<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="robots" content="noindex, nofollow">
  <title>Application Status - Community Connect</title>
  <link rel="stylesheet" href="theme.css">
  <style>
    /* Page-specific styles */
    .status-container {
      max-width: var(--max-width);
      margin: 0 auto;
      padding: var(--space-6) var(--space-4);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    /* Status card variants */
    .status-card.accepted .status-title {
      color: var(--color-status-accepted);
    }

    .status-card.review .status-title {
      color: var(--color-status-review);
    }

    .status-card.hold .status-title {
      color: var(--color-status-hold);
    }

    /* Review message box */
    .review-message {
      background: var(--color-secondary-bg);
      border-radius: var(--radius-md);
      padding: var(--space-4);
      margin-bottom: var(--space-6);
      text-align: left;
    }

    .review-message-label {
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-semibold);
      color: var(--color-primary);
      text-transform: uppercase;
      letter-spacing: 0.03em;
      margin-bottom: var(--space-2);
    }

    .review-message-text {
      font-size: var(--font-size-sm);
      color: var(--color-text);
      line-height: var(--line-height-relaxed);
    }

    /* Hold reason box */
    .hold-reason {
      background: var(--color-status-hold-bg);
      border-radius: var(--radius-md);
      padding: var(--space-4);
      margin-bottom: var(--space-6);
      text-align: left;
    }

    .hold-reason-label {
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-semibold);
      color: var(--color-status-hold);
      text-transform: uppercase;
      letter-spacing: 0.03em;
      margin-bottom: var(--space-2);
    }

    .hold-reason-text {
      font-size: var(--font-size-sm);
      color: var(--color-text);
      line-height: var(--line-height-relaxed);
    }

    /* Shortage tags */
    .shortage-list {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-2);
    }

    .shortage-tag {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-3);
      background: var(--color-bg-card);
      border: 1px solid var(--color-status-accepted);
      border-radius: var(--radius-md);
      font-size: var(--font-size-sm);
      color: var(--color-status-accepted);
    }

    /* Error state */
    .error-state {
      text-align: center;
    }

    .error-icon {
      font-size: 4rem;
      margin-bottom: var(--space-6);
    }

    .error-title {
      font-family: var(--font-family-heading);
      font-size: var(--font-size-xl);
      font-weight: var(--font-weight-semibold);
      color: var(--color-text);
      margin-bottom: var(--space-3);
    }

    .error-link {
      color: var(--color-primary);
      text-decoration: none;
      font-weight: var(--font-weight-medium);
    }

    .error-link:hover {
      text-decoration: underline;
    }

    /* Terms accepted info */
    .terms-info {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-2);
      padding: var(--space-3);
      background: var(--color-bg-muted);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-4);
      font-size: var(--font-size-xs);
      color: var(--color-text-muted);
    }

    .terms-info svg {
      width: 14px;
      height: 14px;
      color: var(--color-status-accepted);
    }

    /* Footer */
    .status-footer {
      text-align: center;
      margin-top: var(--space-6);
      padding-top: var(--space-4);
      border-top: 1px solid var(--color-border-light);
    }

    .footer-link {
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      color: var(--color-text-muted);
      font-size: var(--font-size-xs);
      text-decoration: none;
    }

    .footer-link:hover {
      color: var(--color-primary);
    }

    .footer-link svg {
      width: 12px;
      height: 12px;
    }
  </style>
</head>
<body>
  <script src="shared.js"></script>
  <script src="js/auth.js"></script>

  <div class="status-container" id="main-container">
    <!-- Content will be rendered by JS -->
  </div>

  <script>
    // =====================================================
    // INITIALIZATION
    // =====================================================

    function init() {
      // Support both hash and query params for token (hash preferred due to clean URLs)
      let token = null;
      if (window.location.hash && window.location.hash.includes('token=')) {
        token = new URLSearchParams(window.location.hash.slice(1)).get('token');
      } else if (window.location.search) {
        token = new URLSearchParams(window.location.search).get('token');
      }

      if (!token) {
        renderError('No invite link provided');
        return;
      }

      const invite = getInviteByToken(token);

      if (!invite) {
        renderError('Invite not found');
        return;
      }

      renderStatus(invite);
    }

    // =====================================================
    // ERROR STATE
    // =====================================================

    function renderError(message) {
      document.getElementById('main-container').innerHTML = `
        <div class="error-state">
          <div class="error-icon">üîó</div>
          <h2 class="error-title">Link not found</h2>
          <p style="color: var(--color-text-secondary); margin-bottom: var(--space-6);">${message}</p>
          <a href="index.html" class="error-link">‚Üê Back to Community Connect</a>
        </div>
      `;
    }

    // =====================================================
    // STATUS RENDERING
    // =====================================================

    function renderStatus(invite) {
      const container = document.getElementById('main-container');
      const status = invite.status;

      if (status === 'ACCEPTED' || status === 'AUTO_ACCEPT') {
        renderAccepted(container, invite);
      } else if (status === 'REVIEW') {
        renderReview(container, invite);
      } else if (status === 'HOLD') {
        renderHold(container, invite);
      } else {
        // PENDING_PROFILE - redirect to form - use hash for clean URLs
        window.location.href = `join.html#token=${invite.token}`;
      }
    }

    // =====================================================
    // ACCEPTED
    // =====================================================

    function renderAccepted(container, invite) {
      // Get terms acceptance display
      const termsDisplay = getTermsAcceptanceDisplay(invite.token);
      const termsInfo = termsDisplay.accepted
        ? `<div class="terms-info">
             <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
               <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
               <polyline points="22 4 12 14.01 9 11.01"/>
             </svg>
             Terms accepted: ${termsDisplay.message}
           </div>`
        : '';

      container.innerHTML = `
        <div class="status-card accepted">
          <div class="status-icon">üéâ</div>
          <h1 class="status-title">Welcome to Community Connect!</h1>
          <p class="status-message">
            Your profile has been accepted. You're now part of our community exchange.
          </p>
          <div style="margin: var(--space-4) 0; text-align: center;">
            <span style="display: inline-flex; align-items: center; gap: var(--space-1); background: var(--color-status-review-bg); color: var(--color-status-review); padding: var(--space-1) var(--space-2); border-radius: var(--radius-sm); font-size: var(--font-size-xs); font-weight: var(--font-weight-semibold); text-transform: uppercase; letter-spacing: 0.03em;">Pilot Programme</span>
            <p style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-top: var(--space-2);">Trial period ‚Äî the community can revise rules or stop at any time.</p>
          </div>
          ${termsInfo}
          <a href="index.html" class="btn btn-secondary btn-lg btn-block">Go to home</a>

          <footer class="status-footer">
            <a href="charter.html" class="footer-link">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
              </svg>
              Governance
            </a>
            <span style="margin: 0 var(--space-2); color: var(--color-text-muted);">¬∑</span>
            <a href="terms.html" class="footer-link">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
              </svg>
              Terms
            </a>
            <span style="margin: 0 var(--space-2); color: var(--color-text-muted);">¬∑</span>
            <a href="privacy.html" class="footer-link">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
              </svg>
              Privacy
            </a>
          </footer>
        </div>
      `;
    }

    // =====================================================
    // AWAITING REVIEW
    // =====================================================

    function renderReview(container, invite) {
      const reviewMessage = invite.reviewMessage
        ? `<div class="review-message">
             <div class="review-message-label">Message from reviewer</div>
             <div class="review-message-text">${invite.reviewMessage}</div>
           </div>`
        : '';

      container.innerHTML = `
        <div class="status-card review">
          <div class="status-icon">‚è≥</div>
          <h1 class="status-title">Awaiting community review</h1>
          <p class="status-message">
            Your application is being reviewed by community members. This helps us keep the exchange balanced and trustworthy.
          </p>

          ${reviewMessage}

          <a href="join.html#token=${invite.token}" class="btn btn-ghost btn-lg btn-block">Update my profile</a>

          <footer class="status-footer">
            <a href="charter.html" class="footer-link">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
              </svg>
              Governance
            </a>
            <span style="margin: 0 var(--space-2); color: var(--color-text-muted);">¬∑</span>
            <a href="terms.html" class="footer-link">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
              </svg>
              Terms
            </a>
            <span style="margin: 0 var(--space-2); color: var(--color-text-muted);">¬∑</span>
            <a href="privacy.html" class="footer-link">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
              </svg>
              Privacy
            </a>
          </footer>
        </div>
      `;
    }

    // =====================================================
    // ON HOLD
    // =====================================================

    function renderHold(container, invite) {
      // Get shortage categories
      const shortages = getShortageCategories();
      const overcrowded = getOvercrowdedCategories();

      // Find primary category name
      const primaryCat = invite.profile ? getCategoryById(invite.profile.primaryCategory) : null;
      const primaryLabel = primaryCat ? primaryCat.label : 'your primary category';

      // Build shortage tags
      const shortageTagsHtml = shortages.length > 0
        ? shortages.map(cat => `<span class="shortage-tag">${cat.emoji} ${cat.label}</span>`).join('')
        : '<span class="text-muted text-sm">No current shortages</span>';

      // Hold reason if provided
      const holdReason = invite.holdReason
        ? `<div class="hold-reason">
             <div class="hold-reason-label">Reason</div>
             <div class="hold-reason-text">${invite.holdReason}</div>
           </div>`
        : '';

      container.innerHTML = `
        <div class="status-card hold">
          <div class="status-icon">‚è∏Ô∏è</div>
          <h1 class="status-title">Application on hold</h1>
          <p class="status-message">
            Right now the community has many people offering ${primaryLabel}. To keep exchanges balanced, we're pausing new members in this area.
          </p>

          ${holdReason}

          <div class="guidance-box">
            <div class="guidance-title">üí° Want to speed up acceptance?</div>
            <p class="guidance-text">
              If you can also offer any of these categories where we're short on help, update your profile to highlight them:
            </p>
            <div class="shortage-list">
              ${shortageTagsHtml}
            </div>
          </div>

          <a href="join.html#token=${invite.token}" class="btn btn-primary btn-lg btn-block">Update my profile</a>
          <a href="index.html" class="btn btn-ghost btn-lg btn-block mt-4">Back to home</a>

          <footer class="status-footer">
            <a href="charter.html" class="footer-link">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                <circle cx="9" cy="7" r="4"/>
              </svg>
              Governance
            </a>
            <span style="margin: 0 var(--space-2); color: var(--color-text-muted);">¬∑</span>
            <a href="terms.html" class="footer-link">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
              </svg>
              Terms
            </a>
            <span style="margin: 0 var(--space-2); color: var(--color-text-muted);">¬∑</span>
            <a href="privacy.html" class="footer-link">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
              </svg>
              Privacy
            </a>
          </footer>
        </div>
      `;
    }

    // =====================================================
    // INIT
    // =====================================================

    init();
  </script>
</body>
</html>
