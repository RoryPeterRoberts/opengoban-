<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="robots" content="noindex, nofollow">
  <title>Application Status - Connect Again</title>
  <link rel="stylesheet" href="theme.css">
  <style>
    /* Page-specific styles */
    .status-container {
      max-width: var(--max-width);
      margin: 0 auto;
      padding: var(--space-6) var(--space-4);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    /* Loading */
    .loading-state {
      text-align: center;
      padding: var(--space-12) var(--space-5);
    }

    .loading-spinner-lg {
      width: 40px;
      height: 40px;
      border: 3px solid var(--color-border);
      border-top-color: var(--color-primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto var(--space-4);
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Status card variants */
    .status-card.accepted .status-title {
      color: var(--color-status-accepted);
    }

    .status-card.review .status-title {
      color: var(--color-status-review);
    }

    .status-card.hold .status-title {
      color: var(--color-status-hold);
    }

    /* Review message box */
    .review-message {
      background: var(--color-secondary-bg);
      border-radius: var(--radius-md);
      padding: var(--space-4);
      margin-bottom: var(--space-6);
      text-align: left;
    }

    .review-message-label {
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-semibold);
      color: var(--color-primary);
      text-transform: uppercase;
      letter-spacing: 0.03em;
      margin-bottom: var(--space-2);
    }

    .review-message-text {
      font-size: var(--font-size-sm);
      color: var(--color-text);
      line-height: var(--line-height-relaxed);
    }

    /* Hold reason box */
    .hold-reason {
      background: var(--color-status-hold-bg);
      border-radius: var(--radius-md);
      padding: var(--space-4);
      margin-bottom: var(--space-6);
      text-align: left;
    }

    .hold-reason-label {
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-semibold);
      color: var(--color-status-hold);
      text-transform: uppercase;
      letter-spacing: 0.03em;
      margin-bottom: var(--space-2);
    }

    .hold-reason-text {
      font-size: var(--font-size-sm);
      color: var(--color-text);
      line-height: var(--line-height-relaxed);
    }

    /* Shortage tags */
    .shortage-list {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-2);
    }

    .shortage-tag {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-3);
      background: var(--color-bg-card);
      border: 1px solid var(--color-status-accepted);
      border-radius: var(--radius-md);
      font-size: var(--font-size-sm);
      color: var(--color-status-accepted);
    }

    /* Error state */
    .error-state {
      text-align: center;
    }

    .error-icon {
      font-size: 4rem;
      margin-bottom: var(--space-6);
    }

    .error-title {
      font-family: var(--font-family-heading);
      font-size: var(--font-size-xl);
      font-weight: var(--font-weight-semibold);
      color: var(--color-text);
      margin-bottom: var(--space-3);
    }

    .error-link {
      color: var(--color-primary);
      text-decoration: none;
      font-weight: var(--font-weight-medium);
    }

    .error-link:hover {
      text-decoration: underline;
    }

    /* Terms accepted info */
    .terms-info {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-2);
      padding: var(--space-3);
      background: var(--color-bg-muted);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-4);
      font-size: var(--font-size-xs);
      color: var(--color-text-muted);
    }

    .terms-info svg {
      width: 14px;
      height: 14px;
      color: var(--color-status-accepted);
    }

    /* Footer */
    .status-footer {
      text-align: center;
      margin-top: var(--space-6);
      padding-top: var(--space-4);
      border-top: 1px solid var(--color-border-light);
    }

    .footer-link {
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      color: var(--color-text-muted);
      font-size: var(--font-size-xs);
      text-decoration: none;
    }

    .footer-link:hover {
      color: var(--color-primary);
    }

    .footer-link svg {
      width: 12px;
      height: 12px;
    }
  </style>
</head>
<body>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script>
  <script src="js/auth.js"></script>

  <div class="status-container" id="main-container">
    <div class="loading-state">
      <div class="loading-spinner-lg"></div>
      <p style="color: var(--color-text-muted);">Checking your status...</p>
    </div>
  </div>

  <script>
    // =====================================================
    // INITIALIZATION
    // =====================================================

    async function init() {
      try {
        // Must be authenticated
        const session = await getAuthSession();
        if (!session) {
          window.location.href = 'access.html';
          return;
        }

        // Get current member
        const member = await getCurrentMember();
        if (!member) {
          window.location.href = 'access.html';
          return;
        }

        renderStatus(member);
      } catch (e) {
        console.error('Init error:', e);
        renderError('Something went wrong. Please try signing in again.');
      }
    }

    // =====================================================
    // ERROR STATE
    // =====================================================

    function renderError(message) {
      document.getElementById('main-container').innerHTML = `
        <div class="error-state">
          <div class="error-icon">üîó</div>
          <h2 class="error-title">Something went wrong</h2>
          <p style="color: var(--color-text-secondary); margin-bottom: var(--space-6);">${message}</p>
          <a href="access.html" class="error-link">&larr; Back to sign in</a>
        </div>
      `;
    }

    // =====================================================
    // STATUS RENDERING
    // =====================================================

    function renderStatus(member) {
      const container = document.getElementById('main-container');
      const status = member.status;

      if (status === 'ACCEPTED') {
        renderAccepted(container, member);
      } else if (status === 'REVIEW') {
        renderReview(container, member);
      } else if (status === 'HOLD') {
        renderHold(container, member);
      } else if (status === 'PENDING_PROFILE') {
        // Need to complete profile first
        window.location.href = 'join.html';
      } else {
        renderError('Your account has an unexpected status. Please contact a community member.');
      }
    }

    // =====================================================
    // ACCEPTED
    // =====================================================

    function renderAccepted(container, member) {
      const termsInfo = member.terms_accepted_at
        ? `<div class="terms-info">
             <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
               <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
               <polyline points="22 4 12 14.01 9 11.01"/>
             </svg>
             Terms accepted: ${member.terms_version} on ${formatDate(member.terms_accepted_at)}
           </div>`
        : '';

      container.innerHTML = `
        <div class="status-card accepted">
          <div class="status-icon">üéâ</div>
          <h1 class="status-title">Welcome to Connect Again!</h1>
          <p class="status-message">
            Your profile has been accepted. You're now part of our community exchange.
          </p>
          <div style="margin: var(--space-4) 0; text-align: center;">
            <span style="display: inline-flex; align-items: center; gap: var(--space-1); background: var(--color-status-review-bg); color: var(--color-status-review); padding: var(--space-1) var(--space-2); border-radius: var(--radius-sm); font-size: var(--font-size-xs); font-weight: var(--font-weight-semibold); text-transform: uppercase; letter-spacing: 0.03em;">Pilot Programme</span>
            <p style="font-size: var(--font-size-xs); color: var(--color-text-muted); margin-top: var(--space-2);">Trial period ‚Äî the community can revise rules or stop at any time.</p>
          </div>
          ${termsInfo}
          <a href="index.html" class="btn btn-secondary btn-lg btn-block">Go to home</a>

          ${renderFooter()}
        </div>
      `;
    }

    // =====================================================
    // AWAITING REVIEW
    // =====================================================

    function renderReview(container, member) {
      container.innerHTML = `
        <div class="status-card review">
          <div class="status-icon">‚è≥</div>
          <h1 class="status-title">Awaiting community review</h1>
          <p class="status-message">
            Your application is being reviewed by community members. This helps us keep the exchange balanced and trustworthy.
          </p>

          <div style="background: var(--color-bg-muted); border-radius: var(--radius-md); padding: var(--space-4); margin-bottom: var(--space-6); text-align: left;">
            <p style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin: 0;">
              <strong>Member ID:</strong> ${member.member_id}<br>
              <strong>Primary category:</strong> ${getCategoryLabel(member.primary_category)}<br>
              <strong>Skills:</strong> ${(member.skill_tags || []).join(', ')}
            </p>
          </div>

          <a href="join.html" class="btn btn-ghost btn-lg btn-block">Update my profile</a>

          ${renderFooter()}
        </div>
      `;
    }

    // =====================================================
    // ON HOLD
    // =====================================================

    async function renderHold(container, member) {
      // Get shortage categories from ecosystem health
      let shortageHtml = '<span style="color: var(--color-text-muted); font-size: var(--font-size-sm);">No current shortages</span>';
      try {
        const health = await getEcosystemHealthData();
        const shortages = getShortageCategories(health);
        if (shortages.length > 0) {
          shortageHtml = shortages.map(catId => {
            const cat = getCategoryById(catId);
            return `<span class="shortage-tag">${cat.emoji} ${cat.label}</span>`;
          }).join('');
        }
      } catch (e) {
        console.error('Could not load ecosystem health:', e);
      }

      const primaryCat = getCategoryById(member.primary_category);
      const primaryLabel = primaryCat ? primaryCat.label : 'your primary category';

      container.innerHTML = `
        <div class="status-card hold">
          <div class="status-icon">‚è∏Ô∏è</div>
          <h1 class="status-title">Application on hold</h1>
          <p class="status-message">
            Right now the community has many people offering ${primaryLabel}. To keep exchanges balanced, we're pausing new members in this area.
          </p>

          <div class="guidance-box">
            <div class="guidance-title">Want to speed up acceptance?</div>
            <p class="guidance-text">
              If you can also offer any of these categories where we're short on help, update your profile to highlight them:
            </p>
            <div class="shortage-list">
              ${shortageHtml}
            </div>
          </div>

          <a href="join.html" class="btn btn-primary btn-lg btn-block">Update my profile</a>
          <button class="btn btn-ghost btn-lg btn-block" style="margin-top: var(--space-3);" onclick="handleSignOut()">Sign out</button>

          ${renderFooter()}
        </div>
      `;
    }

    // =====================================================
    // HELPERS
    // =====================================================

    function getCategoryLabel(categoryId) {
      const cat = getCategoryById(categoryId);
      return cat ? `${cat.emoji} ${cat.label}` : categoryId || 'Not set';
    }

    function renderFooter() {
      return `
        <footer class="status-footer">
          <a href="charter.html" class="footer-link">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
              <circle cx="9" cy="7" r="4"/>
            </svg>
            Governance
          </a>
          <span style="margin: 0 var(--space-2); color: var(--color-text-muted);">&middot;</span>
          <a href="terms.html" class="footer-link">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
              <polyline points="14 2 14 8 20 8"/>
            </svg>
            Terms
          </a>
          <span style="margin: 0 var(--space-2); color: var(--color-text-muted);">&middot;</span>
          <a href="privacy.html" class="footer-link">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
            </svg>
            Privacy
          </a>
        </footer>
      `;
    }

    // =====================================================
    // INIT
    // =====================================================

    init();
  </script>
</body>
</html>
