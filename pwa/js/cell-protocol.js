"use strict";var CellProtocol=(()=>{var Wr=Object.create;var St=Object.defineProperty;var Yr=Object.getOwnPropertyDescriptor;var qr=Object.getOwnPropertyNames;var zr=Object.getPrototypeOf,jr=Object.prototype.hasOwnProperty;var Or=(h=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(h,{get:(e,t)=>(typeof require<"u"?require:e)[t]}):h)(function(h){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+h+'" is not supported')});var Mr=(h,e)=>()=>(e||h((e={exports:{}}).exports,e),e.exports),Kr=(h,e)=>{for(var t in e)St(h,t,{get:e[t],enumerable:!0})},wr=(h,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of qr(e))!jr.call(h,i)&&i!==t&&St(h,i,{get:()=>e[i],enumerable:!(r=Yr(e,i))||r.enumerable});return h};var Qr=(h,e,t)=>(t=h!=null?Wr(zr(h)):{},wr(e||!h||!h.__esModule?St(t,"default",{value:h,enumerable:!0}):t,h)),Xr=h=>wr(St({},"__esModule",{value:!0}),h);var Dr=Mr(()=>{});var _r=Mr((xi,Ct)=>{(function(h){"use strict";var e=function(a){var c,s=new Float64Array(16);if(a)for(c=0;c<a.length;c++)s[c]=a[c];return s},t=function(){throw new Error("no PRNG")},r=new Uint8Array(16),i=new Uint8Array(32);i[0]=9;var o=e(),d=e([1]),f=e([56129,1]),S=e([30883,4953,19914,30187,55467,16705,2637,112,59544,30585,16505,36039,65139,11119,27886,20995]),b=e([61785,9906,39828,60374,45398,33411,5274,224,53552,61171,33010,6542,64743,22239,55772,9222]),P=e([54554,36645,11616,51542,42930,38181,51040,26924,56412,64982,57905,49316,21502,52590,14035,8553]),U=e([26200,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214]),q=e([41136,18958,6951,50414,58488,44335,6150,12099,55207,15867,153,11085,57099,20417,9344,11139]);function re(a,c,s,n){a[c]=s>>24&255,a[c+1]=s>>16&255,a[c+2]=s>>8&255,a[c+3]=s&255,a[c+4]=n>>24&255,a[c+5]=n>>16&255,a[c+6]=n>>8&255,a[c+7]=n&255}function j(a,c,s,n,l){var g,p=0;for(g=0;g<l;g++)p|=a[c+g]^s[n+g];return(1&p-1>>>8)-1}function V(a,c,s,n){return j(a,c,s,n,16)}function le(a,c,s,n){return j(a,c,s,n,32)}function Se(a,c,s,n){for(var l=n[0]&255|(n[1]&255)<<8|(n[2]&255)<<16|(n[3]&255)<<24,g=s[0]&255|(s[1]&255)<<8|(s[2]&255)<<16|(s[3]&255)<<24,p=s[4]&255|(s[5]&255)<<8|(s[6]&255)<<16|(s[7]&255)<<24,C=s[8]&255|(s[9]&255)<<8|(s[10]&255)<<16|(s[11]&255)<<24,x=s[12]&255|(s[13]&255)<<8|(s[14]&255)<<16|(s[15]&255)<<24,F=n[4]&255|(n[5]&255)<<8|(n[6]&255)<<16|(n[7]&255)<<24,M=c[0]&255|(c[1]&255)<<8|(c[2]&255)<<16|(c[3]&255)<<24,se=c[4]&255|(c[5]&255)<<8|(c[6]&255)<<16|(c[7]&255)<<24,D=c[8]&255|(c[9]&255)<<8|(c[10]&255)<<16|(c[11]&255)<<24,H=c[12]&255|(c[13]&255)<<8|(c[14]&255)<<16|(c[15]&255)<<24,G=n[8]&255|(n[9]&255)<<8|(n[10]&255)<<16|(n[11]&255)<<24,Q=s[16]&255|(s[17]&255)<<8|(s[18]&255)<<16|(s[19]&255)<<24,K=s[20]&255|(s[21]&255)<<8|(s[22]&255)<<16|(s[23]&255)<<24,W=s[24]&255|(s[25]&255)<<8|(s[26]&255)<<16|(s[27]&255)<<24,z=s[28]&255|(s[29]&255)<<8|(s[30]&255)<<16|(s[31]&255)<<24,Y=n[12]&255|(n[13]&255)<<8|(n[14]&255)<<16|(n[15]&255)<<24,_=l,B=g,w=p,L=C,k=x,O=F,y=M,E=se,R=D,T=H,A=G,v=Q,$=K,X=W,J=z,Z=Y,m,te=0;te<20;te+=2)m=_+$|0,k^=m<<7|m>>>25,m=k+_|0,R^=m<<9|m>>>23,m=R+k|0,$^=m<<13|m>>>19,m=$+R|0,_^=m<<18|m>>>14,m=O+B|0,T^=m<<7|m>>>25,m=T+O|0,X^=m<<9|m>>>23,m=X+T|0,B^=m<<13|m>>>19,m=B+X|0,O^=m<<18|m>>>14,m=A+y|0,J^=m<<7|m>>>25,m=J+A|0,w^=m<<9|m>>>23,m=w+J|0,y^=m<<13|m>>>19,m=y+w|0,A^=m<<18|m>>>14,m=Z+v|0,L^=m<<7|m>>>25,m=L+Z|0,E^=m<<9|m>>>23,m=E+L|0,v^=m<<13|m>>>19,m=v+E|0,Z^=m<<18|m>>>14,m=_+L|0,B^=m<<7|m>>>25,m=B+_|0,w^=m<<9|m>>>23,m=w+B|0,L^=m<<13|m>>>19,m=L+w|0,_^=m<<18|m>>>14,m=O+k|0,y^=m<<7|m>>>25,m=y+O|0,E^=m<<9|m>>>23,m=E+y|0,k^=m<<13|m>>>19,m=k+E|0,O^=m<<18|m>>>14,m=A+T|0,v^=m<<7|m>>>25,m=v+A|0,R^=m<<9|m>>>23,m=R+v|0,T^=m<<13|m>>>19,m=T+R|0,A^=m<<18|m>>>14,m=Z+J|0,$^=m<<7|m>>>25,m=$+Z|0,X^=m<<9|m>>>23,m=X+$|0,J^=m<<13|m>>>19,m=J+X|0,Z^=m<<18|m>>>14;_=_+l|0,B=B+g|0,w=w+p|0,L=L+C|0,k=k+x|0,O=O+F|0,y=y+M|0,E=E+se|0,R=R+D|0,T=T+H|0,A=A+G|0,v=v+Q|0,$=$+K|0,X=X+W|0,J=J+z|0,Z=Z+Y|0,a[0]=_>>>0&255,a[1]=_>>>8&255,a[2]=_>>>16&255,a[3]=_>>>24&255,a[4]=B>>>0&255,a[5]=B>>>8&255,a[6]=B>>>16&255,a[7]=B>>>24&255,a[8]=w>>>0&255,a[9]=w>>>8&255,a[10]=w>>>16&255,a[11]=w>>>24&255,a[12]=L>>>0&255,a[13]=L>>>8&255,a[14]=L>>>16&255,a[15]=L>>>24&255,a[16]=k>>>0&255,a[17]=k>>>8&255,a[18]=k>>>16&255,a[19]=k>>>24&255,a[20]=O>>>0&255,a[21]=O>>>8&255,a[22]=O>>>16&255,a[23]=O>>>24&255,a[24]=y>>>0&255,a[25]=y>>>8&255,a[26]=y>>>16&255,a[27]=y>>>24&255,a[28]=E>>>0&255,a[29]=E>>>8&255,a[30]=E>>>16&255,a[31]=E>>>24&255,a[32]=R>>>0&255,a[33]=R>>>8&255,a[34]=R>>>16&255,a[35]=R>>>24&255,a[36]=T>>>0&255,a[37]=T>>>8&255,a[38]=T>>>16&255,a[39]=T>>>24&255,a[40]=A>>>0&255,a[41]=A>>>8&255,a[42]=A>>>16&255,a[43]=A>>>24&255,a[44]=v>>>0&255,a[45]=v>>>8&255,a[46]=v>>>16&255,a[47]=v>>>24&255,a[48]=$>>>0&255,a[49]=$>>>8&255,a[50]=$>>>16&255,a[51]=$>>>24&255,a[52]=X>>>0&255,a[53]=X>>>8&255,a[54]=X>>>16&255,a[55]=X>>>24&255,a[56]=J>>>0&255,a[57]=J>>>8&255,a[58]=J>>>16&255,a[59]=J>>>24&255,a[60]=Z>>>0&255,a[61]=Z>>>8&255,a[62]=Z>>>16&255,a[63]=Z>>>24&255}function Oe(a,c,s,n){for(var l=n[0]&255|(n[1]&255)<<8|(n[2]&255)<<16|(n[3]&255)<<24,g=s[0]&255|(s[1]&255)<<8|(s[2]&255)<<16|(s[3]&255)<<24,p=s[4]&255|(s[5]&255)<<8|(s[6]&255)<<16|(s[7]&255)<<24,C=s[8]&255|(s[9]&255)<<8|(s[10]&255)<<16|(s[11]&255)<<24,x=s[12]&255|(s[13]&255)<<8|(s[14]&255)<<16|(s[15]&255)<<24,F=n[4]&255|(n[5]&255)<<8|(n[6]&255)<<16|(n[7]&255)<<24,M=c[0]&255|(c[1]&255)<<8|(c[2]&255)<<16|(c[3]&255)<<24,se=c[4]&255|(c[5]&255)<<8|(c[6]&255)<<16|(c[7]&255)<<24,D=c[8]&255|(c[9]&255)<<8|(c[10]&255)<<16|(c[11]&255)<<24,H=c[12]&255|(c[13]&255)<<8|(c[14]&255)<<16|(c[15]&255)<<24,G=n[8]&255|(n[9]&255)<<8|(n[10]&255)<<16|(n[11]&255)<<24,Q=s[16]&255|(s[17]&255)<<8|(s[18]&255)<<16|(s[19]&255)<<24,K=s[20]&255|(s[21]&255)<<8|(s[22]&255)<<16|(s[23]&255)<<24,W=s[24]&255|(s[25]&255)<<8|(s[26]&255)<<16|(s[27]&255)<<24,z=s[28]&255|(s[29]&255)<<8|(s[30]&255)<<16|(s[31]&255)<<24,Y=n[12]&255|(n[13]&255)<<8|(n[14]&255)<<16|(n[15]&255)<<24,_=l,B=g,w=p,L=C,k=x,O=F,y=M,E=se,R=D,T=H,A=G,v=Q,$=K,X=W,J=z,Z=Y,m,te=0;te<20;te+=2)m=_+$|0,k^=m<<7|m>>>25,m=k+_|0,R^=m<<9|m>>>23,m=R+k|0,$^=m<<13|m>>>19,m=$+R|0,_^=m<<18|m>>>14,m=O+B|0,T^=m<<7|m>>>25,m=T+O|0,X^=m<<9|m>>>23,m=X+T|0,B^=m<<13|m>>>19,m=B+X|0,O^=m<<18|m>>>14,m=A+y|0,J^=m<<7|m>>>25,m=J+A|0,w^=m<<9|m>>>23,m=w+J|0,y^=m<<13|m>>>19,m=y+w|0,A^=m<<18|m>>>14,m=Z+v|0,L^=m<<7|m>>>25,m=L+Z|0,E^=m<<9|m>>>23,m=E+L|0,v^=m<<13|m>>>19,m=v+E|0,Z^=m<<18|m>>>14,m=_+L|0,B^=m<<7|m>>>25,m=B+_|0,w^=m<<9|m>>>23,m=w+B|0,L^=m<<13|m>>>19,m=L+w|0,_^=m<<18|m>>>14,m=O+k|0,y^=m<<7|m>>>25,m=y+O|0,E^=m<<9|m>>>23,m=E+y|0,k^=m<<13|m>>>19,m=k+E|0,O^=m<<18|m>>>14,m=A+T|0,v^=m<<7|m>>>25,m=v+A|0,R^=m<<9|m>>>23,m=R+v|0,T^=m<<13|m>>>19,m=T+R|0,A^=m<<18|m>>>14,m=Z+J|0,$^=m<<7|m>>>25,m=$+Z|0,X^=m<<9|m>>>23,m=X+$|0,J^=m<<13|m>>>19,m=J+X|0,Z^=m<<18|m>>>14;a[0]=_>>>0&255,a[1]=_>>>8&255,a[2]=_>>>16&255,a[3]=_>>>24&255,a[4]=O>>>0&255,a[5]=O>>>8&255,a[6]=O>>>16&255,a[7]=O>>>24&255,a[8]=A>>>0&255,a[9]=A>>>8&255,a[10]=A>>>16&255,a[11]=A>>>24&255,a[12]=Z>>>0&255,a[13]=Z>>>8&255,a[14]=Z>>>16&255,a[15]=Z>>>24&255,a[16]=y>>>0&255,a[17]=y>>>8&255,a[18]=y>>>16&255,a[19]=y>>>24&255,a[20]=E>>>0&255,a[21]=E>>>8&255,a[22]=E>>>16&255,a[23]=E>>>24&255,a[24]=R>>>0&255,a[25]=R>>>8&255,a[26]=R>>>16&255,a[27]=R>>>24&255,a[28]=T>>>0&255,a[29]=T>>>8&255,a[30]=T>>>16&255,a[31]=T>>>24&255}function be(a,c,s,n){Se(a,c,s,n)}function we(a,c,s,n){Oe(a,c,s,n)}var Fe=new Uint8Array([101,120,112,97,110,100,32,51,50,45,98,121,116,101,32,107]);function fr(a,c,s,n,l,g,p){var C=new Uint8Array(16),x=new Uint8Array(64),F,M;for(M=0;M<16;M++)C[M]=0;for(M=0;M<8;M++)C[M]=g[M];for(;l>=64;){for(be(x,C,p,Fe),M=0;M<64;M++)a[c+M]=s[n+M]^x[M];for(F=1,M=8;M<16;M++)F=F+(C[M]&255)|0,C[M]=F&255,F>>>=8;l-=64,c+=64,n+=64}if(l>0)for(be(x,C,p,Fe),M=0;M<l;M++)a[c+M]=s[n+M]^x[M];return 0}function gr(a,c,s,n,l){var g=new Uint8Array(16),p=new Uint8Array(64),C,x;for(x=0;x<16;x++)g[x]=0;for(x=0;x<8;x++)g[x]=n[x];for(;s>=64;){for(be(p,g,l,Fe),x=0;x<64;x++)a[c+x]=p[x];for(C=1,x=8;x<16;x++)C=C+(g[x]&255)|0,g[x]=C&255,C>>>=8;s-=64,c+=64}if(s>0)for(be(p,g,l,Fe),x=0;x<s;x++)a[c+x]=p[x];return 0}function pr(a,c,s,n,l){var g=new Uint8Array(32);we(g,n,l,Fe);for(var p=new Uint8Array(8),C=0;C<8;C++)p[C]=n[C+16];return gr(a,c,s,p,g)}function Mt(a,c,s,n,l,g,p){var C=new Uint8Array(32);we(C,g,p,Fe);for(var x=new Uint8Array(8),F=0;F<8;F++)x[F]=g[F+16];return fr(a,c,s,n,l,x,C)}var mt=function(a){this.buffer=new Uint8Array(16),this.r=new Uint16Array(10),this.h=new Uint16Array(10),this.pad=new Uint16Array(8),this.leftover=0,this.fin=0;var c,s,n,l,g,p,C,x;c=a[0]&255|(a[1]&255)<<8,this.r[0]=c&8191,s=a[2]&255|(a[3]&255)<<8,this.r[1]=(c>>>13|s<<3)&8191,n=a[4]&255|(a[5]&255)<<8,this.r[2]=(s>>>10|n<<6)&7939,l=a[6]&255|(a[7]&255)<<8,this.r[3]=(n>>>7|l<<9)&8191,g=a[8]&255|(a[9]&255)<<8,this.r[4]=(l>>>4|g<<12)&255,this.r[5]=g>>>1&8190,p=a[10]&255|(a[11]&255)<<8,this.r[6]=(g>>>14|p<<2)&8191,C=a[12]&255|(a[13]&255)<<8,this.r[7]=(p>>>11|C<<5)&8065,x=a[14]&255|(a[15]&255)<<8,this.r[8]=(C>>>8|x<<8)&8191,this.r[9]=x>>>5&127,this.pad[0]=a[16]&255|(a[17]&255)<<8,this.pad[1]=a[18]&255|(a[19]&255)<<8,this.pad[2]=a[20]&255|(a[21]&255)<<8,this.pad[3]=a[22]&255|(a[23]&255)<<8,this.pad[4]=a[24]&255|(a[25]&255)<<8,this.pad[5]=a[26]&255|(a[27]&255)<<8,this.pad[6]=a[28]&255|(a[29]&255)<<8,this.pad[7]=a[30]&255|(a[31]&255)<<8};mt.prototype.blocks=function(a,c,s){for(var n=this.fin?0:2048,l,g,p,C,x,F,M,se,D,H,G,Q,K,W,z,Y,_,B,w,L=this.h[0],k=this.h[1],O=this.h[2],y=this.h[3],E=this.h[4],R=this.h[5],T=this.h[6],A=this.h[7],v=this.h[8],$=this.h[9],X=this.r[0],J=this.r[1],Z=this.r[2],m=this.r[3],te=this.r[4],oe=this.r[5],ce=this.r[6],ee=this.r[7],ie=this.r[8],ae=this.r[9];s>=16;)l=a[c+0]&255|(a[c+1]&255)<<8,L+=l&8191,g=a[c+2]&255|(a[c+3]&255)<<8,k+=(l>>>13|g<<3)&8191,p=a[c+4]&255|(a[c+5]&255)<<8,O+=(g>>>10|p<<6)&8191,C=a[c+6]&255|(a[c+7]&255)<<8,y+=(p>>>7|C<<9)&8191,x=a[c+8]&255|(a[c+9]&255)<<8,E+=(C>>>4|x<<12)&8191,R+=x>>>1&8191,F=a[c+10]&255|(a[c+11]&255)<<8,T+=(x>>>14|F<<2)&8191,M=a[c+12]&255|(a[c+13]&255)<<8,A+=(F>>>11|M<<5)&8191,se=a[c+14]&255|(a[c+15]&255)<<8,v+=(M>>>8|se<<8)&8191,$+=se>>>5|n,D=0,H=D,H+=L*X,H+=k*(5*ae),H+=O*(5*ie),H+=y*(5*ee),H+=E*(5*ce),D=H>>>13,H&=8191,H+=R*(5*oe),H+=T*(5*te),H+=A*(5*m),H+=v*(5*Z),H+=$*(5*J),D+=H>>>13,H&=8191,G=D,G+=L*J,G+=k*X,G+=O*(5*ae),G+=y*(5*ie),G+=E*(5*ee),D=G>>>13,G&=8191,G+=R*(5*ce),G+=T*(5*oe),G+=A*(5*te),G+=v*(5*m),G+=$*(5*Z),D+=G>>>13,G&=8191,Q=D,Q+=L*Z,Q+=k*J,Q+=O*X,Q+=y*(5*ae),Q+=E*(5*ie),D=Q>>>13,Q&=8191,Q+=R*(5*ee),Q+=T*(5*ce),Q+=A*(5*oe),Q+=v*(5*te),Q+=$*(5*m),D+=Q>>>13,Q&=8191,K=D,K+=L*m,K+=k*Z,K+=O*J,K+=y*X,K+=E*(5*ae),D=K>>>13,K&=8191,K+=R*(5*ie),K+=T*(5*ee),K+=A*(5*ce),K+=v*(5*oe),K+=$*(5*te),D+=K>>>13,K&=8191,W=D,W+=L*te,W+=k*m,W+=O*Z,W+=y*J,W+=E*X,D=W>>>13,W&=8191,W+=R*(5*ae),W+=T*(5*ie),W+=A*(5*ee),W+=v*(5*ce),W+=$*(5*oe),D+=W>>>13,W&=8191,z=D,z+=L*oe,z+=k*te,z+=O*m,z+=y*Z,z+=E*J,D=z>>>13,z&=8191,z+=R*X,z+=T*(5*ae),z+=A*(5*ie),z+=v*(5*ee),z+=$*(5*ce),D+=z>>>13,z&=8191,Y=D,Y+=L*ce,Y+=k*oe,Y+=O*te,Y+=y*m,Y+=E*Z,D=Y>>>13,Y&=8191,Y+=R*J,Y+=T*X,Y+=A*(5*ae),Y+=v*(5*ie),Y+=$*(5*ee),D+=Y>>>13,Y&=8191,_=D,_+=L*ee,_+=k*ce,_+=O*oe,_+=y*te,_+=E*m,D=_>>>13,_&=8191,_+=R*Z,_+=T*J,_+=A*X,_+=v*(5*ae),_+=$*(5*ie),D+=_>>>13,_&=8191,B=D,B+=L*ie,B+=k*ee,B+=O*ce,B+=y*oe,B+=E*te,D=B>>>13,B&=8191,B+=R*m,B+=T*Z,B+=A*J,B+=v*X,B+=$*(5*ae),D+=B>>>13,B&=8191,w=D,w+=L*ae,w+=k*ie,w+=O*ee,w+=y*ce,w+=E*oe,D=w>>>13,w&=8191,w+=R*te,w+=T*m,w+=A*Z,w+=v*J,w+=$*X,D+=w>>>13,w&=8191,D=(D<<2)+D|0,D=D+H|0,H=D&8191,D=D>>>13,G+=D,L=H,k=G,O=Q,y=K,E=W,R=z,T=Y,A=_,v=B,$=w,c+=16,s-=16;this.h[0]=L,this.h[1]=k,this.h[2]=O,this.h[3]=y,this.h[4]=E,this.h[5]=R,this.h[6]=T,this.h[7]=A,this.h[8]=v,this.h[9]=$},mt.prototype.finish=function(a,c){var s=new Uint16Array(10),n,l,g,p;if(this.leftover){for(p=this.leftover,this.buffer[p++]=1;p<16;p++)this.buffer[p]=0;this.fin=1,this.blocks(this.buffer,0,16)}for(n=this.h[1]>>>13,this.h[1]&=8191,p=2;p<10;p++)this.h[p]+=n,n=this.h[p]>>>13,this.h[p]&=8191;for(this.h[0]+=n*5,n=this.h[0]>>>13,this.h[0]&=8191,this.h[1]+=n,n=this.h[1]>>>13,this.h[1]&=8191,this.h[2]+=n,s[0]=this.h[0]+5,n=s[0]>>>13,s[0]&=8191,p=1;p<10;p++)s[p]=this.h[p]+n,n=s[p]>>>13,s[p]&=8191;for(s[9]-=8192,l=(n^1)-1,p=0;p<10;p++)s[p]&=l;for(l=~l,p=0;p<10;p++)this.h[p]=this.h[p]&l|s[p];for(this.h[0]=(this.h[0]|this.h[1]<<13)&65535,this.h[1]=(this.h[1]>>>3|this.h[2]<<10)&65535,this.h[2]=(this.h[2]>>>6|this.h[3]<<7)&65535,this.h[3]=(this.h[3]>>>9|this.h[4]<<4)&65535,this.h[4]=(this.h[4]>>>12|this.h[5]<<1|this.h[6]<<14)&65535,this.h[5]=(this.h[6]>>>2|this.h[7]<<11)&65535,this.h[6]=(this.h[7]>>>5|this.h[8]<<8)&65535,this.h[7]=(this.h[8]>>>8|this.h[9]<<5)&65535,g=this.h[0]+this.pad[0],this.h[0]=g&65535,p=1;p<8;p++)g=(this.h[p]+this.pad[p]|0)+(g>>>16)|0,this.h[p]=g&65535;a[c+0]=this.h[0]>>>0&255,a[c+1]=this.h[0]>>>8&255,a[c+2]=this.h[1]>>>0&255,a[c+3]=this.h[1]>>>8&255,a[c+4]=this.h[2]>>>0&255,a[c+5]=this.h[2]>>>8&255,a[c+6]=this.h[3]>>>0&255,a[c+7]=this.h[3]>>>8&255,a[c+8]=this.h[4]>>>0&255,a[c+9]=this.h[4]>>>8&255,a[c+10]=this.h[5]>>>0&255,a[c+11]=this.h[5]>>>8&255,a[c+12]=this.h[6]>>>0&255,a[c+13]=this.h[6]>>>8&255,a[c+14]=this.h[7]>>>0&255,a[c+15]=this.h[7]>>>8&255},mt.prototype.update=function(a,c,s){var n,l;if(this.leftover){for(l=16-this.leftover,l>s&&(l=s),n=0;n<l;n++)this.buffer[this.leftover+n]=a[c+n];if(s-=l,c+=l,this.leftover+=l,this.leftover<16)return;this.blocks(this.buffer,0,16),this.leftover=0}if(s>=16&&(l=s-s%16,this.blocks(a,c,l),c+=l,s-=l),s){for(n=0;n<s;n++)this.buffer[this.leftover+n]=a[c+n];this.leftover+=s}};function wt(a,c,s,n,l,g){var p=new mt(g);return p.update(s,n,l),p.finish(a,c),0}function Ir(a,c,s,n,l,g){var p=new Uint8Array(16);return wt(p,0,s,n,l,g),V(a,c,p,0)}function Dt(a,c,s,n,l){var g;if(s<32)return-1;for(Mt(a,0,c,0,s,n,l),wt(a,16,a,32,s-32,a),g=0;g<16;g++)a[g]=0;return 0}function _t(a,c,s,n,l){var g,p=new Uint8Array(32);if(s<32||(pr(p,0,32,n,l),Ir(c,16,c,32,s-32,p)!==0))return-1;for(Mt(a,0,c,0,s,n,l),g=0;g<32;g++)a[g]=0;return 0}function Be(a,c){var s;for(s=0;s<16;s++)a[s]=c[s]|0}function Lt(a){var c,s,n=1;for(c=0;c<16;c++)s=a[c]+n+65535,n=Math.floor(s/65536),a[c]=s-n*65536;a[0]+=n-1+37*(n-1)}function We(a,c,s){for(var n,l=~(s-1),g=0;g<16;g++)n=l&(a[g]^c[g]),a[g]^=n,c[g]^=n}function Ye(a,c){var s,n,l,g=e(),p=e();for(s=0;s<16;s++)p[s]=c[s];for(Lt(p),Lt(p),Lt(p),n=0;n<2;n++){for(g[0]=p[0]-65517,s=1;s<15;s++)g[s]=p[s]-65535-(g[s-1]>>16&1),g[s-1]&=65535;g[15]=p[15]-32767-(g[14]>>16&1),l=g[15]>>16&1,g[14]&=65535,We(p,g,1-l)}for(s=0;s<16;s++)a[2*s]=p[s]&255,a[2*s+1]=p[s]>>8}function hr(a,c){var s=new Uint8Array(32),n=new Uint8Array(32);return Ye(s,a),Ye(n,c),le(s,0,n,0)}function yr(a){var c=new Uint8Array(32);return Ye(c,a),c[0]&1}function kt(a,c){var s;for(s=0;s<16;s++)a[s]=c[2*s]+(c[2*s+1]<<8);a[15]&=32767}function Le(a,c,s){for(var n=0;n<16;n++)a[n]=c[n]+s[n]}function ke(a,c,s){for(var n=0;n<16;n++)a[n]=c[n]-s[n]}function ne(a,c,s){var n,l,g=0,p=0,C=0,x=0,F=0,M=0,se=0,D=0,H=0,G=0,Q=0,K=0,W=0,z=0,Y=0,_=0,B=0,w=0,L=0,k=0,O=0,y=0,E=0,R=0,T=0,A=0,v=0,$=0,X=0,J=0,Z=0,m=s[0],te=s[1],oe=s[2],ce=s[3],ee=s[4],ie=s[5],ae=s[6],Te=s[7],ue=s[8],Ie=s[9],he=s[10],ye=s[11],Ce=s[12],Re=s[13],ve=s[14],xe=s[15];n=c[0],g+=n*m,p+=n*te,C+=n*oe,x+=n*ce,F+=n*ee,M+=n*ie,se+=n*ae,D+=n*Te,H+=n*ue,G+=n*Ie,Q+=n*he,K+=n*ye,W+=n*Ce,z+=n*Re,Y+=n*ve,_+=n*xe,n=c[1],p+=n*m,C+=n*te,x+=n*oe,F+=n*ce,M+=n*ee,se+=n*ie,D+=n*ae,H+=n*Te,G+=n*ue,Q+=n*Ie,K+=n*he,W+=n*ye,z+=n*Ce,Y+=n*Re,_+=n*ve,B+=n*xe,n=c[2],C+=n*m,x+=n*te,F+=n*oe,M+=n*ce,se+=n*ee,D+=n*ie,H+=n*ae,G+=n*Te,Q+=n*ue,K+=n*Ie,W+=n*he,z+=n*ye,Y+=n*Ce,_+=n*Re,B+=n*ve,w+=n*xe,n=c[3],x+=n*m,F+=n*te,M+=n*oe,se+=n*ce,D+=n*ee,H+=n*ie,G+=n*ae,Q+=n*Te,K+=n*ue,W+=n*Ie,z+=n*he,Y+=n*ye,_+=n*Ce,B+=n*Re,w+=n*ve,L+=n*xe,n=c[4],F+=n*m,M+=n*te,se+=n*oe,D+=n*ce,H+=n*ee,G+=n*ie,Q+=n*ae,K+=n*Te,W+=n*ue,z+=n*Ie,Y+=n*he,_+=n*ye,B+=n*Ce,w+=n*Re,L+=n*ve,k+=n*xe,n=c[5],M+=n*m,se+=n*te,D+=n*oe,H+=n*ce,G+=n*ee,Q+=n*ie,K+=n*ae,W+=n*Te,z+=n*ue,Y+=n*Ie,_+=n*he,B+=n*ye,w+=n*Ce,L+=n*Re,k+=n*ve,O+=n*xe,n=c[6],se+=n*m,D+=n*te,H+=n*oe,G+=n*ce,Q+=n*ee,K+=n*ie,W+=n*ae,z+=n*Te,Y+=n*ue,_+=n*Ie,B+=n*he,w+=n*ye,L+=n*Ce,k+=n*Re,O+=n*ve,y+=n*xe,n=c[7],D+=n*m,H+=n*te,G+=n*oe,Q+=n*ce,K+=n*ee,W+=n*ie,z+=n*ae,Y+=n*Te,_+=n*ue,B+=n*Ie,w+=n*he,L+=n*ye,k+=n*Ce,O+=n*Re,y+=n*ve,E+=n*xe,n=c[8],H+=n*m,G+=n*te,Q+=n*oe,K+=n*ce,W+=n*ee,z+=n*ie,Y+=n*ae,_+=n*Te,B+=n*ue,w+=n*Ie,L+=n*he,k+=n*ye,O+=n*Ce,y+=n*Re,E+=n*ve,R+=n*xe,n=c[9],G+=n*m,Q+=n*te,K+=n*oe,W+=n*ce,z+=n*ee,Y+=n*ie,_+=n*ae,B+=n*Te,w+=n*ue,L+=n*Ie,k+=n*he,O+=n*ye,y+=n*Ce,E+=n*Re,R+=n*ve,T+=n*xe,n=c[10],Q+=n*m,K+=n*te,W+=n*oe,z+=n*ce,Y+=n*ee,_+=n*ie,B+=n*ae,w+=n*Te,L+=n*ue,k+=n*Ie,O+=n*he,y+=n*ye,E+=n*Ce,R+=n*Re,T+=n*ve,A+=n*xe,n=c[11],K+=n*m,W+=n*te,z+=n*oe,Y+=n*ce,_+=n*ee,B+=n*ie,w+=n*ae,L+=n*Te,k+=n*ue,O+=n*Ie,y+=n*he,E+=n*ye,R+=n*Ce,T+=n*Re,A+=n*ve,v+=n*xe,n=c[12],W+=n*m,z+=n*te,Y+=n*oe,_+=n*ce,B+=n*ee,w+=n*ie,L+=n*ae,k+=n*Te,O+=n*ue,y+=n*Ie,E+=n*he,R+=n*ye,T+=n*Ce,A+=n*Re,v+=n*ve,$+=n*xe,n=c[13],z+=n*m,Y+=n*te,_+=n*oe,B+=n*ce,w+=n*ee,L+=n*ie,k+=n*ae,O+=n*Te,y+=n*ue,E+=n*Ie,R+=n*he,T+=n*ye,A+=n*Ce,v+=n*Re,$+=n*ve,X+=n*xe,n=c[14],Y+=n*m,_+=n*te,B+=n*oe,w+=n*ce,L+=n*ee,k+=n*ie,O+=n*ae,y+=n*Te,E+=n*ue,R+=n*Ie,T+=n*he,A+=n*ye,v+=n*Ce,$+=n*Re,X+=n*ve,J+=n*xe,n=c[15],_+=n*m,B+=n*te,w+=n*oe,L+=n*ce,k+=n*ee,O+=n*ie,y+=n*ae,E+=n*Te,R+=n*ue,T+=n*Ie,A+=n*he,v+=n*ye,$+=n*Ce,X+=n*Re,J+=n*ve,Z+=n*xe,g+=38*B,p+=38*w,C+=38*L,x+=38*k,F+=38*O,M+=38*y,se+=38*E,D+=38*R,H+=38*T,G+=38*A,Q+=38*v,K+=38*$,W+=38*X,z+=38*J,Y+=38*Z,l=1,n=g+l+65535,l=Math.floor(n/65536),g=n-l*65536,n=p+l+65535,l=Math.floor(n/65536),p=n-l*65536,n=C+l+65535,l=Math.floor(n/65536),C=n-l*65536,n=x+l+65535,l=Math.floor(n/65536),x=n-l*65536,n=F+l+65535,l=Math.floor(n/65536),F=n-l*65536,n=M+l+65535,l=Math.floor(n/65536),M=n-l*65536,n=se+l+65535,l=Math.floor(n/65536),se=n-l*65536,n=D+l+65535,l=Math.floor(n/65536),D=n-l*65536,n=H+l+65535,l=Math.floor(n/65536),H=n-l*65536,n=G+l+65535,l=Math.floor(n/65536),G=n-l*65536,n=Q+l+65535,l=Math.floor(n/65536),Q=n-l*65536,n=K+l+65535,l=Math.floor(n/65536),K=n-l*65536,n=W+l+65535,l=Math.floor(n/65536),W=n-l*65536,n=z+l+65535,l=Math.floor(n/65536),z=n-l*65536,n=Y+l+65535,l=Math.floor(n/65536),Y=n-l*65536,n=_+l+65535,l=Math.floor(n/65536),_=n-l*65536,g+=l-1+37*(l-1),l=1,n=g+l+65535,l=Math.floor(n/65536),g=n-l*65536,n=p+l+65535,l=Math.floor(n/65536),p=n-l*65536,n=C+l+65535,l=Math.floor(n/65536),C=n-l*65536,n=x+l+65535,l=Math.floor(n/65536),x=n-l*65536,n=F+l+65535,l=Math.floor(n/65536),F=n-l*65536,n=M+l+65535,l=Math.floor(n/65536),M=n-l*65536,n=se+l+65535,l=Math.floor(n/65536),se=n-l*65536,n=D+l+65535,l=Math.floor(n/65536),D=n-l*65536,n=H+l+65535,l=Math.floor(n/65536),H=n-l*65536,n=G+l+65535,l=Math.floor(n/65536),G=n-l*65536,n=Q+l+65535,l=Math.floor(n/65536),Q=n-l*65536,n=K+l+65535,l=Math.floor(n/65536),K=n-l*65536,n=W+l+65535,l=Math.floor(n/65536),W=n-l*65536,n=z+l+65535,l=Math.floor(n/65536),z=n-l*65536,n=Y+l+65535,l=Math.floor(n/65536),Y=n-l*65536,n=_+l+65535,l=Math.floor(n/65536),_=n-l*65536,g+=l-1+37*(l-1),a[0]=g,a[1]=p,a[2]=C,a[3]=x,a[4]=F,a[5]=M,a[6]=se,a[7]=D,a[8]=H,a[9]=G,a[10]=Q,a[11]=K,a[12]=W,a[13]=z,a[14]=Y,a[15]=_}function De(a,c){ne(a,c,c)}function Er(a,c){var s=e(),n;for(n=0;n<16;n++)s[n]=c[n];for(n=253;n>=0;n--)De(s,s),n!==2&&n!==4&&ne(s,s,c);for(n=0;n<16;n++)a[n]=s[n]}function Sr(a,c){var s=e(),n;for(n=0;n<16;n++)s[n]=c[n];for(n=250;n>=0;n--)De(s,s),n!==1&&ne(s,s,c);for(n=0;n<16;n++)a[n]=s[n]}function ut(a,c,s){var n=new Uint8Array(32),l=new Float64Array(80),g,p,C=e(),x=e(),F=e(),M=e(),se=e(),D=e();for(p=0;p<31;p++)n[p]=c[p];for(n[31]=c[31]&127|64,n[0]&=248,kt(l,s),p=0;p<16;p++)x[p]=l[p],M[p]=C[p]=F[p]=0;for(C[0]=M[0]=1,p=254;p>=0;--p)g=n[p>>>3]>>>(p&7)&1,We(C,x,g),We(F,M,g),Le(se,C,F),ke(C,C,F),Le(F,x,M),ke(x,x,M),De(M,se),De(D,C),ne(C,F,C),ne(F,x,se),Le(se,C,F),ke(C,C,F),De(x,C),ke(F,M,D),ne(C,F,f),Le(C,C,M),ne(F,F,C),ne(C,M,D),ne(M,x,l),De(x,se),We(C,x,g),We(F,M,g);for(p=0;p<16;p++)l[p+16]=C[p],l[p+32]=F[p],l[p+48]=x[p],l[p+64]=M[p];var H=l.subarray(32),G=l.subarray(16);return Er(H,H),ne(G,G,H),Ye(a,G),0}function ft(a,c){return ut(a,c,i)}function br(a,c){return t(c,32),ft(a,c)}function gt(a,c,s){var n=new Uint8Array(32);return ut(n,s,c),we(a,r,n,Fe)}var Tr=Dt,Fr=_t;function Ur(a,c,s,n,l,g){var p=new Uint8Array(32);return gt(p,l,g),Tr(a,c,s,n,p)}function Br(a,c,s,n,l,g){var p=new Uint8Array(32);return gt(p,l,g),Fr(a,c,s,n,p)}var Cr=[1116352408,3609767458,1899447441,602891725,3049323471,3964484399,3921009573,2173295548,961987163,4081628472,1508970993,3053834265,2453635748,2937671579,2870763221,3664609560,3624381080,2734883394,310598401,1164996542,607225278,1323610764,1426881987,3590304994,1925078388,4068182383,2162078206,991336113,2614888103,633803317,3248222580,3479774868,3835390401,2666613458,4022224774,944711139,264347078,2341262773,604807628,2007800933,770255983,1495990901,1249150122,1856431235,1555081692,3175218132,1996064986,2198950837,2554220882,3999719339,2821834349,766784016,2952996808,2566594879,3210313671,3203337956,3336571891,1034457026,3584528711,2466948901,113926993,3758326383,338241895,168717936,666307205,1188179964,773529912,1546045734,1294757372,1522805485,1396182291,2643833823,1695183700,2343527390,1986661051,1014477480,2177026350,1206759142,2456956037,344077627,2730485921,1290863460,2820302411,3158454273,3259730800,3505952657,3345764771,106217008,3516065817,3606008344,3600352804,1432725776,4094571909,1467031594,275423344,851169720,430227734,3100823752,506948616,1363258195,659060556,3750685593,883997877,3785050280,958139571,3318307427,1322822218,3812723403,1537002063,2003034995,1747873779,3602036899,1955562222,1575990012,2024104815,1125592928,2227730452,2716904306,2361852424,442776044,2428436474,593698344,2756734187,3733110249,3204031479,2999351573,3329325298,3815920427,3391569614,3928383900,3515267271,566280711,3940187606,3454069534,4118630271,4000239992,116418474,1914138554,174292421,2731055270,289380356,3203993006,460393269,320620315,685471733,587496836,852142971,1086792851,1017036298,365543100,1126000580,2618297676,1288033470,3409855158,1501505948,4234509866,1607167915,987167468,1816402316,1246189591];function Ar(a,c,s,n){for(var l=new Int32Array(16),g=new Int32Array(16),p,C,x,F,M,se,D,H,G,Q,K,W,z,Y,_,B,w,L,k,O,y,E,R,T,A,v,$=a[0],X=a[1],J=a[2],Z=a[3],m=a[4],te=a[5],oe=a[6],ce=a[7],ee=c[0],ie=c[1],ae=c[2],Te=c[3],ue=c[4],Ie=c[5],he=c[6],ye=c[7],Ce=0;n>=128;){for(k=0;k<16;k++)O=8*k+Ce,l[k]=s[O+0]<<24|s[O+1]<<16|s[O+2]<<8|s[O+3],g[k]=s[O+4]<<24|s[O+5]<<16|s[O+6]<<8|s[O+7];for(k=0;k<80;k++)if(p=$,C=X,x=J,F=Z,M=m,se=te,D=oe,H=ce,G=ee,Q=ie,K=ae,W=Te,z=ue,Y=Ie,_=he,B=ye,y=ce,E=ye,R=E&65535,T=E>>>16,A=y&65535,v=y>>>16,y=(m>>>14|ue<<18)^(m>>>18|ue<<14)^(ue>>>9|m<<23),E=(ue>>>14|m<<18)^(ue>>>18|m<<14)^(m>>>9|ue<<23),R+=E&65535,T+=E>>>16,A+=y&65535,v+=y>>>16,y=m&te^~m&oe,E=ue&Ie^~ue&he,R+=E&65535,T+=E>>>16,A+=y&65535,v+=y>>>16,y=Cr[k*2],E=Cr[k*2+1],R+=E&65535,T+=E>>>16,A+=y&65535,v+=y>>>16,y=l[k%16],E=g[k%16],R+=E&65535,T+=E>>>16,A+=y&65535,v+=y>>>16,T+=R>>>16,A+=T>>>16,v+=A>>>16,w=A&65535|v<<16,L=R&65535|T<<16,y=w,E=L,R=E&65535,T=E>>>16,A=y&65535,v=y>>>16,y=($>>>28|ee<<4)^(ee>>>2|$<<30)^(ee>>>7|$<<25),E=(ee>>>28|$<<4)^($>>>2|ee<<30)^($>>>7|ee<<25),R+=E&65535,T+=E>>>16,A+=y&65535,v+=y>>>16,y=$&X^$&J^X&J,E=ee&ie^ee&ae^ie&ae,R+=E&65535,T+=E>>>16,A+=y&65535,v+=y>>>16,T+=R>>>16,A+=T>>>16,v+=A>>>16,H=A&65535|v<<16,B=R&65535|T<<16,y=F,E=W,R=E&65535,T=E>>>16,A=y&65535,v=y>>>16,y=w,E=L,R+=E&65535,T+=E>>>16,A+=y&65535,v+=y>>>16,T+=R>>>16,A+=T>>>16,v+=A>>>16,F=A&65535|v<<16,W=R&65535|T<<16,X=p,J=C,Z=x,m=F,te=M,oe=se,ce=D,$=H,ie=G,ae=Q,Te=K,ue=W,Ie=z,he=Y,ye=_,ee=B,k%16===15)for(O=0;O<16;O++)y=l[O],E=g[O],R=E&65535,T=E>>>16,A=y&65535,v=y>>>16,y=l[(O+9)%16],E=g[(O+9)%16],R+=E&65535,T+=E>>>16,A+=y&65535,v+=y>>>16,w=l[(O+1)%16],L=g[(O+1)%16],y=(w>>>1|L<<31)^(w>>>8|L<<24)^w>>>7,E=(L>>>1|w<<31)^(L>>>8|w<<24)^(L>>>7|w<<25),R+=E&65535,T+=E>>>16,A+=y&65535,v+=y>>>16,w=l[(O+14)%16],L=g[(O+14)%16],y=(w>>>19|L<<13)^(L>>>29|w<<3)^w>>>6,E=(L>>>19|w<<13)^(w>>>29|L<<3)^(L>>>6|w<<26),R+=E&65535,T+=E>>>16,A+=y&65535,v+=y>>>16,T+=R>>>16,A+=T>>>16,v+=A>>>16,l[O]=A&65535|v<<16,g[O]=R&65535|T<<16;y=$,E=ee,R=E&65535,T=E>>>16,A=y&65535,v=y>>>16,y=a[0],E=c[0],R+=E&65535,T+=E>>>16,A+=y&65535,v+=y>>>16,T+=R>>>16,A+=T>>>16,v+=A>>>16,a[0]=$=A&65535|v<<16,c[0]=ee=R&65535|T<<16,y=X,E=ie,R=E&65535,T=E>>>16,A=y&65535,v=y>>>16,y=a[1],E=c[1],R+=E&65535,T+=E>>>16,A+=y&65535,v+=y>>>16,T+=R>>>16,A+=T>>>16,v+=A>>>16,a[1]=X=A&65535|v<<16,c[1]=ie=R&65535|T<<16,y=J,E=ae,R=E&65535,T=E>>>16,A=y&65535,v=y>>>16,y=a[2],E=c[2],R+=E&65535,T+=E>>>16,A+=y&65535,v+=y>>>16,T+=R>>>16,A+=T>>>16,v+=A>>>16,a[2]=J=A&65535|v<<16,c[2]=ae=R&65535|T<<16,y=Z,E=Te,R=E&65535,T=E>>>16,A=y&65535,v=y>>>16,y=a[3],E=c[3],R+=E&65535,T+=E>>>16,A+=y&65535,v+=y>>>16,T+=R>>>16,A+=T>>>16,v+=A>>>16,a[3]=Z=A&65535|v<<16,c[3]=Te=R&65535|T<<16,y=m,E=ue,R=E&65535,T=E>>>16,A=y&65535,v=y>>>16,y=a[4],E=c[4],R+=E&65535,T+=E>>>16,A+=y&65535,v+=y>>>16,T+=R>>>16,A+=T>>>16,v+=A>>>16,a[4]=m=A&65535|v<<16,c[4]=ue=R&65535|T<<16,y=te,E=Ie,R=E&65535,T=E>>>16,A=y&65535,v=y>>>16,y=a[5],E=c[5],R+=E&65535,T+=E>>>16,A+=y&65535,v+=y>>>16,T+=R>>>16,A+=T>>>16,v+=A>>>16,a[5]=te=A&65535|v<<16,c[5]=Ie=R&65535|T<<16,y=oe,E=he,R=E&65535,T=E>>>16,A=y&65535,v=y>>>16,y=a[6],E=c[6],R+=E&65535,T+=E>>>16,A+=y&65535,v+=y>>>16,T+=R>>>16,A+=T>>>16,v+=A>>>16,a[6]=oe=A&65535|v<<16,c[6]=he=R&65535|T<<16,y=ce,E=ye,R=E&65535,T=E>>>16,A=y&65535,v=y>>>16,y=a[7],E=c[7],R+=E&65535,T+=E>>>16,A+=y&65535,v+=y>>>16,T+=R>>>16,A+=T>>>16,v+=A>>>16,a[7]=ce=A&65535|v<<16,c[7]=ye=R&65535|T<<16,Ce+=128,n-=128}return n}function $e(a,c,s){var n=new Int32Array(8),l=new Int32Array(8),g=new Uint8Array(256),p,C=s;for(n[0]=1779033703,n[1]=3144134277,n[2]=1013904242,n[3]=2773480762,n[4]=1359893119,n[5]=2600822924,n[6]=528734635,n[7]=1541459225,l[0]=4089235720,l[1]=2227873595,l[2]=4271175723,l[3]=1595750129,l[4]=2917565137,l[5]=725511199,l[6]=4215389547,l[7]=327033209,Ar(n,l,c,s),s%=128,p=0;p<s;p++)g[p]=c[C-s+p];for(g[s]=128,s=256-128*(s<112?1:0),g[s-9]=0,re(g,s-8,C/536870912|0,C<<3),Ar(n,l,g,s),p=0;p<8;p++)re(a,8*p,n[p],l[p]);return 0}function pt(a,c){var s=e(),n=e(),l=e(),g=e(),p=e(),C=e(),x=e(),F=e(),M=e();ke(s,a[1],a[0]),ke(M,c[1],c[0]),ne(s,s,M),Le(n,a[0],a[1]),Le(M,c[0],c[1]),ne(n,n,M),ne(l,a[3],c[3]),ne(l,l,b),ne(g,a[2],c[2]),Le(g,g,g),ke(p,n,s),ke(C,g,l),Le(x,g,l),Le(F,n,s),ne(a[0],p,C),ne(a[1],F,x),ne(a[2],x,C),ne(a[3],p,F)}function Rr(a,c,s){var n;for(n=0;n<4;n++)We(a[n],c[n],s)}function Ft(a,c){var s=e(),n=e(),l=e();Er(l,c[2]),ne(s,c[0],l),ne(n,c[1],l),Ye(a,n),a[31]^=yr(s)<<7}function Ut(a,c,s){var n,l;for(Be(a[0],o),Be(a[1],d),Be(a[2],d),Be(a[3],o),l=255;l>=0;--l)n=s[l/8|0]>>(l&7)&1,Rr(a,c,n),pt(c,a),pt(a,a),Rr(a,c,n)}function It(a,c){var s=[e(),e(),e(),e()];Be(s[0],P),Be(s[1],U),Be(s[2],d),ne(s[3],P,U),Ut(a,s,c)}function Bt(a,c,s){var n=new Uint8Array(64),l=[e(),e(),e(),e()],g;for(s||t(c,32),$e(n,c,32),n[0]&=248,n[31]&=127,n[31]|=64,It(l,n),Ft(a,l),g=0;g<32;g++)c[g+32]=a[g];return 0}var ht=new Float64Array([237,211,245,92,26,99,18,88,214,156,247,162,222,249,222,20,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,16]);function Vt(a,c){var s,n,l,g;for(n=63;n>=32;--n){for(s=0,l=n-32,g=n-12;l<g;++l)c[l]+=s-16*c[n]*ht[l-(n-32)],s=Math.floor((c[l]+128)/256),c[l]-=s*256;c[l]+=s,c[n]=0}for(s=0,l=0;l<32;l++)c[l]+=s-(c[31]>>4)*ht[l],s=c[l]>>8,c[l]&=255;for(l=0;l<32;l++)c[l]-=s*ht[l];for(n=0;n<32;n++)c[n+1]+=c[n]>>8,a[n]=c[n]&255}function $t(a){var c=new Float64Array(64),s;for(s=0;s<64;s++)c[s]=a[s];for(s=0;s<64;s++)a[s]=0;Vt(a,c)}function vr(a,c,s,n){var l=new Uint8Array(64),g=new Uint8Array(64),p=new Uint8Array(64),C,x,F=new Float64Array(64),M=[e(),e(),e(),e()];$e(l,n,32),l[0]&=248,l[31]&=127,l[31]|=64;var se=s+64;for(C=0;C<s;C++)a[64+C]=c[C];for(C=0;C<32;C++)a[32+C]=l[32+C];for($e(p,a.subarray(32),s+32),$t(p),It(M,p),Ft(a,M),C=32;C<64;C++)a[C]=n[C];for($e(g,a,s+64),$t(g),C=0;C<64;C++)F[C]=0;for(C=0;C<32;C++)F[C]=p[C];for(C=0;C<32;C++)for(x=0;x<32;x++)F[C+x]+=g[C]*l[x];return Vt(a.subarray(32),F),se}function Vr(a,c){var s=e(),n=e(),l=e(),g=e(),p=e(),C=e(),x=e();return Be(a[2],d),kt(a[1],c),De(l,a[1]),ne(g,l,S),ke(l,l,a[2]),Le(g,a[2],g),De(p,g),De(C,p),ne(x,C,p),ne(s,x,l),ne(s,s,g),Sr(s,s),ne(s,s,l),ne(s,s,g),ne(s,s,g),ne(a[0],s,g),De(n,a[0]),ne(n,n,g),hr(n,l)&&ne(a[0],a[0],q),De(n,a[0]),ne(n,n,g),hr(n,l)?-1:(yr(a[0])===c[31]>>7&&ke(a[0],o,a[0]),ne(a[3],a[0],a[1]),0)}function Ht(a,c,s,n){var l,g=new Uint8Array(32),p=new Uint8Array(64),C=[e(),e(),e(),e()],x=[e(),e(),e(),e()];if(s<64||Vr(x,n))return-1;for(l=0;l<s;l++)a[l]=c[l];for(l=0;l<32;l++)a[l+32]=n[l];if($e(p,a,s),$t(p),Ut(C,x,p),It(x,c.subarray(32)),pt(C,x),Ft(g,C),s-=64,le(c,0,g,0)){for(l=0;l<s;l++)a[l]=0;return-1}for(l=0;l<s;l++)a[l]=c[l+64];return s}var Gt=32,yt=24,it=32,qe=16,at=32,Et=32,st=32,ot=32,Wt=32,xr=yt,$r=it,Hr=qe,Ve=64,He=32,ze=64,Yt=32,qt=64;h.lowlevel={crypto_core_hsalsa20:we,crypto_stream_xor:Mt,crypto_stream:pr,crypto_stream_salsa20_xor:fr,crypto_stream_salsa20:gr,crypto_onetimeauth:wt,crypto_onetimeauth_verify:Ir,crypto_verify_16:V,crypto_verify_32:le,crypto_secretbox:Dt,crypto_secretbox_open:_t,crypto_scalarmult:ut,crypto_scalarmult_base:ft,crypto_box_beforenm:gt,crypto_box_afternm:Tr,crypto_box:Ur,crypto_box_open:Br,crypto_box_keypair:br,crypto_hash:$e,crypto_sign:vr,crypto_sign_keypair:Bt,crypto_sign_open:Ht,crypto_secretbox_KEYBYTES:Gt,crypto_secretbox_NONCEBYTES:yt,crypto_secretbox_ZEROBYTES:it,crypto_secretbox_BOXZEROBYTES:qe,crypto_scalarmult_BYTES:at,crypto_scalarmult_SCALARBYTES:Et,crypto_box_PUBLICKEYBYTES:st,crypto_box_SECRETKEYBYTES:ot,crypto_box_BEFORENMBYTES:Wt,crypto_box_NONCEBYTES:xr,crypto_box_ZEROBYTES:$r,crypto_box_BOXZEROBYTES:Hr,crypto_sign_BYTES:Ve,crypto_sign_PUBLICKEYBYTES:He,crypto_sign_SECRETKEYBYTES:ze,crypto_sign_SEEDBYTES:Yt,crypto_hash_BYTES:qt,gf:e,D:S,L:ht,pack25519:Ye,unpack25519:kt,M:ne,A:Le,S:De,Z:ke,pow2523:Sr,add:pt,set25519:Be,modL:Vt,scalarmult:Ut,scalarbase:It};function Pr(a,c){if(a.length!==Gt)throw new Error("bad key size");if(c.length!==yt)throw new Error("bad nonce size")}function Gr(a,c){if(a.length!==st)throw new Error("bad public key size");if(c.length!==ot)throw new Error("bad secret key size")}function Me(){for(var a=0;a<arguments.length;a++)if(!(arguments[a]instanceof Uint8Array))throw new TypeError("unexpected type, use Uint8Array")}function Nr(a){for(var c=0;c<a.length;c++)a[c]=0}h.randomBytes=function(a){var c=new Uint8Array(a);return t(c,a),c},h.secretbox=function(a,c,s){Me(a,c,s),Pr(s,c);for(var n=new Uint8Array(it+a.length),l=new Uint8Array(n.length),g=0;g<a.length;g++)n[g+it]=a[g];return Dt(l,n,n.length,c,s),l.subarray(qe)},h.secretbox.open=function(a,c,s){Me(a,c,s),Pr(s,c);for(var n=new Uint8Array(qe+a.length),l=new Uint8Array(n.length),g=0;g<a.length;g++)n[g+qe]=a[g];return n.length<32||_t(l,n,n.length,c,s)!==0?null:l.subarray(it)},h.secretbox.keyLength=Gt,h.secretbox.nonceLength=yt,h.secretbox.overheadLength=qe,h.scalarMult=function(a,c){if(Me(a,c),a.length!==Et)throw new Error("bad n size");if(c.length!==at)throw new Error("bad p size");var s=new Uint8Array(at);return ut(s,a,c),s},h.scalarMult.base=function(a){if(Me(a),a.length!==Et)throw new Error("bad n size");var c=new Uint8Array(at);return ft(c,a),c},h.scalarMult.scalarLength=Et,h.scalarMult.groupElementLength=at,h.box=function(a,c,s,n){var l=h.box.before(s,n);return h.secretbox(a,c,l)},h.box.before=function(a,c){Me(a,c),Gr(a,c);var s=new Uint8Array(Wt);return gt(s,a,c),s},h.box.after=h.secretbox,h.box.open=function(a,c,s,n){var l=h.box.before(s,n);return h.secretbox.open(a,c,l)},h.box.open.after=h.secretbox.open,h.box.keyPair=function(){var a=new Uint8Array(st),c=new Uint8Array(ot);return br(a,c),{publicKey:a,secretKey:c}},h.box.keyPair.fromSecretKey=function(a){if(Me(a),a.length!==ot)throw new Error("bad secret key size");var c=new Uint8Array(st);return ft(c,a),{publicKey:c,secretKey:new Uint8Array(a)}},h.box.publicKeyLength=st,h.box.secretKeyLength=ot,h.box.sharedKeyLength=Wt,h.box.nonceLength=xr,h.box.overheadLength=h.secretbox.overheadLength,h.sign=function(a,c){if(Me(a,c),c.length!==ze)throw new Error("bad secret key size");var s=new Uint8Array(Ve+a.length);return vr(s,a,a.length,c),s},h.sign.open=function(a,c){if(Me(a,c),c.length!==He)throw new Error("bad public key size");var s=new Uint8Array(a.length),n=Ht(s,a,a.length,c);if(n<0)return null;for(var l=new Uint8Array(n),g=0;g<l.length;g++)l[g]=s[g];return l},h.sign.detached=function(a,c){for(var s=h.sign(a,c),n=new Uint8Array(Ve),l=0;l<n.length;l++)n[l]=s[l];return n},h.sign.detached.verify=function(a,c,s){if(Me(a,c,s),c.length!==Ve)throw new Error("bad signature size");if(s.length!==He)throw new Error("bad public key size");var n=new Uint8Array(Ve+a.length),l=new Uint8Array(Ve+a.length),g;for(g=0;g<Ve;g++)n[g]=c[g];for(g=0;g<a.length;g++)n[g+Ve]=a[g];return Ht(l,n,n.length,s)>=0},h.sign.keyPair=function(){var a=new Uint8Array(He),c=new Uint8Array(ze);return Bt(a,c),{publicKey:a,secretKey:c}},h.sign.keyPair.fromSecretKey=function(a){if(Me(a),a.length!==ze)throw new Error("bad secret key size");for(var c=new Uint8Array(He),s=0;s<c.length;s++)c[s]=a[32+s];return{publicKey:c,secretKey:new Uint8Array(a)}},h.sign.keyPair.fromSeed=function(a){if(Me(a),a.length!==Yt)throw new Error("bad seed size");for(var c=new Uint8Array(He),s=new Uint8Array(ze),n=0;n<32;n++)s[n]=a[n];return Bt(c,s,!0),{publicKey:c,secretKey:s}},h.sign.publicKeyLength=He,h.sign.secretKeyLength=ze,h.sign.seedLength=Yt,h.sign.signatureLength=Ve,h.hash=function(a){Me(a);var c=new Uint8Array(qt);return $e(c,a,a.length),c},h.hash.hashLength=qt,h.verify=function(a,c){return Me(a,c),a.length===0||c.length===0||a.length!==c.length?!1:j(a,0,c,0,a.length)===0},h.setPRNG=function(a){t=a},(function(){var a=typeof self<"u"?self.crypto||self.msCrypto:null;if(a&&a.getRandomValues){var c=65536;h.setPRNG(function(s,n){var l,g=new Uint8Array(n);for(l=0;l<n;l+=c)a.getRandomValues(g.subarray(l,l+Math.min(n-l,c)));for(l=0;l<n;l++)s[l]=g[l];Nr(g)})}else typeof Or<"u"&&(a=Dr(),a&&a.randomBytes&&h.setPRNG(function(s,n){var l,g=a.randomBytes(n);for(l=0;l<n;l++)s[l]=g[l];Nr(g)}))})()})(typeof Ct<"u"&&Ct.exports?Ct.exports:self.nacl=self.nacl||{})});var Hn={};Kr(Hn,{CommitmentEngine:()=>Xe,EmergencyEngine:()=>tt,EnergyEngine:()=>nt,FederationEngine:()=>rt,GovernanceEngine:()=>Ze,IdentityEngine:()=>Qe,LedgerEngine:()=>je,SchedulerEngine:()=>Je,TransactionEngine:()=>Ke,createCellProtocol:()=>Ot,createInMemoryStorage:()=>dt,createPouchDBStorage:()=>ur,generateId:()=>fe,now:()=>u});function fe(){let h=Date.now().toString(36),e=Math.random().toString(36).substring(2,10);return`${h}-${e}`}function u(){return Date.now()}var zt=[{id:"FIREWOOD",name:"Firewood",unit:"kg",category:"SOLID_FUEL",storable:!0},{id:"DIESEL",name:"Diesel Fuel",unit:"L",category:"LIQUID_FUEL",storable:!0},{id:"PROPANE",name:"Propane Gas",unit:"kg",category:"GAS",storable:!0},{id:"ELECTRICITY_STORED",name:"Battery Storage",unit:"kWh",category:"ELECTRICITY",storable:!0},{id:"POTABLE_WATER",name:"Potable Water",unit:"L",category:"WATER",storable:!0}],jt=[{taskCategory:"FOOD",energyModes:[{id:"FOOD_ELECTRIC",name:"Electric Cooking",efficiency:1,energyPerHour:new Map([["ELECTRICITY_STORED",2]])},{id:"FOOD_GAS",name:"Gas Cooking",efficiency:.95,energyPerHour:new Map([["PROPANE",.5]])},{id:"FOOD_WOOD",name:"Wood Fire Cooking",efficiency:.7,energyPerHour:new Map([["FIREWOOD",3]])}]},{taskCategory:"WATER_SANITATION",energyModes:[{id:"WATER_ELECTRIC",name:"Electric Pump",efficiency:1,energyPerHour:new Map([["ELECTRICITY_STORED",1],["POTABLE_WATER",50]])},{id:"WATER_MANUAL",name:"Manual Draw",efficiency:.6,energyPerHour:new Map([["POTABLE_WATER",30]])}]},{taskCategory:"ENERGY_HEAT",energyModes:[{id:"HEAT_ELECTRIC",name:"Electric Heating",efficiency:1,energyPerHour:new Map([["ELECTRICITY_STORED",3]])},{id:"HEAT_GAS",name:"Gas Heating",efficiency:.9,energyPerHour:new Map([["PROPANE",1]])},{id:"HEAT_WOOD",name:"Wood Stove",efficiency:.7,energyPerHour:new Map([["FIREWOOD",5]])}]},{taskCategory:"MEDICAL",energyModes:[{id:"MEDICAL_FULL",name:"Full Medical Equipment",efficiency:1,energyPerHour:new Map([["ELECTRICITY_STORED",1.5],["POTABLE_WATER",10]])},{id:"MEDICAL_BASIC",name:"Basic Care",efficiency:.7,energyPerHour:new Map([["POTABLE_WATER",5]])}]},{taskCategory:"SHELTER_REPAIR",energyModes:[{id:"SHELTER_POWER_TOOLS",name:"Power Tools",efficiency:1,energyPerHour:new Map([["ELECTRICITY_STORED",.5]])},{id:"SHELTER_MANUAL",name:"Manual Tools",efficiency:.6,energyPerHour:new Map}]},{taskCategory:"CHILDCARE_DEPENDENT",energyModes:[{id:"CHILDCARE_STANDARD",name:"Standard Care",efficiency:1,energyPerHour:new Map([["ELECTRICITY_STORED",.3],["POTABLE_WATER",5]])}]},{taskCategory:"SECURITY_COORDINATION",energyModes:[{id:"SECURITY_STANDARD",name:"Standard Security",efficiency:1,energyPerHour:new Map([["ELECTRICITY_STORED",.2]])}]},{taskCategory:"PROCUREMENT_TRANSPORT",energyModes:[{id:"TRANSPORT_VEHICLE",name:"Vehicle Transport",efficiency:1,energyPerHour:new Map([["DIESEL",5]])},{id:"TRANSPORT_MANUAL",name:"Manual Transport",efficiency:.4,energyPerHour:new Map}]},{taskCategory:"GENERAL",energyModes:[{id:"GENERAL_STANDARD",name:"Standard",efficiency:1,energyPerHour:new Map([["ELECTRICITY_STORED",.1]])},{id:"GENERAL_MINIMAL",name:"Minimal",efficiency:.8,energyPerHour:new Map}]}],bt=.6,Kt=.2;var Tt={NORMAL:{limitFactor:1,newMemberLimitFactor:1,federationBetaFactor:1,admissionMode:"STANDARD",commitmentMode:"STANDARD",schedulerPriority:"BALANCED",debtorPriorityMatching:!1},STRESSED:{limitFactor:1,newMemberLimitFactor:.8,federationBetaFactor:.7,admissionMode:"BONDED",commitmentMode:"ESCROW_ESSENTIALS",schedulerPriority:"ESSENTIALS_FIRST",debtorPriorityMatching:!0},PANIC:{limitFactor:.8,newMemberLimitFactor:.5,federationBetaFactor:0,admissionMode:"SUPERMAJORITY_BONDED",commitmentMode:"ESCROW_ALL",schedulerPriority:"SURVIVAL",debtorPriorityMatching:!0}},Qt={stressedFloorMass:.25,stressedDisputeRate:.05,panicFloorMass:.4,panicEnergyStress:1.2,normalFloorMass:.15,normalOverallStress:.8,panicStabilizationPeriod:1440*60*1e3};var Xt={maxBilateralPosition:1e4,settlementPeriodHours:168,autoSettlement:!1,minTransactionAmount:1},Zt={baseBetaFactor:.3,minExposureCap:0,maxExposureCap:1e6,warningThreshold:.75,criticalThreshold:.9};function Jt(){return`ftx-${fe()}`}function er(){return`lp-${fe()}`}function I(h){return{ok:!0,value:h}}function N(h){return{ok:!1,error:h}}var je=class{constructor(e,t,r){let i={cellId:e,defaultLimit:t.defaultLimit??100,minLimit:t.minLimit??0,maxLimit:t.maxLimit??1e4,enforceEscrowSafety:t.enforceEscrowSafety??!0};this.state={cellId:e,parameters:i,members:new Map,sequenceNumber:0,lastUpdated:u()},this.storage=r}async initialize(){let e=await this.storage.getLedgerState(this.state.cellId);return e.ok?(e.value&&(this.state=e.value),I(void 0)):N({code:"STORAGE_ERROR",message:e.error.message})}async persist(){let e=await this.storage.saveLedgerState(this.state);return e.ok?I(void 0):N({code:"STORAGE_ERROR",message:e.error.message})}getCellId(){return this.state.cellId}getParameters(){return{...this.state.parameters}}getMemberState(e){let t=this.state.members.get(e);return t?{...t}:void 0}getAllMemberStates(){let e=new Map;return this.state.members.forEach((t,r)=>{e.set(r,{...t})}),e}canSpend(e,t){if(t<=0)return!1;let r=this.state.members.get(e);if(!r||r.status!=="ACTIVE")return!1;let i=this.getAvailableCapacity(e);return t<=i}getAvailableCapacity(e){let t=this.state.members.get(e);return t?t.limit+t.balance-t.reserve:0}getMemberCount(){return this.state.members.size}async addMember(e,t){if(this.state.members.has(e))throw new Error(`Member ${e} already exists`);let r=t??this.state.parameters.defaultLimit;if(r<this.state.parameters.minLimit||r>this.state.parameters.maxLimit)throw new Error(`Limit ${r} out of range [${this.state.parameters.minLimit}, ${this.state.parameters.maxLimit}]`);let i={memberId:e,balance:0,limit:r,reserve:0,status:"ACTIVE",lastActivity:u(),joinedAt:u()};return this.state.members.set(e,i),this.state.sequenceNumber++,this.state.lastUpdated=u(),await this.persist(),await this.storage.appendEvent({cellId:this.state.cellId,type:"MEMBER_ADDED",timestamp:u(),data:{memberId:e,limit:r}}),{...i}}async removeMember(e){let t=this.state.members.get(e);if(!t)throw new Error(`Member ${e} not found`);if(t.balance!==0)throw new Error(`Cannot remove member with non-zero balance: ${t.balance}`);if(t.reserve!==0)throw new Error(`Cannot remove member with active reserves: ${t.reserve}`);this.state.members.delete(e),this.state.sequenceNumber++,this.state.lastUpdated=u(),await this.persist(),await this.storage.appendEvent({cellId:this.state.cellId,type:"MEMBER_REMOVED",timestamp:u(),data:{memberId:e}})}async applyBalanceUpdates(e){if(e.length===0)return[];let t=e.reduce((d,f)=>d+f.delta,0);if(t!==0)throw new Ae({code:"CONSERVATION_VIOLATION",message:`Sum of deltas is ${t}, must be 0`,details:{sumDeltas:t,updates:e}});let r=[];for(let d of e){let f=this.state.members.get(d.memberId);if(!f)throw new Ae({code:"MEMBER_NOT_FOUND",message:`Member ${d.memberId} not found`,details:{memberId:d.memberId}});if(f.status!=="ACTIVE")throw new Ae({code:"MEMBER_NOT_ACTIVE",message:`Member ${d.memberId} is not active (status: ${f.status})`,details:{memberId:d.memberId,status:f.status}});let S=f.balance+d.delta;if(S<-f.limit)throw new Ae({code:"FLOOR_VIOLATION",message:`Balance ${S} would breach floor -${f.limit} for member ${d.memberId}`,details:{memberId:d.memberId,currentBalance:f.balance,delta:d.delta,newBalance:S,limit:f.limit,floor:-f.limit}});if(this.state.parameters.enforceEscrowSafety){let b=-f.limit+f.reserve;if(S<b)throw new Ae({code:"ESCROW_VIOLATION",message:`Balance ${S} would breach escrow floor ${b} for member ${d.memberId}`,details:{memberId:d.memberId,currentBalance:f.balance,delta:d.delta,newBalance:S,reserve:f.reserve,escrowFloor:b}})}r.push({update:d,member:f,newBalance:S})}let i=[],o=u();for(let{update:d,member:f,newBalance:S}of r){let b=f.balance;f.balance=S,f.lastActivity=o,i.push({success:!0,newBalance:S,previousBalance:b,sequenceNumber:++this.state.sequenceNumber})}return this.state.lastUpdated=o,await this.persist(),await this.storage.appendEvent({cellId:this.state.cellId,type:"BALANCE_UPDATES",timestamp:o,data:{updates:e.map((d,f)=>({memberId:d.memberId,delta:d.delta,reason:d.reason,referenceId:d.referenceId,newBalance:i[f].newBalance}))}}),i}async applyReserveUpdate(e){let t=this.state.members.get(e.memberId);if(!t)throw new Ae({code:"MEMBER_NOT_FOUND",message:`Member ${e.memberId} not found`});let r=t.reserve+e.delta;if(r<0)throw new Ae({code:"NEGATIVE_RESERVE",message:`Reserve ${r} would be negative for member ${e.memberId}`,details:{memberId:e.memberId,currentReserve:t.reserve,delta:e.delta,newReserve:r}});if(e.delta>0&&this.state.parameters.enforceEscrowSafety){let i=-t.limit+r;if(t.balance<i)throw new Ae({code:"ESCROW_VIOLATION",message:`Cannot reserve ${e.delta}: would breach escrow floor`,details:{memberId:e.memberId,balance:t.balance,newReserve:r,escrowFloor:i}})}t.reserve=r,t.lastActivity=u(),this.state.sequenceNumber++,this.state.lastUpdated=u(),await this.persist(),await this.storage.appendEvent({cellId:this.state.cellId,type:"RESERVE_UPDATE",timestamp:u(),data:{memberId:e.memberId,delta:e.delta,reason:e.reason,commitmentId:e.commitmentId,newReserve:r}})}async updateMemberLimit(e,t){let r=this.state.members.get(e);if(!r)throw new Ae({code:"MEMBER_NOT_FOUND",message:`Member ${e} not found`});if(t<this.state.parameters.minLimit||t>this.state.parameters.maxLimit)throw new Ae({code:"INVALID_AMOUNT",message:`Limit ${t} out of range [${this.state.parameters.minLimit}, ${this.state.parameters.maxLimit}]`});if(t<r.limit){let o=-t;if(r.balance<o)throw new Ae({code:"FLOOR_VIOLATION",message:`Cannot reduce limit: current balance ${r.balance} would breach new floor ${o}`})}let i=r.limit;r.limit=t,r.lastActivity=u(),this.state.sequenceNumber++,this.state.lastUpdated=u(),await this.persist(),await this.storage.appendEvent({cellId:this.state.cellId,type:"LIMIT_UPDATED",timestamp:u(),data:{memberId:e,oldLimit:i,newLimit:t}})}async updateMemberStatus(e,t){let r=this.state.members.get(e);if(!r)throw new Ae({code:"MEMBER_NOT_FOUND",message:`Member ${e} not found`});let i=r.status;r.status=t,r.lastActivity=u(),this.state.sequenceNumber++,this.state.lastUpdated=u(),await this.persist(),await this.storage.appendEvent({cellId:this.state.cellId,type:"STATUS_UPDATED",timestamp:u(),data:{memberId:e,oldStatus:i,newStatus:t}})}verifyConservation(){let e=0;return this.state.members.forEach(t=>{e+=t.balance}),e===0}verifyAllFloors(){for(let e of this.state.members.values())if(e.balance<-e.limit)return!1;return!0}getStatistics(){let e=0,t=0,r=0,i=0,o=0,d=0,f=0;return this.state.members.forEach(S=>{d+=S.balance,r+=S.limit,o+=S.reserve,S.balance>0?e+=S.balance:t+=Math.abs(S.balance),S.balance<=-S.limit&&(i+=S.limit),S.status==="ACTIVE"&&f++}),{memberCount:this.state.members.size,activeMemberCount:f,positiveBalanceSum:e,negativeBalanceSum:t,aggregateCapacity:r,floorMass:i,totalReserved:o,balanceSum:d}}},Ae=class extends Error{constructor(e){super(e.message),this.name="LedgerViolationError",this.code=e.code,this.details=e.details}toJSON(){return{code:this.code,message:this.message,details:this.details}}};async function tr(h,e,t){let r=new je(h,e,t);return await r.initialize(),r}var Pe;function At(h){return Pe?.util?.encodeBase64?Pe.util.encodeBase64(h):typeof Buffer<"u"?Buffer.from(h).toString("base64"):btoa(String.fromCharCode.apply(null,Array.from(h)))}function ct(h){if(Pe?.util?.decodeBase64)return Pe.util.decodeBase64(h);if(typeof Buffer<"u")return new Uint8Array(Buffer.from(h,"base64"));let e=atob(h),t=new Uint8Array(e.length);for(let r=0;r<e.length;r++)t[r]=e.charCodeAt(r);return t}function Rt(h){return Array.from(h).map(e=>e.toString(16).padStart(2,"0")).join("")}var vt=class{constructor(){this.initialized=!1}async initialize(e){try{if(e)Pe=e;else if(typeof globalThis<"u"&&globalThis.nacl)Pe=globalThis.nacl;else try{let t=await Promise.resolve().then(()=>Qr(_r()));Pe=t.default||t}catch{return N({code:"NOT_INITIALIZED",message:"TweetNaCl not available. Please provide naclInstance or install tweetnacl."})}return this.initialized=!0,I(void 0)}catch(t){return N({code:"NOT_INITIALIZED",message:`Failed to initialize crypto: ${t}`})}}isInitialized(){return this.initialized&&Pe!==void 0}generateKeyPair(){if(!this.isInitialized()||!Pe)return N({code:"NOT_INITIALIZED",message:"Crypto not initialized"});try{let e=Pe.sign.keyPair();return I({publicKey:At(e.publicKey),secretKey:At(e.secretKey)})}catch(e){return N({code:"KEY_GENERATION_FAILED",message:`Key generation failed: ${e}`})}}deriveIdentityId(e){let t=ct(e);return Rt(t.slice(0,16))}sign(e,t){if(!this.isInitialized()||!Pe)return N({code:"NOT_INITIALIZED",message:"Crypto not initialized"});try{let r=typeof e=="string"?e:JSON.stringify(e),i=new TextEncoder().encode(r),o=ct(t),d=Pe.sign.detached(i,o);return I(At(d))}catch(r){return N({code:"SIGNING_FAILED",message:`Signing failed: ${r}`})}}verify(e,t,r){if(!this.isInitialized()||!Pe)return!1;try{let i=typeof e=="string"?e:JSON.stringify(e),o=new TextEncoder().encode(i),d=ct(t),f=ct(r);return Pe.sign.detached.verify(o,d,f)}catch{return!1}}generateNonce(e=16){if(!this.isInitialized()||!Pe){let r=new Uint8Array(e);for(let i=0;i<e;i++)r[i]=Math.floor(Math.random()*256);return Rt(r)}let t=Pe.randomBytes(e);return Rt(t)}generateId(){let e=Date.now().toString(36),t=this.generateNonce(8);return`${e}-${t}`}},rr=new vt;function xt(h){return JSON.stringify({payer:h.payer,payee:h.payee,amount:h.amount,description:h.description,createdAt:h.createdAt,nonce:h.nonce})}var Ke=class{constructor(e,t,r,i){this.ledger=e,this.storage=t,this.crypto=r,this.publicKeyResolver=i}async createSpotTransaction(e){let t=fe(),r=this.crypto.generateNonce(),i=u(),o=this.validateInput(e);if(o)throw new Ne(o);let d={id:t,type:"SPOT",payer:e.payer,payee:e.payee,amount:e.amount,description:e.description,createdAt:i,status:"PENDING",signatures:{},nonce:r},f=await this.storage.saveTransaction(d);if(!f.ok)throw new Error(`Failed to save transaction: ${f.error.message}`);return d}validateInput(e){if(e.payer===e.payee)return{code:"SELF_TRANSACTION",message:"Cannot pay yourself"};if(e.amount<=0)return{code:"INVALID_AMOUNT",message:"Amount must be positive",details:{amount:e.amount}};let t=this.ledger.getMemberState(e.payer);if(!t)return{code:"PAYER_NOT_MEMBER",message:`Payer ${e.payer} is not a member`};if(t.status!=="ACTIVE")return{code:"PAYER_NOT_MEMBER",message:`Payer ${e.payer} is not active (status: ${t.status})`};let r=this.ledger.getMemberState(e.payee);if(!r)return{code:"PAYEE_NOT_MEMBER",message:`Payee ${e.payee} is not a member`};if(r.status!=="ACTIVE")return{code:"PAYEE_NOT_MEMBER",message:`Payee ${e.payee} is not active (status: ${r.status})`};if(!this.ledger.canSpend(e.payer,e.amount)){let i=this.ledger.getAvailableCapacity(e.payer);return{code:"INSUFFICIENT_CAPACITY",message:`Payer has insufficient capacity. Available: ${i}, Required: ${e.amount}`,details:{availableCapacity:i,requestedAmount:e.amount}}}return null}async getTransaction(e){let t=await this.storage.getTransaction(e);if(!t.ok)throw new Error(`Failed to get transaction: ${t.error.message}`);return t.value??void 0}getSigningData(e){return{payer:e.payer,payee:e.payee,amount:e.amount,description:e.description,createdAt:e.createdAt,nonce:e.nonce}}async signAsPayer(e,t){let r=await this.getTransaction(e);if(!r)throw new Ne({code:"NOT_FOUND",message:`Transaction ${e} not found`});if(r.status!=="PENDING")throw new Ne({code:"INVALID_STATUS",message:`Cannot sign transaction in status ${r.status}`});let i=await this.publicKeyResolver(r.payer);if(!i)throw new Ne({code:"INVALID_PAYER_SIGNATURE",message:`Could not resolve public key for payer ${r.payer}`});let o=this.getSigningData(r),d=xt(o);if(!this.crypto.verify(d,t,i))throw new Ne({code:"INVALID_PAYER_SIGNATURE",message:"Invalid payer signature"});return r.signatures.payer=t,r.signatures.payee&&(r.status="READY"),await this.storage.saveTransaction(r),r}async signAsPayee(e,t){let r=await this.getTransaction(e);if(!r)throw new Ne({code:"NOT_FOUND",message:`Transaction ${e} not found`});if(r.status!=="PENDING")throw new Ne({code:"INVALID_STATUS",message:`Cannot sign transaction in status ${r.status}`});let i=await this.publicKeyResolver(r.payee);if(!i)throw new Ne({code:"INVALID_PAYEE_SIGNATURE",message:`Could not resolve public key for payee ${r.payee}`});let o=this.getSigningData(r),d=xt(o);if(!this.crypto.verify(d,t,i))throw new Ne({code:"INVALID_PAYEE_SIGNATURE",message:"Invalid payee signature"});return r.signatures.payee=t,r.signatures.payer&&(r.status="READY"),await this.storage.saveTransaction(r),r}async executeTransaction(e){let t=await this.getTransaction(e);if(!t)throw new Ne({code:"NOT_FOUND",message:`Transaction ${e} not found`});let r=this.validateTransaction(t);if(r)throw t.status="FAILED",await this.storage.saveTransaction(t),new Ne(r);let i=[{memberId:t.payer,delta:-t.amount,reason:"SPOT_TRANSACTION_PAYER",referenceId:t.id},{memberId:t.payee,delta:+t.amount,reason:"SPOT_TRANSACTION_PAYEE",referenceId:t.id}];try{let o=await this.ledger.applyBalanceUpdates(i);return t.status="EXECUTED",t.executedAt=u(),await this.storage.saveTransaction(t),{transaction:t,payerNewBalance:o[0].newBalance,payeeNewBalance:o[1].newBalance,sequenceNumber:o[0].sequenceNumber}}catch(o){throw t.status="FAILED",await this.storage.saveTransaction(t),o instanceof Ae?new Ne({code:"LEDGER_ERROR",message:o.message,details:o.details}):o}}validateTransaction(e){return e.status!=="PENDING"&&e.status!=="READY"?{code:"INVALID_STATUS",message:`Transaction in invalid status for execution: ${e.status}`}:e.signatures.payer?e.signatures.payee?this.validateInput({payer:e.payer,payee:e.payee,amount:e.amount,description:e.description}):{code:"INVALID_PAYEE_SIGNATURE",message:"Missing payee signature"}:{code:"INVALID_PAYER_SIGNATURE",message:"Missing payer signature"}}async queueForOffline(e){let t={transaction:e,queuedAt:u(),attempts:0},r=await this.storage.queueTransaction(t);if(!r.ok)throw new Error(`Failed to queue transaction: ${r.error.message}`)}async getOfflineQueue(){let e=await this.storage.getQueuedTransactions();if(!e.ok)throw new Error(`Failed to get offline queue: ${e.error.message}`);return e.value}async processOfflineQueue(){let e=await this.getOfflineQueue(),t=[];for(let r of e)try{let i=await this.executeTransaction(r.transaction.id);t.push(i),await this.storage.removeFromQueue(r.transaction.id)}catch(i){r.attempts++,i instanceof Ne&&(r.lastError=i.toJSON()),await this.storage.queueTransaction(r)}return t}async getMemberTransactions(e,t=100,r=0){let i=await this.storage.getTransactionsByMember(e,t,r);if(!i.ok)throw new Error(`Failed to get transactions: ${i.error.message}`);return i.value}},Ne=class extends Error{constructor(e){super(e.message),this.name="TransactionValidationError",this.code=e.code,this.details=e.details}toJSON(){return{code:this.code,message:this.message,details:this.details}}};function nr(h,e,t,r){return new Ke(h,e,t,r)}var Qe=class{constructor(e,t,r,i){this.ledger=e,this.storage=t,this.crypto=r,this.sybilEngines=i}configureSybilResistance(e){this.sybilEngines=e}getSybilEngines(){return this.sybilEngines}async createIdentity(e,t){if(!t||t.trim().length===0)throw new me({code:"INVALID_DISPLAY_NAME",message:"Display name cannot be empty"});let r=this.crypto.generateKeyPair();if(!r.ok)throw new me({code:"CRYPTO_ERROR",message:`Failed to generate keypair: ${r.error.message}`});let{publicKey:i,secretKey:o}=r.value,d=this.crypto.deriveIdentityId(i),f=await this.storage.getIdentity(d);if(f.ok&&f.value)throw new me({code:"ALREADY_EXISTS",message:`Identity ${d} already exists`});let S=u(),b={id:d,cellId:e,displayName:t.trim(),publicKey:i,membershipStatus:"PENDING",createdAt:S,updatedAt:S},P=await this.storage.saveIdentity(b);if(!P.ok)throw new me({code:"STORAGE_ERROR",message:`Failed to save identity: ${P.error.message}`});return{identity:b,secretKey:o}}async importIdentity(e,t,r){if(!t||t.trim().length===0)throw new me({code:"INVALID_DISPLAY_NAME",message:"Display name cannot be empty"});if(!r||r.length<32)throw new me({code:"INVALID_PUBLIC_KEY",message:"Invalid public key format"});let i=this.crypto.deriveIdentityId(r),o=await this.storage.getIdentity(i);if(o.ok&&o.value)throw new me({code:"ALREADY_EXISTS",message:`Identity ${i} already exists`});let d=u(),f={id:i,cellId:e,displayName:t.trim(),publicKey:r,membershipStatus:"PENDING",createdAt:d,updatedAt:d},S=await this.storage.saveIdentity(f);if(!S.ok)throw new me({code:"STORAGE_ERROR",message:`Failed to save identity: ${S.error.message}`});return f}async getIdentity(e){let t=await this.storage.getIdentity(e);if(!t.ok)throw new me({code:"STORAGE_ERROR",message:`Failed to get identity: ${t.error.message}`});return t.value??void 0}async getIdentityByPublicKey(e){let t=await this.storage.getIdentityByPublicKey(e);if(!t.ok)throw new me({code:"STORAGE_ERROR",message:`Failed to get identity: ${t.error.message}`});return t.value??void 0}async updateDisplayName(e,t){let r=await this.getIdentity(e);if(!r)throw new me({code:"NOT_FOUND",message:`Identity ${e} not found`});if(!t||t.trim().length===0)throw new me({code:"INVALID_DISPLAY_NAME",message:"Display name cannot be empty"});r.displayName=t.trim(),r.updatedAt=u();let i=await this.storage.saveIdentity(r);if(!i.ok)throw new me({code:"STORAGE_ERROR",message:`Failed to save identity: ${i.error.message}`});return r}async addMember(e){let t=u(),r=await this.getIdentity(e.applicantId);if(r||(r=await this.importIdentity(this.ledger.getCellId(),e.displayName,e.publicKey)),e.sponsorId){let o=this.ledger.getMemberState(e.sponsorId);if(!o||o.status!=="ACTIVE")return{approved:!1,rejectionReason:"Sponsor is not an active member",decidedAt:t}}try{await this.ledger.addMember(e.applicantId,e.initialLimit)}catch(o){return{approved:!1,rejectionReason:o instanceof Error?o.message:"Failed to add member to ledger",decidedAt:t}}r.membershipStatus="ACTIVE",r.updatedAt=t,await this.storage.saveIdentity(r);let i={memberId:e.applicantId,previousStatus:"PENDING",newStatus:"ACTIVE",reason:e.notes||"Admitted",initiatorId:e.sponsorId||e.applicantId,changedAt:t};return await this.storage.saveMembershipChange(i),{approved:!0,identity:r,decidedAt:t}}async addMemberWithSybilResistance(e){let t=u(),r=await this.getIdentity(e.applicantId);if(r||(r=await this.importIdentity(this.ledger.getCellId(),e.displayName,e.publicKey)),e.requireSponsorBond&&!e.sponsorId)return{approved:!1,rejectionReason:"Sponsor bond required but no sponsor provided",decidedAt:t};if(e.sponsorId&&this.sybilEngines?.sponsorBonds){let b=await this.sybilEngines.sponsorBonds.canSponsor(e.sponsorId);if(!b.eligible)return{approved:!1,rejectionReason:`Sponsor not eligible: ${b.reason}`,decidedAt:t}}else if(e.sponsorId){let b=this.ledger.getMemberState(e.sponsorId);if(!b||b.status!=="ACTIVE")return{approved:!1,rejectionReason:"Sponsor is not an active member",decidedAt:t}}try{await this.ledger.addMember(e.applicantId,e.initialLimit)}catch(b){return{approved:!1,rejectionReason:b instanceof Error?b.message:"Failed to add member to ledger",decidedAt:t}}let i,o,d=!1,f;if(e.requireSponsorBond&&e.sponsorId&&this.sybilEngines?.sponsorBonds)try{i=(await this.sybilEngines.sponsorBonds.createBond({sponsorId:e.sponsorId,sponseeId:e.applicantId,bondAmount:e.sponsorBondAmount,probationDays:e.probationDays})).id}catch(b){return await this.ledger.removeMember(e.applicantId),{approved:!1,rejectionReason:b instanceof Error?b.message:"Failed to create sponsor bond",decidedAt:t}}if(e.requireServiceBond&&this.sybilEngines?.serviceBonds)try{o=(await this.sybilEngines.serviceBonds.createBond(e.applicantId)).id}catch(b){if(i&&this.sybilEngines?.sponsorBonds)try{await this.sybilEngines.sponsorBonds.releaseBond(i,"Admission rollback")}catch{}return await this.ledger.removeMember(e.applicantId),{approved:!1,rejectionReason:b instanceof Error?b.message:"Failed to create service bond",decidedAt:t}}if(e.startWithProbation&&this.sybilEngines?.probation)try{let b=e.probationDays??90,P=await this.sybilEngines.probation.startProbation(e.applicantId,b,i,o);d=!0,f=P.scheduledEndAt}catch(b){console.warn(`Failed to start probation for ${e.applicantId}:`,b)}r.membershipStatus=d?"PROBATION":"ACTIVE",r.updatedAt=t,await this.storage.saveIdentity(r);let S={memberId:e.applicantId,previousStatus:"PENDING",newStatus:r.membershipStatus,reason:e.notes||(d?"Admitted with probation":"Admitted"),initiatorId:e.sponsorId||e.applicantId,changedAt:t};return await this.storage.saveMembershipChange(S),{approved:!0,identity:r,decidedAt:t,sponsorBondId:i,serviceBondId:o,onProbation:d,probationEndsAt:f}}async graduateProbation(e,t){if(!this.sybilEngines?.probation)throw new me({code:"INVALID_STATUS_TRANSITION",message:"Probation tracker not configured"});let r=await this.getIdentity(e);if(!r)throw new me({code:"NOT_FOUND",message:`Identity ${e} not found`});if(r.membershipStatus!=="PROBATION")throw new me({code:"INVALID_STATUS_TRANSITION",message:`Member ${e} is not on probation`});let i=u();await this.sybilEngines.probation.graduateProbation(e),r.membershipStatus="ACTIVE",r.updatedAt=i,await this.storage.saveIdentity(r);let o={memberId:e,previousStatus:"PROBATION",newStatus:"ACTIVE",reason:"Graduated from probation",initiatorId:t,changedAt:i};await this.storage.saveMembershipChange(o);let d=this.sybilEngines.probation.getProbationState(e);if(d?.sponsorBondId&&this.sybilEngines.sponsorBonds)try{await this.sybilEngines.sponsorBonds.releaseBond(d.sponsorBondId,"Sponsee graduated")}catch(f){console.warn(`Failed to release sponsor bond for ${e}:`,f)}return o}isOnProbation(e){return this.sybilEngines?.probation?this.sybilEngines.probation.isOnProbation(e):!1}async getReputationScore(e){if(this.sybilEngines?.reputation)return this.sybilEngines.reputation.getScore(e)}async computeReputation(e){this.sybilEngines?.reputation&&await this.sybilEngines.reputation.computeReputation(e)}async freezeMember(e,t,r){let i=await this.getIdentity(e);if(!i)throw new me({code:"NOT_FOUND",message:`Identity ${e} not found`});let o=this.ledger.getMemberState(e);if(!o)throw new me({code:"NOT_FOUND",message:`Member ${e} not found in ledger`});if(o.status==="FROZEN")throw new me({code:"INVALID_STATUS_TRANSITION",message:"Member is already frozen"});if(o.status==="EXCLUDED")throw new me({code:"INVALID_STATUS_TRANSITION",message:"Cannot freeze an excluded member"});let d=i.membershipStatus,f=u();await this.ledger.updateMemberStatus(e,"FROZEN"),i.membershipStatus="FROZEN",i.updatedAt=f,await this.storage.saveIdentity(i);let S={memberId:e,previousStatus:d,newStatus:"FROZEN",reason:t,initiatorId:r,changedAt:f};return await this.storage.saveMembershipChange(S),S}async unfreezeMember(e,t,r){let i=await this.getIdentity(e);if(!i)throw new me({code:"NOT_FOUND",message:`Identity ${e} not found`});let o=this.ledger.getMemberState(e);if(!o)throw new me({code:"NOT_FOUND",message:`Member ${e} not found in ledger`});if(o.status!=="FROZEN")throw new me({code:"INVALID_STATUS_TRANSITION",message:`Cannot unfreeze member in status ${o.status}`});let d=u();await this.ledger.updateMemberStatus(e,"ACTIVE"),i.membershipStatus="ACTIVE",i.updatedAt=d,await this.storage.saveIdentity(i);let f={memberId:e,previousStatus:"FROZEN",newStatus:"ACTIVE",reason:t,initiatorId:r,changedAt:d};return await this.storage.saveMembershipChange(f),f}async removeMember(e,t,r){let i=await this.getIdentity(e);if(!i)throw new me({code:"NOT_FOUND",message:`Identity ${e} not found`});let o=this.ledger.getMemberState(e);if(!o)throw new me({code:"NOT_FOUND",message:`Member ${e} not found in ledger`});if(o.balance!==0)throw new me({code:"NON_ZERO_BALANCE",message:`Cannot remove member with balance ${o.balance}`,details:{balance:o.balance}});if(o.reserve!==0)throw new me({code:"PENDING_COMMITMENTS",message:`Cannot remove member with active reserves: ${o.reserve}`,details:{reserve:o.reserve}});let d=i.membershipStatus,f=u();await this.ledger.removeMember(e),i.membershipStatus="EXCLUDED",i.updatedAt=f,await this.storage.saveIdentity(i);let S={memberId:e,previousStatus:d,newStatus:"EXCLUDED",reason:t,initiatorId:r,changedAt:f};return await this.storage.saveMembershipChange(S),S}async getMembers(e){let t=await this.storage.getAllIdentities(e);if(!t.ok)throw new me({code:"STORAGE_ERROR",message:`Failed to get members: ${t.error.message}`});return t.value}async searchMembers(e,t){let i=await this.getMembers(e);if(t.displayName){let b=t.displayName.toLowerCase();i=i.filter(P=>P.displayName.toLowerCase().includes(b))}if(t.status){let b=Array.isArray(t.status)?t.status:[t.status];i=i.filter(P=>b.includes(P.membershipStatus))}(t.minBalance!==void 0||t.maxBalance!==void 0)&&(i=i.filter(b=>{let P=this.ledger.getMemberState(b.id);return!(!P||t.minBalance!==void 0&&P.balance<t.minBalance||t.maxBalance!==void 0&&P.balance>t.maxBalance)}));let o=i.length,d=t.offset??0,f=t.limit??100;return{members:i.slice(d,d+f),totalCount:o}}async verifySignature(e,t,r){let i=await this.getIdentity(e);return i?this.crypto.verify(t,r,i.publicKey):!1}},me=class extends Error{constructor(e){super(e.message),this.name="IdentityValidationError",this.code=e.code,this.details=e.details}toJSON(){return{code:this.code,message:this.message,details:this.details}}};function ir(h,e,t,r){return new Qe(h,e,t,r)}var Xe=class{constructor(e,t,r){this.ledger=e,this.transactions=t,this.storage=r}async createCommitment(e){let t=this.ledger.getMemberState(e.promisor);if(!t)throw new pe({code:"INVALID_PROMISOR",message:`Promisor ${e.promisor} not found`});if(t.status!=="ACTIVE")throw new pe({code:"INVALID_PROMISOR",message:`Promisor ${e.promisor} is not active`});let r=this.ledger.getMemberState(e.promisee);if(!r)throw new pe({code:"INVALID_PROMISEE",message:`Promisee ${e.promisee} not found`});if(r.status!=="ACTIVE")throw new pe({code:"INVALID_PROMISEE",message:`Promisee ${e.promisee} is not active`});if(e.promisor===e.promisee)throw new pe({code:"SELF_COMMITMENT",message:"Cannot create commitment to yourself"});if(e.value<=0)throw new pe({code:"INVALID_VALUE",message:"Commitment value must be positive"});if(e.dueDate&&e.dueDate<=u())throw new pe({code:"INVALID_DUE_DATE",message:"Due date must be in the future"});if(e.type==="ESCROWED"){let d=this.ledger.getAvailableCapacity(e.promisee);if(e.value>d)throw new pe({code:"INSUFFICIENT_CAPACITY",message:`Promisee ${e.promisee} has insufficient capacity: ${d} < ${e.value}`,details:{availableCapacity:d,required:e.value}})}let i={id:fe(),type:e.type,promisor:e.promisor,promisee:e.promisee,value:e.value,category:e.category,description:e.description,dueDate:e.dueDate,status:"ACTIVE",createdAt:u()};e.type==="ESCROWED"&&await this.ledger.applyReserveUpdate({memberId:e.promisee,delta:e.value,reason:"COMMITMENT_RESERVE",commitmentId:i.id});let o=await this.storage.saveCommitment(i);if(!o.ok)throw e.type==="ESCROWED"&&await this.ledger.applyReserveUpdate({memberId:e.promisee,delta:-e.value,reason:"COMMITMENT_RELEASE",commitmentId:i.id}),new pe({code:"STORAGE_ERROR",message:o.error.message});return await this.storage.appendEvent({cellId:this.ledger.getCellId(),type:"COMMITMENT_CREATED",timestamp:u(),data:{commitmentId:i.id,promisor:i.promisor,promisee:i.promisee,value:i.value,category:i.category,type:i.type}}),i}async acceptCommitment(e,t){let r=await this.getCommitment(e);if(!r)throw new pe({code:"NOT_FOUND",message:`Commitment ${e} not found`});if(r.status!=="PROPOSED")throw new pe({code:"INVALID_STATUS_TRANSITION",message:`Cannot accept commitment in status ${r.status}`});if(t!==r.promisor)throw new pe({code:"UNAUTHORIZED_CONFIRMATION",message:"Only promisor can accept commitment"});return r.status="ACTIVE",await this.storage.saveCommitment(r),r}async fulfillCommitment(e,t){let r=await this.getCommitment(e);if(!r)throw new pe({code:"NOT_FOUND",message:`Commitment ${e} not found`});if(r.status!=="ACTIVE")throw new pe({code:"INVALID_STATUS_TRANSITION",message:`Cannot fulfill commitment in status ${r.status}`});if(t.confirmedBy!==r.promisee)throw new pe({code:"UNAUTHORIZED_CONFIRMATION",message:"Only promisee can confirm fulfillment"});r.type==="ESCROWED"&&await this.ledger.applyReserveUpdate({memberId:r.promisee,delta:-r.value,reason:"COMMITMENT_RELEASE",commitmentId:r.id});let i=await this.transactions.createSpotTransaction({payer:r.promisee,payee:r.promisor,amount:r.value,description:`Commitment fulfilled: ${r.description}`}),o=await this.ledger.applyBalanceUpdates([{memberId:r.promisee,delta:-r.value,reason:"COMMITMENT_EXECUTE",referenceId:r.id},{memberId:r.promisor,delta:r.value,reason:"COMMITMENT_EXECUTE",referenceId:r.id}]);return r.status="FULFILLED",r.fulfilledAt=u(),await this.storage.saveCommitment(r),await this.storage.appendEvent({cellId:this.ledger.getCellId(),type:"COMMITMENT_FULFILLED",timestamp:u(),data:{commitmentId:r.id,confirmedBy:t.confirmedBy,rating:t.rating}}),{commitment:r,payerNewBalance:o[0].newBalance,payeeNewBalance:o[1].newBalance}}async cancelCommitment(e,t,r){let i=await this.getCommitment(e);if(!i)throw new pe({code:"NOT_FOUND",message:`Commitment ${e} not found`});if(i.status!=="PROPOSED"&&i.status!=="ACTIVE")throw new pe({code:"CANNOT_CANCEL",message:`Cannot cancel commitment in status ${i.status}`});if(r!==i.promisor&&r!==i.promisee)throw new pe({code:"UNAUTHORIZED_CONFIRMATION",message:"Only parties to the commitment can cancel it"});return i.type==="ESCROWED"&&i.status==="ACTIVE"&&await this.ledger.applyReserveUpdate({memberId:i.promisee,delta:-i.value,reason:"COMMITMENT_RELEASE",commitmentId:i.id}),i.status="CANCELLED",i.cancelledAt=u(),i.notes=t,await this.storage.saveCommitment(i),await this.storage.appendEvent({cellId:this.ledger.getCellId(),type:"COMMITMENT_CANCELLED",timestamp:u(),data:{commitmentId:i.id,initiator:r,reason:t}}),i}async disputeCommitment(e,t,r){let i=await this.getCommitment(e);if(!i)throw new pe({code:"NOT_FOUND",message:`Commitment ${e} not found`});if(i.status!=="ACTIVE")throw new pe({code:"INVALID_STATUS_TRANSITION",message:`Cannot dispute commitment in status ${i.status}`});if(r!==i.promisor&&r!==i.promisee)throw new pe({code:"UNAUTHORIZED_CONFIRMATION",message:"Only parties to the commitment can dispute it"});return i.status="DISPUTED",i.notes=t,await this.storage.saveCommitment(i),await this.storage.appendEvent({cellId:this.ledger.getCellId(),type:"COMMITMENT_DISPUTED",timestamp:u(),data:{commitmentId:i.id,initiator:r,reason:t}}),i}async getCommitment(e){let t=await this.storage.getCommitment(e);if(t.ok)return t.value??void 0}async getCommitmentsByMember(e){let t=await this.storage.getCommitmentsByMember(e);return t.ok?t.value:[]}async getActiveCommitments(){let e=await this.storage.getCommitmentsByStatus("ACTIVE");return e.ok?e.value:[]}async getOverdueCommitments(){let e=await this.getActiveCommitments(),t=u();return e.filter(r=>r.dueDate&&r.dueDate<t)}async getCommitmentsByCategory(e){let t=await this.storage.getCommitmentsByCategory(e);return t.ok?t.value:[]}getMemberReservedCapacity(e){return this.ledger.getMemberState(e)?.reserve??0}async getCategoryFulfillmentRate(e){let t=await this.getCommitmentsByCategory(e);if(t.length===0)return 0;let r=t.filter(o=>o.status==="FULFILLED").length,i=t.filter(o=>o.status==="FULFILLED"||o.status==="CANCELLED").length;return i===0?0:r/i}async getMemberStats(e){let t=await this.getCommitmentsByMember(e),r=t.filter(f=>f.promisor===e),i=t.filter(f=>f.promisee===e),o=r.filter(f=>f.status==="FULFILLED"),d=t.filter(f=>f.promisee===e&&f.type==="ESCROWED"&&f.status==="ACTIVE").reduce((f,S)=>f+S.value,0);return{asPromisor:r.length,asPromisee:i.length,fulfilledAsPromisor:o.length,averageRating:void 0,activeReservedValue:d}}},pe=class extends Error{constructor(e){super(e.message),this.name="CommitmentValidationError",this.code=e.code,this.details=e.details}toJSON(){return{code:this.code,message:this.message,details:this.details}}};function sr(h,e,t){return new Xe(h,e,t)}var Ze=class{constructor(e,t,r,i,o){this.cellId=e,this.ledger=t,this.identity=r,this.commitments=i,this.storage=o}async getCouncil(){let e=await this.storage.getCouncil(this.cellId);if(e.ok)return e.value??void 0}async isCouncilMember(e){let t=await this.getCouncil();return t?t.members.some(r=>r.memberId===e):!1}async initializeCouncil(e){let t={cellId:this.cellId,members:e,quorumRules:{standardQuorum:.5,supermajorityThreshold:.67,minimumVotes:1},termPolicy:{termDurationDays:90,maxConsecutiveTerms:3,minCouncilSize:1,maxCouncilSize:9},createdAt:u(),updatedAt:u()},r=await this.storage.saveCouncil(t);if(!r.ok)throw new de({code:"STORAGE_ERROR",message:r.error.message});return await this.storage.appendEvent({cellId:this.cellId,type:"COUNCIL_INITIALIZED",timestamp:u(),data:{memberIds:e.map(i=>i.memberId)}}),t}async createProposal(e){if(!await this.isCouncilMember(e.proposer))throw new de({code:"NOT_COUNCIL_MEMBER",message:`${e.proposer} is not a council member`});let r=e.votingDurationHours??72,i=u()+r*60*60*1e3,o={id:fe(),type:e.type,status:"OPEN",proposer:e.proposer,payload:e.payload,votes:[],createdAt:u(),closesAt:i,description:e.description},d=await this.storage.saveProposal(o);if(!d.ok)throw new de({code:"STORAGE_ERROR",message:d.error.message});return await this.storage.appendEvent({cellId:this.cellId,type:"PROPOSAL_CREATED",timestamp:u(),data:{proposalId:o.id,type:o.type,proposer:o.proposer}}),o}async castVote(e,t){let r=await this.getProposal(e);if(!r)throw new de({code:"PROPOSAL_NOT_FOUND",message:`Proposal ${e} not found`});if(r.status!=="OPEN")throw new de({code:"VOTING_CLOSED",message:`Voting is closed for proposal ${e}`});if(!await this.isCouncilMember(t.voterId))throw new de({code:"NOT_COUNCIL_MEMBER",message:`${t.voterId} is not a council member`});if(r.votes.some(d=>d.voterId===t.voterId))throw new de({code:"ALREADY_VOTED",message:`${t.voterId} has already voted`});let o={...t,proposalId:e};return r.votes.push(o),await this.storage.saveProposal(r),await this.storage.appendEvent({cellId:this.cellId,type:"VOTE_CAST",timestamp:u(),data:{proposalId:e,voterId:t.voterId,decision:t.decision}}),r}async closeVoting(e){let t=await this.getProposal(e);if(!t)throw new de({code:"PROPOSAL_NOT_FOUND",message:`Proposal ${e} not found`});if(t.status!=="OPEN")throw new de({code:"INVALID_STATUS_TRANSITION",message:`Cannot close voting for proposal in status ${t.status}`});let r=await this.getCouncil();if(!r)throw new de({code:"COUNCIL_NOT_FOUND",message:"Council not found"});let i=this.calculateOutcome(t,r);return t.status=i,await this.storage.saveProposal(t),await this.storage.appendEvent({cellId:this.cellId,type:"VOTING_CLOSED",timestamp:u(),data:{proposalId:e,outcome:i}}),t}calculateOutcome(e,t){let r=this.getActionCategory(e.type),i=r==="CRITICAL"||r==="CONSTITUTIONAL"?t.quorumRules.supermajorityThreshold:.5,o=t.quorumRules.standardQuorum,d=e.votes.filter(U=>U.decision==="APPROVE").length,f=e.votes.filter(U=>U.decision==="REJECT").length,S=d+f;return S/t.members.length<o?"REJECTED":S===0?"REJECTED":d/S>=i?"PASSED":"REJECTED"}async executeProposal(e){let t=await this.getProposal(e);if(!t)throw new de({code:"PROPOSAL_NOT_FOUND",message:`Proposal ${e} not found`});if(t.status!=="PASSED")throw new de({code:"PROPOSAL_NOT_PASSED",message:`Proposal ${e} has not passed`});switch(t.payload.type){case"MEMBER_ADMISSION":await this.identity.addMember(t.payload.admission);break;case"MEMBER_EXCLUSION":await this.identity.removeMember(t.payload.memberId,t.payload.reason,t.proposer);break;case"LIMIT_ADJUSTMENT":await this.ledger.updateMemberLimit(t.payload.memberId,t.payload.newLimit);break;case"COMMITMENT_CANCELLATION":await this.commitments.cancelCommitment(t.payload.commitmentId,t.payload.reason,t.proposer);break;case"DISPUTE_RESOLUTION":await this.resolveDispute(t.payload.disputeId,t.payload.resolution);break;default:break}t.status="EXECUTED",t.executedAt=u(),await this.storage.saveProposal(t),await this.storage.appendEvent({cellId:this.cellId,type:"PROPOSAL_EXECUTED",timestamp:u(),data:{proposalId:e}})}async getProposal(e){let t=await this.storage.getProposal(e);if(t.ok)return t.value??void 0}async getActiveProposals(){let e=await this.storage.getProposalsByStatus("OPEN");return e.ok?e.value:[]}async admitMember(e,t){if(!await this.isCouncilMember(t))throw new de({code:"NOT_COUNCIL_MEMBER",message:`${t} is not a council member`});await this.identity.addMember(e),await this.storage.appendEvent({cellId:this.cellId,type:"MEMBER_ADMITTED_DIRECT",timestamp:u(),data:{memberId:e.applicantId,approverId:t}})}async excludeMember(e,t,r){if(!await this.isCouncilMember(r))throw new de({code:"NOT_COUNCIL_MEMBER",message:`${r} is not a council member`});let o=this.ledger.getMemberState(e);if(o&&o.balance!==0)throw new de({code:"NON_ZERO_BALANCE",message:`Cannot exclude member with non-zero balance: ${o.balance}`});let f=(await this.commitments.getCommitmentsByMember(e)).filter(S=>S.status==="ACTIVE"||S.status==="PROPOSED");if(f.length>0)throw new de({code:"ACTIVE_COMMITMENTS",message:`Member has ${f.length} active commitments`});await this.identity.removeMember(e,t,r),await this.storage.appendEvent({cellId:this.cellId,type:"MEMBER_EXCLUDED_DIRECT",timestamp:u(),data:{memberId:e,reason:t,approverId:r}})}async adjustLimit(e,t,r){if(!await this.isCouncilMember(r))throw new de({code:"NOT_COUNCIL_MEMBER",message:`${r} is not a council member`});let o=this.ledger.getParameters();if(t<o.minLimit||t>o.maxLimit)throw new de({code:"INVALID_LIMIT",message:`Limit ${t} out of range [${o.minLimit}, ${o.maxLimit}]`});await this.ledger.updateMemberLimit(e,t),await this.storage.appendEvent({cellId:this.cellId,type:"LIMIT_ADJUSTED_DIRECT",timestamp:u(),data:{memberId:e,newLimit:t,approverId:r}})}async fileDispute(e){let t=this.ledger.getMemberState(e.complainant);if(!t||t.status!=="ACTIVE")throw new de({code:"UNAUTHORIZED",message:`Complainant ${e.complainant} is not an active member`});if(!this.ledger.getMemberState(e.respondent))throw new de({code:"UNAUTHORIZED",message:`Respondent ${e.respondent} not found`});let i=(e.evidence??[]).map(f=>({...f,id:fe(),timestamp:u()})),o={id:fe(),type:e.type,status:"FILED",complainant:e.complainant,respondent:e.respondent,commitmentId:e.commitmentId,description:e.description,evidence:i,filedAt:u()},d=await this.storage.saveDispute(o);if(!d.ok)throw new de({code:"STORAGE_ERROR",message:d.error.message});return await this.storage.appendEvent({cellId:this.cellId,type:"DISPUTE_FILED",timestamp:u(),data:{disputeId:o.id,complainant:o.complainant,respondent:o.respondent,type:o.type}}),o}async assignDisputeReviewer(e,t){let r=await this.getDispute(e);if(!r)throw new de({code:"DISPUTE_NOT_FOUND",message:`Dispute ${e} not found`});if(!await this.isCouncilMember(t))throw new de({code:"NOT_COUNCIL_MEMBER",message:`${t} is not a council member`});if(t===r.complainant||t===r.respondent)throw new de({code:"UNAUTHORIZED",message:"Reviewer cannot be a party to the dispute"});return r.reviewer=t,r.status="UNDER_REVIEW",await this.storage.saveDispute(r),await this.storage.appendEvent({cellId:this.cellId,type:"DISPUTE_REVIEWER_ASSIGNED",timestamp:u(),data:{disputeId:e,reviewerId:t}}),r}async addEvidence(e,t){let r=await this.getDispute(e);if(!r)throw new de({code:"DISPUTE_NOT_FOUND",message:`Dispute ${e} not found`});if(r.status==="RESOLVED"||r.status==="CLOSED")throw new de({code:"INVALID_STATUS_TRANSITION",message:"Cannot add evidence to resolved dispute"});if(t.submittedBy!==r.complainant&&t.submittedBy!==r.respondent&&t.submittedBy!==r.reviewer)throw new de({code:"UNAUTHORIZED",message:"Only parties to the dispute can add evidence"});let i={...t,id:fe(),timestamp:u()};return r.evidence.push(i),await this.storage.saveDispute(r),r}async resolveDispute(e,t){let r=await this.getDispute(e);if(!r)throw new de({code:"DISPUTE_NOT_FOUND",message:`Dispute ${e} not found`});if(!await this.isCouncilMember(t.decidedBy))throw new de({code:"NOT_COUNCIL_MEMBER",message:`${t.decidedBy} is not a council member`});if(r.resolution=t,r.status="RESOLVED",r.resolvedAt=u(),t.actions)for(let o of t.actions)switch(o.type){case"CANCEL_COMMITMENT":r.commitmentId&&await this.commitments.cancelCommitment(r.commitmentId,t.explanation,r.complainant);break;case"COMPENSATION":break}return await this.storage.saveDispute(r),await this.storage.appendEvent({cellId:this.cellId,type:"DISPUTE_RESOLVED",timestamp:u(),data:{disputeId:e,outcome:t.outcome,decidedBy:t.decidedBy}}),r}async getDispute(e){let t=await this.storage.getDispute(e);if(t.ok)return t.value??void 0}async getActiveDisputes(){let e=["FILED","UNDER_REVIEW","HEARING_SCHEDULED"],t=await Promise.all(e.map(i=>this.storage.getDisputesByStatus(i))),r=[];for(let i of t)i.ok&&r.push(...i.value);return r}async checkActionPermission(e,t){return this.isCouncilMember(t)}getActionCategory(e){switch(e){case"MEMBER_EXCLUSION":case"EMERGENCY_STATE":case"PARAMETER_CHANGE":return"CRITICAL";case"COUNCIL_ELECTION":return"CONSTITUTIONAL";case"MEMBER_ADMISSION":case"LIMIT_ADJUSTMENT":return"SIGNIFICANT";default:return"ROUTINE"}}},de=class extends Error{constructor(e){super(e.message),this.name="GovernanceValidationError",this.code=e.code,this.details=e.details}toJSON(){return{code:this.code,message:this.message,details:this.details}}};function or(h,e,t,r,i){return new Ze(h,e,t,r,i)}var Je=class{constructor(e,t,r){this.debtorPriorityEnabled=!1;this.ledger=e,this.commitments=t,this.storage=r}setEnergyEngine(e){this.energy=e}async createTaskTemplate(e){let t={id:fe(),category:e.category,name:e.name,hoursRequired:e.hoursRequired,creditValue:e.creditValue,maxAssignees:e.maxAssignees,dayOfWeek:e.dayOfWeek,startHour:e.startHour,durationHours:e.durationHours,active:!0,description:e.description},r=await this.storage.saveTaskTemplate(t);if(!r.ok)throw new Ee({code:"STORAGE_ERROR",message:r.error.message});return t}async getTaskTemplate(e){let t=await this.storage.getTaskTemplate(e);if(t.ok)return t.value??void 0}async generateSlotsFromTemplate(e,t){let r=await this.getTaskTemplate(e);if(!r)throw new Ee({code:"TEMPLATE_NOT_FOUND",message:`Template ${e} not found`});let i=[],o=new Date(t);for(let d=0;d<7;d++){if(r.dayOfWeek!==null&&r.dayOfWeek!==void 0&&r.dayOfWeek!==d)continue;let f=new Date(o);f.setDate(f.getDate()+d),f.setHours(r.startHour,0,0,0);let S=f.getTime(),b=S+r.durationHours*60*60*1e3,P={id:fe(),category:r.category,name:r.name,startTime:S,endTime:b,hoursRequired:r.hoursRequired,creditValue:r.creditValue,maxAssignees:r.maxAssignees,status:"OPEN",assignments:[],templateId:e,description:r.description};(await this.storage.saveTaskSlot(P)).ok&&i.push(P)}return i}async getActiveTemplates(){let e=await this.storage.getAllTaskTemplates();return e.ok?e.value.filter(t=>t.active):[]}async createTaskSlot(e){if(e.endTime<=e.startTime)throw new Ee({code:"INVALID_TIME_RANGE",message:"End time must be after start time"});if(e.hoursRequired<=0)throw new Ee({code:"INVALID_HOURS",message:"Hours required must be positive"});let t={id:fe(),category:e.category,name:e.name,startTime:e.startTime,endTime:e.endTime,hoursRequired:e.hoursRequired,creditValue:e.creditValue,maxAssignees:e.maxAssignees,status:"OPEN",assignments:[],description:e.description},r=await this.storage.saveTaskSlot(t);if(!r.ok)throw new Ee({code:"STORAGE_ERROR",message:r.error.message});return t}async getTaskSlot(e){let t=await this.storage.getTaskSlot(e);if(t.ok)return t.value??void 0}async getOpenSlots(e){let t=await this.storage.getTaskSlotsByStatus("OPEN");if(!t.ok)return[];let r=t.value;return e&&(r=r.filter(i=>i.category===e)),r}async getSlotsByPeriod(e,t){let r=await this.storage.getTaskSlotsByPeriod(e,t);return r.ok?r.value:[]}async runMatching(e){let t=e+6048e5,i=(await this.getSlotsByPeriod(e,t)).filter(V=>V.status==="OPEN"||V.status==="PARTIALLY_FILLED"),o=await this.storage.getAllMemberSupplies(),d=o.ok?o.value:[],f=[],S=[],b=new Set,P=["MEDICAL","FOOD","WATER_SANITATION","ENERGY_HEAT","CHILDCARE_DEPENDENT","SECURITY_COORDINATION","SHELTER_REPAIR","PROCUREMENT_TRANSPORT","GENERAL"];i.sort((V,le)=>{let Se=P.indexOf(V.category),Oe=P.indexOf(le.category);return Se-Oe});for(let V of i){let le=V.maxAssignees-V.assignments.length;if(le<=0)continue;let Se=d.filter(be=>!b.has(be.memberId)).filter(be=>{let we=this.ledger.getMemberState(be.memberId);return we&&we.status==="ACTIVE"}).map(be=>({supply:be,score:this.scoreCandidate(be,V)})).filter(be=>be.score>0).sort((be,we)=>we.score-be.score);for(let be=0;be<Math.min(le,Se.length);be++){let we=Se[be];try{let Fe=await this.assignMember(V.id,we.supply.memberId,V.hoursRequired/V.maxAssignees);f.push(Fe),b.add(we.supply.memberId)}catch{}}let Oe=await this.getTaskSlot(V.id);Oe&&Oe.assignments.length<Oe.maxAssignees&&S.push(V.id)}let U=d.filter(V=>!b.has(V.memberId)).map(V=>V.memberId),q=i.length,re=q-S.length,j=q>0?re/q:1;return{assignments:f,unfilledSlots:S,unassignedMembers:U,coverageAchieved:j,matchingScore:j}}scoreCandidate(e,t){let r=e.skills.get(t.category)??.5,i=e.preferences.includes(t.category)?1:0,o=0;if(this.debtorPriorityEnabled){let f=this.ledger.getMemberState(e.memberId);f&&f.balance<0&&(o=-f.balance/f.limit*2)}let d=this.energy?this.energy.canCompleteTask(t.category,t.hoursRequired/t.maxAssignees)?1:.5:1;return r*.35+i*.15+o*.35+d*.15}async assignMember(e,t,r){let i=await this.getTaskSlot(e);if(!i)throw new Ee({code:"SLOT_NOT_FOUND",message:`Slot ${e} not found`});if(i.status!=="OPEN"&&i.status!=="PARTIALLY_FILLED")throw new Ee({code:"INVALID_SLOT_STATUS",message:`Cannot assign to slot in status ${i.status}`});if(i.assignments.length>=i.maxAssignees)throw new Ee({code:"SLOT_FULL",message:"Slot is full"});if(i.assignments.some(S=>S.memberId===t))throw new Ee({code:"ALREADY_ASSIGNED",message:`Member ${t} already assigned to slot`});let o=this.ledger.getMemberState(t);if(!o||o.status!=="ACTIVE")throw new Ee({code:"MEMBER_NOT_FOUND",message:`Member ${t} not found or not active`});let d=Math.floor(r/i.hoursRequired*i.creditValue),f={slotId:e,memberId:t,hoursAssigned:r,status:"ASSIGNED",assignedAt:u()};return i.assignments.push(f),i.assignments.length>=i.maxAssignees?i.status="FILLED":i.status="PARTIALLY_FILLED",await this.storage.saveTaskSlot(i),await this.storage.appendEvent({cellId:this.ledger.getCellId(),type:"MEMBER_ASSIGNED_TO_SLOT",timestamp:u(),data:{slotId:e,memberId:t,hours:r}}),f}async confirmAssignment(e,t){let r=await this.getTaskSlot(e);if(!r)throw new Ee({code:"SLOT_NOT_FOUND",message:`Slot ${e} not found`});let i=r.assignments.find(o=>o.memberId===t);if(!i)throw new Ee({code:"NOT_ASSIGNED",message:`Member ${t} not assigned to slot`});return i.status="CONFIRMED",i.confirmedAt=u(),await this.storage.saveTaskSlot(r),i}async unassignMember(e,t){let r=await this.getTaskSlot(e);if(!r)throw new Ee({code:"SLOT_NOT_FOUND",message:`Slot ${e} not found`});let i=r.assignments.findIndex(d=>d.memberId===t);if(i===-1)throw new Ee({code:"NOT_ASSIGNED",message:`Member ${t} not assigned to slot`});let o=r.assignments[i];o.commitmentId&&await this.commitments.cancelCommitment(o.commitmentId,"Unassigned from slot",t),r.assignments.splice(i,1),r.assignments.length===0?r.status="OPEN":r.assignments.length<r.maxAssignees&&(r.status="PARTIALLY_FILLED"),await this.storage.saveTaskSlot(r),await this.storage.appendEvent({cellId:this.ledger.getCellId(),type:"MEMBER_UNASSIGNED_FROM_SLOT",timestamp:u(),data:{slotId:e,memberId:t}})}async recordCompletion(e,t,r){let i=await this.getTaskSlot(e);if(!i)throw new Ee({code:"SLOT_NOT_FOUND",message:`Slot ${e} not found`});let o=i.assignments.find(f=>f.memberId===t);if(!o)throw new Ee({code:"NOT_ASSIGNED",message:`Member ${t} not assigned to slot`});if(o.status="COMPLETED",o.completedAt=u(),r!==void 0&&(o.rating=r),i.assignments.every(f=>f.status==="COMPLETED"||f.status==="NO_SHOW")?i.status="COMPLETED":i.status="IN_PROGRESS",await this.storage.saveTaskSlot(i),await this.storage.appendEvent({cellId:this.ledger.getCellId(),type:"TASK_COMPLETED",timestamp:u(),data:{slotId:e,memberId:t,rating:r}}),o.commitmentId){let f=await this.commitments.fulfillCommitment(o.commitmentId,{commitmentId:o.commitmentId,confirmedBy:t,rating:r,timestamp:u()});return{assignment:o,payerNewBalance:f.payerNewBalance,payeeNewBalance:f.payeeNewBalance}}return{assignment:o}}async recordNoShow(e,t){let r=await this.getTaskSlot(e);if(!r)throw new Ee({code:"SLOT_NOT_FOUND",message:`Slot ${e} not found`});let i=r.assignments.find(d=>d.memberId===t);if(!i)throw new Ee({code:"NOT_ASSIGNED",message:`Member ${t} not assigned to slot`});if(i.status="NO_SHOW",i.commitmentId&&await this.commitments.cancelCommitment(i.commitmentId,"No show",t),r.assignments.every(d=>d.status==="COMPLETED"||d.status==="NO_SHOW")){let d=r.assignments.some(f=>f.status==="COMPLETED");r.status=d?"COMPLETED":"INCOMPLETE"}await this.storage.saveTaskSlot(r),await this.storage.appendEvent({cellId:this.ledger.getCellId(),type:"MEMBER_NO_SHOW",timestamp:u(),data:{slotId:e,memberId:t}})}async checkCoverageFeasibility(e){let t=e+6048e5,r=await this.getSlotsByPeriod(e,t),i=await this.storage.getAllMemberSupplies(),o=i.ok?i.value:[],d=new Map;for(let j of r){let V=d.get(j.category)??0;d.set(j.category,V+j.hoursRequired)}let f=new Map;for(let j of o){let V=Array.from(j.skills.values()).reduce((le,Se)=>le+Se,0)||1;for(let[le,Se]of j.skills){let Oe=Se/V*j.weeklyAvailableHours,be=f.get(le)??0;f.set(le,be+Oe)}}let S=new Map,b=[],P=[],U=0,q=0;for(let[j,V]of d){U+=V;let le=f.get(j)??0;q+=le;let Se=le-V;S.set(j,Se),Se<0&&(b.push(`${j}: ${Math.abs(Se)} hours short`),P.push(`Recruit more members skilled in ${j}`))}return{feasible:b.length===0,totalRequired:U,totalAvailable:q,categoryGaps:S,bottlenecks:b,recommendations:P}}async getCoverageReport(e){let t=e+6048e5,r=await this.getSlotsByPeriod(e,t),i=new Map,o=0,d=0,f=0,S=0;for(let P of r){o++,f+=P.hoursRequired;let U=P.status==="FILLED"||P.status==="IN_PROGRESS"||P.status==="COMPLETED";U&&d++;let re=P.assignments.filter(V=>V.status==="COMPLETED").reduce((V,le)=>V+le.hoursAssigned,0);S+=re;let j=i.get(P.category)??{total:0,filled:0,completed:0,hours:0,coveredHours:0};j.total++,U&&j.filled++,P.status==="COMPLETED"&&j.completed++,j.hours+=P.hoursRequired,j.coveredHours+=re,i.set(P.category,j)}let b=new Map;for(let[P,U]of i)b.set(P,{category:P,totalSlots:U.total,filledSlots:U.filled,completedSlots:U.completed,totalHours:U.hours,coveredHours:U.coveredHours,coverageRate:U.total>0?U.filled/U.total:1});return{periodStart:e,periodEnd:t,overallCoverage:o>0?d/o:1,categoryBreakdown:b,totalSlots:o,filledSlots:d,totalHoursScheduled:f,totalHoursCompleted:S}}async getMemberSchedule(e,t){let r=t+6048e5;return(await this.getSlotsByPeriod(t,r)).filter(o=>o.assignments.some(d=>d.memberId===e))}async updateMemberSupply(e){let t=await this.storage.saveMemberSupply(e);if(!t.ok)throw new Ee({code:"STORAGE_ERROR",message:t.error.message})}async getMemberSupply(e){let t=await this.storage.getMemberSupply(e);if(t.ok)return t.value??void 0}enableDebtorPriorityMatching(){this.debtorPriorityEnabled=!0}disableDebtorPriorityMatching(){this.debtorPriorityEnabled=!1}isDebtorPriorityEnabled(){return this.debtorPriorityEnabled}getEssentialTaskCategories(){return[{category:"MEDICAL",minimumWeeklyHours:4,isEssential:!0},{category:"FOOD",minimumWeeklyHours:14,isEssential:!0},{category:"WATER_SANITATION",minimumWeeklyHours:7,isEssential:!0},{category:"ENERGY_HEAT",minimumWeeklyHours:7,isEssential:!0},{category:"CHILDCARE_DEPENDENT",minimumWeeklyHours:14,isEssential:!0},{category:"SECURITY_COORDINATION",minimumWeeklyHours:7,isEssential:!0},{category:"SHELTER_REPAIR",minimumWeeklyHours:4,isEssential:!1},{category:"PROCUREMENT_TRANSPORT",minimumWeeklyHours:7,isEssential:!1},{category:"GENERAL",minimumWeeklyHours:7,isEssential:!1}]}calculateWeeklyBundleCost(){let t=this.getEssentialTaskCategories().filter(i=>i.isEssential).reduce((i,o)=>i+o.minimumWeeklyHours,0),r=this.ledger.getStatistics().memberCount;return r>0?t/r:0}getEnergyEngine(){return this.energy}},Ee=class extends Error{constructor(e){super(e.message),this.name="SchedulerValidationError",this.code=e.code,this.details=e.details}toJSON(){return{code:this.code,message:this.message,details:this.details}}};function cr(h,e,t){return new Je(h,e,t)}var tt=class{constructor(e,t,r,i={}){this.cellId=e,this.ledger=t,this.storage=r;let o=u();this.state={cellId:e,riskState:"NORMAL",currentPolicy:{...Tt.NORMAL},indicators:this.createEmptyIndicators(o),thresholds:{...Qt,...i},lastStateChange:o,panicEnteredAt:null,lastIndicatorUpdate:o,createdAt:o,updatedAt:o}}setGovernanceEngine(e){this.governance=e}setIdentityEngine(e){this.identity=e}setEnergyEngine(e){this.energy=e}getCellId(){return this.cellId}getCurrentRiskState(){return this.state.riskState}getStressIndicators(){return{...this.state.indicators}}getCurrentPolicy(){return{...this.state.currentPolicy}}getThresholds(){return{...this.state.thresholds}}async updateIndicators(){let e=u(),t=this.ledger.getStatistics(),r=0,i=this.ledger.getAllMemberStates(),o=.05;for(let[,V]of i){let le=V.balance+V.limit,Se=V.limit*o;le<=Se&&(r+=V.limit)}let d=t.aggregateCapacity>0?r/t.aggregateCapacity:0,f=Array.from(i.values()).map(V=>V.balance),S=this.calculateVarianceCoefficient(f),b=0;if(this.governance){let V=await this.governance.getActiveDisputes();b=t.memberCount>0?V.length/t.memberCount:0}let P=0,U=this.energy?this.energy.calculateEnergyStress():0,q=d*.5+b*.3+S*.2,re=Math.max(q,U),j={floorMass:d,balanceVariance:S,disputeRate:b,memberChurn:P,energyStress:U,economicStress:q,overallStress:re,calculatedAt:e};return this.state.indicators=j,this.state.lastIndicatorUpdate=e,this.state.updatedAt=e,await this.saveState(),j}calculateVarianceCoefficient(e){if(e.length===0)return 0;let t=e.reduce((d,f)=>d+f,0)/e.length;if(t===0)return 0;let i=e.map(d=>Math.pow(d-t,2)).reduce((d,f)=>d+f,0)/e.length;return Math.sqrt(i)/Math.abs(t)}async checkStateTransition(){let{indicators:e,thresholds:t,riskState:r}=this.state;if(r==="NORMAL"){if(e.floorMass>=t.stressedFloorMass)return{shouldTransition:!0,targetState:"STRESSED",reason:"INDICATOR_TRIGGERED",explanation:`Floor mass ${(e.floorMass*100).toFixed(1)}% >= threshold ${(t.stressedFloorMass*100).toFixed(1)}%`,triggeringIndicators:{floorMass:e.floorMass}};if(e.disputeRate>=t.stressedDisputeRate)return{shouldTransition:!0,targetState:"STRESSED",reason:"INDICATOR_TRIGGERED",explanation:`Dispute rate ${(e.disputeRate*100).toFixed(1)}% >= threshold ${(t.stressedDisputeRate*100).toFixed(1)}%`,triggeringIndicators:{disputeRate:e.disputeRate}}}if(r==="STRESSED"){if(e.floorMass>=t.panicFloorMass)return{shouldTransition:!0,targetState:"PANIC",reason:"INDICATOR_TRIGGERED",explanation:`Floor mass ${(e.floorMass*100).toFixed(1)}% >= panic threshold ${(t.panicFloorMass*100).toFixed(1)}%`,triggeringIndicators:{floorMass:e.floorMass}};if(e.energyStress>=t.panicEnergyStress)return{shouldTransition:!0,targetState:"PANIC",reason:"INDICATOR_TRIGGERED",explanation:`Energy stress ${e.energyStress.toFixed(2)} >= threshold ${t.panicEnergyStress.toFixed(2)}`,triggeringIndicators:{energyStress:e.energyStress}};if(e.floorMass<=t.normalFloorMass&&e.overallStress<=t.normalOverallStress)return{shouldTransition:!0,targetState:"NORMAL",reason:"INDICATOR_TRIGGERED",explanation:"Indicators below de-escalation thresholds",triggeringIndicators:{floorMass:e.floorMass,overallStress:e.overallStress}}}return r==="PANIC"&&(this.state.panicEnteredAt?u()-this.state.panicEnteredAt:1/0)>=t.panicStabilizationPeriod&&e.floorMass<=t.normalFloorMass&&e.overallStress<=t.normalOverallStress?{shouldTransition:!0,targetState:"STRESSED",reason:"STABILIZATION_COMPLETE",explanation:"Stabilization period complete and indicators below thresholds",triggeringIndicators:{floorMass:e.floorMass,overallStress:e.overallStress}}:{shouldTransition:!1}}async triggerStateChange(e,t,r,i){let o=this.state.riskState;if(!this.isValidTransition(o,e,t))throw new et({code:"INVALID_TRANSITION",message:`Invalid transition from ${o} to ${e}`});let d={fromState:o,toState:e,reason:t,timestamp:u(),indicators:{...this.state.indicators},governanceApprovalId:r,initiatedBy:i};await this.storage.appendStateHistoryEntry(d,this.cellId),this.state.riskState=e,this.state.currentPolicy={...Tt[e]},this.state.lastStateChange=u(),this.state.updatedAt=u(),e==="PANIC"?this.state.panicEnteredAt=u():o==="PANIC"&&(this.state.panicEnteredAt=null),await this.saveState(),await this.storage.appendEvent({cellId:this.cellId,type:"EMERGENCY_STATE_CHANGE",timestamp:u(),data:{fromState:o,toState:e,reason:t,governanceApprovalId:r,initiatedBy:i}})}isValidTransition(e,t,r){if(e===t)return!1;if(r==="GOVERNANCE_OVERRIDE"||r==="FORCED_DEESCALATION")return!0;let i=["NORMAL","STRESSED","PANIC"],o=i.indexOf(e),d=i.indexOf(t);return Math.abs(d-o)===1}async forceDeEscalation(e,t,r){let i=this.state.riskState;if(i==="NORMAL")throw new et({code:"INVALID_TRANSITION",message:"Already in NORMAL state, cannot de-escalate further"});let o=i==="PANIC"?"STRESSED":"NORMAL";await this.triggerStateChange(o,"FORCED_DEESCALATION",t,r),await this.storage.appendEvent({cellId:this.cellId,type:"FORCED_DEESCALATION",timestamp:u(),data:{reason:e,governanceApprovalId:t,initiatedBy:r,fromState:i,toState:o}})}analyzeThresholdProximity(){let{indicators:e,thresholds:t,riskState:r,panicEnteredAt:i}=this.state,o=1/0,d=1/0,f="none",S=!1,b;if(r==="NORMAL"){let U=t.stressedFloorMass-e.floorMass,q=t.stressedDisputeRate-e.disputeRate;o=Math.min(U,q),f=U<q?"floorMass":"disputeRate",d=1/0}else if(r==="STRESSED"){let U=t.panicFloorMass-e.floorMass,q=t.panicEnergyStress-e.energyStress;o=Math.min(U,q),f=U<q?"floorMass":"energyStress",d=Math.max(e.floorMass-t.normalFloorMass,e.overallStress-t.normalOverallStress)}else if(r==="PANIC"){o=1/0;let U=i?u()-i:0,q=Math.max(0,t.panicStabilizationPeriod-U);q>0?(S=!0,b=`Stabilization period: ${Math.ceil(q/(3600*1e3))}h remaining`,d=1/0):d=Math.max(e.floorMass-t.normalFloorMass,e.overallStress-t.normalOverallStress),f="floorMass"}let P=r==="PANIC"&&i?Math.max(0,t.panicStabilizationPeriod-(u()-i)):null;return{currentState:r,distanceToEscalation:o,distanceToDeescalation:d,criticalIndicator:f,timeUntilStabilization:P,deescalationBlocked:S,blockReason:b}}async getStateHistory(e){let t=await this.storage.getStateHistory(this.cellId,e);return t.ok?t.value:[]}isFederationFrozen(){return this.state.currentPolicy.federationBetaFactor===0}getEffectiveLimitFactor(e){return e?this.state.currentPolicy.newMemberLimitFactor:this.state.currentPolicy.limitFactor}async saveState(){let e=await this.storage.saveEmergencyState(this.state);if(!e.ok)throw new et({code:"STORAGE_ERROR",message:e.error.message})}async loadState(){let e=await this.storage.getEmergencyState(this.cellId);e.ok&&e.value&&(this.state=e.value)}createEmptyIndicators(e){return{floorMass:0,balanceVariance:0,disputeRate:0,memberChurn:0,energyStress:0,economicStress:0,overallStress:0,calculatedAt:e}}},et=class extends Error{constructor(e){super(e.message),this.name="EmergencyValidationError",this.code=e.code,this.details=e.details}toJSON(){return{code:this.code,message:this.message,details:this.details}}};function lr(h,e,t,r={}){return new tt(h,e,t,r)}var rt=class{constructor(e,t,r,i={}){this.cellId=e,this.ledger=t,this.storage=r,this.parameters={...Zt,...i},this.clearingAccountId=`clearing-${e}`;let o=u();this.state={cellId:e,federationPosition:0,clearingAccountId:this.clearingAccountId,exposureCap:0,betaFactor:this.parameters.baseBetaFactor,connectedCells:[],status:"ACTIVE",createdAt:o,updatedAt:o}}async initialize(){this.ledger.getMemberState(this.clearingAccountId)||(await this.ledger.addMember(this.clearingAccountId,0),await this.ledger.updateMemberStatus(this.clearingAccountId,"ACTIVE")),await this.recalculateExposureCap();let t=await this.storage.getFederationState(this.cellId);t.ok&&t.value?this.state=t.value:await this.saveState()}setEmergencyEngine(e){this.emergency=e}getCellId(){return this.cellId}getFederationState(){return{...this.state,connectedCells:[...this.state.connectedCells.map(e=>({...e}))]}}getPosition(){return this.state.federationPosition}getExposureCap(){return this.state.exposureCap}getAvailableCapacity(){return Math.max(0,this.state.exposureCap-Math.abs(this.state.federationPosition))}getConnectedCells(){return[...this.state.connectedCells.map(e=>({...e}))]}getLink(e){let t=this.state.connectedCells.find(r=>r.remoteCellId===e);return t?{...t}:void 0}getClearingAccountId(){return this.clearingAccountId}async proposeLink(e,t={}){let r=this.getLink(e);if(r&&r.status!=="PENDING")throw new ge({code:"LINK_SUSPENDED",message:`Link to ${e} already exists`});let i={id:er(),initiatorCellId:this.cellId,targetCellId:e,proposedTerms:{...Xt,...t},createdAt:u(),expiresAt:u()+10080*60*1e3,status:"PENDING"},o=await this.storage.saveLinkProposal(i);if(!o.ok)throw new ge({code:"STORAGE_ERROR",message:o.error.message});return this.state.connectedCells.push({remoteCellId:e,status:"PENDING",bilateralPosition:0,establishedAt:u(),lastActivity:u()}),await this.saveState(),await this.storage.appendEvent({cellId:this.cellId,type:"LINK_PROPOSED",timestamp:u(),data:{proposalId:i.id,remoteCellId:e}}),i}async acceptLink(e){let t=await this.storage.getLinkProposal(e);if(!t.ok||!t.value)throw new ge({code:"PROPOSAL_NOT_FOUND",message:`Proposal ${e} not found`});let r=t.value;if(r.status!=="PENDING")throw new ge({code:"INVALID_TX_STATE",message:`Proposal is not pending: ${r.status}`});if(u()>r.expiresAt)throw new ge({code:"PROPOSAL_EXPIRED",message:"Proposal has expired"});r.status="ACCEPTED",r.respondedAt=u(),await this.storage.saveLinkProposal(r);let i=this.cellId===r.initiatorCellId?r.targetCellId:r.initiatorCellId,o=this.state.connectedCells.findIndex(f=>f.remoteCellId===i),d={remoteCellId:i,status:"ACTIVE",bilateralPosition:0,establishedAt:u(),lastActivity:u()};return o>=0?this.state.connectedCells[o]=d:this.state.connectedCells.push(d),await this.saveState(),await this.storage.appendEvent({cellId:this.cellId,type:"LINK_ACCEPTED",timestamp:u(),data:{proposalId:e,remoteCellId:r.initiatorCellId}}),d}async rejectLink(e,t){let r=await this.storage.getLinkProposal(e);if(!r.ok||!r.value)throw new ge({code:"PROPOSAL_NOT_FOUND",message:`Proposal ${e} not found`});let i=r.value;i.status="REJECTED",i.respondedAt=u(),i.rejectionReason=t,await this.storage.saveLinkProposal(i),this.state.connectedCells=this.state.connectedCells.filter(o=>o.remoteCellId!==i.initiatorCellId||o.status!=="PENDING"),await this.saveState()}async suspendLink(e,t){let r=this.state.connectedCells.findIndex(i=>i.remoteCellId===e);if(r<0)throw new ge({code:"LINK_NOT_FOUND",message:`Link to ${e} not found`});this.state.connectedCells[r].status="SUSPENDED",this.state.connectedCells[r].suspensionReason=t,this.state.connectedCells[r].suspendedAt=u(),await this.saveState(),await this.storage.appendEvent({cellId:this.cellId,type:"LINK_SUSPENDED",timestamp:u(),data:{remoteCellId:e,reason:t}})}async resumeLink(e){let t=this.state.connectedCells.findIndex(r=>r.remoteCellId===e);if(t<0)throw new ge({code:"LINK_NOT_FOUND",message:`Link to ${e} not found`});this.state.connectedCells[t].status="ACTIVE",this.state.connectedCells[t].suspensionReason=void 0,this.state.connectedCells[t].suspendedAt=void 0,await this.saveState(),await this.storage.appendEvent({cellId:this.cellId,type:"LINK_RESUMED",timestamp:u(),data:{remoteCellId:e}})}async validateInterCellTx(e){if(this.emergency?.isFederationFrozen())throw new ge({code:"FEDERATION_FROZEN",message:"Federation is frozen due to PANIC mode"});if(this.state.status==="QUARANTINED")throw new ge({code:"CELL_QUARANTINED",message:`Cell is quarantined: ${this.state.quarantineReason}`});if(e.amount<=0)throw new ge({code:"INVALID_AMOUNT",message:"Amount must be positive"});if(e.sourceCell===this.cellId){let r=this.getLink(e.targetCell);if(!r)throw new ge({code:"LINK_NOT_FOUND",message:`No link to cell ${e.targetCell}`});if(r.status==="SUSPENDED")throw new ge({code:"LINK_SUSPENDED",message:`Link to ${e.targetCell} is suspended`});if(!this.ledger.canSpend(e.payer,e.amount))throw new ge({code:"LEDGER_ERROR",message:"Payer cannot spend the requested amount"});let i=this.state.federationPosition+e.amount;if(Math.abs(i)>this.state.exposureCap)throw new ge({code:"CAP_EXCEEDED",message:`Transaction would exceed exposure cap: |${i}| > ${this.state.exposureCap}`,details:{newPosition:i,cap:this.state.exposureCap}})}}async executeInterCellTx(e){await this.validateInterCellTx(e);let t=e.sourceCell===this.cellId,r={id:Jt(),sourceCell:e.sourceCell,targetCell:e.targetCell,payer:e.payer,payee:e.payee,amount:e.amount,status:"PENDING",memo:e.memo,createdAt:u()};if(await this.storage.saveFederationTransaction(r),t){try{await this.ledger.applyBalanceUpdates([{memberId:e.payer,delta:-e.amount,reason:"SPOT_TRANSACTION_PAYER",referenceId:r.id},{memberId:this.clearingAccountId,delta:e.amount,reason:"SPOT_TRANSACTION_PAYEE",referenceId:r.id}]),r.status="SOURCE_CONFIRMED",r.sourceConfirmedAt=u(),r.sourceLegTxId=r.id}catch(d){throw r.status="FAILED",r.failureReason=d instanceof Error?d.message:"Unknown error",await this.storage.saveFederationTransaction(r),new ge({code:"LEDGER_ERROR",message:`Source leg failed: ${r.failureReason}`})}this.state.federationPosition+=e.amount;let o=this.state.connectedCells.findIndex(d=>d.remoteCellId===e.targetCell);o>=0&&(this.state.connectedCells[o].bilateralPosition+=e.amount,this.state.connectedCells[o].lastActivity=u()),r.status="COMPLETED",r.targetConfirmedAt=u(),r.completedAt=u()}await this.storage.saveFederationTransaction(r),await this.saveState(),await this.storage.appendEvent({cellId:this.cellId,type:"FEDERATION_TX_COMPLETED",timestamp:u(),data:{transactionId:r.id,amount:e.amount,direction:t?"OUTGOING":"INCOMING",newPosition:this.state.federationPosition}});let i=this.analyzeExposure();return{transaction:r,newPosition:this.state.federationPosition,remainingCapacity:this.getAvailableCapacity(),nearCap:i.atWarning||i.atCritical}}async getTransaction(e){let t=await this.storage.getFederationTransaction(e);if(!(!t.ok||!t.value))return t.value}async getTransactions(e){let t=await this.storage.getFederationTransactions({cellId:this.cellId,...e});return t.ok?t.value:[]}async rollbackTransaction(e,t){let r=await this.getTransaction(e);if(!r)throw new ge({code:"TRANSACTION_NOT_FOUND",message:`Transaction ${e} not found`});if(r.status==="COMPLETED")throw new ge({code:"INVALID_TX_STATE",message:"Cannot rollback completed transaction"});if(r.status!=="ROLLED_BACK"){if(r.sourceConfirmedAt&&r.sourceCell===this.cellId){await this.ledger.applyBalanceUpdates([{memberId:r.payer,delta:r.amount,reason:"SPOT_TRANSACTION_PAYEE",referenceId:`rollback-${r.id}`},{memberId:this.clearingAccountId,delta:-r.amount,reason:"SPOT_TRANSACTION_PAYER",referenceId:`rollback-${r.id}`}]),this.state.federationPosition-=r.amount;let i=this.state.connectedCells.findIndex(o=>o.remoteCellId===r.targetCell);i>=0&&(this.state.connectedCells[i].bilateralPosition-=r.amount)}r.status="ROLLED_BACK",r.failureReason=t,r.completedAt=u(),await this.storage.saveFederationTransaction(r),await this.saveState(),await this.storage.appendEvent({cellId:this.cellId,type:"FEDERATION_TX_ROLLED_BACK",timestamp:u(),data:{transactionId:e,reason:t}})}}checkQuarantineStatus(){let e=Math.abs(this.state.federationPosition)>this.state.exposureCap,t=this.emergency?.isFederationFrozen()??!1;return this.state.status==="QUARANTINED"?{isQuarantined:!0,reason:this.state.quarantineReason,since:this.state.quarantinedAt,violatingPosition:e?this.state.federationPosition:void 0,exceededCap:e?this.state.exposureCap:void 0,resolutionSteps:this.getResolutionSteps()}:e?{isQuarantined:!1,reason:"CAP_VIOLATION",violatingPosition:this.state.federationPosition,exceededCap:this.state.exposureCap,resolutionSteps:["Reduce federation position below cap","Wait for cap to increase"]}:t?{isQuarantined:!1,reason:"PANIC_MODE",resolutionSteps:["Wait for de-escalation from PANIC state"]}:{isQuarantined:!1}}getResolutionSteps(){switch(this.state.quarantineReason){case"CAP_VIOLATION":return["Reduce federation position by settling with connected cells","Increase aggregate capacity (more members or higher limits)"];case"PANIC_MODE":return["Wait for emergency state to de-escalate from PANIC"];case"MANUAL_SUSPENSION":return["Request governance review","Address suspension reason"];default:return[]}}async enterQuarantine(e){this.state.status="QUARANTINED",this.state.quarantineReason=e,this.state.quarantinedAt=u(),await this.saveState(),await this.storage.appendEvent({cellId:this.cellId,type:"FEDERATION_QUARANTINED",timestamp:u(),data:{reason:e}})}async exitQuarantine(){let e=this.checkQuarantineStatus();if(e.reason==="CAP_VIOLATION"&&Math.abs(this.state.federationPosition)>this.state.exposureCap)throw new ge({code:"CAP_EXCEEDED",message:"Cannot exit quarantine: position still exceeds cap"});if(e.reason==="PANIC_MODE"&&this.emergency?.isFederationFrozen())throw new ge({code:"FEDERATION_FROZEN",message:"Cannot exit quarantine: still in PANIC mode"});this.state.status="ACTIVE",this.state.quarantineReason=void 0,this.state.quarantinedAt=void 0,await this.saveState(),await this.storage.appendEvent({cellId:this.cellId,type:"FEDERATION_QUARANTINE_EXIT",timestamp:u(),data:{}})}async setExposureCapFactor(e){if(e<0||e>1)throw new ge({code:"INVALID_AMOUNT",message:"Beta factor must be between 0 and 1"});this.state.betaFactor=e,await this.recalculateExposureCap(),Math.abs(this.state.federationPosition)>this.state.exposureCap&&this.state.status!=="QUARANTINED"&&await this.enterQuarantine("CAP_VIOLATION"),e===0&&this.state.status!=="QUARANTINED"&&await this.enterQuarantine("PANIC_MODE"),await this.storage.appendEvent({cellId:this.cellId,type:"EXPOSURE_CAP_UPDATED",timestamp:u(),data:{betaFactor:e,newCap:this.state.exposureCap}})}async recalculateExposureCap(){let t=this.ledger.getStatistics().aggregateCapacity,r=Math.floor(t*this.state.betaFactor);r=Math.max(this.parameters.minExposureCap,r),r=Math.min(this.parameters.maxExposureCap,r),this.state.exposureCap=r,this.state.updatedAt=u(),await this.saveState()}analyzeExposure(){let e=Math.abs(this.state.federationPosition),t=this.state.exposureCap,r=Math.max(0,t-e),i=t>0?e/t:0;return{position:this.state.federationPosition,cap:t,availableCapacity:r,utilization:i,atWarning:i>=this.parameters.warningThreshold,atCritical:i>=this.parameters.criticalThreshold,capExceeded:e>t}}async saveState(){let e=await this.storage.saveFederationState(this.state);if(!e.ok)throw new ge({code:"STORAGE_ERROR",message:e.error.message})}async loadState(){let e=await this.storage.getFederationState(this.cellId);e.ok&&e.value&&(this.state=e.value)}},ge=class extends Error{constructor(e){super(e.message),this.name="FederationValidationError",this.code=e.code,this.details=e.details}toJSON(){return{code:this.code,message:this.message,details:this.details}}};async function dr(h,e,t,r={}){let i=new rt(h,e,t,r);return await i.initialize(),i}var nt=class{constructor(e,t,r,i,o){this.stressIndex=0;this.flowHistory=new Map;this.cellId=e,this.ledger=t,this.storage=r,this.carriers=i??[...zt],this.taskProfiles=o??this.cloneTaskProfiles(jt),this.stocks=new Map;for(let d of this.carriers)this.stocks.set(d.id,{carrierId:d.id,currentAmount:0,unit:d.unit,lastRestocked:u()});this.selectedModes=new Map;for(let d of this.taskProfiles)d.energyModes.length>0&&this.selectedModes.set(d.taskCategory,d.energyModes[0].id)}setSchedulerEngine(e){this.scheduler=e}getStocks(){return new Map(this.stocks)}getStock(e){let t=this.stocks.get(e);return t?{...t}:null}async recordStockChange(e){if(!this.carriers.find(o=>o.id===e.carrierId))throw new Ue({code:"CARRIER_NOT_FOUND",message:`Carrier ${e.carrierId} not found`});let r=this.stocks.get(e.carrierId);if(!r)throw new Ue({code:"STOCK_NOT_FOUND",message:`Stock for carrier ${e.carrierId} not found`});if(e.delta<0&&r.currentAmount+e.delta<0)throw new Ue({code:"INSUFFICIENT_STOCK",message:`Insufficient stock for carrier ${e.carrierId}: have ${r.currentAmount}, need ${Math.abs(e.delta)}`});r.currentAmount+=e.delta,e.delta>0&&(r.lastRestocked=u()),r.projectedDepletionDate=this.projectDepletion(e.carrierId)??void 0;let i={id:fe(),cellId:this.cellId,timestamp:u(),...e};await this.storage.saveStockChange(i),this.updateFlowHistory(e.carrierId,e.delta,e.source),this.stressIndex=this.calculateEnergyStress(),await this.saveState(),await this.storage.appendEvent({cellId:this.cellId,type:"ENERGY_STOCK_CHANGE",timestamp:u(),data:{carrierId:e.carrierId,delta:e.delta,reason:e.reason,newAmount:r.currentAmount}})}async recordConsumption(e){if(!this.carriers.find(r=>r.id===e.carrierId))throw new Ue({code:"CARRIER_NOT_FOUND",message:`Carrier ${e.carrierId} not found`});await this.recordStockChange({carrierId:e.carrierId,delta:-e.amount,reason:"TASK_CONSUMPTION",source:`task:${e.taskCategory}`});let t={id:fe(),cellId:this.cellId,timestamp:u(),...e};await this.storage.saveConsumptionRecord(t)}updateFlowHistory(e,t,r){this.flowHistory.has(e)||this.flowHistory.set(e,[]);let i=this.flowHistory.get(e),o=u(),d=this.getWeekStart(o),f=d+10080*60*1e3,S=i.find(b=>b.period.start===d&&b.period.end===f);S||(S={carrierId:e,period:{start:d,end:f},inflow:0,outflow:0,sources:[],consumers:[]},i.push(S)),t>0?(S.inflow+=t,S.sources.push({name:r??"unknown",amount:t,timestamp:o})):(S.outflow+=Math.abs(t),S.consumers.push({name:r??"unknown",amount:Math.abs(t),timestamp:o}))}getCarriers(){return[...this.carriers]}getEnergyProfile(e){let t=this.taskProfiles.find(r=>r.taskCategory===e);return t?{...t,energyModes:t.energyModes.map(r=>({...r,energyPerHour:new Map(r.energyPerHour)}))}:null}setModeSelection(e,t){let r=this.taskProfiles.find(o=>o.taskCategory===e);if(!r)throw new Ue({code:"PROFILE_NOT_FOUND",message:`Energy profile for ${e} not found`});if(!r.energyModes.find(o=>o.id===t))throw new Ue({code:"MODE_NOT_FOUND",message:`Mode ${t} not found for category ${e}`});this.selectedModes.set(e,t)}getSelectedMode(e){return this.selectedModes.get(e)??null}generateWeeklyPlan(){let e=this.getWeekStart(u()),t=this.ledger.getStatistics().memberCount,r=new Map,i=new Map;for(let b of this.taskProfiles){let P=this.selectedModes.get(b.taskCategory),U=b.energyModes.find(re=>re.id===P);if(!U)continue;let q=this.getEstimatedWeeklyHours(b.taskCategory,t);for(let[re,j]of U.energyPerHour){let V=j*q,le=r.get(re)??0;r.set(re,le+V),i.set(re,le+V)}}let o=new Map;for(let[b,P]of this.stocks)o.set(b,P.currentAmount);let d=this.calculateStressFromMaps(r,o),f=this.generateBundles(o,r);return{cellId:this.cellId,weekStart:e,projectedConsumption:i,requiredByCarrier:r,availableByCarrier:o,selectedModes:new Map(this.selectedModes),stressIndex:d,feasible:d<=1,bundles:f,createdAt:u()}}getEstimatedWeeklyHours(e,t){return({FOOD:3,WATER_SANITATION:1,ENERGY_HEAT:2,SHELTER_REPAIR:.5,MEDICAL:.5,CHILDCARE_DEPENDENT:2,SECURITY_COORDINATION:1,PROCUREMENT_TRANSPORT:1,GENERAL:1}[e]??1)*Math.max(1,t)}calculateEnergyStress(){return this.generateWeeklyPlan().stressIndex}calculateStressFromMaps(e,t){let r=0;for(let[i,o]of e){if(o<=0)continue;let d=t.get(i)??0;if(d<=0)return 1/0;let f=o/d;r=Math.max(r,f)}return r}getStressIndex(){return this.stressIndex}projectStress(e){let t=[],r=[],i,o=this.generateWeeklyPlan(),d=new Map;for(let[S,b]of o.projectedConsumption)d.set(S,b/7);let f=new Map(this.stocks);for(let S=0;S<e;S++){for(let[U,q]of d){let re=f.get(U);re&&(re.currentAmount=Math.max(0,re.currentAmount-q))}let b=new Map;for(let[U,q]of f)b.set(U,q.currentAmount);let P=this.calculateStressFromMaps(o.requiredByCarrier,b);t.push(P),P>1&&i===void 0&&(i=S+1)}i!==void 0&&(r.push(`Energy crisis projected in ${i} days`),r.push("Consider mode substitution or procurement"));for(let[S,b]of this.stocks){let P=d.get(S)??0;P>0&&b.currentAmount/P<7&&r.push(`Low stock: ${S} will deplete in ${Math.round(b.currentAmount/P)} days`)}return{daysAhead:e,projectedStress:t,daysUntilCrisis:i,recommendations:r}}computeRationingPlan(e){let t=this.generateWeeklyPlan();if(t.stressIndex<=e)return{targetStress:e,bundleReductionFactor:1,taskReductions:new Map,modeSubstitutions:new Map,additionalProcurement:new Map,feasible:!0,explanation:"No rationing needed - already below target stress"};let i=new Map,o=new Map(t.requiredByCarrier);for(let P of this.taskProfiles){let U=this.selectedModes.get(P.taskCategory),q=P.energyModes.find(re=>re.id===U);if(q)for(let re of P.energyModes){if(re.id===U)continue;let j=!1;for(let[V,le]of q.energyPerHour)if((re.energyPerHour.get(V)??0)<le){j=!0;break}if(j){i.set(P.taskCategory,re.id);let V=this.getEstimatedWeeklyHours(P.taskCategory,this.ledger.getStatistics().memberCount);for(let[le,Se]of q.energyPerHour){let Oe=o.get(le)??0;o.set(le,Oe-Se*V)}for(let[le,Se]of re.energyPerHour){let Oe=o.get(le)??0;o.set(le,Oe+Se*V)}break}}}let d=this.calculateStressFromMaps(o,t.availableByCarrier);if(d<=e)return{targetStress:e,bundleReductionFactor:1,taskReductions:new Map,modeSubstitutions:i,additionalProcurement:new Map,feasible:!0,explanation:"Mode substitution achieves target stress"};let f=new Map;for(let[P,U]of o){let q=t.availableByCarrier.get(P)??0;if(U>q*e){let re=U/e-q;f.set(P,Math.ceil(re))}}let S=1;for(let[P,U]of o){if(U<=0)continue;let re=(t.availableByCarrier.get(P)??0)/U;S=Math.min(S,re)}S=Math.max(bt,S);let b=new Map(t.availableByCarrier);for(let[P,U]of f){let q=b.get(P)??0;b.set(P,q+U)}return d=this.calculateStressFromMaps(o,b),{targetStress:e,bundleReductionFactor:S,taskReductions:new Map,modeSubstitutions:i,additionalProcurement:f,feasible:d<=e,explanation:d<=e?"Rationing plan achieves target stress":`Best achievable stress is ${d.toFixed(2)} with current measures`}}async applyRationingPlan(e){for(let[t,r]of e.modeSubstitutions)this.setModeSelection(t,r);await this.saveState(),await this.storage.appendEvent({cellId:this.cellId,type:"RATIONING_PLAN_APPLIED",timestamp:u(),data:{targetStress:e.targetStress,bundleReductionFactor:e.bundleReductionFactor,modeSubstitutions:Object.fromEntries(e.modeSubstitutions),feasible:e.feasible}})}getBundleDistribution(){return this.generateWeeklyPlan().bundles}generateBundles(e,t){let r=this.ledger.getAllMemberStates(),i=r.size;if(i===0)return[];let o=1;for(let[f,S]of t){if(S<=0)continue;let P=(e.get(f)??0)/S;o=Math.min(o,P)}o=Math.max(bt,Math.min(1,o));let d=[];for(let[f,S]of r){let b=S.balance<=-S.limit*.8,P=Math.min(1,o*(1+(b?Kt:0))),U=new Map;for(let[q,re]of e){let j=re/i;U.set(q,j*P)}d.push({memberId:f,bundleFraction:P,energyAllocation:U,isVulnerable:b})}return d}getFlowHistory(e,t){return(this.flowHistory.get(e)??[]).filter(i=>i.period.end>=t).map(i=>({...i}))}projectDepletion(e){let t=this.stocks.get(e);if(!t||t.currentAmount<=0)return null;let r=u()-10080*60*1e3,o=(this.flowHistory.get(e)??[]).find(S=>S.period.end>=r);if(!o||o.outflow<=0)return null;let d=o.outflow/7;if(d<=0)return null;let f=t.currentAmount/d;return u()+f*24*60*60*1e3}generateProcurementAlerts(){let e=[],t=this.generateWeeklyPlan();for(let[r,i]of this.stocks){let o=t.requiredByCarrier.get(r)??0;if(o<=0)continue;let d=o/7;if(d<=0)continue;let f=i.currentAmount/d,S,b;if(f<3)S=1,b=`URGENT: ${r} will deplete in ${Math.round(f)} days`;else if(f<7)S=2,b=`${r} running low - ${Math.round(f)} days remaining`;else if(f<14)S=3,b=`Monitor ${r} - ${Math.round(f)} days remaining`;else continue;let P=d*14-i.currentAmount;P>0&&e.push({carrierId:r,currentStock:i.currentAmount,daysUntilDepletion:f,recommendedAmount:Math.ceil(P),priority:S,message:b})}return e.sort((r,i)=>r.priority-i.priority)}canCompleteTask(e,t){let r=this.taskProfiles.find(d=>d.taskCategory===e);if(!r)return!0;let i=this.selectedModes.get(e),o=r.energyModes.find(d=>d.id===i);if(!o)return!0;for(let[d,f]of o.energyPerHour){let S=f*t,b=this.stocks.get(d);if(!b||b.currentAmount<S)return!1}return!0}async saveState(){let e={cellId:this.cellId,carriers:this.carriers,stocks:new Map(this.stocks),selectedModes:new Map(this.selectedModes),taskProfiles:this.cloneTaskProfiles(this.taskProfiles),stressIndex:this.stressIndex,lastCalculated:u(),createdAt:u(),updatedAt:u()},t=await this.storage.saveEnergyState(e);if(!t.ok)throw new Ue({code:"STORAGE_ERROR",message:t.error.message})}async loadState(){let e=await this.storage.getEnergyState(this.cellId);if(e.ok&&e.value){let t=e.value;this.carriers=t.carriers,this.stocks=new Map(t.stocks),this.selectedModes=new Map(t.selectedModes),this.taskProfiles=this.cloneTaskProfiles(t.taskProfiles),this.stressIndex=t.stressIndex}}getWeekStart(e){let t=new Date(e),r=t.getDay(),i=t.getDate()-r;return t.setDate(i),t.setHours(0,0,0,0),t.getTime()}cloneTaskProfiles(e){return e.map(t=>({...t,energyModes:t.energyModes.map(r=>({...r,energyPerHour:new Map(r.energyPerHour)}))}))}getCellId(){return this.cellId}},Ue=class extends Error{constructor(e){super(e.message),this.name="EnergyValidationError",this.code=e.code,this.details=e.details}toJSON(){return{code:this.code,message:this.message,details:this.details}}};function mr(h,e,t,r,i){return new nt(h,e,t,r,i)}var Pt=class{constructor(){this.ledgerStates=new Map;this.identities=new Map;this.identitiesByPublicKey=new Map;this.transactions=new Map;this.transactionsByMember=new Map;this.offlineQueue=new Map;this.events=[];this.eventSequence=0;this.membershipChanges=new Map;this.commitments=new Map;this.proposals=new Map;this.disputes=new Map;this.councils=new Map;this.taskSlots=new Map;this.taskTemplates=new Map;this.memberSupplies=new Map;this.emergencyStates=new Map;this.stateHistories=new Map;this.federationStates=new Map;this.federationTransactions=new Map;this.linkProposals=new Map;this.energyStates=new Map;this.stockChanges=new Map;this.consumptionRecords=new Map;this.energyPlans=new Map}async saveLedgerState(e){let t={...e,members:new Map(e.members),parameters:{...e.parameters}};return this.ledgerStates.set(e.cellId,t),I(void 0)}async getLedgerState(e){let t=this.ledgerStates.get(e);return t?I({...t,members:new Map(t.members),parameters:{...t.parameters}}):I(null)}async saveIdentity(e){return this.identities.set(e.id,{...e}),this.identitiesByPublicKey.set(e.publicKey,e.id),I(void 0)}async getIdentity(e){let t=this.identities.get(e);return I(t?{...t}:null)}async getIdentityByPublicKey(e){let t=this.identitiesByPublicKey.get(e);return t?this.getIdentity(t):I(null)}async getAllIdentities(e){let t=Array.from(this.identities.values()).filter(r=>r.cellId===e).map(r=>({...r}));return I(t)}async deleteIdentity(e){let t=this.identities.get(e);return t&&(this.identitiesByPublicKey.delete(t.publicKey),this.identities.delete(e)),I(void 0)}async saveTransaction(e){return this.transactions.set(e.id,{...e}),this.transactionsByMember.has(e.payer)||this.transactionsByMember.set(e.payer,new Set),this.transactionsByMember.get(e.payer).add(e.id),this.transactionsByMember.has(e.payee)||this.transactionsByMember.set(e.payee,new Set),this.transactionsByMember.get(e.payee).add(e.id),I(void 0)}async getTransaction(e){let t=this.transactions.get(e);return I(t?{...t}:null)}async getTransactionsByMember(e,t=100,r=0){let i=this.transactionsByMember.get(e);if(!i)return I([]);let o=Array.from(i).map(d=>this.transactions.get(d)).filter(Boolean).sort((d,f)=>f.createdAt-d.createdAt).slice(r,r+t).map(d=>({...d}));return I(o)}async queueTransaction(e){return this.offlineQueue.set(e.transaction.id,{...e}),I(void 0)}async getQueuedTransactions(){let e=Array.from(this.offlineQueue.values()).map(t=>({...t})).sort((t,r)=>t.queuedAt-r.queuedAt);return I(e)}async removeFromQueue(e){return this.offlineQueue.delete(e),I(void 0)}async appendEvent(e){let t={...e,id:fe(),sequenceNumber:++this.eventSequence};return this.events.push(t),I(t)}async getEvents(e,t=0){let r=this.events.filter(i=>i.cellId===e&&i.sequenceNumber>t).map(i=>({...i}));return I(r)}async saveMembershipChange(e){return this.membershipChanges.has(e.memberId)||this.membershipChanges.set(e.memberId,[]),this.membershipChanges.get(e.memberId).push({...e}),I(void 0)}async getMembershipChanges(e){let t=this.membershipChanges.get(e)||[];return I(t.map(r=>({...r})))}async saveCommitment(e){return this.commitments.set(e.id,{...e}),I(void 0)}async getCommitment(e){let t=this.commitments.get(e);return I(t?{...t}:null)}async getCommitmentsByMember(e){let t=Array.from(this.commitments.values()).filter(r=>r.promisor===e||r.promisee===e).map(r=>({...r}));return I(t)}async getCommitmentsByStatus(e){let t=Array.from(this.commitments.values()).filter(r=>r.status===e).map(r=>({...r}));return I(t)}async getCommitmentsByCategory(e){let t=Array.from(this.commitments.values()).filter(r=>r.category===e).map(r=>({...r}));return I(t)}async getAllCommitments(){let e=Array.from(this.commitments.values()).map(t=>({...t}));return I(e)}async saveProposal(e){return this.proposals.set(e.id,{...e,votes:[...e.votes]}),I(void 0)}async getProposal(e){let t=this.proposals.get(e);return I(t?{...t,votes:[...t.votes]}:null)}async getProposalsByStatus(e){let t=Array.from(this.proposals.values()).filter(r=>r.status===e).map(r=>({...r,votes:[...r.votes]}));return I(t)}async getAllProposals(){let e=Array.from(this.proposals.values()).map(t=>({...t,votes:[...t.votes]}));return I(e)}async saveDispute(e){return this.disputes.set(e.id,{...e,evidence:[...e.evidence]}),I(void 0)}async getDispute(e){let t=this.disputes.get(e);return I(t?{...t,evidence:[...t.evidence]}:null)}async getDisputesByStatus(e){let t=Array.from(this.disputes.values()).filter(r=>r.status===e).map(r=>({...r,evidence:[...r.evidence]}));return I(t)}async getAllDisputes(){let e=Array.from(this.disputes.values()).map(t=>({...t,evidence:[...t.evidence]}));return I(e)}async saveCouncil(e){return this.councils.set(e.cellId,{...e,members:[...e.members]}),I(void 0)}async getCouncil(e){let t=this.councils.get(e);return I(t?{...t,members:[...t.members]}:null)}async saveTaskSlot(e){return this.taskSlots.set(e.id,{...e,assignments:[...e.assignments]}),I(void 0)}async getTaskSlot(e){let t=this.taskSlots.get(e);return I(t?{...t,assignments:[...t.assignments]}:null)}async getTaskSlotsByPeriod(e,t){let r=Array.from(this.taskSlots.values()).filter(i=>i.startTime>=e&&i.startTime<t).map(i=>({...i,assignments:[...i.assignments]})).sort((i,o)=>i.startTime-o.startTime);return I(r)}async getTaskSlotsByStatus(e){let t=Array.from(this.taskSlots.values()).filter(r=>r.status===e).map(r=>({...r,assignments:[...r.assignments]}));return I(t)}async getAllTaskSlots(){let e=Array.from(this.taskSlots.values()).map(t=>({...t,assignments:[...t.assignments]}));return I(e)}async saveTaskTemplate(e){return this.taskTemplates.set(e.id,{...e}),I(void 0)}async getTaskTemplate(e){let t=this.taskTemplates.get(e);return I(t?{...t}:null)}async getAllTaskTemplates(){let e=Array.from(this.taskTemplates.values()).map(t=>({...t}));return I(e)}async saveMemberSupply(e){let t={...e,skills:new Map(e.skills),preferences:[...e.preferences],constraints:[...e.constraints]};return this.memberSupplies.set(e.memberId,t),I(void 0)}async getMemberSupply(e){let t=this.memberSupplies.get(e);return t?I({...t,skills:new Map(t.skills),preferences:[...t.preferences],constraints:[...t.constraints]}):I(null)}async getAllMemberSupplies(){let e=Array.from(this.memberSupplies.values()).map(t=>({...t,skills:new Map(t.skills),preferences:[...t.preferences],constraints:[...t.constraints]}));return I(e)}async saveEmergencyState(e){return this.emergencyStates.set(e.cellId,{...e}),I(void 0)}async getEmergencyState(e){let t=this.emergencyStates.get(e);return I(t?{...t}:null)}async appendStateHistoryEntry(e,t){return this.stateHistories.has(t)||this.stateHistories.set(t,[]),this.stateHistories.get(t).push({...e}),I(void 0)}async getStateHistory(e,t){let i=(this.stateHistories.get(e)||[]).filter(o=>o.timestamp>=t).map(o=>({...o})).sort((o,d)=>o.timestamp-d.timestamp);return I(i)}async saveFederationState(e){return this.federationStates.set(e.cellId,{...e,connectedCells:[...e.connectedCells.map(t=>({...t}))]}),I(void 0)}async getFederationState(e){let t=this.federationStates.get(e);return t?I({...t,connectedCells:[...t.connectedCells.map(r=>({...r}))]}):I(null)}async saveFederationTransaction(e){return this.federationTransactions.set(e.id,{...e}),I(void 0)}async getFederationTransaction(e){let t=this.federationTransactions.get(e);return I(t?{...t}:null)}async getFederationTransactions(e){let t=Array.from(this.federationTransactions.values());return e.cellId&&(t=t.filter(r=>r.sourceCell===e.cellId||r.targetCell===e.cellId)),e.remoteCellId&&(t=t.filter(r=>r.sourceCell===e.remoteCellId||r.targetCell===e.remoteCellId)),e.status&&(t=t.filter(r=>r.status===e.status)),e.since&&(t=t.filter(r=>r.createdAt>=e.since)),I(t.map(r=>({...r})).sort((r,i)=>i.createdAt-r.createdAt))}async saveLinkProposal(e){return this.linkProposals.set(e.id,{...e,proposedTerms:{...e.proposedTerms}}),I(void 0)}async getLinkProposal(e){let t=this.linkProposals.get(e);return I(t?{...t,proposedTerms:{...t.proposedTerms}}:null)}async saveEnergyState(e){let t={...e,carriers:[...e.carriers],stocks:new Map(e.stocks),selectedModes:new Map(e.selectedModes),taskProfiles:e.taskProfiles.map(r=>({...r,energyModes:r.energyModes.map(i=>({...i,energyPerHour:new Map(i.energyPerHour)}))}))};return this.energyStates.set(e.cellId,t),I(void 0)}async getEnergyState(e){let t=this.energyStates.get(e);return t?I({...t,carriers:[...t.carriers],stocks:new Map(t.stocks),selectedModes:new Map(t.selectedModes),taskProfiles:t.taskProfiles.map(r=>({...r,energyModes:r.energyModes.map(i=>({...i,energyPerHour:new Map(i.energyPerHour)}))}))}):I(null)}async saveStockChange(e){return this.stockChanges.has(e.cellId)||this.stockChanges.set(e.cellId,[]),this.stockChanges.get(e.cellId).push({...e}),I(void 0)}async getStockChanges(e,t){let i=(this.stockChanges.get(e)||[]).filter(o=>o.timestamp>=t).map(o=>({...o})).sort((o,d)=>o.timestamp-d.timestamp);return I(i)}async saveConsumptionRecord(e){return this.consumptionRecords.has(e.cellId)||this.consumptionRecords.set(e.cellId,[]),this.consumptionRecords.get(e.cellId).push({...e}),I(void 0)}async getConsumptionHistory(e,t){let i=(this.consumptionRecords.get(e)||[]).filter(o=>o.timestamp>=t).map(o=>({...o})).sort((o,d)=>o.timestamp-d.timestamp);return I(i)}async saveEnergyPlan(e){let t=`${e.cellId}:${e.weekStart}`,r={...e,projectedConsumption:new Map(e.projectedConsumption),requiredByCarrier:new Map(e.requiredByCarrier),availableByCarrier:new Map(e.availableByCarrier),selectedModes:new Map(e.selectedModes),bundles:e.bundles.map(i=>({...i,energyAllocation:new Map(i.energyAllocation)}))};return this.energyPlans.set(t,r),I(void 0)}async getEnergyPlan(e,t){let r=`${e}:${t}`,i=this.energyPlans.get(r);return i?I({...i,projectedConsumption:new Map(i.projectedConsumption),requiredByCarrier:new Map(i.requiredByCarrier),availableByCarrier:new Map(i.availableByCarrier),selectedModes:new Map(i.selectedModes),bundles:i.bundles.map(o=>({...o,energyAllocation:new Map(o.energyAllocation)}))}):I(null)}clear(){this.ledgerStates.clear(),this.identities.clear(),this.identitiesByPublicKey.clear(),this.transactions.clear(),this.transactionsByMember.clear(),this.offlineQueue.clear(),this.events=[],this.eventSequence=0,this.membershipChanges.clear(),this.commitments.clear(),this.proposals.clear(),this.disputes.clear(),this.councils.clear(),this.taskSlots.clear(),this.taskTemplates.clear(),this.memberSupplies.clear(),this.emergencyStates.clear(),this.stateHistories.clear(),this.federationStates.clear(),this.federationTransactions.clear(),this.linkProposals.clear(),this.energyStates.clear(),this.stockChanges.clear(),this.consumptionRecords.clear(),this.energyPlans.clear()}},Nt=class{constructor(e){this.eventSequence=0;this.initialized=!1;this.db=e}async initialize(){if(this.initialized)return;await this.db.createIndex({index:{fields:["type","data.cellId"]}}),await this.db.createIndex({index:{fields:["type","data.publicKey"]}}),await this.db.createIndex({index:{fields:["type","data.payer"]}}),await this.db.createIndex({index:{fields:["type","data.payee"]}});let e=await this.db.find({selector:{type:"event"},sort:[{"data.sequenceNumber":"desc"}],limit:1});e.docs.length>0&&(this.eventSequence=e.docs[0].data.sequenceNumber),this.initialized=!0}async saveLedgerState(e){try{let t=`ledger:${e.cellId}`,r={};e.members.forEach((o,d)=>{r[d]=o});let i={_id:t,type:"ledger",data:{...e,members:r},createdAt:u(),updatedAt:u()};try{let o=await this.db.get(t);i._rev=o._rev,i.createdAt=o.createdAt}catch(o){if(o.status!==404)throw o}return await this.db.put(i),I(void 0)}catch(t){return N({code:"WRITE_FAILED",message:`Failed to save ledger state: ${t}`})}}async getLedgerState(e){try{let t=await this.db.get(`ledger:${e}`),r=new Map,i=t.data.members;for(let[o,d]of Object.entries(i))r.set(o,d);return I({...t.data,members:r})}catch(t){return t.status===404?I(null):N({code:"READ_FAILED",message:`Failed to get ledger state: ${t}`})}}async saveIdentity(e){try{let t=`identity:${e.id}`,r={_id:t,type:"identity",data:e,createdAt:u(),updatedAt:u()};try{let i=await this.db.get(t);r._rev=i._rev,r.createdAt=i.createdAt}catch(i){if(i.status!==404)throw i}return await this.db.put(r),I(void 0)}catch(t){return N({code:"WRITE_FAILED",message:`Failed to save identity: ${t}`})}}async getIdentity(e){try{let t=await this.db.get(`identity:${e}`);return I(t.data)}catch(t){return t.status===404?I(null):N({code:"READ_FAILED",message:`Failed to get identity: ${t}`})}}async getIdentityByPublicKey(e){try{let t=await this.db.find({selector:{type:"identity","data.publicKey":e}});return t.docs.length===0?I(null):I(t.docs[0].data)}catch(t){return N({code:"READ_FAILED",message:`Failed to get identity by public key: ${t}`})}}async getAllIdentities(e){try{let t=await this.db.find({selector:{type:"identity","data.cellId":e}});return I(t.docs.map(r=>r.data))}catch(t){return N({code:"READ_FAILED",message:`Failed to get identities: ${t}`})}}async deleteIdentity(e){try{let t=await this.db.get(`identity:${e}`);return await this.db.remove(t),I(void 0)}catch(t){return t.status===404?I(void 0):N({code:"DELETE_FAILED",message:`Failed to delete identity: ${t}`})}}async saveTransaction(e){try{let t=`transaction:${e.id}`,r={_id:t,type:"transaction",data:e,createdAt:u(),updatedAt:u()};try{let i=await this.db.get(t);r._rev=i._rev,r.createdAt=i.createdAt}catch(i){if(i.status!==404)throw i}return await this.db.put(r),I(void 0)}catch(t){return N({code:"WRITE_FAILED",message:`Failed to save transaction: ${t}`})}}async getTransaction(e){try{let t=await this.db.get(`transaction:${e}`);return I(t.data)}catch(t){return t.status===404?I(null):N({code:"READ_FAILED",message:`Failed to get transaction: ${t}`})}}async getTransactionsByMember(e,t=100,r=0){try{let[i,o]=await Promise.all([this.db.find({selector:{type:"transaction","data.payer":e}}),this.db.find({selector:{type:"transaction","data.payee":e}})]),d=new Map;for(let S of[...i.docs,...o.docs])d.set(S.data.id,S.data);let f=Array.from(d.values()).sort((S,b)=>b.createdAt-S.createdAt).slice(r,r+t);return I(f)}catch(i){return N({code:"READ_FAILED",message:`Failed to get transactions: ${i}`})}}async queueTransaction(e){try{let t=`queue:${e.transaction.id}`;return await this.db.put({_id:t,type:"queue",data:e,createdAt:u(),updatedAt:u()}),I(void 0)}catch(t){return N({code:"WRITE_FAILED",message:`Failed to queue transaction: ${t}`})}}async getQueuedTransactions(){try{let t=(await this.db.find({selector:{type:"queue"}})).docs.map(r=>r.data).sort((r,i)=>r.queuedAt-i.queuedAt);return I(t)}catch(e){return N({code:"READ_FAILED",message:`Failed to get queued transactions: ${e}`})}}async removeFromQueue(e){try{let t=await this.db.get(`queue:${e}`);return await this.db.remove(t),I(void 0)}catch(t){return t.status===404?I(void 0):N({code:"DELETE_FAILED",message:`Failed to remove from queue: ${t}`})}}async appendEvent(e){try{let t={...e,id:fe(),sequenceNumber:++this.eventSequence};return await this.db.put({_id:`event:${t.id}`,type:"event",data:t,createdAt:u(),updatedAt:u()}),I(t)}catch(t){return N({code:"WRITE_FAILED",message:`Failed to append event: ${t}`})}}async getEvents(e,t=0){try{let i=(await this.db.find({selector:{type:"event","data.cellId":e,"data.sequenceNumber":{$gt:t}}})).docs.map(o=>o.data).sort((o,d)=>o.sequenceNumber-d.sequenceNumber);return I(i)}catch(r){return N({code:"READ_FAILED",message:`Failed to get events: ${r}`})}}async saveMembershipChange(e){try{let t=`membership-change:${e.memberId}:${e.changedAt}`;return await this.db.put({_id:t,type:"membership-change",data:e,createdAt:u(),updatedAt:u()}),I(void 0)}catch(t){return N({code:"WRITE_FAILED",message:`Failed to save membership change: ${t}`})}}async getMembershipChanges(e){try{let r=(await this.db.find({selector:{type:"membership-change","data.memberId":e}})).docs.map(i=>i.data).sort((i,o)=>i.changedAt-o.changedAt);return I(r)}catch(t){return N({code:"READ_FAILED",message:`Failed to get membership changes: ${t}`})}}async saveCommitment(e){try{let t=`commitment:${e.id}`,r={_id:t,type:"commitment",data:e,createdAt:u(),updatedAt:u()};try{let i=await this.db.get(t);r._rev=i._rev,r.createdAt=i.createdAt}catch(i){if(i.status!==404)throw i}return await this.db.put(r),I(void 0)}catch(t){return N({code:"WRITE_FAILED",message:`Failed to save commitment: ${t}`})}}async getCommitment(e){try{let t=await this.db.get(`commitment:${e}`);return I(t.data)}catch(t){return t.status===404?I(null):N({code:"READ_FAILED",message:`Failed to get commitment: ${t}`})}}async getCommitmentsByMember(e){try{let[t,r]=await Promise.all([this.db.find({selector:{type:"commitment","data.promisor":e}}),this.db.find({selector:{type:"commitment","data.promisee":e}})]),i=new Map;for(let o of[...t.docs,...r.docs])i.set(o.data.id,o.data);return I(Array.from(i.values()))}catch(t){return N({code:"READ_FAILED",message:`Failed to get commitments: ${t}`})}}async getCommitmentsByStatus(e){try{let t=await this.db.find({selector:{type:"commitment","data.status":e}});return I(t.docs.map(r=>r.data))}catch(t){return N({code:"READ_FAILED",message:`Failed to get commitments by status: ${t}`})}}async getCommitmentsByCategory(e){try{let t=await this.db.find({selector:{type:"commitment","data.category":e}});return I(t.docs.map(r=>r.data))}catch(t){return N({code:"READ_FAILED",message:`Failed to get commitments by category: ${t}`})}}async getAllCommitments(){try{let e=await this.db.find({selector:{type:"commitment"}});return I(e.docs.map(t=>t.data))}catch(e){return N({code:"READ_FAILED",message:`Failed to get all commitments: ${e}`})}}async saveProposal(e){try{let t=`proposal:${e.id}`,r={_id:t,type:"proposal",data:e,createdAt:u(),updatedAt:u()};try{let i=await this.db.get(t);r._rev=i._rev,r.createdAt=i.createdAt}catch(i){if(i.status!==404)throw i}return await this.db.put(r),I(void 0)}catch(t){return N({code:"WRITE_FAILED",message:`Failed to save proposal: ${t}`})}}async getProposal(e){try{let t=await this.db.get(`proposal:${e}`);return I(t.data)}catch(t){return t.status===404?I(null):N({code:"READ_FAILED",message:`Failed to get proposal: ${t}`})}}async getProposalsByStatus(e){try{let t=await this.db.find({selector:{type:"proposal","data.status":e}});return I(t.docs.map(r=>r.data))}catch(t){return N({code:"READ_FAILED",message:`Failed to get proposals by status: ${t}`})}}async getAllProposals(){try{let e=await this.db.find({selector:{type:"proposal"}});return I(e.docs.map(t=>t.data))}catch(e){return N({code:"READ_FAILED",message:`Failed to get all proposals: ${e}`})}}async saveDispute(e){try{let t=`dispute:${e.id}`,r={_id:t,type:"dispute",data:e,createdAt:u(),updatedAt:u()};try{let i=await this.db.get(t);r._rev=i._rev,r.createdAt=i.createdAt}catch(i){if(i.status!==404)throw i}return await this.db.put(r),I(void 0)}catch(t){return N({code:"WRITE_FAILED",message:`Failed to save dispute: ${t}`})}}async getDispute(e){try{let t=await this.db.get(`dispute:${e}`);return I(t.data)}catch(t){return t.status===404?I(null):N({code:"READ_FAILED",message:`Failed to get dispute: ${t}`})}}async getDisputesByStatus(e){try{let t=await this.db.find({selector:{type:"dispute","data.status":e}});return I(t.docs.map(r=>r.data))}catch(t){return N({code:"READ_FAILED",message:`Failed to get disputes by status: ${t}`})}}async getAllDisputes(){try{let e=await this.db.find({selector:{type:"dispute"}});return I(e.docs.map(t=>t.data))}catch(e){return N({code:"READ_FAILED",message:`Failed to get all disputes: ${e}`})}}async saveCouncil(e){try{let t=`council:${e.cellId}`,r={_id:t,type:"council",data:e,createdAt:u(),updatedAt:u()};try{let i=await this.db.get(t);r._rev=i._rev,r.createdAt=i.createdAt}catch(i){if(i.status!==404)throw i}return await this.db.put(r),I(void 0)}catch(t){return N({code:"WRITE_FAILED",message:`Failed to save council: ${t}`})}}async getCouncil(e){try{let t=await this.db.get(`council:${e}`);return I(t.data)}catch(t){return t.status===404?I(null):N({code:"READ_FAILED",message:`Failed to get council: ${t}`})}}async saveTaskSlot(e){try{let t=`taskslot:${e.id}`,r={_id:t,type:"taskslot",data:e,createdAt:u(),updatedAt:u()};try{let i=await this.db.get(t);r._rev=i._rev,r.createdAt=i.createdAt}catch(i){if(i.status!==404)throw i}return await this.db.put(r),I(void 0)}catch(t){return N({code:"WRITE_FAILED",message:`Failed to save task slot: ${t}`})}}async getTaskSlot(e){try{let t=await this.db.get(`taskslot:${e}`);return I(t.data)}catch(t){return t.status===404?I(null):N({code:"READ_FAILED",message:`Failed to get task slot: ${t}`})}}async getTaskSlotsByPeriod(e,t){try{let i=(await this.db.find({selector:{type:"taskslot","data.startTime":{$gte:e,$lt:t}}})).docs.map(o=>o.data).sort((o,d)=>o.startTime-d.startTime);return I(i)}catch(r){return N({code:"READ_FAILED",message:`Failed to get task slots by period: ${r}`})}}async getTaskSlotsByStatus(e){try{let t=await this.db.find({selector:{type:"taskslot","data.status":e}});return I(t.docs.map(r=>r.data))}catch(t){return N({code:"READ_FAILED",message:`Failed to get task slots by status: ${t}`})}}async getAllTaskSlots(){try{let e=await this.db.find({selector:{type:"taskslot"}});return I(e.docs.map(t=>t.data))}catch(e){return N({code:"READ_FAILED",message:`Failed to get all task slots: ${e}`})}}async saveTaskTemplate(e){try{let t=`tasktemplate:${e.id}`,r={_id:t,type:"tasktemplate",data:e,createdAt:u(),updatedAt:u()};try{let i=await this.db.get(t);r._rev=i._rev,r.createdAt=i.createdAt}catch(i){if(i.status!==404)throw i}return await this.db.put(r),I(void 0)}catch(t){return N({code:"WRITE_FAILED",message:`Failed to save task template: ${t}`})}}async getTaskTemplate(e){try{let t=await this.db.get(`tasktemplate:${e}`);return I(t.data)}catch(t){return t.status===404?I(null):N({code:"READ_FAILED",message:`Failed to get task template: ${t}`})}}async getAllTaskTemplates(){try{let e=await this.db.find({selector:{type:"tasktemplate"}});return I(e.docs.map(t=>t.data))}catch(e){return N({code:"READ_FAILED",message:`Failed to get all task templates: ${e}`})}}async saveMemberSupply(e){try{let t=`membersupply:${e.memberId}`,r={};e.skills.forEach((o,d)=>{r[d]=o});let i={_id:t,type:"membersupply",data:{...e,skills:r},createdAt:u(),updatedAt:u()};try{let o=await this.db.get(t);i._rev=o._rev,i.createdAt=o.createdAt}catch(o){if(o.status!==404)throw o}return await this.db.put(i),I(void 0)}catch(t){return N({code:"WRITE_FAILED",message:`Failed to save member supply: ${t}`})}}async getMemberSupply(e){try{let t=await this.db.get(`membersupply:${e}`),r=new Map,i=t.data.skills;for(let[o,d]of Object.entries(i))r.set(o,d);return I({...t.data,skills:r})}catch(t){return t.status===404?I(null):N({code:"READ_FAILED",message:`Failed to get member supply: ${t}`})}}async getAllMemberSupplies(){try{let e=await this.db.find({selector:{type:"membersupply"}});return I(e.docs.map(t=>{let r=new Map,i=t.data.skills;for(let[o,d]of Object.entries(i))r.set(o,d);return{...t.data,skills:r}}))}catch(e){return N({code:"READ_FAILED",message:`Failed to get all member supplies: ${e}`})}}async saveEmergencyState(e){try{let t=`emergency:${e.cellId}`,r={_id:t,type:"emergency",data:e,createdAt:u(),updatedAt:u()};try{let i=await this.db.get(t);r._rev=i._rev,r.createdAt=i.createdAt}catch(i){if(i.status!==404)throw i}return await this.db.put(r),I(void 0)}catch(t){return N({code:"WRITE_FAILED",message:`Failed to save emergency state: ${t}`})}}async getEmergencyState(e){try{let t=await this.db.get(`emergency:${e}`);return I(t.data)}catch(t){return t.status===404?I(null):N({code:"READ_FAILED",message:`Failed to get emergency state: ${t}`})}}async appendStateHistoryEntry(e,t){try{let r=`statehistory:${t}:${e.timestamp}`;return await this.db.put({_id:r,type:"statehistory",data:{...e,cellId:t},createdAt:u(),updatedAt:u()}),I(void 0)}catch(r){return N({code:"WRITE_FAILED",message:`Failed to append state history: ${r}`})}}async getStateHistory(e,t){try{let i=(await this.db.find({selector:{type:"statehistory","data.cellId":e,"data.timestamp":{$gte:t}}})).docs.map(o=>o.data).sort((o,d)=>o.timestamp-d.timestamp);return I(i)}catch(r){return N({code:"READ_FAILED",message:`Failed to get state history: ${r}`})}}async saveFederationState(e){try{let t=`federation:${e.cellId}`,r={_id:t,type:"federation",data:e,createdAt:u(),updatedAt:u()};try{let i=await this.db.get(t);r._rev=i._rev,r.createdAt=i.createdAt}catch(i){if(i.status!==404)throw i}return await this.db.put(r),I(void 0)}catch(t){return N({code:"WRITE_FAILED",message:`Failed to save federation state: ${t}`})}}async getFederationState(e){try{let t=await this.db.get(`federation:${e}`);return I(t.data)}catch(t){return t.status===404?I(null):N({code:"READ_FAILED",message:`Failed to get federation state: ${t}`})}}async saveFederationTransaction(e){try{let t=`fedtx:${e.id}`,r={_id:t,type:"fedtx",data:e,createdAt:u(),updatedAt:u()};try{let i=await this.db.get(t);r._rev=i._rev,r.createdAt=i.createdAt}catch(i){if(i.status!==404)throw i}return await this.db.put(r),I(void 0)}catch(t){return N({code:"WRITE_FAILED",message:`Failed to save federation transaction: ${t}`})}}async getFederationTransaction(e){try{let t=await this.db.get(`fedtx:${e}`);return I(t.data)}catch(t){return t.status===404?I(null):N({code:"READ_FAILED",message:`Failed to get federation transaction: ${t}`})}}async getFederationTransactions(e){try{let t={type:"fedtx"};e.status&&(t["data.status"]=e.status),e.since&&(t["data.createdAt"]={$gte:e.since});let i=(await this.db.find({selector:t})).docs.map(o=>o.data);return e.cellId&&(i=i.filter(o=>o.sourceCell===e.cellId||o.targetCell===e.cellId)),e.remoteCellId&&(i=i.filter(o=>o.sourceCell===e.remoteCellId||o.targetCell===e.remoteCellId)),I(i.sort((o,d)=>d.createdAt-o.createdAt))}catch(t){return N({code:"READ_FAILED",message:`Failed to get federation transactions: ${t}`})}}async saveLinkProposal(e){try{let t=`linkproposal:${e.id}`,r={_id:t,type:"linkproposal",data:e,createdAt:u(),updatedAt:u()};try{let i=await this.db.get(t);r._rev=i._rev,r.createdAt=i.createdAt}catch(i){if(i.status!==404)throw i}return await this.db.put(r),I(void 0)}catch(t){return N({code:"WRITE_FAILED",message:`Failed to save link proposal: ${t}`})}}async getLinkProposal(e){try{let t=await this.db.get(`linkproposal:${e}`);return I(t.data)}catch(t){return t.status===404?I(null):N({code:"READ_FAILED",message:`Failed to get link proposal: ${t}`})}}async saveEnergyState(e){try{let t=`energy:${e.cellId}`,r={};e.stocks.forEach((f,S)=>{r[S]=f});let i={};e.selectedModes.forEach((f,S)=>{i[S]=f});let o=e.taskProfiles.map(f=>({...f,energyModes:f.energyModes.map(S=>({...S,energyPerHour:Object.fromEntries(S.energyPerHour)}))})),d={_id:t,type:"energy",data:{...e,stocks:r,selectedModes:i,taskProfiles:o},createdAt:u(),updatedAt:u()};try{let f=await this.db.get(t);d._rev=f._rev,d.createdAt=f.createdAt}catch(f){if(f.status!==404)throw f}return await this.db.put(d),I(void 0)}catch(t){return N({code:"WRITE_FAILED",message:`Failed to save energy state: ${t}`})}}async getEnergyState(e){try{let t=await this.db.get(`energy:${e}`),r=new Map,i=t.data.stocks;for(let[S,b]of Object.entries(i))r.set(S,b);let o=new Map,d=t.data.selectedModes;for(let[S,b]of Object.entries(d))o.set(S,b);let f=t.data.taskProfiles.map(S=>({...S,energyModes:S.energyModes.map(b=>({...b,energyPerHour:new Map(Object.entries(b.energyPerHour))}))}));return I({...t.data,stocks:r,selectedModes:o,taskProfiles:f})}catch(t){return t.status===404?I(null):N({code:"READ_FAILED",message:`Failed to get energy state: ${t}`})}}async saveStockChange(e){try{let t=`stockchange:${e.id}`;return await this.db.put({_id:t,type:"stockchange",data:e,createdAt:u(),updatedAt:u()}),I(void 0)}catch(t){return N({code:"WRITE_FAILED",message:`Failed to save stock change: ${t}`})}}async getStockChanges(e,t){try{let i=(await this.db.find({selector:{type:"stockchange","data.cellId":e,"data.timestamp":{$gte:t}}})).docs.map(o=>o.data).sort((o,d)=>o.timestamp-d.timestamp);return I(i)}catch(r){return N({code:"READ_FAILED",message:`Failed to get stock changes: ${r}`})}}async saveConsumptionRecord(e){try{let t=`consumption:${e.id}`;return await this.db.put({_id:t,type:"consumption",data:e,createdAt:u(),updatedAt:u()}),I(void 0)}catch(t){return N({code:"WRITE_FAILED",message:`Failed to save consumption record: ${t}`})}}async getConsumptionHistory(e,t){try{let i=(await this.db.find({selector:{type:"consumption","data.cellId":e,"data.timestamp":{$gte:t}}})).docs.map(o=>o.data).sort((o,d)=>o.timestamp-d.timestamp);return I(i)}catch(r){return N({code:"READ_FAILED",message:`Failed to get consumption history: ${r}`})}}async saveEnergyPlan(e){try{let t=`energyplan:${e.cellId}:${e.weekStart}`,r=Object.fromEntries(e.projectedConsumption),i=Object.fromEntries(e.requiredByCarrier),o=Object.fromEntries(e.availableByCarrier),d=Object.fromEntries(e.selectedModes),f=e.bundles.map(b=>({...b,energyAllocation:Object.fromEntries(b.energyAllocation)})),S={_id:t,type:"energyplan",data:{...e,projectedConsumption:r,requiredByCarrier:i,availableByCarrier:o,selectedModes:d,bundles:f},createdAt:u(),updatedAt:u()};try{let b=await this.db.get(t);S._rev=b._rev,S.createdAt=b.createdAt}catch(b){if(b.status!==404)throw b}return await this.db.put(S),I(void 0)}catch(t){return N({code:"WRITE_FAILED",message:`Failed to save energy plan: ${t}`})}}async getEnergyPlan(e,t){try{let r=await this.db.get(`energyplan:${e}:${t}`),i=new Map(Object.entries(r.data.projectedConsumption)),o=new Map(Object.entries(r.data.requiredByCarrier)),d=new Map(Object.entries(r.data.availableByCarrier)),f=new Map(Object.entries(r.data.selectedModes)),S=r.data.bundles.map(b=>({...b,energyAllocation:new Map(Object.entries(b.energyAllocation))}));return I({...r.data,projectedConsumption:i,requiredByCarrier:o,availableByCarrier:d,selectedModes:f,bundles:S})}catch(r){return r.status===404?I(null):N({code:"READ_FAILED",message:`Failed to get energy plan: ${r}`})}}};function dt(){return new Pt}function ur(h){return new Nt(h)}async function Ot(h){let{cellId:e,ledgerParameters:t={}}=h,r=h.storage??dt(),i=h.crypto??rr;if(!i.isInitialized()){let V=await i.initialize();if(!V.ok)throw new Error(`Failed to initialize crypto: ${V.error.message}`)}let o=await tr(e,t,r),d=ir(o,r,i),S=nr(o,r,i,async V=>(await d.getIdentity(V))?.publicKey),b=sr(o,S,r),P=or(e,o,d,b,r),U=cr(o,b,r),q=lr(e,o,r,h.emergencyThresholds);q.setGovernanceEngine(P),q.setIdentityEngine(d);let re;h.enableFederation&&(re=await dr(e,o,r,h.federationParameters),re.setEmergencyEngine(q));let j;return h.enableEnergy&&(j=mr(e,o,r,h.energyCarriers,h.energyTaskProfiles),j.setSchedulerEngine(U),U.setEnergyEngine(j),q.setEnergyEngine(j),await j.loadState()),{cellId:e,ledger:o,transactions:S,identity:d,commitments:b,governance:P,scheduler:U,emergency:q,federation:re,energy:j,storage:r,crypto:i}}return Xr(Hn);})();
//# sourceMappingURL=cell-protocol.js.map
