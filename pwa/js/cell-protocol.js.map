{
  "version": 3,
  "sources": ["../../node_modules/tweetnacl/nacl-fast.js", "../../src/cell-protocol/browser.ts", "../../src/cell-protocol/types/common.ts", "../../src/cell-protocol/types/energy.ts", "../../src/cell-protocol/types/emergency.ts", "../../src/cell-protocol/types/federation.ts", "../../src/cell-protocol/utils/result.ts", "../../src/cell-protocol/engines/ledger-engine.ts", "../../src/cell-protocol/crypto/crypto-adapter.ts", "../../src/cell-protocol/engines/transaction-engine.ts", "../../src/cell-protocol/engines/identity-engine.ts", "../../src/cell-protocol/engines/commitment-engine.ts", "../../src/cell-protocol/engines/governance-engine.ts", "../../src/cell-protocol/engines/scheduler-engine.ts", "../../src/cell-protocol/engines/emergency-engine.ts", "../../src/cell-protocol/engines/federation-engine.ts", "../../src/cell-protocol/engines/energy-engine.ts", "../../src/cell-protocol/storage/pouchdb-adapter.ts", "../../src/cell-protocol/index.ts"],
  "sourcesContent": ["(function(nacl) {\n'use strict';\n\n// Ported in 2014 by Dmitry Chestnykh and Devi Mandiri.\n// Public domain.\n//\n// Implementation derived from TweetNaCl version 20140427.\n// See for details: http://tweetnacl.cr.yp.to/\n\nvar gf = function(init) {\n  var i, r = new Float64Array(16);\n  if (init) for (i = 0; i < init.length; i++) r[i] = init[i];\n  return r;\n};\n\n//  Pluggable, initialized in high-level API below.\nvar randombytes = function(/* x, n */) { throw new Error('no PRNG'); };\n\nvar _0 = new Uint8Array(16);\nvar _9 = new Uint8Array(32); _9[0] = 9;\n\nvar gf0 = gf(),\n    gf1 = gf([1]),\n    _121665 = gf([0xdb41, 1]),\n    D = gf([0x78a3, 0x1359, 0x4dca, 0x75eb, 0xd8ab, 0x4141, 0x0a4d, 0x0070, 0xe898, 0x7779, 0x4079, 0x8cc7, 0xfe73, 0x2b6f, 0x6cee, 0x5203]),\n    D2 = gf([0xf159, 0x26b2, 0x9b94, 0xebd6, 0xb156, 0x8283, 0x149a, 0x00e0, 0xd130, 0xeef3, 0x80f2, 0x198e, 0xfce7, 0x56df, 0xd9dc, 0x2406]),\n    X = gf([0xd51a, 0x8f25, 0x2d60, 0xc956, 0xa7b2, 0x9525, 0xc760, 0x692c, 0xdc5c, 0xfdd6, 0xe231, 0xc0a4, 0x53fe, 0xcd6e, 0x36d3, 0x2169]),\n    Y = gf([0x6658, 0x6666, 0x6666, 0x6666, 0x6666, 0x6666, 0x6666, 0x6666, 0x6666, 0x6666, 0x6666, 0x6666, 0x6666, 0x6666, 0x6666, 0x6666]),\n    I = gf([0xa0b0, 0x4a0e, 0x1b27, 0xc4ee, 0xe478, 0xad2f, 0x1806, 0x2f43, 0xd7a7, 0x3dfb, 0x0099, 0x2b4d, 0xdf0b, 0x4fc1, 0x2480, 0x2b83]);\n\nfunction ts64(x, i, h, l) {\n  x[i]   = (h >> 24) & 0xff;\n  x[i+1] = (h >> 16) & 0xff;\n  x[i+2] = (h >>  8) & 0xff;\n  x[i+3] = h & 0xff;\n  x[i+4] = (l >> 24)  & 0xff;\n  x[i+5] = (l >> 16)  & 0xff;\n  x[i+6] = (l >>  8)  & 0xff;\n  x[i+7] = l & 0xff;\n}\n\nfunction vn(x, xi, y, yi, n) {\n  var i,d = 0;\n  for (i = 0; i < n; i++) d |= x[xi+i]^y[yi+i];\n  return (1 & ((d - 1) >>> 8)) - 1;\n}\n\nfunction crypto_verify_16(x, xi, y, yi) {\n  return vn(x,xi,y,yi,16);\n}\n\nfunction crypto_verify_32(x, xi, y, yi) {\n  return vn(x,xi,y,yi,32);\n}\n\nfunction core_salsa20(o, p, k, c) {\n  var j0  = c[ 0] & 0xff | (c[ 1] & 0xff)<<8 | (c[ 2] & 0xff)<<16 | (c[ 3] & 0xff)<<24,\n      j1  = k[ 0] & 0xff | (k[ 1] & 0xff)<<8 | (k[ 2] & 0xff)<<16 | (k[ 3] & 0xff)<<24,\n      j2  = k[ 4] & 0xff | (k[ 5] & 0xff)<<8 | (k[ 6] & 0xff)<<16 | (k[ 7] & 0xff)<<24,\n      j3  = k[ 8] & 0xff | (k[ 9] & 0xff)<<8 | (k[10] & 0xff)<<16 | (k[11] & 0xff)<<24,\n      j4  = k[12] & 0xff | (k[13] & 0xff)<<8 | (k[14] & 0xff)<<16 | (k[15] & 0xff)<<24,\n      j5  = c[ 4] & 0xff | (c[ 5] & 0xff)<<8 | (c[ 6] & 0xff)<<16 | (c[ 7] & 0xff)<<24,\n      j6  = p[ 0] & 0xff | (p[ 1] & 0xff)<<8 | (p[ 2] & 0xff)<<16 | (p[ 3] & 0xff)<<24,\n      j7  = p[ 4] & 0xff | (p[ 5] & 0xff)<<8 | (p[ 6] & 0xff)<<16 | (p[ 7] & 0xff)<<24,\n      j8  = p[ 8] & 0xff | (p[ 9] & 0xff)<<8 | (p[10] & 0xff)<<16 | (p[11] & 0xff)<<24,\n      j9  = p[12] & 0xff | (p[13] & 0xff)<<8 | (p[14] & 0xff)<<16 | (p[15] & 0xff)<<24,\n      j10 = c[ 8] & 0xff | (c[ 9] & 0xff)<<8 | (c[10] & 0xff)<<16 | (c[11] & 0xff)<<24,\n      j11 = k[16] & 0xff | (k[17] & 0xff)<<8 | (k[18] & 0xff)<<16 | (k[19] & 0xff)<<24,\n      j12 = k[20] & 0xff | (k[21] & 0xff)<<8 | (k[22] & 0xff)<<16 | (k[23] & 0xff)<<24,\n      j13 = k[24] & 0xff | (k[25] & 0xff)<<8 | (k[26] & 0xff)<<16 | (k[27] & 0xff)<<24,\n      j14 = k[28] & 0xff | (k[29] & 0xff)<<8 | (k[30] & 0xff)<<16 | (k[31] & 0xff)<<24,\n      j15 = c[12] & 0xff | (c[13] & 0xff)<<8 | (c[14] & 0xff)<<16 | (c[15] & 0xff)<<24;\n\n  var x0 = j0, x1 = j1, x2 = j2, x3 = j3, x4 = j4, x5 = j5, x6 = j6, x7 = j7,\n      x8 = j8, x9 = j9, x10 = j10, x11 = j11, x12 = j12, x13 = j13, x14 = j14,\n      x15 = j15, u;\n\n  for (var i = 0; i < 20; i += 2) {\n    u = x0 + x12 | 0;\n    x4 ^= u<<7 | u>>>(32-7);\n    u = x4 + x0 | 0;\n    x8 ^= u<<9 | u>>>(32-9);\n    u = x8 + x4 | 0;\n    x12 ^= u<<13 | u>>>(32-13);\n    u = x12 + x8 | 0;\n    x0 ^= u<<18 | u>>>(32-18);\n\n    u = x5 + x1 | 0;\n    x9 ^= u<<7 | u>>>(32-7);\n    u = x9 + x5 | 0;\n    x13 ^= u<<9 | u>>>(32-9);\n    u = x13 + x9 | 0;\n    x1 ^= u<<13 | u>>>(32-13);\n    u = x1 + x13 | 0;\n    x5 ^= u<<18 | u>>>(32-18);\n\n    u = x10 + x6 | 0;\n    x14 ^= u<<7 | u>>>(32-7);\n    u = x14 + x10 | 0;\n    x2 ^= u<<9 | u>>>(32-9);\n    u = x2 + x14 | 0;\n    x6 ^= u<<13 | u>>>(32-13);\n    u = x6 + x2 | 0;\n    x10 ^= u<<18 | u>>>(32-18);\n\n    u = x15 + x11 | 0;\n    x3 ^= u<<7 | u>>>(32-7);\n    u = x3 + x15 | 0;\n    x7 ^= u<<9 | u>>>(32-9);\n    u = x7 + x3 | 0;\n    x11 ^= u<<13 | u>>>(32-13);\n    u = x11 + x7 | 0;\n    x15 ^= u<<18 | u>>>(32-18);\n\n    u = x0 + x3 | 0;\n    x1 ^= u<<7 | u>>>(32-7);\n    u = x1 + x0 | 0;\n    x2 ^= u<<9 | u>>>(32-9);\n    u = x2 + x1 | 0;\n    x3 ^= u<<13 | u>>>(32-13);\n    u = x3 + x2 | 0;\n    x0 ^= u<<18 | u>>>(32-18);\n\n    u = x5 + x4 | 0;\n    x6 ^= u<<7 | u>>>(32-7);\n    u = x6 + x5 | 0;\n    x7 ^= u<<9 | u>>>(32-9);\n    u = x7 + x6 | 0;\n    x4 ^= u<<13 | u>>>(32-13);\n    u = x4 + x7 | 0;\n    x5 ^= u<<18 | u>>>(32-18);\n\n    u = x10 + x9 | 0;\n    x11 ^= u<<7 | u>>>(32-7);\n    u = x11 + x10 | 0;\n    x8 ^= u<<9 | u>>>(32-9);\n    u = x8 + x11 | 0;\n    x9 ^= u<<13 | u>>>(32-13);\n    u = x9 + x8 | 0;\n    x10 ^= u<<18 | u>>>(32-18);\n\n    u = x15 + x14 | 0;\n    x12 ^= u<<7 | u>>>(32-7);\n    u = x12 + x15 | 0;\n    x13 ^= u<<9 | u>>>(32-9);\n    u = x13 + x12 | 0;\n    x14 ^= u<<13 | u>>>(32-13);\n    u = x14 + x13 | 0;\n    x15 ^= u<<18 | u>>>(32-18);\n  }\n   x0 =  x0 +  j0 | 0;\n   x1 =  x1 +  j1 | 0;\n   x2 =  x2 +  j2 | 0;\n   x3 =  x3 +  j3 | 0;\n   x4 =  x4 +  j4 | 0;\n   x5 =  x5 +  j5 | 0;\n   x6 =  x6 +  j6 | 0;\n   x7 =  x7 +  j7 | 0;\n   x8 =  x8 +  j8 | 0;\n   x9 =  x9 +  j9 | 0;\n  x10 = x10 + j10 | 0;\n  x11 = x11 + j11 | 0;\n  x12 = x12 + j12 | 0;\n  x13 = x13 + j13 | 0;\n  x14 = x14 + j14 | 0;\n  x15 = x15 + j15 | 0;\n\n  o[ 0] = x0 >>>  0 & 0xff;\n  o[ 1] = x0 >>>  8 & 0xff;\n  o[ 2] = x0 >>> 16 & 0xff;\n  o[ 3] = x0 >>> 24 & 0xff;\n\n  o[ 4] = x1 >>>  0 & 0xff;\n  o[ 5] = x1 >>>  8 & 0xff;\n  o[ 6] = x1 >>> 16 & 0xff;\n  o[ 7] = x1 >>> 24 & 0xff;\n\n  o[ 8] = x2 >>>  0 & 0xff;\n  o[ 9] = x2 >>>  8 & 0xff;\n  o[10] = x2 >>> 16 & 0xff;\n  o[11] = x2 >>> 24 & 0xff;\n\n  o[12] = x3 >>>  0 & 0xff;\n  o[13] = x3 >>>  8 & 0xff;\n  o[14] = x3 >>> 16 & 0xff;\n  o[15] = x3 >>> 24 & 0xff;\n\n  o[16] = x4 >>>  0 & 0xff;\n  o[17] = x4 >>>  8 & 0xff;\n  o[18] = x4 >>> 16 & 0xff;\n  o[19] = x4 >>> 24 & 0xff;\n\n  o[20] = x5 >>>  0 & 0xff;\n  o[21] = x5 >>>  8 & 0xff;\n  o[22] = x5 >>> 16 & 0xff;\n  o[23] = x5 >>> 24 & 0xff;\n\n  o[24] = x6 >>>  0 & 0xff;\n  o[25] = x6 >>>  8 & 0xff;\n  o[26] = x6 >>> 16 & 0xff;\n  o[27] = x6 >>> 24 & 0xff;\n\n  o[28] = x7 >>>  0 & 0xff;\n  o[29] = x7 >>>  8 & 0xff;\n  o[30] = x7 >>> 16 & 0xff;\n  o[31] = x7 >>> 24 & 0xff;\n\n  o[32] = x8 >>>  0 & 0xff;\n  o[33] = x8 >>>  8 & 0xff;\n  o[34] = x8 >>> 16 & 0xff;\n  o[35] = x8 >>> 24 & 0xff;\n\n  o[36] = x9 >>>  0 & 0xff;\n  o[37] = x9 >>>  8 & 0xff;\n  o[38] = x9 >>> 16 & 0xff;\n  o[39] = x9 >>> 24 & 0xff;\n\n  o[40] = x10 >>>  0 & 0xff;\n  o[41] = x10 >>>  8 & 0xff;\n  o[42] = x10 >>> 16 & 0xff;\n  o[43] = x10 >>> 24 & 0xff;\n\n  o[44] = x11 >>>  0 & 0xff;\n  o[45] = x11 >>>  8 & 0xff;\n  o[46] = x11 >>> 16 & 0xff;\n  o[47] = x11 >>> 24 & 0xff;\n\n  o[48] = x12 >>>  0 & 0xff;\n  o[49] = x12 >>>  8 & 0xff;\n  o[50] = x12 >>> 16 & 0xff;\n  o[51] = x12 >>> 24 & 0xff;\n\n  o[52] = x13 >>>  0 & 0xff;\n  o[53] = x13 >>>  8 & 0xff;\n  o[54] = x13 >>> 16 & 0xff;\n  o[55] = x13 >>> 24 & 0xff;\n\n  o[56] = x14 >>>  0 & 0xff;\n  o[57] = x14 >>>  8 & 0xff;\n  o[58] = x14 >>> 16 & 0xff;\n  o[59] = x14 >>> 24 & 0xff;\n\n  o[60] = x15 >>>  0 & 0xff;\n  o[61] = x15 >>>  8 & 0xff;\n  o[62] = x15 >>> 16 & 0xff;\n  o[63] = x15 >>> 24 & 0xff;\n}\n\nfunction core_hsalsa20(o,p,k,c) {\n  var j0  = c[ 0] & 0xff | (c[ 1] & 0xff)<<8 | (c[ 2] & 0xff)<<16 | (c[ 3] & 0xff)<<24,\n      j1  = k[ 0] & 0xff | (k[ 1] & 0xff)<<8 | (k[ 2] & 0xff)<<16 | (k[ 3] & 0xff)<<24,\n      j2  = k[ 4] & 0xff | (k[ 5] & 0xff)<<8 | (k[ 6] & 0xff)<<16 | (k[ 7] & 0xff)<<24,\n      j3  = k[ 8] & 0xff | (k[ 9] & 0xff)<<8 | (k[10] & 0xff)<<16 | (k[11] & 0xff)<<24,\n      j4  = k[12] & 0xff | (k[13] & 0xff)<<8 | (k[14] & 0xff)<<16 | (k[15] & 0xff)<<24,\n      j5  = c[ 4] & 0xff | (c[ 5] & 0xff)<<8 | (c[ 6] & 0xff)<<16 | (c[ 7] & 0xff)<<24,\n      j6  = p[ 0] & 0xff | (p[ 1] & 0xff)<<8 | (p[ 2] & 0xff)<<16 | (p[ 3] & 0xff)<<24,\n      j7  = p[ 4] & 0xff | (p[ 5] & 0xff)<<8 | (p[ 6] & 0xff)<<16 | (p[ 7] & 0xff)<<24,\n      j8  = p[ 8] & 0xff | (p[ 9] & 0xff)<<8 | (p[10] & 0xff)<<16 | (p[11] & 0xff)<<24,\n      j9  = p[12] & 0xff | (p[13] & 0xff)<<8 | (p[14] & 0xff)<<16 | (p[15] & 0xff)<<24,\n      j10 = c[ 8] & 0xff | (c[ 9] & 0xff)<<8 | (c[10] & 0xff)<<16 | (c[11] & 0xff)<<24,\n      j11 = k[16] & 0xff | (k[17] & 0xff)<<8 | (k[18] & 0xff)<<16 | (k[19] & 0xff)<<24,\n      j12 = k[20] & 0xff | (k[21] & 0xff)<<8 | (k[22] & 0xff)<<16 | (k[23] & 0xff)<<24,\n      j13 = k[24] & 0xff | (k[25] & 0xff)<<8 | (k[26] & 0xff)<<16 | (k[27] & 0xff)<<24,\n      j14 = k[28] & 0xff | (k[29] & 0xff)<<8 | (k[30] & 0xff)<<16 | (k[31] & 0xff)<<24,\n      j15 = c[12] & 0xff | (c[13] & 0xff)<<8 | (c[14] & 0xff)<<16 | (c[15] & 0xff)<<24;\n\n  var x0 = j0, x1 = j1, x2 = j2, x3 = j3, x4 = j4, x5 = j5, x6 = j6, x7 = j7,\n      x8 = j8, x9 = j9, x10 = j10, x11 = j11, x12 = j12, x13 = j13, x14 = j14,\n      x15 = j15, u;\n\n  for (var i = 0; i < 20; i += 2) {\n    u = x0 + x12 | 0;\n    x4 ^= u<<7 | u>>>(32-7);\n    u = x4 + x0 | 0;\n    x8 ^= u<<9 | u>>>(32-9);\n    u = x8 + x4 | 0;\n    x12 ^= u<<13 | u>>>(32-13);\n    u = x12 + x8 | 0;\n    x0 ^= u<<18 | u>>>(32-18);\n\n    u = x5 + x1 | 0;\n    x9 ^= u<<7 | u>>>(32-7);\n    u = x9 + x5 | 0;\n    x13 ^= u<<9 | u>>>(32-9);\n    u = x13 + x9 | 0;\n    x1 ^= u<<13 | u>>>(32-13);\n    u = x1 + x13 | 0;\n    x5 ^= u<<18 | u>>>(32-18);\n\n    u = x10 + x6 | 0;\n    x14 ^= u<<7 | u>>>(32-7);\n    u = x14 + x10 | 0;\n    x2 ^= u<<9 | u>>>(32-9);\n    u = x2 + x14 | 0;\n    x6 ^= u<<13 | u>>>(32-13);\n    u = x6 + x2 | 0;\n    x10 ^= u<<18 | u>>>(32-18);\n\n    u = x15 + x11 | 0;\n    x3 ^= u<<7 | u>>>(32-7);\n    u = x3 + x15 | 0;\n    x7 ^= u<<9 | u>>>(32-9);\n    u = x7 + x3 | 0;\n    x11 ^= u<<13 | u>>>(32-13);\n    u = x11 + x7 | 0;\n    x15 ^= u<<18 | u>>>(32-18);\n\n    u = x0 + x3 | 0;\n    x1 ^= u<<7 | u>>>(32-7);\n    u = x1 + x0 | 0;\n    x2 ^= u<<9 | u>>>(32-9);\n    u = x2 + x1 | 0;\n    x3 ^= u<<13 | u>>>(32-13);\n    u = x3 + x2 | 0;\n    x0 ^= u<<18 | u>>>(32-18);\n\n    u = x5 + x4 | 0;\n    x6 ^= u<<7 | u>>>(32-7);\n    u = x6 + x5 | 0;\n    x7 ^= u<<9 | u>>>(32-9);\n    u = x7 + x6 | 0;\n    x4 ^= u<<13 | u>>>(32-13);\n    u = x4 + x7 | 0;\n    x5 ^= u<<18 | u>>>(32-18);\n\n    u = x10 + x9 | 0;\n    x11 ^= u<<7 | u>>>(32-7);\n    u = x11 + x10 | 0;\n    x8 ^= u<<9 | u>>>(32-9);\n    u = x8 + x11 | 0;\n    x9 ^= u<<13 | u>>>(32-13);\n    u = x9 + x8 | 0;\n    x10 ^= u<<18 | u>>>(32-18);\n\n    u = x15 + x14 | 0;\n    x12 ^= u<<7 | u>>>(32-7);\n    u = x12 + x15 | 0;\n    x13 ^= u<<9 | u>>>(32-9);\n    u = x13 + x12 | 0;\n    x14 ^= u<<13 | u>>>(32-13);\n    u = x14 + x13 | 0;\n    x15 ^= u<<18 | u>>>(32-18);\n  }\n\n  o[ 0] = x0 >>>  0 & 0xff;\n  o[ 1] = x0 >>>  8 & 0xff;\n  o[ 2] = x0 >>> 16 & 0xff;\n  o[ 3] = x0 >>> 24 & 0xff;\n\n  o[ 4] = x5 >>>  0 & 0xff;\n  o[ 5] = x5 >>>  8 & 0xff;\n  o[ 6] = x5 >>> 16 & 0xff;\n  o[ 7] = x5 >>> 24 & 0xff;\n\n  o[ 8] = x10 >>>  0 & 0xff;\n  o[ 9] = x10 >>>  8 & 0xff;\n  o[10] = x10 >>> 16 & 0xff;\n  o[11] = x10 >>> 24 & 0xff;\n\n  o[12] = x15 >>>  0 & 0xff;\n  o[13] = x15 >>>  8 & 0xff;\n  o[14] = x15 >>> 16 & 0xff;\n  o[15] = x15 >>> 24 & 0xff;\n\n  o[16] = x6 >>>  0 & 0xff;\n  o[17] = x6 >>>  8 & 0xff;\n  o[18] = x6 >>> 16 & 0xff;\n  o[19] = x6 >>> 24 & 0xff;\n\n  o[20] = x7 >>>  0 & 0xff;\n  o[21] = x7 >>>  8 & 0xff;\n  o[22] = x7 >>> 16 & 0xff;\n  o[23] = x7 >>> 24 & 0xff;\n\n  o[24] = x8 >>>  0 & 0xff;\n  o[25] = x8 >>>  8 & 0xff;\n  o[26] = x8 >>> 16 & 0xff;\n  o[27] = x8 >>> 24 & 0xff;\n\n  o[28] = x9 >>>  0 & 0xff;\n  o[29] = x9 >>>  8 & 0xff;\n  o[30] = x9 >>> 16 & 0xff;\n  o[31] = x9 >>> 24 & 0xff;\n}\n\nfunction crypto_core_salsa20(out,inp,k,c) {\n  core_salsa20(out,inp,k,c);\n}\n\nfunction crypto_core_hsalsa20(out,inp,k,c) {\n  core_hsalsa20(out,inp,k,c);\n}\n\nvar sigma = new Uint8Array([101, 120, 112, 97, 110, 100, 32, 51, 50, 45, 98, 121, 116, 101, 32, 107]);\n            // \"expand 32-byte k\"\n\nfunction crypto_stream_salsa20_xor(c,cpos,m,mpos,b,n,k) {\n  var z = new Uint8Array(16), x = new Uint8Array(64);\n  var u, i;\n  for (i = 0; i < 16; i++) z[i] = 0;\n  for (i = 0; i < 8; i++) z[i] = n[i];\n  while (b >= 64) {\n    crypto_core_salsa20(x,z,k,sigma);\n    for (i = 0; i < 64; i++) c[cpos+i] = m[mpos+i] ^ x[i];\n    u = 1;\n    for (i = 8; i < 16; i++) {\n      u = u + (z[i] & 0xff) | 0;\n      z[i] = u & 0xff;\n      u >>>= 8;\n    }\n    b -= 64;\n    cpos += 64;\n    mpos += 64;\n  }\n  if (b > 0) {\n    crypto_core_salsa20(x,z,k,sigma);\n    for (i = 0; i < b; i++) c[cpos+i] = m[mpos+i] ^ x[i];\n  }\n  return 0;\n}\n\nfunction crypto_stream_salsa20(c,cpos,b,n,k) {\n  var z = new Uint8Array(16), x = new Uint8Array(64);\n  var u, i;\n  for (i = 0; i < 16; i++) z[i] = 0;\n  for (i = 0; i < 8; i++) z[i] = n[i];\n  while (b >= 64) {\n    crypto_core_salsa20(x,z,k,sigma);\n    for (i = 0; i < 64; i++) c[cpos+i] = x[i];\n    u = 1;\n    for (i = 8; i < 16; i++) {\n      u = u + (z[i] & 0xff) | 0;\n      z[i] = u & 0xff;\n      u >>>= 8;\n    }\n    b -= 64;\n    cpos += 64;\n  }\n  if (b > 0) {\n    crypto_core_salsa20(x,z,k,sigma);\n    for (i = 0; i < b; i++) c[cpos+i] = x[i];\n  }\n  return 0;\n}\n\nfunction crypto_stream(c,cpos,d,n,k) {\n  var s = new Uint8Array(32);\n  crypto_core_hsalsa20(s,n,k,sigma);\n  var sn = new Uint8Array(8);\n  for (var i = 0; i < 8; i++) sn[i] = n[i+16];\n  return crypto_stream_salsa20(c,cpos,d,sn,s);\n}\n\nfunction crypto_stream_xor(c,cpos,m,mpos,d,n,k) {\n  var s = new Uint8Array(32);\n  crypto_core_hsalsa20(s,n,k,sigma);\n  var sn = new Uint8Array(8);\n  for (var i = 0; i < 8; i++) sn[i] = n[i+16];\n  return crypto_stream_salsa20_xor(c,cpos,m,mpos,d,sn,s);\n}\n\n/*\n* Port of Andrew Moon's Poly1305-donna-16. Public domain.\n* https://github.com/floodyberry/poly1305-donna\n*/\n\nvar poly1305 = function(key) {\n  this.buffer = new Uint8Array(16);\n  this.r = new Uint16Array(10);\n  this.h = new Uint16Array(10);\n  this.pad = new Uint16Array(8);\n  this.leftover = 0;\n  this.fin = 0;\n\n  var t0, t1, t2, t3, t4, t5, t6, t7;\n\n  t0 = key[ 0] & 0xff | (key[ 1] & 0xff) << 8; this.r[0] = ( t0                     ) & 0x1fff;\n  t1 = key[ 2] & 0xff | (key[ 3] & 0xff) << 8; this.r[1] = ((t0 >>> 13) | (t1 <<  3)) & 0x1fff;\n  t2 = key[ 4] & 0xff | (key[ 5] & 0xff) << 8; this.r[2] = ((t1 >>> 10) | (t2 <<  6)) & 0x1f03;\n  t3 = key[ 6] & 0xff | (key[ 7] & 0xff) << 8; this.r[3] = ((t2 >>>  7) | (t3 <<  9)) & 0x1fff;\n  t4 = key[ 8] & 0xff | (key[ 9] & 0xff) << 8; this.r[4] = ((t3 >>>  4) | (t4 << 12)) & 0x00ff;\n  this.r[5] = ((t4 >>>  1)) & 0x1ffe;\n  t5 = key[10] & 0xff | (key[11] & 0xff) << 8; this.r[6] = ((t4 >>> 14) | (t5 <<  2)) & 0x1fff;\n  t6 = key[12] & 0xff | (key[13] & 0xff) << 8; this.r[7] = ((t5 >>> 11) | (t6 <<  5)) & 0x1f81;\n  t7 = key[14] & 0xff | (key[15] & 0xff) << 8; this.r[8] = ((t6 >>>  8) | (t7 <<  8)) & 0x1fff;\n  this.r[9] = ((t7 >>>  5)) & 0x007f;\n\n  this.pad[0] = key[16] & 0xff | (key[17] & 0xff) << 8;\n  this.pad[1] = key[18] & 0xff | (key[19] & 0xff) << 8;\n  this.pad[2] = key[20] & 0xff | (key[21] & 0xff) << 8;\n  this.pad[3] = key[22] & 0xff | (key[23] & 0xff) << 8;\n  this.pad[4] = key[24] & 0xff | (key[25] & 0xff) << 8;\n  this.pad[5] = key[26] & 0xff | (key[27] & 0xff) << 8;\n  this.pad[6] = key[28] & 0xff | (key[29] & 0xff) << 8;\n  this.pad[7] = key[30] & 0xff | (key[31] & 0xff) << 8;\n};\n\npoly1305.prototype.blocks = function(m, mpos, bytes) {\n  var hibit = this.fin ? 0 : (1 << 11);\n  var t0, t1, t2, t3, t4, t5, t6, t7, c;\n  var d0, d1, d2, d3, d4, d5, d6, d7, d8, d9;\n\n  var h0 = this.h[0],\n      h1 = this.h[1],\n      h2 = this.h[2],\n      h3 = this.h[3],\n      h4 = this.h[4],\n      h5 = this.h[5],\n      h6 = this.h[6],\n      h7 = this.h[7],\n      h8 = this.h[8],\n      h9 = this.h[9];\n\n  var r0 = this.r[0],\n      r1 = this.r[1],\n      r2 = this.r[2],\n      r3 = this.r[3],\n      r4 = this.r[4],\n      r5 = this.r[5],\n      r6 = this.r[6],\n      r7 = this.r[7],\n      r8 = this.r[8],\n      r9 = this.r[9];\n\n  while (bytes >= 16) {\n    t0 = m[mpos+ 0] & 0xff | (m[mpos+ 1] & 0xff) << 8; h0 += ( t0                     ) & 0x1fff;\n    t1 = m[mpos+ 2] & 0xff | (m[mpos+ 3] & 0xff) << 8; h1 += ((t0 >>> 13) | (t1 <<  3)) & 0x1fff;\n    t2 = m[mpos+ 4] & 0xff | (m[mpos+ 5] & 0xff) << 8; h2 += ((t1 >>> 10) | (t2 <<  6)) & 0x1fff;\n    t3 = m[mpos+ 6] & 0xff | (m[mpos+ 7] & 0xff) << 8; h3 += ((t2 >>>  7) | (t3 <<  9)) & 0x1fff;\n    t4 = m[mpos+ 8] & 0xff | (m[mpos+ 9] & 0xff) << 8; h4 += ((t3 >>>  4) | (t4 << 12)) & 0x1fff;\n    h5 += ((t4 >>>  1)) & 0x1fff;\n    t5 = m[mpos+10] & 0xff | (m[mpos+11] & 0xff) << 8; h6 += ((t4 >>> 14) | (t5 <<  2)) & 0x1fff;\n    t6 = m[mpos+12] & 0xff | (m[mpos+13] & 0xff) << 8; h7 += ((t5 >>> 11) | (t6 <<  5)) & 0x1fff;\n    t7 = m[mpos+14] & 0xff | (m[mpos+15] & 0xff) << 8; h8 += ((t6 >>>  8) | (t7 <<  8)) & 0x1fff;\n    h9 += ((t7 >>> 5)) | hibit;\n\n    c = 0;\n\n    d0 = c;\n    d0 += h0 * r0;\n    d0 += h1 * (5 * r9);\n    d0 += h2 * (5 * r8);\n    d0 += h3 * (5 * r7);\n    d0 += h4 * (5 * r6);\n    c = (d0 >>> 13); d0 &= 0x1fff;\n    d0 += h5 * (5 * r5);\n    d0 += h6 * (5 * r4);\n    d0 += h7 * (5 * r3);\n    d0 += h8 * (5 * r2);\n    d0 += h9 * (5 * r1);\n    c += (d0 >>> 13); d0 &= 0x1fff;\n\n    d1 = c;\n    d1 += h0 * r1;\n    d1 += h1 * r0;\n    d1 += h2 * (5 * r9);\n    d1 += h3 * (5 * r8);\n    d1 += h4 * (5 * r7);\n    c = (d1 >>> 13); d1 &= 0x1fff;\n    d1 += h5 * (5 * r6);\n    d1 += h6 * (5 * r5);\n    d1 += h7 * (5 * r4);\n    d1 += h8 * (5 * r3);\n    d1 += h9 * (5 * r2);\n    c += (d1 >>> 13); d1 &= 0x1fff;\n\n    d2 = c;\n    d2 += h0 * r2;\n    d2 += h1 * r1;\n    d2 += h2 * r0;\n    d2 += h3 * (5 * r9);\n    d2 += h4 * (5 * r8);\n    c = (d2 >>> 13); d2 &= 0x1fff;\n    d2 += h5 * (5 * r7);\n    d2 += h6 * (5 * r6);\n    d2 += h7 * (5 * r5);\n    d2 += h8 * (5 * r4);\n    d2 += h9 * (5 * r3);\n    c += (d2 >>> 13); d2 &= 0x1fff;\n\n    d3 = c;\n    d3 += h0 * r3;\n    d3 += h1 * r2;\n    d3 += h2 * r1;\n    d3 += h3 * r0;\n    d3 += h4 * (5 * r9);\n    c = (d3 >>> 13); d3 &= 0x1fff;\n    d3 += h5 * (5 * r8);\n    d3 += h6 * (5 * r7);\n    d3 += h7 * (5 * r6);\n    d3 += h8 * (5 * r5);\n    d3 += h9 * (5 * r4);\n    c += (d3 >>> 13); d3 &= 0x1fff;\n\n    d4 = c;\n    d4 += h0 * r4;\n    d4 += h1 * r3;\n    d4 += h2 * r2;\n    d4 += h3 * r1;\n    d4 += h4 * r0;\n    c = (d4 >>> 13); d4 &= 0x1fff;\n    d4 += h5 * (5 * r9);\n    d4 += h6 * (5 * r8);\n    d4 += h7 * (5 * r7);\n    d4 += h8 * (5 * r6);\n    d4 += h9 * (5 * r5);\n    c += (d4 >>> 13); d4 &= 0x1fff;\n\n    d5 = c;\n    d5 += h0 * r5;\n    d5 += h1 * r4;\n    d5 += h2 * r3;\n    d5 += h3 * r2;\n    d5 += h4 * r1;\n    c = (d5 >>> 13); d5 &= 0x1fff;\n    d5 += h5 * r0;\n    d5 += h6 * (5 * r9);\n    d5 += h7 * (5 * r8);\n    d5 += h8 * (5 * r7);\n    d5 += h9 * (5 * r6);\n    c += (d5 >>> 13); d5 &= 0x1fff;\n\n    d6 = c;\n    d6 += h0 * r6;\n    d6 += h1 * r5;\n    d6 += h2 * r4;\n    d6 += h3 * r3;\n    d6 += h4 * r2;\n    c = (d6 >>> 13); d6 &= 0x1fff;\n    d6 += h5 * r1;\n    d6 += h6 * r0;\n    d6 += h7 * (5 * r9);\n    d6 += h8 * (5 * r8);\n    d6 += h9 * (5 * r7);\n    c += (d6 >>> 13); d6 &= 0x1fff;\n\n    d7 = c;\n    d7 += h0 * r7;\n    d7 += h1 * r6;\n    d7 += h2 * r5;\n    d7 += h3 * r4;\n    d7 += h4 * r3;\n    c = (d7 >>> 13); d7 &= 0x1fff;\n    d7 += h5 * r2;\n    d7 += h6 * r1;\n    d7 += h7 * r0;\n    d7 += h8 * (5 * r9);\n    d7 += h9 * (5 * r8);\n    c += (d7 >>> 13); d7 &= 0x1fff;\n\n    d8 = c;\n    d8 += h0 * r8;\n    d8 += h1 * r7;\n    d8 += h2 * r6;\n    d8 += h3 * r5;\n    d8 += h4 * r4;\n    c = (d8 >>> 13); d8 &= 0x1fff;\n    d8 += h5 * r3;\n    d8 += h6 * r2;\n    d8 += h7 * r1;\n    d8 += h8 * r0;\n    d8 += h9 * (5 * r9);\n    c += (d8 >>> 13); d8 &= 0x1fff;\n\n    d9 = c;\n    d9 += h0 * r9;\n    d9 += h1 * r8;\n    d9 += h2 * r7;\n    d9 += h3 * r6;\n    d9 += h4 * r5;\n    c = (d9 >>> 13); d9 &= 0x1fff;\n    d9 += h5 * r4;\n    d9 += h6 * r3;\n    d9 += h7 * r2;\n    d9 += h8 * r1;\n    d9 += h9 * r0;\n    c += (d9 >>> 13); d9 &= 0x1fff;\n\n    c = (((c << 2) + c)) | 0;\n    c = (c + d0) | 0;\n    d0 = c & 0x1fff;\n    c = (c >>> 13);\n    d1 += c;\n\n    h0 = d0;\n    h1 = d1;\n    h2 = d2;\n    h3 = d3;\n    h4 = d4;\n    h5 = d5;\n    h6 = d6;\n    h7 = d7;\n    h8 = d8;\n    h9 = d9;\n\n    mpos += 16;\n    bytes -= 16;\n  }\n  this.h[0] = h0;\n  this.h[1] = h1;\n  this.h[2] = h2;\n  this.h[3] = h3;\n  this.h[4] = h4;\n  this.h[5] = h5;\n  this.h[6] = h6;\n  this.h[7] = h7;\n  this.h[8] = h8;\n  this.h[9] = h9;\n};\n\npoly1305.prototype.finish = function(mac, macpos) {\n  var g = new Uint16Array(10);\n  var c, mask, f, i;\n\n  if (this.leftover) {\n    i = this.leftover;\n    this.buffer[i++] = 1;\n    for (; i < 16; i++) this.buffer[i] = 0;\n    this.fin = 1;\n    this.blocks(this.buffer, 0, 16);\n  }\n\n  c = this.h[1] >>> 13;\n  this.h[1] &= 0x1fff;\n  for (i = 2; i < 10; i++) {\n    this.h[i] += c;\n    c = this.h[i] >>> 13;\n    this.h[i] &= 0x1fff;\n  }\n  this.h[0] += (c * 5);\n  c = this.h[0] >>> 13;\n  this.h[0] &= 0x1fff;\n  this.h[1] += c;\n  c = this.h[1] >>> 13;\n  this.h[1] &= 0x1fff;\n  this.h[2] += c;\n\n  g[0] = this.h[0] + 5;\n  c = g[0] >>> 13;\n  g[0] &= 0x1fff;\n  for (i = 1; i < 10; i++) {\n    g[i] = this.h[i] + c;\n    c = g[i] >>> 13;\n    g[i] &= 0x1fff;\n  }\n  g[9] -= (1 << 13);\n\n  mask = (c ^ 1) - 1;\n  for (i = 0; i < 10; i++) g[i] &= mask;\n  mask = ~mask;\n  for (i = 0; i < 10; i++) this.h[i] = (this.h[i] & mask) | g[i];\n\n  this.h[0] = ((this.h[0]       ) | (this.h[1] << 13)                    ) & 0xffff;\n  this.h[1] = ((this.h[1] >>>  3) | (this.h[2] << 10)                    ) & 0xffff;\n  this.h[2] = ((this.h[2] >>>  6) | (this.h[3] <<  7)                    ) & 0xffff;\n  this.h[3] = ((this.h[3] >>>  9) | (this.h[4] <<  4)                    ) & 0xffff;\n  this.h[4] = ((this.h[4] >>> 12) | (this.h[5] <<  1) | (this.h[6] << 14)) & 0xffff;\n  this.h[5] = ((this.h[6] >>>  2) | (this.h[7] << 11)                    ) & 0xffff;\n  this.h[6] = ((this.h[7] >>>  5) | (this.h[8] <<  8)                    ) & 0xffff;\n  this.h[7] = ((this.h[8] >>>  8) | (this.h[9] <<  5)                    ) & 0xffff;\n\n  f = this.h[0] + this.pad[0];\n  this.h[0] = f & 0xffff;\n  for (i = 1; i < 8; i++) {\n    f = (((this.h[i] + this.pad[i]) | 0) + (f >>> 16)) | 0;\n    this.h[i] = f & 0xffff;\n  }\n\n  mac[macpos+ 0] = (this.h[0] >>> 0) & 0xff;\n  mac[macpos+ 1] = (this.h[0] >>> 8) & 0xff;\n  mac[macpos+ 2] = (this.h[1] >>> 0) & 0xff;\n  mac[macpos+ 3] = (this.h[1] >>> 8) & 0xff;\n  mac[macpos+ 4] = (this.h[2] >>> 0) & 0xff;\n  mac[macpos+ 5] = (this.h[2] >>> 8) & 0xff;\n  mac[macpos+ 6] = (this.h[3] >>> 0) & 0xff;\n  mac[macpos+ 7] = (this.h[3] >>> 8) & 0xff;\n  mac[macpos+ 8] = (this.h[4] >>> 0) & 0xff;\n  mac[macpos+ 9] = (this.h[4] >>> 8) & 0xff;\n  mac[macpos+10] = (this.h[5] >>> 0) & 0xff;\n  mac[macpos+11] = (this.h[5] >>> 8) & 0xff;\n  mac[macpos+12] = (this.h[6] >>> 0) & 0xff;\n  mac[macpos+13] = (this.h[6] >>> 8) & 0xff;\n  mac[macpos+14] = (this.h[7] >>> 0) & 0xff;\n  mac[macpos+15] = (this.h[7] >>> 8) & 0xff;\n};\n\npoly1305.prototype.update = function(m, mpos, bytes) {\n  var i, want;\n\n  if (this.leftover) {\n    want = (16 - this.leftover);\n    if (want > bytes)\n      want = bytes;\n    for (i = 0; i < want; i++)\n      this.buffer[this.leftover + i] = m[mpos+i];\n    bytes -= want;\n    mpos += want;\n    this.leftover += want;\n    if (this.leftover < 16)\n      return;\n    this.blocks(this.buffer, 0, 16);\n    this.leftover = 0;\n  }\n\n  if (bytes >= 16) {\n    want = bytes - (bytes % 16);\n    this.blocks(m, mpos, want);\n    mpos += want;\n    bytes -= want;\n  }\n\n  if (bytes) {\n    for (i = 0; i < bytes; i++)\n      this.buffer[this.leftover + i] = m[mpos+i];\n    this.leftover += bytes;\n  }\n};\n\nfunction crypto_onetimeauth(out, outpos, m, mpos, n, k) {\n  var s = new poly1305(k);\n  s.update(m, mpos, n);\n  s.finish(out, outpos);\n  return 0;\n}\n\nfunction crypto_onetimeauth_verify(h, hpos, m, mpos, n, k) {\n  var x = new Uint8Array(16);\n  crypto_onetimeauth(x,0,m,mpos,n,k);\n  return crypto_verify_16(h,hpos,x,0);\n}\n\nfunction crypto_secretbox(c,m,d,n,k) {\n  var i;\n  if (d < 32) return -1;\n  crypto_stream_xor(c,0,m,0,d,n,k);\n  crypto_onetimeauth(c, 16, c, 32, d - 32, c);\n  for (i = 0; i < 16; i++) c[i] = 0;\n  return 0;\n}\n\nfunction crypto_secretbox_open(m,c,d,n,k) {\n  var i;\n  var x = new Uint8Array(32);\n  if (d < 32) return -1;\n  crypto_stream(x,0,32,n,k);\n  if (crypto_onetimeauth_verify(c, 16,c, 32,d - 32,x) !== 0) return -1;\n  crypto_stream_xor(m,0,c,0,d,n,k);\n  for (i = 0; i < 32; i++) m[i] = 0;\n  return 0;\n}\n\nfunction set25519(r, a) {\n  var i;\n  for (i = 0; i < 16; i++) r[i] = a[i]|0;\n}\n\nfunction car25519(o) {\n  var i, v, c = 1;\n  for (i = 0; i < 16; i++) {\n    v = o[i] + c + 65535;\n    c = Math.floor(v / 65536);\n    o[i] = v - c * 65536;\n  }\n  o[0] += c-1 + 37 * (c-1);\n}\n\nfunction sel25519(p, q, b) {\n  var t, c = ~(b-1);\n  for (var i = 0; i < 16; i++) {\n    t = c & (p[i] ^ q[i]);\n    p[i] ^= t;\n    q[i] ^= t;\n  }\n}\n\nfunction pack25519(o, n) {\n  var i, j, b;\n  var m = gf(), t = gf();\n  for (i = 0; i < 16; i++) t[i] = n[i];\n  car25519(t);\n  car25519(t);\n  car25519(t);\n  for (j = 0; j < 2; j++) {\n    m[0] = t[0] - 0xffed;\n    for (i = 1; i < 15; i++) {\n      m[i] = t[i] - 0xffff - ((m[i-1]>>16) & 1);\n      m[i-1] &= 0xffff;\n    }\n    m[15] = t[15] - 0x7fff - ((m[14]>>16) & 1);\n    b = (m[15]>>16) & 1;\n    m[14] &= 0xffff;\n    sel25519(t, m, 1-b);\n  }\n  for (i = 0; i < 16; i++) {\n    o[2*i] = t[i] & 0xff;\n    o[2*i+1] = t[i]>>8;\n  }\n}\n\nfunction neq25519(a, b) {\n  var c = new Uint8Array(32), d = new Uint8Array(32);\n  pack25519(c, a);\n  pack25519(d, b);\n  return crypto_verify_32(c, 0, d, 0);\n}\n\nfunction par25519(a) {\n  var d = new Uint8Array(32);\n  pack25519(d, a);\n  return d[0] & 1;\n}\n\nfunction unpack25519(o, n) {\n  var i;\n  for (i = 0; i < 16; i++) o[i] = n[2*i] + (n[2*i+1] << 8);\n  o[15] &= 0x7fff;\n}\n\nfunction A(o, a, b) {\n  for (var i = 0; i < 16; i++) o[i] = a[i] + b[i];\n}\n\nfunction Z(o, a, b) {\n  for (var i = 0; i < 16; i++) o[i] = a[i] - b[i];\n}\n\nfunction M(o, a, b) {\n  var v, c,\n     t0 = 0,  t1 = 0,  t2 = 0,  t3 = 0,  t4 = 0,  t5 = 0,  t6 = 0,  t7 = 0,\n     t8 = 0,  t9 = 0, t10 = 0, t11 = 0, t12 = 0, t13 = 0, t14 = 0, t15 = 0,\n    t16 = 0, t17 = 0, t18 = 0, t19 = 0, t20 = 0, t21 = 0, t22 = 0, t23 = 0,\n    t24 = 0, t25 = 0, t26 = 0, t27 = 0, t28 = 0, t29 = 0, t30 = 0,\n    b0 = b[0],\n    b1 = b[1],\n    b2 = b[2],\n    b3 = b[3],\n    b4 = b[4],\n    b5 = b[5],\n    b6 = b[6],\n    b7 = b[7],\n    b8 = b[8],\n    b9 = b[9],\n    b10 = b[10],\n    b11 = b[11],\n    b12 = b[12],\n    b13 = b[13],\n    b14 = b[14],\n    b15 = b[15];\n\n  v = a[0];\n  t0 += v * b0;\n  t1 += v * b1;\n  t2 += v * b2;\n  t3 += v * b3;\n  t4 += v * b4;\n  t5 += v * b5;\n  t6 += v * b6;\n  t7 += v * b7;\n  t8 += v * b8;\n  t9 += v * b9;\n  t10 += v * b10;\n  t11 += v * b11;\n  t12 += v * b12;\n  t13 += v * b13;\n  t14 += v * b14;\n  t15 += v * b15;\n  v = a[1];\n  t1 += v * b0;\n  t2 += v * b1;\n  t3 += v * b2;\n  t4 += v * b3;\n  t5 += v * b4;\n  t6 += v * b5;\n  t7 += v * b6;\n  t8 += v * b7;\n  t9 += v * b8;\n  t10 += v * b9;\n  t11 += v * b10;\n  t12 += v * b11;\n  t13 += v * b12;\n  t14 += v * b13;\n  t15 += v * b14;\n  t16 += v * b15;\n  v = a[2];\n  t2 += v * b0;\n  t3 += v * b1;\n  t4 += v * b2;\n  t5 += v * b3;\n  t6 += v * b4;\n  t7 += v * b5;\n  t8 += v * b6;\n  t9 += v * b7;\n  t10 += v * b8;\n  t11 += v * b9;\n  t12 += v * b10;\n  t13 += v * b11;\n  t14 += v * b12;\n  t15 += v * b13;\n  t16 += v * b14;\n  t17 += v * b15;\n  v = a[3];\n  t3 += v * b0;\n  t4 += v * b1;\n  t5 += v * b2;\n  t6 += v * b3;\n  t7 += v * b4;\n  t8 += v * b5;\n  t9 += v * b6;\n  t10 += v * b7;\n  t11 += v * b8;\n  t12 += v * b9;\n  t13 += v * b10;\n  t14 += v * b11;\n  t15 += v * b12;\n  t16 += v * b13;\n  t17 += v * b14;\n  t18 += v * b15;\n  v = a[4];\n  t4 += v * b0;\n  t5 += v * b1;\n  t6 += v * b2;\n  t7 += v * b3;\n  t8 += v * b4;\n  t9 += v * b5;\n  t10 += v * b6;\n  t11 += v * b7;\n  t12 += v * b8;\n  t13 += v * b9;\n  t14 += v * b10;\n  t15 += v * b11;\n  t16 += v * b12;\n  t17 += v * b13;\n  t18 += v * b14;\n  t19 += v * b15;\n  v = a[5];\n  t5 += v * b0;\n  t6 += v * b1;\n  t7 += v * b2;\n  t8 += v * b3;\n  t9 += v * b4;\n  t10 += v * b5;\n  t11 += v * b6;\n  t12 += v * b7;\n  t13 += v * b8;\n  t14 += v * b9;\n  t15 += v * b10;\n  t16 += v * b11;\n  t17 += v * b12;\n  t18 += v * b13;\n  t19 += v * b14;\n  t20 += v * b15;\n  v = a[6];\n  t6 += v * b0;\n  t7 += v * b1;\n  t8 += v * b2;\n  t9 += v * b3;\n  t10 += v * b4;\n  t11 += v * b5;\n  t12 += v * b6;\n  t13 += v * b7;\n  t14 += v * b8;\n  t15 += v * b9;\n  t16 += v * b10;\n  t17 += v * b11;\n  t18 += v * b12;\n  t19 += v * b13;\n  t20 += v * b14;\n  t21 += v * b15;\n  v = a[7];\n  t7 += v * b0;\n  t8 += v * b1;\n  t9 += v * b2;\n  t10 += v * b3;\n  t11 += v * b4;\n  t12 += v * b5;\n  t13 += v * b6;\n  t14 += v * b7;\n  t15 += v * b8;\n  t16 += v * b9;\n  t17 += v * b10;\n  t18 += v * b11;\n  t19 += v * b12;\n  t20 += v * b13;\n  t21 += v * b14;\n  t22 += v * b15;\n  v = a[8];\n  t8 += v * b0;\n  t9 += v * b1;\n  t10 += v * b2;\n  t11 += v * b3;\n  t12 += v * b4;\n  t13 += v * b5;\n  t14 += v * b6;\n  t15 += v * b7;\n  t16 += v * b8;\n  t17 += v * b9;\n  t18 += v * b10;\n  t19 += v * b11;\n  t20 += v * b12;\n  t21 += v * b13;\n  t22 += v * b14;\n  t23 += v * b15;\n  v = a[9];\n  t9 += v * b0;\n  t10 += v * b1;\n  t11 += v * b2;\n  t12 += v * b3;\n  t13 += v * b4;\n  t14 += v * b5;\n  t15 += v * b6;\n  t16 += v * b7;\n  t17 += v * b8;\n  t18 += v * b9;\n  t19 += v * b10;\n  t20 += v * b11;\n  t21 += v * b12;\n  t22 += v * b13;\n  t23 += v * b14;\n  t24 += v * b15;\n  v = a[10];\n  t10 += v * b0;\n  t11 += v * b1;\n  t12 += v * b2;\n  t13 += v * b3;\n  t14 += v * b4;\n  t15 += v * b5;\n  t16 += v * b6;\n  t17 += v * b7;\n  t18 += v * b8;\n  t19 += v * b9;\n  t20 += v * b10;\n  t21 += v * b11;\n  t22 += v * b12;\n  t23 += v * b13;\n  t24 += v * b14;\n  t25 += v * b15;\n  v = a[11];\n  t11 += v * b0;\n  t12 += v * b1;\n  t13 += v * b2;\n  t14 += v * b3;\n  t15 += v * b4;\n  t16 += v * b5;\n  t17 += v * b6;\n  t18 += v * b7;\n  t19 += v * b8;\n  t20 += v * b9;\n  t21 += v * b10;\n  t22 += v * b11;\n  t23 += v * b12;\n  t24 += v * b13;\n  t25 += v * b14;\n  t26 += v * b15;\n  v = a[12];\n  t12 += v * b0;\n  t13 += v * b1;\n  t14 += v * b2;\n  t15 += v * b3;\n  t16 += v * b4;\n  t17 += v * b5;\n  t18 += v * b6;\n  t19 += v * b7;\n  t20 += v * b8;\n  t21 += v * b9;\n  t22 += v * b10;\n  t23 += v * b11;\n  t24 += v * b12;\n  t25 += v * b13;\n  t26 += v * b14;\n  t27 += v * b15;\n  v = a[13];\n  t13 += v * b0;\n  t14 += v * b1;\n  t15 += v * b2;\n  t16 += v * b3;\n  t17 += v * b4;\n  t18 += v * b5;\n  t19 += v * b6;\n  t20 += v * b7;\n  t21 += v * b8;\n  t22 += v * b9;\n  t23 += v * b10;\n  t24 += v * b11;\n  t25 += v * b12;\n  t26 += v * b13;\n  t27 += v * b14;\n  t28 += v * b15;\n  v = a[14];\n  t14 += v * b0;\n  t15 += v * b1;\n  t16 += v * b2;\n  t17 += v * b3;\n  t18 += v * b4;\n  t19 += v * b5;\n  t20 += v * b6;\n  t21 += v * b7;\n  t22 += v * b8;\n  t23 += v * b9;\n  t24 += v * b10;\n  t25 += v * b11;\n  t26 += v * b12;\n  t27 += v * b13;\n  t28 += v * b14;\n  t29 += v * b15;\n  v = a[15];\n  t15 += v * b0;\n  t16 += v * b1;\n  t17 += v * b2;\n  t18 += v * b3;\n  t19 += v * b4;\n  t20 += v * b5;\n  t21 += v * b6;\n  t22 += v * b7;\n  t23 += v * b8;\n  t24 += v * b9;\n  t25 += v * b10;\n  t26 += v * b11;\n  t27 += v * b12;\n  t28 += v * b13;\n  t29 += v * b14;\n  t30 += v * b15;\n\n  t0  += 38 * t16;\n  t1  += 38 * t17;\n  t2  += 38 * t18;\n  t3  += 38 * t19;\n  t4  += 38 * t20;\n  t5  += 38 * t21;\n  t6  += 38 * t22;\n  t7  += 38 * t23;\n  t8  += 38 * t24;\n  t9  += 38 * t25;\n  t10 += 38 * t26;\n  t11 += 38 * t27;\n  t12 += 38 * t28;\n  t13 += 38 * t29;\n  t14 += 38 * t30;\n  // t15 left as is\n\n  // first car\n  c = 1;\n  v =  t0 + c + 65535; c = Math.floor(v / 65536);  t0 = v - c * 65536;\n  v =  t1 + c + 65535; c = Math.floor(v / 65536);  t1 = v - c * 65536;\n  v =  t2 + c + 65535; c = Math.floor(v / 65536);  t2 = v - c * 65536;\n  v =  t3 + c + 65535; c = Math.floor(v / 65536);  t3 = v - c * 65536;\n  v =  t4 + c + 65535; c = Math.floor(v / 65536);  t4 = v - c * 65536;\n  v =  t5 + c + 65535; c = Math.floor(v / 65536);  t5 = v - c * 65536;\n  v =  t6 + c + 65535; c = Math.floor(v / 65536);  t6 = v - c * 65536;\n  v =  t7 + c + 65535; c = Math.floor(v / 65536);  t7 = v - c * 65536;\n  v =  t8 + c + 65535; c = Math.floor(v / 65536);  t8 = v - c * 65536;\n  v =  t9 + c + 65535; c = Math.floor(v / 65536);  t9 = v - c * 65536;\n  v = t10 + c + 65535; c = Math.floor(v / 65536); t10 = v - c * 65536;\n  v = t11 + c + 65535; c = Math.floor(v / 65536); t11 = v - c * 65536;\n  v = t12 + c + 65535; c = Math.floor(v / 65536); t12 = v - c * 65536;\n  v = t13 + c + 65535; c = Math.floor(v / 65536); t13 = v - c * 65536;\n  v = t14 + c + 65535; c = Math.floor(v / 65536); t14 = v - c * 65536;\n  v = t15 + c + 65535; c = Math.floor(v / 65536); t15 = v - c * 65536;\n  t0 += c-1 + 37 * (c-1);\n\n  // second car\n  c = 1;\n  v =  t0 + c + 65535; c = Math.floor(v / 65536);  t0 = v - c * 65536;\n  v =  t1 + c + 65535; c = Math.floor(v / 65536);  t1 = v - c * 65536;\n  v =  t2 + c + 65535; c = Math.floor(v / 65536);  t2 = v - c * 65536;\n  v =  t3 + c + 65535; c = Math.floor(v / 65536);  t3 = v - c * 65536;\n  v =  t4 + c + 65535; c = Math.floor(v / 65536);  t4 = v - c * 65536;\n  v =  t5 + c + 65535; c = Math.floor(v / 65536);  t5 = v - c * 65536;\n  v =  t6 + c + 65535; c = Math.floor(v / 65536);  t6 = v - c * 65536;\n  v =  t7 + c + 65535; c = Math.floor(v / 65536);  t7 = v - c * 65536;\n  v =  t8 + c + 65535; c = Math.floor(v / 65536);  t8 = v - c * 65536;\n  v =  t9 + c + 65535; c = Math.floor(v / 65536);  t9 = v - c * 65536;\n  v = t10 + c + 65535; c = Math.floor(v / 65536); t10 = v - c * 65536;\n  v = t11 + c + 65535; c = Math.floor(v / 65536); t11 = v - c * 65536;\n  v = t12 + c + 65535; c = Math.floor(v / 65536); t12 = v - c * 65536;\n  v = t13 + c + 65535; c = Math.floor(v / 65536); t13 = v - c * 65536;\n  v = t14 + c + 65535; c = Math.floor(v / 65536); t14 = v - c * 65536;\n  v = t15 + c + 65535; c = Math.floor(v / 65536); t15 = v - c * 65536;\n  t0 += c-1 + 37 * (c-1);\n\n  o[ 0] = t0;\n  o[ 1] = t1;\n  o[ 2] = t2;\n  o[ 3] = t3;\n  o[ 4] = t4;\n  o[ 5] = t5;\n  o[ 6] = t6;\n  o[ 7] = t7;\n  o[ 8] = t8;\n  o[ 9] = t9;\n  o[10] = t10;\n  o[11] = t11;\n  o[12] = t12;\n  o[13] = t13;\n  o[14] = t14;\n  o[15] = t15;\n}\n\nfunction S(o, a) {\n  M(o, a, a);\n}\n\nfunction inv25519(o, i) {\n  var c = gf();\n  var a;\n  for (a = 0; a < 16; a++) c[a] = i[a];\n  for (a = 253; a >= 0; a--) {\n    S(c, c);\n    if(a !== 2 && a !== 4) M(c, c, i);\n  }\n  for (a = 0; a < 16; a++) o[a] = c[a];\n}\n\nfunction pow2523(o, i) {\n  var c = gf();\n  var a;\n  for (a = 0; a < 16; a++) c[a] = i[a];\n  for (a = 250; a >= 0; a--) {\n      S(c, c);\n      if(a !== 1) M(c, c, i);\n  }\n  for (a = 0; a < 16; a++) o[a] = c[a];\n}\n\nfunction crypto_scalarmult(q, n, p) {\n  var z = new Uint8Array(32);\n  var x = new Float64Array(80), r, i;\n  var a = gf(), b = gf(), c = gf(),\n      d = gf(), e = gf(), f = gf();\n  for (i = 0; i < 31; i++) z[i] = n[i];\n  z[31]=(n[31]&127)|64;\n  z[0]&=248;\n  unpack25519(x,p);\n  for (i = 0; i < 16; i++) {\n    b[i]=x[i];\n    d[i]=a[i]=c[i]=0;\n  }\n  a[0]=d[0]=1;\n  for (i=254; i>=0; --i) {\n    r=(z[i>>>3]>>>(i&7))&1;\n    sel25519(a,b,r);\n    sel25519(c,d,r);\n    A(e,a,c);\n    Z(a,a,c);\n    A(c,b,d);\n    Z(b,b,d);\n    S(d,e);\n    S(f,a);\n    M(a,c,a);\n    M(c,b,e);\n    A(e,a,c);\n    Z(a,a,c);\n    S(b,a);\n    Z(c,d,f);\n    M(a,c,_121665);\n    A(a,a,d);\n    M(c,c,a);\n    M(a,d,f);\n    M(d,b,x);\n    S(b,e);\n    sel25519(a,b,r);\n    sel25519(c,d,r);\n  }\n  for (i = 0; i < 16; i++) {\n    x[i+16]=a[i];\n    x[i+32]=c[i];\n    x[i+48]=b[i];\n    x[i+64]=d[i];\n  }\n  var x32 = x.subarray(32);\n  var x16 = x.subarray(16);\n  inv25519(x32,x32);\n  M(x16,x16,x32);\n  pack25519(q,x16);\n  return 0;\n}\n\nfunction crypto_scalarmult_base(q, n) {\n  return crypto_scalarmult(q, n, _9);\n}\n\nfunction crypto_box_keypair(y, x) {\n  randombytes(x, 32);\n  return crypto_scalarmult_base(y, x);\n}\n\nfunction crypto_box_beforenm(k, y, x) {\n  var s = new Uint8Array(32);\n  crypto_scalarmult(s, x, y);\n  return crypto_core_hsalsa20(k, _0, s, sigma);\n}\n\nvar crypto_box_afternm = crypto_secretbox;\nvar crypto_box_open_afternm = crypto_secretbox_open;\n\nfunction crypto_box(c, m, d, n, y, x) {\n  var k = new Uint8Array(32);\n  crypto_box_beforenm(k, y, x);\n  return crypto_box_afternm(c, m, d, n, k);\n}\n\nfunction crypto_box_open(m, c, d, n, y, x) {\n  var k = new Uint8Array(32);\n  crypto_box_beforenm(k, y, x);\n  return crypto_box_open_afternm(m, c, d, n, k);\n}\n\nvar K = [\n  0x428a2f98, 0xd728ae22, 0x71374491, 0x23ef65cd,\n  0xb5c0fbcf, 0xec4d3b2f, 0xe9b5dba5, 0x8189dbbc,\n  0x3956c25b, 0xf348b538, 0x59f111f1, 0xb605d019,\n  0x923f82a4, 0xaf194f9b, 0xab1c5ed5, 0xda6d8118,\n  0xd807aa98, 0xa3030242, 0x12835b01, 0x45706fbe,\n  0x243185be, 0x4ee4b28c, 0x550c7dc3, 0xd5ffb4e2,\n  0x72be5d74, 0xf27b896f, 0x80deb1fe, 0x3b1696b1,\n  0x9bdc06a7, 0x25c71235, 0xc19bf174, 0xcf692694,\n  0xe49b69c1, 0x9ef14ad2, 0xefbe4786, 0x384f25e3,\n  0x0fc19dc6, 0x8b8cd5b5, 0x240ca1cc, 0x77ac9c65,\n  0x2de92c6f, 0x592b0275, 0x4a7484aa, 0x6ea6e483,\n  0x5cb0a9dc, 0xbd41fbd4, 0x76f988da, 0x831153b5,\n  0x983e5152, 0xee66dfab, 0xa831c66d, 0x2db43210,\n  0xb00327c8, 0x98fb213f, 0xbf597fc7, 0xbeef0ee4,\n  0xc6e00bf3, 0x3da88fc2, 0xd5a79147, 0x930aa725,\n  0x06ca6351, 0xe003826f, 0x14292967, 0x0a0e6e70,\n  0x27b70a85, 0x46d22ffc, 0x2e1b2138, 0x5c26c926,\n  0x4d2c6dfc, 0x5ac42aed, 0x53380d13, 0x9d95b3df,\n  0x650a7354, 0x8baf63de, 0x766a0abb, 0x3c77b2a8,\n  0x81c2c92e, 0x47edaee6, 0x92722c85, 0x1482353b,\n  0xa2bfe8a1, 0x4cf10364, 0xa81a664b, 0xbc423001,\n  0xc24b8b70, 0xd0f89791, 0xc76c51a3, 0x0654be30,\n  0xd192e819, 0xd6ef5218, 0xd6990624, 0x5565a910,\n  0xf40e3585, 0x5771202a, 0x106aa070, 0x32bbd1b8,\n  0x19a4c116, 0xb8d2d0c8, 0x1e376c08, 0x5141ab53,\n  0x2748774c, 0xdf8eeb99, 0x34b0bcb5, 0xe19b48a8,\n  0x391c0cb3, 0xc5c95a63, 0x4ed8aa4a, 0xe3418acb,\n  0x5b9cca4f, 0x7763e373, 0x682e6ff3, 0xd6b2b8a3,\n  0x748f82ee, 0x5defb2fc, 0x78a5636f, 0x43172f60,\n  0x84c87814, 0xa1f0ab72, 0x8cc70208, 0x1a6439ec,\n  0x90befffa, 0x23631e28, 0xa4506ceb, 0xde82bde9,\n  0xbef9a3f7, 0xb2c67915, 0xc67178f2, 0xe372532b,\n  0xca273ece, 0xea26619c, 0xd186b8c7, 0x21c0c207,\n  0xeada7dd6, 0xcde0eb1e, 0xf57d4f7f, 0xee6ed178,\n  0x06f067aa, 0x72176fba, 0x0a637dc5, 0xa2c898a6,\n  0x113f9804, 0xbef90dae, 0x1b710b35, 0x131c471b,\n  0x28db77f5, 0x23047d84, 0x32caab7b, 0x40c72493,\n  0x3c9ebe0a, 0x15c9bebc, 0x431d67c4, 0x9c100d4c,\n  0x4cc5d4be, 0xcb3e42b6, 0x597f299c, 0xfc657e2a,\n  0x5fcb6fab, 0x3ad6faec, 0x6c44198c, 0x4a475817\n];\n\nfunction crypto_hashblocks_hl(hh, hl, m, n) {\n  var wh = new Int32Array(16), wl = new Int32Array(16),\n      bh0, bh1, bh2, bh3, bh4, bh5, bh6, bh7,\n      bl0, bl1, bl2, bl3, bl4, bl5, bl6, bl7,\n      th, tl, i, j, h, l, a, b, c, d;\n\n  var ah0 = hh[0],\n      ah1 = hh[1],\n      ah2 = hh[2],\n      ah3 = hh[3],\n      ah4 = hh[4],\n      ah5 = hh[5],\n      ah6 = hh[6],\n      ah7 = hh[7],\n\n      al0 = hl[0],\n      al1 = hl[1],\n      al2 = hl[2],\n      al3 = hl[3],\n      al4 = hl[4],\n      al5 = hl[5],\n      al6 = hl[6],\n      al7 = hl[7];\n\n  var pos = 0;\n  while (n >= 128) {\n    for (i = 0; i < 16; i++) {\n      j = 8 * i + pos;\n      wh[i] = (m[j+0] << 24) | (m[j+1] << 16) | (m[j+2] << 8) | m[j+3];\n      wl[i] = (m[j+4] << 24) | (m[j+5] << 16) | (m[j+6] << 8) | m[j+7];\n    }\n    for (i = 0; i < 80; i++) {\n      bh0 = ah0;\n      bh1 = ah1;\n      bh2 = ah2;\n      bh3 = ah3;\n      bh4 = ah4;\n      bh5 = ah5;\n      bh6 = ah6;\n      bh7 = ah7;\n\n      bl0 = al0;\n      bl1 = al1;\n      bl2 = al2;\n      bl3 = al3;\n      bl4 = al4;\n      bl5 = al5;\n      bl6 = al6;\n      bl7 = al7;\n\n      // add\n      h = ah7;\n      l = al7;\n\n      a = l & 0xffff; b = l >>> 16;\n      c = h & 0xffff; d = h >>> 16;\n\n      // Sigma1\n      h = ((ah4 >>> 14) | (al4 << (32-14))) ^ ((ah4 >>> 18) | (al4 << (32-18))) ^ ((al4 >>> (41-32)) | (ah4 << (32-(41-32))));\n      l = ((al4 >>> 14) | (ah4 << (32-14))) ^ ((al4 >>> 18) | (ah4 << (32-18))) ^ ((ah4 >>> (41-32)) | (al4 << (32-(41-32))));\n\n      a += l & 0xffff; b += l >>> 16;\n      c += h & 0xffff; d += h >>> 16;\n\n      // Ch\n      h = (ah4 & ah5) ^ (~ah4 & ah6);\n      l = (al4 & al5) ^ (~al4 & al6);\n\n      a += l & 0xffff; b += l >>> 16;\n      c += h & 0xffff; d += h >>> 16;\n\n      // K\n      h = K[i*2];\n      l = K[i*2+1];\n\n      a += l & 0xffff; b += l >>> 16;\n      c += h & 0xffff; d += h >>> 16;\n\n      // w\n      h = wh[i%16];\n      l = wl[i%16];\n\n      a += l & 0xffff; b += l >>> 16;\n      c += h & 0xffff; d += h >>> 16;\n\n      b += a >>> 16;\n      c += b >>> 16;\n      d += c >>> 16;\n\n      th = c & 0xffff | d << 16;\n      tl = a & 0xffff | b << 16;\n\n      // add\n      h = th;\n      l = tl;\n\n      a = l & 0xffff; b = l >>> 16;\n      c = h & 0xffff; d = h >>> 16;\n\n      // Sigma0\n      h = ((ah0 >>> 28) | (al0 << (32-28))) ^ ((al0 >>> (34-32)) | (ah0 << (32-(34-32)))) ^ ((al0 >>> (39-32)) | (ah0 << (32-(39-32))));\n      l = ((al0 >>> 28) | (ah0 << (32-28))) ^ ((ah0 >>> (34-32)) | (al0 << (32-(34-32)))) ^ ((ah0 >>> (39-32)) | (al0 << (32-(39-32))));\n\n      a += l & 0xffff; b += l >>> 16;\n      c += h & 0xffff; d += h >>> 16;\n\n      // Maj\n      h = (ah0 & ah1) ^ (ah0 & ah2) ^ (ah1 & ah2);\n      l = (al0 & al1) ^ (al0 & al2) ^ (al1 & al2);\n\n      a += l & 0xffff; b += l >>> 16;\n      c += h & 0xffff; d += h >>> 16;\n\n      b += a >>> 16;\n      c += b >>> 16;\n      d += c >>> 16;\n\n      bh7 = (c & 0xffff) | (d << 16);\n      bl7 = (a & 0xffff) | (b << 16);\n\n      // add\n      h = bh3;\n      l = bl3;\n\n      a = l & 0xffff; b = l >>> 16;\n      c = h & 0xffff; d = h >>> 16;\n\n      h = th;\n      l = tl;\n\n      a += l & 0xffff; b += l >>> 16;\n      c += h & 0xffff; d += h >>> 16;\n\n      b += a >>> 16;\n      c += b >>> 16;\n      d += c >>> 16;\n\n      bh3 = (c & 0xffff) | (d << 16);\n      bl3 = (a & 0xffff) | (b << 16);\n\n      ah1 = bh0;\n      ah2 = bh1;\n      ah3 = bh2;\n      ah4 = bh3;\n      ah5 = bh4;\n      ah6 = bh5;\n      ah7 = bh6;\n      ah0 = bh7;\n\n      al1 = bl0;\n      al2 = bl1;\n      al3 = bl2;\n      al4 = bl3;\n      al5 = bl4;\n      al6 = bl5;\n      al7 = bl6;\n      al0 = bl7;\n\n      if (i%16 === 15) {\n        for (j = 0; j < 16; j++) {\n          // add\n          h = wh[j];\n          l = wl[j];\n\n          a = l & 0xffff; b = l >>> 16;\n          c = h & 0xffff; d = h >>> 16;\n\n          h = wh[(j+9)%16];\n          l = wl[(j+9)%16];\n\n          a += l & 0xffff; b += l >>> 16;\n          c += h & 0xffff; d += h >>> 16;\n\n          // sigma0\n          th = wh[(j+1)%16];\n          tl = wl[(j+1)%16];\n          h = ((th >>> 1) | (tl << (32-1))) ^ ((th >>> 8) | (tl << (32-8))) ^ (th >>> 7);\n          l = ((tl >>> 1) | (th << (32-1))) ^ ((tl >>> 8) | (th << (32-8))) ^ ((tl >>> 7) | (th << (32-7)));\n\n          a += l & 0xffff; b += l >>> 16;\n          c += h & 0xffff; d += h >>> 16;\n\n          // sigma1\n          th = wh[(j+14)%16];\n          tl = wl[(j+14)%16];\n          h = ((th >>> 19) | (tl << (32-19))) ^ ((tl >>> (61-32)) | (th << (32-(61-32)))) ^ (th >>> 6);\n          l = ((tl >>> 19) | (th << (32-19))) ^ ((th >>> (61-32)) | (tl << (32-(61-32)))) ^ ((tl >>> 6) | (th << (32-6)));\n\n          a += l & 0xffff; b += l >>> 16;\n          c += h & 0xffff; d += h >>> 16;\n\n          b += a >>> 16;\n          c += b >>> 16;\n          d += c >>> 16;\n\n          wh[j] = (c & 0xffff) | (d << 16);\n          wl[j] = (a & 0xffff) | (b << 16);\n        }\n      }\n    }\n\n    // add\n    h = ah0;\n    l = al0;\n\n    a = l & 0xffff; b = l >>> 16;\n    c = h & 0xffff; d = h >>> 16;\n\n    h = hh[0];\n    l = hl[0];\n\n    a += l & 0xffff; b += l >>> 16;\n    c += h & 0xffff; d += h >>> 16;\n\n    b += a >>> 16;\n    c += b >>> 16;\n    d += c >>> 16;\n\n    hh[0] = ah0 = (c & 0xffff) | (d << 16);\n    hl[0] = al0 = (a & 0xffff) | (b << 16);\n\n    h = ah1;\n    l = al1;\n\n    a = l & 0xffff; b = l >>> 16;\n    c = h & 0xffff; d = h >>> 16;\n\n    h = hh[1];\n    l = hl[1];\n\n    a += l & 0xffff; b += l >>> 16;\n    c += h & 0xffff; d += h >>> 16;\n\n    b += a >>> 16;\n    c += b >>> 16;\n    d += c >>> 16;\n\n    hh[1] = ah1 = (c & 0xffff) | (d << 16);\n    hl[1] = al1 = (a & 0xffff) | (b << 16);\n\n    h = ah2;\n    l = al2;\n\n    a = l & 0xffff; b = l >>> 16;\n    c = h & 0xffff; d = h >>> 16;\n\n    h = hh[2];\n    l = hl[2];\n\n    a += l & 0xffff; b += l >>> 16;\n    c += h & 0xffff; d += h >>> 16;\n\n    b += a >>> 16;\n    c += b >>> 16;\n    d += c >>> 16;\n\n    hh[2] = ah2 = (c & 0xffff) | (d << 16);\n    hl[2] = al2 = (a & 0xffff) | (b << 16);\n\n    h = ah3;\n    l = al3;\n\n    a = l & 0xffff; b = l >>> 16;\n    c = h & 0xffff; d = h >>> 16;\n\n    h = hh[3];\n    l = hl[3];\n\n    a += l & 0xffff; b += l >>> 16;\n    c += h & 0xffff; d += h >>> 16;\n\n    b += a >>> 16;\n    c += b >>> 16;\n    d += c >>> 16;\n\n    hh[3] = ah3 = (c & 0xffff) | (d << 16);\n    hl[3] = al3 = (a & 0xffff) | (b << 16);\n\n    h = ah4;\n    l = al4;\n\n    a = l & 0xffff; b = l >>> 16;\n    c = h & 0xffff; d = h >>> 16;\n\n    h = hh[4];\n    l = hl[4];\n\n    a += l & 0xffff; b += l >>> 16;\n    c += h & 0xffff; d += h >>> 16;\n\n    b += a >>> 16;\n    c += b >>> 16;\n    d += c >>> 16;\n\n    hh[4] = ah4 = (c & 0xffff) | (d << 16);\n    hl[4] = al4 = (a & 0xffff) | (b << 16);\n\n    h = ah5;\n    l = al5;\n\n    a = l & 0xffff; b = l >>> 16;\n    c = h & 0xffff; d = h >>> 16;\n\n    h = hh[5];\n    l = hl[5];\n\n    a += l & 0xffff; b += l >>> 16;\n    c += h & 0xffff; d += h >>> 16;\n\n    b += a >>> 16;\n    c += b >>> 16;\n    d += c >>> 16;\n\n    hh[5] = ah5 = (c & 0xffff) | (d << 16);\n    hl[5] = al5 = (a & 0xffff) | (b << 16);\n\n    h = ah6;\n    l = al6;\n\n    a = l & 0xffff; b = l >>> 16;\n    c = h & 0xffff; d = h >>> 16;\n\n    h = hh[6];\n    l = hl[6];\n\n    a += l & 0xffff; b += l >>> 16;\n    c += h & 0xffff; d += h >>> 16;\n\n    b += a >>> 16;\n    c += b >>> 16;\n    d += c >>> 16;\n\n    hh[6] = ah6 = (c & 0xffff) | (d << 16);\n    hl[6] = al6 = (a & 0xffff) | (b << 16);\n\n    h = ah7;\n    l = al7;\n\n    a = l & 0xffff; b = l >>> 16;\n    c = h & 0xffff; d = h >>> 16;\n\n    h = hh[7];\n    l = hl[7];\n\n    a += l & 0xffff; b += l >>> 16;\n    c += h & 0xffff; d += h >>> 16;\n\n    b += a >>> 16;\n    c += b >>> 16;\n    d += c >>> 16;\n\n    hh[7] = ah7 = (c & 0xffff) | (d << 16);\n    hl[7] = al7 = (a & 0xffff) | (b << 16);\n\n    pos += 128;\n    n -= 128;\n  }\n\n  return n;\n}\n\nfunction crypto_hash(out, m, n) {\n  var hh = new Int32Array(8),\n      hl = new Int32Array(8),\n      x = new Uint8Array(256),\n      i, b = n;\n\n  hh[0] = 0x6a09e667;\n  hh[1] = 0xbb67ae85;\n  hh[2] = 0x3c6ef372;\n  hh[3] = 0xa54ff53a;\n  hh[4] = 0x510e527f;\n  hh[5] = 0x9b05688c;\n  hh[6] = 0x1f83d9ab;\n  hh[7] = 0x5be0cd19;\n\n  hl[0] = 0xf3bcc908;\n  hl[1] = 0x84caa73b;\n  hl[2] = 0xfe94f82b;\n  hl[3] = 0x5f1d36f1;\n  hl[4] = 0xade682d1;\n  hl[5] = 0x2b3e6c1f;\n  hl[6] = 0xfb41bd6b;\n  hl[7] = 0x137e2179;\n\n  crypto_hashblocks_hl(hh, hl, m, n);\n  n %= 128;\n\n  for (i = 0; i < n; i++) x[i] = m[b-n+i];\n  x[n] = 128;\n\n  n = 256-128*(n<112?1:0);\n  x[n-9] = 0;\n  ts64(x, n-8,  (b / 0x20000000) | 0, b << 3);\n  crypto_hashblocks_hl(hh, hl, x, n);\n\n  for (i = 0; i < 8; i++) ts64(out, 8*i, hh[i], hl[i]);\n\n  return 0;\n}\n\nfunction add(p, q) {\n  var a = gf(), b = gf(), c = gf(),\n      d = gf(), e = gf(), f = gf(),\n      g = gf(), h = gf(), t = gf();\n\n  Z(a, p[1], p[0]);\n  Z(t, q[1], q[0]);\n  M(a, a, t);\n  A(b, p[0], p[1]);\n  A(t, q[0], q[1]);\n  M(b, b, t);\n  M(c, p[3], q[3]);\n  M(c, c, D2);\n  M(d, p[2], q[2]);\n  A(d, d, d);\n  Z(e, b, a);\n  Z(f, d, c);\n  A(g, d, c);\n  A(h, b, a);\n\n  M(p[0], e, f);\n  M(p[1], h, g);\n  M(p[2], g, f);\n  M(p[3], e, h);\n}\n\nfunction cswap(p, q, b) {\n  var i;\n  for (i = 0; i < 4; i++) {\n    sel25519(p[i], q[i], b);\n  }\n}\n\nfunction pack(r, p) {\n  var tx = gf(), ty = gf(), zi = gf();\n  inv25519(zi, p[2]);\n  M(tx, p[0], zi);\n  M(ty, p[1], zi);\n  pack25519(r, ty);\n  r[31] ^= par25519(tx) << 7;\n}\n\nfunction scalarmult(p, q, s) {\n  var b, i;\n  set25519(p[0], gf0);\n  set25519(p[1], gf1);\n  set25519(p[2], gf1);\n  set25519(p[3], gf0);\n  for (i = 255; i >= 0; --i) {\n    b = (s[(i/8)|0] >> (i&7)) & 1;\n    cswap(p, q, b);\n    add(q, p);\n    add(p, p);\n    cswap(p, q, b);\n  }\n}\n\nfunction scalarbase(p, s) {\n  var q = [gf(), gf(), gf(), gf()];\n  set25519(q[0], X);\n  set25519(q[1], Y);\n  set25519(q[2], gf1);\n  M(q[3], X, Y);\n  scalarmult(p, q, s);\n}\n\nfunction crypto_sign_keypair(pk, sk, seeded) {\n  var d = new Uint8Array(64);\n  var p = [gf(), gf(), gf(), gf()];\n  var i;\n\n  if (!seeded) randombytes(sk, 32);\n  crypto_hash(d, sk, 32);\n  d[0] &= 248;\n  d[31] &= 127;\n  d[31] |= 64;\n\n  scalarbase(p, d);\n  pack(pk, p);\n\n  for (i = 0; i < 32; i++) sk[i+32] = pk[i];\n  return 0;\n}\n\nvar L = new Float64Array([0xed, 0xd3, 0xf5, 0x5c, 0x1a, 0x63, 0x12, 0x58, 0xd6, 0x9c, 0xf7, 0xa2, 0xde, 0xf9, 0xde, 0x14, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0x10]);\n\nfunction modL(r, x) {\n  var carry, i, j, k;\n  for (i = 63; i >= 32; --i) {\n    carry = 0;\n    for (j = i - 32, k = i - 12; j < k; ++j) {\n      x[j] += carry - 16 * x[i] * L[j - (i - 32)];\n      carry = Math.floor((x[j] + 128) / 256);\n      x[j] -= carry * 256;\n    }\n    x[j] += carry;\n    x[i] = 0;\n  }\n  carry = 0;\n  for (j = 0; j < 32; j++) {\n    x[j] += carry - (x[31] >> 4) * L[j];\n    carry = x[j] >> 8;\n    x[j] &= 255;\n  }\n  for (j = 0; j < 32; j++) x[j] -= carry * L[j];\n  for (i = 0; i < 32; i++) {\n    x[i+1] += x[i] >> 8;\n    r[i] = x[i] & 255;\n  }\n}\n\nfunction reduce(r) {\n  var x = new Float64Array(64), i;\n  for (i = 0; i < 64; i++) x[i] = r[i];\n  for (i = 0; i < 64; i++) r[i] = 0;\n  modL(r, x);\n}\n\n// Note: difference from C - smlen returned, not passed as argument.\nfunction crypto_sign(sm, m, n, sk) {\n  var d = new Uint8Array(64), h = new Uint8Array(64), r = new Uint8Array(64);\n  var i, j, x = new Float64Array(64);\n  var p = [gf(), gf(), gf(), gf()];\n\n  crypto_hash(d, sk, 32);\n  d[0] &= 248;\n  d[31] &= 127;\n  d[31] |= 64;\n\n  var smlen = n + 64;\n  for (i = 0; i < n; i++) sm[64 + i] = m[i];\n  for (i = 0; i < 32; i++) sm[32 + i] = d[32 + i];\n\n  crypto_hash(r, sm.subarray(32), n+32);\n  reduce(r);\n  scalarbase(p, r);\n  pack(sm, p);\n\n  for (i = 32; i < 64; i++) sm[i] = sk[i];\n  crypto_hash(h, sm, n + 64);\n  reduce(h);\n\n  for (i = 0; i < 64; i++) x[i] = 0;\n  for (i = 0; i < 32; i++) x[i] = r[i];\n  for (i = 0; i < 32; i++) {\n    for (j = 0; j < 32; j++) {\n      x[i+j] += h[i] * d[j];\n    }\n  }\n\n  modL(sm.subarray(32), x);\n  return smlen;\n}\n\nfunction unpackneg(r, p) {\n  var t = gf(), chk = gf(), num = gf(),\n      den = gf(), den2 = gf(), den4 = gf(),\n      den6 = gf();\n\n  set25519(r[2], gf1);\n  unpack25519(r[1], p);\n  S(num, r[1]);\n  M(den, num, D);\n  Z(num, num, r[2]);\n  A(den, r[2], den);\n\n  S(den2, den);\n  S(den4, den2);\n  M(den6, den4, den2);\n  M(t, den6, num);\n  M(t, t, den);\n\n  pow2523(t, t);\n  M(t, t, num);\n  M(t, t, den);\n  M(t, t, den);\n  M(r[0], t, den);\n\n  S(chk, r[0]);\n  M(chk, chk, den);\n  if (neq25519(chk, num)) M(r[0], r[0], I);\n\n  S(chk, r[0]);\n  M(chk, chk, den);\n  if (neq25519(chk, num)) return -1;\n\n  if (par25519(r[0]) === (p[31]>>7)) Z(r[0], gf0, r[0]);\n\n  M(r[3], r[0], r[1]);\n  return 0;\n}\n\nfunction crypto_sign_open(m, sm, n, pk) {\n  var i;\n  var t = new Uint8Array(32), h = new Uint8Array(64);\n  var p = [gf(), gf(), gf(), gf()],\n      q = [gf(), gf(), gf(), gf()];\n\n  if (n < 64) return -1;\n\n  if (unpackneg(q, pk)) return -1;\n\n  for (i = 0; i < n; i++) m[i] = sm[i];\n  for (i = 0; i < 32; i++) m[i+32] = pk[i];\n  crypto_hash(h, m, n);\n  reduce(h);\n  scalarmult(p, q, h);\n\n  scalarbase(q, sm.subarray(32));\n  add(p, q);\n  pack(t, p);\n\n  n -= 64;\n  if (crypto_verify_32(sm, 0, t, 0)) {\n    for (i = 0; i < n; i++) m[i] = 0;\n    return -1;\n  }\n\n  for (i = 0; i < n; i++) m[i] = sm[i + 64];\n  return n;\n}\n\nvar crypto_secretbox_KEYBYTES = 32,\n    crypto_secretbox_NONCEBYTES = 24,\n    crypto_secretbox_ZEROBYTES = 32,\n    crypto_secretbox_BOXZEROBYTES = 16,\n    crypto_scalarmult_BYTES = 32,\n    crypto_scalarmult_SCALARBYTES = 32,\n    crypto_box_PUBLICKEYBYTES = 32,\n    crypto_box_SECRETKEYBYTES = 32,\n    crypto_box_BEFORENMBYTES = 32,\n    crypto_box_NONCEBYTES = crypto_secretbox_NONCEBYTES,\n    crypto_box_ZEROBYTES = crypto_secretbox_ZEROBYTES,\n    crypto_box_BOXZEROBYTES = crypto_secretbox_BOXZEROBYTES,\n    crypto_sign_BYTES = 64,\n    crypto_sign_PUBLICKEYBYTES = 32,\n    crypto_sign_SECRETKEYBYTES = 64,\n    crypto_sign_SEEDBYTES = 32,\n    crypto_hash_BYTES = 64;\n\nnacl.lowlevel = {\n  crypto_core_hsalsa20: crypto_core_hsalsa20,\n  crypto_stream_xor: crypto_stream_xor,\n  crypto_stream: crypto_stream,\n  crypto_stream_salsa20_xor: crypto_stream_salsa20_xor,\n  crypto_stream_salsa20: crypto_stream_salsa20,\n  crypto_onetimeauth: crypto_onetimeauth,\n  crypto_onetimeauth_verify: crypto_onetimeauth_verify,\n  crypto_verify_16: crypto_verify_16,\n  crypto_verify_32: crypto_verify_32,\n  crypto_secretbox: crypto_secretbox,\n  crypto_secretbox_open: crypto_secretbox_open,\n  crypto_scalarmult: crypto_scalarmult,\n  crypto_scalarmult_base: crypto_scalarmult_base,\n  crypto_box_beforenm: crypto_box_beforenm,\n  crypto_box_afternm: crypto_box_afternm,\n  crypto_box: crypto_box,\n  crypto_box_open: crypto_box_open,\n  crypto_box_keypair: crypto_box_keypair,\n  crypto_hash: crypto_hash,\n  crypto_sign: crypto_sign,\n  crypto_sign_keypair: crypto_sign_keypair,\n  crypto_sign_open: crypto_sign_open,\n\n  crypto_secretbox_KEYBYTES: crypto_secretbox_KEYBYTES,\n  crypto_secretbox_NONCEBYTES: crypto_secretbox_NONCEBYTES,\n  crypto_secretbox_ZEROBYTES: crypto_secretbox_ZEROBYTES,\n  crypto_secretbox_BOXZEROBYTES: crypto_secretbox_BOXZEROBYTES,\n  crypto_scalarmult_BYTES: crypto_scalarmult_BYTES,\n  crypto_scalarmult_SCALARBYTES: crypto_scalarmult_SCALARBYTES,\n  crypto_box_PUBLICKEYBYTES: crypto_box_PUBLICKEYBYTES,\n  crypto_box_SECRETKEYBYTES: crypto_box_SECRETKEYBYTES,\n  crypto_box_BEFORENMBYTES: crypto_box_BEFORENMBYTES,\n  crypto_box_NONCEBYTES: crypto_box_NONCEBYTES,\n  crypto_box_ZEROBYTES: crypto_box_ZEROBYTES,\n  crypto_box_BOXZEROBYTES: crypto_box_BOXZEROBYTES,\n  crypto_sign_BYTES: crypto_sign_BYTES,\n  crypto_sign_PUBLICKEYBYTES: crypto_sign_PUBLICKEYBYTES,\n  crypto_sign_SECRETKEYBYTES: crypto_sign_SECRETKEYBYTES,\n  crypto_sign_SEEDBYTES: crypto_sign_SEEDBYTES,\n  crypto_hash_BYTES: crypto_hash_BYTES,\n\n  gf: gf,\n  D: D,\n  L: L,\n  pack25519: pack25519,\n  unpack25519: unpack25519,\n  M: M,\n  A: A,\n  S: S,\n  Z: Z,\n  pow2523: pow2523,\n  add: add,\n  set25519: set25519,\n  modL: modL,\n  scalarmult: scalarmult,\n  scalarbase: scalarbase,\n};\n\n/* High-level API */\n\nfunction checkLengths(k, n) {\n  if (k.length !== crypto_secretbox_KEYBYTES) throw new Error('bad key size');\n  if (n.length !== crypto_secretbox_NONCEBYTES) throw new Error('bad nonce size');\n}\n\nfunction checkBoxLengths(pk, sk) {\n  if (pk.length !== crypto_box_PUBLICKEYBYTES) throw new Error('bad public key size');\n  if (sk.length !== crypto_box_SECRETKEYBYTES) throw new Error('bad secret key size');\n}\n\nfunction checkArrayTypes() {\n  for (var i = 0; i < arguments.length; i++) {\n    if (!(arguments[i] instanceof Uint8Array))\n      throw new TypeError('unexpected type, use Uint8Array');\n  }\n}\n\nfunction cleanup(arr) {\n  for (var i = 0; i < arr.length; i++) arr[i] = 0;\n}\n\nnacl.randomBytes = function(n) {\n  var b = new Uint8Array(n);\n  randombytes(b, n);\n  return b;\n};\n\nnacl.secretbox = function(msg, nonce, key) {\n  checkArrayTypes(msg, nonce, key);\n  checkLengths(key, nonce);\n  var m = new Uint8Array(crypto_secretbox_ZEROBYTES + msg.length);\n  var c = new Uint8Array(m.length);\n  for (var i = 0; i < msg.length; i++) m[i+crypto_secretbox_ZEROBYTES] = msg[i];\n  crypto_secretbox(c, m, m.length, nonce, key);\n  return c.subarray(crypto_secretbox_BOXZEROBYTES);\n};\n\nnacl.secretbox.open = function(box, nonce, key) {\n  checkArrayTypes(box, nonce, key);\n  checkLengths(key, nonce);\n  var c = new Uint8Array(crypto_secretbox_BOXZEROBYTES + box.length);\n  var m = new Uint8Array(c.length);\n  for (var i = 0; i < box.length; i++) c[i+crypto_secretbox_BOXZEROBYTES] = box[i];\n  if (c.length < 32) return null;\n  if (crypto_secretbox_open(m, c, c.length, nonce, key) !== 0) return null;\n  return m.subarray(crypto_secretbox_ZEROBYTES);\n};\n\nnacl.secretbox.keyLength = crypto_secretbox_KEYBYTES;\nnacl.secretbox.nonceLength = crypto_secretbox_NONCEBYTES;\nnacl.secretbox.overheadLength = crypto_secretbox_BOXZEROBYTES;\n\nnacl.scalarMult = function(n, p) {\n  checkArrayTypes(n, p);\n  if (n.length !== crypto_scalarmult_SCALARBYTES) throw new Error('bad n size');\n  if (p.length !== crypto_scalarmult_BYTES) throw new Error('bad p size');\n  var q = new Uint8Array(crypto_scalarmult_BYTES);\n  crypto_scalarmult(q, n, p);\n  return q;\n};\n\nnacl.scalarMult.base = function(n) {\n  checkArrayTypes(n);\n  if (n.length !== crypto_scalarmult_SCALARBYTES) throw new Error('bad n size');\n  var q = new Uint8Array(crypto_scalarmult_BYTES);\n  crypto_scalarmult_base(q, n);\n  return q;\n};\n\nnacl.scalarMult.scalarLength = crypto_scalarmult_SCALARBYTES;\nnacl.scalarMult.groupElementLength = crypto_scalarmult_BYTES;\n\nnacl.box = function(msg, nonce, publicKey, secretKey) {\n  var k = nacl.box.before(publicKey, secretKey);\n  return nacl.secretbox(msg, nonce, k);\n};\n\nnacl.box.before = function(publicKey, secretKey) {\n  checkArrayTypes(publicKey, secretKey);\n  checkBoxLengths(publicKey, secretKey);\n  var k = new Uint8Array(crypto_box_BEFORENMBYTES);\n  crypto_box_beforenm(k, publicKey, secretKey);\n  return k;\n};\n\nnacl.box.after = nacl.secretbox;\n\nnacl.box.open = function(msg, nonce, publicKey, secretKey) {\n  var k = nacl.box.before(publicKey, secretKey);\n  return nacl.secretbox.open(msg, nonce, k);\n};\n\nnacl.box.open.after = nacl.secretbox.open;\n\nnacl.box.keyPair = function() {\n  var pk = new Uint8Array(crypto_box_PUBLICKEYBYTES);\n  var sk = new Uint8Array(crypto_box_SECRETKEYBYTES);\n  crypto_box_keypair(pk, sk);\n  return {publicKey: pk, secretKey: sk};\n};\n\nnacl.box.keyPair.fromSecretKey = function(secretKey) {\n  checkArrayTypes(secretKey);\n  if (secretKey.length !== crypto_box_SECRETKEYBYTES)\n    throw new Error('bad secret key size');\n  var pk = new Uint8Array(crypto_box_PUBLICKEYBYTES);\n  crypto_scalarmult_base(pk, secretKey);\n  return {publicKey: pk, secretKey: new Uint8Array(secretKey)};\n};\n\nnacl.box.publicKeyLength = crypto_box_PUBLICKEYBYTES;\nnacl.box.secretKeyLength = crypto_box_SECRETKEYBYTES;\nnacl.box.sharedKeyLength = crypto_box_BEFORENMBYTES;\nnacl.box.nonceLength = crypto_box_NONCEBYTES;\nnacl.box.overheadLength = nacl.secretbox.overheadLength;\n\nnacl.sign = function(msg, secretKey) {\n  checkArrayTypes(msg, secretKey);\n  if (secretKey.length !== crypto_sign_SECRETKEYBYTES)\n    throw new Error('bad secret key size');\n  var signedMsg = new Uint8Array(crypto_sign_BYTES+msg.length);\n  crypto_sign(signedMsg, msg, msg.length, secretKey);\n  return signedMsg;\n};\n\nnacl.sign.open = function(signedMsg, publicKey) {\n  checkArrayTypes(signedMsg, publicKey);\n  if (publicKey.length !== crypto_sign_PUBLICKEYBYTES)\n    throw new Error('bad public key size');\n  var tmp = new Uint8Array(signedMsg.length);\n  var mlen = crypto_sign_open(tmp, signedMsg, signedMsg.length, publicKey);\n  if (mlen < 0) return null;\n  var m = new Uint8Array(mlen);\n  for (var i = 0; i < m.length; i++) m[i] = tmp[i];\n  return m;\n};\n\nnacl.sign.detached = function(msg, secretKey) {\n  var signedMsg = nacl.sign(msg, secretKey);\n  var sig = new Uint8Array(crypto_sign_BYTES);\n  for (var i = 0; i < sig.length; i++) sig[i] = signedMsg[i];\n  return sig;\n};\n\nnacl.sign.detached.verify = function(msg, sig, publicKey) {\n  checkArrayTypes(msg, sig, publicKey);\n  if (sig.length !== crypto_sign_BYTES)\n    throw new Error('bad signature size');\n  if (publicKey.length !== crypto_sign_PUBLICKEYBYTES)\n    throw new Error('bad public key size');\n  var sm = new Uint8Array(crypto_sign_BYTES + msg.length);\n  var m = new Uint8Array(crypto_sign_BYTES + msg.length);\n  var i;\n  for (i = 0; i < crypto_sign_BYTES; i++) sm[i] = sig[i];\n  for (i = 0; i < msg.length; i++) sm[i+crypto_sign_BYTES] = msg[i];\n  return (crypto_sign_open(m, sm, sm.length, publicKey) >= 0);\n};\n\nnacl.sign.keyPair = function() {\n  var pk = new Uint8Array(crypto_sign_PUBLICKEYBYTES);\n  var sk = new Uint8Array(crypto_sign_SECRETKEYBYTES);\n  crypto_sign_keypair(pk, sk);\n  return {publicKey: pk, secretKey: sk};\n};\n\nnacl.sign.keyPair.fromSecretKey = function(secretKey) {\n  checkArrayTypes(secretKey);\n  if (secretKey.length !== crypto_sign_SECRETKEYBYTES)\n    throw new Error('bad secret key size');\n  var pk = new Uint8Array(crypto_sign_PUBLICKEYBYTES);\n  for (var i = 0; i < pk.length; i++) pk[i] = secretKey[32+i];\n  return {publicKey: pk, secretKey: new Uint8Array(secretKey)};\n};\n\nnacl.sign.keyPair.fromSeed = function(seed) {\n  checkArrayTypes(seed);\n  if (seed.length !== crypto_sign_SEEDBYTES)\n    throw new Error('bad seed size');\n  var pk = new Uint8Array(crypto_sign_PUBLICKEYBYTES);\n  var sk = new Uint8Array(crypto_sign_SECRETKEYBYTES);\n  for (var i = 0; i < 32; i++) sk[i] = seed[i];\n  crypto_sign_keypair(pk, sk, true);\n  return {publicKey: pk, secretKey: sk};\n};\n\nnacl.sign.publicKeyLength = crypto_sign_PUBLICKEYBYTES;\nnacl.sign.secretKeyLength = crypto_sign_SECRETKEYBYTES;\nnacl.sign.seedLength = crypto_sign_SEEDBYTES;\nnacl.sign.signatureLength = crypto_sign_BYTES;\n\nnacl.hash = function(msg) {\n  checkArrayTypes(msg);\n  var h = new Uint8Array(crypto_hash_BYTES);\n  crypto_hash(h, msg, msg.length);\n  return h;\n};\n\nnacl.hash.hashLength = crypto_hash_BYTES;\n\nnacl.verify = function(x, y) {\n  checkArrayTypes(x, y);\n  // Zero length arguments are considered not equal.\n  if (x.length === 0 || y.length === 0) return false;\n  if (x.length !== y.length) return false;\n  return (vn(x, 0, y, 0, x.length) === 0) ? true : false;\n};\n\nnacl.setPRNG = function(fn) {\n  randombytes = fn;\n};\n\n(function() {\n  // Initialize PRNG if environment provides CSPRNG.\n  // If not, methods calling randombytes will throw.\n  var crypto = typeof self !== 'undefined' ? (self.crypto || self.msCrypto) : null;\n  if (crypto && crypto.getRandomValues) {\n    // Browsers.\n    var QUOTA = 65536;\n    nacl.setPRNG(function(x, n) {\n      var i, v = new Uint8Array(n);\n      for (i = 0; i < n; i += QUOTA) {\n        crypto.getRandomValues(v.subarray(i, i + Math.min(n - i, QUOTA)));\n      }\n      for (i = 0; i < n; i++) x[i] = v[i];\n      cleanup(v);\n    });\n  } else if (typeof require !== 'undefined') {\n    // Node.js.\n    crypto = require('crypto');\n    if (crypto && crypto.randomBytes) {\n      nacl.setPRNG(function(x, n) {\n        var i, v = crypto.randomBytes(n);\n        for (i = 0; i < n; i++) x[i] = v[i];\n        cleanup(v);\n      });\n    }\n  }\n})();\n\n})(typeof module !== 'undefined' && module.exports ? module.exports : (self.nacl = self.nacl || {}));\n", "/**\n * Cell Protocol - Browser Entry Point\n *\n * Exports the Cell Protocol for use in browser environments.\n * This file is compiled by esbuild into a browser-compatible bundle.\n */\n\n// Core protocol\nexport { createCellProtocol, CellProtocol } from './index';\n\n// Types\nexport type {\n  IdentityId,\n  CellId,\n  Units,\n  Timestamp,\n  MembershipStatus,\n  BalanceChangeReason,\n} from './types/common';\n\nexport type {\n  CellIdentity,\n  MemberProfile,\n  AdmissionApplication,\n  AdmissionInfo,\n} from './types/identity';\n\nexport type {\n  SpotTransaction,\n  TransactionStatus,\n  TransactionResult,\n} from './types/transaction';\n\nexport type {\n  Commitment,\n  CommitmentType,\n  CommitmentStatus,\n  TaskCategory,\n} from './types/commitment';\n\n// Utility functions\nexport { generateId, now } from './types/common';\n\n// Re-export individual engines for direct access if needed\nexport { LedgerEngine } from './engines/ledger-engine';\nexport { TransactionEngine } from './engines/transaction-engine';\nexport { IdentityEngine } from './engines/identity-engine';\nexport { CommitmentEngine } from './engines/commitment-engine';\nexport { GovernanceEngine } from './engines/governance-engine';\nexport { FederationEngine } from './engines/federation-engine';\nexport { EmergencyEngine } from './engines/emergency-engine';\nexport { SchedulerEngine } from './engines/scheduler-engine';\nexport { EnergyEngine } from './engines/energy-engine';\n\n// Storage adapter\nexport { createPouchDBStorage, createInMemoryStorage } from './storage/pouchdb-adapter';\n", "/**\n * Cell Protocol - Common Types\n *\n * Fundamental type aliases and shared types used across the protocol.\n */\n\n// ============================================\n// CORE TYPE ALIASES\n// ============================================\n\n/** Unique identifier for an identity/member within a cell */\nexport type IdentityId = string;\n\n/** Unique identifier for a cell */\nexport type CellId = string;\n\n/** Unique identifier for a transaction */\nexport type TransactionId = string;\n\n/** Unix timestamp in milliseconds */\nexport type Timestamp = number;\n\n/** Credit units (positive integer, smallest divisible unit) */\nexport type Units = number;\n\n/** Base64-encoded public key */\nexport type PublicKey = string;\n\n/** Base64-encoded signature */\nexport type Signature = string;\n\n/** Base64-encoded secret key */\nexport type SecretKey = string;\n\n// ============================================\n// COMMON ENUMS\n// ============================================\n\n/** Reasons for balance changes */\nexport enum BalanceChangeReason {\n  SPOT_TRANSACTION_PAYER = 'SPOT_TRANSACTION_PAYER',\n  SPOT_TRANSACTION_PAYEE = 'SPOT_TRANSACTION_PAYEE',\n  COMMITMENT_RESERVE = 'COMMITMENT_RESERVE',\n  COMMITMENT_RELEASE = 'COMMITMENT_RELEASE',\n  COMMITMENT_EXECUTE = 'COMMITMENT_EXECUTE',\n  LIMIT_ADJUSTMENT = 'LIMIT_ADJUSTMENT',\n  MEMBER_SETTLEMENT = 'MEMBER_SETTLEMENT',\n}\n\n/** Status of a member within a cell */\nexport enum MembershipStatus {\n  PENDING = 'PENDING',       // Applied but not yet admitted\n  PROBATION = 'PROBATION',   // Admitted with limited privileges\n  ACTIVE = 'ACTIVE',         // Full member\n  FROZEN = 'FROZEN',         // Temporarily suspended\n  EXCLUDED = 'EXCLUDED',     // Permanently removed\n}\n\n// ============================================\n// COMMON INTERFACES\n// ============================================\n\n/** Generic event metadata */\nexport interface EventMeta {\n  id: string;\n  timestamp: Timestamp;\n  cellId: CellId;\n}\n\n/** Audit log entry for any state change */\nexport interface AuditEntry extends EventMeta {\n  type: string;\n  actorId: IdentityId;\n  details: Record<string, unknown>;\n}\n\n// ============================================\n// UTILITY FUNCTIONS\n// ============================================\n\n/** Generate a unique ID using timestamp and random bytes */\nexport function generateId(): string {\n  const timestamp = Date.now().toString(36);\n  const random = Math.random().toString(36).substring(2, 10);\n  return `${timestamp}-${random}`;\n}\n\n/** Get current timestamp */\nexport function now(): Timestamp {\n  return Date.now();\n}\n", "/**\n * Cell Protocol - Energy Types\n *\n * Type definitions for the Energy Resource Layer (PRD-09).\n * Defines energy carriers, stocks, flows, modes, and rationing.\n */\n\nimport {\n  IdentityId,\n  CellId,\n  Timestamp,\n  Units,\n} from './common';\nimport { TaskCategory } from './commitment';\n\n// ============================================\n// TYPE ALIASES\n// ============================================\n\n/** Unique identifier for an energy carrier */\nexport type EnergyCarrierId = string;\n\n// ============================================\n// ENUMS\n// ============================================\n\n/** Category of energy carrier */\nexport enum EnergyCategory {\n  /** Solid fuels: wood, coal, peat */\n  SOLID_FUEL = 'SOLID_FUEL',\n  /** Liquid fuels: diesel, petrol, kerosene */\n  LIQUID_FUEL = 'LIQUID_FUEL',\n  /** Gas: propane, natural gas */\n  GAS = 'GAS',\n  /** Electricity: stored or flow */\n  ELECTRICITY = 'ELECTRICITY',\n  /** Water: potable water */\n  WATER = 'WATER',\n  /** Other resources */\n  OTHER = 'OTHER',\n}\n\n// ============================================\n// CORE INTERFACES\n// ============================================\n\n/** An energy carrier definition */\nexport interface EnergyCarrier {\n  /** Unique identifier */\n  id: EnergyCarrierId;\n\n  /** Human-readable name */\n  name: string;\n\n  /** Unit of measurement (kg, L, kWh) */\n  unit: string;\n\n  /** Category of carrier */\n  category: EnergyCategory;\n\n  /** Whether this carrier can be stored */\n  storable: boolean;\n\n  /** Maximum storage capacity (optional) */\n  maxStorageCapacity?: number;\n\n  /** Perishability info (optional) */\n  perishable?: {\n    /** Half-life in days */\n    halfLifeDays: number;\n  };\n}\n\n/** Current stock level of an energy carrier */\nexport interface EnergyStock {\n  /** Which carrier */\n  carrierId: EnergyCarrierId;\n\n  /** Current amount in stock */\n  currentAmount: number;\n\n  /** Unit of measurement */\n  unit: string;\n\n  /** When last restocked */\n  lastRestocked: Timestamp;\n\n  /** Projected depletion date (if calculable) */\n  projectedDepletionDate?: Timestamp;\n}\n\n/** Source of energy inflow */\nexport interface EnergySource {\n  /** Source name/identifier */\n  name: string;\n\n  /** Amount contributed */\n  amount: number;\n\n  /** When received */\n  timestamp: Timestamp;\n}\n\n/** Consumer of energy */\nexport interface EnergyConsumer {\n  /** Consumer name/task category */\n  name: string;\n\n  /** Amount consumed */\n  amount: number;\n\n  /** When consumed */\n  timestamp: Timestamp;\n}\n\n/** Energy flow for a period */\nexport interface EnergyFlow {\n  /** Which carrier */\n  carrierId: EnergyCarrierId;\n\n  /** Time period */\n  period: {\n    start: Timestamp;\n    end: Timestamp;\n  };\n\n  /** Total inflow */\n  inflow: number;\n\n  /** Total outflow */\n  outflow: number;\n\n  /** Sources of inflow */\n  sources: EnergySource[];\n\n  /** Consumers of outflow */\n  consumers: EnergyConsumer[];\n}\n\n/** A mode of performing a task with energy profile */\nexport interface EnergyMode {\n  /** Mode identifier */\n  id: string;\n\n  /** Human-readable name */\n  name: string;\n\n  /** Effectiveness/efficiency factor (0-1) */\n  efficiency: number;\n\n  /** Energy consumption per hour by carrier (\u03B5_t,j) */\n  energyPerHour: Map<EnergyCarrierId, number>;\n}\n\n/** Energy profile for a task category */\nexport interface TaskEnergyProfile {\n  /** Task category */\n  taskCategory: TaskCategory;\n\n  /** Available modes for this task */\n  energyModes: EnergyMode[];\n}\n\n// ============================================\n// RATIONING TYPES\n// ============================================\n\n/** A rationing plan to achieve target stress */\nexport interface RationingPlan {\n  /** Target stress level to achieve */\n  targetStress: number;\n\n  /** Bundle reduction factor (y: fraction of full bundle) */\n  bundleReductionFactor: number;\n\n  /** Task category reductions (hours reduction by category) */\n  taskReductions: Map<TaskCategory, number>;\n\n  /** Mode substitutions (category -> selected mode ID) */\n  modeSubstitutions: Map<TaskCategory, string>;\n\n  /** Additional procurement needed by carrier */\n  additionalProcurement: Map<EnergyCarrierId, number>;\n\n  /** Whether plan is feasible */\n  feasible: boolean;\n\n  /** Explanation of plan */\n  explanation: string;\n}\n\n/** Member's energy bundle allocation */\nexport interface MemberBundle {\n  /** Member ID */\n  memberId: IdentityId;\n\n  /** Bundle fraction (y_m: 0 to 1) */\n  bundleFraction: number;\n\n  /** Energy allocation by carrier */\n  energyAllocation: Map<EnergyCarrierId, number>;\n\n  /** Whether member is vulnerable (gets protected allocation) */\n  isVulnerable: boolean;\n}\n\n// ============================================\n// STOCK CHANGE & CONSUMPTION RECORDS\n// ============================================\n\n/** Record of a stock change (addition or removal) */\nexport interface StockChangeRecord {\n  /** Unique ID */\n  id: string;\n\n  /** Cell ID */\n  cellId: CellId;\n\n  /** Which carrier */\n  carrierId: EnergyCarrierId;\n\n  /** Change amount (positive = addition, negative = removal) */\n  delta: number;\n\n  /** Reason for change */\n  reason: StockChangeReason;\n\n  /** Source/destination (e.g., \"procurement\", \"task:FOOD\") */\n  source?: string;\n\n  /** Timestamp */\n  timestamp: Timestamp;\n}\n\n/** Reasons for stock changes */\nexport enum StockChangeReason {\n  /** Procurement/purchase */\n  PROCUREMENT = 'PROCUREMENT',\n  /** Donation/gift */\n  DONATION = 'DONATION',\n  /** Task consumption */\n  TASK_CONSUMPTION = 'TASK_CONSUMPTION',\n  /** Spoilage/loss */\n  SPOILAGE = 'SPOILAGE',\n  /** Transfer to another cell */\n  TRANSFER_OUT = 'TRANSFER_OUT',\n  /** Transfer from another cell */\n  TRANSFER_IN = 'TRANSFER_IN',\n  /** Manual adjustment */\n  ADJUSTMENT = 'ADJUSTMENT',\n}\n\n/** Record of energy consumption */\nexport interface ConsumptionRecord {\n  /** Unique ID */\n  id: string;\n\n  /** Cell ID */\n  cellId: CellId;\n\n  /** Which carrier */\n  carrierId: EnergyCarrierId;\n\n  /** Amount consumed */\n  amount: number;\n\n  /** Task category that consumed it */\n  taskCategory: TaskCategory;\n\n  /** Mode used */\n  modeId?: string;\n\n  /** Member who performed task (optional) */\n  memberId?: IdentityId;\n\n  /** Timestamp */\n  timestamp: Timestamp;\n}\n\n// ============================================\n// PLANNING TYPES\n// ============================================\n\n/** Weekly energy plan */\nexport interface WeeklyEnergyPlan {\n  /** Cell ID */\n  cellId: CellId;\n\n  /** Week start timestamp */\n  weekStart: Timestamp;\n\n  /** Projected consumption by carrier */\n  projectedConsumption: Map<EnergyCarrierId, number>;\n\n  /** Required by carrier */\n  requiredByCarrier: Map<EnergyCarrierId, number>;\n\n  /** Available by carrier */\n  availableByCarrier: Map<EnergyCarrierId, number>;\n\n  /** Selected modes by task category */\n  selectedModes: Map<TaskCategory, string>;\n\n  /** Energy stress index for this plan */\n  stressIndex: number;\n\n  /** Whether plan is feasible */\n  feasible: boolean;\n\n  /** Member bundles */\n  bundles: MemberBundle[];\n\n  /** Created at */\n  createdAt: Timestamp;\n}\n\n/** Stress projection for future days */\nexport interface StressProjection {\n  /** Days ahead */\n  daysAhead: number;\n\n  /** Projected stress values */\n  projectedStress: number[];\n\n  /** Days until crisis (stress > 1) */\n  daysUntilCrisis?: number;\n\n  /** Recommendations */\n  recommendations: string[];\n}\n\n/** Procurement alert */\nexport interface ProcurementAlert {\n  /** Carrier ID */\n  carrierId: EnergyCarrierId;\n\n  /** Current stock */\n  currentStock: number;\n\n  /** Days until depletion */\n  daysUntilDepletion: number;\n\n  /** Recommended procurement amount */\n  recommendedAmount: number;\n\n  /** Priority (1=urgent, 2=soon, 3=monitor) */\n  priority: 1 | 2 | 3;\n\n  /** Alert message */\n  message: string;\n}\n\n// ============================================\n// STATE TYPES\n// ============================================\n\n/** Complete energy state for a cell */\nexport interface EnergyState {\n  /** Cell ID */\n  cellId: CellId;\n\n  /** Available carriers */\n  carriers: EnergyCarrier[];\n\n  /** Current stocks */\n  stocks: Map<EnergyCarrierId, EnergyStock>;\n\n  /** Selected modes by task category */\n  selectedModes: Map<TaskCategory, string>;\n\n  /** Task energy profiles */\n  taskProfiles: TaskEnergyProfile[];\n\n  /** Current stress index */\n  stressIndex: number;\n\n  /** Last calculation timestamp */\n  lastCalculated: Timestamp;\n\n  /** Created timestamp */\n  createdAt: Timestamp;\n\n  /** Updated timestamp */\n  updatedAt: Timestamp;\n}\n\n// ============================================\n// ERROR TYPES\n// ============================================\n\n/** Errors that can occur during energy operations */\nexport enum EnergyErrorCode {\n  /** Carrier not found */\n  CARRIER_NOT_FOUND = 'CARRIER_NOT_FOUND',\n\n  /** Stock not found */\n  STOCK_NOT_FOUND = 'STOCK_NOT_FOUND',\n\n  /** Insufficient stock */\n  INSUFFICIENT_STOCK = 'INSUFFICIENT_STOCK',\n\n  /** Invalid amount */\n  INVALID_AMOUNT = 'INVALID_AMOUNT',\n\n  /** Mode not found */\n  MODE_NOT_FOUND = 'MODE_NOT_FOUND',\n\n  /** Task profile not found */\n  PROFILE_NOT_FOUND = 'PROFILE_NOT_FOUND',\n\n  /** Rationing not feasible */\n  RATIONING_INFEASIBLE = 'RATIONING_INFEASIBLE',\n\n  /** Storage operation failed */\n  STORAGE_ERROR = 'STORAGE_ERROR',\n}\n\n/** Detailed energy error */\nexport interface EnergyError {\n  code: EnergyErrorCode;\n  message: string;\n  details?: Record<string, unknown>;\n}\n\n// ============================================\n// INTERFACE\n// ============================================\n\n/** Interface for the Energy Engine */\nexport interface IEnergyEngine {\n  // Stock Management\n  /** Get all current stocks */\n  getStocks(): Map<EnergyCarrierId, EnergyStock>;\n\n  /** Get stock for a specific carrier */\n  getStock(carrierId: EnergyCarrierId): EnergyStock | null;\n\n  /** Record a stock change (addition or removal) */\n  recordStockChange(change: Omit<StockChangeRecord, 'id' | 'cellId' | 'timestamp'>): Promise<void>;\n\n  /** Record energy consumption */\n  recordConsumption(record: Omit<ConsumptionRecord, 'id' | 'cellId' | 'timestamp'>): Promise<void>;\n\n  // Carriers\n  /** Get all available carriers */\n  getCarriers(): EnergyCarrier[];\n\n  /** Get energy profile for a task category */\n  getEnergyProfile(category: TaskCategory): TaskEnergyProfile | null;\n\n  // Planning\n  /** Generate weekly energy plan */\n  generateWeeklyPlan(): WeeklyEnergyPlan;\n\n  /** Set mode selection for a task category */\n  setModeSelection(category: TaskCategory, modeId: string): void;\n\n  /** Get selected mode for a task category */\n  getSelectedMode(category: TaskCategory): string | null;\n\n  // Stress\n  /** Calculate current energy stress index */\n  calculateEnergyStress(): number;\n\n  /** Get current stress index */\n  getStressIndex(): number;\n\n  /** Project stress for future days */\n  projectStress(daysAhead: number): StressProjection;\n\n  // Rationing\n  /** Compute a rationing plan to achieve target stress */\n  computeRationingPlan(targetStress: number): RationingPlan;\n\n  /** Apply a rationing plan */\n  applyRationingPlan(plan: RationingPlan): Promise<void>;\n\n  /** Get current bundle distribution */\n  getBundleDistribution(): MemberBundle[];\n\n  // History & Projections\n  /** Get flow history for a carrier */\n  getFlowHistory(carrierId: EnergyCarrierId, since: Timestamp): EnergyFlow[];\n\n  /** Project depletion date for a carrier */\n  projectDepletion(carrierId: EnergyCarrierId): Timestamp | null;\n\n  /** Generate procurement alerts */\n  generateProcurementAlerts(): ProcurementAlert[];\n\n  // Task Support\n  /** Check if a task can be completed with available energy */\n  canCompleteTask(category: TaskCategory, hours: number): boolean;\n}\n\n// ============================================\n// DEFAULT CARRIERS\n// ============================================\n\n/** Default energy carriers for a cell */\nexport const DEFAULT_CARRIERS: EnergyCarrier[] = [\n  {\n    id: 'FIREWOOD',\n    name: 'Firewood',\n    unit: 'kg',\n    category: EnergyCategory.SOLID_FUEL,\n    storable: true,\n  },\n  {\n    id: 'DIESEL',\n    name: 'Diesel Fuel',\n    unit: 'L',\n    category: EnergyCategory.LIQUID_FUEL,\n    storable: true,\n  },\n  {\n    id: 'PROPANE',\n    name: 'Propane Gas',\n    unit: 'kg',\n    category: EnergyCategory.GAS,\n    storable: true,\n  },\n  {\n    id: 'ELECTRICITY_STORED',\n    name: 'Battery Storage',\n    unit: 'kWh',\n    category: EnergyCategory.ELECTRICITY,\n    storable: true,\n  },\n  {\n    id: 'POTABLE_WATER',\n    name: 'Potable Water',\n    unit: 'L',\n    category: EnergyCategory.WATER,\n    storable: true,\n  },\n];\n\n// ============================================\n// DEFAULT TASK PROFILES\n// ============================================\n\n/** Default task energy profiles */\nexport const DEFAULT_TASK_PROFILES: TaskEnergyProfile[] = [\n  {\n    taskCategory: TaskCategory.FOOD,\n    energyModes: [\n      {\n        id: 'FOOD_ELECTRIC',\n        name: 'Electric Cooking',\n        efficiency: 1.0,\n        energyPerHour: new Map([['ELECTRICITY_STORED', 2.0]]),\n      },\n      {\n        id: 'FOOD_GAS',\n        name: 'Gas Cooking',\n        efficiency: 0.95,\n        energyPerHour: new Map([['PROPANE', 0.5]]),\n      },\n      {\n        id: 'FOOD_WOOD',\n        name: 'Wood Fire Cooking',\n        efficiency: 0.7,\n        energyPerHour: new Map([['FIREWOOD', 3.0]]),\n      },\n    ],\n  },\n  {\n    taskCategory: TaskCategory.WATER_SANITATION,\n    energyModes: [\n      {\n        id: 'WATER_ELECTRIC',\n        name: 'Electric Pump',\n        efficiency: 1.0,\n        energyPerHour: new Map([['ELECTRICITY_STORED', 1.0], ['POTABLE_WATER', 50]]),\n      },\n      {\n        id: 'WATER_MANUAL',\n        name: 'Manual Draw',\n        efficiency: 0.6,\n        energyPerHour: new Map([['POTABLE_WATER', 30]]),\n      },\n    ],\n  },\n  {\n    taskCategory: TaskCategory.ENERGY_HEAT,\n    energyModes: [\n      {\n        id: 'HEAT_ELECTRIC',\n        name: 'Electric Heating',\n        efficiency: 1.0,\n        energyPerHour: new Map([['ELECTRICITY_STORED', 3.0]]),\n      },\n      {\n        id: 'HEAT_GAS',\n        name: 'Gas Heating',\n        efficiency: 0.9,\n        energyPerHour: new Map([['PROPANE', 1.0]]),\n      },\n      {\n        id: 'HEAT_WOOD',\n        name: 'Wood Stove',\n        efficiency: 0.7,\n        energyPerHour: new Map([['FIREWOOD', 5.0]]),\n      },\n    ],\n  },\n  {\n    taskCategory: TaskCategory.MEDICAL,\n    energyModes: [\n      {\n        id: 'MEDICAL_FULL',\n        name: 'Full Medical Equipment',\n        efficiency: 1.0,\n        energyPerHour: new Map([['ELECTRICITY_STORED', 1.5], ['POTABLE_WATER', 10]]),\n      },\n      {\n        id: 'MEDICAL_BASIC',\n        name: 'Basic Care',\n        efficiency: 0.7,\n        energyPerHour: new Map([['POTABLE_WATER', 5]]),\n      },\n    ],\n  },\n  {\n    taskCategory: TaskCategory.SHELTER_REPAIR,\n    energyModes: [\n      {\n        id: 'SHELTER_POWER_TOOLS',\n        name: 'Power Tools',\n        efficiency: 1.0,\n        energyPerHour: new Map([['ELECTRICITY_STORED', 0.5]]),\n      },\n      {\n        id: 'SHELTER_MANUAL',\n        name: 'Manual Tools',\n        efficiency: 0.6,\n        energyPerHour: new Map(),\n      },\n    ],\n  },\n  {\n    taskCategory: TaskCategory.CHILDCARE_DEPENDENT,\n    energyModes: [\n      {\n        id: 'CHILDCARE_STANDARD',\n        name: 'Standard Care',\n        efficiency: 1.0,\n        energyPerHour: new Map([['ELECTRICITY_STORED', 0.3], ['POTABLE_WATER', 5]]),\n      },\n    ],\n  },\n  {\n    taskCategory: TaskCategory.SECURITY_COORDINATION,\n    energyModes: [\n      {\n        id: 'SECURITY_STANDARD',\n        name: 'Standard Security',\n        efficiency: 1.0,\n        energyPerHour: new Map([['ELECTRICITY_STORED', 0.2]]),\n      },\n    ],\n  },\n  {\n    taskCategory: TaskCategory.PROCUREMENT_TRANSPORT,\n    energyModes: [\n      {\n        id: 'TRANSPORT_VEHICLE',\n        name: 'Vehicle Transport',\n        efficiency: 1.0,\n        energyPerHour: new Map([['DIESEL', 5.0]]),\n      },\n      {\n        id: 'TRANSPORT_MANUAL',\n        name: 'Manual Transport',\n        efficiency: 0.4,\n        energyPerHour: new Map(),\n      },\n    ],\n  },\n  {\n    taskCategory: TaskCategory.GENERAL,\n    energyModes: [\n      {\n        id: 'GENERAL_STANDARD',\n        name: 'Standard',\n        efficiency: 1.0,\n        energyPerHour: new Map([['ELECTRICITY_STORED', 0.1]]),\n      },\n      {\n        id: 'GENERAL_MINIMAL',\n        name: 'Minimal',\n        efficiency: 0.8,\n        energyPerHour: new Map(),\n      },\n    ],\n  },\n];\n\n// ============================================\n// CONSTANTS\n// ============================================\n\n/** Minimum bundle fraction (humanitarian floor) */\nexport const HUMANITARIAN_FLOOR = 0.6;\n\n/** Vulnerability bonus factor */\nexport const VULNERABILITY_BONUS = 0.2;\n", "/**\n * Cell Protocol - Emergency Types\n *\n * Type definitions for the Emergency Mode System (PRD-07).\n * Defines risk states, policies, stress indicators, and state transitions.\n */\n\nimport {\n  CellId,\n  IdentityId,\n  Timestamp,\n  Units,\n} from './common';\n\n// ============================================\n// CORE ENUMS\n// ============================================\n\n/** Risk state of the cell - determines policy parameters */\nexport enum RiskState {\n  NORMAL = 'NORMAL',       // Standard operating conditions\n  STRESSED = 'STRESSED',   // Elevated risk indicators\n  PANIC = 'PANIC',         // Critical risk - emergency measures active\n}\n\n/** Admission modes for new members */\nexport enum AdmissionMode {\n  STANDARD = 'STANDARD',                     // Normal admission process\n  BONDED = 'BONDED',                         // Requires bond/deposit\n  SUPERMAJORITY_BONDED = 'SUPERMAJORITY_BONDED', // Bond + supermajority approval\n}\n\n/** Commitment escrow modes */\nexport enum CommitmentMode {\n  STANDARD = 'STANDARD',           // Normal commitment handling\n  ESCROW_ESSENTIALS = 'ESCROW_ESSENTIALS', // Escrow required for essential commitments\n  ESCROW_ALL = 'ESCROW_ALL',       // Escrow required for all commitments\n}\n\n/** Scheduler priority modes */\nexport enum SchedulerPriority {\n  BALANCED = 'BALANCED',           // Balance all task categories\n  ESSENTIALS_FIRST = 'ESSENTIALS_FIRST', // Prioritize essential tasks\n  SURVIVAL = 'SURVIVAL',           // Only survival-critical tasks\n}\n\n// ============================================\n// STRESS INDICATORS\n// ============================================\n\n/** Stress indicators used to determine risk state */\nexport interface StressIndicators {\n  /** Fraction of total limit held by members at their debt floor (0-1) */\n  floorMass: number;\n\n  /** Balance dispersion across members (variance coefficient) */\n  balanceVariance: number;\n\n  /** Disputes filed per transaction in recent period */\n  disputeRate: number;\n\n  /** Member exits per period (churn rate) */\n  memberChurn: number;\n\n  /** Energy stress indicator (for future use) */\n  energyStress: number;\n\n  /** Combined economic stress index */\n  economicStress: number;\n\n  /** Overall stress = max(economic, energy) */\n  overallStress: number;\n\n  /** Timestamp when indicators were calculated */\n  calculatedAt: Timestamp;\n}\n\n// ============================================\n// EMERGENCY POLICY\n// ============================================\n\n/** Policy parameters that change based on risk state */\nexport interface EmergencyPolicy {\n  /** Factor to multiply existing credit limits (0-1) */\n  limitFactor: number;\n\n  /** Factor for new member limits (typically lower than limitFactor) */\n  newMemberLimitFactor: number;\n\n  /** Factor to multiply federation exposure cap */\n  federationBetaFactor: number;\n\n  /** Current admission mode */\n  admissionMode: AdmissionMode;\n\n  /** Current commitment mode */\n  commitmentMode: CommitmentMode;\n\n  /** Current scheduler priority */\n  schedulerPriority: SchedulerPriority;\n\n  /** Whether to enable debtor priority matching */\n  debtorPriorityMatching: boolean;\n}\n\n/** Default policies for each risk state */\nexport const DEFAULT_POLICIES: Record<RiskState, EmergencyPolicy> = {\n  [RiskState.NORMAL]: {\n    limitFactor: 1.0,\n    newMemberLimitFactor: 1.0,\n    federationBetaFactor: 1.0,\n    admissionMode: AdmissionMode.STANDARD,\n    commitmentMode: CommitmentMode.STANDARD,\n    schedulerPriority: SchedulerPriority.BALANCED,\n    debtorPriorityMatching: false,\n  },\n  [RiskState.STRESSED]: {\n    limitFactor: 1.0,\n    newMemberLimitFactor: 0.8,\n    federationBetaFactor: 0.7,\n    admissionMode: AdmissionMode.BONDED,\n    commitmentMode: CommitmentMode.ESCROW_ESSENTIALS,\n    schedulerPriority: SchedulerPriority.ESSENTIALS_FIRST,\n    debtorPriorityMatching: true,\n  },\n  [RiskState.PANIC]: {\n    limitFactor: 0.8,\n    newMemberLimitFactor: 0.5,\n    federationBetaFactor: 0.0, // Federation frozen\n    admissionMode: AdmissionMode.SUPERMAJORITY_BONDED,\n    commitmentMode: CommitmentMode.ESCROW_ALL,\n    schedulerPriority: SchedulerPriority.SURVIVAL,\n    debtorPriorityMatching: true,\n  },\n};\n\n// ============================================\n// TRANSITION THRESHOLDS\n// ============================================\n\n/** Thresholds for state transitions */\nexport interface TransitionThresholds {\n  /** Floor mass to trigger NORMAL \u2192 STRESSED */\n  stressedFloorMass: number;\n\n  /** Dispute rate to trigger NORMAL \u2192 STRESSED */\n  stressedDisputeRate: number;\n\n  /** Floor mass to trigger STRESSED \u2192 PANIC */\n  panicFloorMass: number;\n\n  /** Energy stress to trigger STRESSED \u2192 PANIC */\n  panicEnergyStress: number;\n\n  /** Floor mass to allow PANIC \u2192 STRESSED (hysteresis) */\n  normalFloorMass: number;\n\n  /** Overall stress to allow de-escalation */\n  normalOverallStress: number;\n\n  /** Minimum time in PANIC before de-escalation (ms) */\n  panicStabilizationPeriod: number;\n}\n\n/** Default thresholds */\nexport const DEFAULT_THRESHOLDS: TransitionThresholds = {\n  stressedFloorMass: 0.25,\n  stressedDisputeRate: 0.05,\n  panicFloorMass: 0.40,\n  panicEnergyStress: 1.2,\n  normalFloorMass: 0.15,\n  normalOverallStress: 0.8,\n  panicStabilizationPeriod: 24 * 60 * 60 * 1000, // 24 hours\n};\n\n// ============================================\n// STATE TRANSITIONS\n// ============================================\n\n/** Reasons for state transitions */\nexport enum TransitionReason {\n  /** Automatic transition based on indicators */\n  INDICATOR_TRIGGERED = 'INDICATOR_TRIGGERED',\n  /** Manual override by governance */\n  GOVERNANCE_OVERRIDE = 'GOVERNANCE_OVERRIDE',\n  /** Forced de-escalation by governance */\n  FORCED_DEESCALATION = 'FORCED_DEESCALATION',\n  /** Time-based de-escalation after stabilization */\n  STABILIZATION_COMPLETE = 'STABILIZATION_COMPLETE',\n  /** Initial state on engine creation */\n  INITIALIZATION = 'INITIALIZATION',\n}\n\n/** Result of checking for state transition */\nexport interface StateTransitionResult {\n  /** Whether a transition should occur */\n  shouldTransition: boolean;\n\n  /** Target state if transition should occur */\n  targetState?: RiskState;\n\n  /** Reason for transition */\n  reason?: TransitionReason;\n\n  /** Detailed explanation */\n  explanation?: string;\n\n  /** Current indicators that triggered transition */\n  triggeringIndicators?: Partial<StressIndicators>;\n}\n\n/** Entry in state history */\nexport interface StateHistoryEntry {\n  /** Previous risk state */\n  fromState: RiskState;\n\n  /** New risk state */\n  toState: RiskState;\n\n  /** Reason for transition */\n  reason: TransitionReason;\n\n  /** Timestamp of transition */\n  timestamp: Timestamp;\n\n  /** Indicators at time of transition */\n  indicators: StressIndicators;\n\n  /** ID of governance approval if manual override */\n  governanceApprovalId?: string;\n\n  /** Actor who initiated the transition */\n  initiatedBy?: IdentityId;\n}\n\n/** Report on proximity to thresholds */\nexport interface ThresholdProximityReport {\n  /** Current risk state */\n  currentState: RiskState;\n\n  /** Distance to escalation (0 = at threshold, negative = past threshold) */\n  distanceToEscalation: number;\n\n  /** Distance to de-escalation (0 = at threshold, positive = above threshold) */\n  distanceToDeescalation: number;\n\n  /** Most critical indicator name */\n  criticalIndicator: string;\n\n  /** Time until stabilization complete (if in PANIC, else null) */\n  timeUntilStabilization: number | null;\n\n  /** Whether de-escalation is currently blocked */\n  deescalationBlocked: boolean;\n\n  /** Reason for blocked de-escalation */\n  blockReason?: string;\n}\n\n// ============================================\n// EMERGENCY STATE\n// ============================================\n\n/** Complete emergency state for a cell */\nexport interface EmergencyState {\n  /** Cell identifier */\n  cellId: CellId;\n\n  /** Current risk state */\n  riskState: RiskState;\n\n  /** Current policy (derived from state) */\n  currentPolicy: EmergencyPolicy;\n\n  /** Latest stress indicators */\n  indicators: StressIndicators;\n\n  /** Transition thresholds */\n  thresholds: TransitionThresholds;\n\n  /** Timestamp of last state change */\n  lastStateChange: Timestamp;\n\n  /** Timestamp when PANIC was entered (null if not in PANIC) */\n  panicEnteredAt: Timestamp | null;\n\n  /** Timestamp of last indicator update */\n  lastIndicatorUpdate: Timestamp;\n\n  /** Created timestamp */\n  createdAt: Timestamp;\n\n  /** Updated timestamp */\n  updatedAt: Timestamp;\n}\n\n// ============================================\n// ERROR TYPES\n// ============================================\n\n/** Errors that can occur during emergency operations */\nexport enum EmergencyErrorCode {\n  /** Invalid state transition requested */\n  INVALID_TRANSITION = 'INVALID_TRANSITION',\n\n  /** De-escalation blocked by stabilization period */\n  STABILIZATION_REQUIRED = 'STABILIZATION_REQUIRED',\n\n  /** Missing governance approval for manual override */\n  GOVERNANCE_APPROVAL_REQUIRED = 'GOVERNANCE_APPROVAL_REQUIRED',\n\n  /** Invalid threshold configuration */\n  INVALID_THRESHOLDS = 'INVALID_THRESHOLDS',\n\n  /** Storage operation failed */\n  STORAGE_ERROR = 'STORAGE_ERROR',\n\n  /** Dependencies not available */\n  DEPENDENCY_ERROR = 'DEPENDENCY_ERROR',\n}\n\n/** Detailed error information */\nexport interface EmergencyError {\n  code: EmergencyErrorCode;\n  message: string;\n  details?: Record<string, unknown>;\n}\n\n// ============================================\n// INTERFACE\n// ============================================\n\n/** Interface for the Emergency Engine */\nexport interface IEmergencyEngine {\n  /** Get the cell ID this engine manages */\n  getCellId(): CellId;\n\n  /** Get current risk state */\n  getCurrentRiskState(): RiskState;\n\n  /** Get current stress indicators */\n  getStressIndicators(): StressIndicators;\n\n  /** Get current policy based on risk state */\n  getCurrentPolicy(): EmergencyPolicy;\n\n  /** Get transition thresholds */\n  getThresholds(): TransitionThresholds;\n\n  /** Recalculate stress indicators from current ledger/governance state */\n  updateIndicators(): Promise<StressIndicators>;\n\n  /** Check if state transition should occur based on current indicators */\n  checkStateTransition(): Promise<StateTransitionResult>;\n\n  /** Trigger state change (called after governance approval for manual changes) */\n  triggerStateChange(\n    newState: RiskState,\n    reason: TransitionReason,\n    governanceApprovalId?: string,\n    initiatedBy?: IdentityId\n  ): Promise<void>;\n\n  /** Force de-escalation (requires governance approval) */\n  forceDeEscalation(\n    reason: string,\n    governanceApprovalId: string,\n    initiatedBy: IdentityId\n  ): Promise<void>;\n\n  /** Analyze proximity to thresholds */\n  analyzeThresholdProximity(): ThresholdProximityReport;\n\n  /** Get state history since timestamp */\n  getStateHistory(since: Timestamp): Promise<StateHistoryEntry[]>;\n\n  /** Check if federation is frozen (PANIC mode with beta=0) */\n  isFederationFrozen(): boolean;\n\n  /** Get effective limit factor for a member */\n  getEffectiveLimitFactor(isNewMember: boolean): number;\n}\n", "/**\n * Cell Protocol - Federation Types\n *\n * Type definitions for the Federation Layer (PRD-06).\n * Defines federation state, links, transactions, and exposure management.\n */\n\nimport {\n  CellId,\n  IdentityId,\n  Timestamp,\n  Units,\n  generateId,\n} from './common';\n\n// ============================================\n// CORE TYPE ALIASES\n// ============================================\n\n/** Unique identifier for a federation transaction */\nexport type FederationTxId = string;\n\n/** Unique identifier for a link proposal */\nexport type LinkProposalId = string;\n\n// ============================================\n// CORE ENUMS\n// ============================================\n\n/** Status of a cell's federation participation */\nexport enum FederationStatus {\n  ACTIVE = 'ACTIVE',           // Normal federation operations\n  SUSPENDED = 'SUSPENDED',     // Temporarily suspended (can resume)\n  QUARANTINED = 'QUARANTINED', // Isolated due to cap violation or PANIC\n}\n\n/** Status of a bilateral federation link */\nexport enum LinkStatus {\n  ACTIVE = 'ACTIVE',     // Link is operational\n  SUSPENDED = 'SUSPENDED', // Link temporarily suspended\n  PENDING = 'PENDING',   // Link proposal pending acceptance\n}\n\n/** Status of a federation transaction */\nexport enum FederationTxStatus {\n  PENDING = 'PENDING',           // Transaction initiated\n  SOURCE_CONFIRMED = 'SOURCE_CONFIRMED', // Source cell has confirmed\n  TARGET_CONFIRMED = 'TARGET_CONFIRMED', // Target cell has confirmed\n  COMPLETED = 'COMPLETED',       // Transaction fully executed\n  FAILED = 'FAILED',             // Transaction failed\n  ROLLED_BACK = 'ROLLED_BACK',   // Transaction was rolled back\n}\n\n/** Reason for quarantine */\nexport enum QuarantineReason {\n  CAP_VIOLATION = 'CAP_VIOLATION',     // Position exceeds cap\n  PANIC_MODE = 'PANIC_MODE',           // Cell in PANIC state\n  SYNC_TIMEOUT = 'SYNC_TIMEOUT',       // Failed to sync with network\n  MANUAL_SUSPENSION = 'MANUAL_SUSPENSION', // Governance suspended\n  REMOTE_VIOLATION = 'REMOTE_VIOLATION',   // Remote cell violated terms\n}\n\n// ============================================\n// FEDERATION LINK\n// ============================================\n\n/** Bilateral link between two cells */\nexport interface FederationLink {\n  /** ID of the remote cell */\n  remoteCellId: CellId;\n\n  /** Current link status */\n  status: LinkStatus;\n\n  /** Net position with this specific cell (positive = they owe us) */\n  bilateralPosition: Units;\n\n  /** Timestamp when link was established */\n  establishedAt: Timestamp;\n\n  /** Timestamp of last activity on this link */\n  lastActivity: Timestamp;\n\n  /** Reason for suspension if suspended */\n  suspensionReason?: string;\n\n  /** Timestamp of suspension if suspended */\n  suspendedAt?: Timestamp;\n}\n\n/** Proposal to establish a federation link */\nexport interface LinkProposal {\n  /** Unique proposal ID */\n  id: LinkProposalId;\n\n  /** Cell that initiated the proposal */\n  initiatorCellId: CellId;\n\n  /** Target cell for the link */\n  targetCellId: CellId;\n\n  /** Proposed terms */\n  proposedTerms: FederationTerms;\n\n  /** Timestamp of proposal creation */\n  createdAt: Timestamp;\n\n  /** Expiration timestamp */\n  expiresAt: Timestamp;\n\n  /** Status */\n  status: 'PENDING' | 'ACCEPTED' | 'REJECTED' | 'EXPIRED';\n\n  /** Response timestamp if accepted/rejected */\n  respondedAt?: Timestamp;\n\n  /** Rejection reason if rejected */\n  rejectionReason?: string;\n}\n\n/** Terms of a federation link */\nexport interface FederationTerms {\n  /** Maximum bilateral position allowed */\n  maxBilateralPosition: Units;\n\n  /** Settlement period in hours */\n  settlementPeriodHours: number;\n\n  /** Whether to allow automatic settlement */\n  autoSettlement: boolean;\n\n  /** Minimum transaction amount */\n  minTransactionAmount: Units;\n}\n\n/** Default federation terms */\nexport const DEFAULT_FEDERATION_TERMS: FederationTerms = {\n  maxBilateralPosition: 10000,\n  settlementPeriodHours: 168, // 1 week\n  autoSettlement: false,\n  minTransactionAmount: 1,\n};\n\n// ============================================\n// FEDERATION STATE\n// ============================================\n\n/** Complete federation state for a cell */\nexport interface FederationState {\n  /** This cell's ID */\n  cellId: CellId;\n\n  /** Net federation position B_k (sum of all bilateral positions) */\n  federationPosition: Units;\n\n  /** ID of the clearing account member in the ledger */\n  clearingAccountId: IdentityId;\n\n  /** Current exposure cap = beta * Lambda_k */\n  exposureCap: Units;\n\n  /** Beta factor (0-1), affected by emergency state */\n  betaFactor: number;\n\n  /** Connected cells with their link status */\n  connectedCells: FederationLink[];\n\n  /** Current federation status */\n  status: FederationStatus;\n\n  /** Quarantine reason if quarantined */\n  quarantineReason?: QuarantineReason;\n\n  /** Timestamp of quarantine if quarantined */\n  quarantinedAt?: Timestamp;\n\n  /** Created timestamp */\n  createdAt: Timestamp;\n\n  /** Updated timestamp */\n  updatedAt: Timestamp;\n}\n\n// ============================================\n// FEDERATION TRANSACTIONS\n// ============================================\n\n/** Inter-cell transaction */\nexport interface FederationTransaction {\n  /** Unique transaction ID */\n  id: FederationTxId;\n\n  /** Source cell (where funds originate) */\n  sourceCell: CellId;\n\n  /** Target cell (where funds go) */\n  targetCell: CellId;\n\n  /** Payer identity in source cell */\n  payer: IdentityId;\n\n  /** Payee identity in target cell */\n  payee: IdentityId;\n\n  /** Amount being transferred */\n  amount: Units;\n\n  /** Current status */\n  status: FederationTxStatus;\n\n  /** Transaction memo/description */\n  memo?: string;\n\n  /** Created timestamp */\n  createdAt: Timestamp;\n\n  /** Timestamp of source confirmation */\n  sourceConfirmedAt?: Timestamp;\n\n  /** Timestamp of target confirmation */\n  targetConfirmedAt?: Timestamp;\n\n  /** Timestamp of completion or failure */\n  completedAt?: Timestamp;\n\n  /** Failure reason if failed */\n  failureReason?: string;\n\n  /** ID of source leg transaction */\n  sourceLegTxId?: string;\n\n  /** ID of target leg transaction */\n  targetLegTxId?: string;\n}\n\n/** Input for creating a federation transaction */\nexport interface CreateFederationTxInput {\n  /** Source cell */\n  sourceCell: CellId;\n\n  /** Target cell */\n  targetCell: CellId;\n\n  /** Payer in source cell */\n  payer: IdentityId;\n\n  /** Payee in target cell */\n  payee: IdentityId;\n\n  /** Amount */\n  amount: Units;\n\n  /** Memo */\n  memo?: string;\n}\n\n/** Result of a federation transaction */\nexport interface FederationTxResult {\n  /** Transaction details */\n  transaction: FederationTransaction;\n\n  /** New federation position after transaction */\n  newPosition: Units;\n\n  /** Remaining capacity */\n  remainingCapacity: Units;\n\n  /** Whether cap was close to being reached */\n  nearCap: boolean;\n}\n\n// ============================================\n// QUARANTINE\n// ============================================\n\n/** Quarantine status information */\nexport interface QuarantineStatus {\n  /** Whether cell is quarantined */\n  isQuarantined: boolean;\n\n  /** Reason for quarantine */\n  reason?: QuarantineReason;\n\n  /** Timestamp of quarantine */\n  since?: Timestamp;\n\n  /** Current position that caused violation */\n  violatingPosition?: Units;\n\n  /** Cap that was exceeded */\n  exceededCap?: Units;\n\n  /** Steps to resolve quarantine */\n  resolutionSteps?: string[];\n}\n\n// ============================================\n// EXPOSURE MANAGEMENT\n// ============================================\n\n/** Federation parameters */\nexport interface FederationParameters {\n  /** Base beta factor (before emergency adjustments) */\n  baseBetaFactor: number;\n\n  /** Minimum exposure cap */\n  minExposureCap: Units;\n\n  /** Maximum exposure cap */\n  maxExposureCap: Units;\n\n  /** Warning threshold as fraction of cap (0-1) */\n  warningThreshold: number;\n\n  /** Critical threshold as fraction of cap (0-1) */\n  criticalThreshold: number;\n}\n\n/** Default federation parameters */\nexport const DEFAULT_FEDERATION_PARAMETERS: FederationParameters = {\n  baseBetaFactor: 0.3, // 30% of aggregate capacity\n  minExposureCap: 0,\n  maxExposureCap: 1000000,\n  warningThreshold: 0.75,\n  criticalThreshold: 0.90,\n};\n\n/** Exposure analysis */\nexport interface ExposureAnalysis {\n  /** Current position */\n  position: Units;\n\n  /** Current cap */\n  cap: Units;\n\n  /** Available capacity (cap - |position|) */\n  availableCapacity: Units;\n\n  /** Utilization ratio (|position| / cap) */\n  utilization: number;\n\n  /** Warning threshold reached */\n  atWarning: boolean;\n\n  /** Critical threshold reached */\n  atCritical: boolean;\n\n  /** Cap exceeded */\n  capExceeded: boolean;\n}\n\n// ============================================\n// ERROR TYPES\n// ============================================\n\n/** Errors that can occur during federation operations */\nexport enum FederationErrorCode {\n  /** Transaction would exceed source cell's cap */\n  CAP_EXCEEDED = 'CAP_EXCEEDED',\n\n  /** Transaction would exceed remote cell's cap */\n  REMOTE_CAP_EXCEEDED = 'REMOTE_CAP_EXCEEDED',\n\n  /** Link to remote cell is suspended */\n  LINK_SUSPENDED = 'LINK_SUSPENDED',\n\n  /** Link to remote cell doesn't exist */\n  LINK_NOT_FOUND = 'LINK_NOT_FOUND',\n\n  /** Cell is quarantined */\n  CELL_QUARANTINED = 'CELL_QUARANTINED',\n\n  /** Remote cell is quarantined */\n  REMOTE_QUARANTINED = 'REMOTE_QUARANTINED',\n\n  /** Federation is frozen (PANIC mode) */\n  FEDERATION_FROZEN = 'FEDERATION_FROZEN',\n\n  /** Transaction not found */\n  TRANSACTION_NOT_FOUND = 'TRANSACTION_NOT_FOUND',\n\n  /** Invalid transaction state */\n  INVALID_TX_STATE = 'INVALID_TX_STATE',\n\n  /** Proposal not found */\n  PROPOSAL_NOT_FOUND = 'PROPOSAL_NOT_FOUND',\n\n  /** Proposal expired */\n  PROPOSAL_EXPIRED = 'PROPOSAL_EXPIRED',\n\n  /** Invalid amount */\n  INVALID_AMOUNT = 'INVALID_AMOUNT',\n\n  /** Storage operation failed */\n  STORAGE_ERROR = 'STORAGE_ERROR',\n\n  /** Clearing account error */\n  CLEARING_ACCOUNT_ERROR = 'CLEARING_ACCOUNT_ERROR',\n\n  /** Ledger operation failed */\n  LEDGER_ERROR = 'LEDGER_ERROR',\n}\n\n/** Detailed error information */\nexport interface FederationError {\n  code: FederationErrorCode;\n  message: string;\n  details?: Record<string, unknown>;\n}\n\n// ============================================\n// INTERFACE\n// ============================================\n\n/** Interface for the Federation Engine */\nexport interface IFederationEngine {\n  /** Get the cell ID */\n  getCellId(): CellId;\n\n  /** Get complete federation state */\n  getFederationState(): FederationState;\n\n  /** Get current federation position (B_k) */\n  getPosition(): Units;\n\n  /** Get current exposure cap */\n  getExposureCap(): Units;\n\n  /** Get available capacity (cap - |position|) */\n  getAvailableCapacity(): Units;\n\n  /** Get all connected cells */\n  getConnectedCells(): FederationLink[];\n\n  /** Get specific link to a remote cell */\n  getLink(remoteCellId: CellId): FederationLink | undefined;\n\n  /** Propose a new link to a remote cell */\n  proposeLink(remoteCellId: CellId, terms?: Partial<FederationTerms>): Promise<LinkProposal>;\n\n  /** Accept a link proposal */\n  acceptLink(proposalId: LinkProposalId): Promise<FederationLink>;\n\n  /** Reject a link proposal */\n  rejectLink(proposalId: LinkProposalId, reason: string): Promise<void>;\n\n  /** Suspend a link */\n  suspendLink(remoteCellId: CellId, reason: string): Promise<void>;\n\n  /** Resume a suspended link */\n  resumeLink(remoteCellId: CellId): Promise<void>;\n\n  /** Validate an inter-cell transaction before execution */\n  validateInterCellTx(input: CreateFederationTxInput): Promise<void>;\n\n  /** Execute an inter-cell transaction */\n  executeInterCellTx(input: CreateFederationTxInput): Promise<FederationTxResult>;\n\n  /** Get a transaction by ID */\n  getTransaction(id: FederationTxId): Promise<FederationTransaction | undefined>;\n\n  /** Get transactions with filters */\n  getTransactions(filter?: {\n    remoteCellId?: CellId;\n    status?: FederationTxStatus;\n    since?: Timestamp;\n  }): Promise<FederationTransaction[]>;\n\n  /** Roll back a failed transaction */\n  rollbackTransaction(id: FederationTxId, reason: string): Promise<void>;\n\n  /** Check quarantine status */\n  checkQuarantineStatus(): QuarantineStatus;\n\n  /** Enter quarantine */\n  enterQuarantine(reason: QuarantineReason): Promise<void>;\n\n  /** Exit quarantine (requires conditions to be met) */\n  exitQuarantine(): Promise<void>;\n\n  /** Set exposure cap factor (called by emergency engine) */\n  setExposureCapFactor(betaFactor: number): Promise<void>;\n\n  /** Recalculate exposure cap based on current ledger aggregate capacity */\n  recalculateExposureCap(): Promise<void>;\n\n  /** Analyze current exposure */\n  analyzeExposure(): ExposureAnalysis;\n\n  /** Get clearing account ID */\n  getClearingAccountId(): IdentityId;\n}\n\n// ============================================\n// UTILITY FUNCTIONS\n// ============================================\n\n/** Generate a federation transaction ID */\nexport function generateFederationTxId(): FederationTxId {\n  return `ftx-${generateId()}`;\n}\n\n/** Generate a link proposal ID */\nexport function generateLinkProposalId(): LinkProposalId {\n  return `lp-${generateId()}`;\n}\n", "/**\n * Cell Protocol - Result Type\n *\n * A discriminated union type for representing success or failure,\n * enabling explicit error handling without exceptions.\n */\n\n// ============================================\n// RESULT TYPE\n// ============================================\n\n/** Successful result */\nexport interface Ok<T> {\n  ok: true;\n  value: T;\n}\n\n/** Failed result */\nexport interface Err<E> {\n  ok: false;\n  error: E;\n}\n\n/** Discriminated union of success or failure */\nexport type Result<T, E> = Ok<T> | Err<E>;\n\n// ============================================\n// CONSTRUCTORS\n// ============================================\n\n/** Create a successful result */\nexport function ok<T>(value: T): Ok<T> {\n  return { ok: true, value };\n}\n\n/** Create a failed result */\nexport function err<E>(error: E): Err<E> {\n  return { ok: false, error };\n}\n\n// ============================================\n// TYPE GUARDS\n// ============================================\n\n/** Check if result is successful */\nexport function isOk<T, E>(result: Result<T, E>): result is Ok<T> {\n  return result.ok === true;\n}\n\n/** Check if result is an error */\nexport function isErr<T, E>(result: Result<T, E>): result is Err<E> {\n  return result.ok === false;\n}\n\n// ============================================\n// UTILITY FUNCTIONS\n// ============================================\n\n/** Unwrap a result, throwing if error */\nexport function unwrap<T, E>(result: Result<T, E>): T {\n  if (result.ok) {\n    return result.value;\n  }\n  throw new Error(`Unwrap called on error result: ${JSON.stringify(result.error)}`);\n}\n\n/** Unwrap a result with a default value */\nexport function unwrapOr<T, E>(result: Result<T, E>, defaultValue: T): T {\n  if (result.ok) {\n    return result.value;\n  }\n  return defaultValue;\n}\n\n/** Map over a successful result */\nexport function map<T, U, E>(result: Result<T, E>, fn: (value: T) => U): Result<U, E> {\n  if (result.ok) {\n    return ok(fn(result.value));\n  }\n  return result;\n}\n\n/** Map over an error result */\nexport function mapErr<T, E, F>(result: Result<T, E>, fn: (error: E) => F): Result<T, F> {\n  if (result.ok) {\n    return result;\n  }\n  return err(fn(result.error));\n}\n\n/** Chain results (flatMap) */\nexport function andThen<T, U, E>(\n  result: Result<T, E>,\n  fn: (value: T) => Result<U, E>\n): Result<U, E> {\n  if (result.ok) {\n    return fn(result.value);\n  }\n  return result;\n}\n\n/** Combine multiple results into one */\nexport function all<T, E>(results: Result<T, E>[]): Result<T[], E> {\n  const values: T[] = [];\n  for (const result of results) {\n    if (!result.ok) {\n      return result;\n    }\n    values.push(result.value);\n  }\n  return ok(values);\n}\n\n/** Try to execute a function, catching any thrown errors */\nexport function tryCatch<T, E = Error>(\n  fn: () => T,\n  errorMapper: (e: unknown) => E = (e) => e as E\n): Result<T, E> {\n  try {\n    return ok(fn());\n  } catch (e) {\n    return err(errorMapper(e));\n  }\n}\n\n/** Async version of tryCatch */\nexport async function tryCatchAsync<T, E = Error>(\n  fn: () => Promise<T>,\n  errorMapper: (e: unknown) => E = (e) => e as E\n): Promise<Result<T, E>> {\n  try {\n    return ok(await fn());\n  } catch (e) {\n    return err(errorMapper(e));\n  }\n}\n", "/**\n * Cell Protocol - Ledger Engine\n *\n * Core implementation of the Cell Ledger (PRD-01).\n * Enforces the fundamental invariants:\n * - I1: SUM(balances) = 0 (Conservation Law)\n * - I2: balance_i >= -limit_i (Floor Constraint)\n * - I3: balance_i - reserve_i >= -limit_i (Escrow Safety)\n * - I4: reserve_i >= 0 (Non-negative Reserves)\n */\n\nimport {\n  IdentityId,\n  CellId,\n  Timestamp,\n  Units,\n  MembershipStatus,\n  now,\n} from '../types/common';\nimport {\n  MemberState,\n  CellLedgerState,\n  LedgerParameters,\n  BalanceUpdate,\n  ReserveUpdate,\n  BalanceUpdateResult,\n  LedgerError,\n  LedgerErrorCode,\n  LedgerStatistics,\n  ILedgerEngine,\n} from '../types/ledger';\nimport { Result, ok, err } from '../utils/result';\nimport { IStorage } from '../storage/pouchdb-adapter';\n\n// ============================================\n// LEDGER ENGINE IMPLEMENTATION\n// ============================================\n\nexport class LedgerEngine implements ILedgerEngine {\n  private state: CellLedgerState;\n  private storage: IStorage;\n\n  constructor(\n    cellId: CellId,\n    parameters: Partial<LedgerParameters>,\n    storage: IStorage\n  ) {\n    const fullParams: LedgerParameters = {\n      cellId,\n      defaultLimit: parameters.defaultLimit ?? 100,\n      minLimit: parameters.minLimit ?? 0,\n      maxLimit: parameters.maxLimit ?? 10000,\n      enforceEscrowSafety: parameters.enforceEscrowSafety ?? true,\n    };\n\n    this.state = {\n      cellId,\n      parameters: fullParams,\n      members: new Map(),\n      sequenceNumber: 0,\n      lastUpdated: now(),\n    };\n\n    this.storage = storage;\n  }\n\n  /**\n   * Initialize from storage (load existing state)\n   */\n  async initialize(): Promise<Result<void, LedgerError>> {\n    const result = await this.storage.getLedgerState(this.state.cellId);\n    if (!result.ok) {\n      return err({\n        code: LedgerErrorCode.STORAGE_ERROR,\n        message: result.error.message,\n      });\n    }\n\n    if (result.value) {\n      this.state = result.value;\n    }\n\n    return ok(undefined);\n  }\n\n  /**\n   * Persist state to storage\n   */\n  private async persist(): Promise<Result<void, LedgerError>> {\n    const result = await this.storage.saveLedgerState(this.state);\n    if (!result.ok) {\n      return err({\n        code: LedgerErrorCode.STORAGE_ERROR,\n        message: result.error.message,\n      });\n    }\n    return ok(undefined);\n  }\n\n  // ============================================\n  // QUERY METHODS\n  // ============================================\n\n  getCellId(): CellId {\n    return this.state.cellId;\n  }\n\n  getParameters(): LedgerParameters {\n    return { ...this.state.parameters };\n  }\n\n  getMemberState(memberId: IdentityId): MemberState | undefined {\n    const state = this.state.members.get(memberId);\n    return state ? { ...state } : undefined;\n  }\n\n  getAllMemberStates(): Map<IdentityId, MemberState> {\n    const result = new Map<IdentityId, MemberState>();\n    this.state.members.forEach((state, id) => {\n      result.set(id, { ...state });\n    });\n    return result;\n  }\n\n  /**\n   * Check if a member can spend a given amount\n   * Takes into account: balance, limit, reserve, and escrow safety\n   */\n  canSpend(memberId: IdentityId, amount: Units): boolean {\n    if (amount <= 0) return false;\n\n    const member = this.state.members.get(memberId);\n    if (!member) return false;\n    if (member.status !== MembershipStatus.ACTIVE) return false;\n\n    const availableCapacity = this.getAvailableCapacity(memberId);\n    return amount <= availableCapacity;\n  }\n\n  /**\n   * Get member's available spending capacity\n   * Available = limit + balance - reserve\n   */\n  getAvailableCapacity(memberId: IdentityId): Units {\n    const member = this.state.members.get(memberId);\n    if (!member) return 0;\n\n    // Available capacity = limit + balance - reserve\n    // This is the amount the member can spend before hitting escrow floor\n    return member.limit + member.balance - member.reserve;\n  }\n\n  getMemberCount(): number {\n    return this.state.members.size;\n  }\n\n  // ============================================\n  // MEMBER MANAGEMENT\n  // ============================================\n\n  /**\n   * Add a new member to the ledger\n   */\n  async addMember(memberId: IdentityId, initialLimit?: Units): Promise<MemberState> {\n    if (this.state.members.has(memberId)) {\n      throw new Error(`Member ${memberId} already exists`);\n    }\n\n    const limit = initialLimit ?? this.state.parameters.defaultLimit;\n\n    // Validate limit\n    if (limit < this.state.parameters.minLimit || limit > this.state.parameters.maxLimit) {\n      throw new Error(\n        `Limit ${limit} out of range [${this.state.parameters.minLimit}, ${this.state.parameters.maxLimit}]`\n      );\n    }\n\n    const memberState: MemberState = {\n      memberId,\n      balance: 0, // Always start at zero (conservation law)\n      limit,\n      reserve: 0,\n      status: MembershipStatus.ACTIVE,\n      lastActivity: now(),\n      joinedAt: now(),\n    };\n\n    this.state.members.set(memberId, memberState);\n    this.state.sequenceNumber++;\n    this.state.lastUpdated = now();\n\n    await this.persist();\n\n    // Log event\n    await this.storage.appendEvent({\n      cellId: this.state.cellId,\n      type: 'MEMBER_ADDED',\n      timestamp: now(),\n      data: { memberId, limit },\n    });\n\n    return { ...memberState };\n  }\n\n  /**\n   * Remove a member from the ledger (balance must be zero)\n   */\n  async removeMember(memberId: IdentityId): Promise<void> {\n    const member = this.state.members.get(memberId);\n    if (!member) {\n      throw new Error(`Member ${memberId} not found`);\n    }\n\n    if (member.balance !== 0) {\n      throw new Error(`Cannot remove member with non-zero balance: ${member.balance}`);\n    }\n\n    if (member.reserve !== 0) {\n      throw new Error(`Cannot remove member with active reserves: ${member.reserve}`);\n    }\n\n    this.state.members.delete(memberId);\n    this.state.sequenceNumber++;\n    this.state.lastUpdated = now();\n\n    await this.persist();\n\n    await this.storage.appendEvent({\n      cellId: this.state.cellId,\n      type: 'MEMBER_REMOVED',\n      timestamp: now(),\n      data: { memberId },\n    });\n  }\n\n  // ============================================\n  // BALANCE OPERATIONS (ATOMIC)\n  // ============================================\n\n  /**\n   * Apply atomic balance updates\n   *\n   * CRITICAL INVARIANTS ENFORCED:\n   * - I1: SUM(deltas) must equal 0 (Conservation Law)\n   * - I2: newBalance >= -limit for all members (Floor Constraint)\n   * - I3: newBalance - reserve >= -limit (Escrow Safety, if enabled)\n   */\n  async applyBalanceUpdates(updates: BalanceUpdate[]): Promise<BalanceUpdateResult[]> {\n    if (updates.length === 0) {\n      return [];\n    }\n\n    // =========================================\n    // INVARIANT I1: Conservation Check\n    // =========================================\n    const sumDeltas = updates.reduce((sum, u) => sum + u.delta, 0);\n    if (sumDeltas !== 0) {\n      throw new LedgerViolationError({\n        code: LedgerErrorCode.CONSERVATION_VIOLATION,\n        message: `Sum of deltas is ${sumDeltas}, must be 0`,\n        details: { sumDeltas, updates },\n      });\n    }\n\n    // =========================================\n    // VALIDATION PHASE\n    // =========================================\n    const validationResults: Array<{\n      update: BalanceUpdate;\n      member: MemberState;\n      newBalance: Units;\n    }> = [];\n\n    for (const update of updates) {\n      const member = this.state.members.get(update.memberId);\n\n      // Member must exist\n      if (!member) {\n        throw new LedgerViolationError({\n          code: LedgerErrorCode.MEMBER_NOT_FOUND,\n          message: `Member ${update.memberId} not found`,\n          details: { memberId: update.memberId },\n        });\n      }\n\n      // Member must be active\n      if (member.status !== MembershipStatus.ACTIVE) {\n        throw new LedgerViolationError({\n          code: LedgerErrorCode.MEMBER_NOT_ACTIVE,\n          message: `Member ${update.memberId} is not active (status: ${member.status})`,\n          details: { memberId: update.memberId, status: member.status },\n        });\n      }\n\n      const newBalance = member.balance + update.delta;\n\n      // =========================================\n      // INVARIANT I2: Floor Constraint\n      // =========================================\n      if (newBalance < -member.limit) {\n        throw new LedgerViolationError({\n          code: LedgerErrorCode.FLOOR_VIOLATION,\n          message: `Balance ${newBalance} would breach floor -${member.limit} for member ${update.memberId}`,\n          details: {\n            memberId: update.memberId,\n            currentBalance: member.balance,\n            delta: update.delta,\n            newBalance,\n            limit: member.limit,\n            floor: -member.limit,\n          },\n        });\n      }\n\n      // =========================================\n      // INVARIANT I3: Escrow Safety\n      // =========================================\n      if (this.state.parameters.enforceEscrowSafety) {\n        const escrowFloor = -member.limit + member.reserve;\n        if (newBalance < escrowFloor) {\n          throw new LedgerViolationError({\n            code: LedgerErrorCode.ESCROW_VIOLATION,\n            message: `Balance ${newBalance} would breach escrow floor ${escrowFloor} for member ${update.memberId}`,\n            details: {\n              memberId: update.memberId,\n              currentBalance: member.balance,\n              delta: update.delta,\n              newBalance,\n              reserve: member.reserve,\n              escrowFloor,\n            },\n          });\n        }\n      }\n\n      validationResults.push({ update, member, newBalance });\n    }\n\n    // =========================================\n    // COMMIT PHASE (all validations passed)\n    // =========================================\n    const results: BalanceUpdateResult[] = [];\n    const timestamp = now();\n\n    for (const { update, member, newBalance } of validationResults) {\n      const previousBalance = member.balance;\n\n      // Update in place\n      member.balance = newBalance;\n      member.lastActivity = timestamp;\n\n      results.push({\n        success: true,\n        newBalance,\n        previousBalance,\n        sequenceNumber: ++this.state.sequenceNumber,\n      });\n    }\n\n    this.state.lastUpdated = timestamp;\n    await this.persist();\n\n    // Log the balance update event\n    await this.storage.appendEvent({\n      cellId: this.state.cellId,\n      type: 'BALANCE_UPDATES',\n      timestamp,\n      data: {\n        updates: updates.map((u, i) => ({\n          memberId: u.memberId,\n          delta: u.delta,\n          reason: u.reason,\n          referenceId: u.referenceId,\n          newBalance: results[i].newBalance,\n        })),\n      },\n    });\n\n    return results;\n  }\n\n  /**\n   * Apply a reserve update (for escrow/commitments)\n   *\n   * INVARIANT I4: reserve >= 0\n   */\n  async applyReserveUpdate(update: ReserveUpdate): Promise<void> {\n    const member = this.state.members.get(update.memberId);\n\n    if (!member) {\n      throw new LedgerViolationError({\n        code: LedgerErrorCode.MEMBER_NOT_FOUND,\n        message: `Member ${update.memberId} not found`,\n      });\n    }\n\n    const newReserve = member.reserve + update.delta;\n\n    // =========================================\n    // INVARIANT I4: Non-negative Reserves\n    // =========================================\n    if (newReserve < 0) {\n      throw new LedgerViolationError({\n        code: LedgerErrorCode.NEGATIVE_RESERVE,\n        message: `Reserve ${newReserve} would be negative for member ${update.memberId}`,\n        details: {\n          memberId: update.memberId,\n          currentReserve: member.reserve,\n          delta: update.delta,\n          newReserve,\n        },\n      });\n    }\n\n    // =========================================\n    // INVARIANT I3: Escrow Safety (increasing reserve)\n    // =========================================\n    if (update.delta > 0 && this.state.parameters.enforceEscrowSafety) {\n      const escrowFloor = -member.limit + newReserve;\n      if (member.balance < escrowFloor) {\n        throw new LedgerViolationError({\n          code: LedgerErrorCode.ESCROW_VIOLATION,\n          message: `Cannot reserve ${update.delta}: would breach escrow floor`,\n          details: {\n            memberId: update.memberId,\n            balance: member.balance,\n            newReserve,\n            escrowFloor,\n          },\n        });\n      }\n    }\n\n    member.reserve = newReserve;\n    member.lastActivity = now();\n    this.state.sequenceNumber++;\n    this.state.lastUpdated = now();\n\n    await this.persist();\n\n    await this.storage.appendEvent({\n      cellId: this.state.cellId,\n      type: 'RESERVE_UPDATE',\n      timestamp: now(),\n      data: {\n        memberId: update.memberId,\n        delta: update.delta,\n        reason: update.reason,\n        commitmentId: update.commitmentId,\n        newReserve,\n      },\n    });\n  }\n\n  // ============================================\n  // LIMIT & STATUS MANAGEMENT\n  // ============================================\n\n  /**\n   * Update a member's credit limit\n   */\n  async updateMemberLimit(memberId: IdentityId, newLimit: Units): Promise<void> {\n    const member = this.state.members.get(memberId);\n    if (!member) {\n      throw new LedgerViolationError({\n        code: LedgerErrorCode.MEMBER_NOT_FOUND,\n        message: `Member ${memberId} not found`,\n      });\n    }\n\n    // Validate limit range\n    if (newLimit < this.state.parameters.minLimit || newLimit > this.state.parameters.maxLimit) {\n      throw new LedgerViolationError({\n        code: LedgerErrorCode.INVALID_AMOUNT,\n        message: `Limit ${newLimit} out of range [${this.state.parameters.minLimit}, ${this.state.parameters.maxLimit}]`,\n      });\n    }\n\n    // Check that reducing limit doesn't breach floor\n    if (newLimit < member.limit) {\n      const newFloor = -newLimit;\n      if (member.balance < newFloor) {\n        throw new LedgerViolationError({\n          code: LedgerErrorCode.FLOOR_VIOLATION,\n          message: `Cannot reduce limit: current balance ${member.balance} would breach new floor ${newFloor}`,\n        });\n      }\n    }\n\n    const oldLimit = member.limit;\n    member.limit = newLimit;\n    member.lastActivity = now();\n    this.state.sequenceNumber++;\n    this.state.lastUpdated = now();\n\n    await this.persist();\n\n    await this.storage.appendEvent({\n      cellId: this.state.cellId,\n      type: 'LIMIT_UPDATED',\n      timestamp: now(),\n      data: { memberId, oldLimit, newLimit },\n    });\n  }\n\n  /**\n   * Update a member's status\n   */\n  async updateMemberStatus(memberId: IdentityId, status: MembershipStatus): Promise<void> {\n    const member = this.state.members.get(memberId);\n    if (!member) {\n      throw new LedgerViolationError({\n        code: LedgerErrorCode.MEMBER_NOT_FOUND,\n        message: `Member ${memberId} not found`,\n      });\n    }\n\n    const oldStatus = member.status;\n    member.status = status;\n    member.lastActivity = now();\n    this.state.sequenceNumber++;\n    this.state.lastUpdated = now();\n\n    await this.persist();\n\n    await this.storage.appendEvent({\n      cellId: this.state.cellId,\n      type: 'STATUS_UPDATED',\n      timestamp: now(),\n      data: { memberId, oldStatus, newStatus: status },\n    });\n  }\n\n  // ============================================\n  // VERIFICATION METHODS\n  // ============================================\n\n  /**\n   * Verify conservation law: SUM(balances) = 0\n   */\n  verifyConservation(): boolean {\n    let sum = 0;\n    this.state.members.forEach(member => {\n      sum += member.balance;\n    });\n    return sum === 0;\n  }\n\n  /**\n   * Verify all floor constraints: balance >= -limit for all members\n   */\n  verifyAllFloors(): boolean {\n    for (const member of this.state.members.values()) {\n      if (member.balance < -member.limit) {\n        return false;\n      }\n    }\n    return true;\n  }\n\n  // ============================================\n  // STATISTICS\n  // ============================================\n\n  /**\n   * Get aggregate statistics for the ledger\n   */\n  getStatistics(): LedgerStatistics {\n    let positiveBalanceSum = 0;\n    let negativeBalanceSum = 0;\n    let aggregateCapacity = 0;\n    let floorMass = 0;\n    let totalReserved = 0;\n    let balanceSum = 0;\n    let activeMemberCount = 0;\n\n    this.state.members.forEach(member => {\n      balanceSum += member.balance;\n      aggregateCapacity += member.limit;\n      totalReserved += member.reserve;\n\n      if (member.balance > 0) {\n        positiveBalanceSum += member.balance;\n      } else {\n        negativeBalanceSum += Math.abs(member.balance);\n      }\n\n      // Floor mass: sum of limits for members at floor\n      if (member.balance <= -member.limit) {\n        floorMass += member.limit;\n      }\n\n      if (member.status === MembershipStatus.ACTIVE) {\n        activeMemberCount++;\n      }\n    });\n\n    return {\n      memberCount: this.state.members.size,\n      activeMemberCount,\n      positiveBalanceSum,\n      negativeBalanceSum,\n      aggregateCapacity,\n      floorMass,\n      totalReserved,\n      balanceSum,\n    };\n  }\n}\n\n// ============================================\n// CUSTOM ERROR CLASS\n// ============================================\n\nexport class LedgerViolationError extends Error {\n  public readonly code: LedgerErrorCode;\n  public readonly details?: Record<string, unknown>;\n\n  constructor(error: LedgerError) {\n    super(error.message);\n    this.name = 'LedgerViolationError';\n    this.code = error.code;\n    this.details = error.details;\n  }\n\n  toJSON(): LedgerError {\n    return {\n      code: this.code,\n      message: this.message,\n      details: this.details,\n    };\n  }\n}\n\n// ============================================\n// FACTORY\n// ============================================\n\n/**\n * Create a new ledger engine\n */\nexport async function createLedgerEngine(\n  cellId: CellId,\n  parameters: Partial<LedgerParameters>,\n  storage: IStorage\n): Promise<LedgerEngine> {\n  const engine = new LedgerEngine(cellId, parameters, storage);\n  await engine.initialize();\n  return engine;\n}\n", "/**\n * Cell Protocol - Crypto Adapter\n *\n * TypeScript wrapper around existing OGCrypto module (pwa/js/crypto.js).\n * Provides Ed25519 signing, verification, and key management.\n */\n\nimport { PublicKey, Signature, SecretKey, IdentityId } from '../types/common';\nimport { Result, ok, err, tryCatchAsync } from '../utils/result';\n\n// ============================================\n// TYPES\n// ============================================\n\nexport interface KeyPair {\n  publicKey: PublicKey;\n  secretKey: SecretKey;\n}\n\nexport interface CryptoError {\n  code: 'KEY_GENERATION_FAILED' | 'SIGNING_FAILED' | 'VERIFICATION_FAILED' | 'NOT_INITIALIZED';\n  message: string;\n}\n\n// ============================================\n// NACL INTERFACE (for browser/node compatibility)\n// ============================================\n\n/** Interface for sign.detached which is both a function and has a verify method */\ninterface SignDetached {\n  (message: Uint8Array, secretKey: Uint8Array): Uint8Array;\n  verify(message: Uint8Array, signature: Uint8Array, publicKey: Uint8Array): boolean;\n}\n\n/** Interface for TweetNaCl library */\ninterface NaCl {\n  sign: {\n    keyPair(): { publicKey: Uint8Array; secretKey: Uint8Array };\n    detached: SignDetached;\n  };\n  randomBytes(n: number): Uint8Array;\n  util?: {\n    encodeBase64(bytes: Uint8Array): string;\n    decodeBase64(str: string): Uint8Array;\n  };\n}\n\n// Global nacl reference (set by initialize)\nlet nacl: NaCl | undefined;\n\n// ============================================\n// ENCODING UTILITIES\n// ============================================\n\n/**\n * Encode Uint8Array to base64\n */\nexport function encodeBase64(bytes: Uint8Array): string {\n  if (nacl?.util?.encodeBase64) {\n    return nacl.util.encodeBase64(bytes);\n  }\n  // Node.js Buffer fallback\n  if (typeof Buffer !== 'undefined') {\n    return Buffer.from(bytes).toString('base64');\n  }\n  // Browser fallback\n  return btoa(String.fromCharCode.apply(null, Array.from(bytes)));\n}\n\n/**\n * Decode base64 to Uint8Array\n */\nexport function decodeBase64(str: string): Uint8Array {\n  if (nacl?.util?.decodeBase64) {\n    return nacl.util.decodeBase64(str);\n  }\n  // Node.js Buffer fallback\n  if (typeof Buffer !== 'undefined') {\n    return new Uint8Array(Buffer.from(str, 'base64'));\n  }\n  // Browser fallback\n  const binary = atob(str);\n  const bytes = new Uint8Array(binary.length);\n  for (let i = 0; i < binary.length; i++) {\n    bytes[i] = binary.charCodeAt(i);\n  }\n  return bytes;\n}\n\n/**\n * Encode Uint8Array to hex string\n */\nexport function encodeHex(bytes: Uint8Array): string {\n  return Array.from(bytes)\n    .map(b => b.toString(16).padStart(2, '0'))\n    .join('');\n}\n\n/**\n * Decode hex string to Uint8Array\n */\nexport function decodeHex(str: string): Uint8Array {\n  const bytes = new Uint8Array(str.length / 2);\n  for (let i = 0; i < str.length; i += 2) {\n    bytes[i / 2] = parseInt(str.substr(i, 2), 16);\n  }\n  return bytes;\n}\n\n// ============================================\n// CRYPTO ADAPTER CLASS\n// ============================================\n\nexport class CryptoAdapter {\n  private initialized = false;\n\n  /**\n   * Initialize the crypto adapter with NaCl library\n   */\n  async initialize(naclInstance?: NaCl): Promise<Result<void, CryptoError>> {\n    try {\n      if (naclInstance) {\n        nacl = naclInstance;\n      } else if (typeof globalThis !== 'undefined' && (globalThis as any).nacl) {\n        nacl = (globalThis as any).nacl;\n      } else {\n        // Try to import tweetnacl for Node.js\n        try {\n          const tweetnacl = await import('tweetnacl');\n          nacl = tweetnacl.default || tweetnacl;\n        } catch {\n          return err({\n            code: 'NOT_INITIALIZED',\n            message: 'TweetNaCl not available. Please provide naclInstance or install tweetnacl.',\n          });\n        }\n      }\n      this.initialized = true;\n      return ok(undefined);\n    } catch (e) {\n      return err({\n        code: 'NOT_INITIALIZED',\n        message: `Failed to initialize crypto: ${e}`,\n      });\n    }\n  }\n\n  /**\n   * Check if adapter is initialized\n   */\n  isInitialized(): boolean {\n    return this.initialized && nacl !== undefined;\n  }\n\n  /**\n   * Generate a new Ed25519 keypair\n   */\n  generateKeyPair(): Result<KeyPair, CryptoError> {\n    if (!this.isInitialized() || !nacl) {\n      return err({ code: 'NOT_INITIALIZED', message: 'Crypto not initialized' });\n    }\n\n    try {\n      const keypair = nacl.sign.keyPair();\n      return ok({\n        publicKey: encodeBase64(keypair.publicKey),\n        secretKey: encodeBase64(keypair.secretKey),\n      });\n    } catch (e) {\n      return err({\n        code: 'KEY_GENERATION_FAILED',\n        message: `Key generation failed: ${e}`,\n      });\n    }\n  }\n\n  /**\n   * Derive identity ID from public key\n   * Uses first 16 bytes of public key as hex string\n   */\n  deriveIdentityId(publicKey: PublicKey): IdentityId {\n    const bytes = decodeBase64(publicKey);\n    return encodeHex(bytes.slice(0, 16));\n  }\n\n  /**\n   * Sign a message with a secret key\n   */\n  sign(message: string | object, secretKey: SecretKey): Result<Signature, CryptoError> {\n    if (!this.isInitialized() || !nacl) {\n      return err({ code: 'NOT_INITIALIZED', message: 'Crypto not initialized' });\n    }\n\n    try {\n      const messageStr = typeof message === 'string' ? message : JSON.stringify(message);\n      const messageBytes = new TextEncoder().encode(messageStr);\n      const secretKeyBytes = decodeBase64(secretKey);\n\n      const signature = nacl.sign.detached(messageBytes, secretKeyBytes);\n      return ok(encodeBase64(signature));\n    } catch (e) {\n      return err({\n        code: 'SIGNING_FAILED',\n        message: `Signing failed: ${e}`,\n      });\n    }\n  }\n\n  /**\n   * Verify a signature\n   */\n  verify(message: string | object, signature: Signature, publicKey: PublicKey): boolean {\n    if (!this.isInitialized() || !nacl) {\n      return false;\n    }\n\n    try {\n      const messageStr = typeof message === 'string' ? message : JSON.stringify(message);\n      const messageBytes = new TextEncoder().encode(messageStr);\n      const signatureBytes = decodeBase64(signature);\n      const publicKeyBytes = decodeBase64(publicKey);\n\n      return nacl.sign.detached.verify(messageBytes, signatureBytes, publicKeyBytes);\n    } catch {\n      return false;\n    }\n  }\n\n  /**\n   * Generate a random nonce (hex string)\n   */\n  generateNonce(byteLength: number = 16): string {\n    if (!this.isInitialized() || !nacl) {\n      // Fallback to Math.random for nonce generation\n      const bytes = new Uint8Array(byteLength);\n      for (let i = 0; i < byteLength; i++) {\n        bytes[i] = Math.floor(Math.random() * 256);\n      }\n      return encodeHex(bytes);\n    }\n\n    const bytes = nacl.randomBytes(byteLength);\n    return encodeHex(bytes);\n  }\n\n  /**\n   * Generate a random ID\n   */\n  generateId(): string {\n    const timestamp = Date.now().toString(36);\n    const nonce = this.generateNonce(8);\n    return `${timestamp}-${nonce}`;\n  }\n}\n\n// ============================================\n// SINGLETON INSTANCE\n// ============================================\n\n/** Default crypto adapter instance */\nexport const cryptoAdapter = new CryptoAdapter();\n\n// ============================================\n// CONVENIENCE FUNCTIONS\n// ============================================\n\n/**\n * Create canonical signing data for a transaction\n */\nexport function createTransactionSigningData(data: {\n  payer: IdentityId;\n  payee: IdentityId;\n  amount: number;\n  description: string;\n  createdAt: number;\n  nonce: string;\n}): string {\n  return JSON.stringify({\n    payer: data.payer,\n    payee: data.payee,\n    amount: data.amount,\n    description: data.description,\n    createdAt: data.createdAt,\n    nonce: data.nonce,\n  });\n}\n\n/**\n * Sign transaction data\n */\nexport function signTransaction(\n  data: {\n    payer: IdentityId;\n    payee: IdentityId;\n    amount: number;\n    description: string;\n    createdAt: number;\n    nonce: string;\n  },\n  secretKey: SecretKey\n): Result<Signature, CryptoError> {\n  const message = createTransactionSigningData(data);\n  return cryptoAdapter.sign(message, secretKey);\n}\n\n/**\n * Verify transaction signature\n */\nexport function verifyTransactionSignature(\n  data: {\n    payer: IdentityId;\n    payee: IdentityId;\n    amount: number;\n    description: string;\n    createdAt: number;\n    nonce: string;\n  },\n  signature: Signature,\n  publicKey: PublicKey\n): boolean {\n  const message = createTransactionSigningData(data);\n  return cryptoAdapter.verify(message, signature, publicKey);\n}\n", "/**\n * Cell Protocol - Transaction Engine\n *\n * Implementation of the Transaction System (PRD-02).\n * Handles spot transactions with dual-signature verification.\n */\n\nimport {\n  IdentityId,\n  TransactionId,\n  Timestamp,\n  Units,\n  Signature,\n  MembershipStatus,\n  BalanceChangeReason,\n  now,\n  generateId,\n} from '../types/common';\nimport {\n  SpotTransaction,\n  TransactionType,\n  TransactionStatus,\n  TransactionSignatures,\n  CreateSpotTransactionInput,\n  TransactionSigningData,\n  TransactionResult,\n  TransactionError,\n  TransactionErrorCode,\n  QueuedTransaction,\n  ITransactionEngine,\n} from '../types/transaction';\nimport { BalanceUpdate } from '../types/ledger';\nimport { Result, ok, err } from '../utils/result';\nimport { IStorage } from '../storage/pouchdb-adapter';\nimport { LedgerEngine, LedgerViolationError } from './ledger-engine';\nimport {\n  CryptoAdapter,\n  createTransactionSigningData,\n} from '../crypto/crypto-adapter';\n\n// ============================================\n// TRANSACTION ENGINE IMPLEMENTATION\n// ============================================\n\nexport class TransactionEngine implements ITransactionEngine {\n  private ledger: LedgerEngine;\n  private storage: IStorage;\n  private crypto: CryptoAdapter;\n  private publicKeyResolver: (memberId: IdentityId) => Promise<string | undefined>;\n\n  constructor(\n    ledger: LedgerEngine,\n    storage: IStorage,\n    crypto: CryptoAdapter,\n    publicKeyResolver: (memberId: IdentityId) => Promise<string | undefined>\n  ) {\n    this.ledger = ledger;\n    this.storage = storage;\n    this.crypto = crypto;\n    this.publicKeyResolver = publicKeyResolver;\n  }\n\n  // ============================================\n  // TRANSACTION CREATION\n  // ============================================\n\n  /**\n   * Create a new spot transaction (unsigned)\n   */\n  async createSpotTransaction(input: CreateSpotTransactionInput): Promise<SpotTransaction> {\n    // Generate unique ID and nonce\n    const id = generateId();\n    const nonce = this.crypto.generateNonce();\n    const createdAt = now();\n\n    // Validate input\n    const validationError = this.validateInput(input);\n    if (validationError) {\n      throw new TransactionValidationError(validationError);\n    }\n\n    const transaction: SpotTransaction = {\n      id,\n      type: TransactionType.SPOT,\n      payer: input.payer,\n      payee: input.payee,\n      amount: input.amount,\n      description: input.description,\n      createdAt,\n      status: TransactionStatus.PENDING,\n      signatures: {},\n      nonce,\n    };\n\n    // Save to storage\n    const result = await this.storage.saveTransaction(transaction);\n    if (!result.ok) {\n      throw new Error(`Failed to save transaction: ${result.error.message}`);\n    }\n\n    return transaction;\n  }\n\n  /**\n   * Validate transaction input\n   */\n  private validateInput(input: CreateSpotTransactionInput): TransactionError | null {\n    // Self-transaction check\n    if (input.payer === input.payee) {\n      return {\n        code: TransactionErrorCode.SELF_TRANSACTION,\n        message: 'Cannot pay yourself',\n      };\n    }\n\n    // Positive amount check\n    if (input.amount <= 0) {\n      return {\n        code: TransactionErrorCode.INVALID_AMOUNT,\n        message: 'Amount must be positive',\n        details: { amount: input.amount },\n      };\n    }\n\n    // Check payer membership\n    const payerState = this.ledger.getMemberState(input.payer);\n    if (!payerState) {\n      return {\n        code: TransactionErrorCode.PAYER_NOT_MEMBER,\n        message: `Payer ${input.payer} is not a member`,\n      };\n    }\n    if (payerState.status !== MembershipStatus.ACTIVE) {\n      return {\n        code: TransactionErrorCode.PAYER_NOT_MEMBER,\n        message: `Payer ${input.payer} is not active (status: ${payerState.status})`,\n      };\n    }\n\n    // Check payee membership\n    const payeeState = this.ledger.getMemberState(input.payee);\n    if (!payeeState) {\n      return {\n        code: TransactionErrorCode.PAYEE_NOT_MEMBER,\n        message: `Payee ${input.payee} is not a member`,\n      };\n    }\n    if (payeeState.status !== MembershipStatus.ACTIVE) {\n      return {\n        code: TransactionErrorCode.PAYEE_NOT_MEMBER,\n        message: `Payee ${input.payee} is not active (status: ${payeeState.status})`,\n      };\n    }\n\n    // Check spending capacity\n    if (!this.ledger.canSpend(input.payer, input.amount)) {\n      const capacity = this.ledger.getAvailableCapacity(input.payer);\n      return {\n        code: TransactionErrorCode.INSUFFICIENT_CAPACITY,\n        message: `Payer has insufficient capacity. Available: ${capacity}, Required: ${input.amount}`,\n        details: {\n          availableCapacity: capacity,\n          requestedAmount: input.amount,\n        },\n      };\n    }\n\n    return null;\n  }\n\n  // ============================================\n  // TRANSACTION RETRIEVAL\n  // ============================================\n\n  /**\n   * Get a transaction by ID\n   */\n  async getTransaction(id: TransactionId): Promise<SpotTransaction | undefined> {\n    const result = await this.storage.getTransaction(id);\n    if (!result.ok) {\n      throw new Error(`Failed to get transaction: ${result.error.message}`);\n    }\n    return result.value ?? undefined;\n  }\n\n  // ============================================\n  // SIGNATURE HANDLING\n  // ============================================\n\n  /**\n   * Get the canonical signing data for a transaction\n   */\n  getSigningData(transaction: SpotTransaction): TransactionSigningData {\n    return {\n      payer: transaction.payer,\n      payee: transaction.payee,\n      amount: transaction.amount,\n      description: transaction.description,\n      createdAt: transaction.createdAt,\n      nonce: transaction.nonce,\n    };\n  }\n\n  /**\n   * Add payer signature to transaction\n   */\n  async signAsPayer(id: TransactionId, signature: Signature): Promise<SpotTransaction> {\n    const transaction = await this.getTransaction(id);\n    if (!transaction) {\n      throw new TransactionValidationError({\n        code: TransactionErrorCode.NOT_FOUND,\n        message: `Transaction ${id} not found`,\n      });\n    }\n\n    if (transaction.status !== TransactionStatus.PENDING) {\n      throw new TransactionValidationError({\n        code: TransactionErrorCode.INVALID_STATUS,\n        message: `Cannot sign transaction in status ${transaction.status}`,\n      });\n    }\n\n    // Verify signature\n    const publicKey = await this.publicKeyResolver(transaction.payer);\n    if (!publicKey) {\n      throw new TransactionValidationError({\n        code: TransactionErrorCode.INVALID_PAYER_SIGNATURE,\n        message: `Could not resolve public key for payer ${transaction.payer}`,\n      });\n    }\n\n    const signingData = this.getSigningData(transaction);\n    const message = createTransactionSigningData(signingData);\n    const isValid = this.crypto.verify(message, signature, publicKey);\n\n    if (!isValid) {\n      throw new TransactionValidationError({\n        code: TransactionErrorCode.INVALID_PAYER_SIGNATURE,\n        message: 'Invalid payer signature',\n      });\n    }\n\n    // Update transaction\n    transaction.signatures.payer = signature;\n\n    // Update status if both signatures present\n    if (transaction.signatures.payee) {\n      transaction.status = TransactionStatus.READY;\n    }\n\n    await this.storage.saveTransaction(transaction);\n    return transaction;\n  }\n\n  /**\n   * Add payee signature to transaction\n   */\n  async signAsPayee(id: TransactionId, signature: Signature): Promise<SpotTransaction> {\n    const transaction = await this.getTransaction(id);\n    if (!transaction) {\n      throw new TransactionValidationError({\n        code: TransactionErrorCode.NOT_FOUND,\n        message: `Transaction ${id} not found`,\n      });\n    }\n\n    if (transaction.status !== TransactionStatus.PENDING) {\n      throw new TransactionValidationError({\n        code: TransactionErrorCode.INVALID_STATUS,\n        message: `Cannot sign transaction in status ${transaction.status}`,\n      });\n    }\n\n    // Verify signature\n    const publicKey = await this.publicKeyResolver(transaction.payee);\n    if (!publicKey) {\n      throw new TransactionValidationError({\n        code: TransactionErrorCode.INVALID_PAYEE_SIGNATURE,\n        message: `Could not resolve public key for payee ${transaction.payee}`,\n      });\n    }\n\n    const signingData = this.getSigningData(transaction);\n    const message = createTransactionSigningData(signingData);\n    const isValid = this.crypto.verify(message, signature, publicKey);\n\n    if (!isValid) {\n      throw new TransactionValidationError({\n        code: TransactionErrorCode.INVALID_PAYEE_SIGNATURE,\n        message: 'Invalid payee signature',\n      });\n    }\n\n    // Update transaction\n    transaction.signatures.payee = signature;\n\n    // Update status if both signatures present\n    if (transaction.signatures.payer) {\n      transaction.status = TransactionStatus.READY;\n    }\n\n    await this.storage.saveTransaction(transaction);\n    return transaction;\n  }\n\n  // ============================================\n  // TRANSACTION EXECUTION\n  // ============================================\n\n  /**\n   * Execute a fully signed transaction\n   */\n  async executeTransaction(id: TransactionId): Promise<TransactionResult> {\n    const transaction = await this.getTransaction(id);\n    if (!transaction) {\n      throw new TransactionValidationError({\n        code: TransactionErrorCode.NOT_FOUND,\n        message: `Transaction ${id} not found`,\n      });\n    }\n\n    // Validate before execution\n    const validationError = this.validateTransaction(transaction);\n    if (validationError) {\n      transaction.status = TransactionStatus.FAILED;\n      await this.storage.saveTransaction(transaction);\n      throw new TransactionValidationError(validationError);\n    }\n\n    // Prepare balance updates\n    const updates: BalanceUpdate[] = [\n      {\n        memberId: transaction.payer,\n        delta: -transaction.amount,\n        reason: BalanceChangeReason.SPOT_TRANSACTION_PAYER,\n        referenceId: transaction.id,\n      },\n      {\n        memberId: transaction.payee,\n        delta: +transaction.amount,\n        reason: BalanceChangeReason.SPOT_TRANSACTION_PAYEE,\n        referenceId: transaction.id,\n      },\n    ];\n\n    // Execute atomic balance update\n    try {\n      const results = await this.ledger.applyBalanceUpdates(updates);\n\n      // Update transaction status\n      transaction.status = TransactionStatus.EXECUTED;\n      transaction.executedAt = now();\n      await this.storage.saveTransaction(transaction);\n\n      return {\n        transaction,\n        payerNewBalance: results[0].newBalance,\n        payeeNewBalance: results[1].newBalance,\n        sequenceNumber: results[0].sequenceNumber,\n      };\n    } catch (e) {\n      // Mark as failed\n      transaction.status = TransactionStatus.FAILED;\n      await this.storage.saveTransaction(transaction);\n\n      if (e instanceof LedgerViolationError) {\n        throw new TransactionValidationError({\n          code: TransactionErrorCode.LEDGER_ERROR,\n          message: e.message,\n          details: e.details,\n        });\n      }\n      throw e;\n    }\n  }\n\n  /**\n   * Validate a transaction without executing\n   */\n  validateTransaction(transaction: SpotTransaction): TransactionError | null {\n    // Check status\n    if (transaction.status !== TransactionStatus.PENDING &&\n        transaction.status !== TransactionStatus.READY) {\n      return {\n        code: TransactionErrorCode.INVALID_STATUS,\n        message: `Transaction in invalid status for execution: ${transaction.status}`,\n      };\n    }\n\n    // Check signatures\n    if (!transaction.signatures.payer) {\n      return {\n        code: TransactionErrorCode.INVALID_PAYER_SIGNATURE,\n        message: 'Missing payer signature',\n      };\n    }\n\n    if (!transaction.signatures.payee) {\n      return {\n        code: TransactionErrorCode.INVALID_PAYEE_SIGNATURE,\n        message: 'Missing payee signature',\n      };\n    }\n\n    // Re-validate input (state may have changed)\n    return this.validateInput({\n      payer: transaction.payer,\n      payee: transaction.payee,\n      amount: transaction.amount,\n      description: transaction.description,\n    });\n  }\n\n  // ============================================\n  // OFFLINE QUEUE\n  // ============================================\n\n  /**\n   * Queue a transaction for offline execution\n   */\n  async queueForOffline(transaction: SpotTransaction): Promise<void> {\n    const queued: QueuedTransaction = {\n      transaction,\n      queuedAt: now(),\n      attempts: 0,\n    };\n\n    const result = await this.storage.queueTransaction(queued);\n    if (!result.ok) {\n      throw new Error(`Failed to queue transaction: ${result.error.message}`);\n    }\n  }\n\n  /**\n   * Get all queued transactions\n   */\n  async getOfflineQueue(): Promise<QueuedTransaction[]> {\n    const result = await this.storage.getQueuedTransactions();\n    if (!result.ok) {\n      throw new Error(`Failed to get offline queue: ${result.error.message}`);\n    }\n    return result.value;\n  }\n\n  /**\n   * Process offline queue\n   */\n  async processOfflineQueue(): Promise<TransactionResult[]> {\n    const queued = await this.getOfflineQueue();\n    const results: TransactionResult[] = [];\n\n    for (const item of queued) {\n      try {\n        // Try to execute\n        const result = await this.executeTransaction(item.transaction.id);\n        results.push(result);\n\n        // Remove from queue on success\n        await this.storage.removeFromQueue(item.transaction.id);\n      } catch (e) {\n        // Update attempt count\n        item.attempts++;\n        if (e instanceof TransactionValidationError) {\n          item.lastError = e.toJSON();\n        }\n        await this.storage.queueTransaction(item);\n      }\n    }\n\n    return results;\n  }\n\n  // ============================================\n  // HISTORY\n  // ============================================\n\n  /**\n   * Get transaction history for a member\n   */\n  async getMemberTransactions(\n    memberId: IdentityId,\n    limit: number = 100,\n    offset: number = 0\n  ): Promise<SpotTransaction[]> {\n    const result = await this.storage.getTransactionsByMember(memberId, limit, offset);\n    if (!result.ok) {\n      throw new Error(`Failed to get transactions: ${result.error.message}`);\n    }\n    return result.value;\n  }\n}\n\n// ============================================\n// CUSTOM ERROR CLASS\n// ============================================\n\nexport class TransactionValidationError extends Error {\n  public readonly code: TransactionErrorCode;\n  public readonly details?: Record<string, unknown>;\n\n  constructor(error: TransactionError) {\n    super(error.message);\n    this.name = 'TransactionValidationError';\n    this.code = error.code;\n    this.details = error.details;\n  }\n\n  toJSON(): TransactionError {\n    return {\n      code: this.code,\n      message: this.message,\n      details: this.details,\n    };\n  }\n}\n\n// ============================================\n// FACTORY\n// ============================================\n\n/**\n * Create a new transaction engine\n */\nexport function createTransactionEngine(\n  ledger: LedgerEngine,\n  storage: IStorage,\n  crypto: CryptoAdapter,\n  publicKeyResolver: (memberId: IdentityId) => Promise<string | undefined>\n): TransactionEngine {\n  return new TransactionEngine(ledger, storage, crypto, publicKeyResolver);\n}\n", "/**\n * Cell Protocol - Identity Engine\n *\n * Implementation of Identity & Membership management (PRD-04).\n * Handles identity creation, admission, and membership status.\n */\n\nimport {\n  IdentityId,\n  CellId,\n  Timestamp,\n  PublicKey,\n  MembershipStatus,\n  Units,\n  now,\n} from '../types/common';\nimport {\n  CellIdentity,\n  AdmissionInfo,\n  AdmissionResult,\n  AdmissionResultExtended,\n  MembershipChange,\n  IdentityError,\n  IdentityErrorCode,\n  MemberSearchCriteria,\n  MemberSearchResult,\n  IIdentityEngine,\n} from '../types/identity';\nimport { Result, ok, err } from '../utils/result';\nimport { IStorage } from '../storage/pouchdb-adapter';\nimport { LedgerEngine, LedgerViolationError } from './ledger-engine';\nimport { CryptoAdapter } from '../crypto/crypto-adapter';\n\n// Optional Sybil resistance imports (Phase 5)\n// These are conditionally used if engines are provided\nimport type { SponsorBondEngine } from '../hardening/sybil/sponsor-bond-engine';\nimport type { ServiceBondEngine } from '../hardening/sybil/service-bond-engine';\nimport type { ProbationTracker } from '../hardening/sybil/probation-tracker';\nimport type { ReputationSignals } from '../hardening/sybil/reputation-signals';\n\n// ============================================\n// IDENTITY ENGINE IMPLEMENTATION\n// ============================================\n\n/**\n * Optional Sybil resistance engines for Phase 5 integration\n */\nexport interface SybilResistanceEngines {\n  sponsorBonds?: SponsorBondEngine;\n  serviceBonds?: ServiceBondEngine;\n  probation?: ProbationTracker;\n  reputation?: ReputationSignals;\n}\n\nexport class IdentityEngine implements IIdentityEngine {\n  private ledger: LedgerEngine;\n  private storage: IStorage;\n  private crypto: CryptoAdapter;\n\n  // Optional Sybil resistance integration (Phase 5)\n  private sybilEngines?: SybilResistanceEngines;\n\n  constructor(\n    ledger: LedgerEngine,\n    storage: IStorage,\n    crypto: CryptoAdapter,\n    sybilEngines?: SybilResistanceEngines\n  ) {\n    this.ledger = ledger;\n    this.storage = storage;\n    this.crypto = crypto;\n    this.sybilEngines = sybilEngines;\n  }\n\n  /**\n   * Configure Sybil resistance engines after construction\n   */\n  configureSybilResistance(engines: SybilResistanceEngines): void {\n    this.sybilEngines = engines;\n  }\n\n  /**\n   * Get Sybil resistance engines (if configured)\n   */\n  getSybilEngines(): SybilResistanceEngines | undefined {\n    return this.sybilEngines;\n  }\n\n  // ============================================\n  // IDENTITY CREATION\n  // ============================================\n\n  /**\n   * Create a new identity with generated keys\n   */\n  async createIdentity(\n    cellId: CellId,\n    displayName: string\n  ): Promise<{ identity: CellIdentity; secretKey: string }> {\n    // Validate display name\n    if (!displayName || displayName.trim().length === 0) {\n      throw new IdentityValidationError({\n        code: IdentityErrorCode.INVALID_DISPLAY_NAME,\n        message: 'Display name cannot be empty',\n      });\n    }\n\n    // Generate keypair\n    const keyPairResult = this.crypto.generateKeyPair();\n    if (!keyPairResult.ok) {\n      throw new IdentityValidationError({\n        code: IdentityErrorCode.CRYPTO_ERROR,\n        message: `Failed to generate keypair: ${keyPairResult.error.message}`,\n      });\n    }\n\n    const { publicKey, secretKey } = keyPairResult.value;\n    const identityId = this.crypto.deriveIdentityId(publicKey);\n\n    // Check for duplicate\n    const existingResult = await this.storage.getIdentity(identityId);\n    if (existingResult.ok && existingResult.value) {\n      throw new IdentityValidationError({\n        code: IdentityErrorCode.ALREADY_EXISTS,\n        message: `Identity ${identityId} already exists`,\n      });\n    }\n\n    const timestamp = now();\n    const identity: CellIdentity = {\n      id: identityId,\n      cellId,\n      displayName: displayName.trim(),\n      publicKey,\n      membershipStatus: MembershipStatus.PENDING,\n      createdAt: timestamp,\n      updatedAt: timestamp,\n    };\n\n    // Save identity\n    const saveResult = await this.storage.saveIdentity(identity);\n    if (!saveResult.ok) {\n      throw new IdentityValidationError({\n        code: IdentityErrorCode.STORAGE_ERROR,\n        message: `Failed to save identity: ${saveResult.error.message}`,\n      });\n    }\n\n    return { identity, secretKey };\n  }\n\n  /**\n   * Import an existing identity (with known public key)\n   */\n  async importIdentity(\n    cellId: CellId,\n    displayName: string,\n    publicKey: PublicKey\n  ): Promise<CellIdentity> {\n    // Validate display name\n    if (!displayName || displayName.trim().length === 0) {\n      throw new IdentityValidationError({\n        code: IdentityErrorCode.INVALID_DISPLAY_NAME,\n        message: 'Display name cannot be empty',\n      });\n    }\n\n    // Validate public key format (basic check)\n    if (!publicKey || publicKey.length < 32) {\n      throw new IdentityValidationError({\n        code: IdentityErrorCode.INVALID_PUBLIC_KEY,\n        message: 'Invalid public key format',\n      });\n    }\n\n    const identityId = this.crypto.deriveIdentityId(publicKey);\n\n    // Check for duplicate\n    const existingResult = await this.storage.getIdentity(identityId);\n    if (existingResult.ok && existingResult.value) {\n      throw new IdentityValidationError({\n        code: IdentityErrorCode.ALREADY_EXISTS,\n        message: `Identity ${identityId} already exists`,\n      });\n    }\n\n    const timestamp = now();\n    const identity: CellIdentity = {\n      id: identityId,\n      cellId,\n      displayName: displayName.trim(),\n      publicKey,\n      membershipStatus: MembershipStatus.PENDING,\n      createdAt: timestamp,\n      updatedAt: timestamp,\n    };\n\n    // Save identity\n    const saveResult = await this.storage.saveIdentity(identity);\n    if (!saveResult.ok) {\n      throw new IdentityValidationError({\n        code: IdentityErrorCode.STORAGE_ERROR,\n        message: `Failed to save identity: ${saveResult.error.message}`,\n      });\n    }\n\n    return identity;\n  }\n\n  // ============================================\n  // IDENTITY RETRIEVAL\n  // ============================================\n\n  /**\n   * Get an identity by ID\n   */\n  async getIdentity(id: IdentityId): Promise<CellIdentity | undefined> {\n    const result = await this.storage.getIdentity(id);\n    if (!result.ok) {\n      throw new IdentityValidationError({\n        code: IdentityErrorCode.STORAGE_ERROR,\n        message: `Failed to get identity: ${result.error.message}`,\n      });\n    }\n    return result.value ?? undefined;\n  }\n\n  /**\n   * Get identity by public key\n   */\n  async getIdentityByPublicKey(publicKey: PublicKey): Promise<CellIdentity | undefined> {\n    const result = await this.storage.getIdentityByPublicKey(publicKey);\n    if (!result.ok) {\n      throw new IdentityValidationError({\n        code: IdentityErrorCode.STORAGE_ERROR,\n        message: `Failed to get identity: ${result.error.message}`,\n      });\n    }\n    return result.value ?? undefined;\n  }\n\n  /**\n   * Update identity display name\n   */\n  async updateDisplayName(id: IdentityId, displayName: string): Promise<CellIdentity> {\n    const identity = await this.getIdentity(id);\n    if (!identity) {\n      throw new IdentityValidationError({\n        code: IdentityErrorCode.NOT_FOUND,\n        message: `Identity ${id} not found`,\n      });\n    }\n\n    if (!displayName || displayName.trim().length === 0) {\n      throw new IdentityValidationError({\n        code: IdentityErrorCode.INVALID_DISPLAY_NAME,\n        message: 'Display name cannot be empty',\n      });\n    }\n\n    identity.displayName = displayName.trim();\n    identity.updatedAt = now();\n\n    const saveResult = await this.storage.saveIdentity(identity);\n    if (!saveResult.ok) {\n      throw new IdentityValidationError({\n        code: IdentityErrorCode.STORAGE_ERROR,\n        message: `Failed to save identity: ${saveResult.error.message}`,\n      });\n    }\n\n    return identity;\n  }\n\n  // ============================================\n  // MEMBERSHIP MANAGEMENT\n  // ============================================\n\n  /**\n   * Add a member to the cell (creates ledger entry)\n   * Basic admission without Sybil resistance features\n   */\n  async addMember(admission: AdmissionInfo): Promise<AdmissionResult> {\n    const timestamp = now();\n\n    // Check if identity exists\n    let identity = await this.getIdentity(admission.applicantId);\n\n    // If identity doesn't exist, create it from admission info\n    if (!identity) {\n      identity = await this.importIdentity(\n        this.ledger.getCellId(),\n        admission.displayName,\n        admission.publicKey\n      );\n    }\n\n    // Validate sponsor if provided\n    if (admission.sponsorId) {\n      const sponsor = this.ledger.getMemberState(admission.sponsorId);\n      if (!sponsor || sponsor.status !== MembershipStatus.ACTIVE) {\n        return {\n          approved: false,\n          rejectionReason: 'Sponsor is not an active member',\n          decidedAt: timestamp,\n        };\n      }\n    }\n\n    // Add to ledger\n    try {\n      await this.ledger.addMember(admission.applicantId, admission.initialLimit);\n    } catch (e) {\n      return {\n        approved: false,\n        rejectionReason: e instanceof Error ? e.message : 'Failed to add member to ledger',\n        decidedAt: timestamp,\n      };\n    }\n\n    // Update identity status\n    identity.membershipStatus = MembershipStatus.ACTIVE;\n    identity.updatedAt = timestamp;\n\n    await this.storage.saveIdentity(identity);\n\n    // Log membership change\n    const change: MembershipChange = {\n      memberId: admission.applicantId,\n      previousStatus: MembershipStatus.PENDING,\n      newStatus: MembershipStatus.ACTIVE,\n      reason: admission.notes || 'Admitted',\n      initiatorId: admission.sponsorId || admission.applicantId,\n      changedAt: timestamp,\n    };\n    await this.storage.saveMembershipChange(change);\n\n    return {\n      approved: true,\n      identity,\n      decidedAt: timestamp,\n    };\n  }\n\n  /**\n   * Add a member with full Sybil resistance integration (Phase 5)\n   * Creates sponsor bonds, service bonds, and probation as configured\n   */\n  async addMemberWithSybilResistance(\n    admission: AdmissionInfo\n  ): Promise<AdmissionResultExtended> {\n    const timestamp = now();\n\n    // Check if identity exists\n    let identity = await this.getIdentity(admission.applicantId);\n\n    // If identity doesn't exist, create it from admission info\n    if (!identity) {\n      identity = await this.importIdentity(\n        this.ledger.getCellId(),\n        admission.displayName,\n        admission.publicKey\n      );\n    }\n\n    // Validate sponsor if required\n    if (admission.requireSponsorBond && !admission.sponsorId) {\n      return {\n        approved: false,\n        rejectionReason: 'Sponsor bond required but no sponsor provided',\n        decidedAt: timestamp,\n      };\n    }\n\n    // Validate sponsor eligibility for bond\n    if (admission.sponsorId && this.sybilEngines?.sponsorBonds) {\n      const eligibility = await this.sybilEngines.sponsorBonds.canSponsor(admission.sponsorId);\n      if (!eligibility.eligible) {\n        return {\n          approved: false,\n          rejectionReason: `Sponsor not eligible: ${eligibility.reason}`,\n          decidedAt: timestamp,\n        };\n      }\n    } else if (admission.sponsorId) {\n      // Fallback check without sponsor bond engine\n      const sponsor = this.ledger.getMemberState(admission.sponsorId);\n      if (!sponsor || sponsor.status !== MembershipStatus.ACTIVE) {\n        return {\n          approved: false,\n          rejectionReason: 'Sponsor is not an active member',\n          decidedAt: timestamp,\n        };\n      }\n    }\n\n    // Add to ledger\n    try {\n      await this.ledger.addMember(admission.applicantId, admission.initialLimit);\n    } catch (e) {\n      return {\n        approved: false,\n        rejectionReason: e instanceof Error ? e.message : 'Failed to add member to ledger',\n        decidedAt: timestamp,\n      };\n    }\n\n    // Track created bonds and probation\n    let sponsorBondId: string | undefined;\n    let serviceBondId: string | undefined;\n    let onProbation = false;\n    let probationEndsAt: Timestamp | undefined;\n\n    // Create sponsor bond if requested and engine available\n    if (admission.requireSponsorBond && admission.sponsorId && this.sybilEngines?.sponsorBonds) {\n      try {\n        const bond = await this.sybilEngines.sponsorBonds.createBond({\n          sponsorId: admission.sponsorId,\n          sponseeId: admission.applicantId,\n          bondAmount: admission.sponsorBondAmount,\n          probationDays: admission.probationDays,\n        });\n        sponsorBondId = bond.id;\n      } catch (e) {\n        // Rollback member addition on bond failure\n        await this.ledger.removeMember(admission.applicantId);\n        return {\n          approved: false,\n          rejectionReason: e instanceof Error ? e.message : 'Failed to create sponsor bond',\n          decidedAt: timestamp,\n        };\n      }\n    }\n\n    // Create service bond if requested and engine available\n    if (admission.requireServiceBond && this.sybilEngines?.serviceBonds) {\n      try {\n        const bond = await this.sybilEngines.serviceBonds.createBond(admission.applicantId);\n        serviceBondId = bond.id;\n      } catch (e) {\n        // Rollback sponsor bond and member\n        if (sponsorBondId && this.sybilEngines?.sponsorBonds) {\n          try {\n            await this.sybilEngines.sponsorBonds.releaseBond(sponsorBondId, 'Admission rollback');\n          } catch { /* ignore rollback errors */ }\n        }\n        await this.ledger.removeMember(admission.applicantId);\n        return {\n          approved: false,\n          rejectionReason: e instanceof Error ? e.message : 'Failed to create service bond',\n          decidedAt: timestamp,\n        };\n      }\n    }\n\n    // Start probation if requested and tracker available\n    if (admission.startWithProbation && this.sybilEngines?.probation) {\n      try {\n        const probationDays = admission.probationDays ?? 90;\n        const probationState = await this.sybilEngines.probation.startProbation(\n          admission.applicantId,\n          probationDays,\n          sponsorBondId,\n          serviceBondId\n        );\n        onProbation = true;\n        probationEndsAt = probationState.scheduledEndAt;\n      } catch (e) {\n        // Probation failure is non-fatal - member is still admitted\n        console.warn(`Failed to start probation for ${admission.applicantId}:`, e);\n      }\n    }\n\n    // Update identity status based on probation\n    identity.membershipStatus = onProbation ? MembershipStatus.PROBATION : MembershipStatus.ACTIVE;\n    identity.updatedAt = timestamp;\n\n    await this.storage.saveIdentity(identity);\n\n    // Log membership change\n    const change: MembershipChange = {\n      memberId: admission.applicantId,\n      previousStatus: MembershipStatus.PENDING,\n      newStatus: identity.membershipStatus,\n      reason: admission.notes || (onProbation ? 'Admitted with probation' : 'Admitted'),\n      initiatorId: admission.sponsorId || admission.applicantId,\n      changedAt: timestamp,\n    };\n    await this.storage.saveMembershipChange(change);\n\n    return {\n      approved: true,\n      identity,\n      decidedAt: timestamp,\n      sponsorBondId,\n      serviceBondId,\n      onProbation,\n      probationEndsAt,\n    };\n  }\n\n  /**\n   * Graduate a member from probation\n   */\n  async graduateProbation(\n    memberId: IdentityId,\n    initiatorId: IdentityId\n  ): Promise<MembershipChange> {\n    if (!this.sybilEngines?.probation) {\n      throw new IdentityValidationError({\n        code: IdentityErrorCode.INVALID_STATUS_TRANSITION,\n        message: 'Probation tracker not configured',\n      });\n    }\n\n    const identity = await this.getIdentity(memberId);\n    if (!identity) {\n      throw new IdentityValidationError({\n        code: IdentityErrorCode.NOT_FOUND,\n        message: `Identity ${memberId} not found`,\n      });\n    }\n\n    if (identity.membershipStatus !== MembershipStatus.PROBATION) {\n      throw new IdentityValidationError({\n        code: IdentityErrorCode.INVALID_STATUS_TRANSITION,\n        message: `Member ${memberId} is not on probation`,\n      });\n    }\n\n    const timestamp = now();\n\n    // Graduate through probation tracker\n    await this.sybilEngines.probation.graduateProbation(memberId);\n\n    // Update identity\n    identity.membershipStatus = MembershipStatus.ACTIVE;\n    identity.updatedAt = timestamp;\n    await this.storage.saveIdentity(identity);\n\n    // Log change\n    const change: MembershipChange = {\n      memberId,\n      previousStatus: MembershipStatus.PROBATION,\n      newStatus: MembershipStatus.ACTIVE,\n      reason: 'Graduated from probation',\n      initiatorId,\n      changedAt: timestamp,\n    };\n    await this.storage.saveMembershipChange(change);\n\n    // Release sponsor bond if exists\n    const probationState = this.sybilEngines.probation.getProbationState(memberId);\n    if (probationState?.sponsorBondId && this.sybilEngines.sponsorBonds) {\n      try {\n        await this.sybilEngines.sponsorBonds.releaseBond(\n          probationState.sponsorBondId,\n          'Sponsee graduated'\n        );\n      } catch (e) {\n        console.warn(`Failed to release sponsor bond for ${memberId}:`, e);\n      }\n    }\n\n    return change;\n  }\n\n  /**\n   * Check if member is on probation\n   */\n  isOnProbation(memberId: IdentityId): boolean {\n    if (!this.sybilEngines?.probation) {\n      return false;\n    }\n    return this.sybilEngines.probation.isOnProbation(memberId);\n  }\n\n  /**\n   * Get member's reputation score (advisory only)\n   */\n  async getReputationScore(memberId: IdentityId): Promise<number | undefined> {\n    if (!this.sybilEngines?.reputation) {\n      return undefined;\n    }\n    return this.sybilEngines.reputation.getScore(memberId);\n  }\n\n  /**\n   * Compute and cache reputation for a member\n   */\n  async computeReputation(memberId: IdentityId): Promise<void> {\n    if (!this.sybilEngines?.reputation) {\n      return;\n    }\n    await this.sybilEngines.reputation.computeReputation(memberId);\n  }\n\n  /**\n   * Freeze a member\n   */\n  async freezeMember(\n    memberId: IdentityId,\n    reason: string,\n    initiatorId: IdentityId\n  ): Promise<MembershipChange> {\n    const identity = await this.getIdentity(memberId);\n    if (!identity) {\n      throw new IdentityValidationError({\n        code: IdentityErrorCode.NOT_FOUND,\n        message: `Identity ${memberId} not found`,\n      });\n    }\n\n    const memberState = this.ledger.getMemberState(memberId);\n    if (!memberState) {\n      throw new IdentityValidationError({\n        code: IdentityErrorCode.NOT_FOUND,\n        message: `Member ${memberId} not found in ledger`,\n      });\n    }\n\n    // Validate transition\n    if (memberState.status === MembershipStatus.FROZEN) {\n      throw new IdentityValidationError({\n        code: IdentityErrorCode.INVALID_STATUS_TRANSITION,\n        message: 'Member is already frozen',\n      });\n    }\n\n    if (memberState.status === MembershipStatus.EXCLUDED) {\n      throw new IdentityValidationError({\n        code: IdentityErrorCode.INVALID_STATUS_TRANSITION,\n        message: 'Cannot freeze an excluded member',\n      });\n    }\n\n    const previousStatus = identity.membershipStatus;\n    const timestamp = now();\n\n    // Update ledger status\n    await this.ledger.updateMemberStatus(memberId, MembershipStatus.FROZEN);\n\n    // Update identity\n    identity.membershipStatus = MembershipStatus.FROZEN;\n    identity.updatedAt = timestamp;\n    await this.storage.saveIdentity(identity);\n\n    // Log change\n    const change: MembershipChange = {\n      memberId,\n      previousStatus,\n      newStatus: MembershipStatus.FROZEN,\n      reason,\n      initiatorId,\n      changedAt: timestamp,\n    };\n    await this.storage.saveMembershipChange(change);\n\n    return change;\n  }\n\n  /**\n   * Unfreeze a member\n   */\n  async unfreezeMember(\n    memberId: IdentityId,\n    reason: string,\n    initiatorId: IdentityId\n  ): Promise<MembershipChange> {\n    const identity = await this.getIdentity(memberId);\n    if (!identity) {\n      throw new IdentityValidationError({\n        code: IdentityErrorCode.NOT_FOUND,\n        message: `Identity ${memberId} not found`,\n      });\n    }\n\n    const memberState = this.ledger.getMemberState(memberId);\n    if (!memberState) {\n      throw new IdentityValidationError({\n        code: IdentityErrorCode.NOT_FOUND,\n        message: `Member ${memberId} not found in ledger`,\n      });\n    }\n\n    // Validate transition\n    if (memberState.status !== MembershipStatus.FROZEN) {\n      throw new IdentityValidationError({\n        code: IdentityErrorCode.INVALID_STATUS_TRANSITION,\n        message: `Cannot unfreeze member in status ${memberState.status}`,\n      });\n    }\n\n    const timestamp = now();\n\n    // Update ledger status\n    await this.ledger.updateMemberStatus(memberId, MembershipStatus.ACTIVE);\n\n    // Update identity\n    identity.membershipStatus = MembershipStatus.ACTIVE;\n    identity.updatedAt = timestamp;\n    await this.storage.saveIdentity(identity);\n\n    // Log change\n    const change: MembershipChange = {\n      memberId,\n      previousStatus: MembershipStatus.FROZEN,\n      newStatus: MembershipStatus.ACTIVE,\n      reason,\n      initiatorId,\n      changedAt: timestamp,\n    };\n    await this.storage.saveMembershipChange(change);\n\n    return change;\n  }\n\n  /**\n   * Remove a member (must have zero balance)\n   */\n  async removeMember(\n    memberId: IdentityId,\n    reason: string,\n    initiatorId: IdentityId\n  ): Promise<MembershipChange> {\n    const identity = await this.getIdentity(memberId);\n    if (!identity) {\n      throw new IdentityValidationError({\n        code: IdentityErrorCode.NOT_FOUND,\n        message: `Identity ${memberId} not found`,\n      });\n    }\n\n    const memberState = this.ledger.getMemberState(memberId);\n    if (!memberState) {\n      throw new IdentityValidationError({\n        code: IdentityErrorCode.NOT_FOUND,\n        message: `Member ${memberId} not found in ledger`,\n      });\n    }\n\n    // Check balance\n    if (memberState.balance !== 0) {\n      throw new IdentityValidationError({\n        code: IdentityErrorCode.NON_ZERO_BALANCE,\n        message: `Cannot remove member with balance ${memberState.balance}`,\n        details: { balance: memberState.balance },\n      });\n    }\n\n    // Check reserves\n    if (memberState.reserve !== 0) {\n      throw new IdentityValidationError({\n        code: IdentityErrorCode.PENDING_COMMITMENTS,\n        message: `Cannot remove member with active reserves: ${memberState.reserve}`,\n        details: { reserve: memberState.reserve },\n      });\n    }\n\n    const previousStatus = identity.membershipStatus;\n    const timestamp = now();\n\n    // Remove from ledger\n    await this.ledger.removeMember(memberId);\n\n    // Update identity\n    identity.membershipStatus = MembershipStatus.EXCLUDED;\n    identity.updatedAt = timestamp;\n    await this.storage.saveIdentity(identity);\n\n    // Log change\n    const change: MembershipChange = {\n      memberId,\n      previousStatus,\n      newStatus: MembershipStatus.EXCLUDED,\n      reason,\n      initiatorId,\n      changedAt: timestamp,\n    };\n    await this.storage.saveMembershipChange(change);\n\n    return change;\n  }\n\n  // ============================================\n  // MEMBER SEARCH\n  // ============================================\n\n  /**\n   * Get all members\n   */\n  async getMembers(cellId: CellId): Promise<CellIdentity[]> {\n    const result = await this.storage.getAllIdentities(cellId);\n    if (!result.ok) {\n      throw new IdentityValidationError({\n        code: IdentityErrorCode.STORAGE_ERROR,\n        message: `Failed to get members: ${result.error.message}`,\n      });\n    }\n    return result.value;\n  }\n\n  /**\n   * Search members\n   */\n  async searchMembers(\n    cellId: CellId,\n    criteria: MemberSearchCriteria\n  ): Promise<MemberSearchResult> {\n    // Get all identities\n    const allIdentities = await this.getMembers(cellId);\n\n    // Filter\n    let filtered = allIdentities;\n\n    if (criteria.displayName) {\n      const searchLower = criteria.displayName.toLowerCase();\n      filtered = filtered.filter(i =>\n        i.displayName.toLowerCase().includes(searchLower)\n      );\n    }\n\n    if (criteria.status) {\n      const statuses = Array.isArray(criteria.status) ? criteria.status : [criteria.status];\n      filtered = filtered.filter(i => statuses.includes(i.membershipStatus));\n    }\n\n    // Filter by balance if specified\n    if (criteria.minBalance !== undefined || criteria.maxBalance !== undefined) {\n      filtered = filtered.filter(identity => {\n        const memberState = this.ledger.getMemberState(identity.id);\n        if (!memberState) return false;\n\n        if (criteria.minBalance !== undefined && memberState.balance < criteria.minBalance) {\n          return false;\n        }\n        if (criteria.maxBalance !== undefined && memberState.balance > criteria.maxBalance) {\n          return false;\n        }\n        return true;\n      });\n    }\n\n    const totalCount = filtered.length;\n\n    // Apply pagination\n    const offset = criteria.offset ?? 0;\n    const limit = criteria.limit ?? 100;\n    const paginated = filtered.slice(offset, offset + limit);\n\n    return {\n      members: paginated,\n      totalCount,\n    };\n  }\n\n  // ============================================\n  // SIGNATURE VERIFICATION\n  // ============================================\n\n  /**\n   * Verify a signature from a member\n   */\n  async verifySignature(\n    memberId: IdentityId,\n    message: string | object,\n    signature: string\n  ): Promise<boolean> {\n    const identity = await this.getIdentity(memberId);\n    if (!identity) {\n      return false;\n    }\n\n    return this.crypto.verify(message, signature, identity.publicKey);\n  }\n}\n\n// ============================================\n// CUSTOM ERROR CLASS\n// ============================================\n\nexport class IdentityValidationError extends Error {\n  public readonly code: IdentityErrorCode;\n  public readonly details?: Record<string, unknown>;\n\n  constructor(error: IdentityError) {\n    super(error.message);\n    this.name = 'IdentityValidationError';\n    this.code = error.code;\n    this.details = error.details;\n  }\n\n  toJSON(): IdentityError {\n    return {\n      code: this.code,\n      message: this.message,\n      details: this.details,\n    };\n  }\n}\n\n// ============================================\n// FACTORY\n// ============================================\n\n/**\n * Create a new identity engine\n */\nexport function createIdentityEngine(\n  ledger: LedgerEngine,\n  storage: IStorage,\n  crypto: CryptoAdapter,\n  sybilEngines?: SybilResistanceEngines\n): IdentityEngine {\n  return new IdentityEngine(ledger, storage, crypto, sybilEngines);\n}\n", "/**\n * Cell Protocol - Commitment Engine\n *\n * Implementation of the Commitment System (PRD-03).\n * Manages commitments between members, including:\n * - Soft commitments (trust-based)\n * - Escrowed commitments (reserve capacity)\n * - Fulfillment and cancellation\n */\n\nimport {\n  IdentityId,\n  Timestamp,\n  Units,\n  MembershipStatus,\n  BalanceChangeReason,\n  now,\n  generateId,\n} from '../types/common';\nimport {\n  Commitment,\n  CommitmentId,\n  CommitmentType,\n  CommitmentStatus,\n  TaskCategory,\n  CreateCommitmentInput,\n  FulfillmentConfirmation,\n  CommitmentError,\n  CommitmentErrorCode,\n  MemberCommitmentStats,\n  ICommitmentEngine,\n} from '../types/commitment';\nimport { LedgerEngine } from './ledger-engine';\nimport { TransactionEngine } from './transaction-engine';\nimport { IStorage } from '../storage/pouchdb-adapter';\n\n// ============================================\n// COMMITMENT ENGINE IMPLEMENTATION\n// ============================================\n\nexport class CommitmentEngine implements ICommitmentEngine {\n  private ledger: LedgerEngine;\n  private transactions: TransactionEngine;\n  private storage: IStorage;\n\n  constructor(\n    ledger: LedgerEngine,\n    transactions: TransactionEngine,\n    storage: IStorage\n  ) {\n    this.ledger = ledger;\n    this.transactions = transactions;\n    this.storage = storage;\n  }\n\n  // ============================================\n  // CREATION\n  // ============================================\n\n  /**\n   * Create a new commitment\n   */\n  async createCommitment(input: CreateCommitmentInput): Promise<Commitment> {\n    // Validate promisor\n    const promisorState = this.ledger.getMemberState(input.promisor);\n    if (!promisorState) {\n      throw new CommitmentValidationError({\n        code: CommitmentErrorCode.INVALID_PROMISOR,\n        message: `Promisor ${input.promisor} not found`,\n      });\n    }\n    if (promisorState.status !== MembershipStatus.ACTIVE) {\n      throw new CommitmentValidationError({\n        code: CommitmentErrorCode.INVALID_PROMISOR,\n        message: `Promisor ${input.promisor} is not active`,\n      });\n    }\n\n    // Validate promisee\n    const promiseeState = this.ledger.getMemberState(input.promisee);\n    if (!promiseeState) {\n      throw new CommitmentValidationError({\n        code: CommitmentErrorCode.INVALID_PROMISEE,\n        message: `Promisee ${input.promisee} not found`,\n      });\n    }\n    if (promiseeState.status !== MembershipStatus.ACTIVE) {\n      throw new CommitmentValidationError({\n        code: CommitmentErrorCode.INVALID_PROMISEE,\n        message: `Promisee ${input.promisee} is not active`,\n      });\n    }\n\n    // Cannot commit to yourself\n    if (input.promisor === input.promisee) {\n      throw new CommitmentValidationError({\n        code: CommitmentErrorCode.SELF_COMMITMENT,\n        message: 'Cannot create commitment to yourself',\n      });\n    }\n\n    // Validate value\n    if (input.value <= 0) {\n      throw new CommitmentValidationError({\n        code: CommitmentErrorCode.INVALID_VALUE,\n        message: 'Commitment value must be positive',\n      });\n    }\n\n    // Validate due date if provided\n    if (input.dueDate && input.dueDate <= now()) {\n      throw new CommitmentValidationError({\n        code: CommitmentErrorCode.INVALID_DUE_DATE,\n        message: 'Due date must be in the future',\n      });\n    }\n\n    // For escrowed commitments, check and reserve capacity\n    if (input.type === CommitmentType.ESCROWED) {\n      // The promisee (payer) needs the capacity\n      const availableCapacity = this.ledger.getAvailableCapacity(input.promisee);\n      if (input.value > availableCapacity) {\n        throw new CommitmentValidationError({\n          code: CommitmentErrorCode.INSUFFICIENT_CAPACITY,\n          message: `Promisee ${input.promisee} has insufficient capacity: ${availableCapacity} < ${input.value}`,\n          details: { availableCapacity, required: input.value },\n        });\n      }\n    }\n\n    // Create the commitment\n    const commitment: Commitment = {\n      id: generateId(),\n      type: input.type,\n      promisor: input.promisor,\n      promisee: input.promisee,\n      value: input.value,\n      category: input.category,\n      description: input.description,\n      dueDate: input.dueDate,\n      status: CommitmentStatus.ACTIVE, // Start as active for simplicity\n      createdAt: now(),\n    };\n\n    // For escrowed commitments, reserve capacity on promisee (payer)\n    if (input.type === CommitmentType.ESCROWED) {\n      await this.ledger.applyReserveUpdate({\n        memberId: input.promisee,\n        delta: input.value,\n        reason: BalanceChangeReason.COMMITMENT_RESERVE,\n        commitmentId: commitment.id,\n      });\n    }\n\n    // Save to storage\n    const result = await this.storage.saveCommitment(commitment);\n    if (!result.ok) {\n      // Rollback reserve if save fails\n      if (input.type === CommitmentType.ESCROWED) {\n        await this.ledger.applyReserveUpdate({\n          memberId: input.promisee,\n          delta: -input.value,\n          reason: BalanceChangeReason.COMMITMENT_RELEASE,\n          commitmentId: commitment.id,\n        });\n      }\n      throw new CommitmentValidationError({\n        code: CommitmentErrorCode.STORAGE_ERROR,\n        message: result.error.message,\n      });\n    }\n\n    // Log event\n    await this.storage.appendEvent({\n      cellId: this.ledger.getCellId(),\n      type: 'COMMITMENT_CREATED',\n      timestamp: now(),\n      data: {\n        commitmentId: commitment.id,\n        promisor: commitment.promisor,\n        promisee: commitment.promisee,\n        value: commitment.value,\n        category: commitment.category,\n        type: commitment.type,\n      },\n    });\n\n    return commitment;\n  }\n\n  // ============================================\n  // LIFECYCLE\n  // ============================================\n\n  /**\n   * Accept a proposed commitment (makes it active)\n   */\n  async acceptCommitment(id: CommitmentId, accepterId: IdentityId): Promise<Commitment> {\n    const commitment = await this.getCommitment(id);\n    if (!commitment) {\n      throw new CommitmentValidationError({\n        code: CommitmentErrorCode.NOT_FOUND,\n        message: `Commitment ${id} not found`,\n      });\n    }\n\n    if (commitment.status !== CommitmentStatus.PROPOSED) {\n      throw new CommitmentValidationError({\n        code: CommitmentErrorCode.INVALID_STATUS_TRANSITION,\n        message: `Cannot accept commitment in status ${commitment.status}`,\n      });\n    }\n\n    // Only promisor can accept (they are committing to do the work)\n    if (accepterId !== commitment.promisor) {\n      throw new CommitmentValidationError({\n        code: CommitmentErrorCode.UNAUTHORIZED_CONFIRMATION,\n        message: 'Only promisor can accept commitment',\n      });\n    }\n\n    commitment.status = CommitmentStatus.ACTIVE;\n\n    await this.storage.saveCommitment(commitment);\n\n    return commitment;\n  }\n\n  /**\n   * Fulfill a commitment - executes the transaction\n   */\n  async fulfillCommitment(\n    id: CommitmentId,\n    confirmation: FulfillmentConfirmation\n  ): Promise<{ commitment: Commitment; payerNewBalance: Units; payeeNewBalance: Units }> {\n    const commitment = await this.getCommitment(id);\n    if (!commitment) {\n      throw new CommitmentValidationError({\n        code: CommitmentErrorCode.NOT_FOUND,\n        message: `Commitment ${id} not found`,\n      });\n    }\n\n    if (commitment.status !== CommitmentStatus.ACTIVE) {\n      throw new CommitmentValidationError({\n        code: CommitmentErrorCode.INVALID_STATUS_TRANSITION,\n        message: `Cannot fulfill commitment in status ${commitment.status}`,\n      });\n    }\n\n    // Only promisee (payer/requester) can confirm fulfillment\n    if (confirmation.confirmedBy !== commitment.promisee) {\n      throw new CommitmentValidationError({\n        code: CommitmentErrorCode.UNAUTHORIZED_CONFIRMATION,\n        message: 'Only promisee can confirm fulfillment',\n      });\n    }\n\n    // For escrowed commitments, release the reserve first\n    if (commitment.type === CommitmentType.ESCROWED) {\n      await this.ledger.applyReserveUpdate({\n        memberId: commitment.promisee,\n        delta: -commitment.value,\n        reason: BalanceChangeReason.COMMITMENT_RELEASE,\n        commitmentId: commitment.id,\n      });\n    }\n\n    // Execute the transaction: promisee pays promisor\n    // Create the transaction\n    const tx = await this.transactions.createSpotTransaction({\n      payer: commitment.promisee,\n      payee: commitment.promisor,\n      amount: commitment.value,\n      description: `Commitment fulfilled: ${commitment.description}`,\n    });\n\n    // For simplicity in this implementation, we execute immediately without signatures\n    // In a real system, we'd need to handle the signature flow\n    const txResult = await this.ledger.applyBalanceUpdates([\n      {\n        memberId: commitment.promisee,\n        delta: -commitment.value,\n        reason: BalanceChangeReason.COMMITMENT_EXECUTE,\n        referenceId: commitment.id,\n      },\n      {\n        memberId: commitment.promisor,\n        delta: commitment.value,\n        reason: BalanceChangeReason.COMMITMENT_EXECUTE,\n        referenceId: commitment.id,\n      },\n    ]);\n\n    // Update commitment status\n    commitment.status = CommitmentStatus.FULFILLED;\n    commitment.fulfilledAt = now();\n\n    await this.storage.saveCommitment(commitment);\n\n    // Log event\n    await this.storage.appendEvent({\n      cellId: this.ledger.getCellId(),\n      type: 'COMMITMENT_FULFILLED',\n      timestamp: now(),\n      data: {\n        commitmentId: commitment.id,\n        confirmedBy: confirmation.confirmedBy,\n        rating: confirmation.rating,\n      },\n    });\n\n    return {\n      commitment,\n      payerNewBalance: txResult[0].newBalance,\n      payeeNewBalance: txResult[1].newBalance,\n    };\n  }\n\n  /**\n   * Cancel a commitment\n   */\n  async cancelCommitment(\n    id: CommitmentId,\n    reason: string,\n    initiatorId: IdentityId\n  ): Promise<Commitment> {\n    const commitment = await this.getCommitment(id);\n    if (!commitment) {\n      throw new CommitmentValidationError({\n        code: CommitmentErrorCode.NOT_FOUND,\n        message: `Commitment ${id} not found`,\n      });\n    }\n\n    // Can only cancel PROPOSED or ACTIVE commitments\n    if (commitment.status !== CommitmentStatus.PROPOSED &&\n        commitment.status !== CommitmentStatus.ACTIVE) {\n      throw new CommitmentValidationError({\n        code: CommitmentErrorCode.CANNOT_CANCEL,\n        message: `Cannot cancel commitment in status ${commitment.status}`,\n      });\n    }\n\n    // Must be a party to the commitment\n    if (initiatorId !== commitment.promisor && initiatorId !== commitment.promisee) {\n      throw new CommitmentValidationError({\n        code: CommitmentErrorCode.UNAUTHORIZED_CONFIRMATION,\n        message: 'Only parties to the commitment can cancel it',\n      });\n    }\n\n    // For escrowed commitments, release the reserve\n    if (commitment.type === CommitmentType.ESCROWED &&\n        commitment.status === CommitmentStatus.ACTIVE) {\n      await this.ledger.applyReserveUpdate({\n        memberId: commitment.promisee,\n        delta: -commitment.value,\n        reason: BalanceChangeReason.COMMITMENT_RELEASE,\n        commitmentId: commitment.id,\n      });\n    }\n\n    commitment.status = CommitmentStatus.CANCELLED;\n    commitment.cancelledAt = now();\n    commitment.notes = reason;\n\n    await this.storage.saveCommitment(commitment);\n\n    // Log event\n    await this.storage.appendEvent({\n      cellId: this.ledger.getCellId(),\n      type: 'COMMITMENT_CANCELLED',\n      timestamp: now(),\n      data: {\n        commitmentId: commitment.id,\n        initiator: initiatorId,\n        reason,\n      },\n    });\n\n    return commitment;\n  }\n\n  /**\n   * Mark commitment as disputed\n   */\n  async disputeCommitment(\n    id: CommitmentId,\n    reason: string,\n    initiatorId: IdentityId\n  ): Promise<Commitment> {\n    const commitment = await this.getCommitment(id);\n    if (!commitment) {\n      throw new CommitmentValidationError({\n        code: CommitmentErrorCode.NOT_FOUND,\n        message: `Commitment ${id} not found`,\n      });\n    }\n\n    if (commitment.status !== CommitmentStatus.ACTIVE) {\n      throw new CommitmentValidationError({\n        code: CommitmentErrorCode.INVALID_STATUS_TRANSITION,\n        message: `Cannot dispute commitment in status ${commitment.status}`,\n      });\n    }\n\n    // Must be a party to the commitment\n    if (initiatorId !== commitment.promisor && initiatorId !== commitment.promisee) {\n      throw new CommitmentValidationError({\n        code: CommitmentErrorCode.UNAUTHORIZED_CONFIRMATION,\n        message: 'Only parties to the commitment can dispute it',\n      });\n    }\n\n    commitment.status = CommitmentStatus.DISPUTED;\n    commitment.notes = reason;\n\n    await this.storage.saveCommitment(commitment);\n\n    // Log event\n    await this.storage.appendEvent({\n      cellId: this.ledger.getCellId(),\n      type: 'COMMITMENT_DISPUTED',\n      timestamp: now(),\n      data: {\n        commitmentId: commitment.id,\n        initiator: initiatorId,\n        reason,\n      },\n    });\n\n    return commitment;\n  }\n\n  // ============================================\n  // QUERIES\n  // ============================================\n\n  async getCommitment(id: CommitmentId): Promise<Commitment | undefined> {\n    const result = await this.storage.getCommitment(id);\n    if (!result.ok) return undefined;\n    return result.value ?? undefined;\n  }\n\n  async getCommitmentsByMember(memberId: IdentityId): Promise<Commitment[]> {\n    const result = await this.storage.getCommitmentsByMember(memberId);\n    if (!result.ok) return [];\n    return result.value;\n  }\n\n  async getActiveCommitments(): Promise<Commitment[]> {\n    const result = await this.storage.getCommitmentsByStatus(CommitmentStatus.ACTIVE);\n    if (!result.ok) return [];\n    return result.value;\n  }\n\n  async getOverdueCommitments(): Promise<Commitment[]> {\n    const active = await this.getActiveCommitments();\n    const currentTime = now();\n    return active.filter(c => c.dueDate && c.dueDate < currentTime);\n  }\n\n  async getCommitmentsByCategory(category: TaskCategory): Promise<Commitment[]> {\n    const result = await this.storage.getCommitmentsByCategory(category);\n    if (!result.ok) return [];\n    return result.value;\n  }\n\n  // ============================================\n  // ANALYTICS\n  // ============================================\n\n  /**\n   * Get total reserved capacity for a member\n   */\n  getMemberReservedCapacity(memberId: IdentityId): Units {\n    const state = this.ledger.getMemberState(memberId);\n    return state?.reserve ?? 0;\n  }\n\n  /**\n   * Get fulfillment rate for a category\n   */\n  async getCategoryFulfillmentRate(category: TaskCategory): Promise<number> {\n    const commitments = await this.getCommitmentsByCategory(category);\n    if (commitments.length === 0) return 0;\n\n    const fulfilled = commitments.filter(c => c.status === CommitmentStatus.FULFILLED).length;\n    const completed = commitments.filter(c =>\n      c.status === CommitmentStatus.FULFILLED ||\n      c.status === CommitmentStatus.CANCELLED\n    ).length;\n\n    if (completed === 0) return 0;\n    return fulfilled / completed;\n  }\n\n  /**\n   * Get member commitment statistics\n   */\n  async getMemberStats(memberId: IdentityId): Promise<MemberCommitmentStats> {\n    const commitments = await this.getCommitmentsByMember(memberId);\n\n    const asPromisor = commitments.filter(c => c.promisor === memberId);\n    const asPromisee = commitments.filter(c => c.promisee === memberId);\n    const fulfilledAsPromisor = asPromisor.filter(c => c.status === CommitmentStatus.FULFILLED);\n\n    // Calculate active reserved value (commitments where member is promisee with escrow)\n    const activeReservedValue = commitments\n      .filter(c =>\n        c.promisee === memberId &&\n        c.type === CommitmentType.ESCROWED &&\n        c.status === CommitmentStatus.ACTIVE\n      )\n      .reduce((sum, c) => sum + c.value, 0);\n\n    return {\n      asPromisor: asPromisor.length,\n      asPromisee: asPromisee.length,\n      fulfilledAsPromisor: fulfilledAsPromisor.length,\n      averageRating: undefined, // Would need to track ratings\n      activeReservedValue,\n    };\n  }\n}\n\n// ============================================\n// CUSTOM ERROR CLASS\n// ============================================\n\nexport class CommitmentValidationError extends Error {\n  public readonly code: CommitmentErrorCode;\n  public readonly details?: Record<string, unknown>;\n\n  constructor(error: CommitmentError) {\n    super(error.message);\n    this.name = 'CommitmentValidationError';\n    this.code = error.code;\n    this.details = error.details;\n  }\n\n  toJSON(): CommitmentError {\n    return {\n      code: this.code,\n      message: this.message,\n      details: this.details,\n    };\n  }\n}\n\n// ============================================\n// FACTORY\n// ============================================\n\n/**\n * Create a new commitment engine\n */\nexport function createCommitmentEngine(\n  ledger: LedgerEngine,\n  transactions: TransactionEngine,\n  storage: IStorage\n): CommitmentEngine {\n  return new CommitmentEngine(ledger, transactions, storage);\n}\n", "/**\n * Cell Protocol - Governance Engine\n *\n * Implementation of the Governance System (PRD-05).\n * Manages councils, proposals, voting, and disputes.\n */\n\nimport {\n  IdentityId,\n  CellId,\n  Timestamp,\n  Units,\n  MembershipStatus,\n  now,\n  generateId,\n} from '../types/common';\nimport { AdmissionInfo } from '../types/identity';\nimport {\n  ProposalId,\n  DisputeId,\n  ProposalType,\n  ProposalStatus,\n  ActionCategory,\n  DisputeType,\n  DisputeStatus,\n  GovernanceCouncil,\n  CouncilMember,\n  QuorumRules,\n  TermPolicy,\n  Proposal,\n  ProposalPayload,\n  Vote,\n  Dispute,\n  Evidence,\n  DisputeResolution,\n  CreateProposalInput,\n  FileDisputeInput,\n  GovernanceError,\n  GovernanceErrorCode,\n  IGovernanceEngine,\n} from '../types/governance';\nimport { LedgerEngine } from './ledger-engine';\nimport { IdentityEngine } from './identity-engine';\nimport { CommitmentEngine } from './commitment-engine';\nimport { IStorage } from '../storage/pouchdb-adapter';\n\n// ============================================\n// GOVERNANCE ENGINE IMPLEMENTATION\n// ============================================\n\nexport class GovernanceEngine implements IGovernanceEngine {\n  private cellId: CellId;\n  private ledger: LedgerEngine;\n  private identity: IdentityEngine;\n  private commitments: CommitmentEngine;\n  private storage: IStorage;\n\n  constructor(\n    cellId: CellId,\n    ledger: LedgerEngine,\n    identity: IdentityEngine,\n    commitments: CommitmentEngine,\n    storage: IStorage\n  ) {\n    this.cellId = cellId;\n    this.ledger = ledger;\n    this.identity = identity;\n    this.commitments = commitments;\n    this.storage = storage;\n  }\n\n  // ============================================\n  // COUNCIL MANAGEMENT\n  // ============================================\n\n  async getCouncil(): Promise<GovernanceCouncil | undefined> {\n    const result = await this.storage.getCouncil(this.cellId);\n    if (!result.ok) return undefined;\n    return result.value ?? undefined;\n  }\n\n  async isCouncilMember(memberId: IdentityId): Promise<boolean> {\n    const council = await this.getCouncil();\n    if (!council) return false;\n    return council.members.some(m => m.memberId === memberId);\n  }\n\n  async initializeCouncil(members: CouncilMember[]): Promise<GovernanceCouncil> {\n    const council: GovernanceCouncil = {\n      cellId: this.cellId,\n      members,\n      quorumRules: {\n        standardQuorum: 0.5,\n        supermajorityThreshold: 0.67,\n        minimumVotes: 1,\n      },\n      termPolicy: {\n        termDurationDays: 90,\n        maxConsecutiveTerms: 3,\n        minCouncilSize: 1,\n        maxCouncilSize: 9,\n      },\n      createdAt: now(),\n      updatedAt: now(),\n    };\n\n    const result = await this.storage.saveCouncil(council);\n    if (!result.ok) {\n      throw new GovernanceValidationError({\n        code: GovernanceErrorCode.STORAGE_ERROR,\n        message: result.error.message,\n      });\n    }\n\n    await this.storage.appendEvent({\n      cellId: this.cellId,\n      type: 'COUNCIL_INITIALIZED',\n      timestamp: now(),\n      data: { memberIds: members.map(m => m.memberId) },\n    });\n\n    return council;\n  }\n\n  // ============================================\n  // PROPOSALS\n  // ============================================\n\n  async createProposal(input: CreateProposalInput): Promise<Proposal> {\n    // Validate proposer is council member\n    const isCouncil = await this.isCouncilMember(input.proposer);\n    if (!isCouncil) {\n      throw new GovernanceValidationError({\n        code: GovernanceErrorCode.NOT_COUNCIL_MEMBER,\n        message: `${input.proposer} is not a council member`,\n      });\n    }\n\n    const votingDurationHours = input.votingDurationHours ?? 72; // Default 3 days\n    const closesAt = now() + (votingDurationHours * 60 * 60 * 1000);\n\n    const proposal: Proposal = {\n      id: generateId(),\n      type: input.type,\n      status: ProposalStatus.OPEN,\n      proposer: input.proposer,\n      payload: input.payload,\n      votes: [],\n      createdAt: now(),\n      closesAt,\n      description: input.description,\n    };\n\n    const result = await this.storage.saveProposal(proposal);\n    if (!result.ok) {\n      throw new GovernanceValidationError({\n        code: GovernanceErrorCode.STORAGE_ERROR,\n        message: result.error.message,\n      });\n    }\n\n    await this.storage.appendEvent({\n      cellId: this.cellId,\n      type: 'PROPOSAL_CREATED',\n      timestamp: now(),\n      data: {\n        proposalId: proposal.id,\n        type: proposal.type,\n        proposer: proposal.proposer,\n      },\n    });\n\n    return proposal;\n  }\n\n  async castVote(proposalId: ProposalId, vote: Omit<Vote, 'proposalId'>): Promise<Proposal> {\n    const proposal = await this.getProposal(proposalId);\n    if (!proposal) {\n      throw new GovernanceValidationError({\n        code: GovernanceErrorCode.PROPOSAL_NOT_FOUND,\n        message: `Proposal ${proposalId} not found`,\n      });\n    }\n\n    if (proposal.status !== ProposalStatus.OPEN) {\n      throw new GovernanceValidationError({\n        code: GovernanceErrorCode.VOTING_CLOSED,\n        message: `Voting is closed for proposal ${proposalId}`,\n      });\n    }\n\n    // Verify voter is council member\n    const isCouncil = await this.isCouncilMember(vote.voterId);\n    if (!isCouncil) {\n      throw new GovernanceValidationError({\n        code: GovernanceErrorCode.NOT_COUNCIL_MEMBER,\n        message: `${vote.voterId} is not a council member`,\n      });\n    }\n\n    // Check if already voted\n    if (proposal.votes.some(v => v.voterId === vote.voterId)) {\n      throw new GovernanceValidationError({\n        code: GovernanceErrorCode.ALREADY_VOTED,\n        message: `${vote.voterId} has already voted`,\n      });\n    }\n\n    const fullVote: Vote = {\n      ...vote,\n      proposalId,\n    };\n\n    proposal.votes.push(fullVote);\n\n    await this.storage.saveProposal(proposal);\n\n    await this.storage.appendEvent({\n      cellId: this.cellId,\n      type: 'VOTE_CAST',\n      timestamp: now(),\n      data: {\n        proposalId,\n        voterId: vote.voterId,\n        decision: vote.decision,\n      },\n    });\n\n    return proposal;\n  }\n\n  async closeVoting(proposalId: ProposalId): Promise<Proposal> {\n    const proposal = await this.getProposal(proposalId);\n    if (!proposal) {\n      throw new GovernanceValidationError({\n        code: GovernanceErrorCode.PROPOSAL_NOT_FOUND,\n        message: `Proposal ${proposalId} not found`,\n      });\n    }\n\n    if (proposal.status !== ProposalStatus.OPEN) {\n      throw new GovernanceValidationError({\n        code: GovernanceErrorCode.INVALID_STATUS_TRANSITION,\n        message: `Cannot close voting for proposal in status ${proposal.status}`,\n      });\n    }\n\n    const council = await this.getCouncil();\n    if (!council) {\n      throw new GovernanceValidationError({\n        code: GovernanceErrorCode.COUNCIL_NOT_FOUND,\n        message: 'Council not found',\n      });\n    }\n\n    // Calculate outcome\n    const outcome = this.calculateOutcome(proposal, council);\n\n    proposal.status = outcome;\n\n    await this.storage.saveProposal(proposal);\n\n    await this.storage.appendEvent({\n      cellId: this.cellId,\n      type: 'VOTING_CLOSED',\n      timestamp: now(),\n      data: {\n        proposalId,\n        outcome,\n      },\n    });\n\n    return proposal;\n  }\n\n  private calculateOutcome(proposal: Proposal, council: GovernanceCouncil): ProposalStatus {\n    const category = this.getActionCategory(proposal.type);\n    const threshold = category === ActionCategory.CRITICAL || category === ActionCategory.CONSTITUTIONAL\n      ? council.quorumRules.supermajorityThreshold\n      : 0.5;\n    const quorum = council.quorumRules.standardQuorum;\n\n    const approvals = proposal.votes.filter(v => v.decision === 'APPROVE').length;\n    const rejections = proposal.votes.filter(v => v.decision === 'REJECT').length;\n    const totalVotes = approvals + rejections;\n    const participation = totalVotes / council.members.length;\n\n    if (participation < quorum) {\n      return ProposalStatus.REJECTED; // No quorum\n    }\n\n    if (totalVotes === 0) {\n      return ProposalStatus.REJECTED;\n    }\n\n    const approvalRate = approvals / totalVotes;\n    if (approvalRate >= threshold) {\n      return ProposalStatus.PASSED;\n    }\n\n    return ProposalStatus.REJECTED;\n  }\n\n  async executeProposal(proposalId: ProposalId): Promise<void> {\n    const proposal = await this.getProposal(proposalId);\n    if (!proposal) {\n      throw new GovernanceValidationError({\n        code: GovernanceErrorCode.PROPOSAL_NOT_FOUND,\n        message: `Proposal ${proposalId} not found`,\n      });\n    }\n\n    if (proposal.status !== ProposalStatus.PASSED) {\n      throw new GovernanceValidationError({\n        code: GovernanceErrorCode.PROPOSAL_NOT_PASSED,\n        message: `Proposal ${proposalId} has not passed`,\n      });\n    }\n\n    // Execute based on type\n    switch (proposal.payload.type) {\n      case ProposalType.MEMBER_ADMISSION:\n        await this.identity.addMember(proposal.payload.admission);\n        break;\n\n      case ProposalType.MEMBER_EXCLUSION:\n        await this.identity.removeMember(\n          proposal.payload.memberId,\n          proposal.payload.reason,\n          proposal.proposer\n        );\n        break;\n\n      case ProposalType.LIMIT_ADJUSTMENT:\n        await this.ledger.updateMemberLimit(\n          proposal.payload.memberId,\n          proposal.payload.newLimit\n        );\n        break;\n\n      case ProposalType.COMMITMENT_CANCELLATION:\n        await this.commitments.cancelCommitment(\n          proposal.payload.commitmentId,\n          proposal.payload.reason,\n          proposal.proposer\n        );\n        break;\n\n      case ProposalType.DISPUTE_RESOLUTION:\n        await this.resolveDispute(\n          proposal.payload.disputeId,\n          proposal.payload.resolution\n        );\n        break;\n\n      default:\n        // Other types not yet implemented\n        break;\n    }\n\n    proposal.status = ProposalStatus.EXECUTED;\n    proposal.executedAt = now();\n\n    await this.storage.saveProposal(proposal);\n\n    await this.storage.appendEvent({\n      cellId: this.cellId,\n      type: 'PROPOSAL_EXECUTED',\n      timestamp: now(),\n      data: { proposalId },\n    });\n  }\n\n  async getProposal(id: ProposalId): Promise<Proposal | undefined> {\n    const result = await this.storage.getProposal(id);\n    if (!result.ok) return undefined;\n    return result.value ?? undefined;\n  }\n\n  async getActiveProposals(): Promise<Proposal[]> {\n    const result = await this.storage.getProposalsByStatus(ProposalStatus.OPEN);\n    if (!result.ok) return [];\n    return result.value;\n  }\n\n  // ============================================\n  // DIRECT ACTIONS (COUNCIL)\n  // ============================================\n\n  async admitMember(admission: AdmissionInfo, approverId: IdentityId): Promise<void> {\n    const isCouncil = await this.isCouncilMember(approverId);\n    if (!isCouncil) {\n      throw new GovernanceValidationError({\n        code: GovernanceErrorCode.NOT_COUNCIL_MEMBER,\n        message: `${approverId} is not a council member`,\n      });\n    }\n\n    await this.identity.addMember(admission);\n\n    await this.storage.appendEvent({\n      cellId: this.cellId,\n      type: 'MEMBER_ADMITTED_DIRECT',\n      timestamp: now(),\n      data: {\n        memberId: admission.applicantId,\n        approverId,\n      },\n    });\n  }\n\n  async excludeMember(memberId: IdentityId, reason: string, approverId: IdentityId): Promise<void> {\n    const isCouncil = await this.isCouncilMember(approverId);\n    if (!isCouncil) {\n      throw new GovernanceValidationError({\n        code: GovernanceErrorCode.NOT_COUNCIL_MEMBER,\n        message: `${approverId} is not a council member`,\n      });\n    }\n\n    // Check member balance\n    const memberState = this.ledger.getMemberState(memberId);\n    if (memberState && memberState.balance !== 0) {\n      throw new GovernanceValidationError({\n        code: GovernanceErrorCode.NON_ZERO_BALANCE,\n        message: `Cannot exclude member with non-zero balance: ${memberState.balance}`,\n      });\n    }\n\n    // Check for active commitments\n    const commitments = await this.commitments.getCommitmentsByMember(memberId);\n    const activeCommitments = commitments.filter(c =>\n      c.status === 'ACTIVE' || c.status === 'PROPOSED'\n    );\n    if (activeCommitments.length > 0) {\n      throw new GovernanceValidationError({\n        code: GovernanceErrorCode.ACTIVE_COMMITMENTS,\n        message: `Member has ${activeCommitments.length} active commitments`,\n      });\n    }\n\n    await this.identity.removeMember(memberId, reason, approverId);\n\n    await this.storage.appendEvent({\n      cellId: this.cellId,\n      type: 'MEMBER_EXCLUDED_DIRECT',\n      timestamp: now(),\n      data: { memberId, reason, approverId },\n    });\n  }\n\n  async adjustLimit(memberId: IdentityId, newLimit: Units, approverId: IdentityId): Promise<void> {\n    const isCouncil = await this.isCouncilMember(approverId);\n    if (!isCouncil) {\n      throw new GovernanceValidationError({\n        code: GovernanceErrorCode.NOT_COUNCIL_MEMBER,\n        message: `${approverId} is not a council member`,\n      });\n    }\n\n    const params = this.ledger.getParameters();\n    if (newLimit < params.minLimit || newLimit > params.maxLimit) {\n      throw new GovernanceValidationError({\n        code: GovernanceErrorCode.INVALID_LIMIT,\n        message: `Limit ${newLimit} out of range [${params.minLimit}, ${params.maxLimit}]`,\n      });\n    }\n\n    await this.ledger.updateMemberLimit(memberId, newLimit);\n\n    await this.storage.appendEvent({\n      cellId: this.cellId,\n      type: 'LIMIT_ADJUSTED_DIRECT',\n      timestamp: now(),\n      data: { memberId, newLimit, approverId },\n    });\n  }\n\n  // ============================================\n  // DISPUTES\n  // ============================================\n\n  async fileDispute(input: FileDisputeInput): Promise<Dispute> {\n    // Validate complainant\n    const complainantState = this.ledger.getMemberState(input.complainant);\n    if (!complainantState || complainantState.status !== MembershipStatus.ACTIVE) {\n      throw new GovernanceValidationError({\n        code: GovernanceErrorCode.UNAUTHORIZED,\n        message: `Complainant ${input.complainant} is not an active member`,\n      });\n    }\n\n    // Validate respondent\n    const respondentState = this.ledger.getMemberState(input.respondent);\n    if (!respondentState) {\n      throw new GovernanceValidationError({\n        code: GovernanceErrorCode.UNAUTHORIZED,\n        message: `Respondent ${input.respondent} not found`,\n      });\n    }\n\n    const evidence: Evidence[] = (input.evidence ?? []).map(e => ({\n      ...e,\n      id: generateId(),\n      timestamp: now(),\n    }));\n\n    const dispute: Dispute = {\n      id: generateId(),\n      type: input.type,\n      status: DisputeStatus.FILED,\n      complainant: input.complainant,\n      respondent: input.respondent,\n      commitmentId: input.commitmentId,\n      description: input.description,\n      evidence,\n      filedAt: now(),\n    };\n\n    const result = await this.storage.saveDispute(dispute);\n    if (!result.ok) {\n      throw new GovernanceValidationError({\n        code: GovernanceErrorCode.STORAGE_ERROR,\n        message: result.error.message,\n      });\n    }\n\n    await this.storage.appendEvent({\n      cellId: this.cellId,\n      type: 'DISPUTE_FILED',\n      timestamp: now(),\n      data: {\n        disputeId: dispute.id,\n        complainant: dispute.complainant,\n        respondent: dispute.respondent,\n        type: dispute.type,\n      },\n    });\n\n    return dispute;\n  }\n\n  async assignDisputeReviewer(disputeId: DisputeId, reviewerId: IdentityId): Promise<Dispute> {\n    const dispute = await this.getDispute(disputeId);\n    if (!dispute) {\n      throw new GovernanceValidationError({\n        code: GovernanceErrorCode.DISPUTE_NOT_FOUND,\n        message: `Dispute ${disputeId} not found`,\n      });\n    }\n\n    // Reviewer must be council member\n    const isCouncil = await this.isCouncilMember(reviewerId);\n    if (!isCouncil) {\n      throw new GovernanceValidationError({\n        code: GovernanceErrorCode.NOT_COUNCIL_MEMBER,\n        message: `${reviewerId} is not a council member`,\n      });\n    }\n\n    // Reviewer cannot be a party to the dispute\n    if (reviewerId === dispute.complainant || reviewerId === dispute.respondent) {\n      throw new GovernanceValidationError({\n        code: GovernanceErrorCode.UNAUTHORIZED,\n        message: 'Reviewer cannot be a party to the dispute',\n      });\n    }\n\n    dispute.reviewer = reviewerId;\n    dispute.status = DisputeStatus.UNDER_REVIEW;\n\n    await this.storage.saveDispute(dispute);\n\n    await this.storage.appendEvent({\n      cellId: this.cellId,\n      type: 'DISPUTE_REVIEWER_ASSIGNED',\n      timestamp: now(),\n      data: { disputeId, reviewerId },\n    });\n\n    return dispute;\n  }\n\n  async addEvidence(disputeId: DisputeId, evidence: Omit<Evidence, 'id' | 'timestamp'>): Promise<Dispute> {\n    const dispute = await this.getDispute(disputeId);\n    if (!dispute) {\n      throw new GovernanceValidationError({\n        code: GovernanceErrorCode.DISPUTE_NOT_FOUND,\n        message: `Dispute ${disputeId} not found`,\n      });\n    }\n\n    // Must be open dispute\n    if (dispute.status === DisputeStatus.RESOLVED || dispute.status === DisputeStatus.CLOSED) {\n      throw new GovernanceValidationError({\n        code: GovernanceErrorCode.INVALID_STATUS_TRANSITION,\n        message: 'Cannot add evidence to resolved dispute',\n      });\n    }\n\n    // Must be a party to the dispute\n    if (evidence.submittedBy !== dispute.complainant &&\n        evidence.submittedBy !== dispute.respondent &&\n        evidence.submittedBy !== dispute.reviewer) {\n      throw new GovernanceValidationError({\n        code: GovernanceErrorCode.UNAUTHORIZED,\n        message: 'Only parties to the dispute can add evidence',\n      });\n    }\n\n    const fullEvidence: Evidence = {\n      ...evidence,\n      id: generateId(),\n      timestamp: now(),\n    };\n\n    dispute.evidence.push(fullEvidence);\n\n    await this.storage.saveDispute(dispute);\n\n    return dispute;\n  }\n\n  async resolveDispute(disputeId: DisputeId, resolution: DisputeResolution): Promise<Dispute> {\n    const dispute = await this.getDispute(disputeId);\n    if (!dispute) {\n      throw new GovernanceValidationError({\n        code: GovernanceErrorCode.DISPUTE_NOT_FOUND,\n        message: `Dispute ${disputeId} not found`,\n      });\n    }\n\n    // Resolver must be council member\n    const isCouncil = await this.isCouncilMember(resolution.decidedBy);\n    if (!isCouncil) {\n      throw new GovernanceValidationError({\n        code: GovernanceErrorCode.NOT_COUNCIL_MEMBER,\n        message: `${resolution.decidedBy} is not a council member`,\n      });\n    }\n\n    dispute.resolution = resolution;\n    dispute.status = DisputeStatus.RESOLVED;\n    dispute.resolvedAt = now();\n\n    // Execute resolution actions if any\n    if (resolution.actions) {\n      for (const action of resolution.actions) {\n        switch (action.type) {\n          case 'CANCEL_COMMITMENT':\n            if (dispute.commitmentId) {\n              // Use complainant as initiator since they are a party to the commitment\n              // and the governance resolution authorizes the cancellation\n              await this.commitments.cancelCommitment(\n                dispute.commitmentId,\n                resolution.explanation,\n                dispute.complainant\n              );\n            }\n            break;\n          case 'COMPENSATION':\n            // Would need to execute a transaction\n            break;\n          // Other actions...\n        }\n      }\n    }\n\n    await this.storage.saveDispute(dispute);\n\n    await this.storage.appendEvent({\n      cellId: this.cellId,\n      type: 'DISPUTE_RESOLVED',\n      timestamp: now(),\n      data: {\n        disputeId,\n        outcome: resolution.outcome,\n        decidedBy: resolution.decidedBy,\n      },\n    });\n\n    return dispute;\n  }\n\n  async getDispute(id: DisputeId): Promise<Dispute | undefined> {\n    const result = await this.storage.getDispute(id);\n    if (!result.ok) return undefined;\n    return result.value ?? undefined;\n  }\n\n  async getActiveDisputes(): Promise<Dispute[]> {\n    const statuses = [DisputeStatus.FILED, DisputeStatus.UNDER_REVIEW, DisputeStatus.HEARING_SCHEDULED];\n    const results = await Promise.all(statuses.map(s => this.storage.getDisputesByStatus(s)));\n    const disputes: Dispute[] = [];\n    for (const result of results) {\n      if (result.ok) {\n        disputes.push(...result.value);\n      }\n    }\n    return disputes;\n  }\n\n  // ============================================\n  // AUTHORIZATION\n  // ============================================\n\n  async checkActionPermission(action: ProposalType, actorId: IdentityId): Promise<boolean> {\n    return this.isCouncilMember(actorId);\n  }\n\n  getActionCategory(action: ProposalType): ActionCategory {\n    switch (action) {\n      case ProposalType.MEMBER_EXCLUSION:\n      case ProposalType.EMERGENCY_STATE:\n      case ProposalType.PARAMETER_CHANGE:\n        return ActionCategory.CRITICAL;\n\n      case ProposalType.COUNCIL_ELECTION:\n        return ActionCategory.CONSTITUTIONAL;\n\n      case ProposalType.MEMBER_ADMISSION:\n      case ProposalType.LIMIT_ADJUSTMENT:\n        return ActionCategory.SIGNIFICANT;\n\n      default:\n        return ActionCategory.ROUTINE;\n    }\n  }\n}\n\n// ============================================\n// CUSTOM ERROR CLASS\n// ============================================\n\nexport class GovernanceValidationError extends Error {\n  public readonly code: GovernanceErrorCode;\n  public readonly details?: Record<string, unknown>;\n\n  constructor(error: GovernanceError) {\n    super(error.message);\n    this.name = 'GovernanceValidationError';\n    this.code = error.code;\n    this.details = error.details;\n  }\n\n  toJSON(): GovernanceError {\n    return {\n      code: this.code,\n      message: this.message,\n      details: this.details,\n    };\n  }\n}\n\n// ============================================\n// FACTORY\n// ============================================\n\n/**\n * Create a new governance engine\n */\nexport function createGovernanceEngine(\n  cellId: CellId,\n  ledger: LedgerEngine,\n  identity: IdentityEngine,\n  commitments: CommitmentEngine,\n  storage: IStorage\n): GovernanceEngine {\n  return new GovernanceEngine(cellId, ledger, identity, commitments, storage);\n}\n", "/**\n * Cell Protocol - Scheduler Engine\n *\n * Implementation of the Survival Scheduler (PRD-08).\n * Manages task scheduling, matching, and coverage.\n */\n\nimport {\n  IdentityId,\n  Timestamp,\n  Units,\n  MembershipStatus,\n  now,\n  generateId,\n} from '../types/common';\nimport {\n  TaskCategory,\n  CommitmentType,\n} from '../types/commitment';\nimport {\n  TaskSlotId,\n  TaskTemplateId,\n  TaskSlotStatus,\n  TaskSlot,\n  TaskTemplate,\n  TaskAssignment,\n  MemberSupply,\n  FeasibilityResult,\n  MatchingResult,\n  CoverageReport,\n  CategoryCoverage,\n  CreateSlotInput,\n  CreateTemplateInput,\n  SchedulerError,\n  SchedulerErrorCode,\n  ISchedulerEngine,\n  TaskCategoryDefinition,\n} from '../types/scheduler';\nimport { LedgerEngine } from './ledger-engine';\nimport { CommitmentEngine } from './commitment-engine';\nimport { EnergyEngine } from './energy-engine';\nimport { IStorage } from '../storage/pouchdb-adapter';\n\n// ============================================\n// SCHEDULER ENGINE IMPLEMENTATION\n// ============================================\n\nexport class SchedulerEngine implements ISchedulerEngine {\n  private ledger: LedgerEngine;\n  private commitments: CommitmentEngine;\n  private energy?: EnergyEngine;\n  private storage: IStorage;\n  private debtorPriorityEnabled = false;\n\n  constructor(\n    ledger: LedgerEngine,\n    commitments: CommitmentEngine,\n    storage: IStorage\n  ) {\n    this.ledger = ledger;\n    this.commitments = commitments;\n    this.storage = storage;\n  }\n\n  /** Set the energy engine (Phase 4 integration) */\n  setEnergyEngine(energy: EnergyEngine): void {\n    this.energy = energy;\n  }\n\n  // ============================================\n  // TEMPLATES\n  // ============================================\n\n  async createTaskTemplate(input: CreateTemplateInput): Promise<TaskTemplate> {\n    const template: TaskTemplate = {\n      id: generateId(),\n      category: input.category,\n      name: input.name,\n      hoursRequired: input.hoursRequired,\n      creditValue: input.creditValue,\n      maxAssignees: input.maxAssignees,\n      dayOfWeek: input.dayOfWeek,\n      startHour: input.startHour,\n      durationHours: input.durationHours,\n      active: true,\n      description: input.description,\n    };\n\n    const result = await this.storage.saveTaskTemplate(template);\n    if (!result.ok) {\n      throw new SchedulerValidationError({\n        code: SchedulerErrorCode.STORAGE_ERROR,\n        message: result.error.message,\n      });\n    }\n\n    return template;\n  }\n\n  async getTaskTemplate(id: TaskTemplateId): Promise<TaskTemplate | undefined> {\n    const result = await this.storage.getTaskTemplate(id);\n    if (!result.ok) return undefined;\n    return result.value ?? undefined;\n  }\n\n  async generateSlotsFromTemplate(templateId: TaskTemplateId, weekStart: Timestamp): Promise<TaskSlot[]> {\n    const template = await this.getTaskTemplate(templateId);\n    if (!template) {\n      throw new SchedulerValidationError({\n        code: SchedulerErrorCode.TEMPLATE_NOT_FOUND,\n        message: `Template ${templateId} not found`,\n      });\n    }\n\n    const slots: TaskSlot[] = [];\n    const weekStartDate = new Date(weekStart);\n\n    // Generate slots for each day in the week\n    for (let day = 0; day < 7; day++) {\n      // If template is for specific day, only generate for that day\n      if (template.dayOfWeek !== null && template.dayOfWeek !== undefined && template.dayOfWeek !== day) {\n        continue;\n      }\n\n      const slotDate = new Date(weekStartDate);\n      slotDate.setDate(slotDate.getDate() + day);\n      slotDate.setHours(template.startHour, 0, 0, 0);\n\n      const startTime = slotDate.getTime();\n      const endTime = startTime + (template.durationHours * 60 * 60 * 1000);\n\n      const slot: TaskSlot = {\n        id: generateId(),\n        category: template.category,\n        name: template.name,\n        startTime,\n        endTime,\n        hoursRequired: template.hoursRequired,\n        creditValue: template.creditValue,\n        maxAssignees: template.maxAssignees,\n        status: TaskSlotStatus.OPEN,\n        assignments: [],\n        templateId,\n        description: template.description,\n      };\n\n      const saveResult = await this.storage.saveTaskSlot(slot);\n      if (saveResult.ok) {\n        slots.push(slot);\n      }\n    }\n\n    return slots;\n  }\n\n  async getActiveTemplates(): Promise<TaskTemplate[]> {\n    const result = await this.storage.getAllTaskTemplates();\n    if (!result.ok) return [];\n    return result.value.filter(t => t.active);\n  }\n\n  // ============================================\n  // SLOTS\n  // ============================================\n\n  async createTaskSlot(input: CreateSlotInput): Promise<TaskSlot> {\n    if (input.endTime <= input.startTime) {\n      throw new SchedulerValidationError({\n        code: SchedulerErrorCode.INVALID_TIME_RANGE,\n        message: 'End time must be after start time',\n      });\n    }\n\n    if (input.hoursRequired <= 0) {\n      throw new SchedulerValidationError({\n        code: SchedulerErrorCode.INVALID_HOURS,\n        message: 'Hours required must be positive',\n      });\n    }\n\n    const slot: TaskSlot = {\n      id: generateId(),\n      category: input.category,\n      name: input.name,\n      startTime: input.startTime,\n      endTime: input.endTime,\n      hoursRequired: input.hoursRequired,\n      creditValue: input.creditValue,\n      maxAssignees: input.maxAssignees,\n      status: TaskSlotStatus.OPEN,\n      assignments: [],\n      description: input.description,\n    };\n\n    const result = await this.storage.saveTaskSlot(slot);\n    if (!result.ok) {\n      throw new SchedulerValidationError({\n        code: SchedulerErrorCode.STORAGE_ERROR,\n        message: result.error.message,\n      });\n    }\n\n    return slot;\n  }\n\n  async getTaskSlot(id: TaskSlotId): Promise<TaskSlot | undefined> {\n    const result = await this.storage.getTaskSlot(id);\n    if (!result.ok) return undefined;\n    return result.value ?? undefined;\n  }\n\n  async getOpenSlots(category?: TaskCategory): Promise<TaskSlot[]> {\n    const result = await this.storage.getTaskSlotsByStatus(TaskSlotStatus.OPEN);\n    if (!result.ok) return [];\n\n    let slots = result.value;\n    if (category) {\n      slots = slots.filter(s => s.category === category);\n    }\n\n    return slots;\n  }\n\n  async getSlotsByPeriod(start: Timestamp, end: Timestamp): Promise<TaskSlot[]> {\n    const result = await this.storage.getTaskSlotsByPeriod(start, end);\n    if (!result.ok) return [];\n    return result.value;\n  }\n\n  // ============================================\n  // ASSIGNMENT\n  // ============================================\n\n  async runMatching(weekStart: Timestamp): Promise<MatchingResult> {\n    const weekEnd = weekStart + (7 * 24 * 60 * 60 * 1000);\n    const slots = await this.getSlotsByPeriod(weekStart, weekEnd);\n    const openSlots = slots.filter(s =>\n      s.status === TaskSlotStatus.OPEN || s.status === TaskSlotStatus.PARTIALLY_FILLED\n    );\n\n    const suppliesResult = await this.storage.getAllMemberSupplies();\n    const supplies = suppliesResult.ok ? suppliesResult.value : [];\n\n    const assignments: TaskAssignment[] = [];\n    const unfilledSlots: TaskSlotId[] = [];\n    const assignedMembers = new Set<IdentityId>();\n\n    // Sort slots by category priority (essential first)\n    const categoryPriority: TaskCategory[] = [\n      TaskCategory.MEDICAL,\n      TaskCategory.FOOD,\n      TaskCategory.WATER_SANITATION,\n      TaskCategory.ENERGY_HEAT,\n      TaskCategory.CHILDCARE_DEPENDENT,\n      TaskCategory.SECURITY_COORDINATION,\n      TaskCategory.SHELTER_REPAIR,\n      TaskCategory.PROCUREMENT_TRANSPORT,\n      TaskCategory.GENERAL,\n    ];\n\n    openSlots.sort((a, b) => {\n      const aIdx = categoryPriority.indexOf(a.category);\n      const bIdx = categoryPriority.indexOf(b.category);\n      return aIdx - bIdx;\n    });\n\n    for (const slot of openSlots) {\n      const neededAssignees = slot.maxAssignees - slot.assignments.length;\n      if (neededAssignees <= 0) continue;\n\n      // Score and rank candidates\n      const candidates = supplies\n        .filter(s => !assignedMembers.has(s.memberId))\n        .filter(s => {\n          const state = this.ledger.getMemberState(s.memberId);\n          return state && state.status === MembershipStatus.ACTIVE;\n        })\n        .map(s => ({\n          supply: s,\n          score: this.scoreCandidate(s, slot),\n        }))\n        .filter(c => c.score > 0)\n        .sort((a, b) => b.score - a.score);\n\n      // Assign top candidates\n      for (let i = 0; i < Math.min(neededAssignees, candidates.length); i++) {\n        const candidate = candidates[i];\n        try {\n          const assignment = await this.assignMember(\n            slot.id,\n            candidate.supply.memberId,\n            slot.hoursRequired / slot.maxAssignees\n          );\n          assignments.push(assignment);\n          assignedMembers.add(candidate.supply.memberId);\n        } catch (e) {\n          // Skip if assignment fails\n        }\n      }\n\n      // Check if slot is still unfilled\n      const updatedSlot = await this.getTaskSlot(slot.id);\n      if (updatedSlot && updatedSlot.assignments.length < updatedSlot.maxAssignees) {\n        unfilledSlots.push(slot.id);\n      }\n    }\n\n    // Find members who weren't assigned\n    const unassignedMembers = supplies\n      .filter(s => !assignedMembers.has(s.memberId))\n      .map(s => s.memberId);\n\n    // Calculate coverage\n    const totalSlots = openSlots.length;\n    const filledSlots = totalSlots - unfilledSlots.length;\n    const coverageAchieved = totalSlots > 0 ? filledSlots / totalSlots : 1;\n\n    return {\n      assignments,\n      unfilledSlots,\n      unassignedMembers,\n      coverageAchieved,\n      matchingScore: coverageAchieved,\n    };\n  }\n\n  private scoreCandidate(member: MemberSupply, slot: TaskSlot): number {\n    const effectiveness = member.skills.get(slot.category) ?? 0.5;\n    const preference = member.preferences.includes(slot.category) ? 1 : 0;\n\n    // Debtor priority: members with negative balance get priority for earning\n    let debtorScore = 0;\n    if (this.debtorPriorityEnabled) {\n      const state = this.ledger.getMemberState(member.memberId);\n      if (state && state.balance < 0) {\n        // Higher score for members closer to floor\n        debtorScore = (-state.balance / state.limit) * 2; // 0-2 range\n      }\n    }\n\n    // Energy availability factor (Phase 4)\n    // If we have energy engine, check if task can be completed\n    const energyFactor = this.energy\n      ? (this.energy.canCompleteTask(slot.category, slot.hoursRequired / slot.maxAssignees) ? 1 : 0.5)\n      : 1;\n\n    // Adjusted weights with energy factor\n    return effectiveness * 0.35 + preference * 0.15 + debtorScore * 0.35 + energyFactor * 0.15;\n  }\n\n  async assignMember(slotId: TaskSlotId, memberId: IdentityId, hours: number): Promise<TaskAssignment> {\n    const slot = await this.getTaskSlot(slotId);\n    if (!slot) {\n      throw new SchedulerValidationError({\n        code: SchedulerErrorCode.SLOT_NOT_FOUND,\n        message: `Slot ${slotId} not found`,\n      });\n    }\n\n    if (slot.status !== TaskSlotStatus.OPEN && slot.status !== TaskSlotStatus.PARTIALLY_FILLED) {\n      throw new SchedulerValidationError({\n        code: SchedulerErrorCode.INVALID_SLOT_STATUS,\n        message: `Cannot assign to slot in status ${slot.status}`,\n      });\n    }\n\n    if (slot.assignments.length >= slot.maxAssignees) {\n      throw new SchedulerValidationError({\n        code: SchedulerErrorCode.SLOT_FULL,\n        message: 'Slot is full',\n      });\n    }\n\n    // Check if member already assigned\n    if (slot.assignments.some(a => a.memberId === memberId)) {\n      throw new SchedulerValidationError({\n        code: SchedulerErrorCode.ALREADY_ASSIGNED,\n        message: `Member ${memberId} already assigned to slot`,\n      });\n    }\n\n    // Validate member\n    const memberState = this.ledger.getMemberState(memberId);\n    if (!memberState || memberState.status !== MembershipStatus.ACTIVE) {\n      throw new SchedulerValidationError({\n        code: SchedulerErrorCode.MEMBER_NOT_FOUND,\n        message: `Member ${memberId} not found or not active`,\n      });\n    }\n\n    // Calculate credit value for this assignment\n    const creditValue = Math.floor((hours / slot.hoursRequired) * slot.creditValue);\n\n    // Create escrowed commitment for the assignment\n    // The cell (represented by a system account or pool) is the promisee\n    // For simplicity, we'll skip commitment creation here and handle it differently\n    // In a real implementation, there would be a cell treasury or pool account\n\n    const assignment: TaskAssignment = {\n      slotId,\n      memberId,\n      hoursAssigned: hours,\n      status: 'ASSIGNED',\n      assignedAt: now(),\n    };\n\n    slot.assignments.push(assignment);\n\n    // Update slot status\n    if (slot.assignments.length >= slot.maxAssignees) {\n      slot.status = TaskSlotStatus.FILLED;\n    } else {\n      slot.status = TaskSlotStatus.PARTIALLY_FILLED;\n    }\n\n    await this.storage.saveTaskSlot(slot);\n\n    await this.storage.appendEvent({\n      cellId: this.ledger.getCellId(),\n      type: 'MEMBER_ASSIGNED_TO_SLOT',\n      timestamp: now(),\n      data: { slotId, memberId, hours },\n    });\n\n    return assignment;\n  }\n\n  async confirmAssignment(slotId: TaskSlotId, memberId: IdentityId): Promise<TaskAssignment> {\n    const slot = await this.getTaskSlot(slotId);\n    if (!slot) {\n      throw new SchedulerValidationError({\n        code: SchedulerErrorCode.SLOT_NOT_FOUND,\n        message: `Slot ${slotId} not found`,\n      });\n    }\n\n    const assignment = slot.assignments.find(a => a.memberId === memberId);\n    if (!assignment) {\n      throw new SchedulerValidationError({\n        code: SchedulerErrorCode.NOT_ASSIGNED,\n        message: `Member ${memberId} not assigned to slot`,\n      });\n    }\n\n    assignment.status = 'CONFIRMED';\n    assignment.confirmedAt = now();\n\n    await this.storage.saveTaskSlot(slot);\n\n    return assignment;\n  }\n\n  async unassignMember(slotId: TaskSlotId, memberId: IdentityId): Promise<void> {\n    const slot = await this.getTaskSlot(slotId);\n    if (!slot) {\n      throw new SchedulerValidationError({\n        code: SchedulerErrorCode.SLOT_NOT_FOUND,\n        message: `Slot ${slotId} not found`,\n      });\n    }\n\n    const assignmentIndex = slot.assignments.findIndex(a => a.memberId === memberId);\n    if (assignmentIndex === -1) {\n      throw new SchedulerValidationError({\n        code: SchedulerErrorCode.NOT_ASSIGNED,\n        message: `Member ${memberId} not assigned to slot`,\n      });\n    }\n\n    // Cancel associated commitment if any\n    const assignment = slot.assignments[assignmentIndex];\n    if (assignment.commitmentId) {\n      await this.commitments.cancelCommitment(\n        assignment.commitmentId,\n        'Unassigned from slot',\n        memberId\n      );\n    }\n\n    slot.assignments.splice(assignmentIndex, 1);\n\n    // Update slot status\n    if (slot.assignments.length === 0) {\n      slot.status = TaskSlotStatus.OPEN;\n    } else if (slot.assignments.length < slot.maxAssignees) {\n      slot.status = TaskSlotStatus.PARTIALLY_FILLED;\n    }\n\n    await this.storage.saveTaskSlot(slot);\n\n    await this.storage.appendEvent({\n      cellId: this.ledger.getCellId(),\n      type: 'MEMBER_UNASSIGNED_FROM_SLOT',\n      timestamp: now(),\n      data: { slotId, memberId },\n    });\n  }\n\n  // ============================================\n  // COMPLETION\n  // ============================================\n\n  async recordCompletion(\n    slotId: TaskSlotId,\n    memberId: IdentityId,\n    rating?: number\n  ): Promise<{ assignment: TaskAssignment; payerNewBalance?: Units; payeeNewBalance?: Units }> {\n    const slot = await this.getTaskSlot(slotId);\n    if (!slot) {\n      throw new SchedulerValidationError({\n        code: SchedulerErrorCode.SLOT_NOT_FOUND,\n        message: `Slot ${slotId} not found`,\n      });\n    }\n\n    const assignment = slot.assignments.find(a => a.memberId === memberId);\n    if (!assignment) {\n      throw new SchedulerValidationError({\n        code: SchedulerErrorCode.NOT_ASSIGNED,\n        message: `Member ${memberId} not assigned to slot`,\n      });\n    }\n\n    assignment.status = 'COMPLETED';\n    assignment.completedAt = now();\n    if (rating !== undefined) {\n      assignment.rating = rating;\n    }\n\n    // Check if all assignments are complete\n    const allComplete = slot.assignments.every(a => a.status === 'COMPLETED' || a.status === 'NO_SHOW');\n    if (allComplete) {\n      slot.status = TaskSlotStatus.COMPLETED;\n    } else {\n      slot.status = TaskSlotStatus.IN_PROGRESS;\n    }\n\n    await this.storage.saveTaskSlot(slot);\n\n    await this.storage.appendEvent({\n      cellId: this.ledger.getCellId(),\n      type: 'TASK_COMPLETED',\n      timestamp: now(),\n      data: { slotId, memberId, rating },\n    });\n\n    // If there's a linked commitment, fulfill it\n    if (assignment.commitmentId) {\n      const result = await this.commitments.fulfillCommitment(assignment.commitmentId, {\n        commitmentId: assignment.commitmentId,\n        confirmedBy: memberId, // In reality, this would be a supervisor\n        rating,\n        timestamp: now(),\n      });\n      return {\n        assignment,\n        payerNewBalance: result.payerNewBalance,\n        payeeNewBalance: result.payeeNewBalance,\n      };\n    }\n\n    return { assignment };\n  }\n\n  async recordNoShow(slotId: TaskSlotId, memberId: IdentityId): Promise<void> {\n    const slot = await this.getTaskSlot(slotId);\n    if (!slot) {\n      throw new SchedulerValidationError({\n        code: SchedulerErrorCode.SLOT_NOT_FOUND,\n        message: `Slot ${slotId} not found`,\n      });\n    }\n\n    const assignment = slot.assignments.find(a => a.memberId === memberId);\n    if (!assignment) {\n      throw new SchedulerValidationError({\n        code: SchedulerErrorCode.NOT_ASSIGNED,\n        message: `Member ${memberId} not assigned to slot`,\n      });\n    }\n\n    assignment.status = 'NO_SHOW';\n\n    // Cancel associated commitment if any\n    if (assignment.commitmentId) {\n      await this.commitments.cancelCommitment(\n        assignment.commitmentId,\n        'No show',\n        memberId\n      );\n    }\n\n    // Check if slot is now incomplete\n    const allDone = slot.assignments.every(a => a.status === 'COMPLETED' || a.status === 'NO_SHOW');\n    if (allDone) {\n      const anyComplete = slot.assignments.some(a => a.status === 'COMPLETED');\n      slot.status = anyComplete ? TaskSlotStatus.COMPLETED : TaskSlotStatus.INCOMPLETE;\n    }\n\n    await this.storage.saveTaskSlot(slot);\n\n    await this.storage.appendEvent({\n      cellId: this.ledger.getCellId(),\n      type: 'MEMBER_NO_SHOW',\n      timestamp: now(),\n      data: { slotId, memberId },\n    });\n  }\n\n  // ============================================\n  // COVERAGE\n  // ============================================\n\n  async checkCoverageFeasibility(weekStart: Timestamp): Promise<FeasibilityResult> {\n    const weekEnd = weekStart + (7 * 24 * 60 * 60 * 1000);\n    const slots = await this.getSlotsByPeriod(weekStart, weekEnd);\n    const suppliesResult = await this.storage.getAllMemberSupplies();\n    const supplies = suppliesResult.ok ? suppliesResult.value : [];\n\n    // Calculate total required by category\n    const categoryRequired = new Map<TaskCategory, number>();\n    for (const slot of slots) {\n      const current = categoryRequired.get(slot.category) ?? 0;\n      categoryRequired.set(slot.category, current + slot.hoursRequired);\n    }\n\n    // Calculate total available by category\n    const categoryAvailable = new Map<TaskCategory, number>();\n    for (const supply of supplies) {\n      // Distribute hours based on skill levels\n      const totalSkill = Array.from(supply.skills.values()).reduce((sum, v) => sum + v, 0) || 1;\n      for (const [cat, skill] of supply.skills) {\n        const hours = (skill / totalSkill) * supply.weeklyAvailableHours;\n        const current = categoryAvailable.get(cat) ?? 0;\n        categoryAvailable.set(cat, current + hours);\n      }\n    }\n\n    // Calculate gaps\n    const categoryGaps = new Map<TaskCategory, number>();\n    const bottlenecks: string[] = [];\n    const recommendations: string[] = [];\n\n    let totalRequired = 0;\n    let totalAvailable = 0;\n\n    for (const [category, required] of categoryRequired) {\n      totalRequired += required;\n      const available = categoryAvailable.get(category) ?? 0;\n      totalAvailable += available;\n      const gap = available - required;\n      categoryGaps.set(category, gap);\n\n      if (gap < 0) {\n        bottlenecks.push(`${category}: ${Math.abs(gap)} hours short`);\n        recommendations.push(`Recruit more members skilled in ${category}`);\n      }\n    }\n\n    const feasible = bottlenecks.length === 0;\n\n    return {\n      feasible,\n      totalRequired,\n      totalAvailable,\n      categoryGaps,\n      bottlenecks,\n      recommendations,\n    };\n  }\n\n  async getCoverageReport(weekStart: Timestamp): Promise<CoverageReport> {\n    const weekEnd = weekStart + (7 * 24 * 60 * 60 * 1000);\n    const slots = await this.getSlotsByPeriod(weekStart, weekEnd);\n\n    // Group by category\n    const categoryStats = new Map<TaskCategory, {\n      total: number;\n      filled: number;\n      completed: number;\n      hours: number;\n      coveredHours: number;\n    }>();\n\n    let totalSlots = 0;\n    let filledSlots = 0;\n    let totalHoursScheduled = 0;\n    let totalHoursCompleted = 0;\n\n    for (const slot of slots) {\n      totalSlots++;\n      totalHoursScheduled += slot.hoursRequired;\n\n      const isFilled = slot.status === TaskSlotStatus.FILLED ||\n                       slot.status === TaskSlotStatus.IN_PROGRESS ||\n                       slot.status === TaskSlotStatus.COMPLETED;\n      if (isFilled) filledSlots++;\n\n      const completedAssignments = slot.assignments.filter(a => a.status === 'COMPLETED');\n      const completedHours = completedAssignments.reduce((sum, a) => sum + a.hoursAssigned, 0);\n      totalHoursCompleted += completedHours;\n\n      // Update category stats\n      const stats = categoryStats.get(slot.category) ?? {\n        total: 0,\n        filled: 0,\n        completed: 0,\n        hours: 0,\n        coveredHours: 0,\n      };\n      stats.total++;\n      if (isFilled) stats.filled++;\n      if (slot.status === TaskSlotStatus.COMPLETED) stats.completed++;\n      stats.hours += slot.hoursRequired;\n      stats.coveredHours += completedHours;\n      categoryStats.set(slot.category, stats);\n    }\n\n    // Build category breakdown\n    const categoryBreakdown = new Map<TaskCategory, CategoryCoverage>();\n    for (const [category, stats] of categoryStats) {\n      categoryBreakdown.set(category, {\n        category,\n        totalSlots: stats.total,\n        filledSlots: stats.filled,\n        completedSlots: stats.completed,\n        totalHours: stats.hours,\n        coveredHours: stats.coveredHours,\n        coverageRate: stats.total > 0 ? stats.filled / stats.total : 1,\n      });\n    }\n\n    return {\n      periodStart: weekStart,\n      periodEnd: weekEnd,\n      overallCoverage: totalSlots > 0 ? filledSlots / totalSlots : 1,\n      categoryBreakdown,\n      totalSlots,\n      filledSlots,\n      totalHoursScheduled,\n      totalHoursCompleted,\n    };\n  }\n\n  // ============================================\n  // MEMBER\n  // ============================================\n\n  async getMemberSchedule(memberId: IdentityId, weekStart: Timestamp): Promise<TaskSlot[]> {\n    const weekEnd = weekStart + (7 * 24 * 60 * 60 * 1000);\n    const slots = await this.getSlotsByPeriod(weekStart, weekEnd);\n    return slots.filter(s => s.assignments.some(a => a.memberId === memberId));\n  }\n\n  async updateMemberSupply(supply: MemberSupply): Promise<void> {\n    const result = await this.storage.saveMemberSupply(supply);\n    if (!result.ok) {\n      throw new SchedulerValidationError({\n        code: SchedulerErrorCode.STORAGE_ERROR,\n        message: result.error.message,\n      });\n    }\n  }\n\n  async getMemberSupply(memberId: IdentityId): Promise<MemberSupply | undefined> {\n    const result = await this.storage.getMemberSupply(memberId);\n    if (!result.ok) return undefined;\n    return result.value ?? undefined;\n  }\n\n  // ============================================\n  // DEBTOR PRIORITY\n  // ============================================\n\n  enableDebtorPriorityMatching(): void {\n    this.debtorPriorityEnabled = true;\n  }\n\n  disableDebtorPriorityMatching(): void {\n    this.debtorPriorityEnabled = false;\n  }\n\n  isDebtorPriorityEnabled(): boolean {\n    return this.debtorPriorityEnabled;\n  }\n\n  // ============================================\n  // PHASE 4: BUNDLE COST & ESSENTIAL TASKS\n  // ============================================\n\n  /**\n   * Get the essential task categories with their minimum weekly hours\n   */\n  getEssentialTaskCategories(): TaskCategoryDefinition[] {\n    return [\n      { category: TaskCategory.MEDICAL, minimumWeeklyHours: 4, isEssential: true },\n      { category: TaskCategory.FOOD, minimumWeeklyHours: 14, isEssential: true },\n      { category: TaskCategory.WATER_SANITATION, minimumWeeklyHours: 7, isEssential: true },\n      { category: TaskCategory.ENERGY_HEAT, minimumWeeklyHours: 7, isEssential: true },\n      { category: TaskCategory.CHILDCARE_DEPENDENT, minimumWeeklyHours: 14, isEssential: true },\n      { category: TaskCategory.SECURITY_COORDINATION, minimumWeeklyHours: 7, isEssential: true },\n      { category: TaskCategory.SHELTER_REPAIR, minimumWeeklyHours: 4, isEssential: false },\n      { category: TaskCategory.PROCUREMENT_TRANSPORT, minimumWeeklyHours: 7, isEssential: false },\n      { category: TaskCategory.GENERAL, minimumWeeklyHours: 7, isEssential: false },\n    ];\n  }\n\n  /**\n   * Calculate the weekly bundle cost per member\n   * c_E = sum(H_t^min for essential t) / N\n   */\n  calculateWeeklyBundleCost(): number {\n    const essentialCategories = this.getEssentialTaskCategories()\n      .filter(c => c.isEssential);\n\n    const totalEssentialHours = essentialCategories\n      .reduce((sum, cat) => sum + cat.minimumWeeklyHours, 0);\n\n    const memberCount = this.ledger.getStatistics().memberCount;\n\n    return memberCount > 0 ? totalEssentialHours / memberCount : 0;\n  }\n\n  /**\n   * Get the energy engine if set (for external access)\n   */\n  getEnergyEngine(): EnergyEngine | undefined {\n    return this.energy;\n  }\n}\n\n// ============================================\n// CUSTOM ERROR CLASS\n// ============================================\n\nexport class SchedulerValidationError extends Error {\n  public readonly code: SchedulerErrorCode;\n  public readonly details?: Record<string, unknown>;\n\n  constructor(error: SchedulerError) {\n    super(error.message);\n    this.name = 'SchedulerValidationError';\n    this.code = error.code;\n    this.details = error.details;\n  }\n\n  toJSON(): SchedulerError {\n    return {\n      code: this.code,\n      message: this.message,\n      details: this.details,\n    };\n  }\n}\n\n// ============================================\n// FACTORY\n// ============================================\n\n/**\n * Create a new scheduler engine\n */\nexport function createSchedulerEngine(\n  ledger: LedgerEngine,\n  commitments: CommitmentEngine,\n  storage: IStorage\n): SchedulerEngine {\n  return new SchedulerEngine(ledger, commitments, storage);\n}\n", "/**\n * Cell Protocol - Emergency Engine\n *\n * Implementation of the Emergency Mode System (PRD-07).\n * Manages risk states, stress indicators, and policy application.\n */\n\nimport {\n  CellId,\n  IdentityId,\n  Timestamp,\n  Units,\n  now,\n} from '../types/common';\nimport {\n  RiskState,\n  AdmissionMode,\n  CommitmentMode,\n  SchedulerPriority,\n  StressIndicators,\n  EmergencyPolicy,\n  TransitionThresholds,\n  TransitionReason,\n  StateTransitionResult,\n  StateHistoryEntry,\n  ThresholdProximityReport,\n  EmergencyState,\n  EmergencyError,\n  EmergencyErrorCode,\n  IEmergencyEngine,\n  DEFAULT_POLICIES,\n  DEFAULT_THRESHOLDS,\n} from '../types/emergency';\nimport { LedgerEngine } from './ledger-engine';\nimport { GovernanceEngine } from './governance-engine';\nimport { IdentityEngine } from './identity-engine';\nimport { EnergyEngine } from './energy-engine';\nimport { IStorage } from '../storage/pouchdb-adapter';\n\n// ============================================\n// EMERGENCY ENGINE IMPLEMENTATION\n// ============================================\n\nexport class EmergencyEngine implements IEmergencyEngine {\n  private cellId: CellId;\n  private ledger: LedgerEngine;\n  private governance?: GovernanceEngine;\n  private identity?: IdentityEngine;\n  private energy?: EnergyEngine;\n  private storage: IStorage;\n\n  private state: EmergencyState;\n\n  constructor(\n    cellId: CellId,\n    ledger: LedgerEngine,\n    storage: IStorage,\n    thresholds: Partial<TransitionThresholds> = {}\n  ) {\n    this.cellId = cellId;\n    this.ledger = ledger;\n    this.storage = storage;\n\n    // Initialize state\n    const timestamp = now();\n    this.state = {\n      cellId,\n      riskState: RiskState.NORMAL,\n      currentPolicy: { ...DEFAULT_POLICIES[RiskState.NORMAL] },\n      indicators: this.createEmptyIndicators(timestamp),\n      thresholds: { ...DEFAULT_THRESHOLDS, ...thresholds },\n      lastStateChange: timestamp,\n      panicEnteredAt: null,\n      lastIndicatorUpdate: timestamp,\n      createdAt: timestamp,\n      updatedAt: timestamp,\n    };\n  }\n\n  /** Set the governance engine (circular dependency resolution) */\n  setGovernanceEngine(governance: GovernanceEngine): void {\n    this.governance = governance;\n  }\n\n  /** Set the identity engine (circular dependency resolution) */\n  setIdentityEngine(identity: IdentityEngine): void {\n    this.identity = identity;\n  }\n\n  /** Set the energy engine (Phase 4 integration) */\n  setEnergyEngine(energy: EnergyEngine): void {\n    this.energy = energy;\n  }\n\n  // ============================================\n  // CORE INTERFACE METHODS\n  // ============================================\n\n  getCellId(): CellId {\n    return this.cellId;\n  }\n\n  getCurrentRiskState(): RiskState {\n    return this.state.riskState;\n  }\n\n  getStressIndicators(): StressIndicators {\n    return { ...this.state.indicators };\n  }\n\n  getCurrentPolicy(): EmergencyPolicy {\n    return { ...this.state.currentPolicy };\n  }\n\n  getThresholds(): TransitionThresholds {\n    return { ...this.state.thresholds };\n  }\n\n  // ============================================\n  // INDICATOR CALCULATION\n  // ============================================\n\n  async updateIndicators(): Promise<StressIndicators> {\n    const timestamp = now();\n    const stats = this.ledger.getStatistics();\n\n    // Calculate floor mass: fraction of total limit held by members at floor\n    // A member is \"at floor\" when balance + limit <= small threshold (e.g., 5% of limit)\n    let floorMassNumerator = 0;\n    const members = this.ledger.getAllMemberStates();\n    const floorThresholdFraction = 0.05;\n\n    for (const [, member] of members) {\n      const distanceToFloor = member.balance + member.limit;\n      const threshold = member.limit * floorThresholdFraction;\n      if (distanceToFloor <= threshold) {\n        floorMassNumerator += member.limit;\n      }\n    }\n\n    const floorMass = stats.aggregateCapacity > 0\n      ? floorMassNumerator / stats.aggregateCapacity\n      : 0;\n\n    // Calculate balance variance (coefficient of variation)\n    const balances = Array.from(members.values()).map(m => m.balance);\n    const balanceVariance = this.calculateVarianceCoefficient(balances);\n\n    // Calculate dispute rate (disputes per transaction in recent period)\n    let disputeRate = 0;\n    if (this.governance) {\n      const disputes = await this.governance.getActiveDisputes();\n      // Simple approximation: disputes / member count as a proxy\n      disputeRate = stats.memberCount > 0 ? disputes.length / stats.memberCount : 0;\n    }\n\n    // Calculate member churn (exits per period)\n    // For now, use a simple placeholder - would need historical data\n    const memberChurn = 0; // TODO: Calculate from membership changes\n\n    // Energy stress - use real value from EnergyEngine if available\n    const energyStress = this.energy ? this.energy.calculateEnergyStress() : 0;\n\n    // Economic stress combines floor mass, variance, and dispute rate\n    const economicStress = (floorMass * 0.5) + (disputeRate * 0.3) + (balanceVariance * 0.2);\n\n    // Overall stress is max of economic and energy\n    const overallStress = Math.max(economicStress, energyStress);\n\n    const indicators: StressIndicators = {\n      floorMass,\n      balanceVariance,\n      disputeRate,\n      memberChurn,\n      energyStress,\n      economicStress,\n      overallStress,\n      calculatedAt: timestamp,\n    };\n\n    this.state.indicators = indicators;\n    this.state.lastIndicatorUpdate = timestamp;\n    this.state.updatedAt = timestamp;\n\n    await this.saveState();\n\n    return indicators;\n  }\n\n  private calculateVarianceCoefficient(values: number[]): number {\n    if (values.length === 0) return 0;\n\n    const mean = values.reduce((a, b) => a + b, 0) / values.length;\n    if (mean === 0) return 0;\n\n    const squaredDiffs = values.map(v => Math.pow(v - mean, 2));\n    const variance = squaredDiffs.reduce((a, b) => a + b, 0) / values.length;\n    const stdDev = Math.sqrt(variance);\n\n    return stdDev / Math.abs(mean);\n  }\n\n  // ============================================\n  // STATE TRANSITIONS\n  // ============================================\n\n  async checkStateTransition(): Promise<StateTransitionResult> {\n    const { indicators, thresholds, riskState } = this.state;\n\n    // Check for escalation first\n    if (riskState === RiskState.NORMAL) {\n      // Check NORMAL \u2192 STRESSED\n      if (indicators.floorMass >= thresholds.stressedFloorMass) {\n        return {\n          shouldTransition: true,\n          targetState: RiskState.STRESSED,\n          reason: TransitionReason.INDICATOR_TRIGGERED,\n          explanation: `Floor mass ${(indicators.floorMass * 100).toFixed(1)}% >= threshold ${(thresholds.stressedFloorMass * 100).toFixed(1)}%`,\n          triggeringIndicators: { floorMass: indicators.floorMass },\n        };\n      }\n\n      if (indicators.disputeRate >= thresholds.stressedDisputeRate) {\n        return {\n          shouldTransition: true,\n          targetState: RiskState.STRESSED,\n          reason: TransitionReason.INDICATOR_TRIGGERED,\n          explanation: `Dispute rate ${(indicators.disputeRate * 100).toFixed(1)}% >= threshold ${(thresholds.stressedDisputeRate * 100).toFixed(1)}%`,\n          triggeringIndicators: { disputeRate: indicators.disputeRate },\n        };\n      }\n    }\n\n    if (riskState === RiskState.STRESSED) {\n      // Check STRESSED \u2192 PANIC\n      if (indicators.floorMass >= thresholds.panicFloorMass) {\n        return {\n          shouldTransition: true,\n          targetState: RiskState.PANIC,\n          reason: TransitionReason.INDICATOR_TRIGGERED,\n          explanation: `Floor mass ${(indicators.floorMass * 100).toFixed(1)}% >= panic threshold ${(thresholds.panicFloorMass * 100).toFixed(1)}%`,\n          triggeringIndicators: { floorMass: indicators.floorMass },\n        };\n      }\n\n      if (indicators.energyStress >= thresholds.panicEnergyStress) {\n        return {\n          shouldTransition: true,\n          targetState: RiskState.PANIC,\n          reason: TransitionReason.INDICATOR_TRIGGERED,\n          explanation: `Energy stress ${indicators.energyStress.toFixed(2)} >= threshold ${thresholds.panicEnergyStress.toFixed(2)}`,\n          triggeringIndicators: { energyStress: indicators.energyStress },\n        };\n      }\n\n      // Check STRESSED \u2192 NORMAL (with hysteresis)\n      if (indicators.floorMass <= thresholds.normalFloorMass &&\n          indicators.overallStress <= thresholds.normalOverallStress) {\n        return {\n          shouldTransition: true,\n          targetState: RiskState.NORMAL,\n          reason: TransitionReason.INDICATOR_TRIGGERED,\n          explanation: `Indicators below de-escalation thresholds`,\n          triggeringIndicators: {\n            floorMass: indicators.floorMass,\n            overallStress: indicators.overallStress,\n          },\n        };\n      }\n    }\n\n    if (riskState === RiskState.PANIC) {\n      // Check PANIC \u2192 STRESSED (requires stabilization period)\n      const timeSincePanic = this.state.panicEnteredAt\n        ? now() - this.state.panicEnteredAt\n        : Infinity;\n\n      if (timeSincePanic >= thresholds.panicStabilizationPeriod) {\n        if (indicators.floorMass <= thresholds.normalFloorMass &&\n            indicators.overallStress <= thresholds.normalOverallStress) {\n          return {\n            shouldTransition: true,\n            targetState: RiskState.STRESSED,\n            reason: TransitionReason.STABILIZATION_COMPLETE,\n            explanation: `Stabilization period complete and indicators below thresholds`,\n            triggeringIndicators: {\n              floorMass: indicators.floorMass,\n              overallStress: indicators.overallStress,\n            },\n          };\n        }\n      }\n    }\n\n    return { shouldTransition: false };\n  }\n\n  async triggerStateChange(\n    newState: RiskState,\n    reason: TransitionReason,\n    governanceApprovalId?: string,\n    initiatedBy?: IdentityId\n  ): Promise<void> {\n    const oldState = this.state.riskState;\n\n    // Validate transition\n    if (!this.isValidTransition(oldState, newState, reason)) {\n      throw new EmergencyValidationError({\n        code: EmergencyErrorCode.INVALID_TRANSITION,\n        message: `Invalid transition from ${oldState} to ${newState}`,\n      });\n    }\n\n    // Record history entry\n    const historyEntry: StateHistoryEntry = {\n      fromState: oldState,\n      toState: newState,\n      reason,\n      timestamp: now(),\n      indicators: { ...this.state.indicators },\n      governanceApprovalId,\n      initiatedBy,\n    };\n\n    await this.storage.appendStateHistoryEntry(historyEntry, this.cellId);\n\n    // Update state\n    this.state.riskState = newState;\n    this.state.currentPolicy = { ...DEFAULT_POLICIES[newState] };\n    this.state.lastStateChange = now();\n    this.state.updatedAt = now();\n\n    if (newState === RiskState.PANIC) {\n      this.state.panicEnteredAt = now();\n    } else if (oldState === RiskState.PANIC) {\n      this.state.panicEnteredAt = null;\n    }\n\n    await this.saveState();\n\n    // Log event\n    await this.storage.appendEvent({\n      cellId: this.cellId,\n      type: 'EMERGENCY_STATE_CHANGE',\n      timestamp: now(),\n      data: {\n        fromState: oldState,\n        toState: newState,\n        reason,\n        governanceApprovalId,\n        initiatedBy,\n      },\n    });\n  }\n\n  private isValidTransition(\n    from: RiskState,\n    to: RiskState,\n    reason: TransitionReason\n  ): boolean {\n    // Same state is always invalid\n    if (from === to) return false;\n\n    // Governance can override any transition\n    if (reason === TransitionReason.GOVERNANCE_OVERRIDE ||\n        reason === TransitionReason.FORCED_DEESCALATION) {\n      return true;\n    }\n\n    // Automatic transitions follow strict order\n    const stateOrder = [RiskState.NORMAL, RiskState.STRESSED, RiskState.PANIC];\n    const fromIndex = stateOrder.indexOf(from);\n    const toIndex = stateOrder.indexOf(to);\n\n    // Can escalate by 1 step or de-escalate by 1 step\n    return Math.abs(toIndex - fromIndex) === 1;\n  }\n\n  async forceDeEscalation(\n    reason: string,\n    governanceApprovalId: string,\n    initiatedBy: IdentityId\n  ): Promise<void> {\n    const current = this.state.riskState;\n\n    if (current === RiskState.NORMAL) {\n      throw new EmergencyValidationError({\n        code: EmergencyErrorCode.INVALID_TRANSITION,\n        message: 'Already in NORMAL state, cannot de-escalate further',\n      });\n    }\n\n    // De-escalate one level\n    const targetState = current === RiskState.PANIC\n      ? RiskState.STRESSED\n      : RiskState.NORMAL;\n\n    await this.triggerStateChange(\n      targetState,\n      TransitionReason.FORCED_DEESCALATION,\n      governanceApprovalId,\n      initiatedBy\n    );\n\n    await this.storage.appendEvent({\n      cellId: this.cellId,\n      type: 'FORCED_DEESCALATION',\n      timestamp: now(),\n      data: {\n        reason,\n        governanceApprovalId,\n        initiatedBy,\n        fromState: current,\n        toState: targetState,\n      },\n    });\n  }\n\n  // ============================================\n  // THRESHOLD ANALYSIS\n  // ============================================\n\n  analyzeThresholdProximity(): ThresholdProximityReport {\n    const { indicators, thresholds, riskState, panicEnteredAt } = this.state;\n\n    let distanceToEscalation = Infinity;\n    let distanceToDeescalation = Infinity;\n    let criticalIndicator = 'none';\n    let deescalationBlocked = false;\n    let blockReason: string | undefined;\n\n    if (riskState === RiskState.NORMAL) {\n      // Distance to STRESSED\n      const floorDistance = thresholds.stressedFloorMass - indicators.floorMass;\n      const disputeDistance = thresholds.stressedDisputeRate - indicators.disputeRate;\n      distanceToEscalation = Math.min(floorDistance, disputeDistance);\n      criticalIndicator = floorDistance < disputeDistance ? 'floorMass' : 'disputeRate';\n      distanceToDeescalation = Infinity; // Already at lowest\n    } else if (riskState === RiskState.STRESSED) {\n      // Distance to PANIC\n      const floorDistance = thresholds.panicFloorMass - indicators.floorMass;\n      const energyDistance = thresholds.panicEnergyStress - indicators.energyStress;\n      distanceToEscalation = Math.min(floorDistance, energyDistance);\n      criticalIndicator = floorDistance < energyDistance ? 'floorMass' : 'energyStress';\n\n      // Distance to NORMAL\n      distanceToDeescalation = Math.max(\n        indicators.floorMass - thresholds.normalFloorMass,\n        indicators.overallStress - thresholds.normalOverallStress\n      );\n    } else if (riskState === RiskState.PANIC) {\n      distanceToEscalation = Infinity; // Already at highest\n\n      // Distance to STRESSED (check stabilization)\n      const timeSincePanic = panicEnteredAt ? now() - panicEnteredAt : 0;\n      const timeRemaining = Math.max(0, thresholds.panicStabilizationPeriod - timeSincePanic);\n\n      if (timeRemaining > 0) {\n        deescalationBlocked = true;\n        blockReason = `Stabilization period: ${Math.ceil(timeRemaining / (60 * 60 * 1000))}h remaining`;\n        distanceToDeescalation = Infinity;\n      } else {\n        distanceToDeescalation = Math.max(\n          indicators.floorMass - thresholds.normalFloorMass,\n          indicators.overallStress - thresholds.normalOverallStress\n        );\n      }\n      criticalIndicator = 'floorMass';\n    }\n\n    const timeUntilStabilization = riskState === RiskState.PANIC && panicEnteredAt\n      ? Math.max(0, thresholds.panicStabilizationPeriod - (now() - panicEnteredAt))\n      : null;\n\n    return {\n      currentState: riskState,\n      distanceToEscalation,\n      distanceToDeescalation,\n      criticalIndicator,\n      timeUntilStabilization,\n      deescalationBlocked,\n      blockReason,\n    };\n  }\n\n  // ============================================\n  // HISTORY\n  // ============================================\n\n  async getStateHistory(since: Timestamp): Promise<StateHistoryEntry[]> {\n    const result = await this.storage.getStateHistory(this.cellId, since);\n    if (!result.ok) return [];\n    return result.value;\n  }\n\n  // ============================================\n  // POLICY HELPERS\n  // ============================================\n\n  isFederationFrozen(): boolean {\n    return this.state.currentPolicy.federationBetaFactor === 0;\n  }\n\n  getEffectiveLimitFactor(isNewMember: boolean): number {\n    return isNewMember\n      ? this.state.currentPolicy.newMemberLimitFactor\n      : this.state.currentPolicy.limitFactor;\n  }\n\n  // ============================================\n  // PERSISTENCE\n  // ============================================\n\n  private async saveState(): Promise<void> {\n    const result = await this.storage.saveEmergencyState(this.state);\n    if (!result.ok) {\n      throw new EmergencyValidationError({\n        code: EmergencyErrorCode.STORAGE_ERROR,\n        message: result.error.message,\n      });\n    }\n  }\n\n  async loadState(): Promise<void> {\n    const result = await this.storage.getEmergencyState(this.cellId);\n    if (result.ok && result.value) {\n      this.state = result.value;\n    }\n  }\n\n  // ============================================\n  // HELPERS\n  // ============================================\n\n  private createEmptyIndicators(timestamp: Timestamp): StressIndicators {\n    return {\n      floorMass: 0,\n      balanceVariance: 0,\n      disputeRate: 0,\n      memberChurn: 0,\n      energyStress: 0,\n      economicStress: 0,\n      overallStress: 0,\n      calculatedAt: timestamp,\n    };\n  }\n}\n\n// ============================================\n// CUSTOM ERROR CLASS\n// ============================================\n\nexport class EmergencyValidationError extends Error {\n  public readonly code: EmergencyErrorCode;\n  public readonly details?: Record<string, unknown>;\n\n  constructor(error: EmergencyError) {\n    super(error.message);\n    this.name = 'EmergencyValidationError';\n    this.code = error.code;\n    this.details = error.details;\n  }\n\n  toJSON(): EmergencyError {\n    return {\n      code: this.code,\n      message: this.message,\n      details: this.details,\n    };\n  }\n}\n\n// ============================================\n// FACTORY\n// ============================================\n\n/**\n * Create a new emergency engine\n */\nexport function createEmergencyEngine(\n  cellId: CellId,\n  ledger: LedgerEngine,\n  storage: IStorage,\n  thresholds: Partial<TransitionThresholds> = {}\n): EmergencyEngine {\n  return new EmergencyEngine(cellId, ledger, storage, thresholds);\n}\n", "/**\n * Cell Protocol - Federation Engine\n *\n * Implementation of the Federation Layer (PRD-06).\n * Manages inter-cell transactions, exposure caps, and quarantine.\n */\n\nimport {\n  CellId,\n  IdentityId,\n  Timestamp,\n  Units,\n  BalanceChangeReason,\n  MembershipStatus,\n  now,\n  generateId,\n} from '../types/common';\nimport {\n  FederationTxId,\n  LinkProposalId,\n  FederationStatus,\n  LinkStatus,\n  FederationTxStatus,\n  QuarantineReason,\n  FederationLink,\n  LinkProposal,\n  FederationTerms,\n  FederationState,\n  FederationTransaction,\n  CreateFederationTxInput,\n  FederationTxResult,\n  QuarantineStatus,\n  FederationParameters,\n  ExposureAnalysis,\n  FederationError,\n  FederationErrorCode,\n  IFederationEngine,\n  DEFAULT_FEDERATION_TERMS,\n  DEFAULT_FEDERATION_PARAMETERS,\n  generateFederationTxId,\n  generateLinkProposalId,\n} from '../types/federation';\nimport { LedgerEngine } from './ledger-engine';\nimport { EmergencyEngine } from './emergency-engine';\nimport { IStorage } from '../storage/pouchdb-adapter';\n\n// ============================================\n// FEDERATION ENGINE IMPLEMENTATION\n// ============================================\n\nexport class FederationEngine implements IFederationEngine {\n  private cellId: CellId;\n  private ledger: LedgerEngine;\n  private storage: IStorage;\n  private emergency?: EmergencyEngine;\n  private parameters: FederationParameters;\n\n  private state: FederationState;\n  private clearingAccountId: IdentityId;\n\n  constructor(\n    cellId: CellId,\n    ledger: LedgerEngine,\n    storage: IStorage,\n    parameters: Partial<FederationParameters> = {}\n  ) {\n    this.cellId = cellId;\n    this.ledger = ledger;\n    this.storage = storage;\n    this.parameters = { ...DEFAULT_FEDERATION_PARAMETERS, ...parameters };\n\n    // Generate clearing account ID\n    this.clearingAccountId = `clearing-${cellId}`;\n\n    // Initialize state\n    const timestamp = now();\n    this.state = {\n      cellId,\n      federationPosition: 0,\n      clearingAccountId: this.clearingAccountId,\n      exposureCap: 0, // Will be calculated on initialize\n      betaFactor: this.parameters.baseBetaFactor,\n      connectedCells: [],\n      status: FederationStatus.ACTIVE,\n      createdAt: timestamp,\n      updatedAt: timestamp,\n    };\n  }\n\n  /** Initialize the federation engine (creates clearing account) */\n  async initialize(): Promise<void> {\n    // Create clearing account if it doesn't exist\n    const existingMember = this.ledger.getMemberState(this.clearingAccountId);\n    if (!existingMember) {\n      await this.ledger.addMember(this.clearingAccountId, 0);\n      // Set status to active\n      await this.ledger.updateMemberStatus(this.clearingAccountId, MembershipStatus.ACTIVE);\n    }\n\n    // Calculate initial exposure cap\n    await this.recalculateExposureCap();\n\n    // Load state from storage if exists\n    const result = await this.storage.getFederationState(this.cellId);\n    if (result.ok && result.value) {\n      this.state = result.value;\n    } else {\n      await this.saveState();\n    }\n  }\n\n  /** Set the emergency engine (circular dependency resolution) */\n  setEmergencyEngine(emergency: EmergencyEngine): void {\n    this.emergency = emergency;\n  }\n\n  // ============================================\n  // CORE INTERFACE METHODS\n  // ============================================\n\n  getCellId(): CellId {\n    return this.cellId;\n  }\n\n  getFederationState(): FederationState {\n    return {\n      ...this.state,\n      connectedCells: [...this.state.connectedCells.map(c => ({ ...c }))],\n    };\n  }\n\n  getPosition(): Units {\n    return this.state.federationPosition;\n  }\n\n  getExposureCap(): Units {\n    return this.state.exposureCap;\n  }\n\n  getAvailableCapacity(): Units {\n    return Math.max(0, this.state.exposureCap - Math.abs(this.state.federationPosition));\n  }\n\n  getConnectedCells(): FederationLink[] {\n    return [...this.state.connectedCells.map(c => ({ ...c }))];\n  }\n\n  getLink(remoteCellId: CellId): FederationLink | undefined {\n    const link = this.state.connectedCells.find(c => c.remoteCellId === remoteCellId);\n    return link ? { ...link } : undefined;\n  }\n\n  getClearingAccountId(): IdentityId {\n    return this.clearingAccountId;\n  }\n\n  // ============================================\n  // LINK MANAGEMENT\n  // ============================================\n\n  async proposeLink(\n    remoteCellId: CellId,\n    terms: Partial<FederationTerms> = {}\n  ): Promise<LinkProposal> {\n    // Check if link already exists\n    const existingLink = this.getLink(remoteCellId);\n    if (existingLink && existingLink.status !== LinkStatus.PENDING) {\n      throw new FederationValidationError({\n        code: FederationErrorCode.LINK_SUSPENDED,\n        message: `Link to ${remoteCellId} already exists`,\n      });\n    }\n\n    const proposal: LinkProposal = {\n      id: generateLinkProposalId(),\n      initiatorCellId: this.cellId,\n      targetCellId: remoteCellId,\n      proposedTerms: { ...DEFAULT_FEDERATION_TERMS, ...terms },\n      createdAt: now(),\n      expiresAt: now() + (7 * 24 * 60 * 60 * 1000), // 7 days\n      status: 'PENDING',\n    };\n\n    const result = await this.storage.saveLinkProposal(proposal);\n    if (!result.ok) {\n      throw new FederationValidationError({\n        code: FederationErrorCode.STORAGE_ERROR,\n        message: result.error.message,\n      });\n    }\n\n    // Add pending link\n    this.state.connectedCells.push({\n      remoteCellId,\n      status: LinkStatus.PENDING,\n      bilateralPosition: 0,\n      establishedAt: now(),\n      lastActivity: now(),\n    });\n\n    await this.saveState();\n\n    await this.storage.appendEvent({\n      cellId: this.cellId,\n      type: 'LINK_PROPOSED',\n      timestamp: now(),\n      data: { proposalId: proposal.id, remoteCellId },\n    });\n\n    return proposal;\n  }\n\n  async acceptLink(proposalId: LinkProposalId): Promise<FederationLink> {\n    const proposalResult = await this.storage.getLinkProposal(proposalId);\n    if (!proposalResult.ok || !proposalResult.value) {\n      throw new FederationValidationError({\n        code: FederationErrorCode.PROPOSAL_NOT_FOUND,\n        message: `Proposal ${proposalId} not found`,\n      });\n    }\n\n    const proposal = proposalResult.value;\n\n    if (proposal.status !== 'PENDING') {\n      throw new FederationValidationError({\n        code: FederationErrorCode.INVALID_TX_STATE,\n        message: `Proposal is not pending: ${proposal.status}`,\n      });\n    }\n\n    if (now() > proposal.expiresAt) {\n      throw new FederationValidationError({\n        code: FederationErrorCode.PROPOSAL_EXPIRED,\n        message: 'Proposal has expired',\n      });\n    }\n\n    // Update proposal\n    proposal.status = 'ACCEPTED';\n    proposal.respondedAt = now();\n    await this.storage.saveLinkProposal(proposal);\n\n    // Determine the remote cell ID based on which side we are\n    // If we are the initiator (simulating round-trip), the remote is the target\n    // If we are the target (normal case), the remote is the initiator\n    const remoteCellId = this.cellId === proposal.initiatorCellId\n      ? proposal.targetCellId\n      : proposal.initiatorCellId;\n\n    // Update or create link\n    const existingLinkIndex = this.state.connectedCells.findIndex(\n      c => c.remoteCellId === remoteCellId\n    );\n\n    const link: FederationLink = {\n      remoteCellId,\n      status: LinkStatus.ACTIVE,\n      bilateralPosition: 0,\n      establishedAt: now(),\n      lastActivity: now(),\n    };\n\n    if (existingLinkIndex >= 0) {\n      this.state.connectedCells[existingLinkIndex] = link;\n    } else {\n      this.state.connectedCells.push(link);\n    }\n\n    await this.saveState();\n\n    await this.storage.appendEvent({\n      cellId: this.cellId,\n      type: 'LINK_ACCEPTED',\n      timestamp: now(),\n      data: { proposalId, remoteCellId: proposal.initiatorCellId },\n    });\n\n    return link;\n  }\n\n  async rejectLink(proposalId: LinkProposalId, reason: string): Promise<void> {\n    const proposalResult = await this.storage.getLinkProposal(proposalId);\n    if (!proposalResult.ok || !proposalResult.value) {\n      throw new FederationValidationError({\n        code: FederationErrorCode.PROPOSAL_NOT_FOUND,\n        message: `Proposal ${proposalId} not found`,\n      });\n    }\n\n    const proposal = proposalResult.value;\n    proposal.status = 'REJECTED';\n    proposal.respondedAt = now();\n    proposal.rejectionReason = reason;\n\n    await this.storage.saveLinkProposal(proposal);\n\n    // Remove pending link if exists\n    this.state.connectedCells = this.state.connectedCells.filter(\n      c => c.remoteCellId !== proposal.initiatorCellId || c.status !== LinkStatus.PENDING\n    );\n\n    await this.saveState();\n  }\n\n  async suspendLink(remoteCellId: CellId, reason: string): Promise<void> {\n    const linkIndex = this.state.connectedCells.findIndex(\n      c => c.remoteCellId === remoteCellId\n    );\n\n    if (linkIndex < 0) {\n      throw new FederationValidationError({\n        code: FederationErrorCode.LINK_NOT_FOUND,\n        message: `Link to ${remoteCellId} not found`,\n      });\n    }\n\n    this.state.connectedCells[linkIndex].status = LinkStatus.SUSPENDED;\n    this.state.connectedCells[linkIndex].suspensionReason = reason;\n    this.state.connectedCells[linkIndex].suspendedAt = now();\n\n    await this.saveState();\n\n    await this.storage.appendEvent({\n      cellId: this.cellId,\n      type: 'LINK_SUSPENDED',\n      timestamp: now(),\n      data: { remoteCellId, reason },\n    });\n  }\n\n  async resumeLink(remoteCellId: CellId): Promise<void> {\n    const linkIndex = this.state.connectedCells.findIndex(\n      c => c.remoteCellId === remoteCellId\n    );\n\n    if (linkIndex < 0) {\n      throw new FederationValidationError({\n        code: FederationErrorCode.LINK_NOT_FOUND,\n        message: `Link to ${remoteCellId} not found`,\n      });\n    }\n\n    this.state.connectedCells[linkIndex].status = LinkStatus.ACTIVE;\n    this.state.connectedCells[linkIndex].suspensionReason = undefined;\n    this.state.connectedCells[linkIndex].suspendedAt = undefined;\n\n    await this.saveState();\n\n    await this.storage.appendEvent({\n      cellId: this.cellId,\n      type: 'LINK_RESUMED',\n      timestamp: now(),\n      data: { remoteCellId },\n    });\n  }\n\n  // ============================================\n  // TRANSACTION VALIDATION\n  // ============================================\n\n  async validateInterCellTx(input: CreateFederationTxInput): Promise<void> {\n    // Check if federation is frozen (PANIC mode)\n    if (this.emergency?.isFederationFrozen()) {\n      throw new FederationValidationError({\n        code: FederationErrorCode.FEDERATION_FROZEN,\n        message: 'Federation is frozen due to PANIC mode',\n      });\n    }\n\n    // Check if cell is quarantined\n    if (this.state.status === FederationStatus.QUARANTINED) {\n      throw new FederationValidationError({\n        code: FederationErrorCode.CELL_QUARANTINED,\n        message: `Cell is quarantined: ${this.state.quarantineReason}`,\n      });\n    }\n\n    // Validate amount\n    if (input.amount <= 0) {\n      throw new FederationValidationError({\n        code: FederationErrorCode.INVALID_AMOUNT,\n        message: 'Amount must be positive',\n      });\n    }\n\n    // Determine if we're source or target\n    const isSource = input.sourceCell === this.cellId;\n\n    if (isSource) {\n      // Check link exists and is active\n      const link = this.getLink(input.targetCell);\n      if (!link) {\n        throw new FederationValidationError({\n          code: FederationErrorCode.LINK_NOT_FOUND,\n          message: `No link to cell ${input.targetCell}`,\n        });\n      }\n\n      if (link.status === LinkStatus.SUSPENDED) {\n        throw new FederationValidationError({\n          code: FederationErrorCode.LINK_SUSPENDED,\n          message: `Link to ${input.targetCell} is suspended`,\n        });\n      }\n\n      // Check payer can spend\n      if (!this.ledger.canSpend(input.payer, input.amount)) {\n        throw new FederationValidationError({\n          code: FederationErrorCode.LEDGER_ERROR,\n          message: 'Payer cannot spend the requested amount',\n        });\n      }\n\n      // Check cap feasibility (outgoing increases our position)\n      // For outgoing: we give credit, position increases\n      const newPosition = this.state.federationPosition + input.amount;\n      if (Math.abs(newPosition) > this.state.exposureCap) {\n        throw new FederationValidationError({\n          code: FederationErrorCode.CAP_EXCEEDED,\n          message: `Transaction would exceed exposure cap: |${newPosition}| > ${this.state.exposureCap}`,\n          details: { newPosition, cap: this.state.exposureCap },\n        });\n      }\n    }\n  }\n\n  // ============================================\n  // TRANSACTION EXECUTION\n  // ============================================\n\n  async executeInterCellTx(input: CreateFederationTxInput): Promise<FederationTxResult> {\n    // Validate first\n    await this.validateInterCellTx(input);\n\n    const isSource = input.sourceCell === this.cellId;\n\n    // Create transaction record\n    const transaction: FederationTransaction = {\n      id: generateFederationTxId(),\n      sourceCell: input.sourceCell,\n      targetCell: input.targetCell,\n      payer: input.payer,\n      payee: input.payee,\n      amount: input.amount,\n      status: FederationTxStatus.PENDING,\n      memo: input.memo,\n      createdAt: now(),\n    };\n\n    await this.storage.saveFederationTransaction(transaction);\n\n    if (isSource) {\n      // Execute source leg: payer pays clearing account\n      try {\n        await this.ledger.applyBalanceUpdates([\n          {\n            memberId: input.payer,\n            delta: -input.amount,\n            reason: BalanceChangeReason.SPOT_TRANSACTION_PAYER,\n            referenceId: transaction.id,\n          },\n          {\n            memberId: this.clearingAccountId,\n            delta: input.amount,\n            reason: BalanceChangeReason.SPOT_TRANSACTION_PAYEE,\n            referenceId: transaction.id,\n          },\n        ]);\n\n        transaction.status = FederationTxStatus.SOURCE_CONFIRMED;\n        transaction.sourceConfirmedAt = now();\n        transaction.sourceLegTxId = transaction.id;\n      } catch (error) {\n        transaction.status = FederationTxStatus.FAILED;\n        transaction.failureReason = error instanceof Error ? error.message : 'Unknown error';\n        await this.storage.saveFederationTransaction(transaction);\n        throw new FederationValidationError({\n          code: FederationErrorCode.LEDGER_ERROR,\n          message: `Source leg failed: ${transaction.failureReason}`,\n        });\n      }\n\n      // Update federation position (outgoing increases)\n      this.state.federationPosition += input.amount;\n\n      // Update bilateral position\n      const linkIndex = this.state.connectedCells.findIndex(\n        c => c.remoteCellId === input.targetCell\n      );\n      if (linkIndex >= 0) {\n        this.state.connectedCells[linkIndex].bilateralPosition += input.amount;\n        this.state.connectedCells[linkIndex].lastActivity = now();\n      }\n\n      // For this implementation, we'll mock the target confirmation\n      // In a real system, this would involve network communication\n      transaction.status = FederationTxStatus.COMPLETED;\n      transaction.targetConfirmedAt = now();\n      transaction.completedAt = now();\n    }\n\n    await this.storage.saveFederationTransaction(transaction);\n    await this.saveState();\n\n    await this.storage.appendEvent({\n      cellId: this.cellId,\n      type: 'FEDERATION_TX_COMPLETED',\n      timestamp: now(),\n      data: {\n        transactionId: transaction.id,\n        amount: input.amount,\n        direction: isSource ? 'OUTGOING' : 'INCOMING',\n        newPosition: this.state.federationPosition,\n      },\n    });\n\n    // Check if we're near cap\n    const analysis = this.analyzeExposure();\n\n    return {\n      transaction,\n      newPosition: this.state.federationPosition,\n      remainingCapacity: this.getAvailableCapacity(),\n      nearCap: analysis.atWarning || analysis.atCritical,\n    };\n  }\n\n  async getTransaction(id: FederationTxId): Promise<FederationTransaction | undefined> {\n    const result = await this.storage.getFederationTransaction(id);\n    if (!result.ok || !result.value) return undefined;\n    return result.value;\n  }\n\n  async getTransactions(filter?: {\n    remoteCellId?: CellId;\n    status?: FederationTxStatus;\n    since?: Timestamp;\n  }): Promise<FederationTransaction[]> {\n    const result = await this.storage.getFederationTransactions({\n      cellId: this.cellId,\n      ...filter,\n    });\n    if (!result.ok) return [];\n    return result.value;\n  }\n\n  async rollbackTransaction(id: FederationTxId, reason: string): Promise<void> {\n    const transaction = await this.getTransaction(id);\n    if (!transaction) {\n      throw new FederationValidationError({\n        code: FederationErrorCode.TRANSACTION_NOT_FOUND,\n        message: `Transaction ${id} not found`,\n      });\n    }\n\n    if (transaction.status === FederationTxStatus.COMPLETED) {\n      throw new FederationValidationError({\n        code: FederationErrorCode.INVALID_TX_STATE,\n        message: 'Cannot rollback completed transaction',\n      });\n    }\n\n    if (transaction.status === FederationTxStatus.ROLLED_BACK) {\n      return; // Already rolled back\n    }\n\n    // Reverse the source leg if it was executed\n    if (transaction.sourceConfirmedAt && transaction.sourceCell === this.cellId) {\n      await this.ledger.applyBalanceUpdates([\n        {\n          memberId: transaction.payer,\n          delta: transaction.amount,\n          reason: BalanceChangeReason.SPOT_TRANSACTION_PAYEE,\n          referenceId: `rollback-${transaction.id}`,\n        },\n        {\n          memberId: this.clearingAccountId,\n          delta: -transaction.amount,\n          reason: BalanceChangeReason.SPOT_TRANSACTION_PAYER,\n          referenceId: `rollback-${transaction.id}`,\n        },\n      ]);\n\n      // Reverse position change\n      this.state.federationPosition -= transaction.amount;\n\n      // Reverse bilateral position\n      const linkIndex = this.state.connectedCells.findIndex(\n        c => c.remoteCellId === transaction.targetCell\n      );\n      if (linkIndex >= 0) {\n        this.state.connectedCells[linkIndex].bilateralPosition -= transaction.amount;\n      }\n    }\n\n    transaction.status = FederationTxStatus.ROLLED_BACK;\n    transaction.failureReason = reason;\n    transaction.completedAt = now();\n\n    await this.storage.saveFederationTransaction(transaction);\n    await this.saveState();\n\n    await this.storage.appendEvent({\n      cellId: this.cellId,\n      type: 'FEDERATION_TX_ROLLED_BACK',\n      timestamp: now(),\n      data: { transactionId: id, reason },\n    });\n  }\n\n  // ============================================\n  // QUARANTINE\n  // ============================================\n\n  checkQuarantineStatus(): QuarantineStatus {\n    const positionExceedsCap = Math.abs(this.state.federationPosition) > this.state.exposureCap;\n    const inPanic = this.emergency?.isFederationFrozen() ?? false;\n\n    if (this.state.status === FederationStatus.QUARANTINED) {\n      return {\n        isQuarantined: true,\n        reason: this.state.quarantineReason,\n        since: this.state.quarantinedAt,\n        violatingPosition: positionExceedsCap ? this.state.federationPosition : undefined,\n        exceededCap: positionExceedsCap ? this.state.exposureCap : undefined,\n        resolutionSteps: this.getResolutionSteps(),\n      };\n    }\n\n    // Check if should be quarantined\n    if (positionExceedsCap) {\n      return {\n        isQuarantined: false,\n        reason: QuarantineReason.CAP_VIOLATION,\n        violatingPosition: this.state.federationPosition,\n        exceededCap: this.state.exposureCap,\n        resolutionSteps: ['Reduce federation position below cap', 'Wait for cap to increase'],\n      };\n    }\n\n    if (inPanic) {\n      return {\n        isQuarantined: false,\n        reason: QuarantineReason.PANIC_MODE,\n        resolutionSteps: ['Wait for de-escalation from PANIC state'],\n      };\n    }\n\n    return { isQuarantined: false };\n  }\n\n  private getResolutionSteps(): string[] {\n    switch (this.state.quarantineReason) {\n      case QuarantineReason.CAP_VIOLATION:\n        return [\n          'Reduce federation position by settling with connected cells',\n          'Increase aggregate capacity (more members or higher limits)',\n        ];\n      case QuarantineReason.PANIC_MODE:\n        return ['Wait for emergency state to de-escalate from PANIC'];\n      case QuarantineReason.MANUAL_SUSPENSION:\n        return ['Request governance review', 'Address suspension reason'];\n      default:\n        return [];\n    }\n  }\n\n  async enterQuarantine(reason: QuarantineReason): Promise<void> {\n    this.state.status = FederationStatus.QUARANTINED;\n    this.state.quarantineReason = reason;\n    this.state.quarantinedAt = now();\n\n    await this.saveState();\n\n    await this.storage.appendEvent({\n      cellId: this.cellId,\n      type: 'FEDERATION_QUARANTINED',\n      timestamp: now(),\n      data: { reason },\n    });\n  }\n\n  async exitQuarantine(): Promise<void> {\n    // Check if conditions are met\n    const status = this.checkQuarantineStatus();\n\n    if (status.reason === QuarantineReason.CAP_VIOLATION) {\n      if (Math.abs(this.state.federationPosition) > this.state.exposureCap) {\n        throw new FederationValidationError({\n          code: FederationErrorCode.CAP_EXCEEDED,\n          message: 'Cannot exit quarantine: position still exceeds cap',\n        });\n      }\n    }\n\n    if (status.reason === QuarantineReason.PANIC_MODE) {\n      if (this.emergency?.isFederationFrozen()) {\n        throw new FederationValidationError({\n          code: FederationErrorCode.FEDERATION_FROZEN,\n          message: 'Cannot exit quarantine: still in PANIC mode',\n        });\n      }\n    }\n\n    this.state.status = FederationStatus.ACTIVE;\n    this.state.quarantineReason = undefined;\n    this.state.quarantinedAt = undefined;\n\n    await this.saveState();\n\n    await this.storage.appendEvent({\n      cellId: this.cellId,\n      type: 'FEDERATION_QUARANTINE_EXIT',\n      timestamp: now(),\n      data: {},\n    });\n  }\n\n  // ============================================\n  // EXPOSURE MANAGEMENT\n  // ============================================\n\n  async setExposureCapFactor(betaFactor: number): Promise<void> {\n    if (betaFactor < 0 || betaFactor > 1) {\n      throw new FederationValidationError({\n        code: FederationErrorCode.INVALID_AMOUNT,\n        message: 'Beta factor must be between 0 and 1',\n      });\n    }\n\n    this.state.betaFactor = betaFactor;\n    await this.recalculateExposureCap();\n\n    // Check if we need to enter quarantine\n    if (Math.abs(this.state.federationPosition) > this.state.exposureCap) {\n      if (this.state.status !== FederationStatus.QUARANTINED) {\n        await this.enterQuarantine(QuarantineReason.CAP_VIOLATION);\n      }\n    }\n\n    // If beta is 0, enter quarantine for PANIC mode\n    if (betaFactor === 0 && this.state.status !== FederationStatus.QUARANTINED) {\n      await this.enterQuarantine(QuarantineReason.PANIC_MODE);\n    }\n\n    await this.storage.appendEvent({\n      cellId: this.cellId,\n      type: 'EXPOSURE_CAP_UPDATED',\n      timestamp: now(),\n      data: { betaFactor, newCap: this.state.exposureCap },\n    });\n  }\n\n  /**\n   * Recalculate exposure cap based on current ledger aggregate capacity.\n   * Call this after adding/removing members to update the cap.\n   */\n  async recalculateExposureCap(): Promise<void> {\n    const stats = this.ledger.getStatistics();\n    const aggregateCapacity = stats.aggregateCapacity;\n\n    let cap = Math.floor(aggregateCapacity * this.state.betaFactor);\n\n    // Apply min/max bounds\n    cap = Math.max(this.parameters.minExposureCap, cap);\n    cap = Math.min(this.parameters.maxExposureCap, cap);\n\n    this.state.exposureCap = cap;\n    this.state.updatedAt = now();\n\n    await this.saveState();\n  }\n\n  analyzeExposure(): ExposureAnalysis {\n    const position = Math.abs(this.state.federationPosition);\n    const cap = this.state.exposureCap;\n    const availableCapacity = Math.max(0, cap - position);\n    const utilization = cap > 0 ? position / cap : 0;\n\n    return {\n      position: this.state.federationPosition,\n      cap,\n      availableCapacity,\n      utilization,\n      atWarning: utilization >= this.parameters.warningThreshold,\n      atCritical: utilization >= this.parameters.criticalThreshold,\n      capExceeded: position > cap,\n    };\n  }\n\n  // ============================================\n  // PERSISTENCE\n  // ============================================\n\n  private async saveState(): Promise<void> {\n    const result = await this.storage.saveFederationState(this.state);\n    if (!result.ok) {\n      throw new FederationValidationError({\n        code: FederationErrorCode.STORAGE_ERROR,\n        message: result.error.message,\n      });\n    }\n  }\n\n  async loadState(): Promise<void> {\n    const result = await this.storage.getFederationState(this.cellId);\n    if (result.ok && result.value) {\n      this.state = result.value;\n    }\n  }\n}\n\n// ============================================\n// CUSTOM ERROR CLASS\n// ============================================\n\nexport class FederationValidationError extends Error {\n  public readonly code: FederationErrorCode;\n  public readonly details?: Record<string, unknown>;\n\n  constructor(error: FederationError) {\n    super(error.message);\n    this.name = 'FederationValidationError';\n    this.code = error.code;\n    this.details = error.details;\n  }\n\n  toJSON(): FederationError {\n    return {\n      code: this.code,\n      message: this.message,\n      details: this.details,\n    };\n  }\n}\n\n// ============================================\n// FACTORY\n// ============================================\n\n/**\n * Create a new federation engine\n */\nexport async function createFederationEngine(\n  cellId: CellId,\n  ledger: LedgerEngine,\n  storage: IStorage,\n  parameters: Partial<FederationParameters> = {}\n): Promise<FederationEngine> {\n  const engine = new FederationEngine(cellId, ledger, storage, parameters);\n  await engine.initialize();\n  return engine;\n}\n", "/**\n * Cell Protocol - Energy Engine\n *\n * Implementation of the Energy Resource Layer (PRD-09).\n * Manages energy stocks, stress calculation, and rationing.\n */\n\nimport {\n  CellId,\n  IdentityId,\n  Timestamp,\n  now,\n  generateId,\n} from '../types/common';\nimport { TaskCategory } from '../types/commitment';\nimport {\n  EnergyCarrierId,\n  EnergyCategory,\n  EnergyCarrier,\n  EnergyStock,\n  EnergyFlow,\n  EnergySource,\n  EnergyConsumer,\n  EnergyMode,\n  TaskEnergyProfile,\n  RationingPlan,\n  MemberBundle,\n  StockChangeRecord,\n  StockChangeReason,\n  ConsumptionRecord,\n  WeeklyEnergyPlan,\n  StressProjection,\n  ProcurementAlert,\n  EnergyState,\n  EnergyError,\n  EnergyErrorCode,\n  IEnergyEngine,\n  DEFAULT_CARRIERS,\n  DEFAULT_TASK_PROFILES,\n  HUMANITARIAN_FLOOR,\n  VULNERABILITY_BONUS,\n} from '../types/energy';\nimport { LedgerEngine } from './ledger-engine';\nimport { SchedulerEngine } from './scheduler-engine';\nimport { IStorage } from '../storage/pouchdb-adapter';\n\n// ============================================\n// ENERGY ENGINE IMPLEMENTATION\n// ============================================\n\nexport class EnergyEngine implements IEnergyEngine {\n  private cellId: CellId;\n  private ledger: LedgerEngine;\n  private scheduler?: SchedulerEngine;\n  private storage: IStorage;\n\n  private carriers: EnergyCarrier[];\n  private stocks: Map<EnergyCarrierId, EnergyStock>;\n  private taskProfiles: TaskEnergyProfile[];\n  private selectedModes: Map<TaskCategory, string>;\n  private stressIndex: number = 0;\n\n  // Caches for flow history\n  private flowHistory: Map<EnergyCarrierId, EnergyFlow[]> = new Map();\n\n  constructor(\n    cellId: CellId,\n    ledger: LedgerEngine,\n    storage: IStorage,\n    carriers?: EnergyCarrier[],\n    taskProfiles?: TaskEnergyProfile[]\n  ) {\n    this.cellId = cellId;\n    this.ledger = ledger;\n    this.storage = storage;\n\n    // Initialize with defaults or provided carriers\n    this.carriers = carriers ?? [...DEFAULT_CARRIERS];\n    this.taskProfiles = taskProfiles ?? this.cloneTaskProfiles(DEFAULT_TASK_PROFILES);\n\n    // Initialize stocks to zero for all carriers\n    this.stocks = new Map();\n    for (const carrier of this.carriers) {\n      this.stocks.set(carrier.id, {\n        carrierId: carrier.id,\n        currentAmount: 0,\n        unit: carrier.unit,\n        lastRestocked: now(),\n      });\n    }\n\n    // Initialize mode selections to first mode for each profile\n    this.selectedModes = new Map();\n    for (const profile of this.taskProfiles) {\n      if (profile.energyModes.length > 0) {\n        this.selectedModes.set(profile.taskCategory, profile.energyModes[0].id);\n      }\n    }\n  }\n\n  /** Set the scheduler engine (for task hour calculations) */\n  setSchedulerEngine(scheduler: SchedulerEngine): void {\n    this.scheduler = scheduler;\n  }\n\n  // ============================================\n  // STOCK MANAGEMENT\n  // ============================================\n\n  getStocks(): Map<EnergyCarrierId, EnergyStock> {\n    return new Map(this.stocks);\n  }\n\n  getStock(carrierId: EnergyCarrierId): EnergyStock | null {\n    const stock = this.stocks.get(carrierId);\n    return stock ? { ...stock } : null;\n  }\n\n  async recordStockChange(\n    change: Omit<StockChangeRecord, 'id' | 'cellId' | 'timestamp'>\n  ): Promise<void> {\n    const carrier = this.carriers.find(c => c.id === change.carrierId);\n    if (!carrier) {\n      throw new EnergyValidationError({\n        code: EnergyErrorCode.CARRIER_NOT_FOUND,\n        message: `Carrier ${change.carrierId} not found`,\n      });\n    }\n\n    const stock = this.stocks.get(change.carrierId);\n    if (!stock) {\n      throw new EnergyValidationError({\n        code: EnergyErrorCode.STOCK_NOT_FOUND,\n        message: `Stock for carrier ${change.carrierId} not found`,\n      });\n    }\n\n    // Validate we have enough for negative changes\n    if (change.delta < 0 && stock.currentAmount + change.delta < 0) {\n      throw new EnergyValidationError({\n        code: EnergyErrorCode.INSUFFICIENT_STOCK,\n        message: `Insufficient stock for carrier ${change.carrierId}: have ${stock.currentAmount}, need ${Math.abs(change.delta)}`,\n      });\n    }\n\n    // Apply change\n    stock.currentAmount += change.delta;\n    if (change.delta > 0) {\n      stock.lastRestocked = now();\n    }\n\n    // Update projected depletion\n    stock.projectedDepletionDate = this.projectDepletion(change.carrierId) ?? undefined;\n\n    // Save record\n    const record: StockChangeRecord = {\n      id: generateId(),\n      cellId: this.cellId,\n      timestamp: now(),\n      ...change,\n    };\n    await this.storage.saveStockChange(record);\n\n    // Update flow history\n    this.updateFlowHistory(change.carrierId, change.delta, change.source);\n\n    // Recalculate stress\n    this.stressIndex = this.calculateEnergyStress();\n\n    await this.saveState();\n\n    await this.storage.appendEvent({\n      cellId: this.cellId,\n      type: 'ENERGY_STOCK_CHANGE',\n      timestamp: now(),\n      data: {\n        carrierId: change.carrierId,\n        delta: change.delta,\n        reason: change.reason,\n        newAmount: stock.currentAmount,\n      },\n    });\n  }\n\n  async recordConsumption(\n    record: Omit<ConsumptionRecord, 'id' | 'cellId' | 'timestamp'>\n  ): Promise<void> {\n    // Validate carrier exists\n    if (!this.carriers.find(c => c.id === record.carrierId)) {\n      throw new EnergyValidationError({\n        code: EnergyErrorCode.CARRIER_NOT_FOUND,\n        message: `Carrier ${record.carrierId} not found`,\n      });\n    }\n\n    // Record as negative stock change\n    await this.recordStockChange({\n      carrierId: record.carrierId,\n      delta: -record.amount,\n      reason: StockChangeReason.TASK_CONSUMPTION,\n      source: `task:${record.taskCategory}`,\n    });\n\n    // Save consumption record\n    const fullRecord: ConsumptionRecord = {\n      id: generateId(),\n      cellId: this.cellId,\n      timestamp: now(),\n      ...record,\n    };\n    await this.storage.saveConsumptionRecord(fullRecord);\n  }\n\n  private updateFlowHistory(\n    carrierId: EnergyCarrierId,\n    delta: number,\n    source?: string\n  ): void {\n    if (!this.flowHistory.has(carrierId)) {\n      this.flowHistory.set(carrierId, []);\n    }\n\n    const flows = this.flowHistory.get(carrierId)!;\n    const currentTime = now();\n    const weekStart = this.getWeekStart(currentTime);\n    const weekEnd = weekStart + 7 * 24 * 60 * 60 * 1000;\n\n    // Find or create flow for current week\n    let currentFlow = flows.find(\n      f => f.period.start === weekStart && f.period.end === weekEnd\n    );\n\n    if (!currentFlow) {\n      currentFlow = {\n        carrierId,\n        period: { start: weekStart, end: weekEnd },\n        inflow: 0,\n        outflow: 0,\n        sources: [],\n        consumers: [],\n      };\n      flows.push(currentFlow);\n    }\n\n    if (delta > 0) {\n      currentFlow.inflow += delta;\n      currentFlow.sources.push({\n        name: source ?? 'unknown',\n        amount: delta,\n        timestamp: currentTime,\n      });\n    } else {\n      currentFlow.outflow += Math.abs(delta);\n      currentFlow.consumers.push({\n        name: source ?? 'unknown',\n        amount: Math.abs(delta),\n        timestamp: currentTime,\n      });\n    }\n  }\n\n  // ============================================\n  // CARRIERS & PROFILES\n  // ============================================\n\n  getCarriers(): EnergyCarrier[] {\n    return [...this.carriers];\n  }\n\n  getEnergyProfile(category: TaskCategory): TaskEnergyProfile | null {\n    const profile = this.taskProfiles.find(p => p.taskCategory === category);\n    if (!profile) return null;\n    return {\n      ...profile,\n      energyModes: profile.energyModes.map(m => ({\n        ...m,\n        energyPerHour: new Map(m.energyPerHour),\n      })),\n    };\n  }\n\n  // ============================================\n  // MODE SELECTION & PLANNING\n  // ============================================\n\n  setModeSelection(category: TaskCategory, modeId: string): void {\n    const profile = this.taskProfiles.find(p => p.taskCategory === category);\n    if (!profile) {\n      throw new EnergyValidationError({\n        code: EnergyErrorCode.PROFILE_NOT_FOUND,\n        message: `Energy profile for ${category} not found`,\n      });\n    }\n\n    const mode = profile.energyModes.find(m => m.id === modeId);\n    if (!mode) {\n      throw new EnergyValidationError({\n        code: EnergyErrorCode.MODE_NOT_FOUND,\n        message: `Mode ${modeId} not found for category ${category}`,\n      });\n    }\n\n    this.selectedModes.set(category, modeId);\n  }\n\n  getSelectedMode(category: TaskCategory): string | null {\n    return this.selectedModes.get(category) ?? null;\n  }\n\n  generateWeeklyPlan(): WeeklyEnergyPlan {\n    const weekStart = this.getWeekStart(now());\n    const memberCount = this.ledger.getStatistics().memberCount;\n\n    // Calculate required consumption by carrier based on selected modes\n    const requiredByCarrier = new Map<EnergyCarrierId, number>();\n    const projectedConsumption = new Map<EnergyCarrierId, number>();\n\n    for (const profile of this.taskProfiles) {\n      const selectedModeId = this.selectedModes.get(profile.taskCategory);\n      const mode = profile.energyModes.find(m => m.id === selectedModeId);\n      if (!mode) continue;\n\n      // Estimate weekly hours for this task category (default: 20h/week * members)\n      const weeklyHours = this.getEstimatedWeeklyHours(profile.taskCategory, memberCount);\n\n      // Add energy requirements\n      for (const [carrierId, perHour] of mode.energyPerHour) {\n        const required = perHour * weeklyHours;\n        const current = requiredByCarrier.get(carrierId) ?? 0;\n        requiredByCarrier.set(carrierId, current + required);\n        projectedConsumption.set(carrierId, current + required);\n      }\n    }\n\n    // Get available by carrier\n    const availableByCarrier = new Map<EnergyCarrierId, number>();\n    for (const [carrierId, stock] of this.stocks) {\n      availableByCarrier.set(carrierId, stock.currentAmount);\n    }\n\n    // Calculate stress\n    const stressIndex = this.calculateStressFromMaps(requiredByCarrier, availableByCarrier);\n\n    // Generate bundles\n    const bundles = this.generateBundles(availableByCarrier, requiredByCarrier);\n\n    const plan: WeeklyEnergyPlan = {\n      cellId: this.cellId,\n      weekStart,\n      projectedConsumption,\n      requiredByCarrier,\n      availableByCarrier,\n      selectedModes: new Map(this.selectedModes),\n      stressIndex,\n      feasible: stressIndex <= 1.0,\n      bundles,\n      createdAt: now(),\n    };\n\n    return plan;\n  }\n\n  private getEstimatedWeeklyHours(category: TaskCategory, memberCount: number): number {\n    // Base estimates per member per week\n    const baseHours: Record<TaskCategory, number> = {\n      [TaskCategory.FOOD]: 3,\n      [TaskCategory.WATER_SANITATION]: 1,\n      [TaskCategory.ENERGY_HEAT]: 2,\n      [TaskCategory.SHELTER_REPAIR]: 0.5,\n      [TaskCategory.MEDICAL]: 0.5,\n      [TaskCategory.CHILDCARE_DEPENDENT]: 2,\n      [TaskCategory.SECURITY_COORDINATION]: 1,\n      [TaskCategory.PROCUREMENT_TRANSPORT]: 1,\n      [TaskCategory.GENERAL]: 1,\n    };\n\n    return (baseHours[category] ?? 1) * Math.max(1, memberCount);\n  }\n\n  // ============================================\n  // STRESS CALCULATION\n  // ============================================\n\n  calculateEnergyStress(): number {\n    const plan = this.generateWeeklyPlan();\n    return plan.stressIndex;\n  }\n\n  private calculateStressFromMaps(\n    required: Map<EnergyCarrierId, number>,\n    available: Map<EnergyCarrierId, number>\n  ): number {\n    // S_E = max_j(required_j / available_j)\n    let maxStress = 0;\n\n    for (const [carrierId, requiredAmount] of required) {\n      if (requiredAmount <= 0) continue;\n\n      const availableAmount = available.get(carrierId) ?? 0;\n      if (availableAmount <= 0) {\n        // If we need something and have none, stress is infinite\n        return Infinity;\n      }\n\n      const stress = requiredAmount / availableAmount;\n      maxStress = Math.max(maxStress, stress);\n    }\n\n    return maxStress;\n  }\n\n  getStressIndex(): number {\n    return this.stressIndex;\n  }\n\n  projectStress(daysAhead: number): StressProjection {\n    const projectedStress: number[] = [];\n    const recommendations: string[] = [];\n    let daysUntilCrisis: number | undefined;\n\n    const plan = this.generateWeeklyPlan();\n    const dailyConsumption = new Map<EnergyCarrierId, number>();\n\n    // Calculate daily consumption rate\n    for (const [carrierId, weeklyAmount] of plan.projectedConsumption) {\n      dailyConsumption.set(carrierId, weeklyAmount / 7);\n    }\n\n    // Project stress for each day\n    const currentStocks = new Map(this.stocks);\n    for (let day = 0; day < daysAhead; day++) {\n      // Reduce stocks by daily consumption\n      for (const [carrierId, dailyRate] of dailyConsumption) {\n        const stock = currentStocks.get(carrierId);\n        if (stock) {\n          stock.currentAmount = Math.max(0, stock.currentAmount - dailyRate);\n        }\n      }\n\n      // Calculate stress for this day\n      const available = new Map<EnergyCarrierId, number>();\n      for (const [carrierId, stock] of currentStocks) {\n        available.set(carrierId, stock.currentAmount);\n      }\n\n      const stress = this.calculateStressFromMaps(plan.requiredByCarrier, available);\n      projectedStress.push(stress);\n\n      if (stress > 1.0 && daysUntilCrisis === undefined) {\n        daysUntilCrisis = day + 1;\n      }\n    }\n\n    // Generate recommendations\n    if (daysUntilCrisis !== undefined) {\n      recommendations.push(`Energy crisis projected in ${daysUntilCrisis} days`);\n      recommendations.push('Consider mode substitution or procurement');\n    }\n\n    for (const [carrierId, stock] of this.stocks) {\n      const dailyRate = dailyConsumption.get(carrierId) ?? 0;\n      if (dailyRate > 0 && stock.currentAmount / dailyRate < 7) {\n        recommendations.push(`Low stock: ${carrierId} will deplete in ${Math.round(stock.currentAmount / dailyRate)} days`);\n      }\n    }\n\n    return {\n      daysAhead,\n      projectedStress,\n      daysUntilCrisis,\n      recommendations,\n    };\n  }\n\n  // ============================================\n  // RATIONING\n  // ============================================\n\n  computeRationingPlan(targetStress: number): RationingPlan {\n    const plan = this.generateWeeklyPlan();\n    const currentStress = plan.stressIndex;\n\n    if (currentStress <= targetStress) {\n      return {\n        targetStress,\n        bundleReductionFactor: 1.0,\n        taskReductions: new Map(),\n        modeSubstitutions: new Map(),\n        additionalProcurement: new Map(),\n        feasible: true,\n        explanation: 'No rationing needed - already below target stress',\n      };\n    }\n\n    // Strategy 1: Mode substitution\n    const modeSubstitutions = new Map<TaskCategory, string>();\n    let newRequired = new Map(plan.requiredByCarrier);\n\n    for (const profile of this.taskProfiles) {\n      const currentModeId = this.selectedModes.get(profile.taskCategory);\n      const currentMode = profile.energyModes.find(m => m.id === currentModeId);\n      if (!currentMode) continue;\n\n      // Try more efficient modes (lower energy, possibly lower effectiveness)\n      for (const mode of profile.energyModes) {\n        if (mode.id === currentModeId) continue;\n\n        // Calculate if this mode uses less of scarce resources\n        let saves = false;\n        for (const [carrierId, currentPerHour] of currentMode.energyPerHour) {\n          const newPerHour = mode.energyPerHour.get(carrierId) ?? 0;\n          if (newPerHour < currentPerHour) {\n            saves = true;\n            break;\n          }\n        }\n\n        if (saves) {\n          modeSubstitutions.set(profile.taskCategory, mode.id);\n          // Update required amounts\n          const weeklyHours = this.getEstimatedWeeklyHours(\n            profile.taskCategory,\n            this.ledger.getStatistics().memberCount\n          );\n\n          // Remove old requirements\n          for (const [carrierId, perHour] of currentMode.energyPerHour) {\n            const current = newRequired.get(carrierId) ?? 0;\n            newRequired.set(carrierId, current - perHour * weeklyHours);\n          }\n\n          // Add new requirements\n          for (const [carrierId, perHour] of mode.energyPerHour) {\n            const current = newRequired.get(carrierId) ?? 0;\n            newRequired.set(carrierId, current + perHour * weeklyHours);\n          }\n          break;\n        }\n      }\n    }\n\n    // Recalculate stress after substitutions\n    let newStress = this.calculateStressFromMaps(newRequired, plan.availableByCarrier);\n\n    if (newStress <= targetStress) {\n      return {\n        targetStress,\n        bundleReductionFactor: 1.0,\n        taskReductions: new Map(),\n        modeSubstitutions,\n        additionalProcurement: new Map(),\n        feasible: true,\n        explanation: 'Mode substitution achieves target stress',\n      };\n    }\n\n    // Strategy 2: Calculate procurement needs\n    const additionalProcurement = new Map<EnergyCarrierId, number>();\n    for (const [carrierId, required] of newRequired) {\n      const available = plan.availableByCarrier.get(carrierId) ?? 0;\n      if (required > available * targetStress) {\n        const needed = required / targetStress - available;\n        additionalProcurement.set(carrierId, Math.ceil(needed));\n      }\n    }\n\n    // Strategy 3: Bundle reduction\n    // y = min(1, available / required) for worst carrier\n    let bundleReductionFactor = 1.0;\n    for (const [carrierId, required] of newRequired) {\n      if (required <= 0) continue;\n      const available = plan.availableByCarrier.get(carrierId) ?? 0;\n      const factor = available / required;\n      bundleReductionFactor = Math.min(bundleReductionFactor, factor);\n    }\n\n    // Don't go below humanitarian floor\n    bundleReductionFactor = Math.max(HUMANITARIAN_FLOOR, bundleReductionFactor);\n\n    // Recalculate with procurement\n    const availableWithProcurement = new Map(plan.availableByCarrier);\n    for (const [carrierId, amount] of additionalProcurement) {\n      const current = availableWithProcurement.get(carrierId) ?? 0;\n      availableWithProcurement.set(carrierId, current + amount);\n    }\n\n    newStress = this.calculateStressFromMaps(newRequired, availableWithProcurement);\n\n    return {\n      targetStress,\n      bundleReductionFactor,\n      taskReductions: new Map(), // Could be expanded to reduce specific tasks\n      modeSubstitutions,\n      additionalProcurement,\n      feasible: newStress <= targetStress,\n      explanation: newStress <= targetStress\n        ? 'Rationing plan achieves target stress'\n        : `Best achievable stress is ${newStress.toFixed(2)} with current measures`,\n    };\n  }\n\n  async applyRationingPlan(plan: RationingPlan): Promise<void> {\n    // Apply mode substitutions\n    for (const [category, modeId] of plan.modeSubstitutions) {\n      this.setModeSelection(category, modeId);\n    }\n\n    // Note: Procurement and bundle reduction would be handled externally\n    // This engine just tracks the plan\n\n    await this.saveState();\n\n    await this.storage.appendEvent({\n      cellId: this.cellId,\n      type: 'RATIONING_PLAN_APPLIED',\n      timestamp: now(),\n      data: {\n        targetStress: plan.targetStress,\n        bundleReductionFactor: plan.bundleReductionFactor,\n        modeSubstitutions: Object.fromEntries(plan.modeSubstitutions),\n        feasible: plan.feasible,\n      },\n    });\n  }\n\n  getBundleDistribution(): MemberBundle[] {\n    const plan = this.generateWeeklyPlan();\n    return plan.bundles;\n  }\n\n  private generateBundles(\n    available: Map<EnergyCarrierId, number>,\n    required: Map<EnergyCarrierId, number>\n  ): MemberBundle[] {\n    const members = this.ledger.getAllMemberStates();\n    const memberCount = members.size;\n    if (memberCount === 0) return [];\n\n    // Calculate base bundle fraction\n    let baseFraction = 1.0;\n    for (const [carrierId, requiredAmount] of required) {\n      if (requiredAmount <= 0) continue;\n      const availableAmount = available.get(carrierId) ?? 0;\n      const factor = availableAmount / requiredAmount;\n      baseFraction = Math.min(baseFraction, factor);\n    }\n\n    // Apply humanitarian floor\n    baseFraction = Math.max(HUMANITARIAN_FLOOR, Math.min(1.0, baseFraction));\n\n    const bundles: MemberBundle[] = [];\n\n    for (const [memberId, memberState] of members) {\n      // Determine vulnerability (simplified: members at debt floor are vulnerable)\n      const isVulnerable = memberState.balance <= -memberState.limit * 0.8;\n\n      // Apply vulnerability bonus\n      const bundleFraction = Math.min(\n        1.0,\n        baseFraction * (1 + (isVulnerable ? VULNERABILITY_BONUS : 0))\n      );\n\n      // Calculate allocation\n      const energyAllocation = new Map<EnergyCarrierId, number>();\n      for (const [carrierId, availableAmount] of available) {\n        const perMember = availableAmount / memberCount;\n        energyAllocation.set(carrierId, perMember * bundleFraction);\n      }\n\n      bundles.push({\n        memberId,\n        bundleFraction,\n        energyAllocation,\n        isVulnerable,\n      });\n    }\n\n    return bundles;\n  }\n\n  // ============================================\n  // HISTORY & PROJECTIONS\n  // ============================================\n\n  getFlowHistory(carrierId: EnergyCarrierId, since: Timestamp): EnergyFlow[] {\n    const flows = this.flowHistory.get(carrierId) ?? [];\n    return flows\n      .filter(f => f.period.end >= since)\n      .map(f => ({ ...f }));\n  }\n\n  projectDepletion(carrierId: EnergyCarrierId): Timestamp | null {\n    const stock = this.stocks.get(carrierId);\n    if (!stock || stock.currentAmount <= 0) return null;\n\n    // Get recent consumption rate\n    const weekAgo = now() - 7 * 24 * 60 * 60 * 1000;\n    const flows = this.flowHistory.get(carrierId) ?? [];\n    const recentFlow = flows.find(f => f.period.end >= weekAgo);\n\n    if (!recentFlow || recentFlow.outflow <= 0) {\n      return null; // Can't project without consumption data\n    }\n\n    const dailyRate = recentFlow.outflow / 7;\n    if (dailyRate <= 0) return null;\n\n    const daysUntilDepletion = stock.currentAmount / dailyRate;\n    return now() + daysUntilDepletion * 24 * 60 * 60 * 1000;\n  }\n\n  generateProcurementAlerts(): ProcurementAlert[] {\n    const alerts: ProcurementAlert[] = [];\n    const plan = this.generateWeeklyPlan();\n\n    for (const [carrierId, stock] of this.stocks) {\n      const required = plan.requiredByCarrier.get(carrierId) ?? 0;\n      if (required <= 0) continue;\n\n      const dailyRate = required / 7;\n      if (dailyRate <= 0) continue;\n\n      const daysUntilDepletion = stock.currentAmount / dailyRate;\n\n      let priority: 1 | 2 | 3;\n      let message: string;\n\n      if (daysUntilDepletion < 3) {\n        priority = 1;\n        message = `URGENT: ${carrierId} will deplete in ${Math.round(daysUntilDepletion)} days`;\n      } else if (daysUntilDepletion < 7) {\n        priority = 2;\n        message = `${carrierId} running low - ${Math.round(daysUntilDepletion)} days remaining`;\n      } else if (daysUntilDepletion < 14) {\n        priority = 3;\n        message = `Monitor ${carrierId} - ${Math.round(daysUntilDepletion)} days remaining`;\n      } else {\n        continue; // No alert needed\n      }\n\n      // Recommend at least 2 weeks supply\n      const recommendedAmount = dailyRate * 14 - stock.currentAmount;\n\n      if (recommendedAmount > 0) {\n        alerts.push({\n          carrierId,\n          currentStock: stock.currentAmount,\n          daysUntilDepletion,\n          recommendedAmount: Math.ceil(recommendedAmount),\n          priority,\n          message,\n        });\n      }\n    }\n\n    return alerts.sort((a, b) => a.priority - b.priority);\n  }\n\n  // ============================================\n  // TASK SUPPORT\n  // ============================================\n\n  canCompleteTask(category: TaskCategory, hours: number): boolean {\n    const profile = this.taskProfiles.find(p => p.taskCategory === category);\n    if (!profile) return true; // No profile means no energy requirement\n\n    const selectedModeId = this.selectedModes.get(category);\n    const mode = profile.energyModes.find(m => m.id === selectedModeId);\n    if (!mode) return true;\n\n    // Check if we have enough of each required carrier\n    for (const [carrierId, perHour] of mode.energyPerHour) {\n      const required = perHour * hours;\n      const stock = this.stocks.get(carrierId);\n      if (!stock || stock.currentAmount < required) {\n        return false;\n      }\n    }\n\n    return true;\n  }\n\n  // ============================================\n  // PERSISTENCE\n  // ============================================\n\n  private async saveState(): Promise<void> {\n    const state: EnergyState = {\n      cellId: this.cellId,\n      carriers: this.carriers,\n      stocks: new Map(this.stocks),\n      selectedModes: new Map(this.selectedModes),\n      taskProfiles: this.cloneTaskProfiles(this.taskProfiles),\n      stressIndex: this.stressIndex,\n      lastCalculated: now(),\n      createdAt: now(),\n      updatedAt: now(),\n    };\n\n    const result = await this.storage.saveEnergyState(state);\n    if (!result.ok) {\n      throw new EnergyValidationError({\n        code: EnergyErrorCode.STORAGE_ERROR,\n        message: result.error.message,\n      });\n    }\n  }\n\n  async loadState(): Promise<void> {\n    const result = await this.storage.getEnergyState(this.cellId);\n    if (result.ok && result.value) {\n      const state = result.value;\n      this.carriers = state.carriers;\n      this.stocks = new Map(state.stocks);\n      this.selectedModes = new Map(state.selectedModes);\n      this.taskProfiles = this.cloneTaskProfiles(state.taskProfiles);\n      this.stressIndex = state.stressIndex;\n    }\n  }\n\n  // ============================================\n  // HELPERS\n  // ============================================\n\n  private getWeekStart(timestamp: Timestamp): Timestamp {\n    const date = new Date(timestamp);\n    const day = date.getDay();\n    const diff = date.getDate() - day;\n    date.setDate(diff);\n    date.setHours(0, 0, 0, 0);\n    return date.getTime();\n  }\n\n  private cloneTaskProfiles(profiles: TaskEnergyProfile[]): TaskEnergyProfile[] {\n    return profiles.map(p => ({\n      ...p,\n      energyModes: p.energyModes.map(m => ({\n        ...m,\n        energyPerHour: new Map(m.energyPerHour),\n      })),\n    }));\n  }\n\n  getCellId(): CellId {\n    return this.cellId;\n  }\n}\n\n// ============================================\n// CUSTOM ERROR CLASS\n// ============================================\n\nexport class EnergyValidationError extends Error {\n  public readonly code: EnergyErrorCode;\n  public readonly details?: Record<string, unknown>;\n\n  constructor(error: EnergyError) {\n    super(error.message);\n    this.name = 'EnergyValidationError';\n    this.code = error.code;\n    this.details = error.details;\n  }\n\n  toJSON(): EnergyError {\n    return {\n      code: this.code,\n      message: this.message,\n      details: this.details,\n    };\n  }\n}\n\n// ============================================\n// FACTORY\n// ============================================\n\n/**\n * Create a new energy engine\n */\nexport function createEnergyEngine(\n  cellId: CellId,\n  ledger: LedgerEngine,\n  storage: IStorage,\n  carriers?: EnergyCarrier[],\n  taskProfiles?: TaskEnergyProfile[]\n): EnergyEngine {\n  return new EnergyEngine(cellId, ledger, storage, carriers, taskProfiles);\n}\n\n/**\n * Create energy engine and wire with scheduler\n */\nexport async function createEnergyEngineWithScheduler(\n  cellId: CellId,\n  ledger: LedgerEngine,\n  scheduler: SchedulerEngine,\n  storage: IStorage,\n  carriers?: EnergyCarrier[],\n  taskProfiles?: TaskEnergyProfile[]\n): Promise<EnergyEngine> {\n  const engine = new EnergyEngine(cellId, ledger, storage, carriers, taskProfiles);\n  engine.setSchedulerEngine(scheduler);\n  await engine.loadState();\n  return engine;\n}\n", "/**\n * Cell Protocol - PouchDB Storage Adapter\n *\n * Provides offline-first persistence for cell protocol data.\n * Supports in-memory storage for testing.\n */\n\nimport { CellId, IdentityId, TransactionId, Timestamp, now, generateId } from '../types/common';\nimport { CellLedgerState, MemberState, LedgerParameters } from '../types/ledger';\nimport { SpotTransaction, QueuedTransaction, TransactionStatus } from '../types/transaction';\nimport { CellIdentity, MembershipChange } from '../types/identity';\nimport { Commitment, CommitmentId, CommitmentStatus, TaskCategory } from '../types/commitment';\nimport { Proposal, ProposalId, ProposalStatus, Dispute, DisputeId, DisputeStatus, GovernanceCouncil } from '../types/governance';\nimport { TaskSlot, TaskSlotId, TaskSlotStatus, TaskTemplate, TaskTemplateId, MemberSupply } from '../types/scheduler';\nimport { EmergencyState, StateHistoryEntry } from '../types/emergency';\nimport { FederationState, FederationTransaction, FederationTxId, FederationTxStatus, LinkProposal, LinkProposalId } from '../types/federation';\nimport { EnergyState, StockChangeRecord, ConsumptionRecord, WeeklyEnergyPlan, EnergyCarrierId } from '../types/energy';\nimport { Result, ok, err } from '../utils/result';\n\n// ============================================\n// STORAGE TYPES\n// ============================================\n\nexport interface StorageError {\n  code: 'NOT_FOUND' | 'ALREADY_EXISTS' | 'WRITE_FAILED' | 'READ_FAILED' | 'DELETE_FAILED';\n  message: string;\n}\n\nexport interface StorageDocument<T> {\n  _id: string;\n  _rev?: string;\n  type: string;\n  data: T;\n  createdAt: Timestamp;\n  updatedAt: Timestamp;\n}\n\nexport interface EventLogEntry {\n  id: string;\n  cellId: CellId;\n  type: string;\n  timestamp: Timestamp;\n  sequenceNumber: number;\n  data: Record<string, unknown>;\n}\n\n// ============================================\n// STORAGE INTERFACE\n// ============================================\n\nexport interface IStorage {\n  // Ledger operations\n  saveLedgerState(state: CellLedgerState): Promise<Result<void, StorageError>>;\n  getLedgerState(cellId: CellId): Promise<Result<CellLedgerState | null, StorageError>>;\n\n  // Identity operations\n  saveIdentity(identity: CellIdentity): Promise<Result<void, StorageError>>;\n  getIdentity(id: IdentityId): Promise<Result<CellIdentity | null, StorageError>>;\n  getIdentityByPublicKey(publicKey: string): Promise<Result<CellIdentity | null, StorageError>>;\n  getAllIdentities(cellId: CellId): Promise<Result<CellIdentity[], StorageError>>;\n  deleteIdentity(id: IdentityId): Promise<Result<void, StorageError>>;\n\n  // Transaction operations\n  saveTransaction(tx: SpotTransaction): Promise<Result<void, StorageError>>;\n  getTransaction(id: TransactionId): Promise<Result<SpotTransaction | null, StorageError>>;\n  getTransactionsByMember(\n    memberId: IdentityId,\n    limit?: number,\n    offset?: number\n  ): Promise<Result<SpotTransaction[], StorageError>>;\n\n  // Offline queue operations\n  queueTransaction(tx: QueuedTransaction): Promise<Result<void, StorageError>>;\n  getQueuedTransactions(): Promise<Result<QueuedTransaction[], StorageError>>;\n  removeFromQueue(txId: TransactionId): Promise<Result<void, StorageError>>;\n\n  // Event log operations\n  appendEvent(event: Omit<EventLogEntry, 'id' | 'sequenceNumber'>): Promise<Result<EventLogEntry, StorageError>>;\n  getEvents(cellId: CellId, since?: number): Promise<Result<EventLogEntry[], StorageError>>;\n\n  // Membership change log\n  saveMembershipChange(change: MembershipChange): Promise<Result<void, StorageError>>;\n  getMembershipChanges(memberId: IdentityId): Promise<Result<MembershipChange[], StorageError>>;\n\n  // ============================================\n  // PHASE 2: COMMITMENT OPERATIONS\n  // ============================================\n\n  saveCommitment(commitment: Commitment): Promise<Result<void, StorageError>>;\n  getCommitment(id: CommitmentId): Promise<Result<Commitment | null, StorageError>>;\n  getCommitmentsByMember(memberId: IdentityId): Promise<Result<Commitment[], StorageError>>;\n  getCommitmentsByStatus(status: CommitmentStatus): Promise<Result<Commitment[], StorageError>>;\n  getCommitmentsByCategory(category: TaskCategory): Promise<Result<Commitment[], StorageError>>;\n  getAllCommitments(): Promise<Result<Commitment[], StorageError>>;\n\n  // ============================================\n  // PHASE 2: GOVERNANCE OPERATIONS\n  // ============================================\n\n  saveProposal(proposal: Proposal): Promise<Result<void, StorageError>>;\n  getProposal(id: ProposalId): Promise<Result<Proposal | null, StorageError>>;\n  getProposalsByStatus(status: ProposalStatus): Promise<Result<Proposal[], StorageError>>;\n  getAllProposals(): Promise<Result<Proposal[], StorageError>>;\n\n  saveDispute(dispute: Dispute): Promise<Result<void, StorageError>>;\n  getDispute(id: DisputeId): Promise<Result<Dispute | null, StorageError>>;\n  getDisputesByStatus(status: DisputeStatus): Promise<Result<Dispute[], StorageError>>;\n  getAllDisputes(): Promise<Result<Dispute[], StorageError>>;\n\n  saveCouncil(council: GovernanceCouncil): Promise<Result<void, StorageError>>;\n  getCouncil(cellId: CellId): Promise<Result<GovernanceCouncil | null, StorageError>>;\n\n  // ============================================\n  // PHASE 2: SCHEDULER OPERATIONS\n  // ============================================\n\n  saveTaskSlot(slot: TaskSlot): Promise<Result<void, StorageError>>;\n  getTaskSlot(id: TaskSlotId): Promise<Result<TaskSlot | null, StorageError>>;\n  getTaskSlotsByPeriod(start: Timestamp, end: Timestamp): Promise<Result<TaskSlot[], StorageError>>;\n  getTaskSlotsByStatus(status: TaskSlotStatus): Promise<Result<TaskSlot[], StorageError>>;\n  getAllTaskSlots(): Promise<Result<TaskSlot[], StorageError>>;\n\n  saveTaskTemplate(template: TaskTemplate): Promise<Result<void, StorageError>>;\n  getTaskTemplate(id: TaskTemplateId): Promise<Result<TaskTemplate | null, StorageError>>;\n  getAllTaskTemplates(): Promise<Result<TaskTemplate[], StorageError>>;\n\n  saveMemberSupply(supply: MemberSupply): Promise<Result<void, StorageError>>;\n  getMemberSupply(memberId: IdentityId): Promise<Result<MemberSupply | null, StorageError>>;\n  getAllMemberSupplies(): Promise<Result<MemberSupply[], StorageError>>;\n\n  // ============================================\n  // PHASE 3: EMERGENCY OPERATIONS\n  // ============================================\n\n  saveEmergencyState(state: EmergencyState): Promise<Result<void, StorageError>>;\n  getEmergencyState(cellId: CellId): Promise<Result<EmergencyState | null, StorageError>>;\n  appendStateHistoryEntry(entry: StateHistoryEntry, cellId: CellId): Promise<Result<void, StorageError>>;\n  getStateHistory(cellId: CellId, since: Timestamp): Promise<Result<StateHistoryEntry[], StorageError>>;\n\n  // ============================================\n  // PHASE 3: FEDERATION OPERATIONS\n  // ============================================\n\n  saveFederationState(state: FederationState): Promise<Result<void, StorageError>>;\n  getFederationState(cellId: CellId): Promise<Result<FederationState | null, StorageError>>;\n  saveFederationTransaction(tx: FederationTransaction): Promise<Result<void, StorageError>>;\n  getFederationTransaction(id: FederationTxId): Promise<Result<FederationTransaction | null, StorageError>>;\n  getFederationTransactions(filter: {\n    cellId?: CellId;\n    remoteCellId?: CellId;\n    status?: FederationTxStatus;\n    since?: Timestamp;\n  }): Promise<Result<FederationTransaction[], StorageError>>;\n  saveLinkProposal(proposal: LinkProposal): Promise<Result<void, StorageError>>;\n  getLinkProposal(id: LinkProposalId): Promise<Result<LinkProposal | null, StorageError>>;\n\n  // ============================================\n  // PHASE 4: ENERGY OPERATIONS\n  // ============================================\n\n  saveEnergyState(state: EnergyState): Promise<Result<void, StorageError>>;\n  getEnergyState(cellId: CellId): Promise<Result<EnergyState | null, StorageError>>;\n  saveStockChange(change: StockChangeRecord): Promise<Result<void, StorageError>>;\n  getStockChanges(cellId: CellId, since: Timestamp): Promise<Result<StockChangeRecord[], StorageError>>;\n  saveConsumptionRecord(record: ConsumptionRecord): Promise<Result<void, StorageError>>;\n  getConsumptionHistory(cellId: CellId, since: Timestamp): Promise<Result<ConsumptionRecord[], StorageError>>;\n  saveEnergyPlan(plan: WeeklyEnergyPlan): Promise<Result<void, StorageError>>;\n  getEnergyPlan(cellId: CellId, weekStart: Timestamp): Promise<Result<WeeklyEnergyPlan | null, StorageError>>;\n}\n\n// ============================================\n// IN-MEMORY STORAGE (for testing)\n// ============================================\n\nexport class InMemoryStorage implements IStorage {\n  private ledgerStates = new Map<CellId, CellLedgerState>();\n  private identities = new Map<IdentityId, CellIdentity>();\n  private identitiesByPublicKey = new Map<string, IdentityId>();\n  private transactions = new Map<TransactionId, SpotTransaction>();\n  private transactionsByMember = new Map<IdentityId, Set<TransactionId>>();\n  private offlineQueue = new Map<TransactionId, QueuedTransaction>();\n  private events: EventLogEntry[] = [];\n  private eventSequence = 0;\n  private membershipChanges = new Map<IdentityId, MembershipChange[]>();\n\n  // Phase 2 storage\n  private commitments = new Map<CommitmentId, Commitment>();\n  private proposals = new Map<ProposalId, Proposal>();\n  private disputes = new Map<DisputeId, Dispute>();\n  private councils = new Map<CellId, GovernanceCouncil>();\n  private taskSlots = new Map<TaskSlotId, TaskSlot>();\n  private taskTemplates = new Map<TaskTemplateId, TaskTemplate>();\n  private memberSupplies = new Map<IdentityId, MemberSupply>();\n\n  // Phase 3 storage\n  private emergencyStates = new Map<CellId, EmergencyState>();\n  private stateHistories = new Map<CellId, StateHistoryEntry[]>();\n  private federationStates = new Map<CellId, FederationState>();\n  private federationTransactions = new Map<FederationTxId, FederationTransaction>();\n  private linkProposals = new Map<LinkProposalId, LinkProposal>();\n\n  // Phase 4 storage\n  private energyStates = new Map<CellId, EnergyState>();\n  private stockChanges = new Map<CellId, StockChangeRecord[]>();\n  private consumptionRecords = new Map<CellId, ConsumptionRecord[]>();\n  private energyPlans = new Map<string, WeeklyEnergyPlan>(); // key: cellId:weekStart\n\n  // Ledger operations\n  async saveLedgerState(state: CellLedgerState): Promise<Result<void, StorageError>> {\n    // Deep clone to prevent mutation issues\n    const cloned: CellLedgerState = {\n      ...state,\n      members: new Map(state.members),\n      parameters: { ...state.parameters },\n    };\n    this.ledgerStates.set(state.cellId, cloned);\n    return ok(undefined);\n  }\n\n  async getLedgerState(cellId: CellId): Promise<Result<CellLedgerState | null, StorageError>> {\n    const state = this.ledgerStates.get(cellId);\n    if (!state) {\n      return ok(null);\n    }\n    // Return a clone to prevent mutation\n    return ok({\n      ...state,\n      members: new Map(state.members),\n      parameters: { ...state.parameters },\n    });\n  }\n\n  // Identity operations\n  async saveIdentity(identity: CellIdentity): Promise<Result<void, StorageError>> {\n    this.identities.set(identity.id, { ...identity });\n    this.identitiesByPublicKey.set(identity.publicKey, identity.id);\n    return ok(undefined);\n  }\n\n  async getIdentity(id: IdentityId): Promise<Result<CellIdentity | null, StorageError>> {\n    const identity = this.identities.get(id);\n    return ok(identity ? { ...identity } : null);\n  }\n\n  async getIdentityByPublicKey(publicKey: string): Promise<Result<CellIdentity | null, StorageError>> {\n    const id = this.identitiesByPublicKey.get(publicKey);\n    if (!id) {\n      return ok(null);\n    }\n    return this.getIdentity(id);\n  }\n\n  async getAllIdentities(cellId: CellId): Promise<Result<CellIdentity[], StorageError>> {\n    const identities = Array.from(this.identities.values())\n      .filter(i => i.cellId === cellId)\n      .map(i => ({ ...i }));\n    return ok(identities);\n  }\n\n  async deleteIdentity(id: IdentityId): Promise<Result<void, StorageError>> {\n    const identity = this.identities.get(id);\n    if (identity) {\n      this.identitiesByPublicKey.delete(identity.publicKey);\n      this.identities.delete(id);\n    }\n    return ok(undefined);\n  }\n\n  // Transaction operations\n  async saveTransaction(tx: SpotTransaction): Promise<Result<void, StorageError>> {\n    this.transactions.set(tx.id, { ...tx });\n\n    // Index by payer\n    if (!this.transactionsByMember.has(tx.payer)) {\n      this.transactionsByMember.set(tx.payer, new Set());\n    }\n    this.transactionsByMember.get(tx.payer)!.add(tx.id);\n\n    // Index by payee\n    if (!this.transactionsByMember.has(tx.payee)) {\n      this.transactionsByMember.set(tx.payee, new Set());\n    }\n    this.transactionsByMember.get(tx.payee)!.add(tx.id);\n\n    return ok(undefined);\n  }\n\n  async getTransaction(id: TransactionId): Promise<Result<SpotTransaction | null, StorageError>> {\n    const tx = this.transactions.get(id);\n    return ok(tx ? { ...tx } : null);\n  }\n\n  async getTransactionsByMember(\n    memberId: IdentityId,\n    limit: number = 100,\n    offset: number = 0\n  ): Promise<Result<SpotTransaction[], StorageError>> {\n    const txIds = this.transactionsByMember.get(memberId);\n    if (!txIds) {\n      return ok([]);\n    }\n\n    const transactions = Array.from(txIds)\n      .map(id => this.transactions.get(id)!)\n      .filter(Boolean)\n      .sort((a, b) => b.createdAt - a.createdAt)\n      .slice(offset, offset + limit)\n      .map(tx => ({ ...tx }));\n\n    return ok(transactions);\n  }\n\n  // Offline queue operations\n  async queueTransaction(tx: QueuedTransaction): Promise<Result<void, StorageError>> {\n    this.offlineQueue.set(tx.transaction.id, { ...tx });\n    return ok(undefined);\n  }\n\n  async getQueuedTransactions(): Promise<Result<QueuedTransaction[], StorageError>> {\n    const queued = Array.from(this.offlineQueue.values())\n      .map(q => ({ ...q }))\n      .sort((a, b) => a.queuedAt - b.queuedAt);\n    return ok(queued);\n  }\n\n  async removeFromQueue(txId: TransactionId): Promise<Result<void, StorageError>> {\n    this.offlineQueue.delete(txId);\n    return ok(undefined);\n  }\n\n  // Event log operations\n  async appendEvent(\n    event: Omit<EventLogEntry, 'id' | 'sequenceNumber'>\n  ): Promise<Result<EventLogEntry, StorageError>> {\n    const fullEvent: EventLogEntry = {\n      ...event,\n      id: generateId(),\n      sequenceNumber: ++this.eventSequence,\n    };\n    this.events.push(fullEvent);\n    return ok(fullEvent);\n  }\n\n  async getEvents(cellId: CellId, since: number = 0): Promise<Result<EventLogEntry[], StorageError>> {\n    const events = this.events\n      .filter(e => e.cellId === cellId && e.sequenceNumber > since)\n      .map(e => ({ ...e }));\n    return ok(events);\n  }\n\n  // Membership change log\n  async saveMembershipChange(change: MembershipChange): Promise<Result<void, StorageError>> {\n    if (!this.membershipChanges.has(change.memberId)) {\n      this.membershipChanges.set(change.memberId, []);\n    }\n    this.membershipChanges.get(change.memberId)!.push({ ...change });\n    return ok(undefined);\n  }\n\n  async getMembershipChanges(memberId: IdentityId): Promise<Result<MembershipChange[], StorageError>> {\n    const changes = this.membershipChanges.get(memberId) || [];\n    return ok(changes.map(c => ({ ...c })));\n  }\n\n  // ============================================\n  // PHASE 2: COMMITMENT OPERATIONS\n  // ============================================\n\n  async saveCommitment(commitment: Commitment): Promise<Result<void, StorageError>> {\n    this.commitments.set(commitment.id, { ...commitment });\n    return ok(undefined);\n  }\n\n  async getCommitment(id: CommitmentId): Promise<Result<Commitment | null, StorageError>> {\n    const commitment = this.commitments.get(id);\n    return ok(commitment ? { ...commitment } : null);\n  }\n\n  async getCommitmentsByMember(memberId: IdentityId): Promise<Result<Commitment[], StorageError>> {\n    const commitments = Array.from(this.commitments.values())\n      .filter(c => c.promisor === memberId || c.promisee === memberId)\n      .map(c => ({ ...c }));\n    return ok(commitments);\n  }\n\n  async getCommitmentsByStatus(status: CommitmentStatus): Promise<Result<Commitment[], StorageError>> {\n    const commitments = Array.from(this.commitments.values())\n      .filter(c => c.status === status)\n      .map(c => ({ ...c }));\n    return ok(commitments);\n  }\n\n  async getCommitmentsByCategory(category: TaskCategory): Promise<Result<Commitment[], StorageError>> {\n    const commitments = Array.from(this.commitments.values())\n      .filter(c => c.category === category)\n      .map(c => ({ ...c }));\n    return ok(commitments);\n  }\n\n  async getAllCommitments(): Promise<Result<Commitment[], StorageError>> {\n    const commitments = Array.from(this.commitments.values()).map(c => ({ ...c }));\n    return ok(commitments);\n  }\n\n  // ============================================\n  // PHASE 2: GOVERNANCE OPERATIONS\n  // ============================================\n\n  async saveProposal(proposal: Proposal): Promise<Result<void, StorageError>> {\n    this.proposals.set(proposal.id, { ...proposal, votes: [...proposal.votes] });\n    return ok(undefined);\n  }\n\n  async getProposal(id: ProposalId): Promise<Result<Proposal | null, StorageError>> {\n    const proposal = this.proposals.get(id);\n    return ok(proposal ? { ...proposal, votes: [...proposal.votes] } : null);\n  }\n\n  async getProposalsByStatus(status: ProposalStatus): Promise<Result<Proposal[], StorageError>> {\n    const proposals = Array.from(this.proposals.values())\n      .filter(p => p.status === status)\n      .map(p => ({ ...p, votes: [...p.votes] }));\n    return ok(proposals);\n  }\n\n  async getAllProposals(): Promise<Result<Proposal[], StorageError>> {\n    const proposals = Array.from(this.proposals.values()).map(p => ({ ...p, votes: [...p.votes] }));\n    return ok(proposals);\n  }\n\n  async saveDispute(dispute: Dispute): Promise<Result<void, StorageError>> {\n    this.disputes.set(dispute.id, { ...dispute, evidence: [...dispute.evidence] });\n    return ok(undefined);\n  }\n\n  async getDispute(id: DisputeId): Promise<Result<Dispute | null, StorageError>> {\n    const dispute = this.disputes.get(id);\n    return ok(dispute ? { ...dispute, evidence: [...dispute.evidence] } : null);\n  }\n\n  async getDisputesByStatus(status: DisputeStatus): Promise<Result<Dispute[], StorageError>> {\n    const disputes = Array.from(this.disputes.values())\n      .filter(d => d.status === status)\n      .map(d => ({ ...d, evidence: [...d.evidence] }));\n    return ok(disputes);\n  }\n\n  async getAllDisputes(): Promise<Result<Dispute[], StorageError>> {\n    const disputes = Array.from(this.disputes.values()).map(d => ({ ...d, evidence: [...d.evidence] }));\n    return ok(disputes);\n  }\n\n  async saveCouncil(council: GovernanceCouncil): Promise<Result<void, StorageError>> {\n    this.councils.set(council.cellId, { ...council, members: [...council.members] });\n    return ok(undefined);\n  }\n\n  async getCouncil(cellId: CellId): Promise<Result<GovernanceCouncil | null, StorageError>> {\n    const council = this.councils.get(cellId);\n    return ok(council ? { ...council, members: [...council.members] } : null);\n  }\n\n  // ============================================\n  // PHASE 2: SCHEDULER OPERATIONS\n  // ============================================\n\n  async saveTaskSlot(slot: TaskSlot): Promise<Result<void, StorageError>> {\n    this.taskSlots.set(slot.id, { ...slot, assignments: [...slot.assignments] });\n    return ok(undefined);\n  }\n\n  async getTaskSlot(id: TaskSlotId): Promise<Result<TaskSlot | null, StorageError>> {\n    const slot = this.taskSlots.get(id);\n    return ok(slot ? { ...slot, assignments: [...slot.assignments] } : null);\n  }\n\n  async getTaskSlotsByPeriod(start: Timestamp, end: Timestamp): Promise<Result<TaskSlot[], StorageError>> {\n    const slots = Array.from(this.taskSlots.values())\n      .filter(s => s.startTime >= start && s.startTime < end)\n      .map(s => ({ ...s, assignments: [...s.assignments] }))\n      .sort((a, b) => a.startTime - b.startTime);\n    return ok(slots);\n  }\n\n  async getTaskSlotsByStatus(status: TaskSlotStatus): Promise<Result<TaskSlot[], StorageError>> {\n    const slots = Array.from(this.taskSlots.values())\n      .filter(s => s.status === status)\n      .map(s => ({ ...s, assignments: [...s.assignments] }));\n    return ok(slots);\n  }\n\n  async getAllTaskSlots(): Promise<Result<TaskSlot[], StorageError>> {\n    const slots = Array.from(this.taskSlots.values()).map(s => ({ ...s, assignments: [...s.assignments] }));\n    return ok(slots);\n  }\n\n  async saveTaskTemplate(template: TaskTemplate): Promise<Result<void, StorageError>> {\n    this.taskTemplates.set(template.id, { ...template });\n    return ok(undefined);\n  }\n\n  async getTaskTemplate(id: TaskTemplateId): Promise<Result<TaskTemplate | null, StorageError>> {\n    const template = this.taskTemplates.get(id);\n    return ok(template ? { ...template } : null);\n  }\n\n  async getAllTaskTemplates(): Promise<Result<TaskTemplate[], StorageError>> {\n    const templates = Array.from(this.taskTemplates.values()).map(t => ({ ...t }));\n    return ok(templates);\n  }\n\n  async saveMemberSupply(supply: MemberSupply): Promise<Result<void, StorageError>> {\n    // Clone the supply, converting Map to a new Map\n    const cloned: MemberSupply = {\n      ...supply,\n      skills: new Map(supply.skills),\n      preferences: [...supply.preferences],\n      constraints: [...supply.constraints],\n    };\n    this.memberSupplies.set(supply.memberId, cloned);\n    return ok(undefined);\n  }\n\n  async getMemberSupply(memberId: IdentityId): Promise<Result<MemberSupply | null, StorageError>> {\n    const supply = this.memberSupplies.get(memberId);\n    if (!supply) return ok(null);\n    return ok({\n      ...supply,\n      skills: new Map(supply.skills),\n      preferences: [...supply.preferences],\n      constraints: [...supply.constraints],\n    });\n  }\n\n  async getAllMemberSupplies(): Promise<Result<MemberSupply[], StorageError>> {\n    const supplies = Array.from(this.memberSupplies.values()).map(s => ({\n      ...s,\n      skills: new Map(s.skills),\n      preferences: [...s.preferences],\n      constraints: [...s.constraints],\n    }));\n    return ok(supplies);\n  }\n\n  // ============================================\n  // PHASE 3: EMERGENCY OPERATIONS\n  // ============================================\n\n  async saveEmergencyState(state: EmergencyState): Promise<Result<void, StorageError>> {\n    this.emergencyStates.set(state.cellId, { ...state });\n    return ok(undefined);\n  }\n\n  async getEmergencyState(cellId: CellId): Promise<Result<EmergencyState | null, StorageError>> {\n    const state = this.emergencyStates.get(cellId);\n    return ok(state ? { ...state } : null);\n  }\n\n  async appendStateHistoryEntry(entry: StateHistoryEntry, cellId: CellId): Promise<Result<void, StorageError>> {\n    if (!this.stateHistories.has(cellId)) {\n      this.stateHistories.set(cellId, []);\n    }\n    this.stateHistories.get(cellId)!.push({ ...entry });\n    return ok(undefined);\n  }\n\n  async getStateHistory(cellId: CellId, since: Timestamp): Promise<Result<StateHistoryEntry[], StorageError>> {\n    const history = this.stateHistories.get(cellId) || [];\n    const filtered = history\n      .filter(e => e.timestamp >= since)\n      .map(e => ({ ...e }))\n      .sort((a, b) => a.timestamp - b.timestamp);\n    return ok(filtered);\n  }\n\n  // ============================================\n  // PHASE 3: FEDERATION OPERATIONS\n  // ============================================\n\n  async saveFederationState(state: FederationState): Promise<Result<void, StorageError>> {\n    this.federationStates.set(state.cellId, {\n      ...state,\n      connectedCells: [...state.connectedCells.map(c => ({ ...c }))],\n    });\n    return ok(undefined);\n  }\n\n  async getFederationState(cellId: CellId): Promise<Result<FederationState | null, StorageError>> {\n    const state = this.federationStates.get(cellId);\n    if (!state) return ok(null);\n    return ok({\n      ...state,\n      connectedCells: [...state.connectedCells.map(c => ({ ...c }))],\n    });\n  }\n\n  async saveFederationTransaction(tx: FederationTransaction): Promise<Result<void, StorageError>> {\n    this.federationTransactions.set(tx.id, { ...tx });\n    return ok(undefined);\n  }\n\n  async getFederationTransaction(id: FederationTxId): Promise<Result<FederationTransaction | null, StorageError>> {\n    const tx = this.federationTransactions.get(id);\n    return ok(tx ? { ...tx } : null);\n  }\n\n  async getFederationTransactions(filter: {\n    cellId?: CellId;\n    remoteCellId?: CellId;\n    status?: FederationTxStatus;\n    since?: Timestamp;\n  }): Promise<Result<FederationTransaction[], StorageError>> {\n    let transactions = Array.from(this.federationTransactions.values());\n\n    if (filter.cellId) {\n      transactions = transactions.filter(t =>\n        t.sourceCell === filter.cellId || t.targetCell === filter.cellId\n      );\n    }\n\n    if (filter.remoteCellId) {\n      transactions = transactions.filter(t =>\n        t.sourceCell === filter.remoteCellId || t.targetCell === filter.remoteCellId\n      );\n    }\n\n    if (filter.status) {\n      transactions = transactions.filter(t => t.status === filter.status);\n    }\n\n    if (filter.since) {\n      transactions = transactions.filter(t => t.createdAt >= filter.since!);\n    }\n\n    return ok(transactions.map(t => ({ ...t })).sort((a, b) => b.createdAt - a.createdAt));\n  }\n\n  async saveLinkProposal(proposal: LinkProposal): Promise<Result<void, StorageError>> {\n    this.linkProposals.set(proposal.id, { ...proposal, proposedTerms: { ...proposal.proposedTerms } });\n    return ok(undefined);\n  }\n\n  async getLinkProposal(id: LinkProposalId): Promise<Result<LinkProposal | null, StorageError>> {\n    const proposal = this.linkProposals.get(id);\n    return ok(proposal ? { ...proposal, proposedTerms: { ...proposal.proposedTerms } } : null);\n  }\n\n  // ============================================\n  // PHASE 4: ENERGY OPERATIONS\n  // ============================================\n\n  async saveEnergyState(state: EnergyState): Promise<Result<void, StorageError>> {\n    // Deep clone with Map handling\n    const cloned: EnergyState = {\n      ...state,\n      carriers: [...state.carriers],\n      stocks: new Map(state.stocks),\n      selectedModes: new Map(state.selectedModes),\n      taskProfiles: state.taskProfiles.map(p => ({\n        ...p,\n        energyModes: p.energyModes.map(m => ({\n          ...m,\n          energyPerHour: new Map(m.energyPerHour),\n        })),\n      })),\n    };\n    this.energyStates.set(state.cellId, cloned);\n    return ok(undefined);\n  }\n\n  async getEnergyState(cellId: CellId): Promise<Result<EnergyState | null, StorageError>> {\n    const state = this.energyStates.get(cellId);\n    if (!state) return ok(null);\n    // Deep clone with Map handling\n    return ok({\n      ...state,\n      carriers: [...state.carriers],\n      stocks: new Map(state.stocks),\n      selectedModes: new Map(state.selectedModes),\n      taskProfiles: state.taskProfiles.map(p => ({\n        ...p,\n        energyModes: p.energyModes.map(m => ({\n          ...m,\n          energyPerHour: new Map(m.energyPerHour),\n        })),\n      })),\n    });\n  }\n\n  async saveStockChange(change: StockChangeRecord): Promise<Result<void, StorageError>> {\n    if (!this.stockChanges.has(change.cellId)) {\n      this.stockChanges.set(change.cellId, []);\n    }\n    this.stockChanges.get(change.cellId)!.push({ ...change });\n    return ok(undefined);\n  }\n\n  async getStockChanges(cellId: CellId, since: Timestamp): Promise<Result<StockChangeRecord[], StorageError>> {\n    const changes = this.stockChanges.get(cellId) || [];\n    const filtered = changes\n      .filter(c => c.timestamp >= since)\n      .map(c => ({ ...c }))\n      .sort((a, b) => a.timestamp - b.timestamp);\n    return ok(filtered);\n  }\n\n  async saveConsumptionRecord(record: ConsumptionRecord): Promise<Result<void, StorageError>> {\n    if (!this.consumptionRecords.has(record.cellId)) {\n      this.consumptionRecords.set(record.cellId, []);\n    }\n    this.consumptionRecords.get(record.cellId)!.push({ ...record });\n    return ok(undefined);\n  }\n\n  async getConsumptionHistory(cellId: CellId, since: Timestamp): Promise<Result<ConsumptionRecord[], StorageError>> {\n    const records = this.consumptionRecords.get(cellId) || [];\n    const filtered = records\n      .filter(r => r.timestamp >= since)\n      .map(r => ({ ...r }))\n      .sort((a, b) => a.timestamp - b.timestamp);\n    return ok(filtered);\n  }\n\n  async saveEnergyPlan(plan: WeeklyEnergyPlan): Promise<Result<void, StorageError>> {\n    const key = `${plan.cellId}:${plan.weekStart}`;\n    // Deep clone with Map handling\n    const cloned: WeeklyEnergyPlan = {\n      ...plan,\n      projectedConsumption: new Map(plan.projectedConsumption),\n      requiredByCarrier: new Map(plan.requiredByCarrier),\n      availableByCarrier: new Map(plan.availableByCarrier),\n      selectedModes: new Map(plan.selectedModes),\n      bundles: plan.bundles.map(b => ({\n        ...b,\n        energyAllocation: new Map(b.energyAllocation),\n      })),\n    };\n    this.energyPlans.set(key, cloned);\n    return ok(undefined);\n  }\n\n  async getEnergyPlan(cellId: CellId, weekStart: Timestamp): Promise<Result<WeeklyEnergyPlan | null, StorageError>> {\n    const key = `${cellId}:${weekStart}`;\n    const plan = this.energyPlans.get(key);\n    if (!plan) return ok(null);\n    // Deep clone with Map handling\n    return ok({\n      ...plan,\n      projectedConsumption: new Map(plan.projectedConsumption),\n      requiredByCarrier: new Map(plan.requiredByCarrier),\n      availableByCarrier: new Map(plan.availableByCarrier),\n      selectedModes: new Map(plan.selectedModes),\n      bundles: plan.bundles.map(b => ({\n        ...b,\n        energyAllocation: new Map(b.energyAllocation),\n      })),\n    });\n  }\n\n  // Utility methods for testing\n  clear(): void {\n    this.ledgerStates.clear();\n    this.identities.clear();\n    this.identitiesByPublicKey.clear();\n    this.transactions.clear();\n    this.transactionsByMember.clear();\n    this.offlineQueue.clear();\n    this.events = [];\n    this.eventSequence = 0;\n    this.membershipChanges.clear();\n    // Phase 2\n    this.commitments.clear();\n    this.proposals.clear();\n    this.disputes.clear();\n    this.councils.clear();\n    this.taskSlots.clear();\n    this.taskTemplates.clear();\n    this.memberSupplies.clear();\n    // Phase 3\n    this.emergencyStates.clear();\n    this.stateHistories.clear();\n    this.federationStates.clear();\n    this.federationTransactions.clear();\n    this.linkProposals.clear();\n    // Phase 4\n    this.energyStates.clear();\n    this.stockChanges.clear();\n    this.consumptionRecords.clear();\n    this.energyPlans.clear();\n  }\n}\n\n// ============================================\n// POUCHDB STORAGE (for production)\n// ============================================\n\n/** PouchDB database interface (minimal typing) */\ninterface PouchDBLike {\n  get(id: string): Promise<any>;\n  put(doc: any): Promise<{ ok: boolean; id: string; rev: string }>;\n  remove(doc: any): Promise<{ ok: boolean }>;\n  allDocs(options?: any): Promise<{ rows: any[] }>;\n  find(query: any): Promise<{ docs: any[] }>;\n  createIndex(index: any): Promise<any>;\n}\n\nexport class PouchDBStorage implements IStorage {\n  private db: PouchDBLike;\n  private eventSequence = 0;\n  private initialized = false;\n\n  constructor(db: PouchDBLike) {\n    this.db = db;\n  }\n\n  async initialize(): Promise<void> {\n    if (this.initialized) return;\n\n    // Create indexes for efficient queries\n    await this.db.createIndex({\n      index: { fields: ['type', 'data.cellId'] },\n    });\n    await this.db.createIndex({\n      index: { fields: ['type', 'data.publicKey'] },\n    });\n    await this.db.createIndex({\n      index: { fields: ['type', 'data.payer'] },\n    });\n    await this.db.createIndex({\n      index: { fields: ['type', 'data.payee'] },\n    });\n\n    // Get current event sequence\n    const events = await this.db.find({\n      selector: { type: 'event' },\n      sort: [{ 'data.sequenceNumber': 'desc' }],\n      limit: 1,\n    });\n    if (events.docs.length > 0) {\n      this.eventSequence = events.docs[0].data.sequenceNumber;\n    }\n\n    this.initialized = true;\n  }\n\n  // Ledger operations\n  async saveLedgerState(state: CellLedgerState): Promise<Result<void, StorageError>> {\n    try {\n      const docId = `ledger:${state.cellId}`;\n\n      // Convert Map to object for storage\n      const membersObj: Record<string, MemberState> = {};\n      state.members.forEach((v, k) => {\n        membersObj[k] = v;\n      });\n\n      let doc: any = {\n        _id: docId,\n        type: 'ledger',\n        data: {\n          ...state,\n          members: membersObj,\n        },\n        createdAt: now(),\n        updatedAt: now(),\n      };\n\n      // Try to get existing doc for revision\n      try {\n        const existing = await this.db.get(docId);\n        doc._rev = existing._rev;\n        doc.createdAt = existing.createdAt;\n      } catch (e: any) {\n        if (e.status !== 404) throw e;\n      }\n\n      await this.db.put(doc);\n      return ok(undefined);\n    } catch (e) {\n      return err({ code: 'WRITE_FAILED', message: `Failed to save ledger state: ${e}` });\n    }\n  }\n\n  async getLedgerState(cellId: CellId): Promise<Result<CellLedgerState | null, StorageError>> {\n    try {\n      const doc = await this.db.get(`ledger:${cellId}`);\n\n      // Convert members object back to Map\n      const members = new Map<IdentityId, MemberState>();\n      const membersObj = doc.data.members as Record<string, MemberState>;\n      for (const [k, v] of Object.entries(membersObj)) {\n        members.set(k, v);\n      }\n\n      return ok({\n        ...doc.data,\n        members,\n      });\n    } catch (e: any) {\n      if (e.status === 404) {\n        return ok(null);\n      }\n      return err({ code: 'READ_FAILED', message: `Failed to get ledger state: ${e}` });\n    }\n  }\n\n  // Identity operations\n  async saveIdentity(identity: CellIdentity): Promise<Result<void, StorageError>> {\n    try {\n      const docId = `identity:${identity.id}`;\n      let doc: any = {\n        _id: docId,\n        type: 'identity',\n        data: identity,\n        createdAt: now(),\n        updatedAt: now(),\n      };\n\n      try {\n        const existing = await this.db.get(docId);\n        doc._rev = existing._rev;\n        doc.createdAt = existing.createdAt;\n      } catch (e: any) {\n        if (e.status !== 404) throw e;\n      }\n\n      await this.db.put(doc);\n      return ok(undefined);\n    } catch (e) {\n      return err({ code: 'WRITE_FAILED', message: `Failed to save identity: ${e}` });\n    }\n  }\n\n  async getIdentity(id: IdentityId): Promise<Result<CellIdentity | null, StorageError>> {\n    try {\n      const doc = await this.db.get(`identity:${id}`);\n      return ok(doc.data);\n    } catch (e: any) {\n      if (e.status === 404) {\n        return ok(null);\n      }\n      return err({ code: 'READ_FAILED', message: `Failed to get identity: ${e}` });\n    }\n  }\n\n  async getIdentityByPublicKey(publicKey: string): Promise<Result<CellIdentity | null, StorageError>> {\n    try {\n      const result = await this.db.find({\n        selector: {\n          type: 'identity',\n          'data.publicKey': publicKey,\n        },\n      });\n      if (result.docs.length === 0) {\n        return ok(null);\n      }\n      return ok(result.docs[0].data);\n    } catch (e) {\n      return err({ code: 'READ_FAILED', message: `Failed to get identity by public key: ${e}` });\n    }\n  }\n\n  async getAllIdentities(cellId: CellId): Promise<Result<CellIdentity[], StorageError>> {\n    try {\n      const result = await this.db.find({\n        selector: {\n          type: 'identity',\n          'data.cellId': cellId,\n        },\n      });\n      return ok(result.docs.map(d => d.data));\n    } catch (e) {\n      return err({ code: 'READ_FAILED', message: `Failed to get identities: ${e}` });\n    }\n  }\n\n  async deleteIdentity(id: IdentityId): Promise<Result<void, StorageError>> {\n    try {\n      const doc = await this.db.get(`identity:${id}`);\n      await this.db.remove(doc);\n      return ok(undefined);\n    } catch (e: any) {\n      if (e.status === 404) {\n        return ok(undefined);\n      }\n      return err({ code: 'DELETE_FAILED', message: `Failed to delete identity: ${e}` });\n    }\n  }\n\n  // Transaction operations\n  async saveTransaction(tx: SpotTransaction): Promise<Result<void, StorageError>> {\n    try {\n      const docId = `transaction:${tx.id}`;\n      let doc: any = {\n        _id: docId,\n        type: 'transaction',\n        data: tx,\n        createdAt: now(),\n        updatedAt: now(),\n      };\n\n      try {\n        const existing = await this.db.get(docId);\n        doc._rev = existing._rev;\n        doc.createdAt = existing.createdAt;\n      } catch (e: any) {\n        if (e.status !== 404) throw e;\n      }\n\n      await this.db.put(doc);\n      return ok(undefined);\n    } catch (e) {\n      return err({ code: 'WRITE_FAILED', message: `Failed to save transaction: ${e}` });\n    }\n  }\n\n  async getTransaction(id: TransactionId): Promise<Result<SpotTransaction | null, StorageError>> {\n    try {\n      const doc = await this.db.get(`transaction:${id}`);\n      return ok(doc.data);\n    } catch (e: any) {\n      if (e.status === 404) {\n        return ok(null);\n      }\n      return err({ code: 'READ_FAILED', message: `Failed to get transaction: ${e}` });\n    }\n  }\n\n  async getTransactionsByMember(\n    memberId: IdentityId,\n    limit: number = 100,\n    offset: number = 0\n  ): Promise<Result<SpotTransaction[], StorageError>> {\n    try {\n      // Get transactions where member is payer or payee\n      const [payerResult, payeeResult] = await Promise.all([\n        this.db.find({\n          selector: { type: 'transaction', 'data.payer': memberId },\n        }),\n        this.db.find({\n          selector: { type: 'transaction', 'data.payee': memberId },\n        }),\n      ]);\n\n      // Merge and dedupe\n      const txMap = new Map<string, SpotTransaction>();\n      for (const doc of [...payerResult.docs, ...payeeResult.docs]) {\n        txMap.set(doc.data.id, doc.data);\n      }\n\n      // Sort by createdAt descending and apply pagination\n      const transactions = Array.from(txMap.values())\n        .sort((a, b) => b.createdAt - a.createdAt)\n        .slice(offset, offset + limit);\n\n      return ok(transactions);\n    } catch (e) {\n      return err({ code: 'READ_FAILED', message: `Failed to get transactions: ${e}` });\n    }\n  }\n\n  // Offline queue operations\n  async queueTransaction(tx: QueuedTransaction): Promise<Result<void, StorageError>> {\n    try {\n      const docId = `queue:${tx.transaction.id}`;\n      await this.db.put({\n        _id: docId,\n        type: 'queue',\n        data: tx,\n        createdAt: now(),\n        updatedAt: now(),\n      });\n      return ok(undefined);\n    } catch (e) {\n      return err({ code: 'WRITE_FAILED', message: `Failed to queue transaction: ${e}` });\n    }\n  }\n\n  async getQueuedTransactions(): Promise<Result<QueuedTransaction[], StorageError>> {\n    try {\n      const result = await this.db.find({\n        selector: { type: 'queue' },\n      });\n      const queued = result.docs\n        .map(d => d.data)\n        .sort((a: QueuedTransaction, b: QueuedTransaction) => a.queuedAt - b.queuedAt);\n      return ok(queued);\n    } catch (e) {\n      return err({ code: 'READ_FAILED', message: `Failed to get queued transactions: ${e}` });\n    }\n  }\n\n  async removeFromQueue(txId: TransactionId): Promise<Result<void, StorageError>> {\n    try {\n      const doc = await this.db.get(`queue:${txId}`);\n      await this.db.remove(doc);\n      return ok(undefined);\n    } catch (e: any) {\n      if (e.status === 404) {\n        return ok(undefined);\n      }\n      return err({ code: 'DELETE_FAILED', message: `Failed to remove from queue: ${e}` });\n    }\n  }\n\n  // Event log operations\n  async appendEvent(\n    event: Omit<EventLogEntry, 'id' | 'sequenceNumber'>\n  ): Promise<Result<EventLogEntry, StorageError>> {\n    try {\n      const fullEvent: EventLogEntry = {\n        ...event,\n        id: generateId(),\n        sequenceNumber: ++this.eventSequence,\n      };\n\n      await this.db.put({\n        _id: `event:${fullEvent.id}`,\n        type: 'event',\n        data: fullEvent,\n        createdAt: now(),\n        updatedAt: now(),\n      });\n\n      return ok(fullEvent);\n    } catch (e) {\n      return err({ code: 'WRITE_FAILED', message: `Failed to append event: ${e}` });\n    }\n  }\n\n  async getEvents(cellId: CellId, since: number = 0): Promise<Result<EventLogEntry[], StorageError>> {\n    try {\n      const result = await this.db.find({\n        selector: {\n          type: 'event',\n          'data.cellId': cellId,\n          'data.sequenceNumber': { $gt: since },\n        },\n      });\n      const events = result.docs\n        .map(d => d.data)\n        .sort((a: EventLogEntry, b: EventLogEntry) => a.sequenceNumber - b.sequenceNumber);\n      return ok(events);\n    } catch (e) {\n      return err({ code: 'READ_FAILED', message: `Failed to get events: ${e}` });\n    }\n  }\n\n  // Membership change log\n  async saveMembershipChange(change: MembershipChange): Promise<Result<void, StorageError>> {\n    try {\n      const docId = `membership-change:${change.memberId}:${change.changedAt}`;\n      await this.db.put({\n        _id: docId,\n        type: 'membership-change',\n        data: change,\n        createdAt: now(),\n        updatedAt: now(),\n      });\n      return ok(undefined);\n    } catch (e) {\n      return err({ code: 'WRITE_FAILED', message: `Failed to save membership change: ${e}` });\n    }\n  }\n\n  async getMembershipChanges(memberId: IdentityId): Promise<Result<MembershipChange[], StorageError>> {\n    try {\n      const result = await this.db.find({\n        selector: {\n          type: 'membership-change',\n          'data.memberId': memberId,\n        },\n      });\n      const changes = result.docs\n        .map(d => d.data)\n        .sort((a: MembershipChange, b: MembershipChange) => a.changedAt - b.changedAt);\n      return ok(changes);\n    } catch (e) {\n      return err({ code: 'READ_FAILED', message: `Failed to get membership changes: ${e}` });\n    }\n  }\n\n  // ============================================\n  // PHASE 2: COMMITMENT OPERATIONS\n  // ============================================\n\n  async saveCommitment(commitment: Commitment): Promise<Result<void, StorageError>> {\n    try {\n      const docId = `commitment:${commitment.id}`;\n      let doc: any = {\n        _id: docId,\n        type: 'commitment',\n        data: commitment,\n        createdAt: now(),\n        updatedAt: now(),\n      };\n\n      try {\n        const existing = await this.db.get(docId);\n        doc._rev = existing._rev;\n        doc.createdAt = existing.createdAt;\n      } catch (e: any) {\n        if (e.status !== 404) throw e;\n      }\n\n      await this.db.put(doc);\n      return ok(undefined);\n    } catch (e) {\n      return err({ code: 'WRITE_FAILED', message: `Failed to save commitment: ${e}` });\n    }\n  }\n\n  async getCommitment(id: CommitmentId): Promise<Result<Commitment | null, StorageError>> {\n    try {\n      const doc = await this.db.get(`commitment:${id}`);\n      return ok(doc.data);\n    } catch (e: any) {\n      if (e.status === 404) return ok(null);\n      return err({ code: 'READ_FAILED', message: `Failed to get commitment: ${e}` });\n    }\n  }\n\n  async getCommitmentsByMember(memberId: IdentityId): Promise<Result<Commitment[], StorageError>> {\n    try {\n      const [promisorResult, promiseeResult] = await Promise.all([\n        this.db.find({ selector: { type: 'commitment', 'data.promisor': memberId } }),\n        this.db.find({ selector: { type: 'commitment', 'data.promisee': memberId } }),\n      ]);\n      const commitmentMap = new Map<string, Commitment>();\n      for (const doc of [...promisorResult.docs, ...promiseeResult.docs]) {\n        commitmentMap.set(doc.data.id, doc.data);\n      }\n      return ok(Array.from(commitmentMap.values()));\n    } catch (e) {\n      return err({ code: 'READ_FAILED', message: `Failed to get commitments: ${e}` });\n    }\n  }\n\n  async getCommitmentsByStatus(status: CommitmentStatus): Promise<Result<Commitment[], StorageError>> {\n    try {\n      const result = await this.db.find({ selector: { type: 'commitment', 'data.status': status } });\n      return ok(result.docs.map(d => d.data));\n    } catch (e) {\n      return err({ code: 'READ_FAILED', message: `Failed to get commitments by status: ${e}` });\n    }\n  }\n\n  async getCommitmentsByCategory(category: TaskCategory): Promise<Result<Commitment[], StorageError>> {\n    try {\n      const result = await this.db.find({ selector: { type: 'commitment', 'data.category': category } });\n      return ok(result.docs.map(d => d.data));\n    } catch (e) {\n      return err({ code: 'READ_FAILED', message: `Failed to get commitments by category: ${e}` });\n    }\n  }\n\n  async getAllCommitments(): Promise<Result<Commitment[], StorageError>> {\n    try {\n      const result = await this.db.find({ selector: { type: 'commitment' } });\n      return ok(result.docs.map(d => d.data));\n    } catch (e) {\n      return err({ code: 'READ_FAILED', message: `Failed to get all commitments: ${e}` });\n    }\n  }\n\n  // ============================================\n  // PHASE 2: GOVERNANCE OPERATIONS\n  // ============================================\n\n  async saveProposal(proposal: Proposal): Promise<Result<void, StorageError>> {\n    try {\n      const docId = `proposal:${proposal.id}`;\n      let doc: any = {\n        _id: docId,\n        type: 'proposal',\n        data: proposal,\n        createdAt: now(),\n        updatedAt: now(),\n      };\n\n      try {\n        const existing = await this.db.get(docId);\n        doc._rev = existing._rev;\n        doc.createdAt = existing.createdAt;\n      } catch (e: any) {\n        if (e.status !== 404) throw e;\n      }\n\n      await this.db.put(doc);\n      return ok(undefined);\n    } catch (e) {\n      return err({ code: 'WRITE_FAILED', message: `Failed to save proposal: ${e}` });\n    }\n  }\n\n  async getProposal(id: ProposalId): Promise<Result<Proposal | null, StorageError>> {\n    try {\n      const doc = await this.db.get(`proposal:${id}`);\n      return ok(doc.data);\n    } catch (e: any) {\n      if (e.status === 404) return ok(null);\n      return err({ code: 'READ_FAILED', message: `Failed to get proposal: ${e}` });\n    }\n  }\n\n  async getProposalsByStatus(status: ProposalStatus): Promise<Result<Proposal[], StorageError>> {\n    try {\n      const result = await this.db.find({ selector: { type: 'proposal', 'data.status': status } });\n      return ok(result.docs.map(d => d.data));\n    } catch (e) {\n      return err({ code: 'READ_FAILED', message: `Failed to get proposals by status: ${e}` });\n    }\n  }\n\n  async getAllProposals(): Promise<Result<Proposal[], StorageError>> {\n    try {\n      const result = await this.db.find({ selector: { type: 'proposal' } });\n      return ok(result.docs.map(d => d.data));\n    } catch (e) {\n      return err({ code: 'READ_FAILED', message: `Failed to get all proposals: ${e}` });\n    }\n  }\n\n  async saveDispute(dispute: Dispute): Promise<Result<void, StorageError>> {\n    try {\n      const docId = `dispute:${dispute.id}`;\n      let doc: any = {\n        _id: docId,\n        type: 'dispute',\n        data: dispute,\n        createdAt: now(),\n        updatedAt: now(),\n      };\n\n      try {\n        const existing = await this.db.get(docId);\n        doc._rev = existing._rev;\n        doc.createdAt = existing.createdAt;\n      } catch (e: any) {\n        if (e.status !== 404) throw e;\n      }\n\n      await this.db.put(doc);\n      return ok(undefined);\n    } catch (e) {\n      return err({ code: 'WRITE_FAILED', message: `Failed to save dispute: ${e}` });\n    }\n  }\n\n  async getDispute(id: DisputeId): Promise<Result<Dispute | null, StorageError>> {\n    try {\n      const doc = await this.db.get(`dispute:${id}`);\n      return ok(doc.data);\n    } catch (e: any) {\n      if (e.status === 404) return ok(null);\n      return err({ code: 'READ_FAILED', message: `Failed to get dispute: ${e}` });\n    }\n  }\n\n  async getDisputesByStatus(status: DisputeStatus): Promise<Result<Dispute[], StorageError>> {\n    try {\n      const result = await this.db.find({ selector: { type: 'dispute', 'data.status': status } });\n      return ok(result.docs.map(d => d.data));\n    } catch (e) {\n      return err({ code: 'READ_FAILED', message: `Failed to get disputes by status: ${e}` });\n    }\n  }\n\n  async getAllDisputes(): Promise<Result<Dispute[], StorageError>> {\n    try {\n      const result = await this.db.find({ selector: { type: 'dispute' } });\n      return ok(result.docs.map(d => d.data));\n    } catch (e) {\n      return err({ code: 'READ_FAILED', message: `Failed to get all disputes: ${e}` });\n    }\n  }\n\n  async saveCouncil(council: GovernanceCouncil): Promise<Result<void, StorageError>> {\n    try {\n      const docId = `council:${council.cellId}`;\n      let doc: any = {\n        _id: docId,\n        type: 'council',\n        data: council,\n        createdAt: now(),\n        updatedAt: now(),\n      };\n\n      try {\n        const existing = await this.db.get(docId);\n        doc._rev = existing._rev;\n        doc.createdAt = existing.createdAt;\n      } catch (e: any) {\n        if (e.status !== 404) throw e;\n      }\n\n      await this.db.put(doc);\n      return ok(undefined);\n    } catch (e) {\n      return err({ code: 'WRITE_FAILED', message: `Failed to save council: ${e}` });\n    }\n  }\n\n  async getCouncil(cellId: CellId): Promise<Result<GovernanceCouncil | null, StorageError>> {\n    try {\n      const doc = await this.db.get(`council:${cellId}`);\n      return ok(doc.data);\n    } catch (e: any) {\n      if (e.status === 404) return ok(null);\n      return err({ code: 'READ_FAILED', message: `Failed to get council: ${e}` });\n    }\n  }\n\n  // ============================================\n  // PHASE 2: SCHEDULER OPERATIONS\n  // ============================================\n\n  async saveTaskSlot(slot: TaskSlot): Promise<Result<void, StorageError>> {\n    try {\n      const docId = `taskslot:${slot.id}`;\n      let doc: any = {\n        _id: docId,\n        type: 'taskslot',\n        data: slot,\n        createdAt: now(),\n        updatedAt: now(),\n      };\n\n      try {\n        const existing = await this.db.get(docId);\n        doc._rev = existing._rev;\n        doc.createdAt = existing.createdAt;\n      } catch (e: any) {\n        if (e.status !== 404) throw e;\n      }\n\n      await this.db.put(doc);\n      return ok(undefined);\n    } catch (e) {\n      return err({ code: 'WRITE_FAILED', message: `Failed to save task slot: ${e}` });\n    }\n  }\n\n  async getTaskSlot(id: TaskSlotId): Promise<Result<TaskSlot | null, StorageError>> {\n    try {\n      const doc = await this.db.get(`taskslot:${id}`);\n      return ok(doc.data);\n    } catch (e: any) {\n      if (e.status === 404) return ok(null);\n      return err({ code: 'READ_FAILED', message: `Failed to get task slot: ${e}` });\n    }\n  }\n\n  async getTaskSlotsByPeriod(start: Timestamp, end: Timestamp): Promise<Result<TaskSlot[], StorageError>> {\n    try {\n      const result = await this.db.find({\n        selector: {\n          type: 'taskslot',\n          'data.startTime': { $gte: start, $lt: end },\n        },\n      });\n      const slots = result.docs\n        .map(d => d.data)\n        .sort((a: TaskSlot, b: TaskSlot) => a.startTime - b.startTime);\n      return ok(slots);\n    } catch (e) {\n      return err({ code: 'READ_FAILED', message: `Failed to get task slots by period: ${e}` });\n    }\n  }\n\n  async getTaskSlotsByStatus(status: TaskSlotStatus): Promise<Result<TaskSlot[], StorageError>> {\n    try {\n      const result = await this.db.find({ selector: { type: 'taskslot', 'data.status': status } });\n      return ok(result.docs.map(d => d.data));\n    } catch (e) {\n      return err({ code: 'READ_FAILED', message: `Failed to get task slots by status: ${e}` });\n    }\n  }\n\n  async getAllTaskSlots(): Promise<Result<TaskSlot[], StorageError>> {\n    try {\n      const result = await this.db.find({ selector: { type: 'taskslot' } });\n      return ok(result.docs.map(d => d.data));\n    } catch (e) {\n      return err({ code: 'READ_FAILED', message: `Failed to get all task slots: ${e}` });\n    }\n  }\n\n  async saveTaskTemplate(template: TaskTemplate): Promise<Result<void, StorageError>> {\n    try {\n      const docId = `tasktemplate:${template.id}`;\n      let doc: any = {\n        _id: docId,\n        type: 'tasktemplate',\n        data: template,\n        createdAt: now(),\n        updatedAt: now(),\n      };\n\n      try {\n        const existing = await this.db.get(docId);\n        doc._rev = existing._rev;\n        doc.createdAt = existing.createdAt;\n      } catch (e: any) {\n        if (e.status !== 404) throw e;\n      }\n\n      await this.db.put(doc);\n      return ok(undefined);\n    } catch (e) {\n      return err({ code: 'WRITE_FAILED', message: `Failed to save task template: ${e}` });\n    }\n  }\n\n  async getTaskTemplate(id: TaskTemplateId): Promise<Result<TaskTemplate | null, StorageError>> {\n    try {\n      const doc = await this.db.get(`tasktemplate:${id}`);\n      return ok(doc.data);\n    } catch (e: any) {\n      if (e.status === 404) return ok(null);\n      return err({ code: 'READ_FAILED', message: `Failed to get task template: ${e}` });\n    }\n  }\n\n  async getAllTaskTemplates(): Promise<Result<TaskTemplate[], StorageError>> {\n    try {\n      const result = await this.db.find({ selector: { type: 'tasktemplate' } });\n      return ok(result.docs.map(d => d.data));\n    } catch (e) {\n      return err({ code: 'READ_FAILED', message: `Failed to get all task templates: ${e}` });\n    }\n  }\n\n  async saveMemberSupply(supply: MemberSupply): Promise<Result<void, StorageError>> {\n    try {\n      const docId = `membersupply:${supply.memberId}`;\n\n      // Convert Map to object for storage\n      const skillsObj: Record<string, number> = {};\n      supply.skills.forEach((v, k) => {\n        skillsObj[k] = v;\n      });\n\n      let doc: any = {\n        _id: docId,\n        type: 'membersupply',\n        data: {\n          ...supply,\n          skills: skillsObj,\n        },\n        createdAt: now(),\n        updatedAt: now(),\n      };\n\n      try {\n        const existing = await this.db.get(docId);\n        doc._rev = existing._rev;\n        doc.createdAt = existing.createdAt;\n      } catch (e: any) {\n        if (e.status !== 404) throw e;\n      }\n\n      await this.db.put(doc);\n      return ok(undefined);\n    } catch (e) {\n      return err({ code: 'WRITE_FAILED', message: `Failed to save member supply: ${e}` });\n    }\n  }\n\n  async getMemberSupply(memberId: IdentityId): Promise<Result<MemberSupply | null, StorageError>> {\n    try {\n      const doc = await this.db.get(`membersupply:${memberId}`);\n      // Convert skills object back to Map\n      const skills = new Map<TaskCategory, number>();\n      const skillsObj = doc.data.skills as Record<string, number>;\n      for (const [k, v] of Object.entries(skillsObj)) {\n        skills.set(k as TaskCategory, v);\n      }\n      return ok({\n        ...doc.data,\n        skills,\n      });\n    } catch (e: any) {\n      if (e.status === 404) return ok(null);\n      return err({ code: 'READ_FAILED', message: `Failed to get member supply: ${e}` });\n    }\n  }\n\n  async getAllMemberSupplies(): Promise<Result<MemberSupply[], StorageError>> {\n    try {\n      const result = await this.db.find({ selector: { type: 'membersupply' } });\n      return ok(result.docs.map(d => {\n        // Convert skills object back to Map\n        const skills = new Map<TaskCategory, number>();\n        const skillsObj = d.data.skills as Record<string, number>;\n        for (const [k, v] of Object.entries(skillsObj)) {\n          skills.set(k as TaskCategory, v);\n        }\n        return {\n          ...d.data,\n          skills,\n        };\n      }));\n    } catch (e) {\n      return err({ code: 'READ_FAILED', message: `Failed to get all member supplies: ${e}` });\n    }\n  }\n\n  // ============================================\n  // PHASE 3: EMERGENCY OPERATIONS\n  // ============================================\n\n  async saveEmergencyState(state: EmergencyState): Promise<Result<void, StorageError>> {\n    try {\n      const docId = `emergency:${state.cellId}`;\n      let doc: any = {\n        _id: docId,\n        type: 'emergency',\n        data: state,\n        createdAt: now(),\n        updatedAt: now(),\n      };\n\n      try {\n        const existing = await this.db.get(docId);\n        doc._rev = existing._rev;\n        doc.createdAt = existing.createdAt;\n      } catch (e: any) {\n        if (e.status !== 404) throw e;\n      }\n\n      await this.db.put(doc);\n      return ok(undefined);\n    } catch (e) {\n      return err({ code: 'WRITE_FAILED', message: `Failed to save emergency state: ${e}` });\n    }\n  }\n\n  async getEmergencyState(cellId: CellId): Promise<Result<EmergencyState | null, StorageError>> {\n    try {\n      const doc = await this.db.get(`emergency:${cellId}`);\n      return ok(doc.data);\n    } catch (e: any) {\n      if (e.status === 404) return ok(null);\n      return err({ code: 'READ_FAILED', message: `Failed to get emergency state: ${e}` });\n    }\n  }\n\n  async appendStateHistoryEntry(entry: StateHistoryEntry, cellId: CellId): Promise<Result<void, StorageError>> {\n    try {\n      const docId = `statehistory:${cellId}:${entry.timestamp}`;\n      await this.db.put({\n        _id: docId,\n        type: 'statehistory',\n        data: { ...entry, cellId },\n        createdAt: now(),\n        updatedAt: now(),\n      });\n      return ok(undefined);\n    } catch (e) {\n      return err({ code: 'WRITE_FAILED', message: `Failed to append state history: ${e}` });\n    }\n  }\n\n  async getStateHistory(cellId: CellId, since: Timestamp): Promise<Result<StateHistoryEntry[], StorageError>> {\n    try {\n      const result = await this.db.find({\n        selector: {\n          type: 'statehistory',\n          'data.cellId': cellId,\n          'data.timestamp': { $gte: since },\n        },\n      });\n      const history = result.docs\n        .map(d => d.data as StateHistoryEntry)\n        .sort((a, b) => a.timestamp - b.timestamp);\n      return ok(history);\n    } catch (e) {\n      return err({ code: 'READ_FAILED', message: `Failed to get state history: ${e}` });\n    }\n  }\n\n  // ============================================\n  // PHASE 3: FEDERATION OPERATIONS\n  // ============================================\n\n  async saveFederationState(state: FederationState): Promise<Result<void, StorageError>> {\n    try {\n      const docId = `federation:${state.cellId}`;\n      let doc: any = {\n        _id: docId,\n        type: 'federation',\n        data: state,\n        createdAt: now(),\n        updatedAt: now(),\n      };\n\n      try {\n        const existing = await this.db.get(docId);\n        doc._rev = existing._rev;\n        doc.createdAt = existing.createdAt;\n      } catch (e: any) {\n        if (e.status !== 404) throw e;\n      }\n\n      await this.db.put(doc);\n      return ok(undefined);\n    } catch (e) {\n      return err({ code: 'WRITE_FAILED', message: `Failed to save federation state: ${e}` });\n    }\n  }\n\n  async getFederationState(cellId: CellId): Promise<Result<FederationState | null, StorageError>> {\n    try {\n      const doc = await this.db.get(`federation:${cellId}`);\n      return ok(doc.data);\n    } catch (e: any) {\n      if (e.status === 404) return ok(null);\n      return err({ code: 'READ_FAILED', message: `Failed to get federation state: ${e}` });\n    }\n  }\n\n  async saveFederationTransaction(tx: FederationTransaction): Promise<Result<void, StorageError>> {\n    try {\n      const docId = `fedtx:${tx.id}`;\n      let doc: any = {\n        _id: docId,\n        type: 'fedtx',\n        data: tx,\n        createdAt: now(),\n        updatedAt: now(),\n      };\n\n      try {\n        const existing = await this.db.get(docId);\n        doc._rev = existing._rev;\n        doc.createdAt = existing.createdAt;\n      } catch (e: any) {\n        if (e.status !== 404) throw e;\n      }\n\n      await this.db.put(doc);\n      return ok(undefined);\n    } catch (e) {\n      return err({ code: 'WRITE_FAILED', message: `Failed to save federation transaction: ${e}` });\n    }\n  }\n\n  async getFederationTransaction(id: FederationTxId): Promise<Result<FederationTransaction | null, StorageError>> {\n    try {\n      const doc = await this.db.get(`fedtx:${id}`);\n      return ok(doc.data);\n    } catch (e: any) {\n      if (e.status === 404) return ok(null);\n      return err({ code: 'READ_FAILED', message: `Failed to get federation transaction: ${e}` });\n    }\n  }\n\n  async getFederationTransactions(filter: {\n    cellId?: CellId;\n    remoteCellId?: CellId;\n    status?: FederationTxStatus;\n    since?: Timestamp;\n  }): Promise<Result<FederationTransaction[], StorageError>> {\n    try {\n      const selector: any = { type: 'fedtx' };\n\n      if (filter.status) {\n        selector['data.status'] = filter.status;\n      }\n      if (filter.since) {\n        selector['data.createdAt'] = { $gte: filter.since };\n      }\n\n      const result = await this.db.find({ selector });\n\n      let transactions = result.docs.map(d => d.data as FederationTransaction);\n\n      // Apply cellId filter (need to check both source and target)\n      if (filter.cellId) {\n        transactions = transactions.filter(t =>\n          t.sourceCell === filter.cellId || t.targetCell === filter.cellId\n        );\n      }\n\n      // Apply remoteCellId filter\n      if (filter.remoteCellId) {\n        transactions = transactions.filter(t =>\n          t.sourceCell === filter.remoteCellId || t.targetCell === filter.remoteCellId\n        );\n      }\n\n      return ok(transactions.sort((a, b) => b.createdAt - a.createdAt));\n    } catch (e) {\n      return err({ code: 'READ_FAILED', message: `Failed to get federation transactions: ${e}` });\n    }\n  }\n\n  async saveLinkProposal(proposal: LinkProposal): Promise<Result<void, StorageError>> {\n    try {\n      const docId = `linkproposal:${proposal.id}`;\n      let doc: any = {\n        _id: docId,\n        type: 'linkproposal',\n        data: proposal,\n        createdAt: now(),\n        updatedAt: now(),\n      };\n\n      try {\n        const existing = await this.db.get(docId);\n        doc._rev = existing._rev;\n        doc.createdAt = existing.createdAt;\n      } catch (e: any) {\n        if (e.status !== 404) throw e;\n      }\n\n      await this.db.put(doc);\n      return ok(undefined);\n    } catch (e) {\n      return err({ code: 'WRITE_FAILED', message: `Failed to save link proposal: ${e}` });\n    }\n  }\n\n  async getLinkProposal(id: LinkProposalId): Promise<Result<LinkProposal | null, StorageError>> {\n    try {\n      const doc = await this.db.get(`linkproposal:${id}`);\n      return ok(doc.data);\n    } catch (e: any) {\n      if (e.status === 404) return ok(null);\n      return err({ code: 'READ_FAILED', message: `Failed to get link proposal: ${e}` });\n    }\n  }\n\n  // ============================================\n  // PHASE 4: ENERGY OPERATIONS\n  // ============================================\n\n  async saveEnergyState(state: EnergyState): Promise<Result<void, StorageError>> {\n    try {\n      const docId = `energy:${state.cellId}`;\n\n      // Convert Maps to objects for storage\n      const stocksObj: Record<string, any> = {};\n      state.stocks.forEach((v, k) => {\n        stocksObj[k] = v;\n      });\n\n      const selectedModesObj: Record<string, string> = {};\n      state.selectedModes.forEach((v, k) => {\n        selectedModesObj[k] = v;\n      });\n\n      const taskProfilesData = state.taskProfiles.map(p => ({\n        ...p,\n        energyModes: p.energyModes.map(m => ({\n          ...m,\n          energyPerHour: Object.fromEntries(m.energyPerHour),\n        })),\n      }));\n\n      let doc: any = {\n        _id: docId,\n        type: 'energy',\n        data: {\n          ...state,\n          stocks: stocksObj,\n          selectedModes: selectedModesObj,\n          taskProfiles: taskProfilesData,\n        },\n        createdAt: now(),\n        updatedAt: now(),\n      };\n\n      try {\n        const existing = await this.db.get(docId);\n        doc._rev = existing._rev;\n        doc.createdAt = existing.createdAt;\n      } catch (e: any) {\n        if (e.status !== 404) throw e;\n      }\n\n      await this.db.put(doc);\n      return ok(undefined);\n    } catch (e) {\n      return err({ code: 'WRITE_FAILED', message: `Failed to save energy state: ${e}` });\n    }\n  }\n\n  async getEnergyState(cellId: CellId): Promise<Result<EnergyState | null, StorageError>> {\n    try {\n      const doc = await this.db.get(`energy:${cellId}`);\n\n      // Convert objects back to Maps\n      const stocks = new Map();\n      const stocksObj = doc.data.stocks as Record<string, any>;\n      for (const [k, v] of Object.entries(stocksObj)) {\n        stocks.set(k, v);\n      }\n\n      const selectedModes = new Map();\n      const selectedModesObj = doc.data.selectedModes as Record<string, string>;\n      for (const [k, v] of Object.entries(selectedModesObj)) {\n        selectedModes.set(k, v);\n      }\n\n      const taskProfiles = doc.data.taskProfiles.map((p: any) => ({\n        ...p,\n        energyModes: p.energyModes.map((m: any) => ({\n          ...m,\n          energyPerHour: new Map(Object.entries(m.energyPerHour)),\n        })),\n      }));\n\n      return ok({\n        ...doc.data,\n        stocks,\n        selectedModes,\n        taskProfiles,\n      });\n    } catch (e: any) {\n      if (e.status === 404) return ok(null);\n      return err({ code: 'READ_FAILED', message: `Failed to get energy state: ${e}` });\n    }\n  }\n\n  async saveStockChange(change: StockChangeRecord): Promise<Result<void, StorageError>> {\n    try {\n      const docId = `stockchange:${change.id}`;\n      await this.db.put({\n        _id: docId,\n        type: 'stockchange',\n        data: change,\n        createdAt: now(),\n        updatedAt: now(),\n      });\n      return ok(undefined);\n    } catch (e) {\n      return err({ code: 'WRITE_FAILED', message: `Failed to save stock change: ${e}` });\n    }\n  }\n\n  async getStockChanges(cellId: CellId, since: Timestamp): Promise<Result<StockChangeRecord[], StorageError>> {\n    try {\n      const result = await this.db.find({\n        selector: {\n          type: 'stockchange',\n          'data.cellId': cellId,\n          'data.timestamp': { $gte: since },\n        },\n      });\n      const changes = result.docs\n        .map((d: any) => d.data as StockChangeRecord)\n        .sort((a, b) => a.timestamp - b.timestamp);\n      return ok(changes);\n    } catch (e) {\n      return err({ code: 'READ_FAILED', message: `Failed to get stock changes: ${e}` });\n    }\n  }\n\n  async saveConsumptionRecord(record: ConsumptionRecord): Promise<Result<void, StorageError>> {\n    try {\n      const docId = `consumption:${record.id}`;\n      await this.db.put({\n        _id: docId,\n        type: 'consumption',\n        data: record,\n        createdAt: now(),\n        updatedAt: now(),\n      });\n      return ok(undefined);\n    } catch (e) {\n      return err({ code: 'WRITE_FAILED', message: `Failed to save consumption record: ${e}` });\n    }\n  }\n\n  async getConsumptionHistory(cellId: CellId, since: Timestamp): Promise<Result<ConsumptionRecord[], StorageError>> {\n    try {\n      const result = await this.db.find({\n        selector: {\n          type: 'consumption',\n          'data.cellId': cellId,\n          'data.timestamp': { $gte: since },\n        },\n      });\n      const records = result.docs\n        .map((d: any) => d.data as ConsumptionRecord)\n        .sort((a, b) => a.timestamp - b.timestamp);\n      return ok(records);\n    } catch (e) {\n      return err({ code: 'READ_FAILED', message: `Failed to get consumption history: ${e}` });\n    }\n  }\n\n  async saveEnergyPlan(plan: WeeklyEnergyPlan): Promise<Result<void, StorageError>> {\n    try {\n      const docId = `energyplan:${plan.cellId}:${plan.weekStart}`;\n\n      // Convert Maps to objects\n      const projectedConsumptionObj = Object.fromEntries(plan.projectedConsumption);\n      const requiredByCarrierObj = Object.fromEntries(plan.requiredByCarrier);\n      const availableByCarrierObj = Object.fromEntries(plan.availableByCarrier);\n      const selectedModesObj = Object.fromEntries(plan.selectedModes);\n      const bundlesData = plan.bundles.map(b => ({\n        ...b,\n        energyAllocation: Object.fromEntries(b.energyAllocation),\n      }));\n\n      let doc: any = {\n        _id: docId,\n        type: 'energyplan',\n        data: {\n          ...plan,\n          projectedConsumption: projectedConsumptionObj,\n          requiredByCarrier: requiredByCarrierObj,\n          availableByCarrier: availableByCarrierObj,\n          selectedModes: selectedModesObj,\n          bundles: bundlesData,\n        },\n        createdAt: now(),\n        updatedAt: now(),\n      };\n\n      try {\n        const existing = await this.db.get(docId);\n        doc._rev = existing._rev;\n        doc.createdAt = existing.createdAt;\n      } catch (e: any) {\n        if (e.status !== 404) throw e;\n      }\n\n      await this.db.put(doc);\n      return ok(undefined);\n    } catch (e) {\n      return err({ code: 'WRITE_FAILED', message: `Failed to save energy plan: ${e}` });\n    }\n  }\n\n  async getEnergyPlan(cellId: CellId, weekStart: Timestamp): Promise<Result<WeeklyEnergyPlan | null, StorageError>> {\n    try {\n      const doc = await this.db.get(`energyplan:${cellId}:${weekStart}`);\n\n      // Convert objects back to Maps\n      const projectedConsumption = new Map(Object.entries(doc.data.projectedConsumption));\n      const requiredByCarrier = new Map(Object.entries(doc.data.requiredByCarrier));\n      const availableByCarrier = new Map(Object.entries(doc.data.availableByCarrier));\n      const selectedModes = new Map(Object.entries(doc.data.selectedModes));\n      const bundles = doc.data.bundles.map((b: any) => ({\n        ...b,\n        energyAllocation: new Map(Object.entries(b.energyAllocation)),\n      }));\n\n      return ok({\n        ...doc.data,\n        projectedConsumption,\n        requiredByCarrier,\n        availableByCarrier,\n        selectedModes,\n        bundles,\n      });\n    } catch (e: any) {\n      if (e.status === 404) return ok(null);\n      return err({ code: 'READ_FAILED', message: `Failed to get energy plan: ${e}` });\n    }\n  }\n}\n\n// ============================================\n// FACTORY\n// ============================================\n\n/** Create an in-memory storage instance (for testing) */\nexport function createInMemoryStorage(): InMemoryStorage {\n  return new InMemoryStorage();\n}\n\n/** Create a PouchDB storage instance (for production) */\nexport function createPouchDBStorage(db: PouchDBLike): PouchDBStorage {\n  return new PouchDBStorage(db);\n}\n", "/**\n * Cell Protocol - Public API\n *\n * Phase 1: Core Protocol MVP\n * - Core Ledger Engine (PRD-01)\n * - Transaction System (PRD-02)\n * - Identity & Membership Basic (PRD-04)\n *\n * Phase 2: Coordination Layer\n * - Commitment System (PRD-03)\n * - Governance System (PRD-05)\n * - Survival Scheduler Basic (PRD-08)\n *\n * Phase 3: Resilience Layer\n * - Emergency Mode System (PRD-07)\n * - Federation Network (PRD-06)\n *\n * Phase 4: Resource Management\n * - Energy Resource Layer (PRD-09)\n * - Survival Scheduler Full (PRD-08)\n */\n\n// ============================================\n// TYPE EXPORTS\n// ============================================\n\n// Common types\nexport {\n  IdentityId,\n  CellId,\n  TransactionId,\n  Timestamp,\n  Units,\n  PublicKey,\n  Signature,\n  SecretKey,\n  BalanceChangeReason,\n  MembershipStatus,\n  EventMeta,\n  AuditEntry,\n  generateId,\n  now,\n} from './types/common';\n\n// Ledger types\nexport {\n  MemberState,\n  MemberComputedState,\n  LedgerParameters,\n  CellLedgerState,\n  BalanceUpdate,\n  ReserveUpdate,\n  BalanceUpdateResult,\n  LedgerError,\n  LedgerErrorCode,\n  LedgerStatistics,\n  ILedgerEngine,\n} from './types/ledger';\n\n// Transaction types\nexport {\n  TransactionType,\n  TransactionStatus,\n  SpotTransaction,\n  TransactionSignatures,\n  CreateSpotTransactionInput,\n  TransactionSigningData,\n  TransactionResult,\n  TransactionError,\n  TransactionErrorCode,\n  QueuedTransaction,\n  ITransactionEngine,\n} from './types/transaction';\n\n// Identity types\nexport {\n  CellIdentity,\n  AdmissionInfo,\n  AdmissionResult,\n  AdmissionResultExtended,\n  MembershipChange,\n  IdentityError,\n  IdentityErrorCode,\n  MemberSearchCriteria,\n  MemberSearchResult,\n  IIdentityEngine,\n} from './types/identity';\n\n// ============================================\n// PHASE 2 TYPE EXPORTS\n// ============================================\n\n// Commitment types\nexport {\n  CommitmentId,\n  CommitmentType,\n  CommitmentStatus,\n  TaskCategory,\n  Commitment,\n  FulfillmentConfirmation,\n  CreateCommitmentInput,\n  CommitmentError,\n  CommitmentErrorCode,\n  MemberCommitmentStats,\n  CategoryFulfillmentStats,\n  ICommitmentEngine,\n} from './types/commitment';\n\n// Governance types\nexport {\n  ProposalId,\n  DisputeId,\n  ProposalType,\n  ProposalStatus,\n  ActionCategory,\n  DisputeType,\n  DisputeStatus,\n  VoteDecision,\n  GovernanceCouncil,\n  CouncilMember,\n  QuorumRules,\n  TermPolicy,\n  Proposal,\n  ProposalPayload,\n  Vote,\n  Evidence,\n  DisputeResolution,\n  DisputeAction,\n  Dispute,\n  CreateProposalInput,\n  FileDisputeInput,\n  GovernanceError,\n  GovernanceErrorCode,\n  IGovernanceEngine,\n} from './types/governance';\n\n// Scheduler types\nexport {\n  TaskSlotId,\n  TaskTemplateId,\n  TaskSlotStatus,\n  AssignmentStatus,\n  TaskSlot,\n  TaskTemplate,\n  TaskAssignment,\n  MemberSupply,\n  FeasibilityResult,\n  MatchingResult,\n  CoverageReport,\n  CategoryCoverage,\n  CreateSlotInput,\n  CreateTemplateInput,\n  SchedulerError,\n  SchedulerErrorCode,\n  ISchedulerEngine,\n  TaskCategoryDefinition,\n} from './types/scheduler';\n\n// ============================================\n// PHASE 4 TYPE EXPORTS\n// ============================================\n\n// Energy types\nexport {\n  EnergyCarrierId,\n  EnergyCategory,\n  EnergyCarrier,\n  EnergyStock,\n  EnergySource,\n  EnergyConsumer,\n  EnergyFlow,\n  EnergyMode,\n  TaskEnergyProfile,\n  RationingPlan,\n  MemberBundle,\n  StockChangeRecord,\n  StockChangeReason,\n  ConsumptionRecord,\n  WeeklyEnergyPlan,\n  StressProjection,\n  ProcurementAlert,\n  EnergyState,\n  EnergyError,\n  EnergyErrorCode,\n  IEnergyEngine,\n  DEFAULT_CARRIERS,\n  DEFAULT_TASK_PROFILES,\n  HUMANITARIAN_FLOOR,\n  VULNERABILITY_BONUS,\n} from './types/energy';\n\n// ============================================\n// PHASE 3 TYPE EXPORTS\n// ============================================\n\n// Emergency types\nexport {\n  RiskState,\n  AdmissionMode,\n  CommitmentMode,\n  SchedulerPriority,\n  StressIndicators,\n  EmergencyPolicy,\n  TransitionThresholds,\n  TransitionReason,\n  StateTransitionResult,\n  StateHistoryEntry,\n  ThresholdProximityReport,\n  EmergencyState,\n  EmergencyError,\n  EmergencyErrorCode,\n  IEmergencyEngine,\n  DEFAULT_POLICIES,\n  DEFAULT_THRESHOLDS,\n} from './types/emergency';\n\n// Federation types\nexport {\n  FederationTxId,\n  LinkProposalId,\n  FederationStatus,\n  LinkStatus,\n  FederationTxStatus,\n  QuarantineReason,\n  FederationLink,\n  LinkProposal,\n  FederationTerms,\n  FederationState,\n  FederationTransaction,\n  CreateFederationTxInput,\n  FederationTxResult,\n  QuarantineStatus,\n  FederationParameters,\n  ExposureAnalysis,\n  FederationError,\n  FederationErrorCode,\n  IFederationEngine,\n  DEFAULT_FEDERATION_TERMS,\n  DEFAULT_FEDERATION_PARAMETERS,\n  generateFederationTxId,\n  generateLinkProposalId,\n} from './types/federation';\n\n// ============================================\n// RESULT TYPE EXPORTS\n// ============================================\n\nexport {\n  Result,\n  Ok,\n  Err,\n  ok,\n  err,\n  isOk,\n  isErr,\n  unwrap,\n  unwrapOr,\n  map,\n  mapErr,\n  andThen,\n  all,\n  tryCatch,\n  tryCatchAsync,\n} from './utils/result';\n\n// ============================================\n// ENGINE EXPORTS\n// ============================================\n\nexport {\n  LedgerEngine,\n  LedgerViolationError,\n  createLedgerEngine,\n} from './engines/ledger-engine';\n\nexport {\n  TransactionEngine,\n  TransactionValidationError,\n  createTransactionEngine,\n} from './engines/transaction-engine';\n\nexport {\n  IdentityEngine,\n  IdentityValidationError,\n  createIdentityEngine,\n  SybilResistanceEngines,\n} from './engines/identity-engine';\n\n// ============================================\n// PHASE 2 ENGINE EXPORTS\n// ============================================\n\nexport {\n  CommitmentEngine,\n  CommitmentValidationError,\n  createCommitmentEngine,\n} from './engines/commitment-engine';\n\nexport {\n  GovernanceEngine,\n  GovernanceValidationError,\n  createGovernanceEngine,\n} from './engines/governance-engine';\n\nexport {\n  SchedulerEngine,\n  SchedulerValidationError,\n  createSchedulerEngine,\n} from './engines/scheduler-engine';\n\n// ============================================\n// PHASE 3 ENGINE EXPORTS\n// ============================================\n\nexport {\n  EmergencyEngine,\n  EmergencyValidationError,\n  createEmergencyEngine,\n} from './engines/emergency-engine';\n\nexport {\n  FederationEngine,\n  FederationValidationError,\n  createFederationEngine,\n} from './engines/federation-engine';\n\n// ============================================\n// PHASE 4 ENGINE EXPORTS\n// ============================================\n\nexport {\n  EnergyEngine,\n  EnergyValidationError,\n  createEnergyEngine,\n  createEnergyEngineWithScheduler,\n} from './engines/energy-engine';\n\n// ============================================\n// STORAGE EXPORTS\n// ============================================\n\nexport {\n  IStorage,\n  StorageError,\n  StorageDocument,\n  EventLogEntry,\n  InMemoryStorage,\n  PouchDBStorage,\n  createInMemoryStorage,\n  createPouchDBStorage,\n} from './storage/pouchdb-adapter';\n\n// ============================================\n// CRYPTO EXPORTS\n// ============================================\n\nexport {\n  CryptoAdapter,\n  KeyPair,\n  CryptoError,\n  cryptoAdapter,\n  encodeBase64,\n  decodeBase64,\n  encodeHex,\n  decodeHex,\n  createTransactionSigningData,\n  signTransaction,\n  verifyTransactionSignature,\n} from './crypto/crypto-adapter';\n\n// ============================================\n// CELL PROTOCOL FACTORY\n// ============================================\n\nimport { CellId, IdentityId } from './types/common';\nimport { LedgerParameters } from './types/ledger';\nimport { TransitionThresholds } from './types/emergency';\nimport { FederationParameters } from './types/federation';\nimport { EnergyCarrier, TaskEnergyProfile } from './types/energy';\nimport { LedgerEngine, createLedgerEngine } from './engines/ledger-engine';\nimport { TransactionEngine, createTransactionEngine } from './engines/transaction-engine';\nimport { IdentityEngine, createIdentityEngine } from './engines/identity-engine';\nimport { CommitmentEngine, createCommitmentEngine } from './engines/commitment-engine';\nimport { GovernanceEngine, createGovernanceEngine } from './engines/governance-engine';\nimport { SchedulerEngine, createSchedulerEngine } from './engines/scheduler-engine';\nimport { EmergencyEngine, createEmergencyEngine } from './engines/emergency-engine';\nimport { FederationEngine, createFederationEngine } from './engines/federation-engine';\nimport { EnergyEngine, createEnergyEngine } from './engines/energy-engine';\nimport { IStorage, createInMemoryStorage } from './storage/pouchdb-adapter';\nimport { CryptoAdapter, cryptoAdapter } from './crypto/crypto-adapter';\n\n/**\n * Complete Cell Protocol instance\n */\nexport interface CellProtocol {\n  cellId: CellId;\n  ledger: LedgerEngine;\n  transactions: TransactionEngine;\n  identity: IdentityEngine;\n  commitments: CommitmentEngine;      // Phase 2\n  governance: GovernanceEngine;        // Phase 2\n  scheduler: SchedulerEngine;          // Phase 2\n  emergency: EmergencyEngine;          // Phase 3\n  federation?: FederationEngine;       // Phase 3 (optional)\n  energy?: EnergyEngine;               // Phase 4 (optional)\n  storage: IStorage;\n  crypto: CryptoAdapter;\n}\n\n/**\n * Options for creating a Cell Protocol instance\n */\nexport interface CellProtocolOptions {\n  cellId: CellId;\n  ledgerParameters?: Partial<LedgerParameters>;\n  storage?: IStorage;\n  crypto?: CryptoAdapter;\n  // Phase 3 options\n  enableFederation?: boolean;\n  federationParameters?: Partial<FederationParameters>;\n  emergencyThresholds?: Partial<TransitionThresholds>;\n  // Phase 4 options\n  enableEnergy?: boolean;\n  energyCarriers?: EnergyCarrier[];\n  energyTaskProfiles?: TaskEnergyProfile[];\n}\n\n/**\n * Create a complete Cell Protocol instance\n */\nexport async function createCellProtocol(options: CellProtocolOptions): Promise<CellProtocol> {\n  const { cellId, ledgerParameters = {} } = options;\n\n  // Use provided storage or create in-memory storage\n  const storage = options.storage ?? createInMemoryStorage();\n\n  // Use provided crypto adapter or the default singleton\n  const crypto = options.crypto ?? cryptoAdapter;\n\n  // Initialize crypto if needed\n  if (!crypto.isInitialized()) {\n    const initResult = await crypto.initialize();\n    if (!initResult.ok) {\n      throw new Error(`Failed to initialize crypto: ${initResult.error.message}`);\n    }\n  }\n\n  // Create ledger engine\n  const ledger = await createLedgerEngine(cellId, ledgerParameters, storage);\n\n  // Create identity engine\n  const identity = createIdentityEngine(ledger, storage, crypto);\n\n  // Create transaction engine with public key resolver\n  const publicKeyResolver = async (memberId: IdentityId): Promise<string | undefined> => {\n    const memberIdentity = await identity.getIdentity(memberId);\n    return memberIdentity?.publicKey;\n  };\n\n  const transactions = createTransactionEngine(ledger, storage, crypto, publicKeyResolver);\n\n  // Phase 2: Create coordination layer engines\n  const commitments = createCommitmentEngine(ledger, transactions, storage);\n  const governance = createGovernanceEngine(cellId, ledger, identity, commitments, storage);\n  const scheduler = createSchedulerEngine(ledger, commitments, storage);\n\n  // Phase 3: Create resilience layer engines\n  const emergency = createEmergencyEngine(cellId, ledger, storage, options.emergencyThresholds);\n\n  // Wire up circular dependencies\n  emergency.setGovernanceEngine(governance);\n  emergency.setIdentityEngine(identity);\n\n  // Create federation if enabled\n  let federation: FederationEngine | undefined;\n  if (options.enableFederation) {\n    federation = await createFederationEngine(cellId, ledger, storage, options.federationParameters);\n    federation.setEmergencyEngine(emergency);\n  }\n\n  // Phase 4: Create energy engine if enabled\n  let energy: EnergyEngine | undefined;\n  if (options.enableEnergy) {\n    energy = createEnergyEngine(\n      cellId,\n      ledger,\n      storage,\n      options.energyCarriers,\n      options.energyTaskProfiles\n    );\n    energy.setSchedulerEngine(scheduler);\n    scheduler.setEnergyEngine(energy);\n    emergency.setEnergyEngine(energy);\n    await energy.loadState();\n  }\n\n  return {\n    cellId,\n    ledger,\n    transactions,\n    identity,\n    commitments,\n    governance,\n    scheduler,\n    emergency,\n    federation,\n    energy,\n    storage,\n    crypto,\n  };\n}\n\n// ============================================\n// PHASE 5 HARDENING EXPORTS\n// ============================================\n\n// Re-export all hardening components\nexport * from './hardening';\n\n// ============================================\n// VERSION\n// ============================================\n\nexport const VERSION = '0.1.0';\nexport const PROTOCOL_VERSION = 1;\n"],
  "mappings": "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",
  "names": ["require_nacl_fast", "__commonJSMin", "exports", "module", "nacl", "gf", "init", "i", "r", "randombytes", "_0", "_9", "gf0", "gf1", "_121665", "D", "D2", "X", "Y", "I", "ts64", "x", "h", "l", "vn", "xi", "y", "yi", "n", "d", "crypto_verify_16", "crypto_verify_32", "core_salsa20", "o", "p", "k", "c", "j0", "j1", "j2", "j3", "j4", "j5", "j6", "j7", "j8", "j9", "j10", "j11", "j12", "j13", "j14", "j15", "x0", "x1", "x2", "x3", "x4", "x5", "x6", "x7", "x8", "x9", "x10", "x11", "x12", "x13", "x14", "x15", "u", "core_hsalsa20", "crypto_core_salsa20", "out", "inp", "crypto_core_hsalsa20", "sigma", "crypto_stream_salsa20_xor", "cpos", "m", "mpos", "b", "z", "crypto_stream_salsa20", "crypto_stream", "s", "sn", "crypto_stream_xor", "poly1305", "key", "t0", "t1", "t2", "t3", "t4", "t5", "t6", "t7", "bytes", "hibit", "d0", "d1", "d2", "d3", "d4", "d5", "d6", "d7", "d8", "d9", "h0", "h1", "h2", "h3", "h4", "h5", "h6", "h7", "h8", "h9", "r0", "r1", "r2", "r3", "r4", "r5", "r6", "r7", "r8", "r9", "mac", "macpos", "g", "mask", "f", "want", "crypto_onetimeauth", "outpos", "crypto_onetimeauth_verify", "hpos", "crypto_secretbox", "crypto_secretbox_open", "set25519", "a", "car25519", "v", "sel25519", "q", "t", "pack25519", "j", "neq25519", "par25519", "unpack25519", "A", "Z", "M", "t8", "t9", "t10", "t11", "t12", "t13", "t14", "t15", "t16", "t17", "t18", "t19", "t20", "t21", "t22", "t23", "t24", "t25", "t26", "t27", "t28", "t29", "t30", "b0", "b1", "b2", "b3", "b4", "b5", "b6", "b7", "b8", "b9", "b10", "b11", "b12", "b13", "b14", "b15", "S", "inv25519", "pow2523", "crypto_scalarmult", "e", "x32", "x16", "crypto_scalarmult_base", "crypto_box_keypair", "crypto_box_beforenm", "crypto_box_afternm", "crypto_box_open_afternm", "crypto_box", "crypto_box_open", "K", "crypto_hashblocks_hl", "hh", "hl", "wh", "wl", "bh0", "bh1", "bh2", "bh3", "bh4", "bh5", "bh6", "bh7", "bl0", "bl1", "bl2", "bl3", "bl4", "bl5", "bl6", "bl7", "th", "tl", "ah0", "ah1", "ah2", "ah3", "ah4", "ah5", "ah6", "ah7", "al0", "al1", "al2", "al3", "al4", "al5", "al6", "al7", "pos", "crypto_hash", "add", "cswap", "pack", "tx", "ty", "zi", "scalarmult", "scalarbase", "crypto_sign_keypair", "pk", "sk", "seeded", "L", "modL", "carry", "reduce", "crypto_sign", "sm", "smlen", "unpackneg", "chk", "num", "den", "den2", "den4", "den6", "crypto_sign_open", "crypto_secretbox_KEYBYTES", "crypto_secretbox_NONCEBYTES", "crypto_secretbox_ZEROBYTES", "crypto_secretbox_BOXZEROBYTES", "crypto_scalarmult_BYTES", "crypto_scalarmult_SCALARBYTES", "crypto_box_PUBLICKEYBYTES", "crypto_box_SECRETKEYBYTES", "crypto_box_BEFORENMBYTES", "crypto_box_NONCEBYTES", "crypto_box_ZEROBYTES", "crypto_box_BOXZEROBYTES", "crypto_sign_BYTES", "crypto_sign_PUBLICKEYBYTES", "crypto_sign_SECRETKEYBYTES", "crypto_sign_SEEDBYTES", "crypto_hash_BYTES", "checkLengths", "checkBoxLengths", "checkArrayTypes", "cleanup", "arr", "msg", "nonce", "box", "publicKey", "secretKey", "signedMsg", "tmp", "mlen", "sig", "seed", "fn", "crypto", "QUOTA", "__require", "browser_exports", "__export", "CommitmentEngine", "EmergencyEngine", "EnergyEngine", "FederationEngine", "GovernanceEngine", "IdentityEngine", "LedgerEngine", "SchedulerEngine", "TransactionEngine", "createCellProtocol", "createInMemoryStorage", "createPouchDBStorage", "generateId", "now", "generateId", "timestamp", "random", "now", "DEFAULT_CARRIERS", "DEFAULT_TASK_PROFILES", "HUMANITARIAN_FLOOR", "VULNERABILITY_BONUS", "DEFAULT_POLICIES", "DEFAULT_THRESHOLDS", "DEFAULT_FEDERATION_TERMS", "DEFAULT_FEDERATION_PARAMETERS", "generateFederationTxId", "generateId", "generateLinkProposalId", "ok", "value", "err", "error", "LedgerEngine", "cellId", "parameters", "storage", "fullParams", "now", "result", "ok", "err", "memberId", "state", "id", "amount", "member", "availableCapacity", "initialLimit", "limit", "memberState", "updates", "sumDeltas", "sum", "u", "LedgerViolationError", "validationResults", "update", "newBalance", "escrowFloor", "results", "timestamp", "previousBalance", "i", "newReserve", "newLimit", "newFloor", "oldLimit", "status", "oldStatus", "positiveBalanceSum", "negativeBalanceSum", "aggregateCapacity", "floorMass", "totalReserved", "balanceSum", "activeMemberCount", "error", "createLedgerEngine", "engine", "nacl", "encodeBase64", "bytes", "decodeBase64", "str", "binary", "i", "encodeHex", "b", "CryptoAdapter", "naclInstance", "nacl", "tweetnacl", "err", "ok", "e", "keypair", "encodeBase64", "publicKey", "bytes", "decodeBase64", "encodeHex", "message", "secretKey", "messageStr", "messageBytes", "secretKeyBytes", "signature", "signatureBytes", "publicKeyBytes", "byteLength", "timestamp", "nonce", "cryptoAdapter", "createTransactionSigningData", "data", "TransactionEngine", "ledger", "storage", "crypto", "publicKeyResolver", "input", "id", "generateId", "nonce", "createdAt", "now", "validationError", "TransactionValidationError", "transaction", "result", "payerState", "payeeState", "capacity", "signature", "publicKey", "signingData", "message", "createTransactionSigningData", "updates", "results", "e", "LedgerViolationError", "queued", "item", "memberId", "limit", "offset", "error", "createTransactionEngine", "IdentityEngine", "ledger", "storage", "crypto", "sybilEngines", "engines", "cellId", "displayName", "IdentityValidationError", "keyPairResult", "publicKey", "secretKey", "identityId", "existingResult", "timestamp", "now", "identity", "saveResult", "id", "result", "admission", "sponsor", "e", "change", "eligibility", "sponsorBondId", "serviceBondId", "onProbation", "probationEndsAt", "probationDays", "probationState", "memberId", "initiatorId", "reason", "memberState", "previousStatus", "criteria", "filtered", "searchLower", "i", "statuses", "totalCount", "offset", "limit", "message", "signature", "error", "createIdentityEngine", "CommitmentEngine", "ledger", "transactions", "storage", "input", "promisorState", "CommitmentValidationError", "promiseeState", "now", "availableCapacity", "commitment", "generateId", "result", "id", "accepterId", "confirmation", "tx", "txResult", "reason", "initiatorId", "memberId", "active", "currentTime", "c", "category", "commitments", "fulfilled", "completed", "asPromisor", "asPromisee", "fulfilledAsPromisor", "activeReservedValue", "sum", "error", "createCommitmentEngine", "GovernanceEngine", "cellId", "ledger", "identity", "commitments", "storage", "result", "memberId", "council", "m", "members", "now", "GovernanceValidationError", "input", "votingDurationHours", "closesAt", "proposal", "generateId", "proposalId", "vote", "v", "fullVote", "outcome", "category", "threshold", "quorum", "approvals", "rejections", "totalVotes", "id", "admission", "approverId", "reason", "memberState", "activeCommitments", "c", "newLimit", "params", "complainantState", "evidence", "e", "dispute", "disputeId", "reviewerId", "fullEvidence", "resolution", "action", "statuses", "results", "s", "disputes", "actorId", "error", "createGovernanceEngine", "SchedulerEngine", "ledger", "commitments", "storage", "energy", "input", "template", "generateId", "result", "SchedulerValidationError", "id", "templateId", "weekStart", "slots", "weekStartDate", "day", "slotDate", "startTime", "endTime", "slot", "category", "s", "start", "end", "weekEnd", "openSlots", "suppliesResult", "supplies", "assignments", "unfilledSlots", "assignedMembers", "categoryPriority", "a", "b", "aIdx", "bIdx", "neededAssignees", "candidates", "state", "c", "i", "candidate", "assignment", "updatedSlot", "unassignedMembers", "totalSlots", "filledSlots", "coverageAchieved", "member", "effectiveness", "preference", "debtorScore", "energyFactor", "slotId", "memberId", "hours", "memberState", "creditValue", "now", "assignmentIndex", "rating", "anyComplete", "categoryRequired", "current", "categoryAvailable", "supply", "totalSkill", "sum", "v", "cat", "skill", "categoryGaps", "bottlenecks", "recommendations", "totalRequired", "totalAvailable", "required", "available", "gap", "categoryStats", "totalHoursScheduled", "totalHoursCompleted", "isFilled", "completedHours", "stats", "categoryBreakdown", "totalEssentialHours", "memberCount", "error", "createSchedulerEngine", "EmergencyEngine", "cellId", "ledger", "storage", "thresholds", "timestamp", "now", "DEFAULT_POLICIES", "DEFAULT_THRESHOLDS", "governance", "identity", "energy", "stats", "floorMassNumerator", "members", "floorThresholdFraction", "member", "distanceToFloor", "threshold", "floorMass", "balances", "m", "balanceVariance", "disputeRate", "disputes", "memberChurn", "energyStress", "economicStress", "overallStress", "indicators", "values", "mean", "a", "b", "variance", "v", "riskState", "newState", "reason", "governanceApprovalId", "initiatedBy", "oldState", "EmergencyValidationError", "historyEntry", "from", "to", "stateOrder", "fromIndex", "toIndex", "current", "targetState", "panicEnteredAt", "distanceToEscalation", "distanceToDeescalation", "criticalIndicator", "deescalationBlocked", "blockReason", "floorDistance", "disputeDistance", "energyDistance", "timeSincePanic", "timeRemaining", "timeUntilStabilization", "since", "result", "isNewMember", "error", "createEmergencyEngine", "FederationEngine", "cellId", "ledger", "storage", "parameters", "DEFAULT_FEDERATION_PARAMETERS", "timestamp", "now", "result", "emergency", "c", "remoteCellId", "link", "terms", "existingLink", "FederationValidationError", "proposal", "generateLinkProposalId", "DEFAULT_FEDERATION_TERMS", "proposalId", "proposalResult", "existingLinkIndex", "reason", "linkIndex", "input", "newPosition", "isSource", "transaction", "generateFederationTxId", "error", "analysis", "id", "filter", "positionExceedsCap", "inPanic", "status", "betaFactor", "aggregateCapacity", "cap", "position", "availableCapacity", "utilization", "createFederationEngine", "engine", "EnergyEngine", "cellId", "ledger", "storage", "carriers", "taskProfiles", "DEFAULT_CARRIERS", "DEFAULT_TASK_PROFILES", "carrier", "now", "profile", "scheduler", "carrierId", "stock", "change", "c", "EnergyValidationError", "record", "generateId", "fullRecord", "delta", "source", "flows", "currentTime", "weekStart", "weekEnd", "currentFlow", "f", "category", "p", "m", "modeId", "memberCount", "requiredByCarrier", "projectedConsumption", "selectedModeId", "mode", "weeklyHours", "perHour", "required", "current", "availableByCarrier", "stressIndex", "bundles", "available", "maxStress", "requiredAmount", "availableAmount", "stress", "daysAhead", "projectedStress", "recommendations", "daysUntilCrisis", "plan", "dailyConsumption", "weeklyAmount", "currentStocks", "day", "dailyRate", "targetStress", "modeSubstitutions", "newRequired", "currentModeId", "currentMode", "saves", "currentPerHour", "newStress", "additionalProcurement", "needed", "bundleReductionFactor", "factor", "HUMANITARIAN_FLOOR", "availableWithProcurement", "amount", "members", "baseFraction", "memberId", "memberState", "isVulnerable", "bundleFraction", "VULNERABILITY_BONUS", "energyAllocation", "perMember", "since", "weekAgo", "recentFlow", "daysUntilDepletion", "alerts", "priority", "message", "recommendedAmount", "a", "b", "hours", "state", "result", "timestamp", "date", "diff", "profiles", "error", "createEnergyEngine", "InMemoryStorage", "state", "cloned", "ok", "cellId", "identity", "id", "publicKey", "identities", "i", "tx", "memberId", "limit", "offset", "txIds", "transactions", "a", "b", "queued", "q", "txId", "event", "fullEvent", "generateId", "since", "events", "e", "change", "changes", "c", "commitment", "commitments", "status", "category", "proposal", "proposals", "p", "dispute", "disputes", "d", "council", "slot", "start", "end", "slots", "s", "template", "templates", "supply", "supplies", "entry", "filtered", "filter", "t", "m", "record", "r", "plan", "key", "weekStart", "PouchDBStorage", "db", "docId", "membersObj", "v", "k", "doc", "now", "existing", "err", "members", "result", "payerResult", "payeeResult", "txMap", "promisorResult", "promiseeResult", "commitmentMap", "skillsObj", "skills", "history", "selector", "stocksObj", "selectedModesObj", "taskProfilesData", "stocks", "selectedModes", "taskProfiles", "records", "projectedConsumptionObj", "requiredByCarrierObj", "availableByCarrierObj", "bundlesData", "projectedConsumption", "requiredByCarrier", "availableByCarrier", "bundles", "createInMemoryStorage", "createPouchDBStorage", "createCellProtocol", "options", "cellId", "ledgerParameters", "storage", "createInMemoryStorage", "crypto", "cryptoAdapter", "initResult", "ledger", "createLedgerEngine", "identity", "createIdentityEngine", "transactions", "createTransactionEngine", "memberId", "commitments", "createCommitmentEngine", "governance", "createGovernanceEngine", "scheduler", "createSchedulerEngine", "emergency", "createEmergencyEngine", "federation", "createFederationEngine", "energy", "createEnergyEngine"]
}
