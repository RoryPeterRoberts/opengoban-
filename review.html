<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="robots" content="noindex, nofollow">
  <title>Community Review Panel - Community Connect</title>
  <link rel="stylesheet" href="theme.css">
  <style>
    /* Balance Chip Styles */
    .balance-chip {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-3);
      background: var(--color-primary-light);
      border: 1px solid var(--color-primary);
      border-radius: var(--radius-full);
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-semibold);
      color: var(--color-primary);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .balance-chip:hover {
      background: var(--color-primary);
      color: white;
    }

    .balance-chip svg {
      width: 16px;
      height: 16px;
    }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-4);
    }

    /* Page-specific styles */
    .review-container {
      max-width: var(--max-width-lg);
      margin: 0 auto;
      padding: var(--space-6) var(--space-4);
    }

    .back-link {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      color: var(--color-primary);
      text-decoration: none;
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-medium);
      margin-bottom: var(--space-5);
    }

    .back-link:hover {
      text-decoration: underline;
    }

    /* Ecosystem Health Section */
    .health-section {
      background: var(--color-bg-card);
      border: 1px solid var(--color-border-light);
      border-radius: var(--radius-lg);
      padding: var(--space-5);
      margin-bottom: var(--space-6);
      box-shadow: var(--shadow-sm);
    }

    .health-title {
      font-family: var(--font-family-heading);
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-semibold);
      color: var(--color-text);
      margin-bottom: var(--space-4);
    }

    .health-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-4);
    }

    .health-item {
      padding: var(--space-4);
      background: var(--color-bg-warm);
      border-radius: var(--radius-md);
    }

    .health-label {
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-semibold);
      color: var(--color-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.03em;
      margin-bottom: var(--space-2);
    }

    .health-categories {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-2);
    }

    .health-tag {
      font-size: var(--font-size-sm);
      padding: var(--space-1) var(--space-2);
      border-radius: var(--radius-sm);
    }

    .health-tag.shortage {
      background: var(--color-status-accepted-bg);
      color: var(--color-status-accepted);
    }

    .health-tag.surplus {
      background: var(--color-status-review-bg);
      color: var(--color-status-review);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: var(--space-12) var(--space-5);
      background: var(--color-bg-card);
      border: 1px solid var(--color-border-light);
      border-radius: var(--radius-lg);
    }

    .empty-icon {
      font-size: 4rem;
      margin-bottom: var(--space-4);
    }

    .empty-title {
      font-family: var(--font-family-heading);
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-semibold);
      color: var(--color-text);
      margin-bottom: var(--space-2);
    }

    .empty-text {
      color: var(--color-text-muted);
    }

    /* Review Card */
    .review-card {
      background: var(--color-bg-card);
      border: 1px solid var(--color-border-light);
      border-radius: var(--radius-lg);
      padding: var(--space-5);
      margin-bottom: var(--space-4);
      box-shadow: var(--shadow-sm);
    }

    .review-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: var(--space-4);
    }

    .review-email {
      font-weight: var(--font-weight-semibold);
      font-size: var(--font-size-base);
      color: var(--color-text);
    }

    .review-status {
      font-size: var(--font-size-xs);
      padding: var(--space-1) var(--space-3);
      border-radius: var(--radius-full);
      font-weight: var(--font-weight-semibold);
      text-transform: uppercase;
      letter-spacing: 0.02em;
    }

    .review-status.review {
      background: var(--color-status-review-bg);
      color: var(--color-status-review);
    }

    .review-status.hold {
      background: var(--color-status-hold-bg);
      color: var(--color-status-hold);
    }

    /* Profile Details */
    .profile-details {
      margin-bottom: var(--space-5);
    }

    .detail-row {
      display: flex;
      margin-bottom: var(--space-3);
    }

    .detail-label {
      width: 120px;
      font-size: var(--font-size-sm);
      color: var(--color-text-muted);
      flex-shrink: 0;
    }

    .detail-value {
      font-size: var(--font-size-sm);
      color: var(--color-text);
    }

    .category-badge {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-3);
      background: var(--color-secondary-bg);
      border-radius: var(--radius-md);
      font-size: var(--font-size-sm);
    }

    .tags-list {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-2);
    }

    .tag {
      padding: var(--space-1) var(--space-3);
      background: var(--color-bg-muted);
      border-radius: var(--radius-full);
      font-size: var(--font-size-sm);
    }

    /* Impact Summary */
    .impact-summary {
      background: var(--color-bg-warm);
      border-radius: var(--radius-md);
      padding: var(--space-4);
      margin-bottom: var(--space-5);
    }

    .impact-title {
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-semibold);
      color: var(--color-text-secondary);
      margin-bottom: var(--space-4);
    }

    /* Actions */
    .review-actions {
      display: flex;
      gap: var(--space-3);
      flex-wrap: wrap;
    }

    .action-btn {
      flex: 1;
      min-width: 80px;
      padding: var(--space-3) var(--space-4);
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-semibold);
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--transition-base);
    }

    .action-btn:active {
      transform: scale(0.97);
    }

    .action-btn.accept {
      background: var(--color-status-accepted);
      color: var(--color-text-inverse);
    }

    .action-btn.accept:hover {
      background: var(--color-primary-light);
    }

    .action-btn.hold {
      background: var(--color-status-hold);
      color: var(--color-text-inverse);
    }

    .action-btn.hold:hover {
      opacity: 0.9;
    }

    .action-btn.clarify {
      background: var(--color-bg-card);
      color: var(--color-text);
      border: 2px solid var(--color-border);
    }

    .action-btn.clarify:hover {
      background: var(--color-bg-muted);
      border-color: var(--color-secondary);
    }

    /* Modal overrides */
    .modal-input {
      width: 100%;
      padding: var(--space-3) var(--space-4);
      font-size: var(--font-size-base);
      font-family: var(--font-family);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-4);
      resize: none;
      min-height: 100px;
    }

    .modal-input:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px var(--color-primary-bg);
    }

    /* Shortage checkboxes */
    .shortage-checkboxes {
      margin-bottom: var(--space-4);
    }

    .shortage-checkbox {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3);
      background: var(--color-bg-warm);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-2);
      cursor: pointer;
      transition: background var(--transition-fast);
    }

    .shortage-checkbox:hover {
      background: var(--color-bg-muted);
    }

    .shortage-checkbox input {
      width: 18px;
      height: 18px;
      accent-color: var(--color-primary);
    }

    /* Capacity Bar */
    .capacity-bar {
      height: 8px;
      background: var(--color-bg-muted);
      border-radius: 4px;
      position: relative;
      margin-bottom: var(--space-4);
    }

    .capacity-fill {
      height: 100%;
      border-radius: 4px;
      background: var(--color-primary);
      transition: width 0.3s;
    }

    .capacity-label {
      position: absolute;
      right: 0;
      top: -20px;
      font-size: var(--font-size-xs);
      color: var(--color-text-muted);
    }

    /* Coverage Grid */
    .coverage-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: var(--space-2);
      margin-top: var(--space-4);
    }

    .coverage-item {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2);
      border-radius: var(--radius-sm);
      font-size: var(--font-size-sm);
    }

    .coverage-item.gap {
      background: var(--color-bg-warning, #fef3cd);
    }

    .coverage-item.concentrated {
      background: var(--color-bg-muted);
    }

    .coverage-count {
      margin-left: auto;
      font-weight: 600;
    }

    .coverage-flag {
      font-size: var(--font-size-xs);
      padding: 2px 6px;
      border-radius: var(--radius-sm);
      background: var(--color-status-review);
      color: white;
    }

    .coverage-flag.warn {
      background: var(--color-text-muted);
    }

    .fills-gap-badge {
      display: inline-flex;
      align-items: center;
      font-size: var(--font-size-xs);
      padding: 2px 8px;
      border-radius: var(--radius-sm);
      background: var(--color-primary);
      color: white;
      margin-left: var(--space-2);
    }
  </style>
</head>
<body>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script>
  <script src="js/auth.js"></script>

  <div class="review-container" id="main-container">
    <div class="page-header">
      <a href="index.html" class="back-link" style="margin-bottom: 0;">&larr; Back to home</a>
    </div>

    <div class="review-banner">
      <span class="review-banner-title">Community Review Panel</span>
      <span class="review-banner-badge">Admin</span>
    </div>

    <!-- Ecosystem Health -->
    <div class="health-section">
      <h3 class="health-title">Community health</h3>
      <!-- Member capacity bar -->
      <div class="capacity-bar">
        <div class="capacity-fill" id="capacity-fill"></div>
        <span class="capacity-label" id="capacity-label"></span>
      </div>
      <div class="health-grid">
        <div class="health-item">
          <div class="health-label">We need more of</div>
          <div class="health-categories" id="shortage-categories"></div>
        </div>
        <div class="health-item">
          <div class="health-label">Well covered</div>
          <div class="health-categories" id="surplus-categories"></div>
        </div>
      </div>
      <!-- Skill coverage breakdown -->
      <div class="coverage-grid" id="coverage-grid"></div>
    </div>

    <!-- Review Queue -->
    <div id="review-queue"></div>

    <!-- Footer -->
    <footer style="text-align: center; padding: var(--space-6) 0; margin-top: var(--space-6); border-top: 1px solid var(--color-border-light);">
      <a href="terms.html" style="display: inline-flex; align-items: center; gap: var(--space-1); color: var(--color-text-muted); font-size: var(--font-size-xs); text-decoration: none;">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
          <polyline points="14 2 14 8 20 8"/>
        </svg>
        Terms & Conditions
      </a>
      <span style="margin: 0 var(--space-2); color: var(--color-text-muted);">·</span>
      <a href="privacy.html" style="display: inline-flex; align-items: center; gap: var(--space-1); color: var(--color-text-muted); font-size: var(--font-size-xs); text-decoration: none;">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
        </svg>
        Privacy
      </a>
    </footer>
  </div>

  <!-- Hold Modal -->
  <div class="modal-overlay" id="hold-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Put application on hold</h3>
        <p class="modal-subtitle">Let them know why and suggest categories where we need help.</p>
      </div>
      <div class="modal-body">
        <textarea class="modal-input" id="hold-reason" placeholder="Reason (shown to applicant)..."></textarea>
        <div class="shortage-checkboxes" id="shortage-checkboxes"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost" onclick="closeHoldModal()">Cancel</button>
        <button class="btn btn-primary" onclick="confirmHold()">Put on hold</button>
      </div>
    </div>
  </div>

  <!-- Clarify Modal -->
  <div class="modal-overlay" id="clarify-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Request clarification</h3>
        <p class="modal-subtitle">Ask a question or request more information.</p>
      </div>
      <div class="modal-body">
        <textarea class="modal-input" id="clarify-message" placeholder="Your message..."></textarea>
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost" onclick="closeClarifyModal()">Cancel</button>
        <button class="btn btn-primary" onclick="confirmClarify()">Send message</button>
      </div>
    </div>
  </div>

  <script>
    // =====================================================
    // STATE
    // =====================================================
    let currentMemberId = null; // member being acted on
    let currentAdmin = null;
    let reviewQueue = [];
    let skillData = null;

    // =====================================================
    // INITIALIZATION
    // =====================================================
    async function init() {
      try {
        const session = await getAuthSession();
        if (!session) { window.location.href = 'access.html'; return; }
        currentAdmin = await getCurrentMember();
        if (!currentAdmin) { window.location.href = 'access.html'; return; }

        // Admin check - require admin password for non-admin members
        await requireAdmin(async () => {
          await renderHealthSummary();
          await renderReviewQueue();
        });
      } catch (e) {
        console.error('Init error:', e);
      }
    }

    // =====================================================
    // ECOSYSTEM HEALTH
    // =====================================================
    async function renderHealthSummary() {
      try {
        const health = await getEcosystemHealthData();
        const shortages = getShortageCategories(health);

        // Find well-covered categories (supply > demand by 2+)
        const allCats = Object.keys({ ...health.supplyCounts, ...health.demandCounts });
        const surplus = allCats.filter(cat => {
          const s = health.supplyCounts[cat] || 0;
          const d = health.demandCounts[cat] || 0;
          return s - d >= 2;
        });

        document.getElementById('shortage-categories').innerHTML = shortages.length > 0
          ? shortages.map(catId => { const c = getCategoryById(catId); return `<span class="health-tag shortage">${c.emoji} ${c.label.split(' & ')[0]}</span>`; }).join('')
          : '<span style="color:var(--color-text-muted);font-size:var(--font-size-sm);">None</span>';

        document.getElementById('surplus-categories').innerHTML = surplus.length > 0
          ? surplus.map(catId => { const c = getCategoryById(catId); return `<span class="health-tag surplus">${c.emoji} ${c.label.split(' & ')[0]}</span>`; }).join('')
          : '<span style="color:var(--color-text-muted);font-size:var(--font-size-sm);">None</span>';

        // Render member capacity bar
        const members = await getAcceptedMembers();
        const pct = (members.length / COMMUNITY_SETTINGS.MEMBER_CAP) * 100;
        document.getElementById('capacity-fill').style.width = Math.min(pct, 100) + '%';
        document.getElementById('capacity-label').textContent =
          `${members.length} / ${COMMUNITY_SETTINGS.MEMBER_CAP} members`;

        // Render skill coverage grid
        skillData = getSkillCoverageData(members);
        document.getElementById('coverage-grid').innerHTML = CATEGORIES.map(cat => {
          const data = skillData.coverage[cat.id];
          const isGap = skillData.gaps.includes(cat.id);
          const isConc = skillData.concentrations.includes(cat.id);
          return `<div class="coverage-item ${isGap ? 'gap' : ''} ${isConc ? 'concentrated' : ''}">
            <span>${cat.emoji}</span>
            <span>${cat.label.split(' & ')[0]}</span>
            <span class="coverage-count">${data.count}</span>
            ${isGap ? '<span class="coverage-flag">Needs members</span>' : ''}
            ${isConc ? '<span class="coverage-flag warn">Over-represented</span>' : ''}
          </div>`;
        }).join('');
      } catch (e) {
        console.error('Health load error:', e);
      }
    }

    // =====================================================
    // REVIEW QUEUE
    // =====================================================
    async function renderReviewQueue() {
      const container = document.getElementById('review-queue');
      try {
        reviewQueue = await getMembersForReview();

        if (reviewQueue.length === 0) {
          container.innerHTML = `<div class="empty-state"><div class="empty-icon">✨</div><h3 class="empty-title">All caught up!</h3><p class="empty-text">No applications pending review.</p></div>`;
          return;
        }

        container.innerHTML = reviewQueue.map(m => renderReviewCard(m)).join('');
      } catch (e) {
        console.error('Queue load error:', e);
        container.innerHTML = '<p style="text-align:center;color:var(--color-text-muted);">Could not load review queue.</p>';
      }
    }

    function renderReviewCard(member) {
      const primaryCat = getCategoryById(member.primary_category);
      const statusClass = member.status === 'HOLD' ? 'hold' : 'review';
      const statusLabel = member.status === 'HOLD' ? 'On hold' : member.status === 'REVIEW' ? 'Awaiting review' : member.status;

      const termsHtml = member.terms_accepted_at
        ? `<span style="display:inline-flex;align-items:center;gap:var(--space-1);color:var(--color-status-accepted);font-size:var(--font-size-xs);">Accepted ${member.terms_version || 'v1'}</span>`
        : '<span style="color:var(--color-status-review);font-size:var(--font-size-xs);">Not yet accepted</span>';

      return `
        <div class="review-card">
          <div class="review-header">
            <div>
              <span class="review-email">${escapeHtml(member.display_name)}</span>
              <span style="font-size:var(--font-size-xs);color:var(--color-text-muted);margin-left:var(--space-2);">${member.member_id}</span>
            </div>
            <span class="review-status ${statusClass}">${statusLabel}</span>
          </div>
          <div style="font-size:var(--font-size-sm);color:var(--color-text-muted);margin-bottom:var(--space-3);">${escapeHtml(member.email)}</div>

          <div class="profile-details">
            ${primaryCat ? `<div class="detail-row"><span class="detail-label">Primary offer</span><span class="detail-value"><span class="category-badge">${primaryCat.emoji} ${primaryCat.label}</span>${skillData && skillData.gaps.includes(member.primary_category) ? '<span class="fills-gap-badge">Fills a gap</span>' : ''}</span></div>` : ''}

            ${member.secondary_categories && member.secondary_categories.length > 0 ? `
            <div class="detail-row"><span class="detail-label">Also offers</span><span class="detail-value">
              ${member.secondary_categories.map(id => { const c = getCategoryById(id); return `<span class="category-badge" style="margin-right:var(--space-2);">${c.emoji} ${c.label.split(' & ')[0]}</span>`; }).join('')}
            </span></div>` : ''}

            <div class="detail-row"><span class="detail-label">Skill tags</span><span class="detail-value"><div class="tags-list">
              ${(member.skill_tags || []).map(t => `<span class="tag">${escapeHtml(t)}</span>`).join('')}
            </div></span></div>

            <div class="detail-row"><span class="detail-label">Availability</span><span class="detail-value">${member.availability || 'Not specified'}</span></div>

            ${member.bio ? `<div class="detail-row"><span class="detail-label">Bio</span><span class="detail-value">${escapeHtml(member.bio)}</span></div>` : ''}

            <div class="detail-row"><span class="detail-label">T&C Status</span><span class="detail-value">${termsHtml}</span></div>

            <div class="detail-row"><span class="detail-label">Applied</span><span class="detail-value">${formatDate(member.created_at)}</span></div>
          </div>

          <div class="review-actions">
            <button class="action-btn accept" onclick="acceptMember('${member.id}')">Accept</button>
            <button class="action-btn hold" onclick="openHoldModal('${member.id}')">Hold</button>
          </div>
        </div>
      `;
    }

    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    // =====================================================
    // ACTIONS
    // =====================================================
    async function acceptMember(memberId) {
      try {
        await updateMember(memberId, {
          status: 'ACCEPTED',
          accepted_at: new Date().toISOString()
        });

        // Audit log
        const m = reviewQueue.find(m => m.id === memberId);
        if (m) {
          await addAuditEntry('member_accepted', currentAdmin.id, currentAdmin.display_name,
            `Accepted member: ${m.display_name} (${m.member_id})`).catch(() => {});
        }

        showToast('Member accepted!');
        await renderHealthSummary();
        await renderReviewQueue();
      } catch (e) {
        console.error('Accept error:', e);
        showToast('Failed to accept. Please try again.');
      }
    }

    // =====================================================
    // HOLD MODAL
    // =====================================================
    function openHoldModal(memberId) {
      currentMemberId = memberId;
      document.getElementById('hold-modal').classList.add('active');
    }

    function closeHoldModal() {
      currentMemberId = null;
      document.getElementById('hold-reason').value = '';
      document.getElementById('hold-modal').classList.remove('active');
    }

    async function confirmHold() {
      if (!currentMemberId) return;
      try {
        await updateMember(currentMemberId, { status: 'HOLD' });

        const m = reviewQueue.find(m => m.id === currentMemberId);
        if (m) {
          await addAuditEntry('member_hold', currentAdmin.id, currentAdmin.display_name,
            `Put on hold: ${m.display_name} (${m.member_id})`).catch(() => {});
        }

        closeHoldModal();
        showToast('Application put on hold');
        await renderReviewQueue();
      } catch (e) {
        console.error('Hold error:', e);
        showToast('Failed. Please try again.');
      }
    }

    // =====================================================
    // CLARIFY MODAL
    // =====================================================
    function openClarifyModal(memberId) {
      currentMemberId = memberId;
      document.getElementById('clarify-modal').classList.add('active');
    }

    function closeClarifyModal() {
      currentMemberId = null;
      document.getElementById('clarify-message').value = '';
      document.getElementById('clarify-modal').classList.remove('active');
    }

    async function confirmClarify() {
      if (!currentMemberId) return;
      const message = document.getElementById('clarify-message').value.trim();
      if (!message) { showToast('Please enter a message'); return; }
      closeClarifyModal();
      showToast('Note recorded');
    }

    // =====================================================
    // INIT
    // =====================================================
    init();
  </script>
</body>
</html>
