<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="robots" content="noindex, nofollow">
  <title>Listing — Open Gobán</title>
  <link rel="stylesheet" href="theme.css">
  <style>
    /* Page Container */
    .listing-container {
      max-width: var(--max-width);
      margin: 0 auto;
      padding: var(--space-6) var(--space-5);
      min-height: 100vh;
    }

    /* Header */
    .page-header {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      margin-bottom: var(--space-6);
    }

    .back-link {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 44px;
      height: 44px;
      background: var(--color-bg-card);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
      color: var(--color-text-secondary);
      text-decoration: none;
      transition: all var(--transition-fast);
      flex-shrink: 0;
    }

    .back-link:hover {
      background: var(--color-bg-muted);
      color: var(--color-primary);
    }

    .back-link svg {
      width: 20px;
      height: 20px;
    }

    .page-title {
      font-family: var(--font-family-heading);
      font-size: var(--font-size-xl);
      font-weight: var(--font-weight-semibold);
      color: var(--color-text);
    }

    /* Loading */
    .loading-state {
      text-align: center;
      padding: var(--space-12) var(--space-5);
    }

    .loading-spinner-lg {
      width: 40px;
      height: 40px;
      border: 3px solid var(--color-border);
      border-top-color: var(--color-primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto var(--space-4);
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* Type Badge */
    .listing-type-badge {
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      padding: var(--space-1) var(--space-3);
      border-radius: var(--radius-sm);
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-semibold);
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .listing-type-badge.offer {
      background: var(--color-status-accepted-bg);
      color: var(--color-status-accepted);
    }

    .listing-type-badge.need {
      background: var(--color-status-review-bg);
      color: var(--color-status-review);
    }

    /* Detail Card */
    .detail-card {
      background: var(--color-bg-card);
      border: 1px solid var(--color-border-light);
      border-radius: var(--radius-xl);
      padding: var(--space-6);
      margin-bottom: var(--space-5);
      box-shadow: var(--shadow-card);
    }

    .detail-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: var(--space-3);
      margin-bottom: var(--space-4);
    }

    .detail-title {
      font-family: var(--font-family-heading);
      font-size: var(--font-size-2xl);
      font-weight: var(--font-weight-bold);
      color: var(--color-text);
      line-height: var(--line-height-snug);
    }

    .detail-category {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
      margin-bottom: var(--space-4);
    }

    .detail-description {
      font-size: var(--font-size-base);
      color: var(--color-text-secondary);
      line-height: var(--line-height-relaxed);
      margin-bottom: var(--space-5);
      white-space: pre-line;
    }

    /* Tags */
    .detail-tags {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-2);
      margin-bottom: var(--space-5);
    }

    .detail-tag {
      display: inline-flex;
      align-items: center;
      background: var(--color-bg-muted);
      color: var(--color-text-muted);
      padding: var(--space-1) var(--space-3);
      border-radius: var(--radius-full);
      font-size: var(--font-size-xs);
    }

    /* Meta row */
    .detail-meta {
      display: flex;
      align-items: center;
      gap: var(--space-4);
      flex-wrap: wrap;
      padding: var(--space-4) 0;
      border-top: 1px solid var(--color-border-light);
      border-bottom: 1px solid var(--color-border-light);
      margin-bottom: var(--space-5);
      font-size: var(--font-size-sm);
      color: var(--color-text-muted);
    }

    .meta-item {
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
    }

    .meta-item svg {
      width: 16px;
      height: 16px;
    }

    /* Author Card */
    .author-card {
      display: flex;
      align-items: center;
      gap: var(--space-4);
      padding: var(--space-4);
      background: var(--color-bg-warm);
      border-radius: var(--radius-lg);
    }

    .author-avatar {
      width: 52px;
      height: 52px;
      background: linear-gradient(135deg, var(--color-primary-bg) 0%, var(--color-accent-bg) 100%);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: var(--font-family-heading);
      font-weight: var(--font-weight-bold);
      font-size: var(--font-size-lg);
      color: var(--color-primary);
      flex-shrink: 0;
    }

    .author-details {
      flex: 1;
      min-width: 0;
    }

    .author-name {
      font-weight: var(--font-weight-semibold);
      color: var(--color-text);
      font-size: var(--font-size-base);
    }

    .author-member-id {
      font-family: var(--font-family-mono, monospace);
      font-size: var(--font-size-xs);
      color: var(--color-text-muted);
    }

    .author-trust {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      margin-top: var(--space-2);
      font-size: var(--font-size-xs);
      color: var(--color-text-muted);
    }

    .reliability-badge {
      display: inline-flex;
      align-items: center;
      padding: 2px var(--space-2);
      border-radius: var(--radius-sm);
      font-size: 10px;
      font-weight: var(--font-weight-semibold);
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .reliability-badge.low { background: var(--color-bg-muted); color: var(--color-text-muted); }
    .reliability-badge.medium { background: var(--color-status-review-bg); color: var(--color-status-review); }
    .reliability-badge.high { background: var(--color-status-accepted-bg); color: var(--color-status-accepted); }

    /* Own Listing Notice */
    .own-listing-notice {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-4);
      background: var(--color-primary-bg);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
      margin-bottom: var(--space-5);
    }

    .own-listing-notice svg {
      width: 20px;
      height: 20px;
      color: var(--color-primary);
      flex-shrink: 0;
    }

    /* Exchange Form */
    .exchange-form-card {
      background: var(--color-bg-card);
      border: 1px solid var(--color-border-light);
      border-radius: var(--radius-xl);
      padding: var(--space-6);
      margin-bottom: var(--space-5);
      box-shadow: var(--shadow-card);
    }

    .exchange-form-title {
      font-family: var(--font-family-heading);
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-semibold);
      color: var(--color-text);
      margin-bottom: var(--space-2);
    }

    .exchange-form-subtitle {
      font-size: var(--font-size-sm);
      color: var(--color-text-muted);
      margin-bottom: var(--space-5);
      line-height: var(--line-height-relaxed);
    }

    /* Credit cost */
    .credit-cost {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-2);
      padding: var(--space-3) var(--space-4);
      background: var(--color-bg-warm);
      border-radius: var(--radius-lg);
      margin-bottom: var(--space-5);
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
    }

    .credit-cost svg {
      width: 18px;
      height: 18px;
      color: var(--color-primary);
    }

    .credit-cost strong {
      color: var(--color-primary);
    }

    /* Proposals Section */
    .proposals-section {
      background: var(--color-bg-card);
      border: 1px solid var(--color-border-light);
      border-radius: var(--radius-xl);
      padding: var(--space-6);
      margin-bottom: var(--space-5);
      box-shadow: var(--shadow-card);
    }

    .proposals-title {
      font-family: var(--font-family-heading);
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-semibold);
      color: var(--color-text);
      margin-bottom: var(--space-4);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .proposals-count {
      background: var(--color-primary);
      color: white;
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-bold);
      padding: 2px var(--space-2);
      border-radius: var(--radius-full);
      font-family: var(--font-family);
    }

    .proposal-item {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
      padding: var(--space-4);
      background: var(--color-bg-warm);
      border-radius: var(--radius-lg);
      margin-bottom: var(--space-3);
      border: 1px solid var(--color-border-light);
    }

    .proposal-item:last-child {
      margin-bottom: 0;
    }

    .proposal-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .proposal-from {
      font-weight: var(--font-weight-semibold);
      color: var(--color-text);
      font-size: var(--font-size-sm);
    }

    .proposal-from-id {
      font-family: var(--font-family-mono, monospace);
      font-size: var(--font-size-xs);
      color: var(--color-text-muted);
    }

    .proposal-status {
      display: inline-flex;
      align-items: center;
      padding: 2px var(--space-2);
      border-radius: var(--radius-sm);
      font-size: 10px;
      font-weight: var(--font-weight-semibold);
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .proposal-status.proposed {
      background: var(--color-status-review-bg);
      color: var(--color-status-review);
    }

    .proposal-status.accepted {
      background: var(--color-status-accepted-bg);
      color: var(--color-status-accepted);
    }

    .proposal-status.cancelled {
      background: var(--color-bg-muted);
      color: var(--color-text-muted);
    }

    .proposal-status.completed {
      background: var(--color-status-accepted-bg);
      color: var(--color-status-accepted);
    }

    .proposal-desc {
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
      line-height: var(--line-height-relaxed);
    }

    .proposal-meta {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      font-size: var(--font-size-xs);
      color: var(--color-text-muted);
    }

    .no-proposals {
      text-align: center;
      padding: var(--space-6);
      color: var(--color-text-muted);
      font-size: var(--font-size-sm);
    }

    .proposal-actions {
      display: flex;
      gap: var(--space-2);
      margin-top: var(--space-2);
    }

    .proposal-actions .btn {
      flex: 1;
      font-size: var(--font-size-sm);
      padding: var(--space-2) var(--space-3);
    }

    .btn-danger {
      background: transparent;
      color: var(--color-status-hold);
      border-color: var(--color-status-hold);
    }

    .btn-danger:hover:not(:disabled) {
      background: var(--color-status-hold-bg);
    }

    .proposal-contact {
      padding: var(--space-3);
      background: linear-gradient(135deg, var(--color-primary-bg) 0%, var(--color-accent-bg) 100%);
      border: 1px solid var(--color-border-light);
      border-radius: var(--radius-md);
      margin-top: var(--space-2);
    }

    .proposal-contact-label {
      font-size: var(--font-size-xs);
      color: var(--color-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      font-weight: var(--font-weight-semibold);
      margin-bottom: var(--space-2);
    }

    .proposal-contact-row {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      margin-bottom: var(--space-1);
    }

    .proposal-contact-row:last-child {
      margin-bottom: 0;
    }

    .proposal-contact-link {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      font-size: var(--font-size-sm);
      color: var(--color-primary);
      text-decoration: none;
    }

    .proposal-contact-link:hover {
      text-decoration: underline;
    }

    .proposal-contact-link svg {
      width: 14px;
      height: 14px;
      flex-shrink: 0;
    }

    .proposal-exchange-link {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-2);
      margin-top: var(--space-3);
      padding: var(--space-3);
      background: var(--color-bg-card);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      font-size: var(--font-size-sm);
      color: var(--color-primary);
      text-decoration: none;
      transition: all var(--transition-fast);
    }

    .proposal-exchange-link:hover {
      border-color: var(--color-primary);
      background: var(--color-primary-bg);
    }

    .proposal-exchange-link svg {
      width: 16px;
      height: 16px;
    }

    /* Listing status banner */
    .listing-status-banner {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-4);
      border-radius: var(--radius-lg);
      font-size: var(--font-size-sm);
      margin-bottom: var(--space-5);
    }

    .listing-status-banner svg {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
    }

    .listing-status-banner.cancelled {
      background: var(--color-status-hold-bg);
      border: 1px solid var(--color-status-hold);
      color: var(--color-status-hold);
    }

    .listing-status-banner.completed {
      background: var(--color-status-accepted-bg);
      border: 1px solid var(--color-status-accepted);
      color: var(--color-status-accepted);
    }

    .listing-status-banner.expired {
      background: var(--color-bg-muted);
      border: 1px solid var(--color-border);
      color: var(--color-text-muted);
    }

    .listing-status-banner.matched {
      background: var(--color-status-pending-bg);
      border: 1px solid var(--color-status-pending);
      color: var(--color-status-pending);
    }

    .listing-status-text {
      flex: 1;
    }

    .listing-status-text strong {
      display: block;
      margin-bottom: 2px;
    }

    .confirm-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: var(--space-4);
    }

    .confirm-dialog {
      background: var(--color-bg-card);
      border-radius: var(--radius-xl);
      padding: var(--space-6);
      max-width: 360px;
      width: 100%;
      box-shadow: var(--shadow-lg);
    }

    .confirm-dialog h3 {
      font-family: var(--font-family-heading);
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-semibold);
      color: var(--color-text);
      margin-bottom: var(--space-3);
    }

    .confirm-dialog p {
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
      margin-bottom: var(--space-5);
      line-height: var(--line-height-relaxed);
    }

    .confirm-dialog-actions {
      display: flex;
      gap: var(--space-3);
    }

    .confirm-dialog-actions .btn {
      flex: 1;
    }

    /* Error state */
    .error-state {
      text-align: center;
      padding: var(--space-12) var(--space-5);
    }

    .error-state-icon {
      font-size: 3rem;
      margin-bottom: var(--space-4);
    }

    .error-state-title {
      font-family: var(--font-family-heading);
      font-size: var(--font-size-lg);
      color: var(--color-text);
      margin-bottom: var(--space-2);
    }

    .error-state-text {
      font-size: var(--font-size-sm);
      color: var(--color-text-muted);
      margin-bottom: var(--space-6);
    }

    /* Degrees badge */
    .degrees-badge {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      padding: 2px var(--space-2);
      border-radius: var(--radius-sm);
      font-size: 10px;
      font-weight: var(--font-weight-semibold);
      background: var(--color-primary-bg);
      color: var(--color-primary);
    }

    .degrees-badge svg {
      width: 12px;
      height: 12px;
    }

    /* Edit Form */
    .edit-form-card {
      background: var(--color-bg-card);
      border: 1px solid var(--color-border-light);
      border-radius: var(--radius-xl);
      padding: var(--space-6);
      margin-bottom: var(--space-5);
      box-shadow: var(--shadow-card);
    }

    .edit-form-card .form-group {
      margin-bottom: var(--space-5);
    }

    .edit-form-card .form-label {
      display: block;
      font-family: var(--font-family-heading);
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-medium);
      color: var(--color-text);
      margin-bottom: var(--space-2);
    }

    .edit-form-card .input,
    .edit-form-card .textarea {
      width: 100%;
      padding: var(--space-3);
      font-family: var(--font-family);
      font-size: var(--font-size-base);
      color: var(--color-text);
      background: var(--color-bg-card);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-lg);
      transition: border-color var(--transition-fast);
    }

    .edit-form-card .input:focus,
    .edit-form-card .textarea:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 4px var(--color-primary-bg);
    }

    .edit-form-card .select {
      width: 100%;
      padding: var(--space-3);
      font-family: var(--font-family);
      font-size: var(--font-size-base);
      color: var(--color-text);
      background: var(--color-bg-card);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-lg);
      appearance: none;
      -webkit-appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
    }

    .edit-form-card .select:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 4px var(--color-primary-bg);
    }

    .edit-form-card .chips-container {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-2);
      padding: var(--space-3);
      background: var(--color-bg-card);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-lg);
      cursor: text;
    }

    .edit-form-card .chips-container:focus-within {
      border-color: var(--color-primary);
      box-shadow: 0 0 0 4px var(--color-primary-bg);
    }

    .edit-form-card .chip {
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      padding: 4px var(--space-3);
      background: linear-gradient(135deg, var(--color-secondary-bg) 0%, var(--color-primary-bg) 100%);
      border: 1px solid var(--color-border-light);
      border-radius: var(--radius-full);
      font-size: var(--font-size-xs);
      color: var(--color-text-secondary);
    }

    .edit-form-card .chip-remove {
      background: none;
      border: none;
      color: var(--color-text-muted);
      cursor: pointer;
      font-size: var(--font-size-sm);
      padding: 0;
      line-height: 1;
      margin-left: 2px;
    }

    .edit-form-card .chip-remove:hover {
      color: var(--color-status-hold);
    }

    .edit-form-card .chips-input {
      flex: 1;
      min-width: 120px;
      border: none;
      outline: none;
      font-family: var(--font-family);
      font-size: var(--font-size-sm);
      background: transparent;
      color: var(--color-text);
      padding: 4px 0;
    }

    .edit-btn-row {
      display: flex;
      gap: var(--space-3);
    }

    .edit-btn-row .btn {
      flex: 1;
    }

    .own-listing-actions {
      display: flex;
      gap: var(--space-3);
      margin-top: var(--space-3);
    }

    .own-listing-actions .btn {
      flex: 1;
    }

    .page-header { justify-content: space-between; }
    .page-header-left { display: flex; align-items: center; gap: var(--space-3); }
    .notif-bell-link {
      position: relative;
      color: var(--color-text-muted);
      text-decoration: none;
      padding: var(--space-1);
      display: flex;
      align-items: center;
      transition: color var(--transition-fast);
    }
    .notif-bell-link:hover { color: var(--color-primary); }
    .notif-bell-link svg { width: 20px; height: 20px; display: block; }
    .notif-bell-link .notif-badge-sm {
      position: absolute;
      top: -2px;
      right: -4px;
      min-width: 16px;
      height: 16px;
      padding: 0 4px;
      border-radius: var(--radius-full);
      background: var(--color-primary);
      color: white;
      font-size: 10px;
      font-weight: var(--font-weight-bold);
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }
    .notif-badge-sm:empty { display: none; }

    /* Q&A Section */
    .qa-section {
      margin-top: var(--space-6);
    }
    .qa-title {
      font-family: var(--font-family-heading);
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-semibold);
      color: var(--color-text);
      margin-bottom: var(--space-4);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }
    .qa-title svg { width: 18px; height: 18px; color: var(--color-primary); }
    .qa-count {
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-medium);
      color: var(--color-text-muted);
    }

    .qa-input-row {
      display: flex;
      gap: var(--space-2);
      margin-bottom: var(--space-4);
    }
    .qa-input-row .textarea {
      flex: 1;
      min-height: 44px;
      resize: none;
      font-size: var(--font-size-sm);
    }
    .qa-send-btn {
      align-self: flex-end;
      padding: var(--space-2) var(--space-3);
      background: var(--color-primary);
      color: white;
      border: none;
      border-radius: var(--radius-md);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background var(--transition-fast);
      min-width: 44px;
      height: 44px;
    }
    .qa-send-btn:hover { background: var(--color-primary-dark, #3d6b4f); }
    .qa-send-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .qa-send-btn svg { width: 18px; height: 18px; }

    .qa-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
    }
    .qa-comment {
      display: flex;
      gap: var(--space-3);
      padding: var(--space-3);
      background: var(--color-bg-card);
      border: 1px solid var(--color-border-light);
      border-radius: var(--radius-md);
    }
    .qa-comment.is-author {
      background: var(--color-bg-warm);
      border-color: var(--color-border);
    }
    .qa-avatar {
      width: 32px;
      height: 32px;
      border-radius: var(--radius-full);
      background: var(--color-primary-bg);
      color: var(--color-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-bold);
      flex-shrink: 0;
    }
    .qa-comment.is-author .qa-avatar {
      background: var(--color-primary);
      color: white;
    }
    .qa-body { flex: 1; min-width: 0; }
    .qa-meta {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      margin-bottom: 2px;
    }
    .qa-name {
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-medium);
      color: var(--color-text);
    }
    .qa-author-badge {
      font-size: 10px;
      font-weight: var(--font-weight-semibold);
      color: var(--color-primary);
      background: var(--color-primary-bg);
      padding: 1px var(--space-1);
      border-radius: var(--radius-sm);
      text-transform: uppercase;
    }
    .qa-time {
      font-size: var(--font-size-xs);
      color: var(--color-text-muted);
    }
    .qa-delete-btn {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--color-text-muted);
      padding: 2px;
      margin-left: var(--space-1);
      opacity: 0.5;
      transition: opacity var(--transition-fast);
    }
    .qa-delete-btn:hover { opacity: 1; color: var(--color-status-hold); }
    .qa-message {
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
      line-height: var(--line-height-relaxed);
      white-space: pre-wrap;
      word-break: break-word;
    }
    .qa-empty {
      text-align: center;
      padding: var(--space-4);
      color: var(--color-text-muted);
      font-size: var(--font-size-sm);
    }
  </style>
</head>
<body>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script>
  <script src="js/auth.js"></script>
  <script src="feedback-widget.js"></script>

  <div class="listing-container" id="main-container">
    <div class="loading-state">
      <div class="loading-spinner-lg"></div>
      <p style="color: var(--color-text-muted);">Loading listing...</p>
    </div>
  </div>

  <script>
    // =====================================================
    // STATE
    // =====================================================
    let currentMember = null;
    let currentBalance = null;
    let listing = null;
    let exchanges = [];
    let comments = [];
    let listingId = null;
    let allMembers = [];

    // =====================================================
    // INITIALIZATION
    // =====================================================
    async function init() {
      try {
        // Auth check
        const session = await getAuthSession();
        if (!session) {
          window.location.href = 'access.html';
          return;
        }

        currentMember = await getCurrentMember();
        if (!currentMember) {
          window.location.href = 'access.html';
          return;
        }

        if (currentMember.status === 'PENDING_PROFILE') {
          window.location.href = 'join.html';
          return;
        }
        initFeedbackWidget(currentMember.id);

        // Get listing ID from URL
        const params = new URLSearchParams(window.location.search);
        listingId = params.get('id');

        if (!listingId) {
          renderError('No listing specified', 'Please go back and select a listing from the community board.');
          return;
        }

        // Load listing data
        try {
          listing = await getListingById(listingId);
        } catch (e) {
          console.error('Listing fetch error:', e);
          renderError('Listing not found', 'This listing may have been removed or the link is invalid.');
          return;
        }

        if (!listing) {
          renderError('Listing not found', 'This listing may have been removed or the link is invalid.');
          return;
        }

        // Load exchanges and comments for this listing
        try {
          [exchanges, comments] = await Promise.all([
            getExchangesForListing(listingId),
            getListingComments(listingId)
          ]);
        } catch (e) {
          console.error('Data fetch error:', e);
          exchanges = [];
          comments = [];
        }

        // Load all members for degrees calculation and current balance
        [allMembers, currentBalance] = await Promise.all([
          getAcceptedMembers(),
          getBalance(currentMember.id).catch(() => ({ credits: 5, total_earned: 0, total_spent: 0 }))
        ]);

        renderListing();

        // Load notification count
        getUnreadNotificationCount().then(count => {
          const badge = document.getElementById('notif-badge');
          if (badge) badge.textContent = count > 0 ? (count > 9 ? '9+' : count) : '';
        }).catch(() => {});
      } catch (e) {
        console.error('Init error:', e);
        document.getElementById('main-container').innerHTML = `
          <div style="text-align:center;padding:40px;">
            <p>Something went wrong.</p>
            <a href="access.html" style="color:var(--color-primary);">Sign in again</a>
          </div>
        `;
      }
    }

    // =====================================================
    // RENDER
    // =====================================================
    function renderListing() {
      const container = document.getElementById('main-container');
      const author = listing.author || {};
      const cat = getCategoryById(listing.category);
      const band = calculateReliabilityBand(author.exchanges_completed || 0, author.disputes_count || 0);
      const isOwner = currentMember.id === listing.author_id;
      const areaLabel = getAreaLabel(listing.area);
      const isOffer = listing.type === 'offer';

      // Update page title
      document.title = `${escapeHtml(listing.title)} — Open Gobán`;

      let html = `
        <header class="page-header">
          <div class="page-header-left">
            <a href="index.html" class="back-link" aria-label="Back to community board">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="19" y1="12" x2="5" y2="12"/>
                <polyline points="12 19 5 12 12 5"/>
              </svg>
            </a>
            <h1 class="page-title">Listing</h1>
          </div>
          <a href="index.html#notifications" class="notif-bell-link" aria-label="Notifications">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
              <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
            </svg>
            <span class="notif-badge-sm" id="notif-badge"></span>
          </a>
        </header>

        <!-- Listing Detail -->
        <div class="detail-card">
          <div class="detail-card-header">
            <h2 class="detail-title">${escapeHtml(listing.title)}</h2>
            <span class="listing-type-badge ${listing.type}">${isOffer ? 'Offer' : 'Need'}</span>
          </div>

          <div class="detail-category">${cat.emoji} ${cat.label}</div>

          ${listing.description ? `<div class="detail-description">${escapeHtml(listing.description)}</div>` : ''}

          ${renderTags(listing.tags)}

          <div class="detail-meta">
            <span class="meta-item">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
              ${areaLabel}
            </span>
            <span class="meta-item">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
              ${escapeHtml(listing.urgency || 'This week')}
            </span>
            <span class="meta-item">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
              ${formatRelativeTime(listing.created_at)}
            </span>
          </div>

          <!-- Author Info -->
          <div class="author-card">
            <div class="author-avatar">${getInitials(author.display_name)}</div>
            <div class="author-details">
              <div class="author-name">${escapeHtml(author.display_name || 'Unknown')}</div>
              <div class="author-member-id">${author.member_id || ''}</div>
              <div class="author-trust">
                <span>${author.exchanges_completed || 0} exchange${(author.exchanges_completed || 0) !== 1 ? 's' : ''}</span>
                <span class="reliability-badge ${band.toLowerCase()}">${band}</span>
                ${renderDegreesBadge(author.id)}
              </div>
            </div>
          </div>
        </div>
      `;

      // Status banner for non-active listings
      if (listing.status !== 'active') {
        html += renderStatusBanner(listing.status, isOwner);
      }

      // Owner view: show edit button and proposals
      if (isOwner) {
        if (listing.status === 'active') {
          html += `
            <div class="own-listing-notice">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
              <span>This is your listing. Exchange proposals from other members will appear below.</span>
            </div>
            <div class="own-listing-actions">
              <button class="btn btn-outline" onclick="showEditForm()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                Edit listing
              </button>
              <button class="btn btn-secondary" onclick="showConfirm('fulfilled')">Mark as fulfilled</button>
              <button class="btn btn-danger" onclick="showConfirm('close')">Close listing</button>
            </div>
          `;
        } else {
          // Non-active: show reopen button
          html += `
            <div class="own-listing-actions">
              <button class="btn btn-primary" onclick="reopenListing()">Reopen listing</button>
            </div>
          `;
        }
        html += '<div id="edit-form-container"></div>';
        html += renderProposalsSection();
      } else {
        // Non-owner: show propose exchange form (only if listing is active)
        if (listing.status === 'active') {
          // Check if current user already has a pending/accepted/completed proposal
          const existingProposal = exchanges.find(ex =>
            ex.proposed_by === currentMember.id &&
            (ex.status === 'proposed' || ex.status === 'accepted' || ex.status === 'completed')
          );

          if (existingProposal) {
            html += renderExistingProposal(existingProposal);
          } else {
            html += renderExchangeForm();
          }
        }
      }

      // Q&A section (visible on all listings)
      html += renderQASection();

      // Confirm dialog container
      html += '<div id="confirm-container"></div>';

      container.innerHTML = html;
    }

    function renderTags(tags) {
      if (!tags || !tags.length) return '';
      return `
        <div class="detail-tags">
          ${tags.map(t => `<span class="detail-tag">${escapeHtml(t)}</span>`).join('')}
        </div>
      `;
    }

    // =====================================================
    // Q&A COMMENTS
    // =====================================================
    function renderComment(c) {
      const isListingAuthor = c.author_id === listing.author_id;
      const isOwn = c.author_id === currentMember.id;
      const initials = (c.author?.display_name || '?').split(' ').map(w => w[0]).join('').slice(0, 2).toUpperCase();
      return `
        <div class="qa-comment ${isListingAuthor ? 'is-author' : ''}" id="comment-${c.id}">
          <div class="qa-avatar">${initials}</div>
          <div class="qa-body">
            <div class="qa-meta">
              <span class="qa-name">${escapeHtml(c.author?.display_name || 'Member')}</span>
              ${isListingAuthor ? '<span class="qa-author-badge">Author</span>' : ''}
              <span class="qa-time">${formatRelativeTime(c.created_at)}</span>
              ${isOwn ? `<button class="qa-delete-btn" onclick="deleteComment('${c.id}')" title="Delete comment"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>` : ''}
            </div>
            <div class="qa-message">${escapeHtml(c.message)}</div>
          </div>
        </div>
      `;
    }

    function renderQASection() {
      const commentList = comments.length > 0
        ? comments.map(c => renderComment(c)).join('')
        : '<div class="qa-empty">No questions yet. Be the first to ask!</div>';

      return `
        <div class="qa-section">
          <h3 class="qa-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
            </svg>
            Questions
            ${comments.length > 0 ? `<span class="qa-count">(${comments.length})</span>` : ''}
          </h3>

          <div class="qa-input-row">
            <textarea class="textarea" id="qa-input" placeholder="Ask a question about this listing..." rows="1" oninput="autoResizeQA(this)"></textarea>
            <button class="qa-send-btn" id="qa-send-btn" onclick="submitComment()" aria-label="Send">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="22" y1="2" x2="11" y2="13"/>
                <polygon points="22 2 15 22 11 13 2 9 22 2"/>
              </svg>
            </button>
          </div>

          <div class="qa-list" id="qa-list">
            ${commentList}
          </div>
        </div>
      `;
    }

    function autoResizeQA(el) {
      el.style.height = 'auto';
      el.style.height = Math.min(el.scrollHeight, 120) + 'px';
    }

    async function submitComment() {
      const input = document.getElementById('qa-input');
      const btn = document.getElementById('qa-send-btn');
      const message = input.value.trim();

      if (!message) {
        input.focus();
        return;
      }

      btn.disabled = true;
      try {
        await createListingComment({
          listing_id: listingId,
          author_id: currentMember.id,
          message: message
        });

        // Notify listing author (unless commenting on own listing)
        if (listing.author_id !== currentMember.id) {
          createNotification({
            member_id: listing.author_id,
            type: 'listing_question',
            title: 'New question on "' + listing.title + '"',
            body: currentMember.display_name + ': ' + message.slice(0, 80),
            link: 'listing.html?id=' + listing.id
          }).catch(e => console.error('Notification error:', e));
        }

        // Reload comments and re-render just the Q&A section
        comments = await getListingComments(listingId);
        const listEl = document.getElementById('qa-list');
        if (listEl) {
          listEl.innerHTML = comments.map(c => renderComment(c)).join('');
        }

        input.value = '';
        input.style.height = 'auto';

        // Scroll to the new comment
        if (listEl) listEl.lastElementChild?.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      } catch (e) {
        console.error('Comment error:', e);
        showToast('Failed to post comment. Please try again.');
      } finally {
        btn.disabled = false;
      }
    }

    async function deleteComment(commentId) {
      if (!confirm('Delete this comment?')) return;
      try {
        const sb = getSupabase();
        const { error } = await sb.from('listing_comments').delete().eq('id', commentId).eq('author_id', currentMember.id);
        if (error) throw error;
        comments = comments.filter(c => c.id !== commentId);
        const el = document.getElementById('comment-' + commentId);
        if (el) el.remove();
        if (comments.length === 0) {
          const listEl = document.getElementById('qa-list');
          if (listEl) listEl.innerHTML = '<div class="qa-empty">No questions yet. Be the first to ask!</div>';
        }
      } catch (e) {
        console.error('Delete comment error:', e);
        showToast('Failed to delete comment.');
      }
    }

    async function withdrawProposal(exchangeId) {
      if (!confirm('Withdraw your proposal?')) return;
      try {
        await cancelExchange(exchangeId, 'Withdrawn by proposer');
        showToast('Proposal withdrawn.');
        // Reload the page to show the form again
        window.location.reload();
      } catch (e) {
        console.error('Withdraw error:', e);
        showToast('Failed to withdraw proposal.');
      }
    }

    function renderExchangeForm() {
      const isOffer = listing.type === 'offer';
      const authorFirst = (listing.author?.display_name || 'This member').split(' ')[0];

      let title, subtitle, roleNote, messagePlaceholder, messageLabel, creditLabel, creditHint, buttonLabel;

      if (isOffer) {
        // Author is OFFERING something — proposer wants to receive it
        title = 'I\'d like this';
        subtitle = `${authorFirst} is offering this. Describe why you're interested and suggest a fair price.`;
        roleNote = `You will pay ${authorFirst} in community credits.`;
        messageLabel = 'Why are you interested?';
        messagePlaceholder = 'e.g., This would be really helpful — I\'m available any day this week.';
        creditLabel = 'Suggested price (credits)';
        creditHint = `How many credits would you pay ${authorFirst} for this?`;
        buttonLabel = 'Send Proposal';
      } else {
        // Author NEEDS something — proposer can provide it
        title = 'I can help with this';
        subtitle = `${authorFirst} needs help. Describe what you can offer and set your price.`;
        roleNote = `${authorFirst} will pay you in community credits.`;
        messageLabel = 'What can you offer?';
        messagePlaceholder = 'e.g., I have what you need and can drop it over tomorrow.';
        creditLabel = 'Your price (credits)';
        creditHint = `How many credits should ${authorFirst} pay for your help?`;
        buttonLabel = 'Offer to Help';
      }

      return `
        <div class="exchange-form-card">
          <h3 class="exchange-form-title">${title}</h3>
          <p class="exchange-form-subtitle">${subtitle}</p>

          <div class="credit-cost">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>
            <span>${roleNote}</span>
          </div>

          <div class="form-group">
            <label class="form-label" for="exchange-desc">${messageLabel} <span style="color: var(--color-status-hold);">*</span></label>
            <textarea class="textarea" id="exchange-desc" placeholder="${messagePlaceholder}" rows="3"></textarea>
          </div>

          <div class="form-group">
            <label class="form-label" for="exchange-credits">${creditLabel} <span style="color: var(--color-status-hold);">*</span></label>
            <input type="number" class="input" id="exchange-credits" value="1" min="1" max="10" step="1" oninput="checkProposalBalance()">
            <p class="form-hint">${creditHint} (1-10)</p>
            <p class="form-hint" style="margin-top: var(--space-1);">Your balance: <strong>${currentBalance ? currentBalance.credits : 0}</strong> credits</p>
            <p class="form-hint" id="balance-warning" style="color: var(--color-status-hold); display: none; margin-top: var(--space-2);"></p>
          </div>

          <button class="btn btn-primary btn-lg btn-block" id="propose-btn" onclick="submitProposal()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
            ${buttonLabel}
          </button>
        </div>
      `;
    }

    function renderExistingProposal(proposal) {
      const statusLabel = proposal.status.charAt(0).toUpperCase() + proposal.status.slice(1);
      const authorFirst = (listing.author?.display_name || 'the other party').split(' ')[0];

      // Determine my confirmation state
      const myRole = proposal.provider_id === currentMember.id ? 'provider' : 'receiver';
      const myConfirmed = myRole === 'provider' ? proposal.provider_confirmed : proposal.receiver_confirmed;
      const theirConfirmed = myRole === 'provider' ? proposal.receiver_confirmed : proposal.provider_confirmed;

      // Build the accepted-state block
      let acceptedHtml = '';
      if (proposal.status === 'accepted') {
        // Contact info
        acceptedHtml += `
          <div class="proposal-contact" style="margin-top: var(--space-3);">
            <div class="proposal-contact-label">Contact ${escapeHtml(listing.author?.display_name || 'the listing author')}</div>
            ${listing.author?.email ? `<div class="proposal-contact-row">
              <a href="mailto:${escapeHtml(listing.author.email)}" class="proposal-contact-link">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                ${escapeHtml(listing.author.email)}
              </a>
            </div>` : ''}
            ${listing.author?.phone ? `<div class="proposal-contact-row">
              <a href="tel:${escapeHtml(listing.author.phone)}" class="proposal-contact-link">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                ${escapeHtml(listing.author.phone)}
              </a>
            </div>` : ''}
          </div>`;

        if (myConfirmed) {
          // I already confirmed — waiting on the other party
          acceptedHtml += `
            <div style="margin-top: var(--space-3); padding: var(--space-3); background: var(--color-bg-warm); border-radius: var(--radius-md); font-size: var(--font-size-sm); color: var(--color-text-secondary);">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: -3px; margin-right: 4px;"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
              You've confirmed. Waiting for ${escapeHtml(authorFirst)} to confirm.
            </div>`;
        } else {
          // I haven't confirmed yet — show link to exchanges page
          acceptedHtml += `
            <a href="exchanges.html" class="proposal-exchange-link">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
              Confirm &amp; complete on Exchanges page
            </a>`;
        }
      }

      // Completed state
      let completedHtml = '';
      if (proposal.status === 'completed') {
        completedHtml = `
          <div style="margin-top: var(--space-3); padding: var(--space-3); background: var(--color-bg-warm); border-radius: var(--radius-md); font-size: var(--font-size-sm); color: var(--color-primary);">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: -3px; margin-right: 4px;"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
            Exchange complete — credits transferred.
          </div>`;
      }

      return `
        <div class="exchange-form-card">
          <h3 class="exchange-form-title">Your Proposal</h3>
          <p class="exchange-form-subtitle">You've already submitted a proposal for this listing.</p>

          <div class="proposal-item" style="margin-top: var(--space-4);">
            <div class="proposal-header">
              <div>
                <div class="proposal-from">Your proposal</div>
              </div>
              <span class="proposal-status ${proposal.status}">${statusLabel}</span>
            </div>
            ${proposal.description ? `<div class="proposal-desc">${escapeHtml(proposal.description)}</div>` : ''}
            <div class="proposal-meta">
              <span>${proposal.credits || 1} credit${(proposal.credits || 1) !== 1 ? 's' : ''}</span>
              <span>Proposed ${formatRelativeTime(proposal.proposed_at || proposal.created_at)}</span>
            </div>
            ${proposal.status === 'proposed' ? `
              <button class="btn btn-ghost" style="margin-top: var(--space-3); color: var(--color-status-hold); font-size: var(--font-size-sm);" onclick="withdrawProposal('${proposal.id}')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                Withdraw Proposal
              </button>
            ` : ''}
            ${acceptedHtml}
            ${completedHtml}
          </div>
        </div>
      `;
    }

    function renderProposalsSection() {
      const activeExchanges = exchanges.filter(ex => ex.status !== 'cancelled');

      let html = `
        <div class="proposals-section">
          <h3 class="proposals-title">
            Exchange Proposals
            ${activeExchanges.length > 0 ? `<span class="proposals-count">${activeExchanges.length}</span>` : ''}
          </h3>
      `;

      if (exchanges.length === 0) {
        html += `
          <div class="no-proposals">
            <p>No proposals yet.</p>
            <p style="margin-top: var(--space-2);">When a neighbour is interested, their proposal will appear here.</p>
          </div>
        `;
      } else {
        html += exchanges.map(ex => {
          const proposer = getProposerInfo(ex);
          const statusLabel = ex.status.charAt(0).toUpperCase() + ex.status.slice(1);

          let itemHtml = `
            <div class="proposal-item" data-exchange-id="${ex.id}">
              <div class="proposal-header">
                <div>
                  <div class="proposal-from">${escapeHtml(proposer.name)}</div>
                  <div class="proposal-from-id">${proposer.memberId}</div>
                </div>
                <span class="proposal-status ${ex.status}">${statusLabel}</span>
              </div>
              ${ex.description ? `<div class="proposal-desc">${escapeHtml(ex.description)}</div>` : ''}
              <div class="proposal-meta">
                <span>${ex.credits || 1} credit${(ex.credits || 1) !== 1 ? 's' : ''}</span>
                <span>Proposed ${formatRelativeTime(ex.proposed_at || ex.created_at)}</span>
              </div>
          `;

          // Accept/Decline buttons for proposed exchanges
          if (ex.status === 'proposed') {
            itemHtml += `
              <div class="proposal-actions">
                <button class="btn btn-primary" onclick="handleAcceptProposal('${ex.id}', this)">Accept</button>
                <button class="btn btn-danger" onclick="handleDeclineProposal('${ex.id}', this)">Decline</button>
              </div>
            `;
          }

          // Contact info for accepted/completed exchanges
          if (ex.status === 'accepted' || ex.status === 'completed') {
            itemHtml += renderProposalContact(proposer, ex);
          }

          // Link to exchanges page for accepted exchanges
          if (ex.status === 'accepted') {
            itemHtml += `
              <a href="exchanges.html" class="proposal-exchange-link">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
                Confirm &amp; complete on Exchanges page
              </a>
            `;
          }

          itemHtml += `</div>`;
          return itemHtml;
        }).join('');
      }

      html += `</div>`;
      return html;
    }

    function renderProposalContact(proposer, exchange) {
      // Find the counterparty (the person who is not the listing author)
      const counterparty = exchange.provider?.id !== listing.author_id ? exchange.provider : exchange.receiver;
      if (!counterparty || !counterparty.email) return '';

      let html = `<div class="proposal-contact">`;
      html += `<div class="proposal-contact-label">Contact ${escapeHtml(counterparty.display_name)}</div>`;
      html += `<div class="proposal-contact-row">
        <a href="mailto:${escapeHtml(counterparty.email)}" class="proposal-contact-link">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
          ${escapeHtml(counterparty.email)}
        </a>
      </div>`;
      if (counterparty.phone) {
        html += `<div class="proposal-contact-row">
          <a href="tel:${escapeHtml(counterparty.phone)}" class="proposal-contact-link">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
            ${escapeHtml(counterparty.phone)}
          </a>
        </div>`;
      }
      html += `</div>`;
      return html;
    }

    // =====================================================
    // PROPOSAL ACTIONS
    // =====================================================
    async function handleAcceptProposal(exchangeId, btn) {
      btn.disabled = true;
      btn.textContent = 'Accepting...';

      try {
        await acceptExchange(exchangeId);

        // Notify the proposer
        const ex = exchanges.find(e => e.id === exchangeId);
        if (ex) {
          const proposerId = ex.proposed_by || (ex.provider_id === listing.author_id ? ex.receiver_id : ex.provider_id);
          createNotification({
            member_id: proposerId,
            type: 'proposal_accepted',
            title: 'Your proposal on "' + listing.title + '" was accepted',
            body: 'Contact details are now visible',
            link: 'exchanges.html'
          }).catch(e => console.error('Notification error:', e));
        }

        showToast('Exchange accepted! Contact info is now visible.');
        exchanges = await getExchangesForListing(listingId);
        renderListing();
      } catch (e) {
        console.error('Accept error:', e);
        showToast('Failed to accept. Please try again.');
        btn.disabled = false;
        btn.textContent = 'Accept';
      }
    }

    function renderStatusBanner(status, isOwner) {
      const banners = {
        cancelled: {
          icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',
          title: 'Listing closed',
          text: isOwner ? 'You closed this listing.' : 'This listing has been closed by the author.'
        },
        completed: {
          icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',
          title: 'Listing fulfilled',
          text: isOwner ? 'You marked this listing as fulfilled.' : 'This exchange has been completed.'
        },
        expired: {
          icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>',
          title: 'Listing expired',
          text: isOwner ? 'This listing has expired. You can reopen it.' : 'This listing has expired.'
        },
        matched: {
          icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>',
          title: 'Exchange in progress',
          text: 'An exchange has been accepted for this listing.'
        }
      };
      const b = banners[status] || banners.cancelled;
      return `
        <div class="listing-status-banner ${status}">
          ${b.icon}
          <div class="listing-status-text">
            <strong>${b.title}</strong>
            ${b.text}
          </div>
        </div>
      `;
    }

    // =====================================================
    // LISTING LIFECYCLE
    // =====================================================
    function showConfirm(action) {
      const config = {
        close: {
          title: 'Close this listing?',
          text: 'It will no longer appear in the feed. You can reopen it later.',
          confirmLabel: 'Close listing',
          confirmClass: 'btn-danger',
          handler: 'closeListing()'
        },
        fulfilled: {
          title: 'Mark as fulfilled?',
          text: 'This means the exchange happened successfully. The listing will be removed from the feed.',
          confirmLabel: 'Mark as fulfilled',
          confirmClass: 'btn-primary',
          handler: 'fulfilListing()'
        }
      };
      const c = config[action];
      document.getElementById('confirm-container').innerHTML = `
        <div class="confirm-overlay" onclick="if(event.target===this)dismissConfirm()">
          <div class="confirm-dialog">
            <h3>${c.title}</h3>
            <p>${c.text}</p>
            <div class="confirm-dialog-actions">
              <button class="btn btn-ghost" onclick="dismissConfirm()">Cancel</button>
              <button class="btn ${c.confirmClass}" onclick="${c.handler}">${c.confirmLabel}</button>
            </div>
          </div>
        </div>
      `;
    }

    function dismissConfirm() {
      document.getElementById('confirm-container').innerHTML = '';
    }

    async function closeListing() {
      dismissConfirm();
      try {
        await updateListing(listing.id, { status: 'cancelled' });
        listing = await getListingById(listing.id);
        renderListing();
        showToast('Listing closed.');
      } catch (e) {
        console.error('Close listing error:', e);
        showToast('Failed to close listing. Please try again.');
      }
    }

    async function fulfilListing() {
      dismissConfirm();
      try {
        await updateListing(listing.id, { status: 'completed' });
        listing = await getListingById(listing.id);
        renderListing();
        showToast('Listing marked as fulfilled!');
      } catch (e) {
        console.error('Fulfil listing error:', e);
        showToast('Failed to update listing. Please try again.');
      }
    }

    async function reopenListing() {
      try {
        const newExpiry = new Date();
        newExpiry.setDate(newExpiry.getDate() + 30);
        await updateListing(listing.id, { status: 'active', expires_at: newExpiry.toISOString() });
        listing = await getListingById(listing.id);
        renderListing();
        showToast('Listing reopened for 30 days.');
      } catch (e) {
        console.error('Reopen listing error:', e);
        showToast('Failed to reopen listing. Please try again.');
      }
    }

    async function handleDeclineProposal(exchangeId, btn) {
      btn.disabled = true;
      btn.textContent = 'Declining...';

      try {
        await cancelExchange(exchangeId);

        // Notify the proposer
        const ex = exchanges.find(e => e.id === exchangeId);
        if (ex) {
          const proposerId = ex.proposed_by || (ex.provider_id === listing.author_id ? ex.receiver_id : ex.provider_id);
          createNotification({
            member_id: proposerId,
            type: 'proposal_declined',
            title: 'Your proposal on "' + listing.title + '" was declined',
            link: 'index.html'
          }).catch(e => console.error('Notification error:', e));
        }

        showToast('Proposal declined.');
        exchanges = await getExchangesForListing(listingId);
        renderListing();
      } catch (e) {
        console.error('Decline error:', e);
        showToast('Failed to decline. Please try again.');
        btn.disabled = false;
        btn.textContent = 'Decline';
      }
    }

    function renderError(title, message) {
      document.getElementById('main-container').innerHTML = `
        <header class="page-header">
          <a href="index.html" class="back-link" aria-label="Back to community board">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="19" y1="12" x2="5" y2="12"/>
              <polyline points="12 19 5 12 12 5"/>
            </svg>
          </a>
          <h1 class="page-title">Listing</h1>
        </header>
        <div class="error-state">
          <div class="error-state-icon">🍂</div>
          <div class="error-state-title">${escapeHtml(title)}</div>
          <p class="error-state-text">${escapeHtml(message)}</p>
          <a href="index.html" class="btn btn-primary">Back to community board</a>
        </div>
      `;
    }

    // =====================================================
    // PROPOSE EXCHANGE
    // =====================================================
    function checkProposalBalance() {
      const warning = document.getElementById('balance-warning');
      if (!warning || !currentBalance) return;

      const credits = parseInt(document.getElementById('exchange-credits').value, 10) || 0;
      const isOffer = listing.type === 'offer';

      // If proposer is the receiver (listing is an offer), they'll spend credits
      if (isOffer) {
        const resultingBalance = currentBalance.credits - credits;
        if (resultingBalance < -10) {
          warning.textContent = 'This would put your balance at ' + resultingBalance + '. The exchange may fail at completion.';
          warning.style.display = 'block';
          return;
        }
      }
      warning.style.display = 'none';
    }

    async function submitProposal() {
      const descEl = document.getElementById('exchange-desc');
      const creditsEl = document.getElementById('exchange-credits');
      const btn = document.getElementById('propose-btn');

      const description = descEl.value.trim();
      const credits = parseInt(creditsEl.value, 10);

      if (!description) {
        showToast('Please describe your proposal');
        descEl.focus();
        return;
      }

      if (!credits || credits < 1 || credits > 10) {
        showToast('Credits must be between 1 and 10');
        creditsEl.focus();
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Submitting...';

      try {
        const isOffer = listing.type === 'offer';

        const exchangeData = {
          listing_id: listing.id,
          provider_id: isOffer ? listing.author_id : currentMember.id,
          receiver_id: isOffer ? currentMember.id : listing.author_id,
          credits: credits,
          description: description,
          category: listing.category,
          proposed_by: currentMember.id,
          status: 'proposed'
        };

        await proposeExchange(exchangeData);

        // Notify listing author
        createNotification({
          member_id: listing.author_id,
          type: 'proposal_received',
          title: 'New proposal on "' + listing.title + '"',
          body: currentMember.display_name + ' proposed an exchange',
          link: 'listing.html?id=' + listing.id
        }).catch(e => console.error('Notification error:', e));

        showToast('Proposal submitted! The listing author will be notified.');

        // Reload exchanges and re-render
        exchanges = await getExchangesForListing(listingId);
        renderListing();
      } catch (e) {
        console.error('Proposal error:', e);
        showToast('Failed to submit proposal. Please try again.');
        btn.disabled = false;
        btn.innerHTML = `
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
          Propose Exchange
        `;
      }
    }

    // =====================================================
    // EDIT LISTING
    // =====================================================
    let editTags = [];

    function showEditForm() {
      editTags = [...(listing.tags || [])];
      const container = document.getElementById('edit-form-container');

      // Build options outside the template literal
      const categoryOptions = CATEGORIES.map(cat =>
        '<option value="' + cat.id + '"' + (listing.category === cat.id ? ' selected' : '') + '>' +
        cat.emoji + ' ' + cat.label + '</option>'
      ).join('');

      const areaOptions = AREA_OPTIONS.map(opt =>
        '<option value="' + opt.id + '"' + (listing.area === opt.id ? ' selected' : '') + '>' +
        opt.label + ' — ' + opt.description + '</option>'
      ).join('');

      container.innerHTML = `
        <div class="edit-form-card" id="edit-form">
          <h3 style="font-family:var(--font-family-heading);font-size:var(--font-size-lg);font-weight:var(--font-weight-semibold);margin-bottom:var(--space-5);">Edit Listing</h3>

          <div class="form-group">
            <label class="form-label" for="edit-title">Title</label>
            <input type="text" class="input" id="edit-title" value="${escapeHtml(listing.title)}" placeholder="Listing title">
          </div>

          <div class="form-group">
            <label class="form-label" for="edit-description">Description</label>
            <textarea class="textarea" id="edit-description" rows="4" placeholder="Describe what you're offering or need...">${escapeHtml(listing.description || '')}</textarea>
          </div>

          <div class="form-group">
            <label class="form-label" for="edit-category">Category</label>
            <select class="select" id="edit-category">
              ${categoryOptions}
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Tags</label>
            <div class="chips-container" id="edit-tag-chips" onclick="document.getElementById('edit-tag-input').focus()">
              ${renderEditTagChips()}
              <input type="text" class="chips-input" id="edit-tag-input"
                placeholder="${editTags.length === 0 ? 'Type a tag then press comma or Enter' : 'Add another...'}"
                onkeydown="handleEditTagInput(event)"
                oninput="handleEditTagComma(event)">
            </div>
          </div>

          <div class="form-group">
            <label class="form-label" for="edit-area">Area</label>
            <select class="select" id="edit-area">
              ${areaOptions}
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Urgency</label>
            <select class="select" id="edit-urgency">
              <option value="Today" ${listing.urgency === 'Today' ? 'selected' : ''}>Today</option>
              <option value="This week" ${listing.urgency === 'This week' ? 'selected' : ''}>This week</option>
              <option value="Flexible" ${listing.urgency === 'Flexible' ? 'selected' : ''}>Flexible</option>
            </select>
          </div>

          <div class="edit-btn-row">
            <button class="btn btn-ghost" onclick="cancelEdit()">Cancel</button>
            <button class="btn btn-primary" id="save-edit-btn" onclick="saveEdit()">Save Changes</button>
          </div>
        </div>
      `;

      container.scrollIntoView({ behavior: 'smooth' });
    }

    function renderEditTagChips() {
      return editTags.map((tag, i) =>
        `<span class="chip">${escapeHtml(tag)}<button class="chip-remove" onclick="removeEditTag(${i})">&times;</button></span>`
      ).join('');
    }

    function refreshEditTagChips() {
      const container = document.getElementById('edit-tag-chips');
      if (!container) return;
      const input = document.getElementById('edit-tag-input');
      const val = input ? input.value : '';
      container.innerHTML = renderEditTagChips() +
        `<input type="text" class="chips-input" id="edit-tag-input"
          placeholder="${editTags.length === 0 ? 'Type a tag then press comma or Enter' : 'Add another...'}"
          onkeydown="handleEditTagInput(event)" oninput="handleEditTagComma(event)"
          value="${escapeHtml(val)}">`;
      const newInput = document.getElementById('edit-tag-input');
      if (newInput) newInput.focus();
    }

    function addEditTag(text) {
      const tag = text.trim();
      if (!tag) return;
      if (editTags.includes(tag)) return;
      editTags.push(tag);
      refreshEditTagChips();
    }

    function removeEditTag(index) {
      editTags.splice(index, 1);
      refreshEditTagChips();
    }

    function handleEditTagInput(e) {
      if (e.key === 'Enter' || e.key === ',') {
        e.preventDefault();
        addEditTag(e.target.value);
        e.target.value = '';
      } else if (e.key === 'Backspace' && e.target.value === '' && editTags.length > 0) {
        removeEditTag(editTags.length - 1);
      }
    }

    function handleEditTagComma(e) {
      const val = e.target.value;
      if (val.includes(',')) {
        val.split(',').forEach(p => addEditTag(p));
        e.target.value = '';
      }
    }

    function cancelEdit() {
      document.getElementById('edit-form-container').innerHTML = '';
    }

    async function saveEdit() {
      const title = document.getElementById('edit-title').value.trim();
      const description = document.getElementById('edit-description').value.trim();
      const category = document.getElementById('edit-category').value;
      const area = document.getElementById('edit-area').value;
      const urgency = document.getElementById('edit-urgency').value;

      if (!title) { showToast('Please enter a title'); return; }

      const btn = document.getElementById('save-edit-btn');
      btn.disabled = true;
      btn.textContent = 'Saving...';

      try {
        listing = await updateListing(listing.id, {
          title,
          description: description || null,
          category,
          tags: editTags,
          area,
          urgency
        });

        // Re-fetch full listing with author join
        listing = await getListingById(listing.id);
        cancelEdit();
        renderListing();
        showToast('Listing updated!');
      } catch (e) {
        console.error('Save listing error:', e);
        showToast('Failed to save. Please try again.');
        btn.disabled = false;
        btn.textContent = 'Save Changes';
      }
    }

    // =====================================================
    // HELPERS
    // =====================================================
    function escapeHtml(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function getInitials(name) {
      if (!name) return '?';
      const parts = name.trim().split(/\s+/);
      if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
      return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
    }

    function getAreaLabel(area) {
      switch (area) {
        case 'neighbourhood': return 'Neighbourhood';
        case 'village': return 'Village';
        case 'nearby': return 'Nearby';
        default: return area || 'Village';
      }
    }

    function renderDegreesBadge(authorId) {
      if (!currentMember || !allMembers.length || !authorId) return '';
      if (authorId === currentMember.id) return '';
      const degrees = getDegreesFromUser(allMembers, currentMember.id, authorId);
      if (degrees < 0) return '';
      const label = degrees === 1 ? '1 step' : degrees + ' steps';
      return `
        <span class="degrees-badge">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><polyline points="17 11 19 13 23 9"/></svg>
          ${label}
        </span>
      `;
    }

    function getProposerInfo(exchange) {
      // The proposer is the person who is NOT the listing author
      // (or more precisely, the person identified by proposed_by)
      const isProvider = exchange.provider && exchange.provider.id !== listing.author_id;
      const isReceiver = exchange.receiver && exchange.receiver.id !== listing.author_id;

      if (exchange.proposed_by === exchange.provider?.id && exchange.provider) {
        return { name: exchange.provider.display_name || 'Unknown', memberId: exchange.provider.member_id || '' };
      }
      if (exchange.proposed_by === exchange.receiver?.id && exchange.receiver) {
        return { name: exchange.receiver.display_name || 'Unknown', memberId: exchange.receiver.member_id || '' };
      }

      // Fallback: return whichever side is not the author
      if (isProvider) {
        return { name: exchange.provider.display_name || 'Unknown', memberId: exchange.provider.member_id || '' };
      }
      if (isReceiver) {
        return { name: exchange.receiver.display_name || 'Unknown', memberId: exchange.receiver.member_id || '' };
      }

      return { name: 'Unknown', memberId: '' };
    }

    // =====================================================
    // INIT
    // =====================================================
    init();
  </script>
</body>
</html>
