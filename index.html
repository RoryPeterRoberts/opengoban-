<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="robots" content="noindex, nofollow">
  <title>Community Connect ‚Äî Neighbours helping neighbours</title>
  <link rel="stylesheet" href="theme.css">
  <style>
    /* Balance Chip */
    .balance-chip {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-4);
      background: linear-gradient(135deg, var(--color-primary-bg) 0%, var(--color-accent-bg) 100%);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-full);
      font-family: var(--font-family-heading);
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-semibold);
      color: var(--color-primary);
      cursor: pointer;
      transition: all var(--transition-base);
      box-shadow: var(--shadow-sm);
      min-height: 40px;
    }

    .balance-chip:hover {
      background: var(--color-primary);
      border-color: var(--color-primary);
      color: white;
      transform: scale(1.05);
    }

    .balance-chip svg { width: 18px; height: 18px; }
    .balance-chip-value { font-weight: var(--font-weight-bold); font-size: var(--font-size-base); }

    /* Header */
    .app-header-with-balance {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      padding: var(--space-5) var(--space-4) var(--space-4);
      margin-bottom: var(--space-2);
      gap: var(--space-1);
    }

    .app-header-with-balance .app-logo { justify-content: center; margin-bottom: 0; }
    .app-header-with-balance .app-tagline { text-align: center; margin: 0; font-size: var(--font-size-sm); }

    .user-identity-section {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      gap: var(--space-3);
      margin-top: var(--space-2);
      padding-top: var(--space-2);
      border-top: 1px solid var(--color-border-light);
      width: 100%;
      max-width: 280px;
    }

    .user-identity-strip {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      font-size: var(--font-size-xs);
      color: var(--color-text-muted);
    }

    .user-identity-strip a { color: var(--color-text-muted); text-decoration: none; }
    .user-identity-strip a:hover { color: var(--color-primary); }
    .user-name { font-weight: var(--font-weight-medium); color: var(--color-text-secondary); }
    .member-id { font-family: var(--font-family-mono, monospace); color: var(--color-text-muted); font-size: var(--font-size-xs); }

    /* Reliability Badge */
    .reliability-badge {
      display: inline-flex;
      align-items: center;
      padding: 2px var(--space-2);
      border-radius: var(--radius-sm);
      font-size: 10px;
      font-weight: var(--font-weight-semibold);
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .reliability-badge.low { background: var(--color-bg-muted); color: var(--color-text-muted); }
    .reliability-badge.medium { background: var(--color-status-review-bg); color: var(--color-status-review); }
    .reliability-badge.high { background: var(--color-status-accepted-bg); color: var(--color-status-accepted); }

    /* Author Strip */
    .author-strip {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-3);
      background: var(--color-bg-warm);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-3);
    }

    .author-info { display: flex; flex-direction: column; gap: 2px; }
    .author-name { font-weight: var(--font-weight-medium); color: var(--color-text); font-size: var(--font-size-sm); }
    .author-member-id { font-family: var(--font-family-mono, monospace); font-size: var(--font-size-xs); color: var(--color-text-muted); }

    /* Balance Modal */
    .balance-modal-content { text-align: center; }
    .balance-display { padding: var(--space-6) 0; }
    .balance-amount { font-family: var(--font-family-heading); font-size: 4rem; font-weight: var(--font-weight-bold); color: var(--color-primary); line-height: 1; }
    .balance-label { font-size: var(--font-size-sm); color: var(--color-text-muted); margin-top: var(--space-2); text-transform: uppercase; letter-spacing: 0.05em; }
    .balance-explanation { background: var(--color-secondary-bg); border-radius: var(--radius-md); padding: var(--space-4); margin: var(--space-4) 0; text-align: left; }
    .balance-explanation p { font-size: var(--font-size-sm); color: var(--color-text-secondary); line-height: var(--line-height-relaxed); margin: 0; }
    .balance-explanation strong { color: var(--color-text); }

    .adjustments-section { margin-top: var(--space-6); text-align: left; }
    .adjustments-title { font-size: var(--font-size-xs); font-weight: var(--font-weight-semibold); color: var(--color-text-muted); text-transform: uppercase; letter-spacing: 0.03em; margin-bottom: var(--space-3); }
    .adjustment-list { display: flex; flex-direction: column; gap: var(--space-2); }
    .adjustment-item { display: flex; justify-content: space-between; align-items: center; padding: var(--space-3); background: var(--color-bg-card); border: 1px solid var(--color-border-light); border-radius: var(--radius-md); }
    .adjustment-info { flex: 1; min-width: 0; }
    .adjustment-reason { font-size: var(--font-size-sm); color: var(--color-text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .adjustment-date { font-size: var(--font-size-xs); color: var(--color-text-muted); margin-top: 2px; }
    .adjustment-amount { font-weight: var(--font-weight-semibold); font-size: var(--font-size-sm); padding: var(--space-1) var(--space-2); border-radius: var(--radius-sm); }
    .adjustment-amount.positive { color: var(--color-status-accepted); background: var(--color-status-accepted-bg); }
    .adjustment-amount.negative { color: var(--color-status-hold); background: var(--color-status-hold-bg); }
    .no-adjustments { text-align: center; padding: var(--space-4); color: var(--color-text-muted); font-size: var(--font-size-sm); }

    /* Balance Delta */
    .balance-delta { display: inline-flex; align-items: center; gap: var(--space-1); padding: var(--space-2) var(--space-3); border-radius: var(--radius-md); font-size: var(--font-size-sm); font-weight: var(--font-weight-semibold); }
    .balance-delta.credit { background: var(--color-status-accepted-bg); color: var(--color-status-accepted); }
    .balance-delta.debit { background: var(--color-status-hold-bg); color: var(--color-status-hold); }
    .balance-delta svg { width: 14px; height: 14px; }
    .balance-delta-note { font-size: var(--font-size-xs); color: var(--color-text-muted); margin-top: var(--space-2); text-align: center; }

    /* Community Feed */
    .feed-section { margin-bottom: var(--space-6); }
    .feed-title { font-family: var(--font-family-heading); font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); color: var(--color-text); margin-bottom: var(--space-4); display: flex; align-items: center; gap: var(--space-2); }
    .feed-title svg { width: 20px; height: 20px; color: var(--color-primary); }

    .listing-card {
      background: var(--color-bg-card);
      border: 1px solid var(--color-border-light);
      border-radius: var(--radius-lg);
      padding: var(--space-4);
      margin-bottom: var(--space-3);
      box-shadow: var(--shadow-sm);
      transition: all var(--transition-fast);
    }

    .listing-card:hover { box-shadow: var(--shadow-md); }

    .listing-type-badge {
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      padding: var(--space-1) var(--space-2);
      border-radius: var(--radius-sm);
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-semibold);
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .listing-type-badge.offer { background: var(--color-status-accepted-bg); color: var(--color-status-accepted); }
    .listing-type-badge.need { background: var(--color-status-review-bg); color: var(--color-status-review); }

    .listing-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--space-3); }
    .listing-title { font-weight: var(--font-weight-semibold); color: var(--color-text); font-size: var(--font-size-base); margin-bottom: var(--space-1); }
    .listing-category { font-size: var(--font-size-sm); color: var(--color-text-secondary); }
    .listing-desc { font-size: var(--font-size-sm); color: var(--color-text-secondary); line-height: var(--line-height-relaxed); margin-bottom: var(--space-3); }
    .listing-meta { display: flex; align-items: center; gap: var(--space-3); font-size: var(--font-size-xs); color: var(--color-text-muted); flex-wrap: wrap; }
    .listing-meta-item { display: inline-flex; align-items: center; gap: var(--space-1); }
    .listing-meta-item svg { width: 14px; height: 14px; }

    .listing-author { display: flex; align-items: center; gap: var(--space-2); padding-top: var(--space-3); margin-top: var(--space-3); border-top: 1px solid var(--color-border-light); font-size: var(--font-size-xs); color: var(--color-text-muted); }

    .empty-feed { text-align: center; padding: var(--space-8); color: var(--color-text-muted); }
    .empty-feed-icon { font-size: 3rem; margin-bottom: var(--space-4); }
    .empty-feed-title { font-family: var(--font-family-heading); font-size: var(--font-size-lg); color: var(--color-text); margin-bottom: var(--space-2); }

    /* Loading */
    .loading-state { text-align: center; padding: var(--space-12) var(--space-5); }
    .loading-spinner-lg { width: 40px; height: 40px; border: 3px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto var(--space-4); }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Area Tag */
    .area-tag { display: inline-flex; align-items: center; gap: var(--space-1); background: var(--color-bg-muted); color: var(--color-text-muted); padding: var(--space-1) var(--space-2); border-radius: var(--radius-sm); font-size: var(--font-size-xs); }
    .area-tag svg { width: 12px; height: 12px; }

    /* Safety Warning */
    .safety-warning { background: var(--color-status-hold-bg); border: 2px solid rgba(194, 65, 12, 0.3); border-radius: var(--radius-lg); padding: var(--space-4); margin: var(--space-4) 0; display: none; }
    .safety-warning.visible { display: block; }
    .safety-warning-header { display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-3); }
    .safety-warning-icon { width: 24px; height: 24px; color: var(--color-status-hold); }
    .safety-warning-title { font-size: var(--font-size-sm); font-weight: var(--font-weight-semibold); color: var(--color-status-hold); }
    .safety-warning-text { font-size: var(--font-size-sm); color: var(--color-text-secondary); line-height: var(--line-height-relaxed); margin-bottom: var(--space-3); }
    .safety-checkbox { display: flex; align-items: flex-start; gap: var(--space-3); padding: var(--space-3); background: var(--color-bg-card); border-radius: var(--radius-md); cursor: pointer; }
    .safety-checkbox input { width: 20px; height: 20px; flex-shrink: 0; margin-top: 2px; accent-color: var(--color-primary); }
    .safety-checkbox-label { font-size: var(--font-size-sm); color: var(--color-text); line-height: var(--line-height-relaxed); }

    /* Area Selection */
    .area-select { display: flex; flex-direction: column; gap: var(--space-2); }
    .area-option { display: flex; align-items: center; padding: var(--space-3); background: var(--color-bg-card); border: 2px solid var(--color-border); border-radius: var(--radius-md); cursor: pointer; transition: all var(--transition-fast); }
    .area-option:hover { border-color: var(--color-primary); }
    .area-option.selected { border-color: var(--color-primary); background: var(--color-primary-bg); }
    .area-option input { position: absolute; opacity: 0; pointer-events: none; }
    .area-option-radio { width: 18px; height: 18px; border: 2px solid var(--color-border); border-radius: 50%; margin-right: var(--space-3); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .area-option.selected .area-option-radio { border-color: var(--color-primary); }
    .area-option.selected .area-option-radio::after { content: ''; width: 10px; height: 10px; background: var(--color-primary); border-radius: 50%; }
    .area-option-label { font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); color: var(--color-text); }
    .area-option-desc { font-size: var(--font-size-xs); color: var(--color-text-muted); }

    /* Pilot Badge */
    .pilot-badge { display: inline-flex; align-items: center; gap: var(--space-1); background: var(--color-status-review-bg); color: var(--color-status-review); padding: var(--space-1) var(--space-2); border-radius: var(--radius-sm); font-size: var(--font-size-xs); font-weight: var(--font-weight-semibold); text-transform: uppercase; letter-spacing: 0.03em; }
    .pilot-note { font-size: var(--font-size-xs); color: var(--color-text-muted); margin-top: var(--space-2); }

    /* Tab filters */
    .feed-tabs { display: flex; gap: var(--space-2); margin-bottom: var(--space-4); }
    .feed-tab { padding: var(--space-2) var(--space-4); border-radius: var(--radius-full); font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); border: 1px solid var(--color-border); background: var(--color-bg-card); color: var(--color-text-secondary); cursor: pointer; transition: all var(--transition-fast); }
    .feed-tab:hover { border-color: var(--color-primary); color: var(--color-primary); }
    .feed-tab.active { background: var(--color-primary); border-color: var(--color-primary); color: white; }

    /* Feedback FAB */
    .feedback-fab { position: fixed; bottom: var(--space-4); right: var(--space-4); display: flex; align-items: center; gap: var(--space-2); background: var(--color-primary); color: white; padding: var(--space-3) var(--space-4); border-radius: var(--radius-full); border: none; cursor: pointer; box-shadow: var(--shadow-lg); z-index: 1000; font-family: var(--font-family); font-size: var(--font-size-sm); font-weight: var(--font-weight-semibold); transition: all var(--transition-fast); }
    .feedback-fab:hover { background: var(--color-primary-dark); transform: translateY(-2px); }
    .feedback-fab svg { width: 18px; height: 18px; }

    /* Feedback Modal */
    .feedback-type-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-3); margin-bottom: var(--space-4); }
    .feedback-type-option { display: flex; flex-direction: column; align-items: center; padding: var(--space-4); background: var(--color-bg-warm); border: 2px solid var(--color-border); border-radius: var(--radius-md); cursor: pointer; transition: all var(--transition-fast); }
    .feedback-type-option:hover { border-color: var(--color-secondary); }
    .feedback-type-option.selected { border-color: var(--color-primary); background: var(--color-primary-bg); }
    .feedback-type-option input { position: absolute; opacity: 0; pointer-events: none; }
    .feedback-type-emoji { font-size: 1.5rem; margin-bottom: var(--space-2); }
    .feedback-type-label { font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); color: var(--color-text); }
    .feedback-type-desc { font-size: var(--font-size-xs); color: var(--color-text-muted); }

    /* Sign out link */
    .signout-link { color: var(--color-text-muted); font-size: var(--font-size-xs); text-decoration: none; cursor: pointer; }
    .signout-link:hover { color: var(--color-status-hold); }

    /* Degrees badge */
    .degrees-badge { display: inline-flex; align-items: center; gap: 3px; padding: 2px var(--space-2); border-radius: var(--radius-sm); font-size: 10px; font-weight: var(--font-weight-semibold); background: var(--color-primary-bg); color: var(--color-primary); }
    .degrees-badge svg { width: 12px; height: 12px; }
  </style>
</head>
<body>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script>
  <script src="js/auth.js"></script>

  <!-- App shell - content injected by JS -->
  <div id="app">
    <div class="loading-state" style="min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center;">
      <div class="loading-spinner-lg"></div>
      <p style="color: var(--color-text-muted);">Loading Community Connect...</p>
    </div>
  </div>

  <!-- ============================================================
       SCREEN 0: HOME
       ============================================================ -->
  <div id="screen-home" class="screen" style="display:none;">
    <div class="container">
      <header class="app-header-with-balance">
        <div class="app-logo">
          <div class="app-logo-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
              <polyline points="9 22 9 12 15 12 15 22"/>
            </svg>
          </div>
          <span class="app-logo-text">Community Connect</span>
        </div>
        <p class="app-tagline">Neighbours helping neighbours.</p>
        <div class="user-identity-section">
          <div class="user-identity-strip">
            <a href="profile.html" class="user-name" id="header-user-name">You</a>
            <span>&middot;</span>
            <span class="member-id" id="header-member-id">CC-0001</span>
          </div>
          <button class="balance-chip" onclick="openBalanceModal()" aria-label="View balance">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <path d="M12 6v6l4 2"/>
            </svg>
            <span class="balance-chip-value" id="balance-chip-value">5</span>
          </button>
        </div>
      </header>

      <!-- Welcome Card -->
      <div class="card card-welcome mb-6">
        <h2 class="card-title">Welcome to the village exchange</h2>
        <p class="card-subtitle mt-2">Share what you have. Ask for what you need.</p>
        <div style="margin-top: var(--space-3);">
          <span class="pilot-badge">Pilot Programme</span>
          <p class="pilot-note">Trial period ‚Äî the community can revise rules or stop at any time.</p>
        </div>
      </div>

      <!-- Main Actions -->
      <div class="flex flex-col gap-4 mb-6">
        <button class="btn btn-secondary btn-xl btn-block" onclick="selectMode('need')">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
          I need something
        </button>
        <button class="btn btn-primary btn-xl btn-block" onclick="selectMode('offer')">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
          I can offer help
        </button>
      </div>

      <!-- Community Feed -->
      <div class="feed-section">
        <h3 class="feed-title">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
          Community board
        </h3>
        <div class="feed-tabs">
          <button class="feed-tab active" onclick="filterFeed('all')">All</button>
          <button class="feed-tab" onclick="filterFeed('offer')">Offers</button>
          <button class="feed-tab" onclick="filterFeed('need')">Needs</button>
        </div>
        <div id="feed-list">
          <div class="loading-state"><div class="loading-spinner-lg"></div></div>
        </div>
      </div>

      <!-- Invite Section -->
      <div class="card card-elevated">
        <div class="card-header">
          <h3 class="card-title">Grow your village</h3>
          <p class="card-subtitle" id="invite-status">Loading...</p>
        </div>
        <button class="btn btn-outline btn-block" id="invite-btn" onclick="openInviteModal()" disabled>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
          Invite a neighbour
        </button>
      </div>

      <!-- Quick Links -->
      <div style="display: flex; gap: var(--space-3); margin-top: var(--space-6); flex-wrap: wrap;">
        <a href="directory.html" class="btn btn-ghost" style="flex: 1; min-width: 120px; justify-content: center;">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
          Directory
        </a>
        <a href="exchanges.html" class="btn btn-ghost" style="flex: 1; min-width: 120px; justify-content: center;">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
          My Exchanges
        </a>
        <a href="my-feedback.html" class="btn btn-ghost" style="flex: 1; min-width: 120px; justify-content: center;">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
          My Feedback
        </a>
      </div>

      <!-- Footer -->
      <footer class="app-footer" style="margin-top: var(--space-6);">
        <div class="app-footer-text">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
          Made for local communities.
        </div>
        <div style="margin-top: var(--space-3);">
          <a href="credit-system.html" style="color: var(--color-text-muted); font-size: var(--font-size-xs); text-decoration: none;">How Credits Work</a>
          <span style="color: var(--color-text-muted); margin: 0 var(--space-2);">&middot;</span>
          <a href="charter.html" style="color: var(--color-text-muted); font-size: var(--font-size-xs); text-decoration: none;">Governance</a>
          <span style="color: var(--color-text-muted); margin: 0 var(--space-2);">&middot;</span>
          <a href="terms.html" style="color: var(--color-text-muted); font-size: var(--font-size-xs); text-decoration: none;">Terms</a>
          <span style="color: var(--color-text-muted); margin: 0 var(--space-2);">&middot;</span>
          <a href="privacy.html" style="color: var(--color-text-muted); font-size: var(--font-size-xs); text-decoration: none;">Privacy</a>
          <span style="color: var(--color-text-muted); margin: 0 var(--space-2);">&middot;</span>
          <a href="#" class="signout-link" onclick="handleSignOut(); return false;">Sign out</a>
        </div>
      </footer>
    </div>
  </div>

  <!-- ============================================================
       SCREEN 1: CATEGORY SELECTION
       ============================================================ -->
  <div id="screen-category" class="screen" style="display:none;">
    <div class="container">
      <header class="app-header-minimal" style="display: flex; justify-content: space-between; align-items: center;">
        <div style="display: flex; align-items: center; gap: var(--space-2);">
          <button class="btn btn-icon btn-ghost" onclick="goBack()" aria-label="Go back">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
          </button>
          <div class="app-logo">
            <div class="app-logo-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></div>
            <span class="app-logo-text">Community Connect</span>
          </div>
        </div>
      </header>
      <div class="card card-elevated mb-4">
        <h2 class="card-title" id="category-title">What do you need?</h2>
        <p class="card-subtitle">Pick the closest match ‚Äî you can add details next.</p>
      </div>
      <div class="category-list" id="category-list"></div>
    </div>
  </div>

  <!-- ============================================================
       SCREEN 2: DESCRIBE
       ============================================================ -->
  <div id="screen-describe" class="screen" style="display:none;">
    <div class="container">
      <header class="app-header-minimal" style="display: flex; justify-content: space-between; align-items: center;">
        <div style="display: flex; align-items: center; gap: var(--space-2);">
          <button class="btn btn-icon btn-ghost" onclick="goBack()" aria-label="Go back">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
          </button>
          <div class="app-logo">
            <div class="app-logo-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></div>
            <span class="app-logo-text">Community Connect</span>
          </div>
        </div>
      </header>

      <div class="card card-elevated">
        <div class="card-header">
          <h2 class="card-title">Tell us more</h2>
          <p class="card-subtitle">A few details help neighbours find you.</p>
        </div>

        <div class="form-group">
          <label class="form-label">Title <span style="color: var(--color-status-hold);">*</span></label>
          <input type="text" class="input" id="listing-title" placeholder="e.g., Need help moving a sofa this Saturday" maxlength="120">
        </div>

        <div class="form-group">
          <label class="form-label">Description (optional)</label>
          <textarea class="textarea" id="listing-description" placeholder="Add more details..." rows="3"></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">Tags (optional)</label>
          <input type="text" class="input" id="listing-tags" placeholder="e.g., gardening, heavy lifting">
          <p class="form-hint">Separate with commas</p>
        </div>

        <div class="form-group">
          <label class="form-label">Area</label>
          <div class="area-select" id="area-select">
            <label class="area-option" data-area="neighbourhood">
              <input type="radio" name="listing-area" value="neighbourhood">
              <div class="area-option-radio"></div>
              <div class="area-option-content"><div class="area-option-label">My neighbourhood</div><div class="area-option-desc">Walking distance</div></div>
            </label>
            <label class="area-option selected" data-area="village">
              <input type="radio" name="listing-area" value="village" checked>
              <div class="area-option-radio"></div>
              <div class="area-option-content"><div class="area-option-label">My village</div><div class="area-option-desc">Local area</div></div>
            </label>
            <label class="area-option" data-area="nearby">
              <input type="radio" name="listing-area" value="nearby">
              <div class="area-option-radio"></div>
              <div class="area-option-content"><div class="area-option-label">Nearby (within 10km)</div><div class="area-option-desc">Short drive</div></div>
            </label>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">When?</label>
          <div class="flex gap-2">
            <button class="btn btn-ghost flex-1" data-picker="urgency" data-value="Today" onclick="selectPicker(this)">Today</button>
            <button class="btn btn-outline flex-1" data-picker="urgency" data-value="This week" onclick="selectPicker(this)">This week</button>
            <button class="btn btn-ghost flex-1" data-picker="urgency" data-value="Flexible" onclick="selectPicker(this)">Flexible</button>
          </div>
        </div>

        <!-- Safety Warning (shown for high-risk categories) -->
        <div class="safety-warning" id="safety-warning">
          <div class="safety-warning-header">
            <svg class="safety-warning-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
            <span class="safety-warning-title">Safety notice</span>
          </div>
          <p class="safety-warning-text">Some help can carry risk. Agree details directly with your neighbour. Community Connect is a noticeboard ‚Äî we don't provide insurance or supervision.</p>
          <label class="safety-checkbox">
            <input type="checkbox" id="safety-confirmed">
            <span class="safety-checkbox-label">I understand Community Connect is a noticeboard and I'm responsible for assessing safety.</span>
          </label>
        </div>

        <button class="btn btn-primary btn-lg btn-block mt-6" id="submit-btn" onclick="submitListing()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
          Post to community
        </button>
      </div>
    </div>
  </div>

  <!-- ============================================================
       SCREEN 3: SUCCESS
       ============================================================ -->
  <div id="screen-success" class="screen" style="display:none;">
    <div class="status-page">
      <div class="status-card">
        <div class="status-icon">üåø</div>
        <h1 class="status-title" style="color: var(--color-status-accepted);">Posted!</h1>
        <p class="status-message">Your neighbours will see this soon. Good things take root in community.</p>
        <div class="card mb-6" id="summary-card"></div>
        <button class="btn btn-primary btn-block" onclick="startOver()">Back to home</button>
      </div>
    </div>
  </div>

  <!-- ============================================================
       INVITE MODAL
       ============================================================ -->
  <div class="modal-overlay" id="invite-modal">
    <div class="modal">
      <div id="invite-form-view">
        <div class="modal-header">
          <h2 class="modal-title">Invite a neighbour</h2>
          <p class="modal-subtitle">Help grow the village exchange by inviting people you trust.</p>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Their name <span class="required">*</span></label>
            <input type="text" class="input" id="invite-name" placeholder="e.g., Sarah">
          </div>
          <div class="form-group">
            <label class="form-label">Their email (optional)</label>
            <input type="email" class="input" id="invite-email" placeholder="e.g., sarah@example.com">
          </div>
          <div class="form-group">
            <label class="form-label">Note (optional)</label>
            <input type="text" class="input" id="invite-note" placeholder="e.g., Lives on Oak Street">
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-ghost" onclick="closeInviteModal()">Cancel</button>
          <button class="btn btn-primary" onclick="sendInvite()">Create invite link</button>
        </div>
      </div>
      <div id="invite-success-view" style="display: none;">
        <div class="modal-header">
          <h2 class="modal-title">Invite created!</h2>
          <p class="modal-subtitle">Share this link with <strong id="invite-success-name"></strong></p>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Invite link</label>
            <div style="display: flex; gap: var(--space-2);">
              <input type="text" class="input" id="invite-link" readonly style="font-size: var(--font-size-sm); background: var(--color-bg-warm);">
              <button class="btn btn-primary" onclick="copyInviteLinkToClipboard()" id="copy-btn">Copy</button>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-ghost" onclick="closeInviteModal()">Done</button>
          <button class="btn btn-secondary" onclick="shareInviteLink()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
            Share
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ============================================================
       BALANCE MODAL
       ============================================================ -->
  <div class="modal-overlay" id="balance-modal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Your Balance</h2>
        <p class="modal-subtitle">Community credits earned through helping neighbours.</p>
      </div>
      <div class="modal-body balance-modal-content">
        <div class="balance-display">
          <div class="balance-amount" id="balance-modal-amount">5</div>
          <div class="balance-label">Community Credits</div>
        </div>
        <div class="balance-explanation">
          <p><strong>How it works:</strong> When you help a neighbour, you earn credits. When you receive help, you spend credits. This keeps the community exchange balanced and fair for everyone.</p>
        </div>
        <div class="adjustments-section">
          <div class="adjustments-title">Recent Activity</div>
          <div class="adjustment-list" id="adjustment-list"></div>
        </div>
        <div style="margin-top: var(--space-4); text-align: center;">
          <a href="credit-system.html" class="btn btn-ghost" style="width: 100%; justify-content: center;">How credits work</a>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary btn-block" onclick="closeBalanceModal()">Done</button>
      </div>
    </div>
  </div>

  <!-- ============================================================
       FEEDBACK MODAL
       ============================================================ -->
  <div class="modal-overlay" id="feedback-modal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Send Feedback</h2>
        <p class="modal-subtitle">Help us improve Community Connect.</p>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">What type of feedback?</label>
          <div class="feedback-type-grid" id="feedback-type-grid">
            <label class="feedback-type-option selected" data-type="idea"><input type="radio" name="feedback-type" value="idea" checked><span class="feedback-type-emoji">üí°</span><span class="feedback-type-label">Idea</span></label>
            <label class="feedback-type-option" data-type="bug"><input type="radio" name="feedback-type" value="bug"><span class="feedback-type-emoji">üêõ</span><span class="feedback-type-label">Bug</span></label>
            <label class="feedback-type-option" data-type="question"><input type="radio" name="feedback-type" value="question"><span class="feedback-type-emoji">‚ùì</span><span class="feedback-type-label">Question</span></label>
            <label class="feedback-type-option" data-type="other"><input type="radio" name="feedback-type" value="other"><span class="feedback-type-emoji">üí¨</span><span class="feedback-type-label">Other</span></label>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Your message</label>
          <textarea class="textarea" id="feedback-message" placeholder="Tell us what's on your mind..." rows="4"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost" onclick="closeFeedbackModal()">Cancel</button>
        <button class="btn btn-primary" onclick="submitFeedbackForm()">Send</button>
      </div>
    </div>
  </div>

  <!-- Feedback FAB -->
  <button class="feedback-fab" onclick="openFeedbackModal()" style="display:none;" id="feedback-fab">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
    Feedback
  </button>

  <script>
    // =====================================================
    // STATE
    // =====================================================
    let currentMember = null;
    let currentBalance = { credits: 5, total_earned: 0, total_spent: 0 };
    let allListings = [];
    let allMembers = [];
    let currentFilter = 'all';

    const postState = {
      mode: null,
      category: null,
      urgency: 'This week',
      area: 'village'
    };

    const SAFETY_RISK_CATEGORIES = ['care_support', 'home_property', 'tools_things'];
    const screenHistory = ['screen-home'];

    // =====================================================
    // INITIALIZATION
    // =====================================================
    async function init() {
      try {
        const session = await getAuthSession();
        if (!session) {
          window.location.href = 'access.html';
          return;
        }

        currentMember = await getCurrentMember();
        if (!currentMember) {
          window.location.href = 'access.html';
          return;
        }

        if (currentMember.status === 'PENDING_PROFILE') {
          window.location.href = 'join.html';
          return;
        }

        if (currentMember.status === 'REVIEW' || currentMember.status === 'HOLD') {
          window.location.href = 'join-status.html';
          return;
        }

        // Hide loading, show app
        document.getElementById('app').style.display = 'none';
        showScreen('screen-home');
        document.getElementById('feedback-fab').style.display = 'flex';

        // Populate UI
        updateUserIdentity();
        await loadBalance();
        allMembers = await getAcceptedMembers();
        await loadFeed();
        updateInviteStatus();
        initAreaSelection();
        initFeedbackTypeSelection();

        // Subscribe to realtime listing updates
        subscribeToListings((payload) => {
          loadFeed(); // Refresh feed on any change
        });

      } catch (e) {
        console.error('Init error:', e);
        document.getElementById('app').innerHTML = `
          <div style="text-align:center;padding:40px;">
            <p>Something went wrong loading the app.</p>
            <a href="access.html" style="color:var(--color-primary);">Sign in again</a>
          </div>
        `;
      }
    }

    // =====================================================
    // NAVIGATION
    // =====================================================
    function showScreen(screenId) {
      document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
      document.getElementById(screenId).style.display = 'block';
      window.scrollTo(0, 0);
    }

    function navigateTo(screenId) {
      screenHistory.push(screenId);
      showScreen(screenId);
    }

    function goBack() {
      if (screenHistory.length > 1) {
        screenHistory.pop();
        showScreen(screenHistory[screenHistory.length - 1]);
      }
    }

    // =====================================================
    // USER IDENTITY
    // =====================================================
    function updateUserIdentity() {
      document.getElementById('header-user-name').textContent = currentMember.display_name || 'You';
      document.getElementById('header-member-id').textContent = currentMember.member_id || '';
    }

    // =====================================================
    // BALANCE
    // =====================================================
    async function loadBalance() {
      try {
        currentBalance = await getBalance(currentMember.id);
      } catch (e) {
        console.error('Balance load error:', e);
      }
      updateBalanceDisplay();
    }

    function updateBalanceDisplay() {
      document.querySelectorAll('.balance-chip-value').forEach(el => {
        el.textContent = currentBalance.credits;
      });
      const modalAmount = document.getElementById('balance-modal-amount');
      if (modalAmount) modalAmount.textContent = currentBalance.credits;
    }

    async function openBalanceModal() {
      updateBalanceDisplay();
      await renderAdjustmentsList();
      document.getElementById('balance-modal').classList.add('active');
    }

    function closeBalanceModal() {
      document.getElementById('balance-modal').classList.remove('active');
    }

    async function renderAdjustmentsList() {
      const container = document.getElementById('adjustment-list');
      try {
        const history = await getBalanceHistory(currentMember.id, 5);
        if (history.length === 0) {
          container.innerHTML = `<div class="no-adjustments"><p>No activity yet.</p><p style="margin-top:var(--space-2);">Start by helping a neighbour or posting what you need!</p></div>`;
          return;
        }
        container.innerHTML = history.map(adj => {
          const isPositive = adj.amount > 0;
          return `<div class="adjustment-item"><div class="adjustment-info"><div class="adjustment-reason">${adj.reason}</div><div class="adjustment-date">${formatDate(adj.created_at)}</div></div><div class="adjustment-amount ${isPositive ? 'positive' : 'negative'}">${isPositive ? '+' : ''}${adj.amount}</div></div>`;
        }).join('');
      } catch (e) {
        container.innerHTML = `<div class="no-adjustments"><p>Could not load activity.</p></div>`;
      }
    }

    // =====================================================
    // COMMUNITY FEED
    // =====================================================
    async function loadFeed() {
      try {
        allListings = await getActiveListings();
        renderFeed();
      } catch (e) {
        console.error('Feed load error:', e);
        document.getElementById('feed-list').innerHTML = `<div class="empty-feed"><p>Could not load listings.</p></div>`;
      }
    }

    function filterFeed(type) {
      currentFilter = type;
      document.querySelectorAll('.feed-tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      renderFeed();
    }

    function renderFeed() {
      const container = document.getElementById('feed-list');
      let filtered = allListings;
      if (currentFilter !== 'all') {
        filtered = allListings.filter(l => l.type === currentFilter);
      }

      if (filtered.length === 0) {
        container.innerHTML = `
          <div class="empty-feed">
            <div class="empty-feed-icon">üå±</div>
            <div class="empty-feed-title">No listings yet</div>
            <p>Be the first to post an offer or need!</p>
          </div>
        `;
        return;
      }

      container.innerHTML = filtered.map(listing => {
        const cat = getCategoryById(listing.category);
        const author = listing.author || {};
        const band = calculateReliabilityBand(author.exchanges_completed || 0, author.disputes_count || 0);
        const areaLabel = listing.area === 'neighbourhood' ? 'Neighbourhood' : listing.area === 'village' ? 'Village' : 'Nearby';
        const tags = (listing.tags || []).map(t => `<span style="background:var(--color-bg-muted);padding:2px 8px;border-radius:var(--radius-sm);font-size:var(--font-size-xs);color:var(--color-text-muted);">${t}</span>`).join(' ');

        return `
          <a href="listing.html?id=${listing.id}" class="listing-card" style="text-decoration:none;color:inherit;display:block;">
            <div class="listing-header">
              <div>
                <div class="listing-title">${escapeHtml(listing.title)}</div>
                <div class="listing-category">${cat.emoji} ${cat.label}</div>
              </div>
              <span class="listing-type-badge ${listing.type}">${listing.type === 'offer' ? 'Offer' : 'Need'}</span>
            </div>
            ${listing.description ? `<div class="listing-desc">${escapeHtml(listing.description)}</div>` : ''}
            ${tags ? `<div style="margin-bottom:var(--space-3);display:flex;gap:var(--space-1);flex-wrap:wrap;">${tags}</div>` : ''}
            <div class="listing-meta">
              <span class="listing-meta-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
                ${areaLabel}
              </span>
              <span class="listing-meta-item">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                ${listing.urgency || 'This week'}
              </span>
              <span class="listing-meta-item">${formatRelativeTime(listing.created_at)}</span>
            </div>
            <div class="listing-author">
              <span>${author.display_name || 'Unknown'}</span>
              <span>&middot;</span>
              <span style="font-family:var(--font-family-mono,monospace);">${author.member_id || ''}</span>
              <span>&middot;</span>
              <span class="reliability-badge ${band.toLowerCase()}">${band}</span>
              ${renderDegreesBadge(author.id)}
            </div>
          </a>
        `;
      }).join('');
    }

    // =====================================================
    // CREATE LISTING
    // =====================================================
    function selectMode(mode) {
      postState.mode = mode;
      document.getElementById('category-title').textContent = mode === 'need' ? 'What do you need?' : 'What can you offer?';
      renderCategories();
      navigateTo('screen-category');
    }

    function renderCategories() {
      document.getElementById('category-list').innerHTML = CATEGORIES.map(cat => {
        const isHighRisk = HIGH_RISK_CATEGORIES.includes(cat.id);
        const hint = cat.hint ? `<span style="font-size:var(--font-size-xs);color:var(--color-text-muted);display:block;">${cat.hint}</span>` : '';
        return `<button class="category-item" onclick="selectCategory('${cat.id}')"><span class="emoji">${cat.emoji}</span><span>${cat.label}${hint}</span></button>`;
      }).join('');
    }

    function selectCategory(categoryId) {
      postState.category = categoryId;
      const warningEl = document.getElementById('safety-warning');
      if (warningEl) warningEl.classList.toggle('visible', SAFETY_RISK_CATEGORIES.includes(categoryId));
      navigateTo('screen-describe');
    }

    function selectPicker(btn) {
      const picker = btn.dataset.picker;
      postState[picker] = btn.dataset.value;
      document.querySelectorAll(`[data-picker="${picker}"]`).forEach(b => { b.classList.remove('btn-outline'); b.classList.add('btn-ghost'); });
      btn.classList.remove('btn-ghost');
      btn.classList.add('btn-outline');
    }

    function initAreaSelection() {
      document.querySelectorAll('.area-option').forEach(option => {
        option.addEventListener('click', () => {
          document.querySelectorAll('.area-option').forEach(o => o.classList.remove('selected'));
          option.classList.add('selected');
          const radio = option.querySelector('input[type="radio"]');
          if (radio) { radio.checked = true; postState.area = radio.value; }
        });
      });
    }

    async function submitListing() {
      const title = document.getElementById('listing-title').value.trim();
      const description = document.getElementById('listing-description').value.trim();
      const tagsRaw = document.getElementById('listing-tags').value.trim();
      const tags = tagsRaw ? tagsRaw.split(',').map(t => t.trim()).filter(Boolean) : [];
      const selectedArea = document.querySelector('input[name="listing-area"]:checked');
      const area = selectedArea ? selectedArea.value : 'village';

      if (!title) {
        showToast('Please enter a title');
        return;
      }

      // Safety check
      if (SAFETY_RISK_CATEGORIES.includes(postState.category)) {
        const safetyCheckbox = document.getElementById('safety-confirmed');
        if (!safetyCheckbox.checked) {
          showToast('Please confirm you understand the safety notice');
          return;
        }
      }

      const btn = document.getElementById('submit-btn');
      btn.disabled = true;
      btn.textContent = 'Posting...';

      try {
        const listing = await createListing({
          author_id: currentMember.id,
          type: postState.mode,
          category: postState.category,
          title: title,
          description: description || null,
          tags: tags,
          area: area,
          urgency: postState.urgency,
          visibility: 'public'
        });

        renderSuccessSummary(listing);
        navigateTo('screen-success');
      } catch (e) {
        console.error('Submit error:', e);
        showToast('Failed to post listing. Please try again.');
      } finally {
        btn.disabled = false;
        btn.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg> Post to community`;
      }
    }

    function renderSuccessSummary(listing) {
      const cat = getCategoryById(listing.category);
      const isOffer = listing.type === 'offer';
      document.getElementById('summary-card').innerHTML = `
        <div class="author-strip">
          <div class="author-info"><span class="author-name">${currentMember.display_name}</span><span class="author-member-id">${currentMember.member_id}</span></div>
          <span class="listing-type-badge ${listing.type}">${isOffer ? 'Offer' : 'Need'}</span>
        </div>
        <div style="padding:var(--space-3) 0;border-bottom:1px solid var(--color-border-light);display:flex;justify-content:space-between;"><span class="text-muted">Category</span><span>${cat.emoji} ${cat.label}</span></div>
        <div style="padding:var(--space-3) 0;border-bottom:1px solid var(--color-border-light);display:flex;justify-content:space-between;"><span class="text-muted">Title</span><span style="text-align:right;max-width:60%;">${escapeHtml(listing.title)}</span></div>
        <div style="padding:var(--space-3) 0;display:flex;flex-direction:column;align-items:center;">
          <span class="balance-delta ${isOffer ? 'credit' : 'debit'}">
            ${isOffer ? '+1' : '-1'} credit (when completed)
          </span>
          <p class="balance-delta-note">${isOffer ? "You'll earn credit when someone accepts your help" : "You'll spend credit when a neighbour helps you"}</p>
        </div>
      `;
    }

    function startOver() {
      postState.mode = null;
      postState.category = null;
      postState.urgency = 'This week';
      postState.area = 'village';

      // Reset form inputs
      const titleEl = document.getElementById('listing-title');
      if (titleEl) titleEl.value = '';
      const descEl = document.getElementById('listing-description');
      if (descEl) descEl.value = '';
      const tagsEl = document.getElementById('listing-tags');
      if (tagsEl) tagsEl.value = '';

      const safetyCheckbox = document.getElementById('safety-confirmed');
      if (safetyCheckbox) safetyCheckbox.checked = false;
      const safetyWarning = document.getElementById('safety-warning');
      if (safetyWarning) safetyWarning.classList.remove('visible');

      // Reset area selection
      document.querySelectorAll('.area-option').forEach(o => o.classList.remove('selected'));
      const defaultArea = document.querySelector('.area-option[data-area="village"]');
      if (defaultArea) { defaultArea.classList.add('selected'); defaultArea.querySelector('input').checked = true; }

      // Reset picker buttons
      document.querySelectorAll('[data-picker]').forEach(b => { b.classList.remove('btn-outline'); b.classList.add('btn-ghost'); });
      const defaultUrgency = document.querySelector('[data-picker="urgency"][data-value="This week"]');
      if (defaultUrgency) { defaultUrgency.classList.add('btn-outline'); defaultUrgency.classList.remove('btn-ghost'); }

      screenHistory.length = 0;
      screenHistory.push('screen-home');
      showScreen('screen-home');
      loadFeed();
    }

    // =====================================================
    // INVITE MODAL
    // =====================================================
    let currentInviteLink = '';

    function openInviteModal() {
      document.getElementById('invite-modal').classList.add('active');
      document.getElementById('invite-form-view').style.display = 'block';
      document.getElementById('invite-success-view').style.display = 'none';
      document.getElementById('invite-name').focus();
    }

    function closeInviteModal() {
      document.getElementById('invite-modal').classList.remove('active');
      document.getElementById('invite-name').value = '';
      document.getElementById('invite-email').value = '';
      document.getElementById('invite-note').value = '';
      currentInviteLink = '';
    }

    async function sendInvite() {
      const name = document.getElementById('invite-name').value.trim();
      const email = document.getElementById('invite-email').value.trim();
      const note = document.getElementById('invite-note').value.trim();

      if (!name) { showToast('Please enter their name'); return; }

      // Check member cap
      const capMembers = await getAcceptedMembers();
      if (capMembers.length >= COMMUNITY_SETTINGS.MEMBER_CAP) {
        showToast('Community is at capacity. Invites are paused.');
        return;
      }

      // Check personal invite allowance
      const myInvites = await getMyInvites(currentMember.id);
      const allowance = getInviteAllowance(currentMember, myInvites.length);
      if (allowance.remaining <= 0) {
        showToast(`You've used all ${allowance.limit} invites. Complete more exchanges to earn more.`);
        return;
      }

      try {
        const invite = await createInviteRecord({
          created_by: currentMember.id,
          invitee_name: name,
          invitee_email: email || null,
          note: note || null
        });

        currentInviteLink = generateInviteLink(invite.token);
        document.getElementById('invite-form-view').style.display = 'none';
        document.getElementById('invite-success-view').style.display = 'block';
        document.getElementById('invite-success-name').textContent = name;
        document.getElementById('invite-link').value = currentInviteLink;
        document.getElementById('copy-btn').textContent = 'Copy';
        updateInviteStatus();
      } catch (e) {
        console.error('Invite error:', e);
        showToast('Failed to create invite. Please try again.');
      }
    }

    function copyInviteLinkToClipboard() {
      navigator.clipboard.writeText(currentInviteLink).then(() => {
        document.getElementById('copy-btn').textContent = 'Copied!';
        setTimeout(() => { document.getElementById('copy-btn').textContent = 'Copy'; }, 2000);
      });
    }

    function shareInviteLink() {
      const name = document.getElementById('invite-success-name').textContent;
      if (navigator.share) {
        navigator.share({ title: 'Join Community Connect', text: `Hi ${name}! Join our community exchange:`, url: currentInviteLink });
      } else {
        copyInviteLinkToClipboard();
        showToast('Link copied - paste it in your message');
      }
    }

    // =====================================================
    // INVITE STATUS
    // =====================================================
    async function updateInviteStatus() {
      try {
        const capMembers = await getAcceptedMembers();
        const myInvites = await getMyInvites(currentMember.id);
        const allowance = getInviteAllowance(currentMember, myInvites.length);
        const atCap = capMembers.length >= COMMUNITY_SETTINGS.MEMBER_CAP;

        const statusEl = document.getElementById('invite-status');
        const btnEl = document.getElementById('invite-btn');

        if (atCap) {
          statusEl.textContent = `Community full (${capMembers.length}/${COMMUNITY_SETTINGS.MEMBER_CAP} members)`;
          btnEl.disabled = true;
        } else if (allowance.remaining <= 0) {
          statusEl.textContent = `No invites remaining (${allowance.used}/${allowance.limit} used)`;
          btnEl.disabled = true;
        } else {
          statusEl.textContent = `${allowance.remaining} invite${allowance.remaining !== 1 ? 's' : ''} remaining ¬∑ ${capMembers.length}/${COMMUNITY_SETTINGS.MEMBER_CAP} members`;
          btnEl.disabled = false;
        }
      } catch (e) {
        console.error('Invite status error:', e);
        document.getElementById('invite-status').textContent = 'Know someone who\'d like to join?';
        document.getElementById('invite-btn').disabled = false;
      }
    }

    // =====================================================
    // FEEDBACK MODAL
    // =====================================================
    let selectedFeedbackType = 'idea';

    function openFeedbackModal() {
      document.getElementById('feedback-modal').classList.add('active');
      document.getElementById('feedback-message').focus();
    }

    function closeFeedbackModal() {
      document.getElementById('feedback-modal').classList.remove('active');
      document.getElementById('feedback-message').value = '';
      selectedFeedbackType = 'idea';
      document.querySelectorAll('.feedback-type-option').forEach(opt => {
        opt.classList.remove('selected');
        if (opt.dataset.type === 'idea') { opt.classList.add('selected'); opt.querySelector('input').checked = true; }
      });
    }

    function initFeedbackTypeSelection() {
      document.querySelectorAll('.feedback-type-option').forEach(option => {
        option.addEventListener('click', () => {
          document.querySelectorAll('.feedback-type-option').forEach(o => o.classList.remove('selected'));
          option.classList.add('selected');
          option.querySelector('input').checked = true;
          selectedFeedbackType = option.dataset.type;
        });
      });
    }

    async function submitFeedbackForm() {
      const message = document.getElementById('feedback-message').value.trim();
      if (!message) { showToast('Please enter your feedback'); return; }

      try {
        await createFeedbackRecord({
          author_id: currentMember.id,
          type: selectedFeedbackType,
          message: message
        });
        closeFeedbackModal();
        showToast('Thank you! Your feedback has been submitted.');
      } catch (e) {
        console.error('Feedback error:', e);
        showToast('Failed to submit feedback. Please try again.');
      }
    }

    // =====================================================
    // HELPERS
    // =====================================================
    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    function renderDegreesBadge(authorId) {
      if (!currentMember || !allMembers.length || !authorId) return '';
      if (authorId === currentMember.id) return '';
      const degrees = getDegreesFromUser(allMembers, currentMember.id, authorId);
      if (degrees < 0) return '';
      const label = degrees === 1 ? '1 step' : degrees + ' steps';
      return `
        <span class="degrees-badge">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><polyline points="17 11 19 13 23 9"/></svg>
          ${label}
        </span>
      `;
    }

    // =====================================================
    // INIT
    // =====================================================
    init();
  </script>
</body>
</html>
