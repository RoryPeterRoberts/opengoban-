<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="robots" content="noindex, nofollow">
  <title>Open Gobán — A digital meitheal</title>
  <link rel="stylesheet" href="theme.css">
  <style>
    /* Balance Chip */
    .balance-chip {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-4);
      background: linear-gradient(135deg, var(--color-primary-bg) 0%, var(--color-accent-bg) 100%);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-full);
      font-family: var(--font-family-heading);
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-semibold);
      color: var(--color-primary);
      cursor: pointer;
      transition: all var(--transition-base);
      box-shadow: var(--shadow-sm);
      min-height: 40px;
    }

    .balance-chip:hover {
      background: var(--color-primary);
      border-color: var(--color-primary);
      color: white;
      transform: scale(1.05);
    }

    .balance-chip svg { width: 18px; height: 18px; }
    .balance-chip-value { font-weight: var(--font-weight-bold); font-size: var(--font-size-base); }

    /* Header */
    .app-header-with-balance {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      padding: var(--space-5) var(--space-4) var(--space-4);
      margin-bottom: var(--space-2);
      gap: var(--space-1);
    }

    .app-header-with-balance .app-logo { justify-content: center; margin-bottom: 0; }
    .app-header-with-balance .app-tagline { text-align: center; margin: 0; font-size: var(--font-size-sm); }

    .user-identity-section {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      gap: var(--space-3);
      margin-top: var(--space-2);
      padding-top: var(--space-2);
      border-top: 1px solid var(--color-border-light);
      width: 100%;
      max-width: 280px;
    }

    .profile-chip {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-1) var(--space-3) var(--space-1) var(--space-1);
      background: var(--color-bg-card);
      border: 1.5px solid var(--color-border);
      border-radius: var(--radius-full);
      text-decoration: none;
      transition: all var(--transition-fast);
      min-height: 36px;
    }
    .profile-chip:hover {
      border-color: var(--color-primary);
      background: var(--color-primary-bg);
    }
    .profile-chip-avatar {
      width: 26px;
      height: 26px;
      border-radius: var(--radius-full);
      background: var(--color-primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: var(--font-weight-bold);
      flex-shrink: 0;
    }
    .profile-chip-name {
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-medium);
      color: var(--color-text-secondary);
    }
    .profile-chip-id {
      font-family: var(--font-family-mono, monospace);
      font-size: 10px;
      color: var(--color-text-muted);
    }

    /* Reliability Badge */
    .reliability-badge {
      display: inline-flex;
      align-items: center;
      padding: 2px var(--space-2);
      border-radius: var(--radius-sm);
      font-size: 10px;
      font-weight: var(--font-weight-semibold);
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .reliability-badge.low { background: var(--color-bg-muted); color: var(--color-text-muted); }
    .reliability-badge.medium { background: var(--color-status-review-bg); color: var(--color-status-review); }
    .reliability-badge.high { background: var(--color-status-accepted-bg); color: var(--color-status-accepted); }

    /* Author Strip */
    .author-strip {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-3);
      background: var(--color-bg-warm);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-3);
    }

    .author-info { display: flex; flex-direction: column; gap: 2px; }
    .author-name { font-weight: var(--font-weight-medium); color: var(--color-text); font-size: var(--font-size-sm); }
    .author-member-id { font-family: var(--font-family-mono, monospace); font-size: var(--font-size-xs); color: var(--color-text-muted); }

    /* Balance Modal */
    .balance-modal-content { text-align: center; }
    .balance-display { padding: var(--space-6) 0; }
    .balance-amount { font-family: var(--font-family-heading); font-size: 4rem; font-weight: var(--font-weight-bold); color: var(--color-primary); line-height: 1; }
    .balance-label { font-size: var(--font-size-sm); color: var(--color-text-muted); margin-top: var(--space-2); text-transform: uppercase; letter-spacing: 0.05em; }
    .balance-explanation { background: var(--color-secondary-bg); border-radius: var(--radius-md); padding: var(--space-4); margin: var(--space-4) 0; text-align: left; }
    .balance-explanation p { font-size: var(--font-size-sm); color: var(--color-text-secondary); line-height: var(--line-height-relaxed); margin: 0; }
    .balance-explanation strong { color: var(--color-text); }

    .adjustments-section { margin-top: var(--space-6); text-align: left; }
    .adjustments-title { font-size: var(--font-size-xs); font-weight: var(--font-weight-semibold); color: var(--color-text-muted); text-transform: uppercase; letter-spacing: 0.03em; margin-bottom: var(--space-3); }
    .adjustment-list { display: flex; flex-direction: column; gap: var(--space-2); }
    .adjustment-item { display: flex; justify-content: space-between; align-items: center; padding: var(--space-3); background: var(--color-bg-card); border: 1px solid var(--color-border-light); border-radius: var(--radius-md); }
    .adjustment-info { flex: 1; min-width: 0; }
    .adjustment-reason { font-size: var(--font-size-sm); color: var(--color-text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .adjustment-date { font-size: var(--font-size-xs); color: var(--color-text-muted); margin-top: 2px; }
    .adjustment-amount { font-weight: var(--font-weight-semibold); font-size: var(--font-size-sm); padding: var(--space-1) var(--space-2); border-radius: var(--radius-sm); }
    .adjustment-amount.positive { color: var(--color-status-accepted); background: var(--color-status-accepted-bg); }
    .adjustment-amount.negative { color: var(--color-status-hold); background: var(--color-status-hold-bg); }
    .no-adjustments { text-align: center; padding: var(--space-4); color: var(--color-text-muted); font-size: var(--font-size-sm); }

    /* Balance Delta */
    .balance-delta { display: inline-flex; align-items: center; gap: var(--space-1); padding: var(--space-2) var(--space-3); border-radius: var(--radius-md); font-size: var(--font-size-sm); font-weight: var(--font-weight-semibold); }
    .balance-delta.credit { background: var(--color-status-accepted-bg); color: var(--color-status-accepted); }
    .balance-delta.debit { background: var(--color-status-hold-bg); color: var(--color-status-hold); }
    .balance-delta svg { width: 14px; height: 14px; }
    .balance-delta-note { font-size: var(--font-size-xs); color: var(--color-text-muted); margin-top: var(--space-2); text-align: center; }

    /* Community Feed */
    .feed-section { margin-bottom: var(--space-6); }
    .feed-title { font-family: var(--font-family-heading); font-size: var(--font-size-lg); font-weight: var(--font-weight-semibold); color: var(--color-text); margin-bottom: var(--space-4); display: flex; align-items: center; gap: var(--space-2); }
    .feed-title svg { width: 20px; height: 20px; color: var(--color-primary); }

    /* Compact listing rows */
    .listing-row {
      background: var(--color-bg-card);
      border: 1px solid var(--color-border-light);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-1);
    }
    .listing-row summary {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-3);
      cursor: pointer;
      list-style: none;
      min-height: 44px;
    }
    .listing-row summary::-webkit-details-marker { display: none; }
    .listing-row summary::marker { display: none; content: ''; }
    .listing-row-type {
      flex-shrink: 0;
      font-size: 10px;
      font-weight: var(--font-weight-semibold);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      padding: 1px 6px;
      border-radius: var(--radius-sm);
    }
    .listing-row-type.offer { background: var(--color-status-accepted-bg); color: var(--color-status-accepted); }
    .listing-row-type.need { background: var(--color-status-review-bg); color: var(--color-status-review); }
    .listing-row-title {
      font-weight: var(--font-weight-semibold);
      font-size: var(--font-size-sm);
      color: var(--color-text);
      flex: 1;
      min-width: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .listing-row-time {
      flex-shrink: 0;
      font-size: var(--font-size-xs);
      color: var(--color-text-muted);
    }
    .listing-row-chevron {
      flex-shrink: 0;
      width: 16px;
      height: 16px;
      color: var(--color-text-muted);
      transition: transform 0.15s ease;
    }
    .listing-row[open] > summary .listing-row-chevron {
      transform: rotate(90deg);
    }
    .listing-row-body {
      padding: 0 var(--space-3) var(--space-3);
    }
    .listing-row-desc {
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
      line-height: var(--line-height-relaxed);
      margin-bottom: var(--space-3);
    }
    .listing-row-tags {
      display: flex;
      gap: var(--space-1);
      flex-wrap: wrap;
      margin-bottom: var(--space-3);
    }
    .listing-row-meta {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      font-size: var(--font-size-xs);
      color: var(--color-text-muted);
      flex-wrap: wrap;
    }
    .listing-row-meta a {
      margin-left: auto;
      color: var(--color-primary);
      text-decoration: none;
    }

    .empty-feed { text-align: center; padding: var(--space-8); color: var(--color-text-muted); }
    .empty-feed-icon { font-size: 3rem; margin-bottom: var(--space-4); }
    .empty-feed-title { font-family: var(--font-family-heading); font-size: var(--font-size-lg); color: var(--color-text); margin-bottom: var(--space-2); }

    /* Loading */
    .loading-state { text-align: center; padding: var(--space-12) var(--space-5); }
    .loading-spinner-lg { width: 40px; height: 40px; border: 3px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto var(--space-4); }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Area Tag */
    .area-tag { display: inline-flex; align-items: center; gap: var(--space-1); background: var(--color-bg-muted); color: var(--color-text-muted); padding: var(--space-1) var(--space-2); border-radius: var(--radius-sm); font-size: var(--font-size-xs); }
    .area-tag svg { width: 12px; height: 12px; }

    /* Safety Warning */
    .safety-warning { background: var(--color-status-hold-bg); border: 2px solid rgba(194, 65, 12, 0.3); border-radius: var(--radius-lg); padding: var(--space-4); margin: var(--space-4) 0; display: none; }
    .safety-warning.visible { display: block; }
    .safety-warning-header { display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-3); }
    .safety-warning-icon { width: 24px; height: 24px; color: var(--color-status-hold); }
    .safety-warning-title { font-size: var(--font-size-sm); font-weight: var(--font-weight-semibold); color: var(--color-status-hold); }
    .safety-warning-text { font-size: var(--font-size-sm); color: var(--color-text-secondary); line-height: var(--line-height-relaxed); margin-bottom: var(--space-3); }
    .safety-checkbox { display: flex; align-items: flex-start; gap: var(--space-3); padding: var(--space-3); background: var(--color-bg-card); border-radius: var(--radius-md); cursor: pointer; }
    .safety-checkbox input { width: 20px; height: 20px; flex-shrink: 0; margin-top: 2px; accent-color: var(--color-primary); }
    .safety-checkbox-label { font-size: var(--font-size-sm); color: var(--color-text); line-height: var(--line-height-relaxed); }

    /* Area Selection */
    .area-select { display: flex; flex-direction: column; gap: var(--space-2); }
    .area-option { display: flex; align-items: center; padding: var(--space-3); background: var(--color-bg-card); border: 2px solid var(--color-border); border-radius: var(--radius-md); cursor: pointer; transition: all var(--transition-fast); }
    .area-option:hover { border-color: var(--color-primary); }
    .area-option.selected { border-color: var(--color-primary); background: var(--color-primary-bg); }
    .area-option input { position: absolute; opacity: 0; pointer-events: none; }
    .area-option-radio { width: 18px; height: 18px; border: 2px solid var(--color-border); border-radius: 50%; margin-right: var(--space-3); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .area-option.selected .area-option-radio { border-color: var(--color-primary); }
    .area-option.selected .area-option-radio::after { content: ''; width: 10px; height: 10px; background: var(--color-primary); border-radius: 50%; }
    .area-option-label { font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); color: var(--color-text); }
    .area-option-desc { font-size: var(--font-size-xs); color: var(--color-text-muted); }

    /* Pilot Badge */
    .pilot-badge { display: inline-flex; align-items: center; gap: var(--space-1); background: var(--color-status-review-bg); color: var(--color-status-review); padding: var(--space-1) var(--space-2); border-radius: var(--radius-sm); font-size: var(--font-size-xs); font-weight: var(--font-weight-semibold); text-transform: uppercase; letter-spacing: 0.03em; }
    .pilot-note { font-size: var(--font-size-xs); color: var(--color-text-muted); margin-top: var(--space-2); }

    /* Tab filters */
    .feed-search {
      position: relative;
      margin-bottom: var(--space-4);
    }

    .feed-search svg {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      width: 18px;
      height: 18px;
      color: var(--color-text-muted);
      pointer-events: none;
    }

    .feed-search-input {
      width: 100%;
      padding: var(--space-3) var(--space-3) var(--space-3) 42px;
      font-family: var(--font-family);
      font-size: var(--font-size-sm);
      color: var(--color-text);
      background: var(--color-bg-card);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
      transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
    }

    .feed-search-input:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 4px var(--color-primary-bg);
    }

    .member-result {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3) var(--space-4);
      background: var(--color-bg-warm);
      border: 1px solid var(--color-border-light);
      border-radius: var(--radius-lg);
      margin-bottom: var(--space-3);
      text-decoration: none;
      color: inherit;
      transition: border-color var(--transition-fast);
    }

    .member-result:hover {
      border-color: var(--color-primary);
    }

    .member-result-avatar {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, var(--color-primary-bg) 0%, var(--color-accent-bg) 100%);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: var(--font-family-heading);
      font-weight: var(--font-weight-bold);
      font-size: var(--font-size-sm);
      color: var(--color-primary);
      flex-shrink: 0;
    }

    .member-result-info {
      flex: 1;
      min-width: 0;
    }

    .member-result-name {
      font-weight: var(--font-weight-semibold);
      font-size: var(--font-size-sm);
    }

    .member-result-skills {
      font-size: var(--font-size-xs);
      color: var(--color-text-muted);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .member-results-header {
      font-size: var(--font-size-xs);
      color: var(--color-text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-weight: var(--font-weight-semibold);
      margin-bottom: var(--space-2);
    }

    /* New badge */
    .new-badge {
      display: inline-flex;
      align-items: center;
      padding: 2px var(--space-2);
      background: var(--color-primary);
      color: white;
      border-radius: var(--radius-sm);
      font-size: 10px;
      font-weight: var(--font-weight-bold);
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-left: var(--space-2);
      flex-shrink: 0;
    }

    /* What's new banner */
    .whats-new-banner {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-4);
      background: linear-gradient(135deg, var(--color-primary-bg) 0%, var(--color-accent-bg) 100%);
      border: 1px solid var(--color-border-light);
      border-radius: var(--radius-lg);
      margin-bottom: var(--space-4);
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
      line-height: var(--line-height-relaxed);
    }

    .whats-new-banner svg {
      width: 20px;
      height: 20px;
      color: var(--color-primary);
      flex-shrink: 0;
    }

    .whats-new-banner strong {
      color: var(--color-text);
    }

    .whats-new-dismiss {
      background: none;
      border: none;
      color: var(--color-text-muted);
      cursor: pointer;
      padding: var(--space-1);
      margin-left: auto;
      flex-shrink: 0;
      font-size: var(--font-size-lg);
      line-height: 1;
    }

    .whats-new-dismiss:hover {
      color: var(--color-text);
    }

    /* New member card */
    .new-member-card {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-4);
      background: var(--color-bg-card);
      border: 1px solid var(--color-border-light);
      border-radius: var(--radius-xl);
      margin-bottom: var(--space-4);
      box-shadow: var(--shadow-card);
      text-decoration: none;
      color: inherit;
      transition: box-shadow var(--transition-fast);
    }

    .new-member-card:hover {
      box-shadow: var(--shadow-md);
    }

    .new-member-avatar {
      width: 44px;
      height: 44px;
      background: linear-gradient(135deg, var(--color-primary-bg) 0%, var(--color-accent-bg) 100%);
      border: 2px solid var(--color-primary);
      border-radius: var(--radius-lg);
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: var(--font-family-heading);
      font-weight: var(--font-weight-bold);
      font-size: var(--font-size-base);
      color: var(--color-primary);
      flex-shrink: 0;
    }

    .new-member-info {
      flex: 1;
      min-width: 0;
    }

    .new-member-name {
      font-weight: var(--font-weight-semibold);
      color: var(--color-text);
      font-size: var(--font-size-sm);
    }

    .new-member-detail {
      font-size: var(--font-size-xs);
      color: var(--color-text-muted);
    }

    .new-member-badge {
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      padding: 2px var(--space-2);
      background: var(--color-primary-bg);
      border: 1px solid var(--color-primary);
      border-radius: var(--radius-sm);
      font-size: 10px;
      font-weight: var(--font-weight-semibold);
      color: var(--color-primary);
      text-transform: uppercase;
      letter-spacing: 0.03em;
      flex-shrink: 0;
    }

    .feed-tabs { display: flex; gap: var(--space-2); margin-bottom: var(--space-3); }
    .feed-tab { padding: var(--space-2) var(--space-4); border-radius: var(--radius-full); font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); border: 1px solid var(--color-border); background: var(--color-bg-card); color: var(--color-text-secondary); cursor: pointer; transition: all var(--transition-fast); }
    .feed-tab:hover { border-color: var(--color-primary); color: var(--color-primary); }
    .feed-tab.active { background: var(--color-primary); border-color: var(--color-primary); color: white; }

    /* Category filter pills */
    .feed-filters { margin-bottom: var(--space-3); }
    .category-pills { display: flex; gap: var(--space-2); flex-wrap: wrap; padding-bottom: var(--space-2); }
    .cat-pill { white-space: nowrap; padding: 6px 12px; border-radius: var(--radius-full); font-size: var(--font-size-xs); border: 1px solid var(--color-border-light); background: var(--color-bg-card); color: var(--color-text-muted); cursor: pointer; transition: all var(--transition-fast); flex-shrink: 0; }
    .cat-pill:hover { border-color: var(--color-primary); color: var(--color-primary); }
    .cat-pill.active { background: var(--color-primary-bg); border-color: var(--color-primary); color: var(--color-primary); font-weight: var(--font-weight-medium); }

    /* Sort and area controls */
    .feed-controls { display: flex; align-items: center; justify-content: space-between; gap: var(--space-3); margin-bottom: var(--space-4); flex-wrap: wrap; }
    .feed-control-group { display: flex; align-items: center; gap: var(--space-2); }
    .feed-control-label { font-size: var(--font-size-xs); color: var(--color-text-muted); flex-shrink: 0; }
    .control-pill { padding: 4px 10px; border-radius: var(--radius-full); font-size: var(--font-size-xs); border: 1px solid var(--color-border-light); background: var(--color-bg-card); color: var(--color-text-muted); cursor: pointer; transition: all var(--transition-fast); }
    .control-pill:hover { border-color: var(--color-text-secondary); color: var(--color-text-secondary); }
    .control-pill.active { background: var(--color-bg-muted); border-color: var(--color-text-secondary); color: var(--color-text); font-weight: var(--font-weight-medium); }

    /* Category group headings */
    .category-group-heading { display: flex; align-items: center; gap: var(--space-2); padding: var(--space-3) 0 var(--space-2); font-family: var(--font-family-heading); font-size: var(--font-size-sm); font-weight: var(--font-weight-semibold); color: var(--color-text-secondary); border-bottom: 1px solid var(--color-border-light); margin-bottom: var(--space-3); }
    .category-group-heading .cat-count { font-weight: var(--font-weight-normal); color: var(--color-text-muted); }

    /* Active filter summary */
    .active-filters { display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-3); flex-wrap: wrap; }
    .clear-filters { font-size: var(--font-size-xs); color: var(--color-primary); cursor: pointer; background: none; border: none; padding: 0; text-decoration: underline; }

    /* Feedback FAB */
    .feedback-fab { position: fixed; bottom: var(--space-4); right: var(--space-4); display: flex; align-items: center; gap: var(--space-2); background: var(--color-primary); color: white; padding: var(--space-3) var(--space-4); border-radius: var(--radius-full); border: none; cursor: pointer; box-shadow: var(--shadow-lg); z-index: 1000; font-family: var(--font-family); font-size: var(--font-size-sm); font-weight: var(--font-weight-semibold); transition: all var(--transition-fast); }
    .feedback-fab:hover { background: var(--color-primary-dark); transform: translateY(-2px); }
    .feedback-fab svg { width: 18px; height: 18px; }

    /* Feedback Modal */
    .feedback-type-grid { display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-3); margin-bottom: var(--space-4); }
    .feedback-type-option { display: flex; flex-direction: column; align-items: center; padding: var(--space-4); background: var(--color-bg-warm); border: 2px solid var(--color-border); border-radius: var(--radius-md); cursor: pointer; transition: all var(--transition-fast); }
    .feedback-type-option:hover { border-color: var(--color-secondary); }
    .feedback-type-option.selected { border-color: var(--color-primary); background: var(--color-primary-bg); }
    .feedback-type-option input { position: absolute; opacity: 0; pointer-events: none; }
    .feedback-type-emoji { font-size: 1.5rem; margin-bottom: var(--space-2); }
    .feedback-type-label { font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); color: var(--color-text); }
    .feedback-type-desc { font-size: var(--font-size-xs); color: var(--color-text-muted); }

    /* Sign out link */
    .signout-link { color: var(--color-text-muted); font-size: var(--font-size-xs); text-decoration: none; cursor: pointer; }
    .signout-link:hover { color: var(--color-status-hold); }

    /* Degrees badge */
    .degrees-badge { display: inline-flex; align-items: center; gap: 3px; padding: 2px var(--space-2); border-radius: var(--radius-sm); font-size: 10px; font-weight: var(--font-weight-semibold); background: var(--color-primary-bg); color: var(--color-primary); }
    .degrees-badge svg { width: 12px; height: 12px; }

    /* Review badge */
    .review-count-badge { display: inline-flex; align-items: center; justify-content: center; min-width: 20px; height: 20px; padding: 0 6px; border-radius: var(--radius-full); background: var(--color-status-review); color: white; font-size: 11px; font-weight: var(--font-weight-bold); margin-left: var(--space-1); }

    /* Notification Bell */
    .notif-bell {
      position: relative;
      background: none;
      border: none;
      cursor: pointer;
      padding: var(--space-1);
      color: var(--color-text-muted);
      transition: color var(--transition-fast);
    }
    .notif-bell:hover { color: var(--color-primary); }
    .notif-bell svg { width: 22px; height: 22px; display: block; }
    .notif-bell-badge {
      position: absolute;
      top: -2px;
      right: -4px;
      min-width: 18px;
      height: 18px;
      padding: 0 5px;
      border-radius: var(--radius-full);
      background: var(--color-primary);
      color: white;
      font-size: 11px;
      font-weight: var(--font-weight-bold);
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }
    .notif-bell-badge:empty, .notif-bell-badge[data-count="0"] { display: none; }

    /* Notification Panel */
    .notif-panel {
      display: none;
      position: absolute;
      top: calc(100% + var(--space-2));
      right: 0;
      width: 320px;
      max-height: 400px;
      background: var(--color-bg-card);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      z-index: 1000;
      overflow: hidden;
    }
    .notif-panel.open { display: flex; flex-direction: column; }
    .notif-panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-3) var(--space-4);
      border-bottom: 1px solid var(--color-border-light);
    }
    .notif-panel-title {
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-semibold);
      color: var(--color-text);
    }
    .notif-mark-all {
      background: none;
      border: none;
      color: var(--color-primary);
      font-size: var(--font-size-xs);
      cursor: pointer;
      padding: var(--space-1) var(--space-2);
      border-radius: var(--radius-sm);
    }
    .notif-mark-all:hover { background: var(--color-primary-bg); }
    .notif-list {
      overflow-y: auto;
      flex: 1;
      max-height: 340px;
    }
    .notif-item {
      display: flex;
      gap: var(--space-3);
      padding: var(--space-3) var(--space-4);
      border-bottom: 1px solid var(--color-border-light);
      text-decoration: none;
      color: inherit;
      transition: background var(--transition-fast);
    }
    .notif-item:hover { background: var(--color-bg-warm); }
    .notif-item.unread { background: var(--color-primary-bg); }
    .notif-item.unread:hover { background: color-mix(in srgb, var(--color-primary-bg) 80%, var(--color-bg-warm)); }
    .notif-icon {
      width: 32px;
      height: 32px;
      border-radius: var(--radius-full);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-size: 16px;
    }
    .notif-content { flex: 1; min-width: 0; }
    .notif-title {
      font-size: var(--font-size-sm);
      color: var(--color-text);
      line-height: var(--line-height-snug);
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .notif-time {
      font-size: var(--font-size-xs);
      color: var(--color-text-muted);
      margin-top: 2px;
    }
    .notif-empty {
      text-align: center;
      padding: var(--space-8) var(--space-4);
      color: var(--color-text-muted);
      font-size: var(--font-size-sm);
    }
    .notif-wrapper {
      position: relative;
    }

    /* Invite needs */
    .invite-needs { background: var(--color-bg-warm); border-radius: var(--radius-md); padding: var(--space-3); margin-bottom: var(--space-2); }
    .invite-needs-label { font-size: var(--font-size-xs); font-weight: var(--font-weight-semibold); color: var(--color-text-muted); text-transform: uppercase; letter-spacing: 0.03em; margin-bottom: var(--space-2); }
    .invite-needs-tags { display: flex; flex-wrap: wrap; gap: var(--space-1); }
    .invite-need-tag { display: inline-flex; align-items: center; gap: 4px; padding: 3px var(--space-2); border-radius: var(--radius-full); font-size: var(--font-size-xs); font-weight: var(--font-weight-medium); background: var(--color-status-review-bg); color: var(--color-status-review); }
    .invite-need-tag.covered { background: var(--color-secondary-bg); color: var(--color-text-muted); }
  </style>
</head>
<body>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script>
  <script src="js/auth.js"></script>

  <!-- App shell - content injected by JS -->
  <div id="app">
    <div class="loading-state" style="min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center;">
      <div class="loading-spinner-lg"></div>
      <p style="color: var(--color-text-muted);">Loading Open Gobán...</p>
    </div>
  </div>

  <!-- ============================================================
       SCREEN 0: HOME
       ============================================================ -->
  <div id="screen-home" class="screen" style="display:none;">
    <div class="container">
      <header class="app-header-with-balance">
        <div class="app-logo">
          <div class="app-logo-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
              <polyline points="9 22 9 12 15 12 15 22"/>
            </svg>
          </div>
          <a href="credit-system.html#name" class="app-logo-text" style="text-decoration:none;color:inherit;">Open Gobán</a>
        </div>
        <p class="app-tagline">A digital meitheal &mdash; neighbours helping neighbours.</p>
        <div class="user-identity-section">
          <a href="profile.html" class="profile-chip" id="profile-chip" aria-label="View your profile">
            <span class="profile-chip-avatar" id="profile-chip-avatar">?</span>
            <span>
              <span class="profile-chip-name" id="header-user-name">You</span>
              <span class="profile-chip-id" id="header-member-id">OG-0001</span>
            </span>
          </a>
          <button class="balance-chip" onclick="openBalanceModal()" aria-label="View balance">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <path d="M12 6v6l4 2"/>
            </svg>
            <span class="balance-chip-value" id="balance-chip-value">5</span>
          </button>
          <div class="notif-wrapper">
            <button class="notif-bell" id="notif-bell" onclick="toggleNotifPanel()" aria-label="Notifications">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
              </svg>
              <span class="notif-bell-badge" id="notif-badge" data-count="0"></span>
            </button>
            <div class="notif-panel" id="notif-panel">
              <div class="notif-panel-header">
                <span class="notif-panel-title">Notifications</span>
                <button class="notif-mark-all" id="notif-mark-all" onclick="handleMarkAllRead()">Mark all read</button>
              </div>
              <div class="notif-list" id="notif-list">
                <div class="notif-empty">No notifications yet</div>
              </div>
            </div>
          </div>
        </div>
      </header>

      <!-- Welcome Card -->
      <div class="card card-welcome mb-6">
        <h2 class="card-title">Welcome to the meitheal</h2>
        <p class="card-subtitle mt-2">Share what you have. Ask for what you need. Neighbours helping neighbours, the way it used to work.</p>
        <div style="margin-top: var(--space-3);">
          <span class="pilot-badge">Pilot Programme</span>
        </div>
      </div>

      <!-- Main Actions -->
      <div class="flex flex-col gap-4 mb-6">
        <button class="btn btn-secondary btn-xl btn-block" onclick="selectMode('need')">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
          I need something
        </button>
        <button class="btn btn-primary btn-xl btn-block" onclick="selectMode('offer')">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
          I can offer help
        </button>
      </div>

      <!-- Quick Links -->
      <div style="display: flex; gap: var(--space-3); margin-bottom: var(--space-6); flex-wrap: wrap;">
        <a href="directory.html" class="btn btn-ghost" style="flex: 1; min-width: 120px; justify-content: center;">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
          Directory
        </a>
        <a href="exchanges.html" class="btn btn-ghost" style="flex: 1; min-width: 120px; justify-content: center;">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
          My Exchanges
        </a>
        <a href="connections.html" class="btn btn-ghost" style="flex: 1; min-width: 120px; justify-content: center;">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><path d="M20 8v6"/><path d="M23 11h-6"/></svg>
          Connections
        </a>
        <a href="my-feedback.html" class="btn btn-ghost" style="flex: 1; min-width: 120px; justify-content: center;">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
          My Feedback
        </a>
        <a href="review.html" class="btn btn-ghost" id="admin-review-link" style="flex: 1; min-width: 120px; justify-content: center; display: none;">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
          Review<span class="review-count-badge" id="review-count-badge" style="display:none;">0</span>
        </a>
        <a href="triage.html" class="btn btn-ghost" id="admin-hub-link" style="flex: 1; min-width: 120px; justify-content: center; display: none;">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20v-4"/></svg>
          Admin
        </a>
      </div>

      <!-- Search -->
      <div class="feed-search">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <input type="text" class="feed-search-input" id="feed-search-input" placeholder="Search listings and members..." autocomplete="off" spellcheck="false" oninput="handleFeedSearch(this.value)">
      </div>
      <div id="member-search-results"></div>

      <!-- Community Feed -->
      <div class="feed-section">
        <h3 class="feed-title">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
          Community board
        </h3>
        <div id="whats-new-container"></div>
        <div class="feed-tabs">
          <button class="feed-tab active" onclick="filterFeed('all')">All</button>
          <button class="feed-tab" onclick="filterFeed('offer')">Offers</button>
          <button class="feed-tab" onclick="filterFeed('need')">Needs</button>
        </div>
        <div class="feed-filters">
          <div class="category-pills" id="category-pills"></div>
        </div>
        <div class="feed-controls">
          <div class="feed-control-group">
            <span class="feed-control-label">Sort:</span>
            <button class="control-pill active" onclick="setSort('newest')">Newest</button>
            <button class="control-pill" onclick="setSort('category')">By category</button>
            <button class="control-pill" onclick="setSort('urgent')">Urgent first</button>
          </div>
          <!-- Area filter hidden for now — revisit when geocoding is added -->
          <!--
          <div class="feed-control-group">
            <span class="feed-control-label">Area:</span>
            <button class="control-pill active" onclick="setArea('all')">All</button>
            <button class="control-pill" onclick="setArea('neighbourhood')">Near</button>
            <button class="control-pill" onclick="setArea('village')">Village</button>
            <button class="control-pill" onclick="setArea('nearby')">10km</button>
          </div>
          -->
        </div>
        <div id="feed-list">
          <div class="loading-state"><div class="loading-spinner-lg"></div></div>
        </div>
      </div>

      <!-- Invite Section -->
      <div class="card card-elevated">
        <div class="card-header">
          <h3 class="card-title">Grow your village</h3>
          <p class="card-subtitle" id="invite-status">Loading...</p>
        </div>
        <button class="btn btn-outline btn-block" id="invite-btn" onclick="openInviteModal()" disabled>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
          Invite a neighbour
        </button>
        <div id="my-invites-list" style="margin-top: var(--space-4);"></div>
        <details style="margin-top: var(--space-4);">
          <summary style="font-size: var(--font-size-sm); color: var(--color-text-muted); cursor: pointer;">Why are invites limited?</summary>
          <div class="balance-explanation" style="margin-top: var(--space-3);">
            <p>We keep this community small on purpose. Research shows groups of around <strong>80 people</strong> are the sweet spot &mdash; large enough to be useful, small enough that everyone still recognises each other.</p>
            <p style="margin-top: var(--space-3);">Every member starts with <strong>2 invites</strong>. That way, you'll think carefully about who you bring in &mdash; because your reputation backs theirs. As you complete exchanges and prove you're active, you can <strong>earn up to 5</strong>.</p>
            <p style="margin-top: var(--space-3);">This isn't a social network trying to grow forever. It's a village &mdash; and villages work because people know and trust each other.</p>
          </div>
        </details>
      </div>

      <!-- Footer -->
      <footer class="app-footer" style="margin-top: var(--space-6);">
        <div class="app-footer-text">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
          Made for local communities.
        </div>
        <div style="margin-top: var(--space-3);">
          <a href="credit-system.html" style="color: var(--color-text-muted); font-size: var(--font-size-xs); text-decoration: none;">How Credits Work</a>
          <span style="color: var(--color-text-muted); margin: 0 var(--space-2);">&middot;</span>
          <a href="the-cell.html" style="color: var(--color-text-muted); font-size: var(--font-size-xs); text-decoration: none;">The Protocol</a>
          <span style="color: var(--color-text-muted); margin: 0 var(--space-2);">&middot;</span>
          <a href="charter.html" style="color: var(--color-text-muted); font-size: var(--font-size-xs); text-decoration: none;">Governance</a>
          <span style="color: var(--color-text-muted); margin: 0 var(--space-2);">&middot;</span>
          <a href="terms.html" style="color: var(--color-text-muted); font-size: var(--font-size-xs); text-decoration: none;">Terms</a>
          <span style="color: var(--color-text-muted); margin: 0 var(--space-2);">&middot;</span>
          <a href="privacy.html" style="color: var(--color-text-muted); font-size: var(--font-size-xs); text-decoration: none;">Privacy</a>
          <span style="color: var(--color-text-muted); margin: 0 var(--space-2);">&middot;</span>
          <a href="#" class="signout-link" onclick="handleSignOut(); return false;">Sign out</a>
        </div>
      </footer>
    </div>
  </div>

  <!-- ============================================================
       SCREEN 1: CATEGORY SELECTION
       ============================================================ -->
  <div id="screen-category" class="screen" style="display:none;">
    <div class="container">
      <header class="app-header-minimal" style="display: flex; justify-content: space-between; align-items: center;">
        <div style="display: flex; align-items: center; gap: var(--space-2);">
          <button class="btn btn-icon btn-ghost" onclick="goBack()" aria-label="Go back">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
          </button>
          <div class="app-logo">
            <div class="app-logo-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></div>
            <a href="credit-system.html#name" class="app-logo-text" style="text-decoration:none;color:inherit;">Open Gobán</a>
          </div>
        </div>
      </header>
      <div class="card card-elevated mb-4">
        <h2 class="card-title" id="category-title">What do you need?</h2>
        <p class="card-subtitle">Pick the closest match — you can add details next.</p>
      </div>
      <div class="category-list" id="category-list"></div>
    </div>
  </div>

  <!-- ============================================================
       SCREEN 2: DESCRIBE
       ============================================================ -->
  <div id="screen-describe" class="screen" style="display:none;">
    <div class="container">
      <header class="app-header-minimal" style="display: flex; justify-content: space-between; align-items: center;">
        <div style="display: flex; align-items: center; gap: var(--space-2);">
          <button class="btn btn-icon btn-ghost" onclick="goBack()" aria-label="Go back">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
          </button>
          <div class="app-logo">
            <div class="app-logo-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg></div>
            <a href="credit-system.html#name" class="app-logo-text" style="text-decoration:none;color:inherit;">Open Gobán</a>
          </div>
        </div>
      </header>

      <div class="card card-elevated">
        <div class="card-header">
          <h2 class="card-title">Tell us more</h2>
          <p class="card-subtitle">A few details help neighbours find you.</p>
        </div>

        <div class="form-group">
          <label class="form-label">Title <span style="color: var(--color-status-hold);">*</span></label>
          <input type="text" class="input" id="listing-title" placeholder="e.g., Need help moving a sofa this Saturday" maxlength="120">
        </div>

        <div class="form-group">
          <label class="form-label">Description (optional)</label>
          <textarea class="textarea" id="listing-description" placeholder="Add more details..." rows="3"></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">Tags (optional)</label>
          <input type="text" class="input" id="listing-tags" placeholder="e.g., gardening, heavy lifting">
          <p class="form-hint">Separate with commas</p>
        </div>

        <!-- Area selector hidden until geocoding is added -->
        <!--
        <div class="form-group">
          <label class="form-label">Area</label>
          <div class="area-select" id="area-select">
            <label class="area-option" data-area="neighbourhood">
              <input type="radio" name="listing-area" value="neighbourhood">
              <div class="area-option-radio"></div>
              <div class="area-option-content"><div class="area-option-label">My neighbourhood</div><div class="area-option-desc">Walking distance</div></div>
            </label>
            <label class="area-option selected" data-area="village">
              <input type="radio" name="listing-area" value="village" checked>
              <div class="area-option-radio"></div>
              <div class="area-option-content"><div class="area-option-label">My village</div><div class="area-option-desc">Local area</div></div>
            </label>
            <label class="area-option" data-area="nearby">
              <input type="radio" name="listing-area" value="nearby">
              <div class="area-option-radio"></div>
              <div class="area-option-content"><div class="area-option-label">Nearby (within 10km)</div><div class="area-option-desc">Short drive</div></div>
            </label>
          </div>
        </div>
        -->

        <div class="form-group">
          <label class="form-label">When?</label>
          <div class="flex gap-2">
            <button class="btn btn-ghost flex-1" data-picker="urgency" data-value="Today" onclick="selectPicker(this)">Today</button>
            <button class="btn btn-outline flex-1" data-picker="urgency" data-value="This week" onclick="selectPicker(this)">This week</button>
            <button class="btn btn-ghost flex-1" data-picker="urgency" data-value="Flexible" onclick="selectPicker(this)">Flexible</button>
          </div>
        </div>

        <!-- Safety Warning (shown for high-risk categories) -->
        <div class="safety-warning" id="safety-warning">
          <div class="safety-warning-header">
            <svg class="safety-warning-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
            <span class="safety-warning-title">Safety notice</span>
          </div>
          <p class="safety-warning-text">Some help can carry risk. Agree details directly with your neighbour. Open Gobán is a noticeboard — we don't provide insurance or supervision.</p>
          <label class="safety-checkbox">
            <input type="checkbox" id="safety-confirmed">
            <span class="safety-checkbox-label">I understand Open Gobán is a noticeboard and I'm responsible for assessing safety.</span>
          </label>
        </div>

        <button class="btn btn-primary btn-lg btn-block mt-6" id="submit-btn" onclick="submitListing()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
          Post to community
        </button>
      </div>
    </div>
  </div>

  <!-- ============================================================
       SCREEN 3: SUCCESS
       ============================================================ -->
  <div id="screen-success" class="screen" style="display:none;">
    <div style="padding: var(--space-3) var(--space-4) 0;">
      <button class="btn btn-icon btn-ghost" onclick="startOver()" aria-label="Back to home">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>
      </button>
    </div>
    <div class="status-page">
      <div class="status-card">
        <div class="status-icon">🌿</div>
        <h1 class="status-title" style="color: var(--color-status-accepted);">Posted!</h1>
        <p class="status-message">Your neighbours will see this soon. Good things take root in community.</p>
        <div class="card mb-6" id="summary-card"></div>
        <button class="btn btn-primary btn-block" onclick="startOver()">Back to home</button>
      </div>
    </div>
  </div>

  <!-- ============================================================
       INVITE MODAL
       ============================================================ -->
  <div class="modal-overlay" id="invite-modal">
    <div class="modal">
      <div id="invite-form-view">
        <div class="modal-header">
          <h2 class="modal-title">Invite a neighbour</h2>
          <p class="modal-subtitle">Grow the meitheal by inviting neighbours you trust.</p>
        </div>
        <div class="modal-body">
          <div id="invite-needs" class="invite-needs" style="display: none;"></div>
          <div class="form-group">
            <label class="form-label">Their name <span class="required">*</span></label>
            <input type="text" class="input" id="invite-name" placeholder="e.g., Sarah">
          </div>
          <div class="form-group">
            <label class="form-label">Their email (optional)</label>
            <input type="email" class="input" id="invite-email" placeholder="e.g., sarah@example.com">
          </div>
          <div class="form-group">
            <label class="form-label">Note (optional)</label>
            <input type="text" class="input" id="invite-note" placeholder="e.g., Lives on Oak Street">
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-ghost" onclick="closeInviteModal()">Cancel</button>
          <button class="btn btn-primary" onclick="sendInvite()">Create invite link</button>
        </div>
      </div>
      <div id="invite-success-view" style="display: none;">
        <div class="modal-header">
          <h2 class="modal-title">Invite created!</h2>
          <p class="modal-subtitle">Share this link with <strong id="invite-success-name"></strong></p>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label class="form-label">Invite link</label>
            <div style="display: flex; gap: var(--space-2);">
              <input type="text" class="input" id="invite-link" readonly style="font-size: var(--font-size-sm); background: var(--color-bg-warm);">
              <button class="btn btn-primary" onclick="copyInviteLinkToClipboard()" id="copy-btn">Copy</button>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-ghost" onclick="closeInviteModal()">Done</button>
          <button class="btn btn-secondary" onclick="shareInviteLink()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>
            Share
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ============================================================
       BALANCE MODAL
       ============================================================ -->
  <div class="modal-overlay" id="balance-modal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Your Balance</h2>
        <p class="modal-subtitle">Community credits earned through helping neighbours.</p>
      </div>
      <div class="modal-body balance-modal-content">
        <div class="balance-display">
          <div class="balance-amount" id="balance-modal-amount">5</div>
          <div class="balance-label">Community Credits</div>
        </div>
        <div class="balance-explanation">
          <p><strong>How it works:</strong> When you help a neighbour, you earn credits. When you receive help, you spend credits. This keeps the community exchange balanced and fair for everyone.</p>
        </div>
        <div class="adjustments-section">
          <div class="adjustments-title">Recent Activity</div>
          <div class="adjustment-list" id="adjustment-list"></div>
        </div>
        <div style="margin-top: var(--space-4); text-align: center;">
          <a href="credit-system.html" class="btn btn-ghost" style="width: 100%; justify-content: center;">How credits work</a>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary btn-block" onclick="closeBalanceModal()">Done</button>
      </div>
    </div>
  </div>

  <!-- ============================================================
       FEEDBACK MODAL
       ============================================================ -->
  <div class="modal-overlay" id="feedback-modal">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title">Send Feedback</h2>
        <p class="modal-subtitle">Help us improve Open Gobán.</p>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">What type of feedback?</label>
          <div class="feedback-type-grid" id="feedback-type-grid">
            <label class="feedback-type-option selected" data-type="idea"><input type="radio" name="feedback-type" value="idea" checked><span class="feedback-type-emoji">💡</span><span class="feedback-type-label">Idea</span></label>
            <label class="feedback-type-option" data-type="bug"><input type="radio" name="feedback-type" value="bug"><span class="feedback-type-emoji">🐛</span><span class="feedback-type-label">Bug</span></label>
            <label class="feedback-type-option" data-type="question"><input type="radio" name="feedback-type" value="question"><span class="feedback-type-emoji">❓</span><span class="feedback-type-label">Question</span></label>
            <label class="feedback-type-option" data-type="other"><input type="radio" name="feedback-type" value="other"><span class="feedback-type-emoji">💬</span><span class="feedback-type-label">Other</span></label>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Your message</label>
          <textarea class="textarea" id="feedback-message" placeholder="Tell us what's on your mind..." rows="4"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost" onclick="closeFeedbackModal()">Cancel</button>
        <button class="btn btn-primary" onclick="submitFeedbackForm()">Send</button>
      </div>
    </div>
  </div>

  <!-- Feedback FAB -->
  <button class="feedback-fab" onclick="openFeedbackModal()" style="display:none;" id="feedback-fab">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
    Feedback
  </button>

  <script>
    // =====================================================
    // STATE
    // =====================================================
    let currentMember = null;
    let currentBalance = { credits: 5, total_earned: 0, total_spent: 0 };
    let allListings = [];
    let allMembers = [];
    let myExchanges = [];
    let currentFilter = 'all';
    let currentCategory = null;
    let currentSort = 'newest';
    let currentArea = 'all';
    let feedSearchQuery = '';
    let feedSearchRegex = null;
    let lastVisit = null; // ISO timestamp of previous visit

    const postState = {
      mode: null,
      category: null,
      urgency: 'This week',
      area: 'village'
    };

    const SAFETY_RISK_CATEGORIES = ['care_support', 'home_property', 'tools_things'];
    const screenHistory = ['screen-home'];
    let notifSubscription = null;

    // =====================================================
    // NOTIFICATIONS
    // =====================================================

    const NOTIF_ICONS = {
      proposal_received: '📩',
      proposal_accepted: '✅',
      proposal_declined: '❌',
      exchange_confirmed: '🤝',
      exchange_completed: '🎉',
      exchange_cancelled: '🚫'
    };

    async function loadNotifications() {
      try {
        const [notifications, count] = await Promise.all([
          getMyNotifications(20),
          getUnreadNotificationCount()
        ]);
        updateNotifBadge(count);
        renderNotifList(notifications);
      } catch (e) {
        console.error('Failed to load notifications:', e);
      }
    }

    function updateNotifBadge(count) {
      const badge = document.getElementById('notif-badge');
      if (!badge) return;
      badge.textContent = count > 0 ? (count > 9 ? '9+' : count) : '';
      badge.setAttribute('data-count', count);
    }

    function renderNotifList(notifications) {
      const list = document.getElementById('notif-list');
      if (!list) return;

      if (!notifications.length) {
        list.innerHTML = '<div class="notif-empty">No notifications yet</div>';
        document.getElementById('notif-mark-all').style.display = 'none';
        return;
      }

      document.getElementById('notif-mark-all').style.display = '';

      list.innerHTML = notifications.map(n => {
        const icon = NOTIF_ICONS[n.type] || '🔔';
        const isUnread = !n.read_at;
        const time = formatRelativeTime(n.created_at);
        const href = n.link || '#';
        return `
          <a class="notif-item ${isUnread ? 'unread' : ''}" href="${escapeHtml(href)}" data-id="${n.id}" onclick="handleNotifClick(event, '${n.id}')">
            <div class="notif-icon">${icon}</div>
            <div class="notif-content">
              <div class="notif-title">${escapeHtml(n.title)}</div>
              <div class="notif-time">${time}</div>
            </div>
          </a>
        `;
      }).join('');
    }

    function toggleNotifPanel() {
      const panel = document.getElementById('notif-panel');
      panel.classList.toggle('open');
    }

    function closeNotifPanel() {
      const panel = document.getElementById('notif-panel');
      if (panel) panel.classList.remove('open');
    }

    async function handleNotifClick(event, notifId) {
      // Mark as read when clicked
      try {
        await markNotificationRead(notifId);
        const count = await getUnreadNotificationCount();
        updateNotifBadge(count);
        // Update the clicked item's style
        const item = event.currentTarget;
        if (item) item.classList.remove('unread');
      } catch (e) {
        console.error('Failed to mark notification read:', e);
      }
    }

    async function handleMarkAllRead() {
      try {
        await markAllNotificationsRead();
        updateNotifBadge(0);
        // Remove unread styling from all items
        document.querySelectorAll('.notif-item.unread').forEach(el => el.classList.remove('unread'));
        closeNotifPanel();
      } catch (e) {
        console.error('Failed to mark all read:', e);
      }
    }

    // Close panel when clicking outside
    document.addEventListener('click', (e) => {
      const wrapper = document.querySelector('.notif-wrapper');
      if (wrapper && !wrapper.contains(e.target)) {
        closeNotifPanel();
      }
    });

    // =====================================================
    // INITIALIZATION
    // =====================================================
    async function init() {
      try {
        const session = await getAuthSession();
        if (!session) {
          window.location.href = 'access.html';
          return;
        }

        currentMember = await getCurrentMember();
        if (!currentMember) {
          // Retry once in case of transient network/RLS failure
          await new Promise(r => setTimeout(r, 1000));
          currentMember = await getCurrentMember().catch(() => null);
        }
        if (!currentMember) {
          // No member record — check if invite flow is pending
          const inviteToken = localStorage.getItem('cc_pending_invite_token');
          if (inviteToken) {
            // Has invite, needs to complete join flow
            window.location.href = 'join.html';
          } else {
            // No member and no invite — redirect without destroying session
            window.location.href = 'access.html';
          }
          return;
        }

        if (currentMember.status === 'PENDING_PROFILE') {
          window.location.href = 'join.html';
          return;
        }

        if (currentMember.status === 'REVIEW' || currentMember.status === 'HOLD') {
          window.location.href = 'join-status.html';
          return;
        }

        // Hide loading, show app
        document.getElementById('app').style.display = 'none';
        showScreen('screen-home');
        document.getElementById('feedback-fab').style.display = 'flex';

        // Read last visit timestamp before loading feed
        lastVisit = localStorage.getItem('cc_last_visited') || null;

        // Populate UI
        updateUserIdentity();
        await loadBalance();
        allMembers = await getAcceptedMembers();
        await loadFeed();
        renderWhatsNew();
        updateInviteStatus();

        // Update last visit to now (after rendering so badges show correctly)
        localStorage.setItem('cc_last_visited', new Date().toISOString());

        // Update last_seen_at in DB (once per session)
        if (!sessionStorage.getItem('cc_seen_updated')) {
          updateMember(currentMember.id, { last_seen_at: new Date().toISOString() }).catch(() => {});
          sessionStorage.setItem('cc_seen_updated', '1');
        }
        initAreaSelection();
        initFeedbackTypeSelection();

        // Show admin links if admin
        if (currentMember.role === 'admin' || currentMember.role === 'moderator') {
          showAdminReviewBadge();
          const hubLink = document.getElementById('admin-hub-link');
          if (hubLink) hubLink.style.display = '';
        }

        // Load notifications
        await loadNotifications();

        // Open notification panel if linked via #notifications
        if (window.location.hash === '#notifications') {
          const panel = document.getElementById('notif-panel');
          if (panel) panel.classList.add('open');
          history.replaceState(null, '', window.location.pathname + window.location.search);
        }

        // Subscribe to realtime listing updates
        subscribeToListings((payload) => {
          loadFeed(); // Refresh feed on any change
        });

        // Subscribe to realtime notification updates
        notifSubscription = subscribeToNotifications(currentMember.id, () => {
          loadNotifications();
        });

      } catch (e) {
        console.error('Init error:', e);
        document.getElementById('app').innerHTML = `
          <div style="text-align:center;padding:40px;">
            <p>Something went wrong loading the app.</p>
            <a href="access.html" style="color:var(--color-primary);">Sign in again</a>
          </div>
        `;
      }
    }

    // =====================================================
    // NAVIGATION
    // =====================================================
    function showScreen(screenId) {
      document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
      document.getElementById(screenId).style.display = 'block';
      window.scrollTo(0, 0);
    }

    function navigateTo(screenId) {
      screenHistory.push(screenId);
      history.pushState({ screen: screenId }, '', '');
      showScreen(screenId);
    }

    function goBack() {
      if (screenHistory.length > 1) {
        screenHistory.pop();
        showScreen(screenHistory[screenHistory.length - 1]);
      }
    }

    // Browser back button support
    window.addEventListener('popstate', function(e) {
      if (screenHistory.length > 1) {
        screenHistory.pop();
        showScreen(screenHistory[screenHistory.length - 1]);
      }
    });

    // =====================================================
    // USER IDENTITY
    // =====================================================
    function updateUserIdentity() {
      const name = currentMember.display_name || 'You';
      document.getElementById('header-user-name').textContent = name;
      document.getElementById('header-member-id').textContent = currentMember.member_id || '';
      const initials = name.split(' ').map(w => w[0]).join('').slice(0, 2).toUpperCase();
      document.getElementById('profile-chip-avatar').textContent = initials || '?';
    }

    // =====================================================
    // BALANCE
    // =====================================================
    async function loadBalance() {
      try {
        currentBalance = await getBalance(currentMember.id);
      } catch (e) {
        console.error('Balance load error:', e);
      }
      updateBalanceDisplay();
    }

    function updateBalanceDisplay() {
      document.querySelectorAll('.balance-chip-value').forEach(el => {
        el.textContent = currentBalance.credits;
      });
      const modalAmount = document.getElementById('balance-modal-amount');
      if (modalAmount) modalAmount.textContent = currentBalance.credits;
    }

    async function openBalanceModal() {
      updateBalanceDisplay();
      await renderAdjustmentsList();
      document.getElementById('balance-modal').classList.add('active');
    }

    function closeBalanceModal() {
      document.getElementById('balance-modal').classList.remove('active');
    }

    async function renderAdjustmentsList() {
      const container = document.getElementById('adjustment-list');
      try {
        const history = await getBalanceHistory(currentMember.id, 5);
        if (history.length === 0) {
          container.innerHTML = `<div class="no-adjustments"><p>No activity yet.</p><p style="margin-top:var(--space-2);">Start by helping a neighbour or posting what you need!</p></div>`;
          return;
        }
        container.innerHTML = history.map(adj => {
          const isPositive = adj.amount > 0;
          return `<div class="adjustment-item"><div class="adjustment-info"><div class="adjustment-reason">${adj.reason}</div><div class="adjustment-date">${formatDate(adj.created_at)}</div></div><div class="adjustment-amount ${isPositive ? 'positive' : 'negative'}">${isPositive ? '+' : ''}${adj.amount}</div></div>`;
        }).join('');
      } catch (e) {
        container.innerHTML = `<div class="no-adjustments"><p>Could not load activity.</p></div>`;
      }
    }

    // =====================================================
    // COMMUNITY FEED
    // =====================================================
    async function loadFeed() {
      try {
        const [listings, exchanges] = await Promise.all([
          getActiveListings(),
          getActiveExchanges(currentMember.id).catch(() => [])
        ]);
        allListings = listings;
        myExchanges = exchanges;
        renderFeed();
      } catch (e) {
        console.error('Feed load error:', e);
        document.getElementById('feed-list').innerHTML = `<div class="empty-feed"><p>Could not load listings.</p></div>`;
      }
    }

    function filterFeed(type) {
      currentFilter = type;
      document.querySelectorAll('.feed-tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      renderFeed();
    }

    function setCategory(catId) {
      currentCategory = currentCategory === catId ? null : catId;
      renderCategoryPills();
      renderFeed();
    }

    function setSort(sort) {
      currentSort = sort;
      document.querySelectorAll('.feed-controls .feed-control-group:first-child .control-pill').forEach(p => p.classList.remove('active'));
      event.target.classList.add('active');
      renderFeed();
    }

    function setArea(area) {
      currentArea = area;
      document.querySelectorAll('.feed-controls .feed-control-group:last-child .control-pill').forEach(p => p.classList.remove('active'));
      event.target.classList.add('active');
      renderFeed();
    }

    function clearAllFilters() {
      currentFilter = 'all';
      currentCategory = null;
      currentSort = 'newest';
      currentArea = 'all';
      feedSearchQuery = '';
      document.getElementById('feed-search-input').value = '';
      document.querySelectorAll('.feed-tab').forEach(t => t.classList.remove('active'));
      document.querySelector('.feed-tab').classList.add('active');
      document.querySelectorAll('.feed-controls .control-pill').forEach(p => p.classList.remove('active'));
      document.querySelectorAll('.feed-controls .control-pill:first-child').forEach(p => p.classList.add('active'));
      renderCategoryPills();
      renderFeed();
      renderMemberSearchResults();
    }

    function renderCategoryPills() {
      const container = document.getElementById('category-pills');
      // Only show categories that have active listings
      const activeCats = new Set(allListings.map(l => l.category));
      const pills = CATEGORIES.filter(c => activeCats.has(c.id)).map(c => {
        const count = allListings.filter(l => l.category === c.id).length;
        const active = currentCategory === c.id ? ' active' : '';
        return `<button class="cat-pill${active}" onclick="setCategory('${c.id}')">${c.emoji} ${c.label} <span style="opacity:0.6;">${count}</span></button>`;
      }).join('');
      container.innerHTML = pills;
    }

    function renderListingCard(listing) {
      const cat = getCategoryById(listing.category);
      const author = listing.author || {};
      const tags = (listing.tags || []).map(t => `<span style="background:var(--color-bg-muted);padding:2px 8px;border-radius:var(--radius-sm);font-size:var(--font-size-xs);color:var(--color-text-muted);">${t}</span>`).join('');
      const isNew = lastVisit && listing.created_at > lastVisit;
      const isNotice = listing.category === 'events_community';
      const typeLabel = isNotice ? '' : `<span class="listing-row-type ${listing.type}">${listing.type === 'offer' ? 'O' : 'N'}</span>`;

      // Build expanded body content
      const desc = listing.description ? `<div class="listing-row-desc">${escapeHtml(listing.description)}</div>` : '';
      const tagBlock = tags ? `<div class="listing-row-tags">${tags}</div>` : '';

      const metaParts = [];
      metaParts.push(escapeHtml(author.display_name || 'Unknown'));
      if (!isNotice) {
        const areaLabel = listing.area === 'neighbourhood' ? 'Neighbourhood' : listing.area === 'village' ? 'Village' : 'Nearby';
        metaParts.push(areaLabel);
        if (listing.urgency) metaParts.push(listing.urgency);
      }
      const metaText = metaParts.join(' · ');

      return `
        <details class="listing-row">
          <summary>
            <span>${cat.emoji}</span>
            ${typeLabel}
            <span class="listing-row-title">${escapeHtml(listing.title)}${isNew ? ' <span class="new-badge">New</span>' : ''}</span>
            <span class="listing-row-time">${formatRelativeTime(listing.created_at)}</span>
            <svg class="listing-row-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
          </summary>
          <div class="listing-row-body">
            ${desc}
            ${tagBlock}
            <div class="listing-row-meta">
              <span>${metaText}</span>
              ${renderProposalBadge(listing)}
              <a href="listing.html?id=${listing.id}">View listing →</a>
            </div>
          </div>
        </details>
      `;
    }

    function renderFeed() {
      const container = document.getElementById('feed-list');
      let filtered = allListings;

      // Apply type filter
      if (currentFilter !== 'all') {
        filtered = filtered.filter(l => l.type === currentFilter);
      }
      // Apply category filter
      if (currentCategory) {
        filtered = filtered.filter(l => l.category === currentCategory);
      }
      // Apply area filter
      if (currentArea !== 'all') {
        filtered = filtered.filter(l => l.area === currentArea);
      }
      // Apply search
      if (feedSearchQuery) {
        filtered = filtered.filter(l => {
          const fields = [
            l.title || '',
            l.description || '',
            ...(l.tags || []),
            (l.author || {}).display_name || ''
          ].join(' ');
          return matchesSearch(fields);
        });
      }

      // Update category pills to reflect current listings
      renderCategoryPills();

      if (filtered.length === 0) {
        const hasFilters = currentFilter !== 'all' || currentCategory || currentArea !== 'all' || feedSearchQuery;
        container.innerHTML = `
          <div class="empty-feed">
            <div class="empty-feed-icon">${hasFilters ? '🔍' : '🌱'}</div>
            <div class="empty-feed-title">${hasFilters ? 'No matches' : 'No listings yet'}</div>
            <p>${hasFilters ? 'Try broadening your filters.' : 'Be the first to post an offer or need!'}</p>
            ${hasFilters ? '<button class="clear-filters" onclick="clearAllFilters()" style="margin-top:var(--space-3);">Clear all filters</button>' : ''}
          </div>
        `;
        return;
      }

      // Build new member cards
      let newMemberCards = '';
      if (lastVisit && !feedSearchQuery && currentFilter === 'all' && !currentCategory && currentArea === 'all') {
        const newMembers = allMembers.filter(m =>
          m.accepted_at && m.accepted_at > lastVisit && m.id !== currentMember.id
        );
        newMemberCards = newMembers.map(m => {
          const initials = getInitials(m.display_name);
          const cat = m.primary_category ? getCategoryById(m.primary_category) : null;
          const catLabel = cat ? cat.emoji + ' ' + cat.label : '';
          return `
            <a href="profile.html?id=${m.id}" class="new-member-card">
              <div class="new-member-avatar">${initials}</div>
              <div class="new-member-info">
                <div class="new-member-name">${escapeHtml(m.display_name)} joined Open Gobán</div>
                <div class="new-member-detail">${catLabel}</div>
              </div>
              <span class="new-member-badge">New</span>
            </a>
          `;
        }).join('');
      }

      // Sort
      const urgencyOrder = { 'Today': 0, 'This week': 1, 'Flexible': 2 };

      if (currentSort === 'urgent') {
        filtered = [...filtered].sort((a, b) => {
          const ua = urgencyOrder[a.urgency] ?? 1;
          const ub = urgencyOrder[b.urgency] ?? 1;
          if (ua !== ub) return ua - ub;
          return new Date(b.created_at) - new Date(a.created_at);
        });
      } else if (currentSort === 'newest') {
        filtered = [...filtered].sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
      }
      // 'category' sort handled below via grouping

      // Render
      if (currentSort === 'category') {
        // Group by category
        const groups = {};
        filtered.forEach(l => {
          if (!groups[l.category]) groups[l.category] = [];
          groups[l.category].push(l);
        });
        // Sort groups by CATEGORIES order
        const catOrder = CATEGORIES.map(c => c.id);
        const sortedKeys = Object.keys(groups).sort((a, b) => catOrder.indexOf(a) - catOrder.indexOf(b));

        let html = newMemberCards;
        sortedKeys.forEach(catId => {
          const cat = getCategoryById(catId);
          const items = groups[catId].sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
          html += `<div class="category-group-heading">${cat.emoji} ${cat.label} <span class="cat-count">(${items.length})</span></div>`;
          html += items.map(renderListingCard).join('');
        });
        container.innerHTML = html;
      } else {
        container.innerHTML = newMemberCards + filtered.map(renderListingCard).join('');
      }
    }

    function getInitials(name) {
      if (!name) return '?';
      const parts = name.trim().split(/\s+/);
      if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
      return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
    }

    function renderWhatsNew() {
      const container = document.getElementById('whats-new-container');
      if (!container || !lastVisit) return;

      const newListings = allListings.filter(l => l.created_at > lastVisit);
      const newMembers = allMembers.filter(m => m.accepted_at && m.accepted_at > lastVisit && m.id !== currentMember.id);

      if (newListings.length === 0 && newMembers.length === 0) return;

      const parts = [];
      if (newListings.length > 0) {
        parts.push(`<strong>${newListings.length}</strong> new listing${newListings.length !== 1 ? 's' : ''}`);
      }
      if (newMembers.length > 0) {
        parts.push(`<strong>${newMembers.length}</strong> new member${newMembers.length !== 1 ? 's' : ''}`);
      }

      container.innerHTML = `
        <div class="whats-new-banner">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
          <span>Welcome back! ${parts.join(' and ')} since your last visit.</span>
          <button class="whats-new-dismiss" onclick="dismissWhatsNew()" title="Dismiss">&times;</button>
        </div>
      `;
    }

    function dismissWhatsNew() {
      const container = document.getElementById('whats-new-container');
      if (container) container.innerHTML = '';
    }

    function renderProposalBadge(listing) {
      if (listing.author_id !== currentMember.id) return '';
      const proposals = myExchanges.filter(ex => ex.listing_id === listing.id && ex.status === 'proposed');
      if (proposals.length === 0) return '';
      return `
        <div style="margin-top:var(--space-3);padding:var(--space-2) var(--space-3);background:var(--color-status-review-bg);border-radius:var(--radius-md);display:inline-flex;align-items:center;gap:var(--space-2);font-size:var(--font-size-xs);font-weight:var(--font-weight-semibold);color:var(--color-status-review);">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
          ${proposals.length} proposal${proposals.length !== 1 ? 's' : ''} waiting
        </div>
      `;
    }

    // =====================================================
    // FEED SEARCH
    // =====================================================
    function handleFeedSearch(value) {
      feedSearchQuery = value.trim().toLowerCase();
      try {
        const escaped = feedSearchQuery.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        feedSearchRegex = feedSearchQuery ? new RegExp('\\b' + escaped + '\\b', 'i') : null;
      } catch (e) { feedSearchRegex = null; }
      renderFeed();
      renderMemberSearchResults();
    }

    function matchesSearch(text) {
      if (!feedSearchRegex) return false;
      return feedSearchRegex.test(text);
    }

    function renderMemberSearchResults() {
      const container = document.getElementById('member-search-results');
      if (!feedSearchQuery || feedSearchQuery.length < 2) {
        container.innerHTML = '';
        return;
      }

      // Exclude system account and current member
      const matches = allMembers.filter(m => {
        if (m.email === 'bootstrap@system') return false;
        if (m.id === currentMember.id) return false;
        const fields = [
          m.display_name || '',
          ...(Array.isArray(m.skill_tags) ? m.skill_tags : []),
          m.bio || '',
          m.area || ''
        ].join(' ');
        return matchesSearch(fields);
      });

      if (matches.length === 0) {
        container.innerHTML = '';
        return;
      }

      const getInitials = (name) => {
        if (!name) return '?';
        const parts = name.trim().split(/\s+/);
        if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
        return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
      };

      container.innerHTML = `
        <div class="member-results-header">Members matching "${escapeHtml(feedSearchQuery)}"</div>
        ${matches.slice(0, 3).map(m => {
          const skills = (m.skill_tags || []).slice(0, 4).join(', ');
          return `
            <a href="profile.html?id=${m.id}" class="member-result">
              <div class="member-result-avatar">${getInitials(m.display_name)}</div>
              <div class="member-result-info">
                <div class="member-result-name">${escapeHtml(m.display_name)}</div>
                ${skills ? `<div class="member-result-skills">${escapeHtml(skills)}</div>` : ''}
              </div>
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--color-text-muted)" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
            </a>
          `;
        }).join('')}
        ${matches.length > 3 ? `<a href="directory.html" style="display:block;text-align:center;font-size:var(--font-size-xs);color:var(--color-primary);padding:var(--space-2);text-decoration:none;">View all ${matches.length} in directory</a>` : ''}
      `;
    }

    // =====================================================
    // CREATE LISTING
    // =====================================================
    function selectMode(mode) {
      postState.mode = mode;
      document.getElementById('category-title').textContent = mode === 'need' ? 'What do you need?' : 'What can you offer?';
      renderCategories();
      navigateTo('screen-category');
    }

    function renderCategories() {
      document.getElementById('category-list').innerHTML = CATEGORIES.map(cat => {
        const isHighRisk = HIGH_RISK_CATEGORIES.includes(cat.id);
        const hint = cat.hint ? `<span style="font-size:var(--font-size-xs);color:var(--color-text-muted);display:block;">${cat.hint}</span>` : '';
        return `<button class="category-item" onclick="selectCategory('${cat.id}')"><span class="emoji">${cat.emoji}</span><span>${cat.label}${hint}</span></button>`;
      }).join('');
    }

    function selectCategory(categoryId) {
      postState.category = categoryId;
      const warningEl = document.getElementById('safety-warning');
      if (warningEl) warningEl.classList.toggle('visible', SAFETY_RISK_CATEGORIES.includes(categoryId));
      navigateTo('screen-describe');
    }

    function selectPicker(btn) {
      const picker = btn.dataset.picker;
      postState[picker] = btn.dataset.value;
      document.querySelectorAll(`[data-picker="${picker}"]`).forEach(b => { b.classList.remove('btn-outline'); b.classList.add('btn-ghost'); });
      btn.classList.remove('btn-ghost');
      btn.classList.add('btn-outline');
    }

    function initAreaSelection() {
      document.querySelectorAll('.area-option').forEach(option => {
        option.addEventListener('click', () => {
          document.querySelectorAll('.area-option').forEach(o => o.classList.remove('selected'));
          option.classList.add('selected');
          const radio = option.querySelector('input[type="radio"]');
          if (radio) { radio.checked = true; postState.area = radio.value; }
        });
      });
    }

    async function submitListing() {
      const title = document.getElementById('listing-title').value.trim();
      const description = document.getElementById('listing-description').value.trim();
      const tagsRaw = document.getElementById('listing-tags').value.trim();
      const tags = tagsRaw ? tagsRaw.split(',').map(t => t.trim()).filter(Boolean) : [];
      const selectedArea = document.querySelector('input[name="listing-area"]:checked');
      const area = selectedArea ? selectedArea.value : 'village';

      if (!title) {
        showToast('Please enter a title');
        return;
      }

      // Safety check
      if (SAFETY_RISK_CATEGORIES.includes(postState.category)) {
        const safetyCheckbox = document.getElementById('safety-confirmed');
        if (!safetyCheckbox.checked) {
          showToast('Please confirm you understand the safety notice');
          return;
        }
      }

      const btn = document.getElementById('submit-btn');
      btn.disabled = true;
      btn.textContent = 'Posting...';

      try {
        const listing = await createListing({
          author_id: currentMember.id,
          type: postState.mode,
          category: postState.category,
          title: title,
          description: description || null,
          tags: tags,
          area: area,
          urgency: postState.urgency,
          visibility: 'public'
        });

        renderSuccessSummary(listing);
        navigateTo('screen-success');
      } catch (e) {
        console.error('Submit error:', e);
        showToast('Failed to post listing. Please try again.');
      } finally {
        btn.disabled = false;
        btn.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg> Post to community`;
      }
    }

    function renderSuccessSummary(listing) {
      const cat = getCategoryById(listing.category);
      const isOffer = listing.type === 'offer';
      document.getElementById('summary-card').innerHTML = `
        <div class="author-strip">
          <div class="author-info"><span class="author-name">${currentMember.display_name}</span><span class="author-member-id">${currentMember.member_id}</span></div>
          <span class="listing-type-badge ${listing.type}">${isOffer ? 'Offer' : 'Need'}</span>
        </div>
        <div style="padding:var(--space-3) 0;border-bottom:1px solid var(--color-border-light);display:flex;justify-content:space-between;"><span class="text-muted">Category</span><span>${cat.emoji} ${cat.label}</span></div>
        <div style="padding:var(--space-3) 0;border-bottom:1px solid var(--color-border-light);display:flex;justify-content:space-between;"><span class="text-muted">Title</span><span style="text-align:right;max-width:60%;">${escapeHtml(listing.title)}</span></div>
        <div style="padding:var(--space-3) 0;display:flex;flex-direction:column;align-items:center;">
          <span class="balance-delta ${isOffer ? 'credit' : 'debit'}">
            ${isOffer ? 'Earn' : 'Spend'} credits when completed
          </span>
          <p class="balance-delta-note">${isOffer ? "You'll earn credits when someone accepts and completes an exchange" : "Credits are agreed when a neighbour proposes an exchange"}</p>
        </div>
      `;
    }

    function startOver() {
      postState.mode = null;
      postState.category = null;
      postState.urgency = 'This week';
      postState.area = 'village';

      // Reset form inputs
      const titleEl = document.getElementById('listing-title');
      if (titleEl) titleEl.value = '';
      const descEl = document.getElementById('listing-description');
      if (descEl) descEl.value = '';
      const tagsEl = document.getElementById('listing-tags');
      if (tagsEl) tagsEl.value = '';

      const safetyCheckbox = document.getElementById('safety-confirmed');
      if (safetyCheckbox) safetyCheckbox.checked = false;
      const safetyWarning = document.getElementById('safety-warning');
      if (safetyWarning) safetyWarning.classList.remove('visible');

      // Reset area selection
      document.querySelectorAll('.area-option').forEach(o => o.classList.remove('selected'));
      const defaultArea = document.querySelector('.area-option[data-area="village"]');
      if (defaultArea) { defaultArea.classList.add('selected'); defaultArea.querySelector('input').checked = true; }

      // Reset picker buttons
      document.querySelectorAll('[data-picker]').forEach(b => { b.classList.remove('btn-outline'); b.classList.add('btn-ghost'); });
      const defaultUrgency = document.querySelector('[data-picker="urgency"][data-value="This week"]');
      if (defaultUrgency) { defaultUrgency.classList.add('btn-outline'); defaultUrgency.classList.remove('btn-ghost'); }

      screenHistory.length = 0;
      screenHistory.push('screen-home');
      showScreen('screen-home');
      loadFeed();
    }

    // =====================================================
    // INVITE MODAL
    // =====================================================
    let currentInviteLink = '';

    function openInviteModal() {
      document.getElementById('invite-modal').classList.add('active');
      document.getElementById('invite-form-view').style.display = 'block';
      document.getElementById('invite-success-view').style.display = 'none';
      renderInviteNeeds();
      document.getElementById('invite-name').focus();
    }

    function renderInviteNeeds() {
      const container = document.getElementById('invite-needs');
      if (!allListings || allListings.length === 0) { container.style.display = 'none'; return; }

      // Count offers and needs per category
      const supply = {}, demand = {};
      allListings.forEach(l => {
        if (l.type === 'offer') supply[l.category] = (supply[l.category] || 0) + 1;
        else demand[l.category] = (demand[l.category] || 0) + 1;
      });

      // Find shortages: categories with needs but few/no offers
      const shortages = [];
      CATEGORIES.forEach(cat => {
        const s = supply[cat.id] || 0;
        const d = demand[cat.id] || 0;
        if (d > 0 && s === 0) shortages.push(cat);
        else if (d > s && d - s >= 2) shortages.push(cat);
      });

      if (shortages.length === 0) { container.style.display = 'none'; return; }

      let html = '<div class="invite-needs-label">The meitheal could use</div>';
      html += '<div class="invite-needs-tags">';
      shortages.forEach(cat => {
        const label = cat.label.split(' & ')[0];
        html += `<span class="invite-need-tag">${cat.emoji} ${label}</span>`;
      });
      html += '</div>';

      container.innerHTML = html;
      container.style.display = 'block';
    }

    function closeInviteModal() {
      document.getElementById('invite-modal').classList.remove('active');
      document.getElementById('invite-name').value = '';
      document.getElementById('invite-email').value = '';
      document.getElementById('invite-note').value = '';
      currentInviteLink = '';
    }

    async function sendInvite() {
      const name = document.getElementById('invite-name').value.trim();
      const email = document.getElementById('invite-email').value.trim();
      const note = document.getElementById('invite-note').value.trim();

      if (!name) { showToast('Please enter their name'); return; }

      // Check member cap
      const capMembers = await getAcceptedMembers();
      if (capMembers.length >= COMMUNITY_SETTINGS.MEMBER_CAP) {
        showToast('Community is at capacity. Invites are paused.');
        return;
      }

      // Check personal invite allowance
      const myInvites = await getMyInvites(currentMember.id);
      const allowance = getInviteAllowance(currentMember, myInvites.length);
      if (allowance.remaining <= 0) {
        showToast(`You've used all ${allowance.limit} invites. Complete more exchanges to earn more.`);
        return;
      }

      try {
        const invite = await createInviteRecord({
          created_by: currentMember.id,
          invitee_name: name,
          invitee_email: email || null,
          note: note || null
        });

        currentInviteLink = generateInviteLink(invite.token);
        document.getElementById('invite-form-view').style.display = 'none';
        document.getElementById('invite-success-view').style.display = 'block';
        document.getElementById('invite-success-name').textContent = name;
        document.getElementById('invite-link').value = currentInviteLink;
        document.getElementById('copy-btn').textContent = 'Copy';
        updateInviteStatus();
      } catch (e) {
        console.error('Invite error:', e);
        showToast('Failed to create invite. Please try again.');
      }
    }

    function copyInviteLinkToClipboard() {
      navigator.clipboard.writeText(currentInviteLink).then(() => {
        document.getElementById('copy-btn').textContent = 'Copied!';
        setTimeout(() => { document.getElementById('copy-btn').textContent = 'Copy'; }, 2000);
      });
    }

    function shareInviteLink() {
      const name = document.getElementById('invite-success-name').textContent;
      if (navigator.share) {
        navigator.share({ title: 'Join Open Gobán', text: `Hi ${name}! Join our community exchange:`, url: currentInviteLink });
      } else {
        copyInviteLinkToClipboard();
        showToast('Link copied - paste it in your message');
      }
    }

    // =====================================================
    // INVITE STATUS
    // =====================================================
    async function updateInviteStatus() {
      try {
        const capMembers = await getAcceptedMembers();
        const myInvites = await getMyInvites(currentMember.id);
        const allowance = getInviteAllowance(currentMember, myInvites.length);
        const atCap = capMembers.length >= COMMUNITY_SETTINGS.MEMBER_CAP;

        const statusEl = document.getElementById('invite-status');
        const btnEl = document.getElementById('invite-btn');

        if (atCap) {
          statusEl.textContent = `Community full (${capMembers.length}/${COMMUNITY_SETTINGS.MEMBER_CAP} members)`;
          btnEl.disabled = true;
        } else if (allowance.remaining <= 0) {
          statusEl.textContent = `No invites remaining (${allowance.used}/${allowance.limit} used)`;
          btnEl.disabled = true;
        } else {
          statusEl.textContent = `${allowance.remaining} invite${allowance.remaining !== 1 ? 's' : ''} remaining · ${capMembers.length}/${COMMUNITY_SETTINGS.MEMBER_CAP} members`;
          btnEl.disabled = false;
        }

        // Render invite list
        const listEl = document.getElementById('my-invites-list');
        if (listEl && myInvites.length > 0) {
          listEl.innerHTML = `
            <p style="font-size: var(--font-size-sm); font-weight: var(--font-weight-semibold); color: var(--color-text-muted); margin-bottom: var(--space-2);">Your invites</p>
            ${myInvites.map(inv => {
              const name = escapeHtml(inv.invitee_name || 'Unnamed');
              const status = inv.status === 'redeemed'
                ? '<span style="color: var(--color-status-active);">Joined</span>'
                : '<span style="color: var(--color-text-muted);">Pending</span>';
              return `<div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-2) 0; border-bottom: 1px solid var(--color-border-light);">
                <span style="font-size: var(--font-size-sm);">${name}</span>
                <span style="font-size: var(--font-size-xs);">${status}</span>
              </div>`;
            }).join('')}
          `;
        }
      } catch (e) {
        console.error('Invite status error:', e);
        document.getElementById('invite-status').textContent = 'Know someone who\'d like to join?';
        document.getElementById('invite-btn').disabled = false;
      }
    }

    // =====================================================
    // FEEDBACK MODAL
    // =====================================================
    let selectedFeedbackType = 'idea';

    function openFeedbackModal() {
      document.getElementById('feedback-modal').classList.add('active');
      document.getElementById('feedback-fab').style.display = 'none';
      document.getElementById('feedback-message').focus();
    }

    function closeFeedbackModal() {
      document.getElementById('feedback-modal').classList.remove('active');
      document.getElementById('feedback-fab').style.display = 'flex';
      document.getElementById('feedback-message').value = '';
      selectedFeedbackType = 'idea';
      document.querySelectorAll('.feedback-type-option').forEach(opt => {
        opt.classList.remove('selected');
        if (opt.dataset.type === 'idea') { opt.classList.add('selected'); opt.querySelector('input').checked = true; }
      });
    }

    function initFeedbackTypeSelection() {
      document.querySelectorAll('.feedback-type-option').forEach(option => {
        option.addEventListener('click', () => {
          document.querySelectorAll('.feedback-type-option').forEach(o => o.classList.remove('selected'));
          option.classList.add('selected');
          option.querySelector('input').checked = true;
          selectedFeedbackType = option.dataset.type;
        });
      });
    }

    async function submitFeedbackForm() {
      const message = document.getElementById('feedback-message').value.trim();
      if (!message) { showToast('Please enter your feedback'); return; }

      try {
        await createFeedbackRecord({
          author_id: currentMember.id,
          type: selectedFeedbackType,
          message: message
        });
        closeFeedbackModal();
        showToast('Thank you! Your feedback has been submitted.');
      } catch (e) {
        console.error('Feedback error:', e);
        showToast('Failed to submit feedback. Please try again.');
      }
    }

    // =====================================================
    // ADMIN REVIEW BADGE
    // =====================================================
    async function showAdminReviewBadge() {
      const link = document.getElementById('admin-review-link');
      const badge = document.getElementById('review-count-badge');
      if (!link) return;
      link.style.display = '';
      try {
        const pending = await getMembersForReview();
        const count = pending.filter(m => m.status === 'REVIEW').length;
        if (count > 0) {
          badge.textContent = count;
          badge.style.display = '';
        }
      } catch (e) {
        console.error('Review badge error:', e);
      }
    }

    // =====================================================
    // HELPERS
    // =====================================================
    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    function renderDegreesBadge(authorId) {
      if (!currentMember || !allMembers.length || !authorId) return '';
      if (authorId === currentMember.id) return '';
      const degrees = getDegreesFromUser(allMembers, currentMember.id, authorId);
      if (degrees < 0) return '';
      const label = degrees === 1 ? '1 step' : degrees + ' steps';
      return `
        <span class="degrees-badge">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><polyline points="17 11 19 13 23 9"/></svg>
          ${label}
        </span>
      `;
    }

    // =====================================================
    // INIT
    // =====================================================
    init();
  </script>
</body>
</html>
